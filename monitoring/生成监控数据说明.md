# 生成Grafana监控数据说明

**创建日期**: 2025-10-12
**用途**: 为Grafana仪表板生成测试和实际监控数据

---

## 📊 当前状态

✅ Grafana仪表板已成功创建
✅ PostgreSQL数据源连接正常
⏳ 监控数据库为空（等待生成数据）

---

## 🎯 生成监控数据的方式

### 方式1: 使用测试脚本生成模拟数据（快速测试）

**适用场景**: 快速验证Grafana仪表板是否正常工作

**运行命令**:
```bash
cd /mnt/wd_mycode/mystocks_spec
python test_monitoring_with_redis.py
```

**生成的数据**:
- ✅ 操作日志记录（多种操作类型）
- ✅ 性能指标记录（不同数据库的查询时间）
- ✅ 数据质量检查记录（PASS/WARN/FAIL状态）
- ✅ 告警记录（不同级别的告警）

**预计时间**: 30-60秒

---

### 方式2: 通过实际业务操作自动生成（生产数据）

**适用场景**: 日常使用中自动收集真实监控数据

监控系统已经集成到业务代码中，以下操作会自动生成监控数据：

#### 2.1 运行数据采集程序

**实时行情数据保存**:
```bash
cd /mnt/wd_mycode/mystocks_spec
python run_realtime_market_saver.py
```

**会自动记录**:
- 数据库操作日志（INSERT到TDengine）
- 查询性能指标
- 数据质量检查结果
- 异常告警（如数据延迟、连接失败）

#### 2.2 使用Unified Manager

```python
from unified_manager import MyStocksUnifiedManager

# 初始化系统
manager = MyStocksUnifiedManager()
manager.initialize_system()

# 任何数据操作都会自动生成监控数据
manager.save_data_by_classification(
    classification=DataClassification.MARKET_DATA,
    table_name="stock_tick_data",
    data=df
)
```

**会自动记录**:
- 操作类型（INSERT/UPDATE/QUERY）
- 操作耗时
- 数据库目标
- 成功/失败状态

#### 2.3 运行系统演示

```bash
cd /mnt/wd_mycode/mystocks_spec
python system_demo.py
```

**会生成完整的监控数据**:
- 多种数据分类的操作记录
- 跨数据库性能对比数据
- 数据质量检查记录

---

## 📈 监控数据的13个仪表板面板

配置完成后，仪表板包含以下面板：

### 系统概览 (4个Stat面板)
1. **今日操作总数** - 显示当天所有数据库操作数量
2. **慢查询数量** - 显示查询时间>1秒的操作数
3. **未解决告警** - 显示待处理的告警数量
4. **平均查询时间** - 显示所有查询的平均耗时

### 性能监控 (3个面板)
5. **查询时间趋势** - 24小时内查询时间变化趋势图
6. **数据库性能对比** - TDengine/PostgreSQL/MySQL性能柱状图
7. **慢查询Top 10** - 最慢的10个查询详情表格

### 数据质量 (2个面板)
8. **质量检查状态分布** - PASS/WARN/FAIL比例饼图
9. **质量检查趋势** - 数据质量历史趋势图

### 告警监控 (2个面板)
10. **告警级别分布** - CRITICAL/HIGH/MEDIUM/LOW分布
11. **未解决告警列表** - 待处理告警详情表格

### 操作统计 (2个面板)
12. **操作类型分布** - QUERY/INSERT/UPDATE/DELETE比例饼图
13. **操作成功率** - 按数据库分类的成功率统计

---

## ⏰ 什么时候生成数据

### 立即生成（推荐）

**目的**: 验证Grafana仪表板配置正确

```bash
# 运行测试脚本，1分钟内完成
python test_monitoring_with_redis.py
```

**验证步骤**:
1. 运行脚本生成数据
2. 返回Grafana刷新仪表板（点击右上角🔄）
3. 检查所有13个面板是否正常显示数据
4. 确认图表渲染正确（折线图、柱状图、饼图、表格）

✅ **优点**: 立即验证配置，快速发现问题

---

### 以后生成（您选择的方式）

**目的**: 等待实际业务运行时自动收集真实数据

**无需任何额外操作**，系统会在以下情况自动生成监控数据：

- 运行实时行情数据采集程序
- 使用UnifiedManager进行数据操作
- 运行任何使用监控组件的业务代码
- 系统自动的数据质量检查任务

✅ **优点**: 真实生产数据，反映实际系统状态

⚠️ **注意**:
- 仪表板在有数据前会显示"No Data"
- 第一次运行业务代码后，数据会自动出现
- 可能需要等待数小时或数天才能看到完整趋势

---

## 🔍 检查监控数据是否存在

### 快速检查命令

```bash
export PGPASSWORD='c790414J'
psql -h 192.168.123.104 -p 5438 -U postgres -d mystocks_monitoring -c "
SELECT
  '操作日志' as table_name,
  COUNT(*) as records,
  CASE WHEN COUNT(*) > 0 THEN '✅ 有数据' ELSE '⏳ 无数据' END as status
FROM operation_logs
UNION ALL
SELECT
  '性能指标',
  COUNT(*),
  CASE WHEN COUNT(*) > 0 THEN '✅ 有数据' ELSE '⏳ 无数据' END
FROM performance_metrics
UNION ALL
SELECT
  '质量检查',
  COUNT(*),
  CASE WHEN COUNT(*) > 0 THEN '✅ 有数据' ELSE '⏳ 无数据' END
FROM data_quality_checks
UNION ALL
SELECT
  '告警记录',
  COUNT(*),
  CASE WHEN COUNT(*) > 0 THEN '✅ 有数据' ELSE '⏳ 无数据' END
FROM alert_records;
"
```

### 查看最近的监控记录

```bash
export PGPASSWORD='c790414J'
psql -h 192.168.123.104 -p 5438 -U postgres -d mystocks_monitoring -c "
-- 最近10条操作日志
SELECT
  operation_time,
  operation_type,
  target_database,
  table_name,
  status
FROM operation_logs
ORDER BY operation_time DESC
LIMIT 10;
"
```

---

## 📝 生成数据的详细说明

### test_monitoring_with_redis.py 脚本详情

**脚本位置**: `/mnt/wd_mycode/mystocks_spec/test_monitoring_with_redis.py`

**生成的数据类型**:

1. **操作日志** (operation_logs表)
   - 50-100条不同类型的操作记录
   - 包括QUERY、INSERT、UPDATE、DELETE
   - 涵盖TDengine、PostgreSQL、MySQL、Redis
   - 模拟成功和失败的操作
   - 包含慢查询（>1秒）

2. **性能指标** (performance_metrics表)
   - 30-60条性能记录
   - 不同数据库的查询时间对比
   - 模拟快速查询（<100ms）和慢查询（>1s）
   - 包含内存使用、CPU时间等指标

3. **数据质量检查** (data_quality_checks表)
   - 20-40条质量检查记录
   - 包括完整性、一致性、准确性检查
   - PASS、WARN、FAIL三种状态
   - 附带详细的检查消息

4. **告警记录** (alert_records表)
   - 10-20条告警记录
   - CRITICAL、HIGH、MEDIUM、LOW四个级别
   - 包括已解决和未解决的告警
   - 性能、质量、系统类型的告警

**运行输出示例**:
```
开始生成监控测试数据...
✅ 生成了 75 条操作日志
✅ 生成了 45 条性能指标
✅ 生成了 30 条数据质量检查
✅ 生成了 15 条告警记录
✅ 监控数据生成完成！

现在可以在Grafana中查看仪表板数据了。
```

---

## 🎯 推荐流程

### 如果您想立即验证仪表板

```bash
# 1. 生成测试数据
python test_monitoring_with_redis.py

# 2. 打开Grafana仪表板
# http://192.168.123.104:3000

# 3. 刷新仪表板（点击右上角🔄）

# 4. 验证所有面板都显示数据

# 5. 可选：清空测试数据，等待真实数据
# 清空命令：
export PGPASSWORD='c790414J'
psql -h 192.168.123.104 -p 5438 -U postgres -d mystocks_monitoring -c "
TRUNCATE TABLE operation_logs, performance_metrics, data_quality_checks, alert_records CASCADE;
"
```

### 如果您想等待真实数据

**不需要任何操作**，等待系统正常运行即可。

当您运行任何业务程序（如实时行情采集、数据查询等），监控数据会自动生成。

**第一次看到数据的时间**:
- 运行实时行情采集: 几分钟内
- 运行系统演示: 立即
- 日常业务操作: 数小时到数天

---

## 🔄 数据保留策略

### 当前配置

监控数据库使用月度分区（`operation_logs`表），建议保留策略：

- **operation_logs**: 30天（自动分区，可配置自动删除）
- **performance_metrics**: 90天
- **data_quality_checks**: 60天
- **alert_records**: 180天

### 手动清理历史数据

```sql
-- 删除30天前的操作日志
DELETE FROM operation_logs
WHERE operation_time < NOW() - INTERVAL '30 days';

-- 删除90天前的性能指标
DELETE FROM performance_metrics
WHERE metric_time < NOW() - INTERVAL '90 days';

-- 删除60天前的质量检查
DELETE FROM data_quality_checks
WHERE check_time < NOW() - INTERVAL '60 days';

-- 删除已解决的告警（90天前）
DELETE FROM alert_records
WHERE is_resolved = TRUE
  AND resolved_time < NOW() - INTERVAL '90 days';
```

---

## 📞 需要帮助？

### 仪表板显示"No Data"

**原因**: 监控数据库中没有数据

**解决**: 运行 `python test_monitoring_with_redis.py`

### 脚本运行失败

**检查**:
1. TDengine是否运行: `systemctl status taosd`
2. Redis是否运行: `systemctl status redis`
3. PostgreSQL是否运行
4. .env文件配置是否正确

### 真实数据没有生成

**检查**:
1. 业务代码是否使用了监控组件
2. MonitoringDatabase是否初始化
3. 查看业务程序日志是否有监控相关错误

---

## ✅ 总结

✅ **仪表板已创建** - 配置完成，等待数据
✅ **数据库已就绪** - 表结构和分区已创建
✅ **监控系统已集成** - 业务代码会自动生成数据

**您的选择**: 等待真实数据 ⏳
- 优点: 真实反映系统状态
- 提示: 第一次运行业务代码后数据会自动出现
- 验证: 随时可运行测试脚本快速验证

**测试命令** (随时可用):
```bash
python test_monitoring_with_redis.py
```

---

**文档版本**: 1.0.0
**最后更新**: 2025-10-12

🎉 **Grafana仪表板配置成功！等待监控数据自动填充。**
