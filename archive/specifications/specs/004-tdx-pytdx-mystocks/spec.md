# Feature Specification: TDX数据源适配器集成

**Feature Branch**: `004-tdx-pytdx-mystocks`
**Created**: 2025-10-15
**Status**: Draft
**Input**: User description: "TDX数据源适配器集成 - 集成pytdx库到MyStocks系统，创建符合IDataSource接口规范的TdxDataSource适配器。pytdx提供通达信协议数据访问，专注于A股市场数据。主要功能：1)实时行情查询(支持批量查询)；2)历史K线数据(1分钟/5分钟/15分钟/30分钟/1小时/日/周/月/季/年)；3)分时数据(当日和历史)；4)分笔成交明细；5)财务信息查询；6)除权除息信息；7)板块信息(板块列表、板块成分股)；8)公司信息查询。主要特点：直连通达信服务器无API限流、支持深交所和上交所市场。实现要求：复用项目现有的重试机制、列名映射ColumnMapper、日期格式化normalize_date、股票代码格式化format_stock_code_for_source等工具类；不直接复制pytdx代码而是封装其API；支持连接池管理和心跳保持；错误处理和日志记录遵循项目规范；仅处理A股股票和指数，不包含期货期权功能。参考temp/pytdx目录中的hq.py进行二次开发。"

## User Scenarios & Testing

### User Story 1 - 获取实时行情数据 (Priority: P1)

作为量化交易系统用户，我需要获取股票的实时行情数据（最新价、涨跌幅、成交量等），以便做出及时的交易决策。系统应该支持单个股票查询和批量查询，直接从通达信服务器获取数据，避免API限流问题。

**Why this priority**: 实时行情是量化交易的基础数据，是MVP的核心功能。没有实时行情数据，其他功能都无法正常运作。

**Independent Test**: 可以通过调用数据源适配器的实时行情查询方法，传入单个或多个股票代码，验证返回的数据包含完整的行情字段（价格、成交量、涨跌幅等），并且数据与通达信客户端显示一致。

**Acceptance Scenarios**:

1. **Given** 系统已连接到通达信服务器，**When** 用户查询单个股票"600519"的实时行情，**Then** 系统返回包含最新价、涨跌幅、成交量、买卖五档等完整行情数据
2. **Given** 系统已连接到通达信服务器，**When** 用户批量查询10只股票的实时行情，**Then** 系统返回所有10只股票的完整行情数据，响应时间在3秒内
3. **Given** 通达信服务器连接正常，**When** 用户查询深市股票"000001"的实时行情，**Then** 系统正确识别市场类型并返回深市行情数据
4. **Given** 通达信服务器连接正常，**When** 用户查询沪市股票"600000"的实时行情，**Then** 系统正确识别市场类型并返回沪市行情数据

---

### User Story 2 - 获取历史K线数据 (Priority: P1)

作为量化交易分析师，我需要获取股票的历史K线数据（包括日K、周K、月K和分钟级K线），以便进行技术分析和回测策略。系统应该支持多种时间周期，并能够指定日期范围。

**Why this priority**: 历史K线数据是技术分析和策略回测的基础，是MVP必需功能。与实时行情同等重要。

**Independent Test**: 可以通过指定股票代码、日期范围和K线周期，查询历史K线数据，验证返回的OHLCV数据完整、日期范围正确、数据量符合预期。

**Acceptance Scenarios**:

1. **Given** 用户需要查询"600519"的日K线数据，**When** 用户指定2024年1月1日到2024年12月31日，**Then** 系统返回该时间范围内所有交易日的OHLCV数据
2. **Given** 用户需要进行短线分析，**When** 用户查询"000001"的5分钟K线数据（最近800条），**Then** 系统返回800条5分钟K线数据，包含完整的时间戳、OHLCV字段
3. **Given** 用户需要查看长期趋势，**When** 用户查询"600000"的周K线数据（最近100周），**Then** 系统返回100条周K线数据，每条数据代表一周的汇总
4. **Given** 用户查询历史数据，**When** 指定的日期范围包含非交易日，**Then** 系统仅返回交易日的K线数据，跳过非交易日

---

### User Story 3 - 获取分时数据和成交明细 (Priority: P2)

作为短线交易者，我需要查看股票的分时走势图数据和分笔成交明细，以便观察盘中价格波动和资金流向，捕捉短线交易机会。

**Why this priority**: 分时数据对短线交易很重要，但不是MVP的核心功能。可以在基础行情功能之后实现。

**Independent Test**: 可以查询指定股票的当日分时数据或历史某日的分时数据，验证返回每分钟的价格、成交量数据。查询分笔成交明细，验证返回每笔成交的时间、价格、数量、买卖方向。

**Acceptance Scenarios**:

1. **Given** 当前交易时间为14:30，**When** 用户查询"600519"的当日分时数据，**Then** 系统返回从开盘9:30到当前14:30的所有分钟级价格和成交量数据
2. **Given** 用户需要回顾历史分时，**When** 用户查询"000001"在2024年10月10日的分时数据，**Then** 系统返回该日9:30-15:00的完整分时数据
3. **Given** 用户需要查看资金流向，**When** 用户查询"600000"的最新1000笔成交明细，**Then** 系统返回1000笔成交记录，包含时间、价格、成交量、买卖方向
4. **Given** 用户分析历史成交，**When** 用户查询"000001"在2024年10月10日的成交明细（从第0笔开始，共500笔），**Then** 系统返回该日前500笔成交记录

---

### User Story 4 - 获取财务和除权除息信息 (Priority: P3)

作为基本面分析师，我需要查询上市公司的财务指标（如市盈率、净利润、营收等）和除权除息信息，以便进行价值投资分析和股价调整计算。

**Why this priority**: 财务信息对基本面分析重要，但对量化交易系统不是最核心功能。可以在行情数据功能稳定后添加。

**Independent Test**: 可以通过股票代码查询财务信息，验证返回包含市盈率、净利润、营收等关键指标。查询除权除息信息，验证返回历史分红送股记录。

**Acceptance Scenarios**:

1. **Given** 用户需要评估股票估值，**When** 用户查询"600519"的财务信息，**Then** 系统返回最新的财务指标（市盈率、市净率、净利润、营收、ROE等）
2. **Given** 用户需要进行复权计算，**When** 用户查询"000001"的除权除息信息，**Then** 系统返回历史所有的分红、送股、配股记录，包含除权日期和比例
3. **Given** 用户查询公司基本信息，**When** 用户请求"600000"的公司信息，**Then** 系统返回公司名称、上市日期、所属行业、总股本、流通股本等基础数据

---

### User Story 5 - 获取板块信息 (Priority: P3)

作为行业研究员，我需要查询行业板块列表和每个板块的成分股，以便进行板块轮动分析和行业比较研究。

**Why this priority**: 板块信息对行业分析有帮助，但不是量化交易系统的核心功能。优先级相对较低。

**Independent Test**: 可以查询所有板块列表，验证返回板块名称和代码。根据板块名称查询成分股列表，验证返回该板块所有股票代码。

**Acceptance Scenarios**:

1. **Given** 用户需要查看板块分类，**When** 用户请求获取所有行业板块列表，**Then** 系统返回包含板块名称、板块代码的完整列表
2. **Given** 用户研究特定行业，**When** 用户查询"银行"板块的成分股，**Then** 系统返回该板块所有股票代码和名称
3. **Given** 用户研究概念板块，**When** 用户查询"新能源"概念板块的成分股，**Then** 系统返回该概念相关的所有股票列表

---

### Edge Cases

- **连接失败场景**: 当通达信服务器无法连接时，系统如何处理？是否会自动重试？重试多少次？
- **数据缺失场景**: 当查询的股票代码不存在或已退市时，系统如何返回错误信息？
- **停牌股票**: 当查询停牌股票的实时行情时，系统如何标识停牌状态？
- **非交易时间**: 在非交易时间（如晚上、周末）查询实时行情时，系统如何处理？返回上一个交易日的收盘价还是报错？
- **数据量限制**: 单次查询K线数据的最大条数是多少？如果用户请求超过限制，系统如何处理？
- **批量查询限制**: 批量查询实时行情时，单次最多支持多少只股票？如果超过限制，系统如何分批处理？
- **连接超时**: 如果通达信服务器响应缓慢，超过设定的超时时间，系统如何处理？
- **心跳保持**: 长时间空闲后，连接是否会断开？系统如何保持连接活跃？
- **并发查询**: 多个用户同时查询数据时，连接池如何分配？是否会出现连接耗尽的情况？
- **数据格式异常**: 如果通达信返回的数据格式与预期不符，系统如何处理和记录错误？

## Requirements

### Functional Requirements

- **FR-001**: 系统必须提供获取实时行情的接口，支持单个股票和批量股票查询，返回数据包含最新价、涨跌幅、成交量、买卖五档等字段
- **FR-002**: 系统必须支持查询历史K线数据，支持的周期包括：1分钟、5分钟、15分钟、30分钟、1小时、日、周、月、季、年
- **FR-003**: 系统必须能够指定日期范围查询K线数据，并能指定返回的数据条数（例如最近800条）
- **FR-004**: 系统必须区分深交所（market=0）和上交所（market=1）市场，正确路由股票代码到相应市场
- **FR-005**: 系统必须提供查询当日分时数据的接口，返回从开盘到当前时间的每分钟价格和成交量
- **FR-006**: 系统必须提供查询历史分时数据的接口，可指定历史某一日期查询该日的分时数据
- **FR-007**: 系统必须提供查询分笔成交明细的接口，支持指定起始位置和查询数量，返回包含时间、价格、成交量、买卖方向的逐笔数据
- **FR-008**: 系统必须提供查询股票财务信息的接口，返回市盈率、市净率、净利润、营收等财务指标
- **FR-009**: 系统必须提供查询除权除息信息的接口，返回历史分红送股配股记录及除权日期
- **FR-010**: 系统必须提供查询公司基本信息的接口，返回公司名称、上市日期、所属行业、股本信息等
- **FR-011**: 系统必须提供查询板块列表的接口，返回所有行业板块和概念板块的名称和代码
- **FR-012**: 系统必须提供查询板块成分股的接口，根据板块标识返回该板块所有股票代码
- **FR-013**: 系统必须复用项目现有工具类进行数据标准化，包括：ColumnMapper（列名映射）、normalize_date（日期格式化）、format_stock_code_for_source（股票代码格式化）
- **FR-014**: 系统必须实现连接池管理，支持多个并发查询共享连接，避免频繁创建和销毁连接
- **FR-015**: 系统必须实现心跳保持机制，定期发送心跳包保持与通达信服务器的连接活跃
- **FR-016**: 系统必须实现自动重试机制，当网络请求失败时自动重试，重试次数和间隔可配置
- **FR-017**: 系统必须对所有异常进行捕获和记录，遵循项目日志规范输出详细错误信息
- **FR-018**: 系统必须对返回的数据进行标准化处理，统一列名为英文，统一日期格式为YYYY-MM-DD
- **FR-019**: 系统必须仅处理A股股票和指数，不包含期货、期权等衍生品功能
- **FR-020**: 系统必须在无法连接通达信服务器时返回明确的错误信息，不应崩溃或挂起

### Key Entities

- **实时行情数据 (Real-time Quote)**: 包含股票代码、名称、最新价、开盘价、最高价、最低价、昨收价、涨跌额、涨跌幅、成交量、成交额、买卖五档价格和数量、时间戳等字段
- **K线数据 (Candlestick Data)**: 包含股票代码、日期时间、开盘价、最高价、最低价、收盘价、成交量、成交额等OHLCV字段，根据不同周期进行汇总
- **分时数据 (Minute Data)**: 包含股票代码、时间（精确到分钟）、价格、成交量、均价等字段，用于绘制分时走势图
- **成交明细 (Transaction Detail)**: 包含股票代码、时间（精确到秒）、价格、成交量、买卖方向（买盘/卖盘/中性盘）等字段
- **财务信息 (Financial Info)**: 包含股票代码、报告期、市盈率、市净率、净利润、营业收入、ROE、每股收益等财务指标
- **除权除息记录 (Dividend Record)**: 包含股票代码、除权除息日期、分红金额、送股比例、配股比例、配股价等信息
- **公司信息 (Company Info)**: 包含股票代码、公司名称、上市日期、所属行业、主营业务、总股本、流通股本等基本信息
- **板块信息 (Sector Info)**: 包含板块代码、板块名称、板块类型（行业/概念）、成分股列表等信息

## Success Criteria

### Measurable Outcomes

- **SC-001**: 用户可以在3秒内获取单只股票的实时行情数据
- **SC-002**: 系统支持单次批量查询至少50只股票的实时行情，响应时间在10秒内
- **SC-003**: 用户可以在5秒内获取单只股票最近800条日K线数据
- **SC-004**: 系统在通达信服务器正常的情况下，数据查询成功率达到99%以上
- **SC-005**: 当通达信服务器连接失败时，系统能在3次重试后（每次间隔1秒）给出明确的错误提示
- **SC-006**: 系统支持至少10个并发用户同时查询数据，不出现连接耗尽或响应超时
- **SC-007**: 所有返回的数据格式统一，列名均为标准化的英文字段，日期格式统一为YYYY-MM-DD
- **SC-008**: 系统日志完整记录所有数据查询操作，包括查询参数、响应时间、成功/失败状态、错误详情
- **SC-009**: 与现有Akshare和Baostock数据源适配器相比，通达信数据源在高峰期（如开盘和收盘前后）的响应速度提升至少30%
- **SC-010**: 用户无需了解通达信协议细节，仅通过简单的API调用即可获取所需数据

### Assumptions

1. **通达信服务器地址**: 假设使用公开的通达信行情服务器地址（如101.227.73.20:7709），如果需要使用其他服务器，可通过配置文件或环境变量指定
2. **数据更新频率**: 假设实时行情数据的更新频率为3-5秒（取决于通达信服务器推送频率）
3. **历史数据完整性**: 假设通达信服务器能提供至少最近5年的完整历史K线数据
4. **连接池大小**: 假设默认连接池大小为5个连接，可根据实际并发需求调整
5. **重试策略**: 假设默认重试3次，每次间隔1秒，可通过配置调整
6. **超时设置**: 假设默认网络请求超时时间为10秒
7. **心跳间隔**: 假设心跳包发送间隔为30秒，避免长时间空闲导致连接断开
8. **代码格式**: 假设输入的股票代码可以是"600519"、"000001"等纯数字格式，系统内部自动识别市场类型
9. **pytdx库版本**: 假设使用temp/pytdx目录中提供的pytdx代码版本，该版本已经过验证可正常工作
10. **数据权限**: 假设通达信服务器对公开数据无访问限制，无需账号认证
11. **板块数据**: 假设板块数据存储在通达信的特定文件中（如block_gn.dat、block_fg.dat），可通过协议访问
12. **数据编码**: 假设通达信返回的数据为GBK或UTF-8编码，系统需要正确处理中文字符

### Dependencies

- **pytdx库**: 依赖temp/pytdx目录中提供的pytdx代码，封装通达信协议的底层通信
- **项目工具类**: 依赖项目现有的utils模块，包括ColumnMapper、normalize_date、format_stock_code_for_source等工具类
- **IDataSource接口**: 必须符合项目定义的IDataSource接口规范，确保与其他数据源适配器（Akshare、Baostock等）保持一致的调用方式
- **网络连接**: 依赖网络能正常访问通达信行情服务器（端口通常为7709）
- **配置管理**: 依赖项目的配置管理机制（如.env文件或config模块）存储通达信服务器地址、连接池大小等配置参数

### Out of Scope

以下功能明确不在本次feature范围内：

- **期货和期权数据**: 不支持期货、期权等衍生品的行情查询
- **港股和美股**: 仅支持A股市场（深交所和上交所），不支持港股通、美股等境外市场
- **Level-2行情**: 不支持逐笔委托、委托队列等Level-2高级行情数据
- **交易功能**: 仅提供行情查询功能，不包含下单、撤单等交易功能
- **数据存储**: 适配器仅负责数据获取，不负责数据的持久化存储（存储由系统其他模块负责）
- **数据清洗**: 仅进行基本的格式标准化，不进行复杂的数据清洗和异常值处理
- **自动选择最佳服务器**: 不实现自动扫描和选择最优通达信服务器的功能（可在后续版本添加）
- **图形界面**: 仅提供编程接口，不提供Web UI或桌面GUI
