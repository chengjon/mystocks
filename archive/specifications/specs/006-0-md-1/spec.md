# Feature Specification: 系统规范化改进

**Feature Branch**: `006-0-md-1`
**Created**: 2025-10-16
**Status**: Draft
**Input**: 根据改进意见0.md整理现有系统的规范性问题

**创建人**: Claude
**版本**: 1.0.0
**批准日期**: 待定
**最后修订**: 2025-10-16
**本次修订内容**: 初始创建系统规范化改进规格说明

## Clarifications

### Session 2025-10-16

- Q: A+H股数据关联处理 - 当A股公司同时在香港上市H股时，系统如何处理这两个市场的数据关联？ → A: 本次规范化不处理，仅在代码中预留接口和注释说明，留待后续功能开发时实现
- Q: 历史数据清理策略 - 清理非业务范围代码时，如何处理已有的历史数据和数据库表结构？ → A: 备份后删除非业务范围的表和数据（如有）
- Q: 文档元数据批量更新方式 - 如何高效地为几十个现有MD文档添加元数据标记？ → A: 手动逐个更新核心文档（10-15个重要文档），其他文档暂不处理
- Q: 注释语言处理 - 技术术语（如API、DataFrame、Token等）应如何处理？ → A: 技术术语保留英文，其他描述性注释统一为中文
- Q: 测试文件迁移处理 - 移动测试文件名不符合规范的文件时，如何避免破坏现有的import路径？ → A: 重命名后立即运行全部测试，如有失败则修复import路径，确保测试通过后再提交

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 业务范围限定和清理 (Priority: P1)

作为项目管理者JohnC，我需要确保系统只处理业务范围内的数据（A股、股指期货、可选H股），删除超出范围的代码（期货/期权/外汇/黄金/美股），以便保持系统聚焦核心业务，降低维护成本。

**Why this priority**: 这是系统架构层面的基础决策，影响所有后续开发和维护工作。范围不清晰会导致代码膨胀、测试复杂度增加。

**Independent Test**: 可通过代码审查和关键词搜索（如"futures", "options", "forex", "gold", "US stock"）验证，检查adapters、配置文件、文档中是否还存在超出范围的内容。

**Acceptance Scenarios**:

1. **Given** 系统包含多种数据源适配器，**When** 审查adapters目录，**Then** 仅保留A股、股指期货、H股相关的适配器代码
2. **Given** 配置文件中有多种市场配置，**When** 检查table_config.yaml等配置，**Then** 仅包含A股、股指期货、H股相关的表结构
3. **Given** 文档中提及多种市场，**When** 检查所有.md文档，**Then** 删除或标记为"不支持"的非业务范围内容
4. **Given** 代码中包含非业务范围的处理逻辑，**When** 搜索关键词，**Then** 清理或迁移到temp目录

---

### User Story 2 - 文档标记规范化 (Priority: P1)

作为项目管理者JohnC，我需要所有MD文档都包含标准化的元数据标记（创建人、版本、批准日期、最后修订、修订内容），以便追溯文档历史、明确责任人、便于版本管理和协作。

**Why this priority**: 文档是项目知识管理的核心，标准化的元数据是团队协作和长期维护的基础。当前系统已有大量文档，需要统一规范。

**Independent Test**: 可通过脚本自动检查所有.md文件头部是否包含必需的5个字段（创建人、版本、批准日期、最后修订、修订内容），生成合规性报告。

**Acceptance Scenarios**:

1. **Given** 现有MD文档缺少元数据，**When** 更新所有核心文档（README.md, CHANGELOG, 等），**Then** 每个文档都包含完整的5个标记字段
2. **Given** 新创建MD文档，**When** 使用speckit或手动创建，**Then** 自动包含标准元数据模板
3. **Given** 文档被修改，**When** 更新内容，**Then** 必须同时更新"最后修订"日期和"本次修订内容"
4. **Given** 需要查找某类文档，**When** 按创建人或版本号搜索，**Then** 能快速定位相关文档

---

### User Story 3 - Python代码注释规范化 (Priority: P2)

作为开发者，我需要所有Python程序都遵循统一的注释规范（文件头注释、类/函数文档字符串），以便快速理解代码功能、依赖和使用方法，降低维护成本。

**Why this priority**: 代码可读性直接影响维护效率。当前系统已有大量Python文件，标准化注释能显著提升新成员上手速度和长期维护性。

**Independent Test**: 可通过静态分析工具检查所有.py文件是否包含：1) 文件头注释（功能、作者、版本、依赖、注意事项）；2) 所有自定义类和函数的docstring。

**Acceptance Scenarios**:

1. **Given** 现有Python文件缺少头部注释，**When** 审查核心模块（adapters/, core.py, unified_manager.py等），**Then** 添加完整的文件头注释
2. **Given** 类和函数缺少文档字符串，**When** 检查公共API，**Then** 所有公共类/函数都有清晰的docstring
3. **Given** 新创建Python文件，**When** 编写代码，**Then** 必须包含标准头部注释和适当的docstring
4. **Given** 代码有特殊依赖或约束，**When** 在头部注释中说明，**Then** 其他开发者能快速了解使用限制

---

### User Story 4 - 文件和测试管理规范化 (Priority: P2)

作为项目管理者JohnC，我需要清理无关文件、统一测试文件命名（test_前缀）、优化目录结构，以便保持代码库整洁、降低认知负担、便于CI/CD集成。

**Why this priority**: 清晰的文件组织是项目可维护性的基础。当前根目录下有多个测试文件和临时文件，需要统一管理。

**Independent Test**: 可通过检查根目录文件列表，验证：1) 所有测试文件都以test_开头；2) 临时/无关文件都在temp/目录；3) 核心文件分类清晰（adapters/, core/, web/, specs/, docs/等）。

**Acceptance Scenarios**:

1. **Given** 根目录下有多个测试文件，**When** 检查文件命名，**Then** 所有测试文件都以test_开头（如test_tdx_mvp.py）
2. **Given** 存在无关或临时文件，**When** 识别这些文件，**Then** 移动到temp/目录并记录迁移原因
3. **Given** temp/目录中的文件已观察一段时间，**When** 确认无用，**Then** 请示JohnC后删除
4. **Given** 需要运行所有测试，**When** 执行`pytest test_*.py`，**Then** 自动发现并运行所有测试用例
5. **Given** 项目目录结构，**When** 新成员查看，**Then** 能快速理解各目录用途和文件分类逻辑

---

### User Story 5 - .gitignore配置优化 (Priority: P3)

作为开发者，我需要.gitignore文件正确排除不必要的文件（.env, __pycache__, *.log, IDE配置等），以便保持Git仓库清洁、避免敏感信息泄露、减少无意义的提交冲突。

**Why this priority**: 这是Git使用的最佳实践，虽不影响核心功能，但能显著改善开发体验。当前git status显示多个应该忽略的文件（如__pycache__）。

**Independent Test**: 可通过运行`git status`检查是否还有应该被忽略但未被忽略的文件类型，并验证.env等敏感文件确实被排除。

**Acceptance Scenarios**:

1. **Given** 运行git status显示__pycache__文件，**When** 更新.gitignore，**Then** 这些文件被自动忽略
2. **Given** 存在.env文件包含敏感信息，**When** 检查.gitignore，**Then** .env被排除且有.env.example作为模板
3. **Given** 生成日志文件（*.log），**When** 运行git status，**Then** 日志文件被自动忽略
4. **Given** 使用不同IDE（VSCode, PyCharm等），**When** 生成IDE配置文件，**Then** 这些文件被自动忽略
5. **Given** 前端生成node_modules和build文件，**When** 检查web/.gitignore，**Then** 这些目录被正确排除

---

### Edge Cases

- **跨市场数据关联**: A+H股关联在本次规范化中不处理，仅在代码（如adapters/接口定义）中预留接口方法和TODO注释，说明"预留给后续A+H关联功能"，确保接口扩展性
- **历史数据兼容性**: 清理非业务范围代码前，必须先备份相关数据库表和数据（使用mysqldump或pg_dump），备份完成后删除非业务范围的表结构和数据，清理相关代码和配置
- **文档批量更新**: 采用手动更新方式，仅针对10-15个核心文档（README.md、CHANGELOG、QUICKSTART、各主要模块的README等）补充元数据标记，其他次要文档暂不处理，留待下次修改时同步更新
- **注释语言混用**: 技术术语保留英文（如API、DataFrame、Token、Cache、Exception等），其他描述性注释统一为中文，遵循"技术名词英文+解释中文"原则
- **测试文件迁移**: 重命名测试文件（如simple_test.py→test_simple.py）后，立即运行`pytest test_*.py -v`验证，如有import错误则修复相关路径引用，确保所有测试通过后再提交代码
- **.gitignore冲突**: 全局.gitignore处理通用规则（Python缓存、日志等），子目录.gitignore处理特定规则（如web/frontend/.gitignore处理node_modules），子目录规则优先级更高，使用`!`排除规则处理特殊情况（如!.env.example）

## Requirements *(mandatory)*

### Functional Requirements

#### 业务范围限定 (P1)

- **FR-001**: 系统必须仅支持A股（上海、深圳、创业板、科创板）的数据获取和分析
- **FR-002**: 系统必须支持股指期货（如沪深300、上证50、中证500指数期货）的数据获取
- **FR-003**: 系统可选支持H股（香港联交所上市的中国大陆公司股票）数据，但必须在配置中明确标识为可选；H股相关接口在代码中预留并添加TODO注释，说明为后续功能预留
- **FR-004**: 系统必须删除或移除所有与期货、期权、外汇、黄金、美股相关的代码和配置；删除前必须备份相关数据库表和数据（如存在）
- **FR-005**: 系统必须在配置文件中明确声明支持的市场范围，便于后续审查

#### 文档标记规范 (P1)

- **FR-006**: 所有MD文档必须在文件开头包含以下元数据标记：
  - **创建人**: 实际创建者（Claude, Spec-Kit, JohnC等）
  - **版本**: 语义化版本号（如1.0.0）
  - **批准日期**: YYYY-MM-DD格式
  - **最后修订**: YYYY-MM-DD格式
  - **本次修订内容**: 简要描述本次修改
- **FR-007**: 文档模板必须包含标准元数据占位符，便于新文档创建
- **FR-008**: 现有核心文档必须手动逐个补充元数据标记，范围包括：README.md、CHANGELOG、QUICKSTART、各主要模块的README（adapters/、web/、monitoring/等），共10-15个核心文档；其他次要文档暂不处理
- **FR-009**: 文档修改时必须同步更新"最后修订"和"修订内容"字段

#### Python代码注释规范 (P2)

- **FR-010**: 所有Python文件必须包含文件头注释，内容包括：
  - 编码声明（如需兼容Python 2.x）
  - 功能描述（简要说明文件用途）
  - 作者与联系方式（JohnC & iFlow/Claude等）
  - 日期和版本号
  - 依赖说明（关键依赖或指向requirements.txt）
  - 使用说明/注意事项（重要约束）
  - 版权声明
- **FR-011**: 所有自定义类必须包含类文档字符串（docstring），说明类的功能和主要属性
- **FR-012**: 所有自定义函数必须包含函数文档字符串，说明：
  - 函数功能
  - 参数含义和类型
  - 返回值说明
  - 基本使用示例（如需要）
- **FR-013**: 代码内注释遵循适度原则：复杂逻辑必须注释，简单代码不过度注释
- **FR-014**: 注释语言遵循"技术术语英文+解释中文"原则：技术术语保留英文（如API、DataFrame、Token、Cache、Exception等），其他描述性注释统一为中文

#### 文件和测试管理 (P2)

- **FR-015**: 所有测试文件必须以`test_`开头命名（如test_tdx_mvp.py）；重命名测试文件后必须立即运行`pytest test_*.py -v`验证，确保所有测试通过后再提交
- **FR-016**: 根目录下与项目无关的文件、空文件必须移动到`temp/`目录
- **FR-017**: 系统必须创建`temp/`目录用于集中管理待删除文件
- **FR-018**: 移动到temp/的文件必须记录迁移原因和观察期（如30天）；重命名测试文件时如有import错误，必须修复相关路径引用
- **FR-019**: 项目必须遵循清晰的目录结构规范：
  - `adapters/` - 数据源适配器
  - `core/` 或 `core.py` - 核心管理模块
  - `web/` - Web系统（前端+后端）
  - `specs/` - 功能规格文档
  - `docs/` 或根目录 - 项目文档
  - `tests/` 或 `test_*.py` - 测试文件
  - `temp/` - 临时/待删除文件
  - `utils/` - 工具函数

#### .gitignore配置 (P3)

- **FR-020**: .gitignore必须排除环境配置文件（.env, .env.local等）
- **FR-021**: .gitignore必须排除Python缓存文件（__pycache__/, *.pyc, *.pyo, *.pyd）
- **FR-022**: .gitignore必须排除日志文件（*.log, logs/）
- **FR-023**: .gitignore必须排除IDE配置（.vscode/, .idea/, *.swp）
- **FR-024**: .gitignore必须排除前端依赖和构建文件（node_modules/, dist/, build/）
- **FR-025**: .gitignore必须排除测试覆盖率报告（.coverage, htmlcov/, .pytest_cache/）
- **FR-026**: .gitignore必须排除临时文件（temp/, *.tmp）
- **FR-027**: 必须提供.env.example作为环境变量配置模板

### Key Entities

- **文档元数据（DocumentMetadata）**: 包含创建人、版本、批准日期、最后修订、修订内容等字段，用于追溯文档历史
- **代码注释规范（CodeCommentStandard）**: 定义文件头注释、类docstring、函数docstring的必需内容和格式
- **业务范围配置（BusinessScope）**: 定义系统支持的市场类型（A股、股指期货、H股）及其优先级（必要/可选）
- **文件分类规则（FileClassificationRule）**: 定义各类文件应存放的目录位置和命名规范
- **忽略规则（IgnoreRule）**: 定义应被Git忽略的文件类型和目录模式

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 代码库中不存在期货、期权、外汇、黄金、美股相关的代码文件或配置（通过关键词搜索验证，0结果）
- **SC-002**: 所有核心MD文档（至少10个主要文档）包含完整的5个元数据标记字段（100%合规率）
- **SC-003**: 所有核心Python文件（adapters/, core.py, unified_manager.py等，至少20个文件）包含标准头部注释（100%合规率）
- **SC-004**: 所有测试文件（至少10个）都以test_开头命名（100%合规率）
- **SC-005**: 运行`git status`时，不再显示应该被忽略的文件类型（__pycache__, *.log, .env等），0未跟踪的应忽略文件
- **SC-006**: 项目根目录下的文件数量减少至少50%（通过将临时文件移至temp/）
- **SC-007**: 新成员能在30分钟内通过文档了解系统的业务范围、目录结构、代码规范（通过新成员反馈调查）
- **SC-008**: 代码审查时，检查注释和文档规范的时间减少70%（有明确规范可参考）

### Quality Outcomes

- **SC-009**: 系统架构清晰度提升 - 新成员能快速识别哪些功能在业务范围内，哪些不在
- **SC-010**: 文档可追溯性提升 - 能快速找到任何文档的创建者和修改历史
- **SC-011**: 代码可维护性提升 - 通过标准化注释，降低理解和修改代码的时间成本
- **SC-012**: Git仓库清洁度提升 - 减少不必要的文件提交和冲突

## Assumptions

1. **现有代码保留**: 清理非业务范围代码时，假设现有A股、股指期货相关的核心功能不受影响
2. **H股为可选**: H股数据支持作为可选功能，暂不强制实现，但需要预留接口
3. **文档语言**: 假设所有文档和注释统一使用中文，除非涉及技术术语（如API、Git等）
4. **Python版本**: 假设项目使用Python 3.8+，无需Python 2.x兼容性声明
5. **工具可用**: 假设可以使用自动化脚本批量更新文档元数据和检查代码规范
6. **观察期**: 临时文件移至temp/后，默认观察30天再决定是否删除
7. **IDE多样性**: 假设团队成员可能使用不同IDE（VSCode, PyCharm, Vim等），需要在.gitignore中覆盖主流IDE配置
8. **测试框架**: 假设使用pytest作为测试框架，测试文件命名遵循pytest的test_前缀约定

## Out of Scope

以下内容不在本次规范化改进范围内：

1. **功能开发**: 不涉及新功能开发或现有功能逻辑修改
2. **数据库重构**: 不涉及数据库表结构调整或数据迁移
3. **性能优化**: 不涉及代码性能优化或架构重构
4. **UI/UX改进**: 不涉及Web界面的设计或交互优化
5. **自动化工具开发**: 可以使用现有工具，但不专门开发复杂的自动化工具（简单脚本可以）
6. **CI/CD配置**: 不涉及持续集成/部署流程的搭建（但测试文件规范化为后续CI/CD打基础）
7. **国际化**: 不涉及多语言支持或国际化配置

## Dependencies

1. **改进意见0.md**: 本规格说明基于该文档的要求制定
2. **现有代码库**: 依赖于当前mystocks_spec项目的代码结构
3. **Git版本控制**: 依赖Git进行版本管理和.gitignore配置
4. **Speckit工具**: 使用speckit进行规格管理和任务跟踪

## Risks and Mitigations

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 清理代码时误删重要功能 | 高 | 1) 使用temp/目录缓冲，不直接删除；2) 在删除前请示JohnC；3) 确保有Git历史可回滚 |
| 批量更新文档元数据时格式不一致 | 中 | 使用统一的模板和自动化脚本，人工审查关键文档 |
| 测试文件重命名导致import路径失效 | 中 | 重命名后立即运行所有测试，确保无破坏 |
| .gitignore配置过于激进导致重要文件被忽略 | 高 | 使用白名单机制（如!.env.example），多次验证git status |
| 注释规范过于严格影响开发效率 | 低 | 规范适度，复杂代码必须注释，简单代码可省略 |

## Next Steps

完成本规格说明后，建议的后续步骤：

1. **运行 `/speckit.clarify`**: 识别规格中不清晰的地方，与JohnC确认细节
2. **运行 `/speckit.plan`**: 生成详细的实施计划和任务清单
3. **优先级执行**: 按P1→P2→P3的顺序逐步实施
4. **阶段验收**: 每完成一个User Story，与JohnC确认验收标准
5. **文档归档**: 完成后更新CHANGELOG和DELIVERY文档
