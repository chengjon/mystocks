# Data Model: Quantitative Trading Integration

**Feature**: 010-integrate-quantitative-trading
**Date**: 2025-10-18
**Phase**: 1 - Design & Contracts

## Overview

This document defines the data entities, relationships, and validation rules for the quantitative trading feature. All entities are designed to integrate with MyStocks' 5-tier data classification system.

---

## Entity Definitions

### 1. Strategy

**Purpose**: Represents a custom stock screening algorithm with parameters, entry/exit logic, and metadata

**Classification**: Meta Data → MySQL/MariaDB (Constitution compliance)

**Attributes**:

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| id | BIGINT AUTO_INCREMENT | Yes | Unique strategy identifier | Primary key |
| name | VARCHAR(100) | Yes | Strategy name | Unique, alphanumeric + hyphen/underscore |
| version | VARCHAR(20) | Yes | Strategy version (semantic versioning) | Format: X.Y.Z |
| description | TEXT | No | Strategy description and rationale | Max 2000 chars |
| parameters | JSON | Yes | Strategy parameters (indicator periods, thresholds) | Valid JSON object |
| code_hash | VARCHAR(64) | Yes | SHA-256 hash of strategy code | Hex string, 64 chars |
| created_at | TIMESTAMP | Yes | Creation timestamp | Auto-generated |
| updated_at | TIMESTAMP | Yes | Last update timestamp | Auto-updated on change |
| created_by | VARCHAR(50) | Yes | User/system identifier | Alphanumeric |
| is_active | BOOLEAN | Yes | Whether strategy is currently active | Default: true |
| tags | JSON | No | Category tags for organization | JSON array of strings |

**Relationships**:
- Has many `Signal` entities (one strategy generates multiple signals)
- Has many `BacktestResult` entities (one strategy can be backtested multiple times)

**State Transitions**:
- Draft → Active (when first deployed)
- Active → Inactive (when deprecated)
- Active → Active (version updates)

**Example**:
```json
{
  "id": 1,
  "name": "ma_crossover_strategy",
  "version": "1.2.0",
  "description": "Moving average crossover with RSI filter",
  "parameters": {
    "ma_short": 5,
    "ma_long": 20,
    "rsi_period": 14,
    "rsi_threshold": 30
  },
  "code_hash": "a3d5e8f...",
  "created_at": "2025-01-15T10:30:00Z",
  "is_active": true,
  "tags": ["momentum", "technical", "intraday"]
}
```

---

### 2. Signal

**Purpose**: Represents a buy or sell signal generated by a strategy for a specific stock on a specific date

**Classification**: Derived Data → PostgreSQL+TimescaleDB (Constitution compliance)

**Attributes**:

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| id | BIGINT AUTO_INCREMENT | Yes | Unique signal identifier | Primary key |
| strategy_id | BIGINT | Yes | Foreign key to Strategy | References strategy.id |
| symbol | VARCHAR(20) | Yes | Stock symbol | Format: 6 digits or exchange.symbol |
| signal_date | DATE | Yes | Date when signal was generated | Valid date, not future |
| signal_type | VARCHAR(10) | Yes | Signal type: 'buy' or 'sell' | Enum: ['buy', 'sell'] |
| signal_strength | FLOAT | No | Signal confidence score (0.0-1.0) | Range: 0.0-1.0 |
| entry_price | DECIMAL(10,3) | Yes | Price at signal generation | Positive value |
| indicators | JSON | No | Snapshot of indicator values at signal time | Valid JSON |
| metadata | JSON | No | Additional context (volume, market conditions) | Valid JSON |
| created_at | TIMESTAMP | Yes | Record creation timestamp | Auto-generated |

**Relationships**:
- Belongs to one `Strategy` (many signals per strategy)
- Related to `BacktestResult` via strategy_id and date range

**Indexes**:
- Primary: (id)
- Composite: (strategy_id, symbol, signal_date) - for fast queries by strategy and stock
- Index: (signal_date) - for time-range queries
- Index: (symbol, signal_date) - for stock-specific signal history

**Validation Rules**:
- Buy and sell signals for same strategy/symbol must not overlap (no concurrent positions)
- signal_date must be a valid trading day
- signal_strength must be between 0.0 and 1.0 if provided
- entry_price must be positive

**Example**:
```json
{
  "id": 12345,
  "strategy_id": 1,
  "symbol": "000001",
  "signal_date": "2025-01-20",
  "signal_type": "buy",
  "signal_strength": 0.85,
  "entry_price": 12.34,
  "indicators": {
    "ma_5": 12.10,
    "ma_20": 11.80,
    "rsi_14": 28.5
  },
  "metadata": {
    "volume": 1500000,
    "market_condition": "bullish"
  },
  "created_at": "2025-01-20T15:05:00Z"
}
```

---

### 3. BacktestResult

**Purpose**: Represents the outcome of a historical strategy backtest, including performance metrics and trade log

**Classification**: Derived Data → PostgreSQL+TimescaleDB (Constitution compliance)

**Attributes**:

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| id | BIGINT AUTO_INCREMENT | Yes | Unique backtest identifier | Primary key |
| strategy_id | BIGINT | Yes | Foreign key to Strategy | References strategy.id |
| start_date | DATE | Yes | Backtest start date | Valid date, before end_date |
| end_date | DATE | Yes | Backtest end date | Valid date, after start_date |
| initial_capital | DECIMAL(15,2) | Yes | Starting capital amount | Positive value |
| final_capital | DECIMAL(15,2) | Yes | Ending capital amount | Non-negative value |
| total_return | FLOAT | Yes | Total return percentage | Can be negative |
| annualized_return | FLOAT | Yes | Annualized return percentage | Calculated from total_return |
| max_drawdown | FLOAT | Yes | Maximum drawdown percentage | Range: 0.0-1.0 |
| sharpe_ratio | FLOAT | No | Sharpe ratio (risk-adjusted return) | Typically -3.0 to 5.0 |
| win_rate | FLOAT | No | Percentage of winning trades | Range: 0.0-1.0 |
| total_trades | INT | Yes | Total number of trades executed | Non-negative |
| benchmark_return | FLOAT | No | Benchmark index return for comparison | Can be negative |
| commission_rate | FLOAT | Yes | Commission rate used in backtest | Range: 0.0-0.01 |
| slippage_rate | FLOAT | Yes | Slippage rate assumed | Range: 0.0-0.01 |
| metrics_json | JSONB | Yes | Detailed performance metrics | Valid JSONB |
| equity_curve | JSONB | No | Time-series equity values | JSONB array |
| trade_log | JSONB | No | Detailed trade-by-trade records | JSONB array |
| created_at | TIMESTAMP | Yes | Backtest execution timestamp | Auto-generated |

**Relationships**:
- Belongs to one `Strategy` (many backtests per strategy)
- Aggregates multiple `Signal` entities within date range

**Indexes**:
- Primary: (id)
- Index: (strategy_id, start_date, end_date) - for strategy performance history
- Index: (created_at) - for recent backtests

**Validation Rules**:
- end_date > start_date (minimum 30 days for meaningful backtest)
- final_capital = initial_capital * (1 + total_return/100)
- max_drawdown must be between 0.0 and 1.0
- win_rate must be between 0.0 and 1.0 if provided
- total_trades must be non-negative

**Example**:
```json
{
  "id": 101,
  "strategy_id": 1,
  "start_date": "2020-01-01",
  "end_date": "2024-12-31",
  "initial_capital": 100000.00,
  "final_capital": 256280.00,
  "total_return": 156.28,
  "annualized_return": 9.98,
  "max_drawdown": 0.2235,
  "sharpe_ratio": 1.45,
  "win_rate": 0.62,
  "total_trades": 45,
  "benchmark_return": 45.89,
  "commission_rate": 0.0003,
  "slippage_rate": 0.0001,
  "metrics_json": {
    "sortino_ratio": 1.87,
    "calmar_ratio": 0.45,
    "profit_factor": 1.8,
    "avg_win": 8500.00,
    "avg_loss": -4200.00
  },
  "equity_curve": [
    {"date": "2020-01-01", "value": 100000},
    {"date": "2020-01-02", "value": 100500},
    ...
  ],
  "trade_log": [
    {
      "entry_date": "2020-01-15",
      "exit_date": "2020-02-10",
      "symbol": "000001",
      "shares": 1000,
      "entry_price": 12.34,
      "exit_price": 13.50,
      "pnl": 1160.00,
      "return_pct": 9.41
    },
    ...
  ],
  "created_at": "2025-01-20T18:30:00Z"
}
```

---

### 4. TechnicalIndicator (In-Memory Entity)

**Purpose**: Represents a calculated technical analysis metric derived from price/volume data

**Classification**: Derived Data (cached in-memory, optional persistent storage)

**Attributes**:

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| symbol | VARCHAR(20) | Yes | Stock symbol | Format: 6 digits or exchange.symbol |
| indicator_name | VARCHAR(50) | Yes | Indicator name (RSI, MACD, MA, etc.) | Alphanumeric + underscore |
| parameters | DICT | Yes | Indicator parameters | E.g., {"period": 14} |
| values | ARRAY | Yes | Time-series indicator values | Numpy array or pandas Series |
| calculation_date | DATE | Yes | Date of calculation | Valid date |
| cache_ttl | INT | Yes | Cache time-to-live in seconds | Default: 3600 (1 hour) |

**Storage Strategy**:
- Primary: In-memory cache during strategy execution (no persistent storage for MVP)
- Future: Optional PostgreSQL storage for frequently-used indicators
- Cache key: `{symbol}_{indicator_name}_{parameters_hash}`

**Validation Rules**:
- values length must match price data length
- NaN values allowed for initial warm-up period (e.g., first 14 days for RSI-14)
- Cached values expire after cache_ttl seconds

**Example** (Python object):
```python
{
    "symbol": "000001",
    "indicator_name": "RSI",
    "parameters": {"period": 14},
    "values": np.array([28.5, 32.1, 35.8, ...]),
    "calculation_date": datetime.date(2025, 1, 20),
    "cache_ttl": 3600
}
```

---

### 5. TDXDataImportJob

**Purpose**: Represents an import operation from Tongdaxin local files, tracking import progress and errors

**Classification**: Meta Data → MySQL/MariaDB (Constitution compliance)

**Attributes**:

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| id | BIGINT AUTO_INCREMENT | Yes | Unique job identifier | Primary key |
| job_type | VARCHAR(20) | Yes | Import type: 'full' or 'incremental' | Enum: ['full', 'incremental'] |
| market | VARCHAR(10) | Yes | Target market: 'sh', 'sz', 'bj', 'all' | Enum values |
| start_time | TIMESTAMP | Yes | Job start timestamp | Auto-generated |
| end_time | TIMESTAMP | No | Job completion timestamp | Set on finish |
| status | VARCHAR(20) | Yes | Job status | Enum: ['running', 'completed', 'failed', 'partial'] |
| total_files | INT | Yes | Total number of files to process | Non-negative |
| processed_files | INT | Yes | Number of files successfully processed | ≤ total_files |
| failed_files | INT | Yes | Number of files that failed processing | ≤ total_files |
| total_records | BIGINT | Yes | Total number of data records imported | Non-negative |
| error_log | JSON | No | Array of error details | JSON array |
| import_config | JSON | Yes | Configuration used for import | Valid JSON |
| created_by | VARCHAR(50) | Yes | User/system identifier | Alphanumeric |

**Relationships**:
- Standalone entity (no direct foreign keys)
- Indirectly related to market data stored via import

**Indexes**:
- Primary: (id)
- Index: (start_time) - for job history queries
- Index: (status) - for monitoring active jobs

**Validation Rules**:
- processed_files + failed_files ≤ total_files
- status = 'completed' → end_time must be set
- status = 'failed' → error_log must contain at least one error

**Example**:
```json
{
  "id": 501,
  "job_type": "incremental",
  "market": "all",
  "start_time": "2025-01-20T16:05:00Z",
  "end_time": "2025-01-20T16:07:30Z",
  "status": "completed",
  "total_files": 3245,
  "processed_files": 3240,
  "failed_files": 5,
  "total_records": 1250000,
  "error_log": [
    {"file": "sh600000.day", "error": "Corrupted data at offset 1024"},
    ...
  ],
  "import_config": {
    "tdx_path": "/mnt/d/ProgramData/tdx_new/vipdoc",
    "apply_adjustment": true,
    "skip_weekends": true
  },
  "created_by": "system_cron"
}
```

---

### 6. ChartConfiguration (In-Memory Entity)

**Purpose**: Represents visualization settings for K-line charts, including date range and signal markers

**Classification**: Transient (not persisted, request-scoped)

**Attributes**:

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| symbol | VARCHAR(20) | Yes | Stock symbol to chart | Format: 6 digits |
| start_date | DATE | Yes | Chart start date | Valid date, before end_date |
| end_date | DATE | Yes | Chart end date | Valid date, after start_date |
| strategy_id | BIGINT | No | Strategy ID to overlay signals | References strategy.id |
| chart_type | VARCHAR(20) | Yes | Chart style: 'candle', 'ohlc', 'line' | Enum values |
| show_volume | BOOLEAN | Yes | Whether to show volume subplot | Default: true |
| show_signals | BOOLEAN | Yes | Whether to mark buy/sell signals | Default: true |
| show_holding_periods | BOOLEAN | Yes | Whether to highlight holding periods | Default: true |
| moving_averages | ARRAY | No | MA periods to overlay | E.g., [5, 20, 60] |
| output_format | VARCHAR(10) | Yes | Output format: 'png', 'html' | Enum: ['png', 'jpg', 'html'] |
| dpi | INT | No | Image resolution (for PNG/JPG) | Range: 72-300, default: 150 |

**Storage Strategy**:
- No persistent storage (ephemeral configuration object)
- Created per chart generation request
- Passed to visualization module as function parameters

**Validation Rules**:
- end_date > start_date (minimum 30 days for meaningful chart)
- moving_averages periods must be positive integers
- dpi must be between 72 and 300

**Example** (Python object):
```python
{
    "symbol": "000001",
    "start_date": datetime.date(2024, 1, 1),
    "end_date": datetime.date(2024, 12, 31),
    "strategy_id": 1,
    "chart_type": "candle",
    "show_volume": True,
    "show_signals": True,
    "show_holding_periods": True,
    "moving_averages": [5, 20, 60],
    "output_format": "png",
    "dpi": 150
}
```

---

## Entity Relationship Diagram (ERD)

```
┌─────────────┐
│  Strategy   │
│  (MySQL)    │
└──────┬──────┘
       │
       │ 1:N
       │
       ├──────────────────────┬─────────────────────┐
       │                      │                     │
       ▼                      ▼                     ▼
┌──────────────┐    ┌─────────────────┐    ┌───────────────┐
│    Signal    │    │ BacktestResult  │    │ (Transient)   │
│ (PostgreSQL) │    │  (PostgreSQL)   │    │ ChartConfig   │
└──────────────┘    └─────────────────┘    └───────────────┘
                              │
                              │ References date range
                              │
                              ▼
                      ┌──────────────┐
                      │   Signals    │
                      │ (aggregated) │
                      └──────────────┘

┌──────────────────┐
│ TDXDataImportJob │
│    (MySQL)       │  ← Standalone, no FK relationships
└──────────────────┘

┌─────────────────┐
│ TechnicalIndicator│ ← In-memory cache, no persistence
│   (In-Memory)     │
└─────────────────┘
```

**Relationship Summary**:
- Strategy → Signal (1:N)
- Strategy → BacktestResult (1:N)
- BacktestResult → Signal (aggregates via strategy_id + date range)
- TDXDataImportJob (standalone)
- TechnicalIndicator (in-memory, no relationships)
- ChartConfiguration (transient, no persistence)

---

## Database Schema Definitions

### Table: strategy (MySQL/MariaDB)

```sql
CREATE TABLE strategy (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    version VARCHAR(20) NOT NULL,
    description TEXT,
    parameters JSON NOT NULL,
    code_hash VARCHAR(64) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(50) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    tags JSON,
    INDEX idx_created_at (created_at),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### Table: strategy_signals (PostgreSQL+TimescaleDB)

```sql
CREATE TABLE strategy_signals (
    id BIGSERIAL PRIMARY KEY,
    strategy_id BIGINT NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    signal_date DATE NOT NULL,
    signal_type VARCHAR(10) NOT NULL CHECK (signal_type IN ('buy', 'sell')),
    signal_strength FLOAT CHECK (signal_strength >= 0.0 AND signal_strength <= 1.0),
    entry_price DECIMAL(10,3) NOT NULL CHECK (entry_price > 0),
    indicators JSONB,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT fk_strategy FOREIGN KEY (strategy_id) REFERENCES strategy(id) ON DELETE CASCADE
);

-- Create composite index for fast queries
CREATE INDEX idx_strategy_symbol_date ON strategy_signals (strategy_id, symbol, signal_date);
CREATE INDEX idx_signal_date ON strategy_signals (signal_date);
CREATE INDEX idx_symbol_date ON strategy_signals (symbol, signal_date);

-- Convert to TimescaleDB hypertable (optional, for time-series optimization)
SELECT create_hypertable('strategy_signals', 'signal_date', if_not_exists => TRUE);
```

### Table: backtest_results (PostgreSQL+TimescaleDB)

```sql
CREATE TABLE backtest_results (
    id BIGSERIAL PRIMARY KEY,
    strategy_id BIGINT NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL CHECK (end_date > start_date),
    initial_capital DECIMAL(15,2) NOT NULL CHECK (initial_capital > 0),
    final_capital DECIMAL(15,2) NOT NULL CHECK (final_capital >= 0),
    total_return FLOAT NOT NULL,
    annualized_return FLOAT NOT NULL,
    max_drawdown FLOAT NOT NULL CHECK (max_drawdown >= 0 AND max_drawdown <= 1),
    sharpe_ratio FLOAT,
    win_rate FLOAT CHECK (win_rate >= 0 AND win_rate <= 1),
    total_trades INT NOT NULL CHECK (total_trades >= 0),
    benchmark_return FLOAT,
    commission_rate FLOAT NOT NULL CHECK (commission_rate >= 0 AND commission_rate <= 0.01),
    slippage_rate FLOAT NOT NULL CHECK (slippage_rate >= 0 AND slippage_rate <= 0.01),
    metrics_json JSONB NOT NULL,
    equity_curve JSONB,
    trade_log JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT fk_strategy FOREIGN KEY (strategy_id) REFERENCES strategy(id) ON DELETE CASCADE
);

CREATE INDEX idx_strategy_date_range ON backtest_results (strategy_id, start_date, end_date);
CREATE INDEX idx_created_at ON backtest_results (created_at);

-- Convert to TimescaleDB hypertable (optional)
SELECT create_hypertable('backtest_results', 'start_date', if_not_exists => TRUE);
```

### Table: tdx_import_jobs (MySQL/MariaDB)

```sql
CREATE TABLE tdx_import_jobs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    job_type VARCHAR(20) NOT NULL CHECK (job_type IN ('full', 'incremental')),
    market VARCHAR(10) NOT NULL CHECK (market IN ('sh', 'sz', 'bj', 'all')),
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP,
    status VARCHAR(20) NOT NULL CHECK (status IN ('running', 'completed', 'failed', 'partial')),
    total_files INT NOT NULL CHECK (total_files >= 0),
    processed_files INT NOT NULL CHECK (processed_files >= 0),
    failed_files INT NOT NULL CHECK (failed_files >= 0),
    total_records BIGINT NOT NULL CHECK (total_records >= 0),
    error_log JSON,
    import_config JSON NOT NULL,
    created_by VARCHAR(50) NOT NULL,
    INDEX idx_start_time (start_time),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## Data Classification Mapping

| Entity | Data Type | Storage | Rationale |
|--------|-----------|---------|-----------|
| Strategy | Meta Data | MySQL/MariaDB | Configuration-type data, infrequent updates |
| Signal | Derived Data | PostgreSQL+TimescaleDB | Time-series computed results |
| BacktestResult | Derived Data | PostgreSQL+TimescaleDB | Analytical results with time-series equity curves |
| TechnicalIndicator | Derived Data | In-memory (optional PostgreSQL) | Computed metrics, cached for performance |
| TDXDataImportJob | Meta Data | MySQL/MariaDB | System monitoring and job tracking |
| ChartConfiguration | Transient | None | Request-scoped, no persistence |

All classifications comply with MyStocks Constitution Section I (5-Tier Data Classification System).

---

## Next Steps

1. Update `table_config.yaml` with new table definitions
2. Run `ConfigDrivenTableManager.batch_create_tables()` to create schemas
3. Implement API contracts in `contracts/` directory
4. Generate `quickstart.md` with example data operations
5. Update `.specify/memory/agent_context.md` with new entities
