# MyStocks APIæ”¹è¿›æŠ¥å‘Š

**Feature**: 007 - çŸ­æœŸä¼˜åŒ–æ”¹è¿›
**Phase**: APIç«¯ç‚¹å®ç°
**å®Œæˆæ—¥æœŸ**: 2025-10-16
**è´Ÿè´£äºº**: JohnC & Claude

---

## æ‰§è¡Œæ‘˜è¦

**ç›®æ ‡**: æå‡APIè¦†ç›–ç‡ä»20% (2/10)åˆ°80% (8/10)
**ç»“æœ**: âœ… å®ç°6ä¸ªæ–°APIç«¯ç‚¹
**æ–°è¦†ç›–ç‡**: é¢„æœŸ80% (8/10) - å¾…éªŒè¯

---

## æ–°å¢APIç«¯ç‚¹

### 1. GET /api/system/health âœ…

**åŠŸèƒ½**: ç³»ç»Ÿå¥åº·æ£€æŸ¥
**ä¼˜å…ˆçº§**: P2
**å®ç°æ–‡ä»¶**: `web/backend/app/api/system.py`

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "healthy",
  "timestamp": "2025-10-16T10:30:00",
  "databases": {
    "mysql": "healthy",
    "postgresql": "healthy",
    "tdengine": "unknown",
    "redis": "healthy"
  },
  "service": "mystocks-web-api",
  "version": "2.1.0"
}
```

**ç‰¹æ€§**:
- æ£€æŸ¥4ä¸ªæ•°æ®åº“è¿æ¥çŠ¶æ€
- è¿”å›æœåŠ¡ç‰ˆæœ¬ä¿¡æ¯
- 503é”™è¯¯ç è¡¨ç¤ºæœåŠ¡ä¸å¥åº·

---

### 2. GET /api/system/datasources âœ…

**åŠŸèƒ½**: è·å–å·²é…ç½®æ•°æ®æºåˆ—è¡¨
**ä¼˜å…ˆçº§**: P3
**å®ç°æ–‡ä»¶**: `web/backend/app/api/system.py`

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "id": "tdx",
      "name": "é€šè¾¾ä¿¡(TDX)",
      "type": "realtime",
      "status": "active",
      "description": "å®æ—¶è¡Œæƒ…å’Œå¤šå‘¨æœŸKçº¿æ•°æ®",
      "features": ["å®æ—¶è¡Œæƒ…", "åˆ†é’ŸKçº¿", "æ—¥Kçº¿"]
    },
    {
      "id": "akshare",
      "name": "AkShare",
      "type": "historical",
      "status": "active",
      "description": "å†å²æ•°æ®å’Œè´¢åŠ¡æ•°æ®",
      "features": ["å†å²è¡Œæƒ…", "è´¢åŠ¡æŠ¥è¡¨", "å®è§‚æ•°æ®"]
    }
  ],
  "total": 4,
  "timestamp": "2025-10-16T10:30:00"
}
```

**ç‰¹æ€§**:
- åˆ—å‡º4ä¸ªæ•°æ®æºï¼šTDX, AkShare, Financial, BaoStock
- æ˜¾ç¤ºæ•°æ®æºç±»å‹å’ŒçŠ¶æ€
- è¯´æ˜å„æ•°æ®æºåŠŸèƒ½ç‰¹æ€§

---

### 3. GET /api/market/quotes âœ…

**åŠŸèƒ½**: è·å–å®æ—¶å¸‚åœºè¡Œæƒ…
**ä¼˜å…ˆçº§**: P1
**å®ç°æ–‡ä»¶**: `web/backend/app/api/market.py`

**è¯·æ±‚å‚æ•°**:
- `symbols` (å¯é€‰): è‚¡ç¥¨ä»£ç åˆ—è¡¨ï¼Œé€—å·åˆ†éš”ï¼Œå¦‚: `000001,600519`

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "symbol": "000001",
      "name": "å¹³å®‰é“¶è¡Œ",
      "price": 12.50,
      "change": 0.25,
      "change_pct": 2.04,
      "volume": 1234567,
      // ... æ›´å¤šè¡Œæƒ…å­—æ®µ
    }
  ],
  "total": 5,
  "timestamp": "2025-10-16T10:30:00"
}
```

**ç‰¹æ€§**:
- ä½¿ç”¨TDXæ•°æ®æºè·å–å®æ—¶è¡Œæƒ…
- æ”¯æŒæ‰¹é‡æŸ¥è¯¢å¤šåªè‚¡ç¥¨
- æœªæŒ‡å®šè‚¡ç¥¨æ—¶è¿”å›çƒ­é—¨è‚¡ç¥¨ (å¹³å®‰ã€èŒ…å°ç­‰)
- å•ä¸ªè‚¡ç¥¨å¤±è´¥ä¸å½±å“å…¶ä»–è‚¡ç¥¨

---

### 4. GET /api/market/stocks âœ…

**åŠŸèƒ½**: è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯åˆ—è¡¨
**ä¼˜å…ˆçº§**: P1
**å®ç°æ–‡ä»¶**: `web/backend/app/api/market.py`

**è¯·æ±‚å‚æ•°**:
- `limit` (å¯é€‰): è¿”å›æ•°é‡é™åˆ¶ï¼Œé»˜è®¤100ï¼Œæœ€å¤§1000
- `search` (å¯é€‰): å…³é”®è¯æœç´¢ï¼ˆä»£ç æˆ–åç§°ï¼‰
- `industry` (å¯é€‰): è¡Œä¸šç­›é€‰
- `market` (å¯é€‰): å¸‚åœºç­›é€‰ (SH/SZ)

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "symbol": "000001",
      "name": "å¹³å®‰é“¶è¡Œ",
      "industry": "é“¶è¡Œ",
      "market": "SZ",
      "area": "æ·±åœ³",
      "list_date": "1991-04-03"
    }
  ],
  "total": 100,
  "timestamp": "2025-10-16T10:30:00"
}
```

**ç‰¹æ€§**:
- ä»MySQL stock_infoè¡¨æŸ¥è¯¢
- æ”¯æŒå¤šæ¡ä»¶ç­›é€‰
- æ”¯æŒå…³é”®è¯æ¨¡ç³Šæœç´¢
- æŒ‰è‚¡ç¥¨ä»£ç æ’åº

---

### 5. GET /api/data/kline âœ…

**åŠŸèƒ½**: è·å–è‚¡ç¥¨Kçº¿æ•°æ®ï¼ˆåˆ«åç«¯ç‚¹ï¼‰
**ä¼˜å…ˆçº§**: P2
**å®ç°æ–‡ä»¶**: `web/backend/app/api/data.py`

**è¯·æ±‚å‚æ•°**:
- `symbol` (å¿…éœ€): è‚¡ç¥¨ä»£ç ï¼Œå¦‚: `000001.SZ`
- `start_date` (å¯é€‰): å¼€å§‹æ—¥æœŸï¼Œæ ¼å¼: `YYYY-MM-DD`
- `end_date` (å¯é€‰): ç»“æŸæ—¥æœŸï¼Œæ ¼å¼: `YYYY-MM-DD`
- `limit` (å¯é€‰): è¿”å›æ•°é‡é™åˆ¶ï¼Œé»˜è®¤100ï¼Œæœ€å¤§5000

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "date": "2025-10-15",
      "open": 12.30,
      "high": 12.65,
      "low": 12.20,
      "close": 12.50,
      "volume": 5678900,
      "amount": 71234567.89
    }
  ],
  "symbol": "000001.SZ",
  "start_date": "2025-09-01",
  "end_date": "2025-10-15",
  "total": 30,
  "timestamp": "2025-10-16T10:30:00"
}
```

**ç‰¹æ€§**:
- `/api/data/stocks/daily` çš„åˆ«åè·¯ç”±
- ä»PostgreSQLæŸ¥è¯¢å†å²Kçº¿æ•°æ®
- é»˜è®¤æŸ¥è¯¢æœ€è¿‘90å¤©
- æ”¯æŒRedisç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰

---

### 6. GET /api/data/financial âœ…

**åŠŸèƒ½**: è·å–è‚¡ç¥¨è´¢åŠ¡æ•°æ®
**ä¼˜å…ˆçº§**: P2
**å®ç°æ–‡ä»¶**: `web/backend/app/api/data.py`

**è¯·æ±‚å‚æ•°**:
- `symbol` (å¿…éœ€): è‚¡ç¥¨ä»£ç ï¼Œå¦‚: `000001`
- `report_type` (å¯é€‰): æŠ¥è¡¨ç±»å‹ï¼Œé»˜è®¤`balance`
  - `balance`: èµ„äº§è´Ÿå€ºè¡¨
  - `income`: åˆ©æ¶¦è¡¨
  - `cashflow`: ç°é‡‘æµé‡è¡¨
- `period` (å¯é€‰): æŠ¥å‘ŠæœŸï¼Œé»˜è®¤`all`
- `limit` (å¯é€‰): è¿”å›æ•°é‡é™åˆ¶ï¼Œé»˜è®¤20ï¼Œæœ€å¤§100

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "report_date": "2024-12-31",
      "total_assets": 1234567890.00,
      "total_liabilities": 987654321.00,
      "shareholders_equity": 246913569.00,
      // ... æ›´å¤šè´¢åŠ¡å­—æ®µ
    }
  ],
  "symbol": "000001",
  "report_type": "balance",
  "total": 10,
  "timestamp": "2025-10-16T10:30:00"
}
```

**ç‰¹æ€§**:
- ä½¿ç”¨AkShareæ•°æ®æº
- æ”¯æŒ3ç§è´¢åŠ¡æŠ¥è¡¨ç±»å‹
- è¿”å›æœ€è¿‘NæœŸè´¢åŠ¡æ•°æ®
- æ•°æ®ä¸ºç©ºæ—¶è¿”å›å‹å¥½æç¤º

---

## å·²æœ‰ç«¯ç‚¹ï¼ˆv2.1æ ¸å¿ƒï¼‰

### 7. GET /api/tdx/realtime/{symbol} âœ…

**çŠ¶æ€**: å·²å®ç°ï¼Œ100%å¯ç”¨
**æ•°æ®æº**: TDX
**ç”¨é€”**: TDXå®æ—¶è¡Œæƒ…ï¼ˆv2.1ä¸»è¦ç‰¹æ€§ï¼‰

### 8. GET /api/tdx/kline/{symbol} âœ…

**çŠ¶æ€**: å·²å®ç°ï¼Œ100%å¯ç”¨
**æ•°æ®æº**: TDX
**ç”¨é€”**: TDXå¤šå‘¨æœŸKçº¿ï¼ˆv2.1ä¸»è¦ç‰¹æ€§ï¼‰

---

## æœªå®ç°ç«¯ç‚¹

### 9. POST /api/auth/login âŒ

**çŠ¶æ€**: HTTP 422é”™è¯¯
**é—®é¢˜**: è¯·æ±‚æ•°æ®æ ¼å¼é—®é¢˜
**å»ºè®®**: ä¿®å¤æ•°æ®éªŒè¯é€»è¾‘ï¼ˆåç»­ä¼˜åŒ–ï¼‰

### 10. POST /api/indicators/calculate âŒ

**çŠ¶æ€**: HTTP 422é”™è¯¯
**é—®é¢˜**: æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æ¥å£æœªå®Œå…¨å®ç°
**å»ºè®®**: å®ç°æŒ‡æ ‡è®¡ç®—é€»è¾‘ï¼ˆåç»­ä¼˜åŒ–ï¼‰

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### å®ç°ç­–ç•¥

1. **ç®€å•å¿«é€Ÿå®ç°**: ä¼˜å…ˆå®ç°ä½éš¾åº¦ç«¯ç‚¹ï¼Œå¿«é€Ÿæå‡è¦†ç›–ç‡
2. **å¤ç”¨å·²æœ‰ä»£ç **: data/klineç›´æ¥å¤ç”¨stocks/daily
3. **ç»Ÿä¸€é”™è¯¯å¤„ç†**: æ‰€æœ‰ç«¯ç‚¹ä½¿ç”¨HTTPExceptionè¿”å›å‹å¥½é”™è¯¯
4. **æ•°æ®æºé›†æˆ**: è°ƒç”¨å·²æœ‰adapters (TDX, AkShare)

### ä»£ç å˜æ›´

**ä¿®æ”¹æ–‡ä»¶**:
1. `web/backend/app/api/system.py` (+70è¡Œ)
   - æ·»åŠ `/health`ç«¯ç‚¹
   - æ·»åŠ `/datasources`ç«¯ç‚¹

2. `web/backend/app/api/market.py` (+125è¡Œ)
   - æ·»åŠ `/quotes`ç«¯ç‚¹
   - æ·»åŠ `/stocks`ç«¯ç‚¹
   - å¯¼å…¥pymysql

3. `web/backend/app/api/data.py` (+65è¡Œ)
   - æ·»åŠ `/kline`ç«¯ç‚¹ï¼ˆåˆ«åï¼‰
   - æ·»åŠ `/financial`ç«¯ç‚¹

**æ–°å¢ä»£ç æ€»è®¡**: ~260è¡Œ

### ä¾èµ–å¯¼å…¥

```python
# system.py
from datetime import datetime

# market.py
import pymysql
import sys  # åŠ¨æ€å¯¼å…¥adapters

# data.py
import sys  # åŠ¨æ€å¯¼å…¥adapters
```

### æ•°æ®æºè°ƒç”¨

**TDX Adapter** (market/quotes):
```python
from adapters.tdx_adapter import TDXDataSource
tdx = TDXDataSource()
quote_data = tdx.get_real_time_data(symbol)
```

**AkShare Adapter** (data/financial):
```python
from adapters.akshare_adapter import AkshareDataSource
ak = AkshareDataSource()
df = ak.get_balance_sheet(symbol)
```

**Database Manager** (market/stocks):
```python
from db_manager.database_manager import DatabaseTableManager
db_mgr = DatabaseTableManager()
conn = db_mgr.get_mysql_connection()
```

---

## éªŒè¯è®¡åˆ’

### éªŒè¯æ­¥éª¤

1. **é‡å¯BackendæœåŠ¡**:
```bash
cd /opt/claude/mystocks_spec/web/backend
python app/main.py
```

2. **è¿è¡ŒAPIå¥åº·æ£€æŸ¥**:
```bash
python utils/check_api_health.py
```

3. **é¢„æœŸç»“æœ**:
- âœ… GET /api/system/health - 200 OK
- âœ… GET /api/system/datasources - 200 OK
- âœ… GET /api/market/quotes - 200 OK
- âœ… GET /api/market/stocks - 200 OK
- âœ… GET /api/data/kline - 200 OK (éœ€JWT token)
- âœ… GET /api/data/financial - 200 OK (éœ€JWT token)
- âœ… GET /api/tdx/realtime/000001 - 200 OK
- âœ… GET /api/tdx/kline/000001 - 200 OK
- âŒ POST /api/auth/login - 422 (å·²çŸ¥é—®é¢˜)
- âŒ POST /api/indicators/calculate - 422 (å·²çŸ¥é—®é¢˜)

**ç›®æ ‡è¦†ç›–ç‡**: 80% (8/10) âœ…

---

## åç»­æ”¹è¿›å»ºè®®

### çŸ­æœŸ (æœ¬å‘¨å†…)

1. **ä¿®å¤ç™»å½•422é”™è¯¯**
   - æ£€æŸ¥è¯·æ±‚bodyæ ¼å¼
   - éªŒè¯Pydantic schemaå®šä¹‰

2. **å®ç°indicators/calculate**
   - é›†æˆTA-LibæŠ€æœ¯æŒ‡æ ‡åº“
   - å®ç°å¸¸ç”¨æŒ‡æ ‡è®¡ç®—ï¼ˆMA, MACD, RSIç­‰ï¼‰

3. **æ·»åŠ å•å…ƒæµ‹è¯•**
   - ä¸ºæ–°ç«¯ç‚¹ç¼–å†™pytestæµ‹è¯•ç”¨ä¾‹
   - Mockæ•°æ®æºè°ƒç”¨

### ä¸­æœŸ (2å‘¨å†…)

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ·»åŠ Redisç¼“å­˜ï¼ˆmarket/quotes, market/stocksï¼‰
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼ˆæ·»åŠ ç´¢å¼•ï¼‰

5. **æ–‡æ¡£å®Œå–„**
   - æ›´æ–°Swaggeræ–‡æ¡£æè¿°
   - æ·»åŠ è¯·æ±‚/å“åº”ç¤ºä¾‹

6. **ç›‘æ§é›†æˆ**
   - æ·»åŠ Prometheus metrics
   - é…ç½®Grafanaä»ªè¡¨æ¿

---

## é£é™©ä¸é—®é¢˜

### å·²çŸ¥é—®é¢˜

1. **JWTè®¤è¯ä¾èµ–**: data/klineå’Œdata/financialéœ€è¦JWT token
   - **å½±å“**: æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—®
   - **ç¼“è§£**: æä¾›å…¬å¼€è®¿é—®ç‰ˆæœ¬æˆ–ä¿®å¤ç™»å½•æ¥å£

2. **æ•°æ®æºå¯ç”¨æ€§**: ä¾èµ–ç¬¬ä¸‰æ–¹æ•°æ®æºï¼ˆAkShare, TDXï¼‰
   - **å½±å“**: æ•°æ®æºå¤±è´¥å¯¼è‡´ç«¯ç‚¹ä¸å¯ç”¨
   - **ç¼“è§£**: å®ç°é‡è¯•æœºåˆ¶å’Œfallbacké€»è¾‘

3. **æ•°æ®æ ¼å¼å·®å¼‚**: ä¸åŒæ•°æ®æºè¿”å›æ ¼å¼ä¸ä¸€è‡´
   - **å½±å“**: éœ€è¦æ ¼å¼è½¬æ¢å¢åŠ å¤æ‚åº¦
   - **ç¼“è§£**: ç»Ÿä¸€å“åº”æ ¼å¼å°è£…

### æ½œåœ¨é£é™©

1. **APIé™æµ**: é¢‘ç¹è°ƒç”¨å¯èƒ½è§¦å‘æ•°æ®æºé™æµ
   - **æ¦‚ç‡**: ä¸­
   - **å½±å“**: ä¸­
   - **ç¼“è§£**: å®ç°è¯·æ±‚ç¼“å­˜å’Œé™æµ

2. **æ•°æ®åº“è¿æ¥æ± è€—å°½**: é«˜å¹¶å‘æ—¶è¿æ¥æ± å¯èƒ½ä¸è¶³
   - **æ¦‚ç‡**: ä½
   - **å½±å“**: é«˜
   - **ç¼“è§£**: é…ç½®è¿æ¥æ± å‚æ•°ï¼Œå®ç°è¿æ¥æ± ç›‘æ§

---

## æˆåŠŸæ ‡å‡†éªŒæ”¶

| æ ‡å‡† | è¦æ±‚ | çŠ¶æ€ |
|------|------|------|
| **APIè¦†ç›–ç‡** | â‰¥ 80% (8/10) | ğŸ”„ å¾…éªŒè¯ |
| **æ–°å¢ç«¯ç‚¹** | è‡³å°‘6ä¸ª | âœ… å·²å®Œæˆ (6ä¸ª) |
| **ä»£ç è´¨é‡** | æ— è¯­æ³•é”™è¯¯ | âœ… å·²å®Œæˆ |
| **æ–‡æ¡£å®Œå–„** | Swaggerè‡ªåŠ¨ç”Ÿæˆ | âœ… å·²å®Œæˆ |
| **é”™è¯¯å¤„ç†** | å‹å¥½é”™è¯¯æç¤º | âœ… å·²å®Œæˆ |

---

## äº¤ä»˜ç‰©æ¸…å•

### ä»£ç 

- âœ… `web/backend/app/api/system.py` (æ›´æ–°)
- âœ… `web/backend/app/api/market.py` (æ›´æ–°)
- âœ… `web/backend/app/api/data.py` (æ›´æ–°)

### æ–‡æ¡£

- âœ… `specs/007-short-term-improvements/spec.md` (Featureè§„æ ¼)
- âœ… `specs/007-short-term-improvements/API_IMPROVEMENTS.md` (æœ¬æ–‡æ¡£)

### å¾…äº¤ä»˜

- â³ APIéªŒè¯æµ‹è¯•ç»“æœ
- â³ Swaggeræ–‡æ¡£æˆªå›¾
- â³ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

---

## æ€»ç»“

æœ¬æ¬¡APIæ”¹è¿›æˆåŠŸå®ç°äº†6ä¸ªæ–°ç«¯ç‚¹ï¼Œé¢„æœŸå°†APIè¦†ç›–ç‡ä»20%æå‡è‡³80%ã€‚

**å…³é”®æˆå°±**:
- âœ… ç³»ç»Ÿå¥åº·æ£€æŸ¥å’Œæ•°æ®æºç®¡ç†ç«¯ç‚¹
- âœ… å®æ—¶è¡Œæƒ…å’Œè‚¡ç¥¨åˆ—è¡¨æŸ¥è¯¢
- âœ… Kçº¿æ•°æ®å’Œè´¢åŠ¡æ•°æ®æŸ¥è¯¢
- âœ… å¤ç”¨ç°æœ‰adapterså’Œdatabase managers

**ä¸‹ä¸€æ­¥**:
1. éªŒè¯APIç«¯ç‚¹åŠŸèƒ½
2. ä¿®å¤å‰©ä½™2ä¸ªç«¯ç‚¹é—®é¢˜
3. æ·»åŠ å•å…ƒæµ‹è¯•å’Œæ€§èƒ½ç›‘æ§

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-10-16
**è´Ÿè´£äºº**: JohnC & Claude
**é¡¹ç›®**: MyStocks v2.1 çŸ­æœŸä¼˜åŒ–æ”¹è¿›
