# Feature Specification: TDX数据源Web集成

**创建人**: Claude & Spec-Kit
**版本**: 1.0.0
**批准日期**: 2025-10-15
**最后修订**: 2025-10-16
**本次修订内容**: TDX功能规格

---

**Feature Branch**: `005-tdx-web-tdx`
**Created**: 2025-10-15
**Status**: Draft
**Input**: User description: "TDX数据源Web集成 - 将TDX数据源适配器集成到现有的Web前后端系统中。后端使用FastAPI提供RESTful API接口,支持实时行情查询、历史K线数据获取(支持多周期:1m/5m/15m/30m/1h/1d)、指数数据查询。前端使用Vue3+Element Plus展示数据,包括:1)实时行情面板(股票搜索、实时价格、涨跌幅、成交量等);2)K线图表(基于klinecharts,支持多周期切换、技术指标叠加);3)指数行情监控(主要指数实时展示)。API设计遵循RESTful规范,路径为/api/tdx/*。需要集成现有的认证系统(JWT)和错误处理机制。数据刷新策略:实时行情每5秒自动刷新,K线图按需加载。"

## User Scenarios & Testing

### User Story 1 - 实时行情查询 (Priority: P1)

交易员需要快速查看特定股票的当前价格、涨跌幅和成交量,以便做出及时的交易决策。用户在搜索框输入股票代码或名称,系统显示实时行情数据,包括最新价、涨跌幅、成交量、五档行情等关键信息。数据每5秒自动刷新,确保信息的时效性。

**Why this priority**: 实时行情是量化交易系统的核心功能,是用户最频繁使用的功能,直接影响交易决策的时效性和准确性。没有实时行情,系统基本无法使用。

**Independent Test**: 可以独立测试 - 用户输入股票代码"600519"后立即看到贵州茅台的实时价格和涨跌幅,无需等待其他功能完成。

**Acceptance Scenarios**:

1. **Given** 用户已登录系统, **When** 用户在搜索框输入股票代码"600519", **Then** 系统显示贵州茅台的实时行情,包括最新价、涨跌幅、成交量、五档行情
2. **Given** 实时行情面板已显示某股票数据, **When** 5秒后数据更新, **Then** 页面自动刷新显示最新价格,无需用户手动操作
3. **Given** 用户输入股票名称"茅台", **When** 系统搜索, **Then** 显示匹配的股票列表供用户选择
4. **Given** 用户输入无效股票代码"999999", **When** 系统查询, **Then** 显示友好的错误提示"未找到该股票"

---

### User Story 2 - K线图表展示 (Priority: P1)

交易员需要查看股票的历史价格走势和技术形态,以便进行技术分析和制定交易策略。用户选择股票后,系统显示可交互的K线图表,支持多种时间周期切换(1分钟/5分钟/15分钟/30分钟/1小时/日线),用户可以通过图表工具进行缩放、平移等操作。

**Why this priority**: K线图是技术分析的基础工具,与实时行情同等重要。没有K线图,用户无法进行深入的技术分析,系统价值大幅降低。

**Independent Test**: 可以独立测试 - 用户选择股票"600519"并选择"日线"周期后,立即看到完整的K线图表,可以缩放和查看历史数据,独立于实时行情功能。

**Acceptance Scenarios**:

1. **Given** 用户已选择股票"600519", **When** 用户点击"日线"周期按钮, **Then** 系统显示该股票的日K线图表,默认显示最近90天数据
2. **Given** K线图表已显示, **When** 用户切换到"5分钟"周期, **Then** 图表立即更新为5分钟K线,显示最近2天数据
3. **Given** K线图表已显示, **When** 用户使用鼠标滚轮缩放, **Then** 图表响应缩放操作,显示更多或更少的K线数量
4. **Given** K线图表已显示, **When** 用户将鼠标悬停在某根K线上, **Then** 显示该时间点的详细数据(开高低收成交量)
5. **Given** 用户请求历史数据范围超出可用数据, **When** 系统查询, **Then** 返回实际可用的数据范围并提示用户

---

### User Story 3 - 指数行情监控 (Priority: P2)

交易员需要同时监控主要市场指数(上证指数、深证成指、创业板指)的实时走势,以便把握整体市场趋势。系统在独立区域显示主要指数的实时点位和涨跌幅,数据自动刷新。

**Why this priority**: 指数监控是重要的辅助功能,帮助用户了解大盘走势,但不是核心交易功能。即使没有指数监控,用户仍可以使用实时行情和K线图进行个股分析。

**Independent Test**: 可以独立测试 - 用户登录后在页面顶部看到上证指数、深证成指的实时点位和涨跌幅,无需依赖其他功能。

**Acceptance Scenarios**:

1. **Given** 用户已登录系统, **When** 页面加载完成, **Then** 系统自动显示上证指数(000001)、深证成指(399001)、创业板指(399006)的实时点位和涨跌幅
2. **Given** 指数行情已显示, **When** 5秒后数据更新, **Then** 指数数据自动刷新,涨跌幅颜色动态更新(涨红跌绿)
3. **Given** 用户点击某个指数, **When** 系统响应, **Then** 在主区域显示该指数的K线图表
4. **Given** 市场休市时间, **When** 用户查看指数, **Then** 显示最后交易日的收盘数据和"休市中"标识

---

### User Story 4 - 多周期K线切换 (Priority: P2)

交易员需要在不同时间周期之间快速切换,以便进行多时间框架分析。用户可以通过点击周期按钮在1分钟、5分钟、15分钟、30分钟、1小时和日线之间快速切换,系统立即加载相应周期的K线数据。

**Why this priority**: 多周期分析是高级交易策略的需求,增强了系统的专业性,但不是基础功能。有了基本的日线图表后,多周期切换是自然的功能扩展。

**Independent Test**: 可以独立测试 - 用户在K线图表界面点击不同周期按钮,图表立即切换到对应周期,每个周期都能独立加载和显示数据。

**Acceptance Scenarios**:

1. **Given** K线图表正在显示日线数据, **When** 用户点击"5分钟"按钮, **Then** 图表在2秒内切换为5分钟K线,显示最近2天的5分钟数据
2. **Given** K线图表正在显示5分钟数据, **When** 用户点击"1小时"按钮, **Then** 图表切换为1小时K线,显示最近30天的小时数据
3. **Given** 用户快速连续切换多个周期, **When** 系统响应, **Then** 只加载最后选择的周期数据,自动取消前面的请求
4. **Given** 某个周期的数据加载失败, **When** 用户尝试切换, **Then** 显示错误提示但不影响其他周期的使用

---

### User Story 5 - 用户认证和权限控制 (Priority: P1)

系统需要保护用户数据和行情数据,只有经过认证的用户才能访问。用户使用已有的账号密码登录,系统验证身份后允许访问TDX数据接口和前端页面。

**Why this priority**: 安全认证是Web应用的基础要求,没有认证系统会导致数据泄露和滥用。虽然不是业务核心,但必须在任何功能发布前完成。

**Independent Test**: 可以独立测试 - 未登录用户访问TDX相关页面时被重定向到登录页,登录成功后可以访问所有TDX功能。

**Acceptance Scenarios**:

1. **Given** 用户未登录, **When** 用户访问TDX行情页面, **Then** 系统重定向到登录页面并提示"请先登录"
2. **Given** 用户已登录但令牌过期, **When** 用户请求实时行情数据, **Then** 系统返回401错误并提示重新登录
3. **Given** 用户成功登录, **When** 用户访问TDX行情页面, **Then** 系统允许访问并显示完整功能
4. **Given** 用户使用无效令牌, **When** 用户请求API接口, **Then** 系统拒绝请求并返回403错误

---

### Edge Cases

- **网络断开场景**: 用户正在查看实时行情时网络突然断开,系统如何处理?应显示"连接中断"提示,停止自动刷新,待网络恢复后自动重连。
- **股票代码不存在**: 用户输入不存在的股票代码(如"999999"),系统应返回友好提示"未找到该股票,请检查代码是否正确",而不是技术错误信息。
- **数据源服务器宕机**: TDX服务器无响应时,系统应在3秒内返回超时错误,提示"行情服务暂时不可用,请稍后再试",而不是让用户无限等待。
- **大量并发请求**: 100个用户同时请求实时行情时,系统如何保证响应速度?应使用缓存机制,相同股票的请求在5秒内返回缓存数据。
- **K线数据量过大**: 用户请求超过5年的分钟级K线数据(数百万条),系统应限制单次请求的数据量,提示"数据量过大,请缩小时间范围"。
- **浏览器兼容性**: 在旧版浏览器(IE11)中访问K线图表,如果不支持应显示"请使用Chrome/Firefox/Edge最新版本"提示。
- **移动端访问**: 用户在手机浏览器访问时,K线图表应自适应屏幕尺寸,触摸操作代替鼠标操作。
- **市场休市时间**: 在非交易时间(如晚上10点或周末),实时行情应显示最后交易日的数据,并标注"休市中"状态。

## Requirements

### Functional Requirements

#### API接口要求

- **FR-001**: 系统必须提供RESTful API接口供前端调用,所有接口路径以`/api/tdx/`开头
- **FR-002**: 系统必须提供获取实时行情的接口,接受股票代码参数,返回包含最新价、涨跌幅、成交量等数据的JSON响应
- **FR-003**: 系统必须提供获取历史K线的接口,接受股票代码、开始日期、结束日期、周期类型参数,返回K线数据数组
- **FR-004**: 系统必须支持6种K线周期:1分钟、5分钟、15分钟、30分钟、1小时、日线
- **FR-005**: 系统必须提供获取指数实时行情的接口,支持上证指数、深证成指、创业板指等主要指数
- **FR-006**: 所有API接口必须遵循RESTful设计规范,使用标准HTTP方法(GET用于查询)
- **FR-007**: API响应必须使用统一的JSON格式,包含状态码、数据、错误信息等标准字段

#### 数据展示要求

- **FR-008**: 前端必须提供股票搜索功能,支持按股票代码或名称搜索
- **FR-009**: 前端必须显示实时行情面板,展示选中股票的最新价、昨收价、涨跌额、涨跌幅、开盘价、最高价、最低价、成交量、成交额
- **FR-010**: 实时行情必须每5秒自动刷新一次,无需用户手动操作
- **FR-011**: 前端必须提供交互式K线图表,支持鼠标缩放、平移、悬停查看详情
- **FR-012**: K线图表必须提供周期切换按钮,用户可以快速切换不同时间周期
- **FR-013**: 前端必须在页面顶部或侧边栏显示主要指数的实时行情,包括点位和涨跌幅
- **FR-014**: 涨跌幅必须使用颜色区分:正数显示红色,负数显示绿色,符合中国股市习惯

#### 认证和安全要求

- **FR-015**: 所有TDX API接口必须要求用户认证,未认证的请求返回401错误
- **FR-016**: 系统必须集成现有的JWT认证系统,验证请求头中的Authorization令牌
- **FR-017**: 令牌验证失败时,系统必须返回明确的错误信息,如"令牌无效"或"令牌已过期"
- **FR-018**: 前端必须在用户未登录时自动重定向到登录页面

#### 错误处理要求

- **FR-019**: 系统必须捕获并处理所有可能的错误,包括网络错误、数据源错误、参数错误
- **FR-020**: API接口返回错误时,必须使用合适的HTTP状态码(400参数错误、401未认证、404未找到、500服务器错误)
- **FR-021**: 错误响应必须包含用户友好的错误消息,而不是技术堆栈信息
- **FR-022**: 前端必须优雅地处理API错误,向用户显示友好提示而不是崩溃

#### 性能要求

- **FR-023**: 实时行情API响应时间必须在1秒内完成(90%的请求)
- **FR-024**: K线数据API响应时间必须在2秒内完成(对于500条以内的数据)
- **FR-025**: 系统必须支持缓存机制,相同股票的实时行情在5秒内返回缓存数据,减少TDX服务器压力
- **FR-026**: K线图表渲染必须流畅,500根K线的加载和显示在1秒内完成

#### 数据格式要求

- **FR-027**: 日期时间必须统一使用ISO 8601格式(YYYY-MM-DD HH:mm:ss)
- **FR-028**: 价格数据必须保留2位小数
- **FR-029**: 涨跌幅必须以百分比形式显示,保留2位小数
- **FR-030**: 成交量使用手为单位,成交额使用元为单位

### Key Entities

- **实时行情数据(RealTimeQuote)**: 表示某个股票在某一时刻的行情快照,包含股票代码、股票名称、最新价、昨收价、开盘价、最高价、最低价、成交量、成交额、涨跌额、涨跌幅、五档行情、时间戳等关键属性。

- **K线数据(KlineData)**: 表示某个股票在特定时间周期内的OHLCV数据,包含日期时间、开盘价、最高价、最低价、收盘价、成交量、成交额、周期类型(1m/5m/15m/30m/1h/1d)等属性。一个股票可以有多个周期的K线数据集合。

- **指数行情数据(IndexQuote)**: 表示某个市场指数的实时点位信息,包含指数代码、指数名称、当前点位、昨收点位、涨跌点数、涨跌幅、成交量、成交额、上涨家数、下跌家数、时间戳等属性。

- **用户会话(UserSession)**: 表示已登录用户的身份和权限信息,包含用户ID、用户名、JWT令牌、令牌过期时间、访问权限等属性。用户会话用于认证和授权API请求。

## Success Criteria

### Measurable Outcomes

- **SC-001**: 用户能够在输入股票代码后1秒内看到实时行情数据(95%的请求)
- **SC-002**: 用户能够在点击周期按钮后2秒内看到K线图表更新(90%的请求)
- **SC-003**: 系统能够同时支持50个并发用户查询实时行情,响应时间不超过2秒
- **SC-004**: 实时行情自动刷新功能正常工作,无需用户手动操作,刷新间隔误差在±1秒内
- **SC-005**: K线图表在加载500根K线时,渲染完成时间不超过1秒
- **SC-006**: 用户能够成功完成从登录到查看股票K线图的完整流程,耗时不超过30秒
- **SC-007**: API错误率低于1%(排除用户输入错误),系统稳定性达到99%
- **SC-008**: 用户在使用过程中遇到的错误都有友好提示,不会看到技术错误堆栈
- **SC-009**: 90%的用户在首次使用时能够无需帮助文档完成股票搜索和K线查看
- **SC-010**: 系统在TDX服务器响应延迟时能够在3秒内返回超时提示,不让用户无限等待

### Assumptions

1. **现有系统假设**: 假设MyStocks系统已经具备完整的用户认证系统(JWT),本功能只需要集成使用,不需要重新开发认证机制。
2. **TDX适配器假设**: 假设TDX数据源适配器(tdx_adapter.py)已经完成开发和测试,可以稳定提供实时行情和历史K线数据。
3. **前端框架假设**: 假设前端已经搭建了Vue3+Element Plus的基础框架,本功能只需要添加新的页面和组件。
4. **图表库假设**: 假设项目已经引入klinecharts库或愿意引入该库用于K线图表展示。
5. **网络环境假设**: 假设服务器能够正常访问TDX服务器(默认38个备用服务器),网络延迟在可接受范围内。
6. **数据权限假设**: 假设所有登录用户都有权限访问实时行情和历史K线数据,不需要区分VIP用户和普通用户。
7. **浏览器兼容性假设**: 假设目标用户使用现代浏览器(Chrome/Firefox/Edge/Safari最新版),不需要支持IE11。
8. **数据刷新频率假设**: 假设5秒的刷新频率能够满足大多数用户需求,不需要更高频率的实时推送(如WebSocket)。
9. **K线数据范围假设**: 假设用户主要查询最近1年以内的K线数据,超过1年的历史数据加载可能较慢但可以接受。
10. **API限流假设**: 假设系统不需要严格的API限流机制,但会使用缓存来减少对TDX服务器的压力。

### Dependencies

- **后端依赖**: 依赖TDX数据源适配器(adapters/tdx_adapter.py)和数据源管理器(adapters/data_source_manager.py)已完成开发
- **前端依赖**: 依赖Vue3、Element Plus、klinecharts等前端库已正确安装和配置
- **认证依赖**: 依赖现有的JWT认证系统(app/core/security.py或类似模块)能够正常验证令牌
- **数据库依赖**: 如果需要缓存实时行情数据,依赖Redis或其他缓存系统已部署并可用
- **网络依赖**: 依赖服务器能够访问TDX服务器(connect.cfg中配置的38个服务器)
