# Feature Specification: 股票数据扩展功能集成

**Feature Branch**: `003-inside-mystocks`
**Created**: 2025-10-14
**Status**: Draft
**Input**: User description: "股票数据扩展功能集成 - 将inside目录下的多个数据模块集成到现有MyStocks系统中,重点实现股票基本数据模块、股票指标模块和股票策略模块"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看股票基本数据和资金流向 (Priority: P1)

作为量化交易分析师,我需要查看股票的实时行情、历史K线数据、资金流向(主力/超大单/大单/中单/小单)等基本数据,以便做出交易决策。

**Why this priority**: 这是系统的核心功能,提供最基础的数据查询能力,是后续所有分析的基础。

**Independent Test**: 可以通过访问股票数据查询页面,输入股票代码,查看到完整的基本数据和资金流向信息来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户已登录系统,**When** 用户输入股票代码"600519.SH",**Then** 系统显示该股票的实时行情数据(最新价、涨跌幅、成交量、成交额等)
2. **Given** 用户查看某只股票,**When** 用户选择查看资金流向,**Then** 系统显示主力净流入、超大单净流入、大单净流入、中单净流入、小单净流入的金额和占比
3. **Given** 用户选择日期范围,**When** 用户请求历史K线数据,**Then** 系统返回该时间范围内的OHLCV数据并可视化展示
4. **Given** 用户查看资金流向,**When** 用户选择不同时间维度(今日/3日/5日/10日),**Then** 系统显示对应时间段的资金流向汇总

---

### User Story 2 - 查看和分析技术指标 (Priority: P2)

作为技术分析师,我需要对股票应用各种技术指标(移动平均线、RSI、MACD等),以便识别交易信号和趋势。

**Why this priority**: 技术指标分析是专业投资者的核心需求,基于已实现的161个TA-Lib指标,提供强大的分析能力。

**Independent Test**: 可以通过选择一只股票,应用多个技术指标(如MA、RSI、MACD),查看指标计算结果和图表叠加来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户查看某只股票的K线图,**When** 用户选择添加技术指标"MA(20)",**Then** 系统在K线图上叠加显示20日移动平均线
2. **Given** 用户已添加多个技术指标,**When** 用户调整指标参数(如将MA周期从20改为50),**Then** 系统实时重新计算并更新图表显示
3. **Given** 用户需要查看震荡指标,**When** 用户添加RSI指标,**Then** 系统在独立面板中显示RSI曲线和超买超卖参考线(30/70)
4. **Given** 用户分析多个股票,**When** 用户保存常用指标配置,**Then** 系统记住该配置并可在查看其他股票时快速应用

---

### User Story 3 - 运行股票策略筛选和回测 (Priority: P3)

作为策略交易者,我需要使用预定义的交易策略(放量上涨、均线多头、海龟交易法则等)筛选符合条件的股票,并查看策略的历史表现。

**Why this priority**: 策略功能帮助用户系统化筛选交易机会,提高决策效率,但依赖于前两个模块的数据和指标。

**Independent Test**: 可以通过选择一个策略(如"放量上涨"),设置筛选条件,运行策略并查看筛选结果列表来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户进入策略筛选页面,**When** 用户选择"放量上涨"策略并点击运行,**Then** 系统返回符合该策略条件的股票列表
2. **Given** 用户查看策略结果,**When** 用户点击某只股票,**Then** 系统显示该股票为何符合策略条件的详细说明
3. **Given** 用户想了解策略效果,**When** 用户选择查看策略回测,**Then** 系统显示该策略在历史数据上的表现(胜率、收益率、最大回撤等)
4. **Given** 用户运行多个策略,**When** 用户保存策略组合,**Then** 系统可以定时运行该组合并推送结果

---

### User Story 4 - 查看ETF数据和行业/概念资金流向 (Priority: P2)

作为市场分析师,我需要查看ETF基金的行情数据,以及行业和概念板块的资金流向,以便把握市场热点和趋势。

**Why this priority**: 板块和行业分析帮助用户从宏观角度理解市场,是个股分析的重要补充。

**Independent Test**: 可以通过访问ETF数据页面查看ETF列表,以及访问资金流向页面查看行业/概念资金流向排行来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户进入ETF数据页面,**When** 用户查看ETF列表,**Then** 系统显示所有ETF的代码、名称、最新价、涨跌幅、成交量等信息
2. **Given** 用户查看行业资金流向,**When** 用户选择时间维度(今日/5日/10日),**Then** 系统显示各行业的主力净流入排行
3. **Given** 用户查看概念资金流向,**When** 用户点击某个热门概念,**Then** 系统显示该概念下所有个股的资金流向详情
4. **Given** 用户分析市场热点,**When** 用户对比多个行业的资金流向趋势,**Then** 系统可视化展示各行业资金流向的时间序列变化

---

### User Story 5 - 查看龙虎榜和大宗交易数据 (Priority: P3)

作为短线交易者,我需要查看龙虎榜数据和大宗交易信息,以便跟踪机构和大资金的动向。

**Why this priority**: 龙虎榜和大宗交易是重要的市场信号,但相对于基础数据和技术分析是辅助功能。

**Independent Test**: 可以通过访问龙虎榜页面查看当日上榜个股,以及访问大宗交易页面查看大宗交易明细来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户进入龙虎榜页面,**When** 用户查看当日龙虎榜,**Then** 系统显示所有上榜个股及上榜原因
2. **Given** 用户查看某只股票的龙虎榜详情,**When** 用户点击该股票,**Then** 系统显示买入和卖出营业部排行及金额
3. **Given** 用户进入大宗交易页面,**When** 用户选择日期,**Then** 系统显示该日所有大宗交易的明细(股票代码、成交价、成交量、折溢价率等)
4. **Given** 用户跟踪机构动向,**When** 用户查询机构席位统计,**Then** 系统显示机构的买入卖出金额排行

---

### User Story 6 - 查看分红配送和早晚盘抢筹数据 (Priority: P3)

作为长期价值投资者和日内交易者,我需要查看股票的分红配送信息以及早盘/尾盘的抢筹数据,以便制定投资计划。

**Why this priority**: 这些是特定场景的需求,优先级较低但提供了完整的数据覆盖。

**Independent Test**: 可以通过访问分红配送页面查看即将分红的股票列表,以及访问抢筹数据页面查看早盘/尾盘抢筹排行来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户进入分红配送页面,**When** 用户查看分红公告,**Then** 系统显示股票的分红方案、股权登记日、除权除息日等信息
2. **Given** 用户筛选高股息股票,**When** 用户按股息率排序,**Then** 系统显示股息率从高到低的股票列表
3. **Given** 用户关注早盘抢筹,**When** 用户在开盘后查看抢筹数据,**Then** 系统显示早盘抢筹幅度、抢筹金额、抢筹占比等信息
4. **Given** 用户分析尾盘行为,**When** 用户在收盘后查看尾盘抢筹数据,**Then** 系统显示哪些股票在尾盘有大额资金进出

---

### Edge Cases

- **数据源不可用**: 当东方财富网或通达信接口无法访问时,系统如何降级处理?是显示缓存数据还是提示用户?
- **数据延迟**: 当实时数据延迟超过预期(如超过1分钟)时,系统是否应该提示用户数据可能不准确?
- **大量并发请求**: 当多个用户同时请求同一只股票的数据时,系统如何避免重复爬取?
- **指标计算失败**: 当某个技术指标因数据不足(如需要200个数据点但只有100个)无法计算时,系统如何提示用户?
- **策略筛选结果为空**: 当某个策略在当前市场条件下没有符合条件的股票时,系统应如何展示?
- **历史数据缺失**: 当某只股票的历史数据不完整(如停牌期间)时,指标和策略计算如何处理?
- **ETF vs 股票**: 系统如何区分ETF和普通股票,以及在数据展示和分析上有何不同?
- **节假日和非交易日**: 系统如何处理用户在非交易时间查询实时数据的请求?

## Requirements *(mandatory)*

### Functional Requirements

#### 股票基本数据模块

- **FR-001**: 系统必须能够获取和存储A股市场所有股票的实时行情数据,包括代码、名称、最新价、涨跌幅、涨跌额、成交量、成交额、开盘价、最高价、最低价、昨收价、换手率、量比、振幅、市盈率、市净率、总市值、流通市值
- **FR-002**: 系统必须能够获取和存储股票的历史K线数据,支持日线、周线、月线三种周期
- **FR-003**: 系统必须能够获取和存储股票的资金流向数据,包括主力净流入、超大单净流入、大单净流入、中单净流入、小单净流入的净额和净占比,支持今日、3日、5日、10日四个时间维度
- **FR-004**: 系统必须能够获取和存储股票的分红配送信息,包括分红方案、股权登记日、除权除息日、每股送转、每股派息
- **FR-005**: 系统必须能够获取和存储龙虎榜数据,包括上榜股票、上榜原因、买入营业部排行、卖出营业部排行、买入金额、卖出金额
- **FR-006**: 系统必须能够获取和存储大宗交易数据,包括交易日期、股票代码、成交价格、成交量、成交额、折溢价率、买方营业部、卖方营业部
- **FR-007**: 系统必须能够获取和存储早盘抢筹和尾盘抢筹数据,包括抢筹幅度、抢筹委托金额、抢筹成交金额、抢筹占比
- **FR-008**: 系统必须能够获取和存储行业资金流向和概念资金流向数据,包括行业/概念名称、主力净流入、领涨股、支持今日、5日、10日三个时间维度
- **FR-009**: 系统必须能够获取和存储ETF基金的实时行情数据,包括代码、名称、最新价、涨跌幅、成交量、成交额、换手率、总市值、流通市值
- **FR-010**: 用户必须能够通过股票代码或名称搜索并查看股票的基本数据
- **FR-011**: 用户必须能够选择日期范围查询股票的历史数据
- **FR-012**: 系统必须能够自动定时更新股票数据,实时行情数据在交易时间内持续更新,历史数据在每日收盘后更新

#### 股票指标模块

- **FR-013**: 系统必须支持计算已集成的161个TA-Lib技术指标,包括趋势指标(MA/EMA/MACD/ADX等)、动量指标(RSI/KDJ/CCI等)、波动率指标(ATR/BBANDS等)、成交量指标(OBV/AD等)和K线形态识别
- **FR-014**: 用户必须能够对任意股票应用一个或多个技术指标,并指定指标参数(如MA的周期)
- **FR-015**: 系统必须能够在K线图上叠加显示趋势类指标(overlay模式),并在独立面板显示震荡类指标(oscillator模式)
- **FR-016**: 系统必须能够缓存指标计算结果,相同股票、相同日期范围、相同指标参数的请求应返回缓存数据
- **FR-017**: 用户必须能够保存常用的指标配置组合,并快速应用到不同股票
- **FR-018**: 系统必须在指标计算前验证数据充足性,当数据不足时提示用户所需的最小数据点数
- **FR-019**: 系统必须支持指标参数的实时调整,用户修改参数后系统自动重新计算并更新图表
- **FR-020**: 系统必须提供指标的详细说明,包括计算方法、参数含义、适用场景和使用建议

#### 股票策略模块

- **FR-021**: 系统必须实现10个预定义的股票筛选策略,包括放量上涨、均线多头、停机坪、回踩年线、突破平台、无大幅回撤、海龟交易法则、高而窄的旗形、放量跌停、低ATR成长
- **FR-022**: 用户必须能够选择一个策略并运行,系统返回符合该策略条件的股票列表
- **FR-023**: 系统必须为每个策略提供详细的筛选逻辑说明,包括具体的判断条件和参数阈值
- **FR-024**: 用户必须能够查看某只股票为何符合策略条件,系统应显示该股票满足的具体条件
- **FR-025**: 系统必须支持策略的历史回测,计算策略在过去一段时间的表现,包括胜率、平均收益率、最大回撤、夏普比率
- **FR-026**: 用户必须能够保存策略组合(多个策略),并设置定时运行和结果推送
- **FR-027**: 系统必须能够对策略筛选结果进行排序和筛选,如按涨跌幅、成交量、符合策略的强度等排序
- **FR-028**: 系统必须记录每次策略运行的结果,用户可以查看历史运行记录和趋势变化

#### 数据集成和管理

- **FR-029**: 系统必须集成现有的MyStocksUnifiedManager,使用5-tier数据分类策略自动路由数据到合适的数据库(实时数据→Redis,历史行情→PostgreSQL+TimescaleDB,策略结果→PostgreSQL,元数据→MySQL)
- **FR-030**: 系统必须实现爬虫功能,从东方财富网获取股票行情、ETF、资金流向、龙虎榜、大宗交易、分红配送数据
- **FR-031**: 系统必须实现与通达信TQLEX接口的集成,获取早盘/尾盘抢筹数据,包括Token认证机制
- **FR-032**: 系统必须实现代理池管理,支持配置多个代理IP,自动轮换使用以避免被封禁
- **FR-033**: 系统必须实现接口限流和重试策略,当请求失败时自动重试,超过阈值时暂停请求
- **FR-034**: 系统必须记录所有数据获取操作的日志,包括请求时间、数据源、请求参数、是否成功、失败原因
- **FR-035**: 系统必须提供数据质量监控,检测数据的完整性、准确性和及时性,异常时发出告警

### Key Entities

- **Stock (股票)**: 代表一只A股股票,包含代码、名称、交易所、所属行业、所属概念、上市日期等基本信息
- **StockDailyData (股票日线数据)**: 某只股票在某一交易日的行情数据,包含日期、开盘价、收盘价、最高价、最低价、成交量、成交额、涨跌幅、换手率等
- **FundFlow (资金流向)**: 某只股票在某一时间段的资金流入流出情况,包含主力净流入、超大单净流入、大单净流入、中单净流入、小单净流入的金额和占比
- **TechnicalIndicator (技术指标)**: 基于股票价格和成交量计算的技术分析指标,包含指标名称、计算参数、输出值、计算时间
- **IndicatorConfig (指标配置)**: 用户保存的指标组合配置,包含配置名称、指标列表(含参数)、创建时间、最后使用时间
- **TradingStrategy (交易策略)**: 股票筛选策略的定义,包含策略名称、筛选条件、参数设置、适用场景描述
- **StrategyResult (策略结果)**: 某次策略运行的结果,包含运行时间、符合条件的股票列表、每只股票的详细评分
- **BacktestResult (回测结果)**: 策略的历史回测结果,包含回测时间范围、总收益率、胜率、最大回撤、夏普比率、交易次数
- **ETF (ETF基金)**: 代表一只ETF,包含代码、名称、跟踪指数、管理费率、成立日期等信息
- **LongHuBang (龙虎榜)**: 某只股票在某日上榜龙虎榜的记录,包含上榜日期、上榜原因、买入营业部、卖出营业部、买入金额、卖出金额
- **BlockTrade (大宗交易)**: 某只股票的大宗交易记录,包含交易日期、成交价格、成交量、折溢价率、买方营业部、卖方营业部
- **ChipRace (抢筹数据)**: 某只股票在早盘或尾盘的抢筹情况,包含时间类型(早盘/尾盘)、抢筹幅度、抢筹金额、抢筹占比
- **SectorFundFlow (行业/概念资金流向)**: 某个行业或概念板块的资金流向,包含名称、类型(行业/概念)、主力净流入、领涨股、涨跌幅
- **Dividend (分红配送)**: 股票的分红配送记录,包含公告日期、股权登记日、除权除息日、分红方案、每股送转、每股派息

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在3秒内查询到任意股票的实时行情数据和基本信息
- **SC-002**: 用户可以在5秒内加载一只股票一年内的历史K线数据并显示在图表上
- **SC-003**: 系统支持同时为一只股票计算和显示至少5个技术指标,总计算时间不超过2秒
- **SC-004**: 策略筛选可以在30秒内扫描全市场5000只股票并返回符合条件的结果
- **SC-005**: 系统的数据更新延迟不超过1分钟(从数据源更新到系统可查询)
- **SC-006**: 系统可以稳定支持100个并发用户同时查询和分析数据,响应时间不超过5秒
- **SC-007**: 数据获取成功率达到95%以上,即使在数据源不稳定的情况下
- **SC-008**: 用户可以在10分钟内完成一次完整的策略回测(包括选择策略、设置参数、运行回测、查看结果)
- **SC-009**: 系统的指标计算准确率达到100%(与TA-Lib官方结果一致)
- **SC-010**: 用户对数据查询和分析功能的满意度达到80%以上(通过用户调查)
- **SC-011**: 系统每日成功更新的股票数据覆盖率达到99%以上(即5000只股票中至少4950只成功更新)
- **SC-012**: 策略筛选的误报率(不符合策略但被筛选出来的股票)低于5%

## Assumptions

- **ASMP-001**: 用户拥有稳定的互联网连接,可以访问外部数据源(东方财富网、通达信)
- **ASMP-002**: 数据源(东方财富网、通达信)的接口格式和数据结构保持相对稳定
- **ASMP-003**: 用户已经具备基本的股票和技术分析知识,理解指标和策略的含义
- **ASMP-004**: 系统部署环境已经安装并配置好PostgreSQL、MySQL、Redis、TDengine等数据库
- **ASMP-005**: MyStocksUnifiedManager已经正常运行,可以正常路由和存储数据
- **ASMP-006**: 代理池中至少有3个可用的代理IP,且可以正常访问数据源
- **ASMP-007**: 用户在交易时间内查询实时数据,非交易时间查询历史数据
- **ASMP-008**: 股票的历史数据至少保留5年,以支持长期策略回测
- **ASMP-009**: 技术指标的计算依赖完整的OHLCV数据,不支持数据有缺失的情况
- **ASMP-010**: 策略筛选和回测的性能可以通过增加计算资源来提升
- **ASMP-011**: 用户理解实时数据存在延迟(最多1分钟),不用于高频交易决策
- **ASMP-012**: 数据的存储容量足够支持全市场5000只股票5年的日线数据(约9亿条记录)

## Constraints

- **CONS-001**: 数据获取必须遵守数据源的使用条款和访问频率限制,避免被封禁
- **CONS-002**: 爬虫请求频率不得超过每秒10次,以避免对数据源服务器造成压力
- **CONS-003**: 系统不得提供未经授权的数据下载和导出功能,保护数据版权
- **CONS-004**: 技术指标计算必须使用TA-Lib官方库,确保计算准确性和一致性
- **CONS-005**: 策略回测仅基于历史数据模拟,不代表未来表现,必须向用户明确提示风险
- **CONS-006**: 用户的指标配置和策略组合属于个人数据,不得在用户间共享或公开
- **CONS-007**: 系统必须在非交易时间(如周末、节假日)暂停数据更新任务,避免无效请求
- **CONS-008**: 当数据源不可用时,系统只能显示缓存数据,不能提供实时数据
- **CONS-009**: 早盘/尾盘抢筹数据依赖通达信TQLEX接口,该接口需要有效的Token认证
- **CONS-010**: 策略筛选结果不构成投资建议,用户需自行判断和承担投资风险
