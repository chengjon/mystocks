# Task Plan: MyStocks 全链路E2E自动化测试

## Goal
使用 Playwright + Chrome DevTools MCP 对 MyStocks WEB 服务进行端到端测试，**严格避免"仅以HTTP 200/进程在线"作为判断依据**，完成渲染、元素、数据、交互的全链路校验，并输出可追溯的详细测试报告。

## 测试环境
- **Frontend**: http://localhost:3001 (mystocks-frontend)
- **Backend**: http://localhost:8000 (mystocks-backend)
- **PM2管理**: 两个服务均通过PM2运行
- **测试工具**: Playwright + Chrome DevTools MCP
- **输出目录**: `test-reports/e2e-YYYYMMDD_HHMMSS/`

## Phases

### [ ] Phase 1: 前置校验与环境验证
**目标**: 确保服务真实可用，而非仅"进程在线"

- [ ] PM2进程状态检查（mystocks-frontend, mystocks-backend）
- [ ] 端口连通性测试（3001, 8000）
- [ ] 前端HTML完整性验证（非空、非错误页面、完整DOCTYPE）
- [ ] 后端health check接口验证
- [ ] 浏览器环境准备（Playwright + Chrome DevTools）

### [ ] Phase 2: 页面发现与核心元素识别
**目标**: 建立页面清单和每个页面的"核心3元素"验证规则

- [ ] 扫描前端路由配置，识别所有页面
- [ ] 提取每个页面的预期核心DOM元素（至少3个）
- [ ] 识别页面的预期标题/元数据
- [ ] 识别需要后端数据支撑的页面
- [ ] 建立页面测试矩阵（URL × 核心元素 × 数据依赖）

### [ ] Phase 3: 后端接口独立测试
**目标**: 解耦验证后端接口，排除"前端正常但后端无数据"的漏判

- [ ] 识别关键后端API（用户、股票列表、行情、交易等）
- [ ] 对每个接口进行独立请求测试（通过Playwright/直接HTTP）
- [ ] 验证响应状态码（200/201/400/401等）
- [ ] 验证响应数据格式（JSON结构、字段类型）
- [ ] 验证核心业务字段非空
- [ ] 记录接口响应时间和数据样本（用于后续数据一致性对比）

### [ ] Phase 4: 页面加载完整性测试
**目标**: 解决"页面空白"问题，确保页面真实渲染

**每个页面的测试步骤**:
- [ ] 访问页面URL
- [ ] 等待load事件（DOM加载完成）
- [ ] 等待networkidle（异步资源加载完成）
- [ ] **校验核心DOM元素可见性**（toBeVisible，非仅toBePresent）
- [ ] **检查浏览器控制台错误**（JS错误、资源404/500）
- [ ] 校验页面标题非空且符合预期
- [ ] 校验meta描述、关键字等元数据
- [ ] 截图保存（成功/失败均截图）
- [ ] 记录页面加载时长

**拒绝标准**:
- ❌ 仅HTTP 200响应
- ❌ DOM存在但不可见（CSS未渲染）
- ❌ 控制台有JS错误或资源加载失败
- ❌ 核心元素缺失或不可见
- ❌ 页面空白或仅显示Loading

### [ ] Phase 5: 前后端联动功能测试
**目标**: 避免"前端假正常、后端无数据"或"数据不一致"

- [ ] 选择依赖后端数据的核心页面（如股票列表、行情、交易）
- [ ] **对比测试**:
  - 从后端接口获取数据样本（Phase 3已记录）
  - 访问前端页面，检查展示的数据
  - 验证至少1个核心字段值一致性（如股票代码、名称、价格）
- [ ] **数据流向验证**:
  - 打开网络请求监控（Chrome DevTools）
  - 访问页面，记录前端向后端发起的API请求
  - 验证请求URL、参数、响应与后端独立测试一致
- [ ] **错误处理验证**:
  - 模拟后端错误（500/404），验证前端错误提示
  - 模拟网络延迟，验证Loading状态

### [ ] Phase 6: 基础交互测试
**目标**: 验证功能可用性，避免"页面能看但不能用"

**每个页面的交互测试**:
- [ ] 导航菜单点击测试
- [ ] 输入框输入验证（可输入、可清除）
- [ ] 按钮/链接点击测试（跳转、展开、筛选等）
- [ ] 表单提交测试（如登录、查询）
- [ ] 分页/滚动测试
- [ ] **交互后校验**:
  - 页面有预期反馈（跳转、数据刷新、Toast提示）
  - 无JS报错
  - 无白屏/闪退
  - 截图记录交互前后状态

### [ ] Phase 7: 测试报告生成
**目标**: 输出可追溯的结构化报告，拒绝模糊的"一切正常"

**报告内容**:
- [ ] **测试概览**
  - 测试时间、环境、工具版本
  - 测试覆盖页面数量、用例总数
  - 通过率、失败率、阻塞率

- [ ] **详细用例结果**（每个页面）
  - 用例名称、执行状态、耗时
  - 失败用例：错误堆栈、控制台报错、截图路径
  - 核心元素验证结果（哪些通过/失败）
  - 控制台错误详情（完整日志）

- [ ] **前后端联动测试结果**
  - 接口响应时间统计
  - 数据一致性验证结果（对比记录）
  - 网络请求监控记录

- [ ] **问题分类**（明确区分）
  - 🔴 **前端加载问题**: HTML不完整、CSS未渲染、JS错误
  - 🟠 **后端接口问题**: 接口异常、数据格式错误、超时
  - 🟡 **前后端联动问题**: 数据不一致、前端错误处理后端数据

- [ ] **证据附件**
  - 失败截图（自动保存）
  - 成功页面截图（抽样保存）
  - 完整测试日志（JSON格式）
  - 测试录屏（可选，关键失败场景）

### [ ] Phase 8: 持续集成配置
**目标**: 将测试集成到CI/CD流程

- [ ] 生成独立测试脚本（可手动运行）
- [ ] 配置GitHub Actions工作流
- [ ] 配置测试失败告警
- [ ] 自动报告上传（如GitHub Artifacts）

## Key Questions

1. **页面清单**: 前端有哪些页面/路由需要测试？（需从router配置中提取）
2. **核心元素**: 每个页面的"核心3元素"是什么？（导航栏？内容容器？特定按钮？）
3. **后端接口**: 有哪些关键API需要独立测试？（从backend/swagger文档中提取）
4. **数据字段**: 前后端数据对比时，核心字段是什么？（股票代码？价格？用户名？）
5. **预期标题**: 每个页面的预期标题是什么？（或仅验证非空？）
6. **现有测试**: 是否已有Playwright测试？如有，如何复用？

## Decisions Made

- **测试工具**: Playwright（主要） + Chrome DevTools MCP（辅助调试和性能分析）
- **验证标准**: toBeVisible() > toBePresent()（优先可见性）
- **截图策略**: 失败必截图，成功抽样新截图
- **日志级别**: 详细记录每个步骤，包括控制台错误、网络请求
- **报告格式**: Markdown（可读） + JSON（可解析）
- **问题分类**: 前端问题/后端问题/联动问题（严格区分）

## Errors Encountered
- _None yet_

## Status
**Phase 1-7 已完成** - E2E测试执行完成，发现关键问题

### 测试执行结果
- ✅ 后端API测试: 1/5 通过（仅health正常）
- ❌ 前端页面测试: 0/8 通过（所有页面空白）
- 📸 截图生成: 8张
- 📊 JSON报告: 已生成
- 📝 执行日志: 已保存

---

## 核心避坑点检查清单

**测试执行时必须遵守**:

- ✅ **不仅检查HTTP 200**: 必须验证HTML内容、DOM渲染、元素可见性
- ✅ **优先使用toBeVisible()**: 确保元素不仅在DOM中，还完成了CSS渲染
- ✅ **必须捕获控制台错误**: 页面空白的常见原因是JS报错或资源404
- ✅ **前后端解耦验证**: 先测后端接口，再测前端展示，最后测联动
- ✅ **截图/录屏追溯**: 所有失败必截图，成功按需截图
- ✅ **明确问题分类**: 区分前端/后端/联动问题，拒绝模糊结论

## 测试脚本结构

```
test-reports/e2e-YYYYMMDD_HHMMSS/
├── test-report.md              # 主报告（Markdown）
├── test-results.json           # 结构化结果（JSON）
├── screenshots/                # 截图目录
│   ├── page-home-success.png
│   ├── page-market-blank.png
│   └── interaction-login-error.png
├── console-errors/             # 控制台错误日志
│   ├── page-home-errors.txt
│   └── page-trading-errors.txt
├── network-logs/               # 网络请求日志
│   └── api-requests.json
└── test-script.js              # 可复用的测试脚本
```
