name: API Contract Validation & Type Generation

on:
  push:
    paths:
      - 'web/backend/app/api/contract/**'
      - 'web/backend/app/api/**/*.py'
      - 'scripts/generate_frontend_types.py'
      - '.github/workflows/api-contract-validation.yml'
  pull_request:
    paths:
      - 'web/backend/app/api/contract/**'
      - 'web/backend/app/api/**/*.py'
      - 'scripts/generate_frontend_types.py'
      - 'web/frontend/src/api/**'

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # ==================== å¥‘çº¦éªŒè¯ ====================
  validate-contracts:
    name: Validate API Contracts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install pydantic openapi-spec-validator

      - name: Validate contract models and services
        run: |
          python -c "
          # Test contract model imports
          from web.backend.app.api.contract.models import ContractVersion, ContractDiff, ContractValidation
          from web.backend.app.api.contract.schemas import ContractVersionCreate, ContractVersionResponse
          print('âœ… Contract models validation passed')

          # Test contract services
          from web.backend.app.api.contract.services.contract_validator import ContractValidator
          from web.backend.app.api.contract.services.diff_engine import ContractDiffEngine
          print('âœ… Contract services validation passed')
          "

      - name: Validate OpenAPI generation
        run: |
          python -c "
          from web.backend.app.api.contract.services.openapi_generator import OpenAPIGenerator
          from web.backend.app.main import app
          import json

          generator = OpenAPIGenerator(title='MyStocks API', version='1.0.0')
          generator.scan_app(app)
          spec = generator.generate_spec()

          # Validate basic structure
          assert 'openapi' in spec, 'Missing openapi field'
          assert 'info' in spec, 'Missing info field'
          assert 'paths' in spec, 'Missing paths field'
          assert len(spec['paths']) > 0, 'No paths found'

          print(f'âœ… OpenAPI generation validation passed - {len(spec[\"paths\"])} endpoints found')

          # Save generated spec for next job
          with open('generated_openapi.json', 'w') as f:
            json.dump(spec, f, indent=2)
          print('ðŸ“„ Generated OpenAPI spec saved')
          "

      - name: Upload generated OpenAPI spec
        uses: actions/upload-artifact@v4
        with:
          name: generated-openapi-spec
          path: generated_openapi.json

  # ==================== ç±»åž‹ç”Ÿæˆ ====================
  generate-types:
    name: Generate TypeScript Types
    runs-on: ubuntu-latest
    needs: validate-contracts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download generated OpenAPI spec
        uses: actions/download-artifact@v4
        with:
          name: generated-openapi-spec
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/frontend/package-lock.json

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Node.js dependencies
        working-directory: web/frontend
        run: npm ci

      - name: Generate TypeScript types from OpenAPI spec
        run: python scripts/generate_frontend_types.py --openapi-spec generated_openapi.json

      - name: Validate TypeScript compilation
        working-directory: web/frontend
        run: |
          npm run type-check
          if [ $? -ne 0 ]; then
            echo 'âŒ TypeScript compilation failed after type generation'
            exit 1
          fi
          echo 'âœ… TypeScript compilation passed'

      - name: Check for type changes
        id: check-changes
        run: |
          if git diff --name-only | grep -q "web/frontend/src/types/"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ TypeScript types have been updated"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No TypeScript type changes detected"
          fi

      - name: Commit type changes (on main branch only)
        if: steps.check-changes.outputs.has_changes == 'true' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add web/frontend/src/types/
          git commit -m "ðŸ¤– chore: update TypeScript types from API contracts

          Auto-generated by GitHub Actions on contract changes.
          Ensures frontend types stay in sync with backend API contracts.

          Generated from commit: ${{ github.sha }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== ç ´åæ€§å˜æ›´æ£€æµ‹ ====================
  detect-breaking-changes:
    name: Detect Breaking Changes
    runs-on: ubuntu-latest
    needs: validate-contracts
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download generated OpenAPI spec
        uses: actions/download-artifact@v4
        with:
          name: generated-openapi-spec
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Detect breaking changes
        run: |
          python -c "
          from web.backend.app.api.contract.services.diff_engine import ContractDiffEngine
          import json
          import subprocess

          try:
              # Load current generated spec
              with open('generated_openapi.json', 'r') as f:
                  current_spec = json.load(f)

              # Get base branch spec (simplified - in practice you'd fetch from API)
              print('ðŸ” Comparing OpenAPI specifications...')
              print(f'Current spec has {len(current_spec.get(\"paths\", {}))} paths')

              # For now, just validate the spec structure
              # TODO: Implement full diff against base branch
              diff_engine = ContractDiffEngine()
              print('âœ… Breaking change detection framework ready')

              # Create a basic report
              report = {
                  'breaking_changes': [],
                  'non_breaking_changes': [],
                  'breaking_changes_count': 0,
                  'total_changes': 0,
                  'summary': 'Basic validation completed - full diff to be implemented'
              }

              with open('breaking-changes-report.json', 'w') as f:
                  json.dump(report, f, indent=2)

              print('ðŸ“„ Breaking changes report generated')

          except Exception as e:
              print(f'âš ï¸ Breaking change detection failed: {e}')
              # Create error report
              report = {
                  'error': str(e),
                  'breaking_changes': [],
                  'non_breaking_changes': [],
                  'breaking_changes_count': 0,
                  'total_changes': 0,
                  'summary': 'Detection failed - manual review required'
              }
              with open('breaking-changes-report.json', 'w') as f:
                  json.dump(report, f, indent=2)
          "

      - name: Generate breaking changes report
        if: always()
        run: |
          if [ -f breaking-changes-report.json ]; then
              cat > breaking-changes-report.md << 'EOF'
          # ðŸš¨ API Breaking Changes Report

          **Pull Request**: #${{ github.event.number }}
          **Author**: ${{ github.actor }}
          **Branch**: ${{ github.head_ref }}
          **Base**: ${{ github.base_ref }}

          ## ðŸ“Š Analysis Results
          EOF

              # Add JSON content
              echo '```json' >> breaking-changes-report.md
              cat breaking-changes-report.json >> breaking-changes-report.md
              echo '```' >> breaking-changes-report.md

              echo '' >> breaking-changes-report.md
              echo '## ðŸ” Recommendations' >> breaking-changes-report.md
              echo '' >> breaking-changes-report.md
              echo 'If breaking changes are detected:' >> breaking-changes-report.md
              echo '- Ensure proper versioning strategy' >> breaking-changes-report.md
              echo '- Update client code accordingly' >> breaking-changes-report.md
              echo '- Communicate changes to stakeholders' >> breaking-changes-report.md
          else
              echo 'âš ï¸ Breaking changes report not found' > breaking-changes-report.md
          fi

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('breaking-changes-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Fail on breaking changes
        run: |
          if [ -f breaking-changes-report.json ]; then
              BREAKING_COUNT=$(cat breaking-changes-report.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('breaking_changes_count', 0))")

              if [ "$BREAKING_COUNT" -gt "0" ]; then
                  echo "âŒ Breaking changes detected: $BREAKING_COUNT"
                  echo "Please ensure proper versioning and client updates"
                  exit 1
              else
                  echo "âœ… No breaking changes detected"
              fi
          else
              echo "âš ï¸ Breaking changes report not available"
              exit 1
          fi

  # ==================== æŠ¥å‘Šç”Ÿæˆ ====================
  generate-report:
    name: Generate Contract Validation Report
    runs-on: ubuntu-latest
    needs: [validate-contracts, generate-types, detect-breaking-changes]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download generated OpenAPI spec
        uses: actions/download-artifact@v4
        with:
          name: generated-openapi-spec
          path: .

      - name: Generate comprehensive report
        run: |
          echo '# ðŸ¤– API Contract Validation Report' > contract_validation_report.md
          echo '' >> contract_validation_report.md
          echo '## ðŸ“Š Validation Summary' >> contract_validation_report.md
          echo '' >> contract_validation_report.md

          # Check job statuses
          CONTRACTS_STATUS="${{ needs.validate-contracts.result }}"
          TYPES_STATUS="${{ needs.generate-types.result }}"
          BREAKING_STATUS="${{ needs.detect-breaking-changes.result }}"

          if [ "$CONTRACTS_STATUS" == "success" ]; then
              echo '- âœ… **Contract Validation**: PASSED' >> contract_validation_report.md
          else
              echo '- âŒ **Contract Validation**: FAILED' >> contract_validation_report.md
          fi

          if [ "$TYPES_STATUS" == "success" ]; then
              echo '- âœ… **Type Generation**: PASSED' >> contract_validation_report.md
          else
              echo '- âŒ **Type Generation**: FAILED' >> contract_validation_report.md
          fi

          if [ "$BREAKING_STATUS" == "success" ]; then
              echo '- âœ… **Breaking Change Detection**: PASSED' >> contract_validation_report.md
          else
              echo '- âš ï¸ **Breaking Change Detection**: WARNING' >> contract_validation_report.md
          fi

          echo '' >> contract_validation_report.md
          echo '## ðŸ“‹ Details' >> contract_validation_report.md
          echo '' >> contract_validation_report.md
          echo '**Event**: ${{ github.event_name }}' >> contract_validation_report.md
          echo '**Branch**: ${{ github.ref_name }}' >> contract_validation_report.md
          echo '**Commit**: ${{ github.sha }}' >> contract_validation_report.md
          echo '**Actor**: ${{ github.actor }}' >> contract_validation_report.md

          if [ -f generated_openapi.json ]; then
              ENDPOINTS=$(cat generated_openapi.json | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data.get('paths', {})))")
              echo "**API Endpoints**: $ENDPOINTS" >> contract_validation_report.md
          fi

          echo '' >> contract_validation_report.md
          echo '## ðŸ”— Related Files' >> contract_validation_report.md
          echo '' >> contract_validation_report.md
          echo '- API Contracts: `web/backend/app/api/contract/`' >> contract_validation_report.md
          echo '- Type Generation: `scripts/generate_frontend_types.py`' >> contract_validation_report.md
          echo '- Frontend Types: `web/frontend/src/types/`' >> contract_validation_report.md
          echo '- Runtime Validation: `web/frontend/src/api/unifiedApiClient.ts`' >> contract_validation_report.md

          echo '' >> contract_validation_report.md
          echo '---' >> contract_validation_report.md
          echo '*Generated by GitHub Actions on $(date -u "+%Y-%m-%d %H:%M:%S UTC")*' >> contract_validation_report.md

      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: contract-validation-report
          path: contract_validation_report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('contract_validation_report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # ==================== é€šçŸ¥ ====================
  notify-failures:
    name: Notify on Validation Failures
    runs-on: ubuntu-latest
    needs: [validate-contracts, generate-types]
    if: failure() && github.ref == 'refs/heads/main'

    steps:
      - name: Send failure notification
        run: |
          echo "ðŸš¨ API Contract Validation Failed"
          echo ""
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "Please check the validation results and fix any contract issues."
          echo ""
          echo "Common issues:"
          echo "- Breaking API changes without version bump"
          echo "- Type generation failures"
          echo "- Contract validation errors"
