# GitHub Actions Python Type Checking Pipeline
# 使用 mypy 进行静态类型检查

name: Python Type Check (mypy)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.py'
      - 'tests/**/*.py'
      - 'pyproject.toml'
      - '.github/workflows/python-type-check.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.py'
      - 'tests/**/*.py'
      - 'pyproject.toml'
      - '.github/workflows/python-type-check.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  MYPY_CACHE_DIR: '.mypy_cache'

jobs:
  # ============================================================
  # 阶段1: 增量类型检查（快速反馈）
  # ============================================================
  type-check-incremental:
    name: Type Check (Incremental)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache mypy cache
        uses: actions/cache@v4
        with:
          path: ${{ env.MYPY_CACHE_DIR }}
          key: ${{ runner.os }}-mypy-${{ hashFiles('pyproject.toml', 'src/**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-mypy-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy==1.14.1
          pip install -e .

      - name: Run mypy (incremental)
        run: |
          mypy src/ \
            --config-file=pyproject.toml \
            --incremental \
            --cache-dir=${{ env.MYPY_CACHE_DIR }} \
            --pretty \
            --show-error-codes \
            --show-column-numbers \
            --no-error-summary | tee mypy-incremental.txt
        continue-on-error: true

      - name: Upload mypy results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mypy-incremental-results
          path: mypy-incremental.txt
          retention-days: 7

  # ============================================================
  # 阶段2: 完整类型检查（严格模式）
  # ============================================================
  type-check-full:
    name: Type Check (Full)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy==1.14.1
          pip install types-requests types-PyYAML
          pip install -e .

      - name: Run mypy (full check)
        run: |
          mypy src/ tests/ \
            --config-file=pyproject.toml \
            --non-interactive \
            --pretty \
            --show-error-codes \
            --show-column-numbers \
            --show-error-context \
            --warn-unused-ignores \
            --warn-redundant-casts \
            --warn-unused-configs \
            --no-error-summary | tee mypy-full.txt
        continue-on-error: true

      - name: Generate mypy report
        if: always()
        run: |
          echo "## MyPy 类型检查报告" > mypy-report.md
          echo "" >> mypy-report.md
          echo "**执行时间**: $(date)" >> mypy-report.md
          echo "**提交**: ${{ github.sha }}" >> mypy-report.md
          echo "" >> mypy-report.md

          # 统计错误
          if [ -f mypy-full.txt ]; then
            ERROR_COUNT=$(grep -c "^src:" mypy-full.txt 2>/dev/null || echo "0")
            WARNING_COUNT=$(grep -c "warning:" mypy-full.txt 2>/dev/null || echo "0")
            NOTE_COUNT=$(grep -c "note:" mypy-full.txt 2>/dev/null || echo "0")

            echo "### 错误统计" >> mypy-report.md
            echo "- **错误**: $ERROR_COUNT" >> mypy-report.md
            echo "- **警告**: $WARNING_COUNT" >> mypy-report.md
            echo "- **提示**: $NOTE_COUNT" >> mypy-report.md
            echo "" >> mypy-report.md

            # 提取前10个错误
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "### 主要错误 (前10个)" >> mypy-report.md
              echo '```' >> mypy-report.md
              grep "^src:" mypy-full.txt | head -10 >> mypy-report.md
              echo '```' >> mypy-report.md
            fi
          fi

      - name: Upload mypy results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mypy-full-results
          path: |
            mypy-full.txt
            mypy-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('mypy-report.md')) {
              const report = fs.readFileSync('mypy-report.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.name,
                body: report
              });
            }

  # ============================================================
  # 阶段3: 类型覆盖率分析
  # ============================================================
  type-coverage:
    name: Type Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy-coverage-typing

      - name: Analyze type coverage
        run: |
          # 统计带有类型注解的函数比例
          python -c "
import os
import re
from pathlib import Path

def analyze_type_coverage(directory):
    '''分析 Python 代码的类型覆盖率'''
    total_funcs = 0
    typed_funcs = 0
    total_classes = 0
    typed_classes = 0

    for py_file in Path(directory).rglob('*.py'):
        if 'test' in str(py_file) or '__pycache__' in str(py_file):
            continue

        try:
            with open(py_file, 'r', encoding='utf-8') as f:
                content = f.read()

            # 统计函数定义
            funcs = re.findall(r'^def\s+(\w+)\s*\((.*?)\)\s*(?:->\s*([^:]+))?:', content, re.MULTILINE)
            for func_name, params, return_type in funcs:
                total_funcs += 1
                # 检查是否有类型注解
                if return_type or any(': ' in param for param in params.split(',')):
                    typed_funcs += 1

            # 统计类定义
            classes = re.findall(r'^class\s+(\w+).*?:', content, re.MULTILINE)
            total_classes += len(classes)

        except Exception as e:
            print(f'Error processing {py_file}: {e}')

    # 输出结果
    func_coverage = (typed_funcs / total_funcs * 100) if total_funcs > 0 else 0
    print(f'函数类型覆盖率: {func_coverage:.1f}% ({typed_funcs}/{total_funcs})')
    print(f'类总数: {total_classes}')

    # 写入 JSON 报告
    import json
    report = {
        'timestamp': '$(date -Iseconds)',
        'total_functions': total_funcs,
        'typed_functions': typed_funcs,
        'function_coverage_percent': round(func_coverage, 2),
        'total_classes': total_classes
    }

    with open('type-coverage.json', 'w') as f:
        json.dump(report, f, indent=2)
          "
        working-directory: src/

      - name: Upload type coverage results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: type-coverage-results
          path: src/type-coverage.json
          retention-days: 30

  # ============================================================
  # 阶段4: 类型检查质量门禁
  # ============================================================
  type-check-gate:
    name: Type Check Quality Gate
    runs-on: ubuntu-latest
    needs: [type-check-incremental, type-check-full]

    outputs:
      type-check-pass: ${{ steps.gate.outputs.pass }}

    steps:
      - name: Download mypy results
        uses: actions/download-artifact@v4
        with:
          pattern: mypy-*-results
          path: .

      - name: Evaluate quality gate
        id: gate
        run: |
          QUALITY_PASS=true
          GATE_ISSUES=""

          # 检查增量检查结果
          if [ -f mypy-incremental.txt ]; then
            ERROR_COUNT=$(grep -c "^src:" mypy-incremental.txt 2>/dev/null || echo "0")
            echo "增量检查错误数: $ERROR_COUNT"

            if [ "$ERROR_COUNT" -gt 50 ]; then
              QUALITY_PASS=false
              GATE_ISSUES="$GATE_ISSUES 增量类型检查错误过多: $ERROR_COUNT 个"
            fi
          fi

          # 检查完整检查结果
          if [ -f mypy-full.txt ]; then
            CRITICAL_ERRORS=$(grep -c "error:" mypy-full.txt 2>/dev/null || echo "0")
            echo "完整检查严重错误数: $CRITICAL_ERRORS"

            if [ "$CRITICAL_ERRORS" -gt 20 ]; then
              QUALITY_PASS=false
              GATE_ISSUES="$GATE_ISSUES 严重类型错误过多: $CRITICAL_ERRORS 个"
            fi
          fi

          # 输出结果
          if [ "$QUALITY_PASS" = "true" ]; then
            echo "✅ 类型检查质量门禁通过"
            echo "pass=true" >> $GITHUB_OUTPUT
          else
            echo "❌ 类型检查质量门禁失败: $GATE_ISSUES"
            echo "pass=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ============================================================
  # 阶段5: 最终报告汇总
  # ============================================================
  final-report:
    name: Final Type Check Report
    runs-on: ubuntu-latest
    needs: [type-check-incremental, type-check-full, type-coverage, type-check-gate]
    if: always()

    steps:
      - name: Download all type check artifacts
        uses: actions/download-artifact@v4

      - name: Generate consolidated report
        run: |
          cat > type-check-summary.md << 'EOF'
          # Python 类型检查总结

          **执行时间**: $(date)
          **提交**: ${{ github.sha }}
          **分支**: ${{ github.ref_name }}

          ## 检查项目

          - ✅ 增量类型检查 (mypy incremental)
          - ✅ 完整类型检查 (mypy full)
          - ✅ 类型覆盖率分析
          - ✅ 质量门禁评估

          ## 质量门禁状态

          **类型检查**: ${{ needs.type-check-gate.outputs.type-check-pass == 'true' && '✅ 通过' || '❌ 失败' }}

          EOF

          cat type-check-summary.md

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: type-check-final-report
          path: type-check-summary.md
          retention-days: 90
