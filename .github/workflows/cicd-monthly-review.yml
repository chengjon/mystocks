# MyStocks CI/CD æœˆåº¦ä¼˜åŒ–å®¡æŸ¥å·¥ä½œæµ
# æ¯æœˆè‡ªåŠ¨ç”ŸæˆCI/CDä¼˜åŒ–æŠ¥å‘Šå’Œæ”¹è¿›å»ºè®®

name: CI/CD Monthly Optimization Review

on:
  # æ¯æœˆ1å·æ—©ä¸Š8ç‚¹æ‰§è¡Œ
  schedule:
    - cron: '0 0 1 * *'  # æ¯æœˆ1æ—¥00:00 UTC (åŒ—äº¬æ—¶é—´08:00)
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_run:
        description: 'å¼ºåˆ¶æ‰§è¡Œï¼ˆè·³è¿‡æ—¥æœŸæ£€æŸ¥ï¼‰'
        required: false
        type: boolean
        default: false

env:
  REPORT_MONTH: ${{ github.event.inputs.force_run == 'true' && 'manual' || format('{0}-{1:02d}', github.event.schedule && fromJSON('["' + github.event.schedule + '"]')[0] || github.event.head_commit.timestamp || github.event.repository.updated_at || '2024-01', github.event.schedule && fromJSON('["' + github.event.schedule + '"]')[1] || github.event.head_commit.timestamp && fromJSON('["' + github.event.head_commit.timestamp + '"]')[1] || github.event.repository.updated_at && fromJSON('["' + github.event.repository.updated_at + '"]')[1] || '01') }}

jobs:
  # ============================================================================
  # æœˆåº¦å®¡æŸ¥æ‰§è¡Œ
  # ============================================================================
  monthly-review:
    name: Execute Monthly CI/CD Review
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥è¿›è¡Œè¶‹åŠ¿åˆ†æ

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy prometheus-client PyGithub

    - name: Install GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh

    - name: Authenticate GitHub CLI
      run: |
        echo ${{ secrets.GITHUB_TOKEN }} | gh auth login --with-token

    - name: Set report month
      run: |
        if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
          echo "REPORT_MONTH=manual-$(date +%Y-%m)" >> $GITHUB_ENV
        else
          echo "REPORT_MONTH=$(date +%Y-%m)" >> $GITHUB_ENV
        fi

    - name: Execute monthly review script
      run: |
        chmod +x scripts/cicd-monthly-review.sh
        ./scripts/cicd-monthly-review.sh

    - name: Upload review artifacts
      uses: actions/upload-artifact@v3
      with:
        name: monthly-review-${{ env.REPORT_MONTH }}
        path: reports/cicd-optimization/${{ env.REPORT_MONTH }}/
        retention-days: 90  # ä¿ç•™90å¤©

  # ============================================================================
  # æŠ¥å‘Šå‘å¸ƒ
  # ============================================================================
  publish-report:
    name: Publish Monthly Report
    runs-on: ubuntu-latest
    needs: monthly-review
    if: success()

    steps:
    - name: Download review artifacts
      uses: actions/download-artifact@v3
      with:
        name: monthly-review-${{ env.REPORT_MONTH }}
        path: monthly-report

    - name: Create GitHub Issue with report
      run: |
        # è¯»å–æŠ¥å‘Šå†…å®¹
        if [ -f "monthly-report/monthly_optimization_report.md" ]; then
          REPORT_CONTENT=$(cat monthly-report/monthly_optimization_report.md)

          # åˆ›å»ºGitHub Issue
          gh issue create \
            --title "ğŸ“Š CI/CDæœˆåº¦ä¼˜åŒ–æŠ¥å‘Š - ${{ env.REPORT_MONTH }}" \
            --body "$REPORT_CONTENT" \
            --label "monthly-review,optimization,report" \
            --assignee ${{ github.actor }}
        else
          echo "æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡Issueåˆ›å»º"
        fi

    - name: Send notification to team
      run: |
        # è¿™é‡Œå¯ä»¥é›†æˆå›¢é˜Ÿé€šçŸ¥
        # Slackã€å¾®ä¿¡ã€ä¼ä¸šå¾®ä¿¡ç­‰

        if [ -n "${{ secrets.TEAM_WEBHOOK_URL }}" ]; then
          curl -X POST "${{ secrets.TEAM_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"ğŸ“Š MyStocks ${{ env.REPORT_MONTH }} CI/CDä¼˜åŒ–æŠ¥å‘Šå·²ç”Ÿæˆ\\næŸ¥çœ‹: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n\\n$(head -20 monthly-report/monthly_optimization_report.md 2>/dev/null || echo 'æŠ¥å‘Šç”Ÿæˆå¤±è´¥')\"
            }"
        fi

  # ============================================================================
  # ä¼˜åŒ–ä»»åŠ¡è·Ÿè¸ª
  # ============================================================================
  create-optimization-tasks:
    name: Create Optimization Tasks
    runs-on: ubuntu-latest
    needs: [monthly-review, publish-report]
    if: success()

    steps:
    - name: Download review artifacts
      uses: actions/download-artifact@v3
      with:
        name: monthly-review-${{ env.REPORT_MONTH }}
        path: monthly-report

    - name: Parse optimization recommendations
      id: parse-recommendations
      run: |
        # è§£æä¼˜åŒ–å»ºè®®JSON
        if [ -f "monthly-report/optimization_recommendations.json" ]; then
          # ç»Ÿè®¡å„ç±»å»ºè®®æ•°é‡
          high_priority=$(jq '.[] | select(.priority == "high") | .title' monthly-report/optimization_recommendations.json | wc -l)
          medium_priority=$(jq '.[] | select(.priority == "medium") | .title' monthly-report/optimization_recommendations.json | wc -l)
          low_priority=$(jq '.[] | select(.priority == "low") | .title' monthly-report/optimization_recommendations.json | wc -l)

          echo "high_priority=$high_priority" >> $GITHUB_OUTPUT
          echo "medium_priority=$medium_priority" >> $GITHUB_OUTPUT
          echo "low_priority=$low_priority" >> $GITHUB_OUTPUT

          # ä¸ºé«˜ä¼˜å…ˆçº§å»ºè®®åˆ›å»ºGitHub Issues
          if [ "$high_priority" -gt 0 ]; then
            echo "åˆ›å»º $high_priority ä¸ªé«˜ä¼˜å…ˆçº§ä¼˜åŒ–ä»»åŠ¡..."

            jq -r '.[] | select(.priority == "high") | @base64' monthly-report/optimization_recommendations.json | while read -r item; do
              item_data=$(echo "$item" | base64 -d)

              title=$(echo "$item_data" | jq -r '.title')
              description=$(echo "$item_data" | jq -r '.description')
              category=$(echo "$item_data" | jq -r '.category')
              actions=$(echo "$item_data" | jq -r '.actions | join("\\n- ")')

              issue_body="## é—®é¢˜æè¿°
$description

## åˆ†ç±»
$category

## å»ºè®®æªæ–½
- $actions

## æŠ¥å‘Šæœˆä»½
${{ env.REPORT_MONTH }}

---
*æ­¤ä»»åŠ¡ç”±æœˆåº¦ä¼˜åŒ–å®¡æŸ¥è‡ªåŠ¨ç”Ÿæˆ*"

              # åˆ›å»ºIssue
              gh issue create \
                --title "ğŸ”´ é«˜ä¼˜å…ˆçº§: $title" \
                --body "$issue_body" \
                --label "optimization,high-priority,monthly-review" \
                --milestone "CI/CDä¼˜åŒ–"
            done
          fi
        fi

    - name: Create optimization project board card
      if: steps.parse-recommendations.outputs.high_priority > 0
      run: |
        # å¦‚æœæœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œåœ¨é¡¹ç›®é¢æ¿ä¸­åˆ›å»ºå¡ç‰‡
        # è¿™é‡Œå¯ä»¥é›†æˆGitHub Projects API

        echo "ğŸ“‹ å·²åˆ›å»º ${{ steps.parse-recommendations.outputs.high_priority }} ä¸ªé«˜ä¼˜å…ˆçº§ä¼˜åŒ–ä»»åŠ¡"
        echo "ğŸ“‹ ${{ steps.parse-recommendations.outputs.medium_priority }} ä¸ªä¸­ä¼˜å…ˆçº§å»ºè®®"
        echo "ğŸ“‹ ${{ steps.parse-recommendations.outputs.low_priority }} ä¸ªä½ä¼˜å…ˆçº§å»ºè®®"

  # ============================================================================
  # å†å²æ•°æ®å½’æ¡£
  # ============================================================================
  archive-historical-data:
    name: Archive Historical Data
    runs-on: ubuntu-latest
    needs: [monthly-review, publish-report, create-optimization-tasks]
    if: success()

    steps:
    - name: Create archive directory
      run: |
        mkdir -p archive/cicd-reviews/${{ env.REPORT_MONTH }}

    - name: Download and archive all artifacts
      uses: actions/download-artifact@v3
      with:
        path: archive/cicd-reviews/${{ env.REPORT_MONTH }}

    - name: Compress archive
      run: |
        cd archive/cicd-reviews
        tar -czf ${{ env.REPORT_MONTH }}.tar.gz ${{ env.REPORT_MONTH }}
        rm -rf ${{ env.REPORT_MONTH }}

    - name: Upload archive to releases
      uses: actions/upload-artifact@v3
      with:
        name: cicd-review-archive-${{ env.REPORT_MONTH }}
        path: archive/cicd-reviews/${{ env.REPORT_MONTH }}.tar.gz
        retention-days: 365  # ä¿ç•™ä¸€å¹´

  # ============================================================================
  # æ¸…ç†ä»»åŠ¡
  # ============================================================================
  cleanup:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    needs: archive-historical-data
    if: always()

    steps:
    - name: Clean up old artifacts
      run: |
        # æ¸…ç†30å¤©å‰çš„ä¸´æ—¶artifacts
        # æ³¨æ„ï¼šè¿™éœ€è¦é€‚å½“çš„æƒé™é…ç½®

        echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

    - name: Send completion notification
      if: success()
      run: |
        echo "âœ… MyStocks ${{ env.REPORT_MONTH }} CI/CDæœˆåº¦ä¼˜åŒ–å®¡æŸ¥å®Œæˆ"
        echo "ğŸ“Š æŠ¥å‘Šå·²ç”Ÿæˆå¹¶å‘å¸ƒ"
        echo "ğŸ¯ ä¼˜åŒ–ä»»åŠ¡å·²åˆ›å»º"
        echo "ğŸ“¦ å†å²æ•°æ®å·²å½’æ¡£"