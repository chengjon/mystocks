# P0ä¼˜å…ˆçº§è´¨é‡é—¨ç¦ - é˜»æ­¢ä½è´¨é‡ä»£ç åˆå¹¶
# æ‰§è¡Œä¸¥æ ¼çš„ä»£ç è´¨é‡æ£€æŸ¥ï¼Œå¤±è´¥åˆ™é˜»æ­¢PRåˆå¹¶
# è§¦å‘æ¡ä»¶ï¼šæ‰€æœ‰PRå’Œmainåˆ†æ”¯çš„push

name: P0 Quality Gate

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.12'

jobs:
  # P0-1: Pylint Errorçº§åˆ«æ£€æŸ¥ï¼ˆå¿…é¡»é€šè¿‡ï¼‰
  pylint-errors:
    name: Pylint Errors (Critical)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Pylint
      run: |
        python -m pip install --upgrade pip
        pip install pylint

    - name: Run Pylint (Errorçº§åˆ« only)
      run: |
        echo "ğŸ” æ£€æŸ¥Pylint Errorçº§åˆ«é—®é¢˜..."
        pylint src/ \
          --rcfile=.pylintrc \
          --errors-only \
          --disable=import-error,no-member \
          --output-format=colorized \
          --fail-on=I \
          || {
            echo "âŒ P0è´¨é‡é—¨ç¦å¤±è´¥ï¼šå­˜åœ¨Errorçº§åˆ«é—®é¢˜"
            echo "ğŸ’¡ ä¿®å¤å»ºè®®ï¼š"
            echo "   1. è¿è¡Œ: pylint src/ --errors-only --disable=import-error,no-member"
            echo "   2. ä¿®å¤æ‰€æœ‰Errorçº§åˆ«é—®é¢˜åé‡æ–°æäº¤"
            exit 1
          }

        echo "âœ… Pylint Erroræ£€æŸ¥é€šè¿‡"

  # P0-2: ä»£ç æ ¼å¼åŒ–æ£€æŸ¥ï¼ˆå¿…é¡»é€šè¿‡ï¼‰
  formatting-check:
    name: Code Formatting Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install formatting tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort

    - name: Check Black formatting
      run: |
        echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆBlackï¼‰..."
        black --check --diff --line-length=120 src/ || {
          echo "âŒ P0è´¨é‡é—¨ç¦å¤±è´¥ï¼šä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
          echo "ğŸ’¡ ä¿®å¤å»ºè®®ï¼š"
          echo "   è¿è¡Œ: black src/ --line-length=120"
          exit 1
        }
        echo "âœ… Blackæ ¼å¼æ£€æŸ¥é€šè¿‡"

    - name: Check import sorting
      run: |
        echo "ğŸ” æ£€æŸ¥å¯¼å…¥æ’åºï¼ˆisortï¼‰..."
        isort --check-only --diff src/ || {
          echo "âŒ P0è´¨é‡é—¨ç¦å¤±è´¥ï¼šå¯¼å…¥æ’åºä¸ç¬¦åˆè§„èŒƒ"
          echo "ğŸ’¡ ä¿®å¤å»ºè®®ï¼š"
          echo "   è¿è¡Œ: isort src/"
          exit 1
        }
        echo "âœ… isortæ£€æŸ¥é€šè¿‡"

  # P0-3: å®‰å…¨æ£€æŸ¥ï¼ˆå¿…é¡»é€šè¿‡ï¼‰
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Bandit
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]

    - name: Run Bandit security scan
      run: |
        echo "ğŸ” æ‰§è¡Œå®‰å…¨æ‰«æ..."
        bandit -r src/ \
          -c config/.security.yml \
          -ll \
          -f screen \
          || {
            echo "âŒ P0è´¨é‡é—¨ç¦å¤±è´¥ï¼šå‘ç°å®‰å…¨é—®é¢˜"
            echo "ğŸ’¡ ä¿®å¤å»ºè®®ï¼š"
            echo "   1. æ£€æŸ¥æŠ¥å‘Šä¸­çš„å®‰å…¨é—®é¢˜"
            echo "   2. è¿è¡Œ: bandit -r src/ -c config/.security.yml"
            echo "   3. ä¿®å¤æ‰€æœ‰Highå’ŒMediumçº§åˆ«é—®é¢˜"
            exit 1
          }
        echo "âœ… å®‰å…¨æ‰«æé€šè¿‡"

  # P0-4: ä¾èµ–å®‰å…¨æ£€æŸ¥
  dependency-check:
    name: Dependency Safety Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Safety
      run: |
        python -m pip install --upgrade pip
        pip install safety

    - name: Check dependencies for vulnerabilities
      run: |
        echo "ğŸ” æ£€æŸ¥ä¾èµ–å®‰å…¨æ€§..."
        safety check --json > safety-report.json || {
          echo "âŒ P0è´¨é‡é—¨ç¦å¤±è´¥ï¼šå‘ç°ä¾èµ–æ¼æ´"
          echo "ğŸ’¡ ä¿®å¤å»ºè®®ï¼š"
          echo "   1. æŸ¥çœ‹safety-report.jsonäº†è§£æ¼æ´è¯¦æƒ…"
          echo "   2. æ›´æ–°æœ‰æ¼æ´çš„ä¾èµ–åŒ…"
          echo "   3. è¿è¡Œ: pip install --upgrade <package>"
          exit 1
        }
        echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"

  # P0-5: Pythonè¯­æ³•æ£€æŸ¥
  syntax-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Check Python syntax
      run: |
        echo "ğŸ” æ£€æŸ¥Pythonè¯­æ³•..."
        find src/ -name "*.py" -type f -exec python -m py_compile {} \; || {
          echo "âŒ P0è´¨é‡é—¨ç¦å¤±è´¥ï¼šå­˜åœ¨Pythonè¯­æ³•é”™è¯¯"
          echo "ğŸ’¡ ä¿®å¤å»ºè®®ï¼š"
          echo "   è¿è¡Œ: python -m py_compile src/**/*.py"
          echo "   ä¿®å¤æ‰€æœ‰è¯­æ³•é”™è¯¯"
          exit 1
        }
        echo "âœ… Pythonè¯­æ³•æ£€æŸ¥é€šè¿‡"

  # P0-6: æ•æ„Ÿä¿¡æ¯æ£€æµ‹
  secrets-check:
    name: Secrets Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Detect secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
      continue-on-error: false

  # P0-7: ç”Ÿæˆè´¨é‡æŠ¥å‘Š
  quality-report:
    name: Generate Quality Report
    runs-on: ubuntu-latest
    needs: [pylint-errors, formatting-check, security-scan, dependency-check, syntax-check]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate summary
      run: |
        echo "# P0è´¨é‡é—¨ç¦æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ£€æŸ¥æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Pylint Errors | ${{ needs.pylint-errors.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ä»£ç æ ¼å¼åŒ– | ${{ needs.formatting-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| å®‰å…¨æ‰«æ | ${{ needs.security-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ä¾èµ–å®‰å…¨ | ${{ needs.dependency-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Pythonè¯­æ³• | ${{ needs.syntax-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š æ€»ä½“è¯„ä¼°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # è®¡ç®—é€šè¿‡ç‡
        if [ "${{ needs.pylint-errors.result }}" == "success" ] && \
           [ "${{ needs.formatting-check.result }}" == "success" ] && \
           [ "${{ needs.security-scan.result }}" == "success" ] && \
           [ "${{ needs.dependency-check.result }}" == "success" ] && \
           [ "${{ needs.syntax-check.result }}" == "success" ]; then
          echo "âœ… **æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œä»£ç è´¨é‡ç¬¦åˆP0æ ‡å‡†**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Final gate
      run: |
        # å¦‚æœä»»ä½•æ£€æŸ¥å¤±è´¥ï¼Œæ•´ä¸ªå·¥ä½œæµå¤±è´¥
        if [ "${{ needs.pylint-errors.result }}" != "success" ] || \
           [ "${{ needs.formatting-check.result }}" != "success" ] || \
           [ "${{ needs.security-scan.result }}" != "success" ] || \
           [ "${{ needs.dependency-check.result }}" != "success" ] || \
           [ "${{ needs.syntax-check.result }}" != "success" ]; then
          echo "âŒ P0è´¨é‡é—¨ç¦ï¼šä»£ç è´¨é‡ä¸è¾¾æ ‡"
          exit 1
        fi

        echo "âœ… P0è´¨é‡é—¨ç¦ï¼šæ‰€æœ‰æ£€æŸ¥é€šè¿‡"
