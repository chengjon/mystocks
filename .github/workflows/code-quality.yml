# GitHub Actions CI/CD Code Quality Pipeline
# é›†æˆä»£ç è´¨é‡å’Œå®‰å…¨æ£€æŸ¥åˆ°CI/CDæµç¨‹

name: Code Quality Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥é˜¶æ®µ
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint pytest pytest-cov black isort flake8 bandit safety

    - name: Run Pylint with security profile
      run: |
        pylint src/ --rcfile=.pylintrc -j 0 --disable=import-error --output-format=json > pylint-report.json || true
      continue-on-error: true

    - name: Run Flake8 with security checks
      run: |
        flake8 src/ --format=json --exit-zero > flake8-report.json || true
      continue-on-error: true

    - name: Run Black formatting check
      run: |
        black --check --diff src/ > black-diff.txt || true
      continue-on-error: true

    - name: Run isort import sorting check
      run: |
        isort --check-only --diff src/ > isort-diff.txt || true
      continue-on-error: true

    - name: Upload code quality results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-quality-results
        path: |
          pylint-report.json
          flake8-report.json
          black-diff.txt
          isort-diff.txt

  # æµ‹è¯•è¦†ç›–ç‡åˆ†æ
  test-coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov coverage[toml]

    - name: Run tests with coverage
      run: |
        coverage run -m pytest scripts/tests/ -v --cov=src --cov-report=xml --cov-report=html --cov-fail-under=80
      continue-on-error: true

    - name: Generate coverage report
      run: |
        coverage report --show-missing
        coverage html

    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-coverage-results
        path: |
          coverage.xml
          htmlcov/

  # æ€§èƒ½åŸºå‡†æµ‹è¯•é˜¶æ®µ
  performance-benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-benchmark memory-profiler

    - name: Run performance benchmarks
      run: |
        python -m pytest scripts/tests/ --benchmark-only --benchmark-json=benchmark-results.json || true
      continue-on-error: true

    - name: Analyze memory usage
      run: |
        python -c "
import sys
sys.path.insert(0, '.')
from src.core.memory_manager import MemoryManager
import psutil
import os

print('=== å†…å­˜ä½¿ç”¨åˆ†æ ===')
process = psutil.Process(os.getpid())
memory_info = process.memory_info()
print(f'è¿›ç¨‹å†…å­˜ä½¿ç”¨: {memory_info.rss / 1024 / 1024:.2f} MB')
print(f'è™šæ‹Ÿå†…å­˜: {memory_info.vms / 1024 / 1024:.2f} MB')
print(f'CPU ä½¿ç”¨ç‡: {process.cpu_percent()}%')

# æ£€æŸ¥å†…å­˜ç®¡ç†å™¨çŠ¶æ€
try:
    from src.core.memory_manager import MemoryManager
    manager = MemoryManager()
    stats = manager.get_memory_stats()
    print(f'ç®¡ç†å†…å­˜ç»Ÿè®¡: {stats}')
except Exception as e:
    print(f'å†…å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: {e}')
"

    - name: Upload performance results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-results
        path: |
          benchmark-results.json

  # ä»£ç å¤æ‚åº¦åˆ†æ
  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon mccabe lizard

    - name: Run Radon complexity analysis
      run: |
        radon cc src/ -nb -a -nb > radon-cc.txt
        radon cc src/ -nb -nb | grep -E "(A\+|A|B|C|F)" > complexity-summary.txt
      continue-on-error: true

    - name: Run McCabe complexity
      run: |
        radon cc src/ -nb -nb > mccabe-complexity.txt || true
      continue-on-error: true

    - name: Run Lizard complexity
      run: |
        lizard src/ --language Python --CCN 10 --NLOC 50 > lizard-report.txt || true
      continue-on-error: true

    - name: Upload complexity results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: complexity-results
        path: |
          radon-cc.txt
          complexity-summary.txt
          mccabe-complexity.txt
          lizard-report.txt

  # å®‰å…¨ç¼–ç è§„èŒƒæ£€æŸ¥
  security-compliance:
    name: Security Compliance Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit semgrep safety

    - name: Check security coding standards compliance
      run: |
        # æ£€æŸ¥SQLæ³¨å…¥é˜²æŠ¤
        echo "=== SQLæ³¨å…¥é˜²æŠ¤æ£€æŸ¥ ==="
        grep -r "execute.*\+.*SELECT" src/ || echo "âœ… æœªå‘ç°SQLæ³¨å…¥é£é™©"
        grep -r "cursor.execute.*format" src/ || echo "âœ… æœªå‘ç°æ ¼å¼åŒ–å­—ç¬¦ä¸²SQLé£é™©"

        # æ£€æŸ¥å¯†ç å¤„ç†
        echo -e "\n=== å¯†ç å¤„ç†æ£€æŸ¥ ==="
        grep -r "password.*encode.*md5" src/ || echo "âœ… æœªå‘ç°MD5å¯†ç "
        grep -r "hashlib.md5" src/ || echo "âœ… æœªå‘ç°å¼±å“ˆå¸Œç®—æ³•"

        # æ£€æŸ¥æ–‡ä»¶æ“ä½œå®‰å…¨
        echo -e "\n=== æ–‡ä»¶æ“ä½œå®‰å…¨æ£€æŸ¥ ==="
        grep -r "open.*\+" src/ | head -5 || echo "âœ… æœªå‘ç°å±é™©çš„æ–‡ä»¶æ“ä½œ"

        # æ£€æŸ¥è¾“å…¥éªŒè¯
        echo -e "\n=== è¾“å…¥éªŒè¯æ£€æŸ¥ ==="
        missing_validation=0
        for file in $(find src/ -name "*.py" -type f | head -10); do
          if grep -q "request\." $file && ! grep -q "validate\|check" $file; then
            echo "âš ï¸  $file å¯èƒ½ç¼ºå°‘è¾“å…¥éªŒè¯"
            missing_validation=$((missing_validation + 1))
          fi
        done
        if [ $missing_validation -eq 0 ]; then
          echo "âœ… è¾“å…¥éªŒè¯æ£€æŸ¥é€šè¿‡"
        fi

    - name: Run comprehensive security scan
      run: |
        bandit -r src/ -f json -o bandit-compliance.json || true
        semgrep --config=p/ci --json -o semgrep-compliance.json src/ || true

    - name: Upload compliance results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: compliance-results
        path: |
          bandit-compliance.json
          semgrep-compliance.json

  # è´¨é‡æŠ¥å‘Šç”Ÿæˆ
  quality-report:
    name: Quality Report Generation
    runs-on: ubuntu-latest
    needs: [code-quality, test-coverage, performance-benchmark, complexity-analysis, security-compliance]

    steps:
    - name: Download all quality artifacts
      uses: actions/download-artifact@v3

    - name: Generate consolidated quality report
      run: |
        mkdir -p quality-reports

        # ç”Ÿæˆæ€»ä½“è´¨é‡æŠ¥å‘Š
        cat > quality-reports/quality-summary.md << 'EOF'
        # MyStocks ä»£ç è´¨é‡æŠ¥å‘Š

        ## æ‰§è¡Œæ—¶é—´
        $(date)

        ## è´¨é‡æ£€æŸ¥è¦†ç›–èŒƒå›´

        ### æ‰§è¡Œçš„è´¨é‡æ£€æŸ¥
        - âœ… Pylint é™æ€ä»£ç åˆ†æ
        - âœ… Flake8 ä»£ç é£æ ¼æ£€æŸ¥
        - âœ… Black ä»£ç æ ¼å¼æ£€æŸ¥
        - âœ… isort å¯¼å…¥æ’åºæ£€æŸ¥
        - âœ… æµ‹è¯•è¦†ç›–ç‡åˆ†æ
        - âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•
        - âœ… ä»£ç å¤æ‚åº¦åˆ†æ
        - âœ… å®‰å…¨åˆè§„æ£€æŸ¥

        ## ä»£ç è´¨é‡æŒ‡æ ‡
        EOF

        # æ·»åŠ Pylintç»“æœ
        if [ -f pylint-report.json ]; then
          echo "### Pylint åˆ†æç»“æœ" >> quality-reports/quality-summary.md
          python -c "
import json
with open('pylint-report.json') as f:
    try:
        data = json.load(f)
        if isinstance(data, list) and data:
            # å¤„ç†JSONæ•°ç»„æ ¼å¼
            errors = sum(1 for msg in data if msg.get('type') == 'convention')
            warnings = sum(1 for msg in data if msg.get('type') == 'refactor')
            criticals = sum(1 for msg in data if msg.get('type') == 'error')
            print(f'- é”™è¯¯: {errors}')
            print(f'- è­¦å‘Š: {warnings}')
            print(f'- é‡æ„å»ºè®®: {criticals}')
        else:
            print('- è§£æPylintæŠ¥å‘Šæ—¶å‡ºé”™')
    except:
        print('- æ— æ³•è§£æPylintæŠ¥å‘Š')
" >> quality-reports/quality-summary.md
        fi

        # æ·»åŠ è¦†ç›–ç‡ç»“æœ
        if [ -f coverage.xml ]; then
          echo -e "\n### æµ‹è¯•è¦†ç›–ç‡" >> quality-reports/quality-summary.md
          python -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('coverage.xml')
    root = tree.getroot()
    coverage = float(root.get('line-rate', '0')) * 100
    print(f'- ä»£ç è¦†ç›–ç‡: {coverage:.1f}%')
    if coverage < 80:
        print('- âš ï¸  è¦†ç›–ç‡ä½äº80%ç›®æ ‡')
    else:
        print('- âœ… è¦†ç›–ç‡è¾¾åˆ°ç›®æ ‡')
except:
    print('- æ— æ³•è§£æè¦†ç›–ç‡æŠ¥å‘Š')
" >> quality-reports/quality-summary.md
        fi

        # æ·»åŠ å¤æ‚åº¦ç»“æœ
        if [ -f complexity-summary.txt ]; then
          echo -e "\n### ä»£ç å¤æ‚åº¦" >> quality-reports/quality-summary.md
          cat complexity-summary.txt >> quality-reports/quality-summary.md
        fi

        # ç”ŸæˆJSONæ ¼å¼æŠ¥å‘Š
        cat > quality-reports/quality-results.json << 'JSON_EOF'
        {
          "timestamp": "$(date -Iseconds)",
          "quality_metrics": {
            "pylint_score": 0,
            "test_coverage": 0,
            "complexity_issues": 0,
            "security_issues": 0
          },
          "recommendations": []
        }
        JSON_EOF

        echo "è´¨é‡æŠ¥å‘Šå·²ç”Ÿæˆ: quality-reports/"

    - name: Upload quality reports
      uses: actions/upload-artifact@v3
      with:
        name: quality-reports
        path: quality-reports/

  # è´¨é‡é—¨ç¦
  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    needs: [quality-report]

    outputs:
      quality-pass: ${{ steps.gate.outputs.quality-pass }}

    steps:
    - name: Download quality reports
      uses: actions/download-artifact@v3

    - name: Quality Gate Evaluation
      id: gate
      run: |
        QUALITY_PASS=true
        QUALITY_ISSUES=""

        # æ£€æŸ¥Pylinté”™è¯¯
        if [ -f pylint-report.json ]; then
          ERROR_COUNT=$(python -c "
import json
try:
    with open('pylint-report.json') as f:
        data = json.load(f)
    if isinstance(data, list):
        error_count = len([msg for msg in data if msg.get('type') == 'error'])
        print(error_count)
    else:
        print('10')  # é»˜è®¤é”™è¯¯æ•°
except:
    print('10')
")
          if [ "$ERROR_COUNT" -gt 20 ]; then
            QUALITY_PASS=false
            QUALITY_ISSUES="$QUALITY_ISSUES Pylinté”™è¯¯è¿‡å¤š: $ERROR_COUNT ä¸ª"
          fi
        fi

        # æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
        if [ -f coverage.xml ]; then
          COVERAGE=$(python -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('coverage.xml')
    root = tree.getroot()
    coverage = float(root.get('line-rate', '0')) * 100
    print(f'{coverage:.1f}')
except:
    print('0.0')
")
          COVERAGE_NUM=$(echo $COVERAGE | cut -d. -f1)
          if [ "$COVERAGE_NUM" -lt 80 ]; then
            QUALITY_PASS=false
            QUALITY_ISSUES="$QUALITY_ISSUES æµ‹è¯•è¦†ç›–ç‡ä¸è¶³: ${COVERAGE_NUM}%"
          fi
        fi

        # æ£€æŸ¥ä»£ç å¤æ‚åº¦
        if [ -f complexity-summary.txt ]; then
          HIGH_COMPLEXITY=$(grep -c "F\|C" complexity-summary.txt 2>/dev/null || echo "0")
          if [ "$HIGH_COMPLEXITY" -gt 5 ]; then
            QUALITY_PASS=false
            QUALITY_ISSUES="$QUALITY_ISSUES é«˜å¤æ‚åº¦å‡½æ•°è¿‡å¤š: $HIGH_COMPLEXITY ä¸ª"
          fi
        fi

        # è¾“å‡ºç»“æœ
        if [ "$QUALITY_PASS" = "true" ]; then
          echo "âœ… ä»£ç è´¨é‡é—¨ç¦é€šè¿‡ - æ‰€æœ‰è´¨é‡æŒ‡æ ‡æ­£å¸¸"
          echo "quality-pass=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ä»£ç è´¨é‡é—¨ç¦å¤±è´¥ - $QUALITY_ISSUES"
          echo "quality-pass=false" >> $GITHUB_OUTPUT
        fi

    - name: Comment on PR
      if: github.event_name == 'pull_request' && steps.gate.outputs.quality-pass == 'false'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.name,
            body: 'âš ï¸ ä»£ç è´¨é‡é—¨ç¦å¤±è´¥ï¼è¯·ä¿®å¤ä»¥ä¸‹è´¨é‡é—®é¢˜åå†åˆå¹¶ï¼š\n- æ£€æŸ¥ä»£ç è´¨é‡æŠ¥å‘Š\n- ä¿®å¤Pylinté”™è¯¯\n- æé«˜æµ‹è¯•è¦†ç›–ç‡\n- é‡æ„é«˜å¤æ‚åº¦å‡½æ•°\n\nè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹è´¨é‡æµ‹è¯•æŠ¥å‘Šã€‚'
          })

  # æœ€ç»ˆæ•´åˆæŠ¥å‘Š
  final-report:
    name: Final Integration Report
    runs-on: ubuntu-latest
    needs: [security-gate, quality-gate]
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Generate final CI/CD report
      run: |
        echo "=== MyStocks CI/CD æµ‹è¯•æ€»ç»“ ==="
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "æäº¤: ${{ github.sha }}"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"
        echo ""

        # å®‰å…¨æµ‹è¯•ç»“æœ
        echo "ğŸ”’ å®‰å…¨æµ‹è¯•ç»“æœ:"
        if [ -f security-reports/security-summary.md ]; then
          grep -E "(âœ…|âŒ|âš ï¸)" security-reports/security-summary.md | head -5
        else
          echo "âŒ å®‰å…¨æµ‹è¯•æŠ¥å‘Šæœªæ‰¾åˆ°"
        fi

        # è´¨é‡æµ‹è¯•ç»“æœ
        echo -e "\nğŸ“Š è´¨é‡æµ‹è¯•ç»“æœ:"
        if [ -f quality-reports/quality-summary.md ]; then
          grep -E "(âœ…|âŒ|âš ï¸)" quality-reports/quality-summary.md | head -5
        else
          echo "âŒ è´¨é‡æµ‹è¯•æŠ¥å‘Šæœªæ‰¾åˆ°"
        fi

        # æ€»ä½“çŠ¶æ€
        echo -e "\nğŸ¯ æ€»ä½“çŠ¶æ€:"
        if [ "${{ needs.security-gate.outputs.security-pass }}" = "true" ] && [ "${{ needs.quality-gate.outputs.quality-pass }}" = "true" ]; then
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ - å¯ä»¥éƒ¨ç½²"
        else
          echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ - éœ€è¦ä¿®å¤"
        fi

    - name: Upload final report
      uses: actions/upload-artifact@v3
      with:
        name: ci-cd-final-report
        path: |
          security-reports/
          quality-reports/
