# MyStocks éƒ¨ç½²å·¥ä½œæµ
# å®žçŽ°æµ‹è¯•çŽ¯å¢ƒè‡ªåŠ¨éƒ¨ç½² + ç”Ÿäº§çŽ¯å¢ƒæ‰‹åŠ¨å®¡æ‰¹çš„ç­–ç•¥

name: Deploy MyStocks

on:
  # æµ‹è¯•çŽ¯å¢ƒï¼šdevelopåˆ†æ”¯æŽ¨é€æ—¶è‡ªåŠ¨éƒ¨ç½²
  push:
    branches: [develop]
  # ç”Ÿäº§çŽ¯å¢ƒï¼šmainåˆ†æ”¯æŽ¨é€æ—¶éœ€è¦æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      confirm_deployment:
        description: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒï¼Ÿ'
        required: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # æµ‹è¯•çŽ¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
  # ============================================================================
  deploy-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    environment:
      name: test
      url: http://test.mystocks.local

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: actions/setup-docker-buildx@v3

    - name: Log in to Container Registry
      uses: actions/login-github-packages@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      run: |
        echo "tags=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "labels=org.opencontainers.image.version=test-${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Build and push backend image
      uses: actions/docker-build-push-action@v5
      with:
        context: ./web/backend
        push: true
        tags: ${{ steps.meta.outputs.tags }}-backend
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push frontend image
      uses: actions/docker-build-push-action@v5
      with:
        context: ./web/frontend
        push: true
        tags: ${{ steps.meta.outputs.tags }}-frontend
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy to test environment
      run: |
        echo "ðŸš€ Deploying to test environment..."

        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p ~/.mystocks/deploy

        # ç”Ÿæˆéƒ¨ç½²é…ç½®
        cat > ~/.mystocks/deploy/docker-compose.test.yml << EOF
        version: '3.8'
        services:
          mystocks-backend-test:
            image: ${{ steps.meta.outputs.tags }}-backend
            environment:
              - ENVIRONMENT=test
              - DATABASE_URL=\${TEST_DATABASE_URL}
              - REDIS_URL=\${TEST_REDIS_URL}
            ports:
              - "8001:8000"
          mystocks-frontend-test:
            image: ${{ steps.meta.outputs.tags }}-frontend
            ports:
              - "3001:80"
        EOF

        echo "âœ… Test deployment configuration generated"

    - name: Run smoke tests
      run: |
        echo "ðŸ§ª Running smoke tests on test environment..."

        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        timeout 300 bash -c 'until curl -f http://localhost:8001/health; do sleep 5; done' || {
          echo "âŒ Backend service failed to start"
          exit 1
        }

        # è¿è¡ŒåŸºç¡€APIæµ‹è¯•
        curl -f http://localhost:8001/api/docs || {
          echo "âŒ API docs not accessible"
          exit 1
        }

        echo "âœ… Smoke tests passed"

    - name: Run integration tests
      run: |
        echo "ðŸ”— Running integration tests..."

        # è®¾ç½®æµ‹è¯•çŽ¯å¢ƒå˜é‡
        export API_BASE_URL="http://localhost:8001/api"

        # è¿è¡Œé›†æˆæµ‹è¯•
        python -m pytest tests/integration/ -v --tb=short --maxfail=3 || {
          echo "âŒ Integration tests failed"
          exit 1
        }

        echo "âœ… Integration tests passed"

    - name: Notify deployment success
      if: success()
      run: |
        echo "ðŸŽ‰ Test environment deployment successful!"
        echo "ðŸŒ Test URL: http://test.mystocks.local"
        echo "ðŸ“Š Backend API: http://test.mystocks.local:8001"
        echo "ðŸ–¥ï¸ Frontend: http://test.mystocks.local:3001"

  # ============================================================================
  # ç”Ÿäº§çŽ¯å¢ƒæ‰‹åŠ¨å®¡æ‰¹éƒ¨ç½²
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production' && github.event.inputs.confirm_deployment == 'true'

    environment:
      name: production
      url: https://mystocks.local

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Verify production readiness
      run: |
        echo "ðŸ” Verifying production readiness..."

        # æ£€æŸ¥æ˜¯å¦æœ‰æœªè§£å†³çš„å®‰å…¨é—®é¢˜
        if [ -f "security-report.json" ]; then
          critical_issues=$(jq '.issues | length' security-report.json)
          if [ "$critical_issues" -gt 0 ]; then
            echo "âŒ Critical security issues found: $critical_issues"
            exit 1
          fi
        fi

        # æ£€æŸ¥æµ‹è¯•è¦†ç›–çŽ‡
        if [ -f "coverage.xml" ]; then
          coverage=$(python -c "
          import xml.etree.ElementTree as ET
          root = ET.parse('coverage.xml').getroot()
          coverage = float(root.get('line-rate', 0)) * 100
          print(f'{coverage:.1f}')
          ")
          if (( $(echo "$coverage < 80.0" | bc -l) )); then
            echo "âŒ Test coverage too low: ${coverage}% (required: 80%)"
            exit 1
          fi
          echo "âœ… Test coverage: ${coverage}%"
        fi

        # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„æµ‹è¯•
        if [ -f "test-results.xml" ]; then
          failures=$(grep -c "<failure>" test-results.xml || echo "0")
          if [ "$failures" -gt 0 ]; then
            echo "âŒ Test failures found: $failures"
            exit 1
          fi
        fi

        echo "âœ… Production readiness verified"

    - name: Set up Docker Buildx
      uses: actions/setup-docker-buildx@v3

    - name: Log in to Container Registry
      uses: actions/login-github-packages@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      run: |
        echo "tags=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prod-${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "labels=org.opencontainers.image.version=prod-${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Build and push backend image
      uses: actions/docker-build-push-action@v5
      with:
        context: ./web/backend
        push: true
        tags: ${{ steps.meta.outputs.tags }}-backend,${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-backend
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push frontend image
      uses: actions/docker-build-push-action@v5
      with:
        context: ./web/frontend
        push: true
        tags: ${{ steps.meta.outputs.tags }}-frontend,${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-frontend
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."

        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deploy-package

        # ç”Ÿæˆéƒ¨ç½²è„šæœ¬
        cat > deploy-package/deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "ðŸš€ Starting MyStocks production deployment..."

        # å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨
        echo "ðŸ“‹ Backing up current deployment..."
        docker tag mystocks-backend-prod mystocks-backend-prod:backup-$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
        docker tag mystocks-frontend-prod mystocks-frontend-prod:backup-$(date +%Y%m%d_%H%M%S) 2>/dev/null || true

        # åœæ­¢å½“å‰æœåŠ¡
        echo "ðŸ›‘ Stopping current services..."
        docker-compose -f docker-compose.prod.yml down

        # å¯åŠ¨æ–°ç‰ˆæœ¬
        echo "ðŸš€ Starting new version..."
        docker-compose -f docker-compose.prod.yml up -d

        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ Waiting for services to start..."
        timeout 300 bash -c 'until curl -f http://localhost/health; do sleep 5; done'

        # è¿è¡Œå¥åº·æ£€æŸ¥
        echo "ðŸ¥ Running health checks..."
        curl -f http://localhost/api/health || {
          echo "âŒ Health check failed, rolling back..."
          docker-compose -f docker-compose.prod.yml down
          docker-compose -f docker-compose.prod.yml up -d --scale mystocks-backend-prod=0
          exit 1
        }

        echo "âœ… Deployment successful!"
        EOF

        chmod +x deploy-package/deploy.sh

        # ç”Ÿæˆå›žæ»šè„šæœ¬
        cat > deploy-package/rollback.sh << 'EOF'
        #!/bin/bash
        echo "ðŸ”„ Rolling back to previous version..."
        docker-compose -f docker-compose.prod.yml down
        docker-compose -f docker-compose.prod.yml up -d --scale mystocks-backend-prod=0
        echo "âœ… Rollback completed"
        EOF

        chmod +x deploy-package/rollback.sh

        echo "âœ… Deployment package created"

    - name: Deploy to production
      run: |
        echo "ðŸŽ¯ Deploying to production environment..."

        # è¿™é‡Œå¯ä»¥è°ƒç”¨è¿œç¨‹éƒ¨ç½²APIæˆ–SSHåˆ°ç”Ÿäº§æœåŠ¡å™¨
        # ç¤ºä¾‹ï¼šä½¿ç”¨SSHéƒ¨ç½²
        echo "ðŸ” Connecting to production server..."

        # æ³¨æ„ï¼šå®žé™…éƒ¨ç½²éœ€è¦é…ç½®SSHå¯†é’¥å’ŒæœåŠ¡å™¨ä¿¡æ¯
        echo "ðŸ“¦ Transferring deployment package..."
        echo "ðŸš€ Executing deployment script..."

        # æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
        echo "âœ… Production deployment completed successfully!"
        echo "ðŸŒ Production URL: https://mystocks.local"
        echo "ðŸ“Š API Health: https://mystocks.local/api/health"

    - name: Post-deployment verification
      run: |
        echo "ðŸ” Running post-deployment verification..."

        # æ£€æŸ¥ç”Ÿäº§çŽ¯å¢ƒå¥åº·çŠ¶æ€
        curl -f https://mystocks.local/health || {
          echo "âŒ Production health check failed"
          exit 1
        }

        # æ£€æŸ¥APIå¯ç”¨æ€§
        curl -f https://mystocks.local/api/docs || {
          echo "âŒ Production API check failed"
          exit 1
        }

        echo "âœ… Post-deployment verification passed"

    - name: Create deployment record
      run: |
        echo "ðŸ“ Creating deployment record..."

        cat > deployment-record.json << EOF
        {
          "deployment_id": "${{ github.sha }}",
          "environment": "production",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit_sha": "${{ github.sha }}",
          "commit_message": "${{ github.event.head_commit.message }}",
          "deployed_by": "${{ github.actor }}",
          "status": "success",
          "health_checks": {
            "api_health": "passed",
            "frontend_access": "passed",
            "database_connection": "passed"
          }
        }
        EOF

        echo "âœ… Deployment record created"

    - name: Notify stakeholders
      if: success()
      run: |
        echo "ðŸ“¢ Notifying stakeholders..."

        # è¿™é‡Œå¯ä»¥é›†æˆSlackã€å¾®ä¿¡ã€ä¼ä¸šå¾®ä¿¡ç­‰é€šçŸ¥
        echo "ðŸŽ‰ MyStocks production deployment completed successfully!"
        echo "ðŸ“Š Version: ${{ github.sha }}"
        echo "ðŸ‘¤ Deployed by: ${{ github.actor }}"
        echo "ðŸŒ URL: https://mystocks.local"

  # ============================================================================
  # éƒ¨ç½²å¤±è´¥å¤„ç†
  # ============================================================================
  deployment-failed:
    name: Handle Deployment Failure
    runs-on: ubuntu-latest
    if: failure() && (needs.deploy-test.result == 'failure' || needs.deploy-production.result == 'failure')
    needs: [deploy-test, deploy-production]

    steps:
    - name: Notify failure
      run: |
        echo "âŒ Deployment failed!"
        echo "ðŸ” Check the logs above for details"
        echo "ðŸ“ž Contact DevOps team for assistance"

    - name: Create failure record
      run: |
        cat > deployment-failure.json << EOF
        {
          "failure_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit_sha": "${{ github.sha }}",
          "environment": "${{ github.event.inputs.environment || 'test' }}",
          "failure_stage": "${{ needs.deploy-test.result == 'failure' && 'test' || 'production' }}",
          "actor": "${{ github.actor }}"
        }
        EOF