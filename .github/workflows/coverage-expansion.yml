name: Coverage Expansion

on:
  workflow_dispatch:
    inputs:
      target_coverage:
        description: 'Target coverage percentage'
        required: false
        default: '80'
        type: choice
        options:
        - '70'
        - '75'
        - '80'
        - '85'
        - '90'
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  analyze-coverage:
    runs-on: ubuntu-latest
    outputs:
      current_coverage: ${{ steps.coverage.outputs.current }}
      target_coverage: ${{ steps.coverage.outputs.target }}
      coverage_gap: ${{ steps.coverage.outputs.gap }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e ".[dev]"

    - name: Run full test suite with coverage
      run: |
        python -m pytest tests/ -v --cov=src --cov=web/backend/app --cov-report=xml --cov-report=html --cov-report=json

    - name: Analyze coverage gaps
      id: coverage
      run: |
        python scripts/analyze_coverage_gaps.py
        echo "current=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")" >> $GITHUB_OUTPUT
        echo "target=${{ inputs.target_coverage || '80' }}" >> $GITHUB_OUTPUT
        echo "gap=$(python -c "
        import json
        data = json.load(open('coverage.json'))
        current = data['totals']['percent_covered']
        target = ${{ inputs.target_coverage || 80 }}
        gap = max(0, target - current)
        print(f'{gap:.1f}')
        ")" >> $GITHUB_OUTPUT

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/

  generate-test-plan:
    needs: analyze-coverage
    runs-on: ubuntu-latest
    if: needs.analyze-coverage.outputs.coverage_gap > 0

    steps:
    - uses: actions/checkout@v4

    - name: Download coverage report
      uses: actions/download-artifact@v4
      with:
        name: coverage-report

    - name: Generate test expansion plan
      run: |
        python scripts/generate_test_plan.py \
          --current-coverage ${{ needs.analyze-coverage.outputs.current_coverage }} \
          --target-coverage ${{ needs.analyze-coverage.outputs.target_coverage }} \
          --output test_expansion_plan.md

    - name: Create test expansion issue
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const plan = fs.readFileSync('test_expansion_plan.md', 'utf8');

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Test Coverage Expansion: ${process.env.CURRENT_COVERAGE}% â†’ ${process.env.TARGET_COVERAGE}%`,
            body: `## Current Coverage: ${process.env.CURRENT_COVERAGE}%
## Target Coverage: ${process.env.TARGET_COVERAGE}%
## Gap: ${process.env.COVERAGE_GAP}%

${plan}

This issue was automatically generated by the Coverage Expansion workflow.`,
            labels: ['enhancement', 'testing', 'coverage']
          });
      env:
        CURRENT_COVERAGE: ${{ needs.analyze-coverage.outputs.current_coverage }}
        TARGET_COVERAGE: ${{ needs.analyze-coverage.outputs.target_coverage }}
        COVERAGE_GAP: ${{ needs.analyze-coverage.outputs.coverage_gap }}

  expand-tests:
    needs: [analyze-coverage, generate-test-plan]
    runs-on: ubuntu-latest
    if: needs.analyze-coverage.outputs.coverage_gap > 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e ".[dev]"

    - name: Auto-generate missing tests
      run: |
        python scripts/auto_generate_tests.py \
          --coverage-file coverage.json \
          --target-coverage ${{ needs.analyze-coverage.outputs.target_coverage }}

    - name: Validate generated tests
      run: |
        python -m pytest tests/ -x --tb=short

    - name: Create pull request with new tests
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "feat: auto-generated tests for coverage expansion"
        title: "Auto-generated tests for coverage expansion"
        body: |
          This PR contains automatically generated tests to increase code coverage.

          **Coverage Improvement:**
          - Current: ${{ needs.analyze-coverage.outputs.current_coverage }}%
          - Target: ${{ needs.analyze-coverage.outputs.target_coverage }}%
          - Gap: ${{ needs.analyze-coverage.outputs.coverage_gap }}%

          **Generated Files:**
          - New unit tests for uncovered functions
          - Integration tests for uncovered API endpoints
          - Edge case tests for improved coverage

          **Note:** Please review the generated tests for correctness and completeness.
        branch: coverage-expansion/auto-generated
        delete-branch: true