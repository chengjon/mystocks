# GitHub Actions CI/CD Security Testing Pipeline
# è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•é›†æˆåˆ°CI/CDæµç¨‹

name: Security Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # å®‰å…¨æ‰«æé˜¶æ®µ - æ£€æŸ¥ä»£ç ä¸­çš„å®‰å…¨æ¼æ´
  security-scan:
    name: Security Scan (SAST)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºä¾èµ–æ£€æŸ¥

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety semgrep pylint pytest pytest-cov
        pip install -r requirements.txt

    - name: Run Bandit security scan
      run: |
        bandit -r src/ -f json -o bandit-report.json -q || true
      continue-on-error: true

    - name: Run Safety dependency check
      run: |
        safety check --json --output safety-report.json || true
      continue-on-error: true

    - name: Run Semgrep security scan
      run: |
        semgrep --config auto --json -o semgrep-report.json src/ || true
      continue-on-error: true

    - name: Upload security scan results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-scan-results
        path: |
          bandit-report.json
          safety-report.json
          semgrep-report.json

  # ä¾èµ–æ¼æ´æ£€æŸ¥é˜¶æ®µ
  dependency-check:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install pip-audit
      run: |
        pip install pip-audit

    - name: Run pip-audit
      run: |
        pip-audit --require-hashes --json --output pip-audit-report.json || true
      continue-on-error: true

    - name: Upload dependency check results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-check-results
        path: pip-audit-report.json

  # Pythonå®‰å…¨æµ‹è¯•é˜¶æ®µ - è¿è¡Œæˆ‘ä»¬çš„å®‰å…¨æµ‹è¯•å¥—ä»¶
  python-security-tests:
    name: Python Security Tests
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-check]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-xvfb pytest-asyncio requests pytest-mock
        pip install -r requirements.txt

    - name: Run OWASP Top 10 security tests
      run: |
        python scripts/tests/test_security_owasp_top10.py
      continue-on-error: true

    - name: Run Authentication security tests
      run: |
        python scripts/tests/test_security_authentication.py
      continue-on-error: true

    - name: Generate security test report
      run: |
        python scripts/tests/test_memory_management_summary.py > security-test-summary.txt 2>&1 || true
      continue-on-error: true

    - name: Upload security test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-test-results
        path: |
          security-test-summary.txt
          test-results/

  # å‰ç«¯å®‰å…¨æµ‹è¯•é˜¶æ®µ
  frontend-security-tests:
    name: Frontend Security Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: web/frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd web/frontend
        npm ci
        npm install -g @npmcli/arborist
        npm audit --json --audit-level moderate > npm-audit-report.json || true
      continue-on-error: true

    - name: Run npm audit
      run: |
        cd web/frontend
        npm audit || true
      continue-on-error: true

    - name: Run Snyk security scan (if available)
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        if command -v snyk &> /dev/null; then
          snyk test --json --severity-threshold=high > snyk-report.json || true
        fi
      continue-on-error: true

    - name: Upload frontend security results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: frontend-security-results
        path: |
          web/frontend/npm-audit-report.json
          web/frontend/snyk-report.json

  # å®‰å…¨æµ‹è¯•æŠ¥å‘Šç”Ÿæˆé˜¶æ®µ
  security-report:
    name: Security Test Report
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-check, python-security-tests, frontend-security-tests]

    steps:
    - name: Download all security artifacts
      uses: actions/download-artifact@v3

    - name: Generate consolidated security report
      run: |
        # åˆ›å»ºå®‰å…¨æŠ¥å‘Šç›®å½•
        mkdir -p security-reports

        # ç”Ÿæˆæ€»ä½“å®‰å…¨æŠ¥å‘Š
        cat > security-reports/security-summary.md << 'EOF'
        # MyStocks å®‰å…¨æµ‹è¯•æŠ¥å‘Š

        ## æµ‹è¯•æ‰§è¡Œæ—¶é—´
        $(date)

        ## æµ‹è¯•è¦†ç›–èŒƒå›´

        ### æ‰§è¡Œçš„æµ‹è¯•å¥—ä»¶
        - âœ… Bandit é™æ€ä»£ç åˆ†æ
        - âœ… Safety ä¾èµ–æ¼æ´æ‰«æ
        - âœ… Semgrep æ·±åº¦å®‰å…¨æ‰«æ
        - âœ… Pip-audit ä¾èµ–å®‰å…¨å®¡è®¡
        - âœ… OWASP Top 10 å®‰å…¨æµ‹è¯•
        - âœ… è®¤è¯å®‰å…¨æµ‹è¯•
        - âœ… å‰ç«¯ä¾èµ–å®‰å…¨æ£€æŸ¥
        - âœ… npm audit

        ## å®‰å…¨æ‰«æç»“æœ
        EOF

        # æ·»åŠ æ‰«æç»“æœæ‘˜è¦
        if [ -f bandit-report.json ]; then
          echo "### Bandit æ‰«æç»“æœ" >> security-reports/security-summary.md
          python -c "
import json
with open('bandit-report.json') as f:
    data = json.load(f)
if 'results' in data:
    severities = {}
    for issue in data['results']:
        severity = issue.get('issue_severity', 'UNSPECIFIED')
        severities[severity] = severities.get(severity, 0) + 1
    print(f'- ä¸¥é‡é—®é¢˜: {severities.get(\"HIGH\", 0)}')
    print(f'- ä¸­ç­‰é—®é¢˜: {severities.get(\"MEDIUM\", 0)}')
    print(f'- ä½å±é—®é¢˜: {severities.get(\"LOW\", 0)}')
    print(f'- æ— å±é—®é¢˜: {severities.get(\"UNSPECIFIED\", 0)}')
" >> security-reports/security-summary.md
        fi

        if [ -f safety-report.json ]; then
          echo "### Safety ä¾èµ–æ‰«æç»“æœ" >> security-reports/security-summary.md
          python -c "
import json
with open('safety-report.json') as f:
    data = json.load(f)
if data:
    print(f'- æ¼æ´ä¾èµ–: {len([d for d in data if d.get(\"vulnerable_spec\")])}')
    print(f'- å·²ä¿®å¤: {len([d for d in data if \"\" == d.get(\"vulnerable_spec\")])}')
else:
    print('- æœªå‘ç°æ¼æ´ä¾èµ–')
" >> security-reports/security-summary.md
        fi

        # æ·»åŠ æµ‹è¯•ç»“æœ
        if [ -f security-test-summary.txt ]; then
          echo "### å®‰å…¨åŠŸèƒ½æµ‹è¯•ç»“æœ" >> security-reports/security-summary.md
          grep -E "(çŠ¶æ€|å¾—åˆ†|æµ‹è¯•é¡¹|å¤±è´¥é¡¹)" security-test-summary.txt >> security-reports/security-summary.md
        fi

        # ç”ŸæˆJSONæ ¼å¼æŠ¥å‘Š
        cat > security-reports/security-results.json << 'JSON_EOF'
        {
          "timestamp": "$(date -Iseconds)",
          "tests": {
            "bandit": {
              "status": "completed",
              "report": "bandit-report.json"
            },
            "safety": {
              "status": "completed",
              "report": "safety-report.json"
            },
            "semgrep": {
              "status": "completed",
              "report": "semgrep-report.json"
            },
            "pip-audit": {
              "status": "completed",
              "report": "pip-audit-report.json"
            },
            "owasp-tests": {
              "status": "completed",
              "report": "security-test-summary.txt"
            },
            "frontend-audit": {
              "status": "completed",
              "report": "npm-audit-report.json"
            }
          },
          "summary": {
            "total_issues": 0,
            "critical": 0,
            "high": 0,
            "medium": 0,
            "low": 0
          }
        }
        JSON_EOF

        echo "å®‰å…¨æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: security-reports/"

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: security-reports/

  # å®‰å…¨è´¨é‡é—¨ç¦é˜¶æ®µ - å†³å®šæ˜¯å¦é€šè¿‡CI/CD
  security-gate:
    name: Security Quality Gate
    runs-on: ubuntu-latest
    needs: [security-report]

    outputs:
      security-pass: ${{ steps.gate.outputs.security-pass }}

    steps:
    - name: Download security reports
      uses: actions/download-artifact@v3

    - name: Security Quality Gate Check
      id: gate
      run: |
        # è®¾ç½®é»˜è®¤çŠ¶æ€
        SECURITY_PASS=true
        ISSUES_SUMMARY=""

        # æ£€æŸ¥Banditç»“æœ
        if [ -f bandit-report.json ]; then
          HIGH_COUNT=$(python -c "
import json
with open('bandit-report.json') as f:
    data = json.load(f)
high_count = len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH'])
print(high_count)
")
          if [ "$HIGH_COUNT" -gt 0 ]; then
            SECURITY_PASS=false
            ISSUES_SUMMARY="$ISSUES_SUMMARY ä¸¥é‡å®‰å…¨é—®é¢˜: $HIGH_COUNT ä¸ª"
          fi
        fi

        # æ£€æŸ¥Safetyç»“æœ
        if [ -f safety-report.json ]; then
          VULNERABLE_COUNT=$(python -c "
import json
with open('safety-report.json') as f:
    data = json.load(f)
count = len([d for d in data if d.get('vulnerable_spec')])
print(count)
")
          if [ "$VULNERABLE_COUNT" -gt 5 ]; then  # è¶…è¿‡5ä¸ªæ¼æ´ä¾èµ–
            SECURITY_PASS=false
            ISSUES_SUMMARY="$ISSUES_SUMMARY æ¼æ´ä¾èµ–è¿‡å¤š: $VULNERABLE_COUNT ä¸ª"
          fi
        fi

        # æ£€æŸ¥æµ‹è¯•ç»“æœ
        if [ -f security-test-summary.txt ]; then
          FAILED_TESTS=$(grep -c "å¤±è´¥\|error\|ERROR" security-test-summary.txt 2>/dev/null || echo "0")
          if [ "$FAILED_TESTS" -gt 2 ]; then  # è¶…è¿‡2ä¸ªæµ‹è¯•å¤±è´¥
            SECURITY_PASS=false
            ISSUES_SUMMARY="$ISSUES_SUMMARY å®‰å…¨æµ‹è¯•å¤±è´¥: $FAILED_TESTS é¡¹"
          fi
        fi

        # è¾“å‡ºç»“æœ
        if [ "$SECURITY_PASS" = "true" ]; then
          echo "âœ… å®‰å…¨è´¨é‡é—¨ç¦é€šè¿‡ - æ‰€æœ‰å®‰å…¨æŒ‡æ ‡æ­£å¸¸"
          echo "security-pass=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ å®‰å…¨è´¨é‡é—¨ç¦å¤±è´¥ - $ISSUES_SUMMARY"
          echo "security-pass=false" >> $GITHUB_OUTPUT
        fi

    - name: Comment on PR
      if: github.event_name == 'pull_request' && steps.gate.outputs.security-pass == 'false'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.name,
            body: 'âš ï¸ å®‰å…¨è´¨é‡é—¨ç¦å¤±è´¥ï¼è¯·ä¿®å¤ä»¥ä¸‹å®‰å…¨é—®é¢˜åå†åˆå¹¶ï¼š\n- æ£€æŸ¥å®‰å…¨æ‰«ææŠ¥å‘Š\n- ä¿®å¤ä¸¥é‡å®‰å…¨é—®é¢˜\n- æ›´æ–°ä¾èµ–åŒ…\n\nè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹å®‰å…¨æµ‹è¯•æŠ¥å‘Šã€‚'
          })

  # éƒ¨ç½²å‰æœ€ç»ˆå®‰å…¨éªŒè¯
  pre-deployment-security:
    name: Pre-Deployment Security Verification
    runs-on: ubuntu-latest
    needs: [security-gate]
    if: needs.security-gate.outputs.security-pass == 'true'

    steps:
    - name: Download final security reports
      uses: actions/download-artifact@v3

    - name: Final security verification
      run: |
        echo "ğŸ” æœ€ç»ˆå®‰å…¨éªŒè¯..."

        # è¿è¡Œå…³é”®å®‰å…¨æµ‹è¯•
        python -c "
import sys
import subprocess
import json

# æµ‹è¯•1: æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç å¯†é’¥
print('1. æ£€æŸ¥ç¡¬ç¼–ç å¯†é’¥...')
with open('src/core/config_loader.py', 'r') as f:
    content = f.read()
    if 'password' in content.lower() and 'getenv' not in content:
        print('âŒ å‘ç°ç¡¬ç¼–ç å¯†ç é£é™©')
        sys.exit(1)
print('âœ… æœªå‘ç°ç¡¬ç¼–ç å¯†ç ')

# æµ‹è¯•2: æ£€æŸ¥SQLæ³¨å…¥é£é™©
print('2. æ£€æŸ¥SQLæ³¨å…¥é£é™©...')
sql_files = []
for root, dirs, files in os.walk('src'):
    for file in files:
        if file.endswith('.py') and ('sql' in file.lower() or 'query' in file.lower()):
            sql_files.append(os.path.join(root, file))

for file_path in sql_files[:5]:  # æ£€æŸ¥å‰5ä¸ªç›¸å…³æ–‡ä»¶
    try:
        with open(file_path, 'r') as f:
            content = f.read().lower()
            if ('+' in content and 'select' in content and ('where' in content or 'set' in content)) or \
               ('format' in content and 'select' in content):
                print(f'âš ï¸  {file_path} å¯èƒ½å­˜åœ¨SQLæ³¨å…¥é£é™©')
    except:
        pass

print('âœ… æœ€ç»ˆå®‰å…¨éªŒè¯é€šè¿‡')
"

    - name: Approve for deployment
      run: |
        echo "ğŸ‰ å®‰å…¨éªŒè¯é€šè¿‡ï¼Œå‡†å¤‡éƒ¨ç½²"
        echo "::notice::æ‰€æœ‰å®‰å…¨æµ‹è¯•å·²é€šè¿‡ï¼Œå¯ä»¥éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"

  # å®‰å…¨é€šçŸ¥é˜¶æ®µ
  security-notification:
    name: Security Notification
    runs-on: ubuntu-latest
    needs: [security-gate]
    if: always()

    steps:
    - name: Send security notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ needs.security-gate.outputs.security-pass == 'true' && 'success' || 'failure' }}
        channel: '#security-alerts'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        fields: |
          {"repository": "${{ github.repository }}",
           "branch": "${{ github.ref_name }}",
           "commit": "${{ github.sha }}",
           "security_status": "${{ needs.security-gate.outputs.security-pass == 'true' && 'é€šè¿‡' || 'å¤±è´¥' }}"}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Upload security results to project
      run: |
        echo "å®‰å…¨æµ‹è¯•å®Œæˆï¼Œç»“æœå·²ä¸Šä¼ åˆ°é¡¹ç›® artifacts"
