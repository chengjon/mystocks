# MyStocks ç›‘æ§éªŒè¯å·¥ä½œæµ
# å°†ç”Ÿäº§ç›‘æ§æ•°æ®é›†æˆåˆ°CI/CDæµç¨‹ä¸­ï¼Œè¿›è¡Œè‡ªåŠ¨åŒ–è´¨é‡éªŒè¯

name: Monitoring Validation

on:
  # å®šæ—¶æ£€æŸ¥ï¼šæ¯å¤©æ—©ä¸Šæ£€æŸ¥ç”Ÿäº§ç¯å¢ƒå¥åº·çŠ¶æ€
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹
  # æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸æ‰‹åŠ¨è¿è¡Œç›‘æ§éªŒè¯
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»å‹'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - performance
          - security
          - business
  # éƒ¨ç½²åéªŒè¯ï¼šç”Ÿäº§éƒ¨ç½²å®Œæˆåè‡ªåŠ¨è¿è¡Œ
  workflow_run:
    workflows: ["Deploy MyStocks"]
    types:
      - completed

env:
  PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL }}
  GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
  ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}

jobs:
  # ============================================================================
  # ç›‘æ§æ•°æ®æ”¶é›†
  # ============================================================================
  collect-monitoring-data:
    name: Collect Monitoring Data
    runs-on: ubuntu-latest
    outputs:
      performance_score: ${{ steps.performance.outputs.score }}
      security_score: ${{ steps.security.outputs.score }}
      business_health: ${{ steps.business.outputs.health }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install requests prometheus-client pandas numpy

    - name: Query Prometheus metrics
      id: prometheus
      run: |
        python -c "
        import requests
        import json
        import os
        from datetime import datetime, timedelta

        PROMETHEUS_URL = os.getenv('PROMETHEUS_URL', 'http://localhost:9090')

        def query_prometheus(query, hours=24):
            '''æŸ¥è¯¢PrometheusæŒ‡æ ‡'''
            end_time = datetime.now()
            start_time = end_time - timedelta(hours=hours)

            params = {
                'query': query,
                'start': start_time.timestamp(),
                'end': end_time.timestamp(),
                'step': '3600'  # 1å°æ—¶æ­¥é•¿
            }

            try:
                response = requests.get(f'{PROMETHEUS_URL}/api/v1/query_range', params=params)
                response.raise_for_status()
                return response.json()
            except Exception as e:
                print(f'Prometheus query failed: {e}')
                return {'data': {'result': []}}

        # æŸ¥è¯¢å…³é”®æŒ‡æ ‡
        metrics = {}

        # APIå“åº”æ—¶é—´
        api_response = query_prometheus('histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))')
        metrics['api_response_time'] = api_response

        # é”™è¯¯ç‡
        error_rate = query_prometheus('rate(http_requests_total{status_code=~\"5..\"}[5m]) / rate(http_requests_total[5m]) * 100')
        metrics['error_rate'] = error_rate

        # ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡
        cpu_usage = query_prometheus('system_cpu_usage_percent')
        memory_usage = query_prometheus('system_memory_usage_percent')
        metrics['system_resources'] = {'cpu': cpu_usage, 'memory': memory_usage}

        # ä¿å­˜æŒ‡æ ‡æ•°æ®
        with open('monitoring_data.json', 'w') as f:
            json.dump(metrics, f, indent=2)

        print('âœ… Monitoring data collected')
        "

    - name: Analyze performance metrics
      id: performance
      run: |
        python -c "
        import json
        import os

        # è¯»å–ç›‘æ§æ•°æ®
        with open('monitoring_data.json', 'r') as f:
            data = json.load(f)

        # åˆ†ææ€§èƒ½æŒ‡æ ‡
        performance_score = 100  # åŸºç¡€åˆ†æ•°

        # APIå“åº”æ—¶é—´è¯„åˆ† (ç›®æ ‡: <2ç§’ 95th percentile)
        if 'api_response_time' in data and data['api_response_time']['data']['result']:
            response_times = []
            for result in data['api_response_time']['data']['result']:
                if result['values']:
                    response_times.extend([float(v[1]) for v in result['values']])

            if response_times:
                avg_response_time = sum(response_times) / len(response_times)
                if avg_response_time > 2.0:
                    performance_score -= (avg_response_time - 2.0) * 20  # æ¯è¶…0.1ç§’å‡2åˆ†
                print(f'ğŸ“Š Average API response time: {avg_response_time:.2f}s')

        # ç³»ç»Ÿèµ„æºè¯„åˆ†
        if 'system_resources' in data:
            resources = data['system_resources']

            # CPUè¯„åˆ† (ç›®æ ‡: <80%)
            if resources.get('cpu', {}).get('data', {}).get('result'):
                cpu_values = []
                for result in resources['cpu']['data']['result']:
                    if result['values']:
                        cpu_values.extend([float(v[1]) for v in result['values']])

                if cpu_values:
                    avg_cpu = sum(cpu_values) / len(cpu_values)
                    if avg_cpu > 80:
                        performance_score -= (avg_cpu - 80) * 0.5  # æ¯è¶…1%å‡0.5åˆ†
                    print(f'ğŸ–¥ï¸ Average CPU usage: {avg_cpu:.1f}%')

            # å†…å­˜è¯„åˆ† (ç›®æ ‡: <85%)
            if resources.get('memory', {}).get('data', {}).get('result'):
                mem_values = []
                for result in resources['memory']['data']['result']:
                    if result['values']:
                        mem_values.extend([float(v[1]) for v in result['values']])

                if mem_values:
                    avg_mem = sum(mem_values) / len(mem_values)
                    if avg_mem > 85:
                        performance_score -= (avg_mem - 85) * 0.5  # æ¯è¶…1%å‡0.5åˆ†
                    print(f'ğŸ§  Average memory usage: {avg_mem:.1f}%')

        performance_score = max(0, min(100, performance_score))

        print(f'ğŸ¯ Performance Score: {performance_score:.1f}/100')

        # è®¾ç½®è¾“å‡º
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'score={performance_score:.1f}\\n')
        "

    - name: Analyze security metrics
      id: security
      run: |
        python -c "
        import json
        import os

        # è¯»å–ç›‘æ§æ•°æ®
        with open('monitoring_data.json', 'r') as f:
            data = json.load(f)

        # åˆ†æå®‰å…¨æŒ‡æ ‡
        security_score = 100  # åŸºç¡€åˆ†æ•°

        # é”™è¯¯ç‡è¯„åˆ† (ç›®æ ‡: <5%)
        if 'error_rate' in data and data['error_rate']['data']['result']:
            error_rates = []
            for result in data['error_rate']['data']['result']:
                if result['values']:
                    error_rates.extend([float(v[1]) for v in result['values']])

            if error_rates:
                avg_error_rate = sum(error_rates) / len(error_rates)
                if avg_error_rate > 5.0:
                    security_score -= (avg_error_rate - 5.0) * 5  # æ¯è¶…1%å‡5åˆ†
                elif avg_error_rate > 1.0:
                    security_score -= (avg_error_rate - 1.0) * 2  # 1-5%ä¹‹é—´æ¯è¶…1%å‡2åˆ†
                print(f'ğŸš¨ Average error rate: {avg_error_rate:.2f}%')

        # æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨å‘Šè­¦
        security_alerts = 0  # è¿™é‡Œå¯ä»¥æŸ¥è¯¢å®‰å…¨ç›¸å…³çš„å‘Šè­¦æ•°é‡

        if security_alerts > 0:
            security_score -= security_alerts * 10  # æ¯ä¸ªå®‰å…¨å‘Šè­¦å‡10åˆ†

        security_score = max(0, min(100, security_score))

        print(f'ğŸ”’ Security Score: {security_score:.1f}/100')

        # è®¾ç½®è¾“å‡º
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'score={security_score:.1f}\\n')
        "

    - name: Analyze business metrics
      id: business
      run: |
        python -c "
        import json
        import os

        # ä¸šåŠ¡å¥åº·åº¦åˆ†æ
        business_health = 'healthy'  # é»˜è®¤å¥åº·

        # è¿™é‡Œå¯ä»¥æ·»åŠ ä¸šåŠ¡æŒ‡æ ‡åˆ†æ
        # ä¾‹å¦‚ï¼šç”¨æˆ·æ´»è·ƒåº¦ã€ç­–ç•¥æˆåŠŸç‡ã€æ•°æ®è´¨é‡ç­‰

        print(f'ğŸ“ˆ Business Health: {business_health}')

        # è®¾ç½®è¾“å‡º
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'health={business_health}\\n')
        "

    - name: Upload monitoring data
      uses: actions/upload-artifact@v3
      with:
        name: monitoring-data
        path: monitoring_data.json

  # ============================================================================
  # è´¨é‡é—¨ç¦æ£€æŸ¥
  # ============================================================================
  quality-gate-check:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    needs: collect-monitoring-data
    if: needs.collect-monitoring-data.result == 'success'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check performance thresholds
      run: |
        PERFORMANCE_SCORE=${{ needs.collect-monitoring-data.outputs.performance_score }}
        SECURITY_SCORE=${{ needs.collect-monitoring-data.outputs.security_score }}

        echo "ğŸ“Š Performance Score: $PERFORMANCE_SCORE"
        echo "ğŸ”’ Security Score: $SECURITY_SCORE"

        # æ€§èƒ½é—¨ç¦ (åˆ†æ•° >= 70)
        if (( $(echo "$PERFORMANCE_SCORE < 70" | bc -l) )); then
          echo "::error::Performance score too low: $PERFORMANCE_SCORE (required: >=70)"
          echo "::error::Recent performance degradation detected. Check system resources and API response times."
          exit 1
        fi

        # å®‰å…¨é—¨ç¦ (åˆ†æ•° >= 80)
        if (( $(echo "$SECURITY_SCORE < 80" | bc -l) )); then
          echo "::error::Security score too low: $SECURITY_SCORE (required: >=80)"
          echo "::error::Security issues detected. Check error rates and system alerts."
          exit 1
        fi

        echo "âœ… All quality gates passed"

    - name: Generate quality report
      run: |
        cat > quality_report.md << EOF
        # MyStocks è´¨é‡é—¨ç¦æŠ¥å‘Š

        ## ç”Ÿæˆæ—¶é—´
        $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        ## è´¨é‡è¯„åˆ†

        ### æ€§èƒ½è¯„åˆ†
        - åˆ†æ•°: ${{ needs.collect-monitoring-data.outputs.performance_score }}/100
        - çŠ¶æ€: $([ "${{ needs.collect-monitoring-data.outputs.performance_score }}" -ge 70 ] && echo "âœ… é€šè¿‡" || echo "âŒ æœªé€šè¿‡")

        ### å®‰å…¨è¯„åˆ†
        - åˆ†æ•°: ${{ needs.collect-monitoring-data.outputs.security_score }}/100
        - çŠ¶æ€: $([ "${{ needs.collect-monitoring-data.outputs.security_score }}" -ge 80 ] && echo "âœ… é€šè¿‡" || echo "âŒ æœªé€šè¿‡")

        ### ä¸šåŠ¡å¥åº·åº¦
        - çŠ¶æ€: ${{ needs.collect-monitoring-data.outputs.business_health }}

        ## æ£€æŸ¥è¯¦æƒ…

        ### æ€§èƒ½æŒ‡æ ‡
        - APIå“åº”æ—¶é—´ç›®æ ‡: <2ç§’ (95th percentile)
        - CPUä½¿ç”¨ç‡ç›®æ ‡: <80%
        - å†…å­˜ä½¿ç”¨ç‡ç›®æ ‡: <85%

        ### å®‰å…¨æŒ‡æ ‡
        - é”™è¯¯ç‡ç›®æ ‡: <5%
        - å®‰å…¨å‘Šè­¦: 0ä¸ª

        ## å»ºè®®æªæ–½

        EOF

        # æ·»åŠ æ”¹è¿›å»ºè®®
        if (( $(echo "${{ needs.collect-monitoring-data.outputs.performance_score }} < 80" | bc -l) )); then
          echo "- ä¼˜åŒ–APIå“åº”æ—¶é—´ï¼Œæ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½" >> quality_report.md
        fi

        if (( $(echo "${{ needs.collect-monitoring-data.outputs.security_score }} < 90" | bc -l) )); then
          echo "- æ£€æŸ¥å¹¶ä¿®å¤ç³»ç»Ÿé”™è¯¯ï¼Œä¼˜åŒ–é”™è¯¯å¤„ç†é€»è¾‘" >> quality_report.md
        fi

        echo "- å®šæœŸç›‘æ§ç³»ç»ŸæŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜" >> quality_report.md

        cat quality_report.md

    - name: Upload quality report
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality_report.md

  # ============================================================================
  # å‘Šè­¦å¤„ç†
  # ============================================================================
  alert-handling:
    name: Alert Handling
    runs-on: ubuntu-latest
    needs: [collect-monitoring-data, quality-gate-check]
    if: failure() && needs.quality-gate-check.result == 'failure'

    steps:
    - name: Create alert notification
      run: |
        PERFORMANCE_SCORE=${{ needs.collect-monitoring-data.outputs.performance_score }}
        SECURITY_SCORE=${{ needs.collect-monitoring-data.outputs.security_score }}

        # æ„å»ºå‘Šè­¦æ¶ˆæ¯
        ALERT_MESSAGE="ğŸš¨ MyStocks è´¨é‡é—¨ç¦å‘Šè­¦\\n\\n"

        if (( $(echo "$PERFORMANCE_SCORE < 70" | bc -l) )); then
          ALERT_MESSAGE="${ALERT_MESSAGE}âŒ æ€§èƒ½è¯„åˆ†è¿‡ä½: $PERFORMANCE_SCORE/100\\n"
        fi

        if (( $(echo "$SECURITY_SCORE < 80" | bc -l) )); then
          ALERT_MESSAGE="${ALERT_MESSAGE}âŒ å®‰å…¨è¯„åˆ†è¿‡ä½: $SECURITY_SCORE/100\\n"
        fi

        ALERT_MESSAGE="${ALERT_MESSAGE}\\nè¯·ç«‹å³æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å¹¶é‡‡å– corrective actionã€‚\\n"
        ALERT_MESSAGE="${ALERT_MESSAGE}ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        echo "ALERT_MESSAGE=$ALERT_MESSAGE" >> $GITHUB_ENV

    - name: Send alert notification
      run: |
        # è¿™é‡Œå¯ä»¥é›†æˆå¤šç§é€šçŸ¥æ–¹å¼

        # 1. GitHub Issue åˆ›å»º
        if [ "${{ github.event_name }}" = "schedule" ]; then
          gh issue create \
            --title "ğŸš¨ è´¨é‡é—¨ç¦å‘Šè­¦ - $(date +%Y-%m-%d)" \
            --body "$ALERT_MESSAGE" \
            --label "alert,quality-gate"
        fi

        # 2. Webhook é€šçŸ¥ (å¦‚ä¼ä¸šå¾®ä¿¡ã€Slackç­‰)
        if [ -n "$ALERT_WEBHOOK_URL" ]; then
          curl -X POST "$ALERT_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"$ALERT_MESSAGE\"}"
        fi

        # 3. é‚®ä»¶é€šçŸ¥ (å¦‚æœé…ç½®äº†)
        # è¿™é‡Œå¯ä»¥æ·»åŠ é‚®ä»¶å‘é€é€»è¾‘

        echo "âœ… Alert notifications sent"

  # ============================================================================
  # æ”¹è¿›å»ºè®®ç”Ÿæˆ
  # ============================================================================
  generate-improvement-plan:
    name: Generate Improvement Plan
    runs-on: ubuntu-latest
    needs: collect-monitoring-data
    if: always()

    steps:
    - name: Analyze monitoring trends
      run: |
        python -c "
        import json
        import os

        # è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„è¶‹åŠ¿åˆ†æ
        # æ¯”è¾ƒå†å²æ•°æ®ï¼Œè¯†åˆ«æ€§èƒ½è¶‹åŠ¿

        improvements = []

        PERFORMANCE_SCORE = float('${{ needs.collect-monitoring-data.outputs.performance_score }}')
        SECURITY_SCORE = float('${{ needs.collect-monitoring-data.outputs.security_score }}')

        if PERFORMANCE_SCORE < 80:
            improvements.extend([
                'ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼Œæ·»åŠ é€‚å½“çš„ç´¢å¼•',
                'å®ç°APIå“åº”ç¼“å­˜æœºåˆ¶',
                'æ£€æŸ¥å¹¶ä¼˜åŒ–ç³»ç»Ÿèµ„æºé…ç½®'
            ])

        if SECURITY_SCORE < 90:
            improvements.extend([
                'æ”¹è¿›é”™è¯¯å¤„ç†é€»è¾‘ï¼Œå‡å°‘5xxé”™è¯¯',
                'æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶',
                'åŠ å¼ºè¾“å…¥éªŒè¯å’Œæ•°æ®æ¸…ç†'
            ])

        # ç”Ÿæˆæ”¹è¿›è®¡åˆ’
        with open('improvement_plan.md', 'w') as f:
            f.write('# MyStocks æ”¹è¿›è®¡åˆ’\\n\\n')
            f.write(f'ç”Ÿæˆæ—¶é—´: {os.popen(\"date -u +'%Y-%m-%d %H:%M:%S UTC'\").read().strip()}\\n\\n')

            if improvements:
                f.write('## å»ºè®®æ”¹è¿›é¡¹\\n\\n')
                for i, item in enumerate(improvements, 1):
                    f.write(f'{i}. {item}\\n')
            else:
                f.write('## ç³»ç»ŸçŠ¶æ€è‰¯å¥½\\n\\n')
                f.write('âœ… æ‰€æœ‰æŒ‡æ ‡å‡åœ¨æ­£å¸¸èŒƒå›´å†…ï¼Œæ— éœ€ç«‹å³æ”¹è¿›ã€‚\\n')

            f.write('\\n## ç›‘æ§å»ºè®®\\n\\n')
            f.write('- ç»§ç»­ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡\\n')
            f.write('- å®šæœŸå®¡æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ\\n')
            f.write('- å…³æ³¨å®‰å…¨å‘Šè­¦å’Œé”™è¯¯ç‡å˜åŒ–\\n')

        print('âœ… Improvement plan generated')
        "

    - name: Upload improvement plan
      uses: actions/upload-artifact@v3
      with:
        name: improvement-plan
        path: improvement_plan.md

  # ============================================================================
  # ç»“æœæ±‡æ€»
  # ============================================================================
  summary:
    name: Monitoring Validation Summary
    runs-on: ubuntu-latest
    needs: [collect-monitoring-data, quality-gate-check, generate-improvement-plan]
    if: always()

    steps:
    - name: Generate final summary
      run: |
        echo "## ğŸ“Š MyStocks ç›‘æ§éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥å„ä¸ªä»»åŠ¡çŠ¶æ€
        tasks_status() {
          local task_name=$1
          local status=$2

          if [ "$status" = "success" ]; then
            echo "âœ… $task_name" >> $GITHUB_STEP_SUMMARY
          elif [ "$status" = "failure" ]; then
            echo "âŒ $task_name" >> $GITHUB_STEP_SUMMARY
          elif [ "$status" = "skipped" ]; then
            echo "â­ï¸ $task_name (è·³è¿‡)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ $task_name ($status)" >> $GITHUB_STEP_SUMMARY
          fi
        }

        tasks_status "ç›‘æ§æ•°æ®æ”¶é›†" "${{ needs.collect-monitoring-data.result }}"
        tasks_status "è´¨é‡é—¨ç¦æ£€æŸ¥" "${{ needs.quality-gate-check.result }}"
        tasks_status "æ”¹è¿›è®¡åˆ’ç”Ÿæˆ" "${{ needs.generate-improvement-plan.result }}"

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ å…³é”®æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        echo "- æ€§èƒ½è¯„åˆ†: ${{ needs.collect-monitoring-data.outputs.performance_score }}/100" >> $GITHUB_STEP_SUMMARY
        echo "- å®‰å…¨è¯„åˆ†: ${{ needs.collect-monitoring-data.outputs.security_score }}/100" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸šåŠ¡å¥åº·åº¦: ${{ needs.collect-monitoring-data.outputs.business_health }}" >> $GITHUB_STEP_SUMMARY

        # æ ¹æ®æ•´ä½“çŠ¶æ€ç»™å‡ºå»ºè®®
        if [ "${{ needs.quality-gate-check.result }}" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ‰ éªŒè¯é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰è´¨é‡é—¨ç¦æ£€æŸ¥å‡å·²é€šè¿‡ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ éœ€è¦å…³æ³¨" >> $GITHUB_STEP_SUMMARY
          echo "éƒ¨åˆ†è´¨é‡é—¨ç¦æ£€æŸ¥æœªé€šè¿‡ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶é‡‡å– corrective actionã€‚" >> $GITHUB_STEP_SUMMARY
        fi