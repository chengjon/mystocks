# MyStocks é‡åŒ–ç­–ç•¥ä¸“é¡¹éªŒè¯å·¥ä½œæµ
# ä¸“é—¨éªŒè¯é‡åŒ–ç­–ç•¥çš„æ­£ç¡®æ€§ã€æ€§èƒ½å’Œåˆè§„æ€§

name: Quant Strategy Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/strategies/**'
      - 'src/ml_strategy/**'
      - 'src/backtesting/**'
      - 'src/domain/strategy/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/strategies/**'
      - 'src/ml_strategy/**'
      - 'src/backtesting/**'
      - 'src/domain/strategy/**'
  workflow_dispatch:
    inputs:
      validation_scope:
        description: 'éªŒè¯èŒƒå›´'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - syntax-only
          - performance-only
      benchmark_update:
        description: 'æ›´æ–°åŸºå‡†æ•°æ®'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================================================
  # é‡åŒ–ç­–ç•¥æ­£ç¡®æ€§éªŒè¯
  # ============================================================================
  quant-strategy-correctness:
    name: Quant Strategy Correctness Validation
    runs-on: ubuntu-latest

    strategy:
      matrix:
        validation_type: [syntax, imports, backtest_engine, security, code_quality, integration_testing, performance_regression, ai_enhanced, correctness]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pandas numpy scikit-learn tensorflow torch
        # å®‰è£…å¯é€‰ä¾èµ–
        pip install ta-lib --no-cache-dir || echo "TA-Lib not available"

    - name: Cache strategy benchmarks
      uses: actions/cache@v3
      with:
        path: ~/.mystocks/strategy_benchmarks
        key: strategy-benchmarks-${{ github.sha }}
        restore-keys: |
          strategy-benchmarks-

    - name: Run Quant Strategy Validation
      run: |
        echo "ğŸ¤– è¿è¡Œé‡åŒ–ç­–ç•¥æ­£ç¡®æ€§éªŒè¯ - ${{ matrix.validation_type }}"

        # è®¾ç½®ç¯å¢ƒå˜é‡
        export VALIDATION_TYPE="${{ matrix.validation_type }}"
        export BENCHMARK_UPDATE="${{ github.event.inputs.benchmark_update || 'false' }}"
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"

        # è¿è¡ŒéªŒè¯è„šæœ¬
        chmod +x scripts/ci/quant_strategy_validation.py
        python scripts/ci/quant_strategy_validation.py

      env:
        VALIDATION_TYPE: ${{ matrix.validation_type }}
        GITHUB_STEP_SUMMARY: strategy_validation_summary_${{ matrix.validation_type }}.md

    - name: Upload validation results
      uses: actions/upload-artifact@v3
      with:
        name: strategy-validation-${{ matrix.validation_type }}
        path: |
          quant_strategy_validation_results.json
          strategy_validation_summary_${{ matrix.validation_type }}.md
        retention-days: 30

    - name: Upload benchmark data (if updated)
      if: github.event.inputs.benchmark_update == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: updated-benchmarks
        path: ~/.mystocks/strategy_benchmarks/
        retention-days: 90

  # ============================================================================
  # MLç­–ç•¥ä¸“é¡¹éªŒè¯
  # ============================================================================
  ml-strategy-special-validation:
    name: ML Strategy Special Validation
    runs-on: ubuntu-latest
    needs: quant-strategy-correctness
    if: contains(needs.quant-strategy-correctness.result, 'success')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install ML dependencies
      run: |
        pip install scikit-learn tensorflow torch xgboost lightgbm
        pip install pandas numpy matplotlib seaborn

    - name: Validate ML Model Performance
      run: |
        echo "ğŸ§  éªŒè¯MLæ¨¡å‹æ€§èƒ½..."

        python -c "
        import sys
        sys.path.insert(0, 'src')

        # æµ‹è¯•MLç­–ç•¥çš„æ ¸å¿ƒåŠŸèƒ½
        try:
            from src.ml_strategy.validation.ml_strategy_validator import MLStrategyValidator
            
            # åˆ›å»ºéªŒè¯å™¨
            validator = MLStrategyValidator()
            print('âœ… MLç­–ç•¥éªŒè¯å™¨åˆå§‹åŒ–æˆåŠŸ')

            # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„MLæ¨¡å‹éªŒè¯é€»è¾‘
            # åŒ…æ‹¬æ¨¡å‹å‡†ç¡®æ€§ã€è¿‡æ‹Ÿåˆæ£€æµ‹ã€ç‰¹å¾é‡è¦æ€§ç­‰

        except Exception as e:
            print(f'âŒ MLç­–ç•¥éªŒè¯å¤±è´¥: {e}')
            exit(1)
        "

  # ============================================================================
  # ç­–ç•¥åŸºå‡†æ•°æ®ç®¡ç†
  # ============================================================================
  benchmark-data-management:
    name: Benchmark Data Management
    runs-on: ubuntu-latest
    needs: [quant-strategy-correctness, ml-strategy-special-validation]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download validation results
      uses: actions/download-artifact@v3
      with:
        name: strategy-validation-correctness
        path: validation-results

    - name: Process benchmark updates
      run: |
        echo "ğŸ“Š å¤„ç†ç­–ç•¥åŸºå‡†æ•°æ®æ›´æ–°..."

        if [ -f "validation-results/quant_strategy_validation_results.json" ]; then
          # è§£æéªŒè¯ç»“æœï¼Œæå–æ–°çš„åŸºå‡†æ•°æ®
          python -c "
          import json
          import os

          with open('validation-results/quant_strategy_validation_results.json', 'r') as f:
              results = json.load(f)

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„åŸºå‡†æ•°æ®éœ€è¦æ›´æ–°
          # è¿™é‡Œå¯ä»¥å®ç°åŸºå‡†æ•°æ®çš„è‡ªåŠ¨æ›´æ–°é€»è¾‘

          print('âœ… åŸºå‡†æ•°æ®å¤„ç†å®Œæˆ')
          "
        else
          echo "âš ï¸ æœªæ‰¾åˆ°éªŒè¯ç»“æœæ–‡ä»¶"
        fi

    - name: Update strategy benchmarks
      if: github.event.inputs.benchmark_update == 'true'
      run: |
        echo "ğŸ”„ æ›´æ–°ç­–ç•¥åŸºå‡†æ•°æ®..."

        # åˆ›å»ºåŸºå‡†æ•°æ®ç›®å½•
        mkdir -p .mystocks/benchmarks

        # ç”Ÿæˆæ–°çš„åŸºå‡†æ•°æ®
        python -c "
        import json
        import os
        from datetime import datetime

        # è¿™é‡Œå¯ä»¥ä»å†å²æ•°æ®ç”Ÿæˆæ–°çš„åŸºå‡†
        benchmarks = {
            'timestamp': datetime.now().isoformat(),
            'version': '1.0.0',
            'benchmarks': {
                'momentum_strategy': {
                    'sharpe_ratio': 1.2,
                    'max_drawdown': -0.15,
                    'total_return': 0.25
                },
                'mean_reversion_strategy': {
                    'sharpe_ratio': 0.8,
                    'max_drawdown': -0.12,
                    'total_return': 0.18
                }
            }
        }

        with open('.mystocks/benchmarks/current.json', 'w') as f:
            json.dump(benchmarks, f, indent=2)

        print('âœ… åŸºå‡†æ•°æ®æ›´æ–°å®Œæˆ')
        "

    - name: Upload updated benchmarks
      if: github.event.inputs.benchmark_update == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: strategy-benchmarks
        path: .mystocks/benchmarks/
        retention-days: 365

  # ============================================================================
  # éªŒè¯ç»“æœæ±‡æ€»ä¸æŠ¥å‘Š
  # ============================================================================
  validation-summary:
    name: Validation Summary & Reporting
    runs-on: ubuntu-latest
    needs: [quant-strategy-correctness, ml-strategy-special-validation, benchmark-data-management]
    if: always()

    steps:
    - name: Download all validation results
      uses: actions/download-artifact@v3
      with:
        path: all-results

    - name: Generate comprehensive report
      run: |
        echo "## ğŸ“Š MyStocks é‡åŒ–ç­–ç•¥éªŒè¯æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**éªŒè¯æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æ±‡æ€»å„ä¸ªéªŒè¯é˜¶æ®µçš„ç»“æœ
        echo "### ğŸ” éªŒè¯é˜¶æ®µç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # è¯­æ³•éªŒè¯
        if [ -f "all-results/strategy-validation-syntax/quant_strategy_validation_results.json" ]; then
          syntax_result=$(jq -r '.summary.overall_passed' all-results/strategy-validation-syntax/quant_strategy_validation_results.json)
          if [ "$syntax_result" = "true" ]; then
            echo "âœ… **è¯­æ³•éªŒè¯**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **è¯­æ³•éªŒè¯**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # å¯¼å…¥éªŒè¯
        if [ -f "all-results/strategy-validation-imports/quant_strategy_validation_results.json" ]; then
          import_result=$(jq -r '.summary.overall_passed' all-results/strategy-validation-imports/quant_strategy_validation_results.json)
          if [ "$import_result" = "true" ]; then
            echo "âœ… **å¯¼å…¥éªŒè¯**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **å¯¼å…¥éªŒè¯**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # å›æµ‹å¼•æ“éªŒè¯
        if [ -f "all-results/strategy-validation-backtest_engine/quant_strategy_validation_results.json" ]; then
          engine_result=$(jq -r '.summary.overall_passed' all-results/strategy-validation-backtest_engine/quant_strategy_validation_results.json)
          if [ "$engine_result" = "true" ]; then
            echo "âœ… **å›æµ‹å¼•æ“éªŒè¯**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **å›æµ‹å¼•æ“éªŒè¯**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # ç­–ç•¥æ­£ç¡®æ€§éªŒè¯
        if [ -f "all-results/strategy-validation-correctness/quant_strategy_validation_results.json" ]; then
          correctness_result=$(jq -r '.summary.overall_passed' all-results/strategy-validation-correctness/quant_strategy_validation_results.json)
          success_rate=$(jq -r '.summary.success_rate' all-results/strategy-validation-correctness/quant_strategy_validation_results.json)

          if [ "$correctness_result" = "true" ]; then
            echo "âœ… **ç­–ç•¥æ­£ç¡®æ€§éªŒè¯**: é€šè¿‡ (${success_rate}%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ç­–ç•¥æ­£ç¡®æ€§éªŒè¯**: å¤±è´¥ (${success_rate}%)" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # æ€§èƒ½éªŒè¯
        if [ -f "all-results/strategy-validation-performance/quant_strategy_validation_results.json" ]; then
          perf_result=$(jq -r '.summary.overall_passed' all-results/strategy-validation-performance/quant_strategy_validation_results.json)
          if [ "$perf_result" = "true" ]; then
            echo "âœ… **æ€§èƒ½éªŒè¯**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ€§èƒ½éªŒè¯**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        # æ€»ä½“è¯„ä¼°
        total_passed=0
        total_checks=0

        for result_file in all-results/strategy-validation-*/quant_strategy_validation_results.json; do
          if [ -f "$result_file" ]; then
            if jq -r '.summary.overall_passed' "$result_file" | grep -q "true"; then
              ((total_passed++))
            fi
            ((total_checks++))
          fi
        done

        if [ $total_checks -gt 0 ]; then
          overall_rate=$((total_passed * 100 / total_checks))

          echo "### ğŸ“ˆ æ€»ä½“è¯„ä¼°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é€šè¿‡ç‡**: ${overall_rate}% ($total_passed/$total_checks)" >> $GITHUB_STEP_SUMMARY

          if [ $overall_rate -ge 80 ]; then
            echo "**çŠ¶æ€**: ğŸŸ¢ ä¼˜ç§€" >> $GITHUB_STEP_SUMMARY
          elif [ $overall_rate -ge 60 ]; then
            echo "**çŠ¶æ€**: ğŸŸ¡ è‰¯å¥½" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€**: ğŸ”´ éœ€è¦æ”¹è¿›" >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Create GitHub Issue for failures
      if: needs.quant-strategy-correctness.result == 'failure'
      run: |
        echo "ğŸš¨ å‘ç°ç­–ç•¥éªŒè¯å¤±è´¥ï¼Œåˆ›å»ºé—®é¢˜è·Ÿè¸ª..."

        # åˆ›å»ºè¯¦ç»†çš„é—®é¢˜æŠ¥å‘Š
        ISSUE_BODY="## ğŸš¨ é‡åŒ–ç­–ç•¥éªŒè¯å¤±è´¥

**éªŒè¯æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
**Commit**: ${{ github.sha }}
**åˆ†æ”¯**: ${{ github.ref }}

### å¤±è´¥è¯¦æƒ…

$(cat $GITHUB_STEP_SUMMARY | grep -A 20 "### ğŸ” éªŒè¯é˜¶æ®µç»“æœ")

### å»ºè®®æªæ–½

1. æ£€æŸ¥å¤±è´¥çš„éªŒè¯é¡¹ç›®
2. æŸ¥çœ‹è¯¦ç»†çš„éªŒè¯æ—¥å¿—
3. ä¿®å¤ç›¸å…³é—®é¢˜åé‡æ–°æäº¤

### ç›¸å…³æ–‡ä»¶
- éªŒè¯ç»“æœ: strategy-validation-*.zip
- è¯¦ç»†æ—¥å¿—: æŸ¥çœ‹Actionsè¿è¡Œæ—¥å¿—

/cc @quant-team"

        gh issue create \
          --title "ğŸš¨ é‡åŒ–ç­–ç•¥éªŒè¯å¤±è´¥ - $(date +%Y%m%d)" \
          --body "$ISSUE_BODY" \
          --label "bug,quant-strategy,validation-failure" \
          --assignee ${{ github.actor }}

    - name: Final status notification
      run: |
        if [ "${{ needs.quant-strategy-correctness.result }}" = "success" ] && \
           [ "${{ needs.ml-strategy-special-validation.result }}" = "success" ]; then
          echo "ğŸ‰ é‡åŒ–ç­–ç•¥éªŒè¯å…¨éƒ¨é€šè¿‡ï¼"
        else
          echo "âš ï¸ é‡åŒ–ç­–ç•¥éªŒè¯éƒ¨åˆ†å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æŠ¥å‘Šã€‚"
          exit 1
        fi