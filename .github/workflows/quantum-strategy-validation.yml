# MyStocks é‡åŒ–ç­–ç•¥éªŒè¯å·¥ä½œæµ
# é’ˆå¯¹é‡åŒ–äº¤æ˜“å¹³å°çš„ç‰¹æ®Šéœ€æ±‚ï¼Œæä¾›ç­–ç•¥éªŒè¯å’Œæ•°æ®å®‰å…¨æ£€æŸ¥

name: Quantum Strategy Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/strategies/**'
      - 'src/backtesting/**'
      - 'src/trading/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/strategies/**'
      - 'src/backtesting/**'
      - 'src/trading/**'

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================================================
  # é‡åŒ–ç­–ç•¥éªŒè¯
  # ============================================================================
  quant-strategy-validation:
    name: Quantum Strategy Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pandas numpy pytest pytest-cov

    - name: ç­–ç•¥è¯­æ³•éªŒè¯
      run: |
        echo "ðŸ” éªŒè¯é‡åŒ–ç­–ç•¥è¯­æ³•..."
        python -c "
        import sys
        import os
        import ast

        sys.path.insert(0, 'src')
        syntax_errors = []

        # æ£€æŸ¥ç­–ç•¥ç›®å½•
        if os.path.exists('src/strategies'):
            for root, dirs, files in os.walk('src/strategies'):
                for file in files:
                    if file.endswith('.py') and not file.startswith('__'):
                        filepath = os.path.join(root, file)
                        try:
                            with open(filepath, 'r', encoding='utf-8') as f:
                                ast.parse(f.read())
                            print(f'âœ… {filepath}')
                        except SyntaxError as e:
                            syntax_errors.append(f'{filepath}: {e}')
                            print(f'âŒ {filepath}: {e}')

        if syntax_errors:
            print('::error::é‡åŒ–ç­–ç•¥è¯­æ³•é”™è¯¯')
            for error in syntax_errors:
                print(f'::error::{error}')
            sys.exit(1)
        else:
            print('âœ… æ‰€æœ‰é‡åŒ–ç­–ç•¥è¯­æ³•æ£€æŸ¥é€šè¿‡')
        "

    - name: ç­–ç•¥å¯¼å…¥æµ‹è¯•
      run: |
        echo "ðŸ” æµ‹è¯•ç­–ç•¥æ¨¡å—å¯¼å…¥..."
        python -c "
        import sys
        sys.path.insert(0, 'src')

        import_errors = []

        # å°è¯•å¯¼å…¥ç­–ç•¥æ¨¡å—
        try:
            from src.strategies import *
            print('âœ… ç­–ç•¥æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except ImportError as e:
            import_errors.append(f'Import error: {e}')
        except Exception as e:
            import_errors.append(f'å…¶ä»–é”™è¯¯: {e}')

        if import_errors:
            print('::error::ç­–ç•¥æ¨¡å—å¯¼å…¥å¤±è´¥')
            for error in import_errors:
                print(f'::error::{error}')
            sys.exit(1)
        "

    - name: ç­–ç•¥åŸºæœ¬åŠŸèƒ½æµ‹è¯•
      run: |
        echo "ðŸ” æ‰§è¡Œç­–ç•¥åŸºæœ¬åŠŸèƒ½æµ‹è¯•..."
        python -c "
        import sys
        sys.path.insert(0, 'src')

        test_results = []

        try:
            # æµ‹è¯•ç­–ç•¥å·¥åŽ‚
            from src.strategies.strategy_factory import StrategyFactory
            factory = StrategyFactory()
            print('âœ… ç­–ç•¥å·¥åŽ‚åˆå§‹åŒ–æˆåŠŸ')

            # æµ‹è¯•åŸºç¡€ç­–ç•¥
            if hasattr(factory, 'get_available_strategies'):
                strategies = factory.get_available_strategies()
                print(f'âœ… å‘çŽ° {len(strategies)} ä¸ªå¯ç”¨ç­–ç•¥')

            test_results.append(('strategy_factory', True))

        except Exception as e:
            print(f'âŒ ç­–ç•¥å·¥åŽ‚æµ‹è¯•å¤±è´¥: {e}')
            test_results.append(('strategy_factory', False))

        # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„æµ‹è¯•
        failed_tests = [name for name, passed in test_results if not passed]
        if failed_tests:
            print(f'::error::ç­–ç•¥åŠŸèƒ½æµ‹è¯•å¤±è´¥: {failed_tests}')
            sys.exit(1)
        else:
            print('âœ… ç­–ç•¥åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡')
        "

    - name: å›žæµ‹å¼•æ“ŽéªŒè¯
      run: |
        echo "ðŸ” éªŒè¯å›žæµ‹å¼•æ“Ž..."
        python -c "
        import sys
        sys.path.insert(0, 'src')

        try:
            from src.backtesting.engine import BacktestingEngine
            engine = BacktestingEngine()
            print('âœ… å›žæµ‹å¼•æ“Žåˆå§‹åŒ–æˆåŠŸ')

            # æµ‹è¯•åŸºæœ¬é…ç½®
            if hasattr(engine, 'validate_config'):
                config = {'strategy': 'test', 'data_source': 'mock'}
                is_valid = engine.validate_config(config)
                if is_valid:
                    print('âœ… å›žæµ‹é…ç½®éªŒè¯é€šè¿‡')
                else:
                    print('âŒ å›žæµ‹é…ç½®éªŒè¯å¤±è´¥')
                    sys.exit(1)

        except Exception as e:
            print(f'âŒ å›žæµ‹å¼•æ“ŽéªŒè¯å¤±è´¥: {e}')
            sys.exit(1)
        "

    - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        echo "ðŸ” æ‰§è¡Œç­–ç•¥æ€§èƒ½åŸºå‡†æµ‹è¯•..."
        python -c "
        import sys
        import time
        sys.path.insert(0, 'src')

        try:
            # ç®€å•çš„æ€§èƒ½æµ‹è¯•
            start_time = time.time()

            # æµ‹è¯•æ•°æ®å¤„ç†æ€§èƒ½
            import pandas as pd
            import numpy as np

            # ç”Ÿæˆæµ‹è¯•æ•°æ®
            dates = pd.date_range('2023-01-01', periods=1000, freq='D')
            data = pd.DataFrame({
                'close': np.random.randn(1000).cumsum() + 100,
                'volume': np.random.randint(1000, 10000, 1000)
            }, index=dates)

            # æµ‹è¯•åŸºæœ¬æŒ‡æ ‡è®¡ç®—
            data['returns'] = data['close'].pct_change()
            data['ma5'] = data['close'].rolling(5).mean()
            data['ma20'] = data['close'].rolling(20).mean()

            end_time = time.time()
            duration = end_time - start_time

            print(f'âœ… æ€§èƒ½æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: {duration:.2f}ç§’')
            print(f'âœ… æ•°æ®å¤„ç†: {len(data)} æ¡è®°å½•')

            # æ€§èƒ½é˜ˆå€¼æ£€æŸ¥
            if duration > 5.0:
                print(f'::warning::æ€§èƒ½æµ‹è¯•è€—æ—¶è¾ƒé•¿: {duration:.2f}ç§’')
            if len(data) < 900:
                print('::error::æ•°æ®å¤„ç†ä¸å®Œæ•´')
                sys.exit(1)

        except Exception as e:
            print(f'âŒ æ€§èƒ½åŸºå‡†æµ‹è¯•å¤±è´¥: {e}')
            sys.exit(1)
        "

  # ============================================================================
  # æ•°æ®å®‰å…¨æ£€æŸ¥
  # ============================================================================
  data-security-validation:
    name: Data Security Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: æ•æ„Ÿä¿¡æ¯æ‰«æ
      run: |
        echo "ðŸ”’ æ‰«ææ•æ„Ÿä¿¡æ¯æ³„éœ²..."

        # æ£€æŸ¥ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯
        sensitive_patterns=(
          'password.*=.*[^$]'
          'secret.*=.*[^$]'
          'key.*=.*[^$]'
          'token.*=.*[^$]'
          'api_key.*=.*[^$]'
        )

        found_sensitive=()

        for pattern in "${sensitive_patterns[@]}"; do
          # æŽ’é™¤æµ‹è¯•æ–‡ä»¶å’Œé…ç½®æ¨¡æ¿
          matches=$(grep -r -i "$pattern" --include="*.py" --exclude-dir="tests" --exclude-dir=".git" . | grep -v ".env.example" | grep -v "test_" | wc -l)
          if [ "$matches" -gt 0 ]; then
            found_sensitive+=("$pattern: $matches å¤„")
          fi
        done

        if [ ${#found_sensitive[@]} -gt 0 ]; then
          echo "::error::å‘çŽ°æ½œåœ¨çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
          for item in "${found_sensitive[@]}"; do
            echo "::error::$item"
          done
          exit 1
        else
          echo "âœ… æ•æ„Ÿä¿¡æ¯æ‰«æé€šè¿‡"
        fi

    - name: SQLæ³¨å…¥é£Žé™©æ£€æŸ¥
      run: |
        echo "ðŸ”’ æ£€æŸ¥SQLæ³¨å…¥é£Žé™©..."

        # æ£€æŸ¥å­—ç¬¦ä¸²æ‹¼æŽ¥çš„SQLæŸ¥è¯¢
        sql_injection_patterns=(
          'SELECT.*%s'
          'INSERT.*%s'
          'UPDATE.*%s'
          'DELETE.*%s'
          '\.format\(.*sql'
          'f".*SELECT'
          'f".*INSERT'
          'f".*UPDATE'
          'f".*DELETE'
        )

        risky_files=()

        for pattern in "${sql_injection_patterns[@]}"; do
          files=$(grep -r -l "$pattern" --include="*.py" --exclude-dir="tests" . 2>/dev/null || true)
          if [ -n "$files" ]; then
            risky_files+=("$files")
          fi
        done

        if [ ${#risky_files[@]} -gt 0 ]; then
          echo "::warning::å‘çŽ°å¯èƒ½çš„SQLæ³¨å…¥é£Žé™©æ–‡ä»¶:"
          for file in "${risky_files[@]}"; do
            echo "::warning::$file"
          done
          # ä¸é˜»æ–­CIï¼Œä½†å‘å‡ºè­¦å‘Š
        else
          echo "âœ… SQLæ³¨å…¥é£Žé™©æ£€æŸ¥é€šè¿‡"
        fi

    - name: æ•°æ®åŠ å¯†éªŒè¯
      run: |
        echo "ðŸ”’ éªŒè¯æ•°æ®åŠ å¯†é…ç½®..."

        python -c "
        import sys
        sys.path.insert(0, 'src')

        try:
            # æ£€æŸ¥åŠ å¯†é…ç½®
            from src.core.config import settings

            # æ£€æŸ¥æ˜¯å¦æœ‰åŠ å¯†ç›¸å…³çš„é…ç½®
            encryption_configured = False

            if hasattr(settings, 'encryption'):
                encryption_configured = True
                print('âœ… åŠ å¯†é…ç½®å·²å¯ç”¨')
            else:
                print('âš ï¸ æœªå‘çŽ°åŠ å¯†é…ç½®ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶')

            # æ£€æŸ¥æ•æ„Ÿæ•°æ®å¤„ç†
            if hasattr(settings, 'database'):
                db_config = settings.database
                if hasattr(db_config, 'password') and db_config.password:
                    # æ£€æŸ¥å¯†ç æ˜¯å¦æ˜¯çŽ¯å¢ƒå˜é‡å¼•ç”¨
                    if not db_config.password.startswith('$'):
                        print('::warning::æ•°æ®åº“å¯†ç å¯èƒ½æ˜Žæ–‡å­˜å‚¨')
                    else:
                        print('âœ… æ•°æ®åº“å¯†ç ä½¿ç”¨çŽ¯å¢ƒå˜é‡')

        except Exception as e:
            print(f'âš ï¸ æ•°æ®åŠ å¯†éªŒè¯å¤±è´¥: {e}')
        "

    - name: è®¿é—®æŽ§åˆ¶éªŒè¯
      run: |
        echo "ðŸ”’ éªŒè¯è®¿é—®æŽ§åˆ¶é…ç½®..."

        python -c "
        import sys
        sys.path.insert(0, 'src')

        try:
            # æ£€æŸ¥è®¤è¯å’ŒæŽˆæƒé…ç½®
            from src.core.config import settings

            auth_configured = False

            if hasattr(settings, 'auth'):
                auth_config = settings.auth
                if hasattr(auth_config, 'jwt_secret') and auth_config.jwt_secret:
                    if not auth_config.jwt_secret.startswith('$'):
                        print('::warning::JWTå¯†é’¥å¯èƒ½æ˜Žæ–‡å­˜å‚¨')
                    else:
                        print('âœ… JWTå¯†é’¥ä½¿ç”¨çŽ¯å¢ƒå˜é‡')
                    auth_configured = True

            if hasattr(settings, 'security'):
                security_config = settings.security
                if hasattr(security_config, 'cors_origins'):
                    print('âœ… CORSé…ç½®å·²è®¾ç½®')
                    auth_configured = True

            if not auth_configured:
                print('âš ï¸ æœªå‘çŽ°å®Œæ•´çš„è®¤è¯é…ç½®')

        except Exception as e:
            print(f'âš ï¸ è®¿é—®æŽ§åˆ¶éªŒè¯å¤±è´¥: {e}')
        "

  # ============================================================================
  # ç­–ç•¥æ€§èƒ½å›žå½’æµ‹è¯•
  # ============================================================================
  strategy-performance-regression:
    name: Strategy Performance Regression
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-benchmark

    - name: ä¸‹è½½åŸºå‡†æ€§èƒ½æ•°æ®
      run: |
        echo "ðŸ“Š ä¸‹è½½åŸºå‡†æ€§èƒ½æ•°æ®..."
        # è¿™é‡Œå¯ä»¥ä»ŽGitHub releasesæˆ–artifactä¸‹è½½åŸºå‡†æ•°æ®
        # æš‚æ—¶åˆ›å»ºç®€å•çš„åŸºå‡†

    - name: æ‰§è¡Œæ€§èƒ½å›žå½’æµ‹è¯•
      run: |
        echo "ðŸ“Š æ‰§è¡Œç­–ç•¥æ€§èƒ½å›žå½’æµ‹è¯•..."

        python -c "
        import sys
        import time
        import json
        sys.path.insert(0, 'src')

        results = {}

        try:
            # æµ‹è¯•ç­–ç•¥åˆå§‹åŒ–æ€§èƒ½
            start_time = time.time()
            from src.strategies.strategy_factory import StrategyFactory
            factory = StrategyFactory()
            init_time = time.time() - start_time
            results['strategy_init_time'] = init_time

            # æµ‹è¯•æ•°æ®å¤„ç†æ€§èƒ½
            import pandas as pd
            import numpy as np

            # ç”Ÿæˆæµ‹è¯•æ•°æ®é›†
            np.random.seed(42)  # ç¡®ä¿å¯é‡å¤æ€§
            dates = pd.date_range('2023-01-01', periods=1000, freq='D')
            data = pd.DataFrame({
                'close': np.random.randn(1000).cumsum() + 100,
                'volume': np.random.randint(1000, 10000, 1000),
                'high': np.random.randn(1000).cumsum() + 102,
                'low': np.random.randn(1000).cumsum() + 98
            }, index=dates)

            # æµ‹è¯•æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æ€§èƒ½
            start_time = time.time()
            data['ma5'] = data['close'].rolling(5).mean()
            data['ma20'] = data['close'].rolling(20).mean()
            data['rsi'] = 100 - (100 / (1 + data['close'].pct_change().rolling(14).mean() / data['close'].pct_change().rolling(14).std()))
            indicator_time = time.time() - start_time
            results['indicator_calc_time'] = indicator_time

            # ä¿å­˜ç»“æžœç”¨äºŽæ¯”è¾ƒ
            with open('performance_results.json', 'w') as f:
                json.dump(results, f, indent=2)

            print(f'âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ')
            print(f'ç­–ç•¥åˆå§‹åŒ–æ—¶é—´: {init_time:.3f}ç§’')
            print(f'æŒ‡æ ‡è®¡ç®—æ—¶é—´: {indicator_time:.3f}ç§’')

            # ç®€å•çš„å›žå½’æ£€æŸ¥ï¼ˆå¯ä»¥æ ¹æ®åŽ†å²æ•°æ®è°ƒæ•´é˜ˆå€¼ï¼‰
            if init_time > 5.0:
                print(f'::warning::ç­–ç•¥åˆå§‹åŒ–æ—¶é—´è¿‡é•¿: {init_time:.3f}ç§’')
            if indicator_time > 2.0:
                print(f'::warning::æŒ‡æ ‡è®¡ç®—æ—¶é—´è¿‡é•¿: {indicator_time:.3f}ç§’')

        except Exception as e:
            print(f'âŒ æ€§èƒ½å›žå½’æµ‹è¯•å¤±è´¥: {e}')
            sys.exit(1)
        "

    - name: ä¸Šä¼ æ€§èƒ½ç»“æžœ
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: performance_results.json

  # ============================================================================
  # ç»“æžœæ±‡æ€»
  # ============================================================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [quant-strategy-validation, data-security-validation, strategy-performance-regression]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "## ðŸ” é‡åŒ–ç­–ç•¥éªŒè¯ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥å„ä¸ªä»»åŠ¡çŠ¶æ€
        jobs_status() {
          local job_name=$1
          local status=$2

          if [ "$status" = "success" ]; then
            echo "âœ… $job_name" >> $GITHUB_STEP_SUMMARY
          elif [ "$status" = "failure" ]; then
            echo "âŒ $job_name" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ $job_name ($status)" >> $GITHUB_STEP_SUMMARY
          fi
        }

        jobs_status "ç­–ç•¥è¯­æ³•éªŒè¯" "${{ needs.quant-strategy-validation.result }}"
        jobs_status "æ•°æ®å®‰å…¨æ£€æŸ¥" "${{ needs.data-security-validation.result }}"
        jobs_status "æ€§èƒ½å›žå½’æµ‹è¯•" "${{ needs.strategy-performance-regression.result }}"

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ æ£€æŸ¥æ¸…å•" >> $GITHUB_STEP_SUMMARY
        echo "- [x] é‡åŒ–ç­–ç•¥è¯­æ³•æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
        echo "- [x] ç­–ç•¥æ¨¡å—å¯æ­£å¸¸å¯¼å…¥" >> $GITHUB_STEP_SUMMARY
        echo "- [x] å›žæµ‹å¼•æ“ŽåŠŸèƒ½æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        echo "- [x] æ— æ•æ„Ÿä¿¡æ¯æ³„éœ²" >> $GITHUB_STEP_SUMMARY
        echo "- [x] SQLæ³¨å…¥é£Žé™©å¯æŽ§" >> $GITHUB_STEP_SUMMARY
        echo "- [x] æ€§èƒ½å›žå½’åœ¨å¯æŽ¥å—èŒƒå›´å†…" >> $GITHUB_STEP_SUMMARY