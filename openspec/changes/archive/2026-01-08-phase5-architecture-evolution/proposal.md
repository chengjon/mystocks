# Change: Phase 5 架构演进 - 需求分析、架构设计、API设计

## Why

当前项目已完成Phase 1-4的基础设施建设（多数据源适配、双数据库架构、基础API框架），但在生产环境就绪度方面存在以下差距：
1. **性能不达标**：API响应时间未量化，部分接口P95延迟超过500ms
2. **监控缺失**：缺乏完整的可观测性体系（指标、日志、追踪）
3. **测试覆盖不足**：E2E测试框架未建立，核心业务场景未验证
4. **部署标准化缺失**：缺少容器化配置和K8s部署清单

## What Changes

### Phase 5 三大核心目标

#### 1. 性能优化体系
- 建立API性能基准：P95响应时间≤300ms
- 实现多级缓存策略（Redis + 应用内存 + 数据库查询缓存）
- 数据库查询优化：索引策略、连接池调优、查询语句优化

#### 2. 生产级可观测性
- 指标监控：Prometheus指标暴露（请求量、延迟、错误率、数据库连接）
- 日志规范：结构化日志（JSON格式）、日志级别策略、日志聚合配置
- 分布式追踪：请求链路追踪（入口→API→数据库）
- 告警规则：基于SLO的告警配置（可用性≥99.9%）

#### 3. E2E测试与质量保障
- Playwright测试框架搭建：15+核心业务场景覆盖
- 测试数据工厂：模拟股票数据、资金流向、龙虎榜数据
- CI/CD集成：测试自动化、门禁检查、性能回归检测

### 架构设计决策

| 领域 | 当前状态 | Phase 5 目标 |
|------|---------|-------------|
| API响应 | 无SLA | P95 ≤ 300ms |
| 监控 | 基础配置 | 完整可观测性 |
| 测试 | 单元测试 | E2E覆盖≥80% |
| 部署 | pm2手动 | K8s声明式 |
| 可用性 | 无量化 | ≥99.9% |

## Impact

- Affected specs:
  - `01-unified-response-format`（性能监控字段扩展）
  - `03-adapter-pattern`（新增缓存适配器）
  - 新增 `06-api-performance` 规范
  - 新增 `07-observability` 规范
  - 新增 `08-e2e-testing` 规范

- Affected code:
  - `src/api/` - 所有API端点（性能优化）
  - `src/core/` - 监控中间件、日志配置
  - `src/monitoring/` - 新增监控模块
  - `tests/e2e/` - 新增E2E测试套件
  - `config/monitoring/` - Prometheus/Grafana配置

- Breaking changes:
  - API响应格式新增性能字段（`performance`对象）
  - 日志格式从文本改为JSON结构化
