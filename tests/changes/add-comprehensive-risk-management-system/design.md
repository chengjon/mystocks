# Risk Management System Architecture Design

## Context
MyStocks项目已有成熟的监控基础设施，需要在此基础上构建完整的风险管理框架。现有系统包括：
- **信号监控系统**: SignalRecorder、SignalResultTracker、MonitoredNotificationManager
- **股票监控系统**: 异步事件总线(MonitoringEventPublisher)、GPU性能优化器
- **数据源生态**: 50+接口 (AKShare, Efinance, TDX, etc.)
- **GPU加速引擎**: 68.58x性能提升，CuPy/CUDA支持
- **双数据库架构**: PostgreSQL + TDengine，完整监控表结构
- **监控告警**: Grafana仪表板、Prometheus告警规则

风险管理系统将作为现有监控系统的"风险增强层"，深度集成而不重复建设。

## Goals / Non-Goals

### Goals
- ✅ **深度复用现有组件**: SignalRecorder记录风险事件，MonitoredNotificationManager发送风险告警
- ✅ **扩展GPU风险计算**: 在现有GPU引擎基础上增加VaR、CVaR、相关性矩阵计算
- ✅ **增强异步事件总线**: 扩展MonitoringEventPublisher支持风险事件类型
- ✅ **统一监控界面**: 在现有Grafana仪表板基础上增加风险监控面板
- ✅ **最小化新增代码**: 通过复用减少60%的开发工作量
- ✅ **保持系统一致性**: 遵循现有监控系统的架构模式和API规范

### Non-Goals
- ❌ 不重新实现监控基础设施
- ❌ 不重复建设GPU抽象层
- ❌ 不重建通知和告警系统
- ❌ 不新增外部数据源依赖
- ❌ 不实现复杂的机器学习模型

## Decisions

### 1. 架构模式选择
**决策**: 采用领域驱动设计(DDD)模式，分离业务逻辑和基础设施
**理由**: 风险管理业务复杂，需要清晰的领域边界和业务规则封装
**替代方案**: 考虑了简单服务模式，但DDD更适合复杂的业务逻辑演化

### 2. GPU加速策略
**决策**: 复用现有GPU引擎，不创建新的GPU抽象层
**理由**: 项目已有成熟的GPU基础设施，避免重复开发
**实现**: 通过`src/gpu/data_processor_factory.py`获取GPU处理器实例

### 3. 数据存储策略
**决策**: 扩展现有双数据库架构
- PostgreSQL: 风险策略配置、历史预警记录
- TDengine: 实时风险指标时序数据
**理由**: 充分利用现有数据库架构，无需引入新数据库

### 4. 前端集成策略
**决策**: 复用现有的Vue组件库和ECharts图表库
**理由**: 保持技术栈一致性，降低学习成本
**实现**: 在`src/views/risk/`目录下创建风险管理页面

### 5. API设计策略
**决策**: 采用RESTful + WebSocket混合架构
- RESTful: 风险配置、历史查询、报告生成
- WebSocket: 实时风险指标推送、紧急预警
**理由**: 满足不同场景的实时性需求

## Risks / Trade-offs

### 1. 性能风险
**风险**: GPU计算可能引入延迟，影响实时性
**缓解**: 实现CPU/GPU自动切换，设置合理的超时时间
**监控**: 通过现有监控系统跟踪GPU计算性能

### 2. 复杂性风险
**风险**: 风险计算涉及多个指标，可能引入逻辑错误
**缓解**: 采用TDD开发模式，为每个计算函数编写单元测试
**验证**: 历史数据回测验证计算准确性

### 3. 数据一致性风险
**风险**: 多个数据源的数据质量差异
**缓解**: 实现数据质量校验和异常检测
**回退**: 当数据质量不佳时，自动降级到保守策略

### 4. 用户体验风险
**风险**: 专业风险指标对普通用户过于复杂
**缓解**: 提供分层界面设计，高级用户可查看详细指标
**测试**: 用户可用性测试，确保界面直观易懂

## Migration Plan

### Phase 1: 基础架构 (Week 1-2)
1. 创建风险管理领域层目录结构
2. 实现基础风险指标计算 (CPU版本)
3. 创建数据库表结构
4. 搭建基本的API框架

### Phase 2: GPU加速集成 (Week 3-4)
1. 集成现有GPU引擎
2. 实现GPU加速的风险计算
3. 性能基准测试和优化
4. 回退机制实现

### Phase 3: 前端界面 (Week 5-6)
1. 创建风险仪表盘组件
2. 实现实时数据可视化
3. 集成预警通知系统
4. 用户界面测试和优化

### Phase 4: 生产部署 (Week 7-8)
1. 端到端集成测试
2. 性能压力测试
3. 监控告警配置
4. 生产环境部署

### Rollback Plan
- **数据库**: 风险相关表可以安全删除，不会影响现有数据
- **代码**: 所有新代码都位于`src/governance/risk_management/`目录
- **API**: 新增的`/api/v1/risk/`端点，不影响现有API
- **前端**: 新的风险页面独立部署，不影响现有界面

## Open Questions

### 1. 数据源质量保证
**问题**: 如何确保34个AKShare接口的数据质量和稳定性？
**需要澄清**: 是否需要实现数据源健康监控和自动切换机制？

### 2. 计算精度要求
**问题**: 风险指标计算需要达到什么精度要求？
**需要澄清**: 个股VaR误差容忍度？组合相关性计算精度？

### 3. 用户风险偏好配置
**问题**: 如何设计灵活的风险偏好配置系统？
**需要澄清**: 是否需要支持自定义风险指标权重和阈值？

### 4. 实时性要求
**问题**: 风险指标更新频率是多少？
**需要澄清**: 个股风险实时更新？组合风险定时计算？

### 5. 告警疲劳管理
**问题**: 如何避免告警疲劳和误报？
**需要澄清**: 告警去重规则？用户反馈学习机制？
