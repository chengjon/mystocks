# 数据库连通性测试说明

## 功能描述

这个Python程序用于测试`.env`文件中配置的各个数据库的连通性，包括：

- MySQL监控数据库 (SQLAlchemy格式)
- TDengine时序数据库
- PostgreSQL数据库
- Redis缓存数据库
- MySQL数据库
- MariaDB数据库

## 文件结构

```
mystocks/
├── .env                                    # 数据库配置文件
├── db_manager/
│   ├── database_test_menu.py              # ✅ 新版交互式菜单程序
│   ├── database_connectivity_test.py      # 原完整版测试程序
│   ├── test_config_only.py               # 可删除（已整合）
│   └── test_env_path.py                   # 可删除（已整合）
├── test_requirements.txt                  # 依赖库列表
└── DATABASE_TEST_README.md               # 本说明文档
```

## 🚀 推荐使用方式

### 交互式菜单程序（推荐）

使用新的交互式菜单程序 [database_test_menu.py](file://d:\MyData\GITHUB\mystocks\db_manager\database_test_menu.py)：

```bash
# 进入db_manager目录
cd mystocks/db_manager

# 运行交互式程序
python database_test_menu.py
```

**菜单选项：**
- 1️⃣ 查找 .env 文件路径
- 2️⃣ 数据库配置完整性测试
- 3️⃣ 数据库连通性测试（包括驱动检查）
- 4️⃣ 以上全部
- 5️⃣ 退出

## 重要说明

**程序现在会自动查找`.env`文件**，无需手动指定路径！

程序会按以下顺序查找`.env`文件：
1. `db_manager/.env` (当前目录)
2. `mystocks/.env` (上级目录) ← **推荐位置**
3. `GITHUB/.env` (项目根目录)

## 程序特性

- **自动配置读取**: 从`.env`文件自动读取数据库配置
- **连接超时控制**: 每个数据库连接都设置了合理的超时时间(5秒)
- **详细结果报告**: 显示连接状态、响应时间、数据库版本等信息
- **错误信息友好**: 提供清晰的错误描述，便于问题排查
- **总结统计**: 显示连接成功率和详细统计信息

## 输出示例

```
================================================================================
数据库连通性测试开始...
================================================================================

测试 MySQL Monitor...
  状态: ✓ 成功 (156ms)
  信息: 连接成功

测试 TDengine...
  状态: ✗ 失败
  信息: 连接失败: [0x80000004] Unable to establish connection

测试 PostgreSQL...
  状态: ✓ 成功 (89ms)
  信息: 连接成功，版本: 13.7

测试 Redis...
  状态: ✓ 成功 (12ms)
  信息: 连接成功，版本: 6.2.7

测试 MySQL...
  状态: ✓ 成功 (134ms)
  信息: 连接成功，版本: 8.0.32

测试 MariaDB...
  状态: ✓ 成功 (98ms)
  信息: 连接成功，版本: 10.6.12-MariaDB

================================================================================
测试总结
================================================================================
总数据库数量: 6
连接成功: 5
连接失败: 1
成功率: 83.3%

详细结果:
--------------------------------------------------------------------------------
数据库          状态     响应时间      信息
--------------------------------------------------------------------------------
MySQL Monitor   成功     156ms        连接成功
TDengine        失败     -            连接失败: [0x80000004] Unable to establish...
PostgreSQL      成功     89ms         连接成功，版本: 13.7
Redis           成功     12ms         连接成功，版本: 6.2.7
MySQL           成功     134ms        连接成功，版本: 8.0.32
MariaDB         成功     98ms         连接成功，版本: 10.6.12-MariaDB
```

## 注意事项

1. **网络连接**: 确保可以访问`nas-ip`地址
2. **防火墙**: 确认各数据库端口未被防火墙阻止
3. **权限**: 确认用户名和密码正确，且有足够权限
4. **服务状态**: 确认各数据库服务正在运行

## 故障排除

### 常见错误及解决方案

- **连接超时**: 检查网络连接和防火墙设置
- **认证失败**: 验证用户名和密码是否正确
- **端口拒绝**: 确认数据库服务正在运行且端口正确
- **缺少依赖**: 安装对应的Python库

### TDengine特别说明

TDengine可能需要额外的系统库支持，如果遇到连接问题：

1. 确认TDengine客户端库已正确安装
2. 检查系统是否有必要的动态链接库
3. 参考TDengine官方文档进行环境配置

## 扩展使用

程序设计为可扩展的，您可以：

1. 添加新的数据库测试方法
2. 修改超时时间和重试逻辑
3. 添加更详细的性能测试
4. 集成到监控系统中定期执行
