# Implementation Plan: Architecture Optimization for Quantitative Trading System

**Branch**: `002-arch-optimization` | **Date**: 2025-10-25 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-arch-optimization/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command following the Phase 0-1 planning workflow.

## Summary

Optimize MyStocks system architecture by reducing complexity from 7 layers to 3, consolidating 34 data classifications to 8-10 essential categories, simplifying 8 adapters to 3-4 core adapters, and migrating from 4 databases to 2 (TDengine + PostgreSQL). This optimization reduces codebase from 11,000 lines to ≤4,000 lines (-64%), improves performance by 30% (120ms→80ms), and cuts onboarding time by 90% (24-38h→6h) while maintaining professional quantitative analysis capabilities including industry classification, sector analysis, concept tracking, capital flow monitoring, and chip distribution analysis. The system will serve 1-2 person teams managing Chinese A-share market data for quantitative trading.

## Technical Context

**Language/Version**: Python 3.12 (current: WSL2 Linux environment with Conda)
**Primary Dependencies**:
- **Data Processing**: pandas ≥2.0.0, numpy ≥1.24.0
- **Databases**: psycopg2-binary ≥2.9.5 (PostgreSQL), taospy ≥2.7.2 (TDengine client)
- **Data Sources**: akshare ≥1.12.0, pytdx ≥1.72 (TDX local interface)
- **ORM & Validation**: sqlalchemy ≥2.0.0, pydantic ≥2.0.0
- **Logging**: loguru ≥0.7.0 (project standard)
- **Testing**: pytest ≥7.4.0, pytest-cov ≥4.1.0
- **Monitoring**: Grafana (external, independent PostgreSQL monitoring DB)

**Storage**:
- **TDengine** (market_data database): High-frequency time-series data (tick, minute K-lines)
  - Retention: 3 months hot data, then archive to PostgreSQL
  - Estimated size: ~20GB for 3 months (with 20:1 compression)
- **PostgreSQL** (mystocks database): All other data types including daily K-lines, reference data, derived indicators, trading records, metadata, and archived time-series data
  - With TimescaleDB extension for time-series optimization
  - Estimated size: ~50GB for 3 years historical data
- **Monitoring Database**: Independent PostgreSQL database for system monitoring (separate from business data)

**Testing**:
- **Framework**: pytest with coverage reporting (target: ≥80% coverage)
- **Test Categories**: Unit tests (70%), Integration tests (20%), End-to-end tests (10%)
- **CI/CD**: GitHub Actions with automated test execution on PR
- **Performance Tests**: Custom scripts for latency measurement (<80ms target)

**Target Platform**: Linux server (Ubuntu 20.04+ / WSL2), deployed via systemd services
**Project Type**: Single project (unified data management system with CLI and potential web frontend)

**Performance Goals**:
- **Query Latency**: ≤80ms average (current: 120ms, +33% improvement)
- **Code Reduction**: 11,000 → ≤4,000 lines (-64% reduction)
- **Abstraction Overhead**: ≤30% of execution time (current: 58%)
- **Onboarding Time**: ≤6 hours for new developers (current: 24-38 hours, -90%)
- **Batch Operations**: 10,000 records in ≤2 seconds

**Constraints**:
- **Team Size**: 1-2 person maintenance capacity (critical design constraint)
- **Backward Compatibility**: Gradual migration path for existing adapters during transition (6-8 week migration window)
- **Data Integrity**: Zero data loss during database migration (MySQL/Redis → PostgreSQL)
- **Business Continuity**: No downtime >4 hours during architecture migration
- **API Compatibility**: Existing data acquisition scripts must continue to work with adapter layer changes

**Scale/Scope**:
- **Adapter Consolidation**: 8 adapters → 3-4 core adapters (TDX, AkShare, Byapi, optional Baostock)
- **Layer Reduction**: 7 layers → 3 layers (Adapter → DataManager → Database)
- **Classification Simplification**: 34 classifications → 8-10 essential categories
- **Database Reduction**: 4 databases → 2 databases (TDengine + PostgreSQL)
- **Expected Code Volume**: ~4,000 lines core architecture + ~2,000 lines adapters + ~1,500 lines tests = ~7,500 lines total
- **Supported Markets**: Chinese A-share (SH 60xxxx, SZ 00xxxx, GEM 30xxxx) + Chinese stock index futures (IF, IC, IH)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Initial Evaluation (Pre-Phase 0)

- [x] **最高规范原则**: ✅ 确认遵循项目宪法和开发规范指导文档
  - 本计划遵循《项目开发规范与指导文档.md》和《代码修改规则.md》
  - 所有架构决策基于用户明确的优先级指导（简化优先于复杂性）

- [x] **业务范围原则**: ✅ 确认功能在A股市场范围内，无禁止业务
  - 支持范围：沪市（60开头）、深市（00开头）、创业板（30开头）
  - 支持合规股指期货：沪深300（IF）、中证500（IC）、上证50（IH）
  - 明确排除：美股、外汇、黄金、非指定期货品种
  - 港股预留接口但不实现（命名规范：xxx_hk_bridge）

- [x] **规范驱动开发**: ✅ 代码符合PEP8，文档包含元数据头
  - Python代码：PEP8 + Google风格注释 + 类型注解
  - 文档规范：所有新建MD文档包含元数据（创建人、版本、批准日期、修订记录）
  - 使用black格式化，flake8检查

- [x] **目录结构原则**: ✅ 遵循三层目录结构设计
  - 功能模块结构：adapters/, db_manager/, core.py, unified_manager.py
  - 每个模块包含：scripts/, tests/, docs/ 子目录
  - 公共逻辑：common/ 目录
  - 临时文件：temp/ 目录（含add.md记录文件）

- [x] **文档管理原则**: ✅ 新文档已获JohnC批准
  - 本计划作为speckit生成的标准工作流产物，遵循既定流程
  - 用户已明确要求"使用speckit对待修正的问题进行专业的规划和解决"
  - 关键架构决策（动态注册、分层存储、适配器优先级）已获用户明确批准

- [x] **代码质量原则**: ✅ 类型注解完整，异常处理规范，遵循代码修改规则.md
  - 严格遵循《代码修改规则.md》的最小变更原则
  - 分层验证：AI自检 → 自动化测试 → 人工审核
  - 版本控制：所有变更通过feature分支，禁止直接修改main
  - 架构合规：100%遵循配置驱动架构，严禁临时补救措施
  - PostgreSQL ORM：ENUM类型指定name参数，显式类型转换

- [x] **AI协作原则**: ✅ AI生成内容已进行合规自查，正确使用专门Agent
  - 架构设计阶段已使用`first-principles-fullstack-architect` Agent
  - 本计划创建使用`/speckit.plan`标准工作流
  - 后续将使用`database-architect-cn` Agent进行数据库优化设计
  - 代码实现后将使用`code-reviewer` Agent进行质量审查

### Evaluation Result: **✅ PASS** - All constitution principles satisfied

**Justification**: This architecture optimization is essential for team capacity (1-2 people) and directly addresses over-engineering issues identified through first-principles analysis. All changes align with project constitution and have explicit user approval.

---

### Post-Phase 1 Re-evaluation (After Design Completion)

**Re-evaluation Date**: 2025-10-25 (after completing research.md, data-model.md, contracts/, quickstart.md)

- [x] **最高规范原则**: ✅ 继续遵循
  - 所有设计文档已完成并遵循项目开发规范
  - Phase 0 research.md 详细记录了所有架构决策和备选方案
  - Phase 1 设计文档(data-model.md, contracts/)提供完整的实现指导

- [x] **业务范围原则**: ✅ 继续遵循
  - 数据分类系统明确支持A股市场(沪深60/00/30代码)
  - 明确排除美股/外汇/黄金等非核心业务
  - Industry/Sector/Concept分类专为中国市场设计

- [x] **规范驱动开发**: ✅ 继续遵循
  - API契约定义了标准接口(IDataSource, DataManager)
  - 数据模型使用pydantic进行类型验证
  - quickstart.md提供实现指南和代码规范示例

- [x] **目录结构原则**: ✅ 继续遵循
  - 保持3层架构:adapters/ → core.py/unified_manager.py → db_manager/
  - 所有设计文档在specs/002-arch-optimization/目录下
  - 遵循功能模块+生命周期/类型的目录组织

- [x] **文档管理原则**: ✅ 继续遵循
  - 所有新文档作为speckit工作流产物,遵循既定流程
  - 文档结构清晰:plan.md → research.md → data-model.md → contracts/ → quickstart.md
  - 用户已明确要求使用speckit进行规划

- [x] **代码质量原则**: ✅ 继续遵循并强化
  - API契约定义了错误处理、线程安全、性能目标
  - quickstart.md提供测试用例模板和性能基准
  - 明确架构合规要求(100%配置驱动,严禁临时补救)

- [x] **AI协作原则**: ✅ 继续遵循
  - 使用`first-principles-fullstack-architect` Agent完成架构分析
  - 使用`/speckit.plan`标准工作流生成本计划
  - 计划中明确后续使用`database-architect-cn`和`code-reviewer` Agent的时机

### Post-Phase 1 Evaluation Result: **✅ PASS** - Design完整且符合所有原则

**设计质量评估**:
1. **完整性**: Phase 0-1所有产物已生成(research.md, data-model.md, 3个contracts, quickstart.md)
2. **一致性**: 所有文档相互引用,设计决策一致(3层架构,10分类,3-4适配器,2数据库)
3. **可实现性**: quickstart.md提供详细实现步骤,包含代码示例和测试用例
4. **可测试性**: 定义了性能目标(<80ms延迟)和验证方法
5. **可维护性**: API契约清晰,分层明确,适合1-2人团队维护

**无新增架构违规**: 设计阶段未引入任何违反项目宪法的复杂度

## Project Structure

### Documentation (this feature)

```
specs/002-arch-optimization/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output - architecture research and decisions
├── data-model.md        # Phase 1 output - entity and relationship definitions
├── quickstart.md        # Phase 1 output - implementation guide
├── contracts/           # Phase 1 output - API contracts and interfaces
│   ├── data_manager_interface.md
│   ├── adapter_interface.md
│   └── data_classification_schema.md
├── spec.md              # Feature specification (already complete)
└── checklists/          # Quality checklists
    └── requirements.md  # Specification quality checklist (already complete)
```

### Source Code (repository root)

**Structure Type**: Single project with modular architecture

```
mystocks_spec/                           # Project root
├── adapters/                            # Data source adapter layer (Layer 1)
│   ├── __init__.py
│   ├── README.md                        # Adapter usage guide
│   ├── akshare_adapter.py               # Core: Comprehensive online data (keep)
│   ├── tdx_adapter.py                   # Core: Local high-speed data (keep)
│   ├── byapi_adapter.py                 # Core: Alternative API (keep)
│   ├── baostock_adapter.py              # Optional: Retained per user priority config
│   ├── financial_adapter.py             # To merge: → akshare_adapter
│   ├── customer_adapter.py              # To merge: → akshare_adapter
│   ├── tushare_adapter.py               # To deprecate: Optional/community (paid token)
│   ├── akshare_proxy_adapter.py         # To deprecate: Merge proxy config into akshare
│   └── tests/
│       ├── test_akshare_adapter.py
│       ├── test_tdx_adapter.py
│       └── test_byapi_adapter.py
│
├── core.py                              # Data Manager layer (Layer 2) - to be refactored
│   # Current: DataClassification, DatabaseTarget, DataStorageStrategy
│   # Target: Simplified DataManager class with 8-10 classifications
│
├── unified_manager.py                   # Unified API entry point - to be refactored
│   # Current: MyStocksUnifiedManager with complex routing
│   # Target: Simplified UnifiedDataManager with cache-first strategy
│
├── db_manager/                          # Database access layer (Layer 3)
│   ├── __init__.py
│   ├── database_manager.py              # ConfigDrivenTableManager (keep, enhance)
│   ├── tdengine_access.py               # TDengine specific operations (keep)
│   ├── postgresql_access.py             # PostgreSQL specific operations (keep)
│   └── tests/
│       ├── test_database_manager.py
│       └── test_tdengine.py
│
├── interfaces/                          # Abstract interfaces
│   ├── __init__.py
│   └── data_source.py                   # IDataSource interface (refactor for flexibility)
│
├── common/                              # Shared utilities
│   ├── __init__.py
│   ├── config_loader.py                 # Configuration management
│   ├── logger.py                        # Loguru logging setup
│   └── constants.py                     # Shared constants
│
├── utils/                               # Helper utilities
│   ├── date_utils.py                    # Date handling
│   ├── symbol_utils.py                  # Stock code processing
│   ├── column_mapper.py                 # Data field mapping
│   └── failure_recovery_queue.py        # Error handling
│
├── monitoring/                          # System monitoring (independent)
│   ├── monitoring_database.py           # PostgreSQL monitoring DB
│   ├── performance_monitor.py           # Performance tracking
│   ├── data_quality_monitor.py          # Data quality checks
│   └── alert_manager.py                 # Alert dispatching
│
├── config/                              # Configuration files
│   ├── table_config.yaml                # ConfigDriven table definitions
│   ├── automation_config.yaml           # Automation settings
│   └── strategy_config.yaml             # Strategy parameters
│
├── tests/                               # Project-level tests
│   ├── conftest.py                      # Pytest configuration
│   ├── test_database_manager.py
│   ├── test_akshare_adapter.py
│   ├── test_tdx_adapter.py
│   └── test_automation.py
│
├── specs/                               # Feature specifications
│   └── 002-arch-optimization/           # This feature
│
├── temp/                                # Temporary and archived files
│   ├── add.md                           # Temporary file registry
│   └── [various archived files]
│
├── .env                                 # Environment variables (git-ignored)
├── .env.example                         # Environment template
├── requirements.txt                     # Python dependencies
├── pytest.ini                           # Pytest configuration
├── CLAUDE.md                            # Claude Code project guide
├── README.md                            # Project overview
├── 项目开发规范与指导文档.md              # Development standards
└── 代码修改规则.md                        # Code modification rules
```

**Structure Decision**: Single project structure (Option 1) is used as MyStocks is a unified data management system. The architecture follows a clear 3-layer design:

1. **Layer 1 - Data Source Adapters** (`adapters/`): External data acquisition from various sources (TDX, AkShare, Byapi, etc.)
2. **Layer 2 - Data Manager** (`core.py`, `unified_manager.py`): Business logic, data routing, validation, caching strategy
3. **Layer 3 - Database Access** (`db_manager/`): Database-specific operations for TDengine and PostgreSQL

The monitoring system (`monitoring/`) is intentionally separate with its own independent PostgreSQL database to avoid circular dependencies and ensure monitoring reliability even during main system issues.

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**No Constitution Violations** - All principles satisfied.

This feature actually **reduces** complexity rather than adding it:
- Reduces layers: 7 → 3 (-57% architectural complexity)
- Reduces classifications: 34 → 8-10 (-71% classification overhead)
- Reduces adapters: 8 → 3-4 (-50% adapter maintenance)
- Reduces databases: 4 → 2 (-50% infrastructure complexity)
- Reduces codebase: 11,000 → 4,000 lines (-64% code volume)

The optimization aligns with constitution's core principle: "Simplicity > Complexity, Maintainability > Features"
