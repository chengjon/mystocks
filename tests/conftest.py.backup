"""
MyStocks pytest 配置文件

提供全局的测试配置和夹具
"""

import pytest
import sys
import os
from pathlib import Path

# 添加项目根目录到Python路径
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))
sys.path.insert(0, str(project_root / "src"))

# 设置测试环境变量
os.environ.setdefault('USE_MOCK_DATA', 'true')
os.environ.setdefault('TEST_MODE', 'true')


@pytest.fixture(autouse=True)
def test_environment():
    """全局测试环境配置"""
    yield
    # 测试后的清理工作
    pass


@pytest.fixture
def sample_dataframe():
    """提供示例DataFrame用于测试"""
    import pandas as pd
    return pd.DataFrame({
        'date': pd.date_range('2024-01-01', periods=5),
        'open': [10.0, 10.1, 10.2, 10.3, 10.4],
        'close': [10.1, 10.2, 10.3, 10.4, 10.5],
        'high': [10.2, 10.3, 10.4, 10.5, 10.6],
        'low': [9.9, 10.0, 10.1, 10.2, 10.3],
        'volume': [1000000] * 5
    })


@pytest.fixture
def mock_logger():
    """提供模拟的logger"""
    import logging
    return logging.getLogger('test')


def pytest_configure(config):
    """pytest配置"""
    # 添加自定义标记
    config.addinivalue_line(
        "markers", "slow: marks tests as slow (deselect with '-m \"not slow\"')"
    )
    config.addinivalue_line(
        "markers", "integration: marks tests as integration tests"
    )
    config.addinivalue_line(
        "markers", "unit: marks tests as unit tests"
    )
    config.addinivalue_line(
        "markers", "gpu: marks tests that require GPU"
    )
    config.addinivalue_line(
        "markers", "database: marks tests that require database"
    )
