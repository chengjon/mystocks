# MyStocks Frontend Nginx Configuration
# 支持 HTML5 History 模式
#
# 配置说明：
# 1. HTML5 History 模式支持：所有非静态文件请求回退到 index.html
# 2. API 反向代理：/api/ 路径代理到后端服务
# 3. 静态资源缓存：JS/CSS 文件长期缓存
#
# 部署步骤：
# 1. 构建前端：npm run build
# 2. 复制 dist/ 目录到服务器：/var/www/mystocks/dist
# 3. 复制本配置到：/etc/nginx/sites-available/mystocks
# 4. 启用站点：ln -s /etc/nginx/sites-available/mystocks /etc/nginx/sites-enabled/
# 5. 测试配置：nginx -t
# 6. 重载 Nginx：systemctl reload nginx

# ✅ 速率限制配置（防止DDoS攻击和API滥用）
# 定义速率限制区域（在http块中）
# 注意：如果本配置被include到主nginx.conf的http块中，移除下面的http包装
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;

# 定义429响应（速率限制超出）
server {
    listen 8080;
    server_name rate_limit_backend;

    location / {
        default_type application/json;
        return 429 '{"error":"Rate limit exceeded","message":"Too many requests. Please try again later.","retry_after":60}';
    }
}

server {
    listen 80;
    server_name mystocks.local;  # 替换为实际域名，如：your-domain.com

    # 前端构建文件根目录
    root /var/www/mystocks/dist;

    # 字符集
    charset utf-8;

    # 访问日志
    access_log /var/log/nginx/mystocks_access.log;
    error_log /var/log/nginx/mystocks_error.log;

    # ✅ 健康检查端点（用于监控系统和负载均衡器）
    location /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"healthy","timestamp":"$time_iso8601","service":"frontend-history-mode","version":"1.0"}';
    }

    # ✅ 就绪检查端点（检查前端静态资源和路由配置是否就绪）
    location /ready {
        access_log off;
        try_files /index.html @check_ready;
    }

    location @check_ready {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"ready","routes":"all_loaded","timestamp":"$time_iso8601"}';
    }

    # ✅ HTML5 History Mode 支持
    # 核心配置：所有非静态文件请求回退到 index.html
    location / {
        # ✅ 应用通用速率限制（30请求/秒，突发50）
        limit_req zone=general_limit burst=50;

        try_files $uri $uri/ /index.html;
    }

    # API 反向代理到后端
    location /api/ {
        # ✅ 应用严格的API速率限制（10请求/秒，突发20）
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;
        limit_req_log_level warn;

        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源缓存 - 提升性能（Vite生成带哈希的文件名）
    # ✅ 带哈希的JS/CSS文件（app.abc123.js）可以永久缓存
    location ~* \.[a-f0-9]{8}\.(js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ✅ 非哈希资源（图片、字体）- 较短期限以便更新
    location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
        expires 1M;
        add_header Cache-Control "public, must-revalidate";
        access_log off;
    }

    # ✅ 字体文件 - 1年缓存
    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ✅ index.html 永不缓存（确保始终获取最新版本）
    location = /index.html {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Gzip 压缩 - 提升传输性能
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentypefont/vnd woff image/svg+xml;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}

# HTTPS 配置（可选，启用 SSL 时取消注释）
# server {
#     listen 443 ssl http2;
#     server_name mystocks.local;
#
#     ssl_certificate /etc/nginx/ssl/mystocks.crt;
#     ssl_certificate_key /etc/ssl/mystocks.key;
#
#     root /var/www/mystocks/dist;
#
#     # HTML5 History Mode 支持
#     location / {
#         try_files $uri $uri/ /index.html;
#     }
#
#     # API 反向代理
#     location /api/ {
#         proxy_pass http://localhost:8000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#
#         # WebSocket 支持
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#     }
#
#     # 静态资源缓存
#     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         access_log off;
#     }
#
#     # 安全头
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
# }
