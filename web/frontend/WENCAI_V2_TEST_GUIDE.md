# 问财股票筛选器 V2 测试指南

## 更新内容概述

### 1. 新增功能
- ✅ **自定义查询输入框**：标题下方新增输入框，支持用户输入自然语言查询
- ✅ **树形结构布局**：将卡片布局改为树形结构，包含4个分组（默认、A、B、C）
- ✅ **优化的表格显示**：改进列名、数据格式和字体大小
- ✅ **新增列**：查询日期、序号
- ✅ **加入分组功能**：每行数据可以加入用户指定的分组
- ✅ **显示查询语句**：在结果上方显示完整的查询语句

### 2. 后端改进
- ✅ 新增 `/api/market/wencai/custom-query` 端点
- ✅ 支持自定义查询文本（不保存到数据库）
- ✅ 实时返回查询结果

## 测试步骤

### 准备工作

1. **清除浏览器缓存**
   ```
   Windows/Linux: Ctrl + Shift + R
   Mac: Cmd + Shift + R
   ```

2. **确认服务状态**
   ```bash
   # 前端服务
   ps aux | grep vite
   # 应该显示：npm run dev (端口 3001)

   # 后端服务
   ps aux | grep uvicorn
   # 应该显示：uvicorn app.main:app (端口 8000)
   ```

### 测试 1：自定义查询功能

**目标**：验证用户可以输入自定义查询并获得结果

**步骤**：
1. 访问 `http://localhost:3001`
2. 登录（admin / admin123）
3. 点击左侧菜单："市场数据" → "问财筛选"
4. 在标题下方看到输入框
5. 输入查询条件，例如：
   - `请列出今天涨幅超过5%的股票`
   - `量比大于2且换手率大于5%的股票`
   - `最近5天有涨停的创业板股票`
6. 点击右侧的"查询"按钮

**预期结果**：
- ✅ 查询按钮显示loading状态
- ✅ 查询完成后，右侧表格显示结果
- ✅ 表格上方显示查询语句（灰色标签）
- ✅ 表格显示：序号、股票代码、股票简称等列
- ✅ 涨跌幅列：正数显示红色，负数显示绿色
- ✅ 数值列：保留3位小数
- ✅ 涨跌幅列：保留2位小数，带%符号
- ✅ 查询日期列显示当前日期
- ✅ 每行有"加入分组"按钮

### 测试 2：树形结构布局

**目标**：验证查询列表以树形结构显示

**步骤**：
1. 查看左侧面板
2. 展开树形节点

**预期结果**：
- ✅ 看到4个文件夹图标：
  - 默认查询
  - 分组 A
  - 分组 B
  - 分组 C
- ✅ "默认查询"下有 qs_1 到 qs_9
- ✅ 每个查询节点有文档图标
- ✅ 鼠标悬停时显示"执行"按钮
- ✅ 点击查询节点时，右侧显示查询语句（但不执行）
- ✅ 点击"执行"按钮时，执行查询并显示结果

### 测试 3：优化的表格显示

**目标**：验证表格列显示符合要求

**步骤**：
1. 执行任一查询（预定义或自定义）
2. 查看表格列

**预期结果 - 显示的列**：
- ✅ 序号（自增，80px宽度）
- ✅ 股票代码（100px宽度，居中）
- ✅ 股票简称（120px宽度，居中）
- ✅ 最新价（100px宽度，右对齐，3位小数）
- ✅ 涨跌幅（100px宽度，右对齐，2位小数+%，带颜色）
- ✅ 涨停次数（100px宽度，居中）
- ✅ 量比（100px宽度，右对齐，3位小数）
- ✅ 换手率（100px宽度，右对齐，3位小数）
- ✅ 振幅（100px宽度，右对齐，3位小数）
- ✅ 查询日期（120px宽度，居中）
- ✅ 操作（120px宽度，固定右侧）

**预期结果 - 不显示的列**：
- ❌ 代码（重复）
- ❌ 名称（重复）
- ❌ a股市值(不含限售股)
- ❌ market_code

**预期结果 - 格式化**：
- ✅ 字体大小：14px（比之前大）
- ✅ 表头背景：浅灰色 (#f5f7fa)
- ✅ 涨跌幅颜色：
  - 正数：红色 (#f56c6c)
  - 负数：绿色 (#67c23a)
  - 零：默认黑色

### 测试 4：查询语句显示

**目标**：验证查询语句在结果上方显示

**步骤**：
1. 点击左侧树形中的任一查询节点（如 qs_1）
2. 查看右侧面板

**预期结果**：
- ✅ 表格上方显示灰色标签
- ✅ 标签内容：`查询语句：[完整的查询文本]`
- ✅ 查询文本完整可读

**步骤**：
1. 点击查询节点的"执行"按钮
2. 查看结果

**预期结果**：
- ✅ 查询语句继续显示
- ✅ 表格显示数据

### 测试 5：加入分组功能

**目标**：验证可以将股票加入指定分组

**步骤**：
1. 执行任一查询，获得结果
2. 点击某行的"加入分组"按钮
3. 在弹出对话框中：
   - 查看选中的股票信息
   - 选择分组（默认/A/B/C）
   - 点击"确定"

**预期结果**：
- ✅ 对话框显示股票代码和简称
- ✅ 分组下拉菜单有4个选项：默认、分组A、分组B、分组C
- ✅ 点击确定后显示成功消息
- ✅ 对话框关闭

**注意**：当前版本仅实现UI，分组数据暂未持久化

### 测试 6：分页功能

**目标**：验证表格分页正常工作

**步骤**：
1. 执行一个有较多结果的查询
2. 查看表格底部分页控件
3. 切换页码、修改每页条数

**预期结果**：
- ✅ 分页控件显示：总数、每页条数选择、页码、跳转
- ✅ 每页条数选项：20、50、100、200
- ✅ 切换页码时，序号正确（例如第2页第1条应该是21）
- ✅ 修改每页条数时，表格正确刷新

### 测试 7：导出功能

**目标**：验证CSV导出功能

**步骤**：
1. 执行查询获得结果
2. 点击右上角"导出CSV"按钮
3. 检查下载的文件

**预期结果**：
- ✅ 文件自动下载
- ✅ 文件名格式：`查询名称_日期.csv`（如：qs_1_2025-10-18.csv）
- ✅ 打开CSV文件，包含所有显示的列
- ✅ 数据格式正确（中文不乱码）
- ✅ 数值格式保留

## 后端 API 测试

### 测试自定义查询 API

```bash
# 测试健康检查
curl http://localhost:8000/api/market/wencai/health

# 预期返回
# {"status":"healthy","service":"wencai","version":"1.0.0"}

# 测试自定义查询
curl -X POST http://localhost:8000/api/market/wencai/custom-query \
  -H "Content-Type: application/json" \
  -d '{"query_text":"请列出今天涨幅超过3%的股票","pages":1}'

# 预期返回（示例）
# {
#   "success": true,
#   "message": "查询成功，共获取 100 条数据",
#   "query_text": "请列出今天涨幅超过3%的股票",
#   "total_records": 100,
#   "results": [...],
#   "columns": ["股票代码", "股票简称", ...],
#   "fetch_time": "2025-10-18T15:52:07.123456"
# }
```

## 常见问题排查

### 问题 1：自定义查询按钮无反应

**检查**：
1. 浏览器 Console 是否有错误
2. 后端服务是否正常运行
3. 网络请求是否成功

**解决**：
```bash
# 检查后端服务
curl http://localhost:8000/api/market/wencai/health

# 查看后端日志
tail -f /tmp/backend.log
```

### 问题 2：树形结构不显示

**检查**：
1. 是否硬刷新浏览器（Ctrl+Shift+R）
2. Console 是否有组件加载错误

**解决**：
- 清除浏览器缓存
- 重启前端服务

### 问题 3：表格列不符合要求

**检查**：
1. 是否使用的是 WencaiPanelV2.vue
2. 路由配置是否正确

**解决**：
```bash
# 检查路由配置
grep -A 3 "market-data/wencai" src/router/index.js
# 应该显示：component: () => import('@/components/market/WencaiPanelV2.vue')
```

### 问题 4：自定义查询返回空数据

**原因**：
- 问财API可能暂时无数据
- 查询条件太严格

**解决**：
- 尝试更宽松的查询条件
- 检查后端日志中的API响应

## 性能指标

**预期性能**：
- 自定义查询响应时间：< 3秒
- 预定义查询执行时间：< 2秒
- 页面加载时间：< 1秒
- 表格渲染（100行）：< 500ms

## 已知限制

1. **分组功能**：当前仅实现UI，数据未持久化到数据库
2. **自定义查询**：结果不保存到数据库，刷新后消失
3. **历史记录**：暂不支持查看自定义查询的历史
4. **分组管理**：暂不支持创建/删除/重命名分组

## 后续改进建议

1. **分组功能完善**：
   - 实现分组数据持久化
   - 支持自定义分组名称
   - 支持从分组中移除股票

2. **自定义查询增强**：
   - 支持保存常用查询
   - 支持查询历史记录
   - 支持查询结果缓存

3. **用户体验优化**：
   - 添加查询模板（常用查询示例）
   - 支持查询条件语法提示
   - 支持快捷键操作

## 测试完成标志

完成以上所有测试并验证通过后，可以确认 V2 版本功能正常。

### 快速验证清单

- [ ] 自定义查询输入框存在且可用
- [ ] 树形结构正确显示4个分组
- [ ] qs_1到qs_9在默认分组下
- [ ] 点击查询节点显示语句
- [ ] 点击执行按钮获得结果
- [ ] 表格列符合要求（10个列+操作列）
- [ ] 数值格式正确（3位/2位小数）
- [ ] 涨跌幅颜色正确（红涨绿跌）
- [ ] 查询日期显示当前日期
- [ ] 序号自增正确
- [ ] 加入分组对话框正常工作
- [ ] 分页功能正常
- [ ] CSV导出功能正常

---

**文档版本**: 1.0
**创建日期**: 2025-10-18
**测试环境**: Vue 3 + Element Plus + FastAPI
**维护者**: Claude Code
