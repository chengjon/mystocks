# 前端开发服务器启动指南

## 快速启动

### 方式1: 标准启动（推荐）
使用智能端口切换脚本，自动尝试3000→3001→3002端口：

```bash
cd web/frontend
npm run dev:safe
```

### 方式2: 原始启动
使用Vite默认行为（会无限递增端口）：

```bash
cd web/frontend
npm run dev
```

## 端口选择策略

`npm run dev:safe` 会按照以下策略选择端口：

1. **优先使用 3000** - 如果可用，使用3000端口
2. **备用 3001** - 如果3000被占用，切换到3001
3. **最后 3002** - 如果3001也被占用，切换到3002
4. **报警退出** - 如果3000、3001、3002全部被占用，报警并退出

## 报警示例

如果所有端口都被占用，会显示详细的报警信息：

```
========================================
❌ 错误: 所有端口都被占用！
========================================

已尝试的端口: 3000 3001 3002

请执行以下操作之一:
  1. 释放占用的端口:
     端口 3000 被PID 12345 占用，可执行: kill 12345
     端口 3001 被PID 67890 占用，可执行: kill 67890
     端口 3002 被PID 11111 占用，可执行: kill 11111
  2. 修改 vite.config.js 中的 port 配置
  3. 等待其他服务释放端口后重试

========================================
```

## 释放端口

### 查看端口占用情况
```bash
lsof -i :3000
lsof -i :3001
lsof -i :3002
```

### 终止占用端口的进程
```bash
# 方法1: 使用kill命令
kill <PID>

# 方法2: 强制终止
kill -9 <PID>

# 方法3: 批量终止（谨慎使用）
lsof -ti :3000 | xargs kill
```

## 配置文件

### vite.config.js
```javascript
server: {
  host: '0.0.0.0',
  port: 3000,
  strictPort: false, // 允许端口被占用时自动切换
  proxy: {
    '/api': {
      target: 'http://localhost:8000',
      changeOrigin: true
    }
  }
}
```

### start-dev.sh
智能启动脚本，实现3层端口回退策略：
- 检查3000/3001/3002端口可用性
- 自动选择第一个可用端口
- 如果全部占用则报警并退出

## 访问地址

成功启动后，可以通过以下地址访问：

- Local: http://localhost:3000 (或3001/3002)
- Network: http://<your-ip>:3000

## 常见问题

### Q: 为什么不使用3000端口？
A: 可能3000端口被其他服务占用，脚本会自动切换到3001或3002。

### Q: 如何强制使用3000端口？
A: 先释放3000端口，然后运行 `npm run dev:safe`。

### Q: 脚本报错"所有端口都被占用"怎么办？
A: 按照报警信息中的提示，释放至少一个端口（3000、3001或3002），然后重试。

### Q: 可以自定义端口列表吗？
A: 可以。编辑 `start-dev.sh`，修改 `PORTS=(3000 3001 3002)` 这一行。

## 技术细节

### 端口检查逻辑
```bash
# 使用lsof命令检查端口是否被占用
lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1
```

### 启动流程
1. 遍历端口列表 [3000, 3001, 3002]
2. 对每个端口执行 `lsof` 检查
3. 找到第一个可用端口后，使用 `--port` 参数启动Vite
4. 如果没有可用端口，显示详细报警信息并退出

## 更新日志

- **2025-10-30**:
  - 新增 `start-dev.sh` 智能启动脚本
  - 添加 `npm run dev:safe` 命令
  - 实现3层端口回退策略（3000→3001→3002）
  - 添加端口全部占用时的报警机制
