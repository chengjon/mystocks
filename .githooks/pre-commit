#!/bin/bash
# Pre-commit hook: Prevent root directory pollution
# Install: git config core.hooksPath .githooks
#
# åŸºäºŽ FILE_ORGANIZATION_RULES.md v1.4 æ›´æ–°
# æ›´æ–°è®°å½•: 2026-02-13 - å¯¹é½ reorganize-project-directory-structure ä»»åŠ¡ç»“æžœ
#
# ============================================================================

set -e

# Whitelist of allowed root files (non-hidden)
# å…è®¸åœ¨æ ¹ç›®å½•çš„æ–‡ä»¶ (åŸºäºŽ FILE_ORGANIZATION_RULES.md v1.4)
ALLOWED_ROOT_FILES=(
  # é¡¹ç›®å…¥å£/è¯´æ˜Žæ–‡æ¡£
  "README.md" "CLAUDE.md" "IFLOW.md" "AGENTS.md" "GEMINI.md" "LICENSE"
  # Python å·¥å…·é“¾é…ç½®
  "pyproject.toml" "setup.py" "setup.cfg"
  "requirements.txt" "requirements-dev.txt" "requirements-test.txt"
  "pytest.ini" "mypy.ini" "conftest.py" "__init__.py"
  # Node/E2E å·¥å…·é“¾é…ç½®
  "package.json" "package-lock.json"
  "tsconfig.json" "tsconfig.node.json" "tsconfig.app.json"
  "vitest.config.ts" "vitest.config.js"
  "playwright.config.ts"
  # å…¼å®¹å…¥å£ç‚¹ (src/ é‡å¯¼å‡º)
  "core.py" "data_access.py" "monitoring.py" "unified_manager.py"
  # Docker/éƒ¨ç½²é…ç½®
  "docker-compose.yml" "docker-compose.test.yml" "docker-compose.prod.yml"
  "monitoring-stack.yml"
  # å…¶ä»–å·¥å…·
  ".mcp.json" "opencode.json"
)

# Whitelist of allowed root directories (non-hidden)
# å…è®¸çš„é¡¶å±‚ç›®å½• (v1.4: 9ä¸ªæ ¸å¿ƒç›®å½• + å·¥å…·é“¾ç›®å½•)
ALLOWED_ROOT_DIRS=(
  # æ ¸å¿ƒç›®å½• (v1.4 è§„èŒƒ)
  "src"           # æ ¸å¿ƒä¸šåŠ¡ä»£ç 
  "tests"         # æµ‹è¯•æ–‡ä»¶ (ç‹¬ç«‹é¡¶å±‚)
  "scripts"       # è„šæœ¬å·¥å…·
  "docs"          # æ–‡æ¡£
  "architecture"  # æž¶æž„è®¾è®¡æ–‡æ¡£ (ç‹¬ç«‹é¡¶å±‚)
  "config"        # é…ç½®æ–‡ä»¶
  "reports"       # ç”Ÿæˆçš„æŠ¥å‘Š
  "archived"      # å½’æ¡£æ–‡ä»¶
  "data"          # æ•°æ®æ–‡ä»¶
  # å·¥å…·é“¾/æœåŠ¡ç›®å½•
  "web"           # Web å‰åŽç«¯
  "services"      # å¾®æœåŠ¡
  "openspec"      # OpenSpec å˜æ›´ç®¡ç†
  "gpu_api_system"  # GPU API ç³»ç»Ÿ
  ".multi-cli-tasks"  # å¤š CLI åä½œå·¥ä½œç›®å½• (dot-prefix)
  "monitoring-stack"  # ç›‘æŽ§æ ˆ
  # ç¼“å­˜/æž„å»ºç›®å½•
  "node_modules" "__pycache__"
)

ERRORS=0
WARNINGS=0

# ===== è¾…åŠ©å‡½æ•° =====
log_error() {
  echo "âŒ ERROR: $1" >&2
  ERRORS=$((ERRORS + 1))
}

log_warning() {
  echo "âš ï¸  WARNING: $1" >&2
  WARNINGS=$((WARNINGS + 1))
}

# ===== æ£€æŸ¥æ–°æ–‡ä»¶ =====
for file in $(git diff --cached --name-only --diff-filter=A 2>/dev/null); do
  # èŽ·å–ç›®å½•å’Œæ–‡ä»¶å
  dir=$(dirname "$file")
  basename=$(basename "$file")
  top_dir=$(echo "$file" | cut -d'/' -f1)

  # è·³è¿‡éšè—æ–‡ä»¶å’Œç›®å½•
  [[ "$basename" == .* ]] && continue
  [[ "$top_dir" == .* ]] && continue

  # æ£€æŸ¥æ ¹ç›®å½•æ–‡ä»¶
  if [ "$dir" = "." ]; then
    ALLOWED=false
    for allowed in "${ALLOWED_ROOT_FILES[@]}"; do
      if [ "$basename" = "$allowed" ]; then
        ALLOWED=true
        break
      fi
    done

    if [ "$ALLOWED" = false ]; then
      log_error "New root file '$basename' is not in the allowlist."
      echo "   Suggestion: Move it to the appropriate subdirectory:" >&2

      # æ ¹æ®æ–‡ä»¶ç±»åž‹æä¾›å»ºè®® (v1.4 è§„èŒƒ)
      ext="${basename##*.}"
      case "$ext" in
        py)
          if [[ "$basename" =~ ^test_ ]]; then
            echo "   â†’ tests/unit/ (æµ‹è¯•æ–‡ä»¶)" >&2
          elif [[ "$basename" =~ ^(run_|save_|monitor_) ]]; then
            echo "   â†’ scripts/runtime/ (è¿è¡Œæ—¶è„šæœ¬)" >&2
          elif [[ "$basename" =~ ^(check_|verify_|create_) ]]; then
            echo "   â†’ scripts/database/ (æ•°æ®åº“è„šæœ¬)" >&2
          else
            echo "   â†’ scripts/dev/ æˆ– src/" >&2
          fi
          ;;
        md|rst|txt)
          echo "   â†’ docs/guides/ (æˆ– docs/api/, docs/standards/, docs/legacy/)" >&2
          ;;
        yaml|yml|ini|toml)
          echo "   â†’ config/ (é…ç½®æ–‡ä»¶)" >&2
          ;;
        json)
          echo "   â†’ config/ æˆ– reports/ (æ ¹æ®å†…å®¹)" >&2
          ;;
        *)
          echo "   â†’ æ ¹æ® FILE_ORGANIZATION_RULES.md v1.4 é€‰æ‹©åˆé€‚ç›®å½•" >&2
          ;;
      esac
    fi
  fi

  # æ£€æŸ¥æ–°é¡¶å±‚ç›®å½•
  if [ "$top_dir" != "$file" ] && [ "$dir" != "." ]; then
    ALLOWED=false
    for allowed in "${ALLOWED_ROOT_DIRS[@]}"; do
      if [ "$top_dir" = "$allowed" ]; then
        ALLOWED=true
        break
      fi
    done

    if [ "$ALLOWED" = false ]; then
      log_warning "File added under non-standard root directory '$top_dir/'."
      echo "   Standard directories (v1.4): src/, tests/, scripts/, docs/, architecture/, config/, reports/, archived/, data/" >&2
    fi
  fi
done

# ===== æ ¹ç›®å½•ç»Ÿè®¡æ£€æŸ¥ =====
ROOT_FILE_COUNT=$(find . -maxdepth 1 -type f ! -name '.*' 2>/dev/null | wc -l)
ROOT_DIR_COUNT=$(find . -maxdepth 1 -type d ! -name '.' ! -name '.*' 2>/dev/null | wc -l)

if [ "$ROOT_FILE_COUNT" -gt 20 ]; then
  log_warning "Root directory has $ROOT_FILE_COUNT files (threshold: 20)."
  echo "   Consider cleaning up root-level files." >&2
fi

if [ "$ROOT_DIR_COUNT" -gt 15 ]; then
  log_warning "Root directory has $ROOT_DIR_COUNT subdirectories (threshold: 15)."
  echo "   Standard count is ~9 (v1.4: src/tests/scripts/docs/architecture/config/reports/archived/data)" >&2
fi

# ===== ä¸´æ—¶æ–‡ä»¶æ£€æŸ¥ =====
TEMP_PATTERNS=("*.log" "*.tmp" "*.bak" "*.swp" "*~" "*.pyc" "*.pyo")
for pattern in "${TEMP_PATTERNS[@]}"; do
  if git diff --cached --name-only 2>/dev/null | grep -q "$pattern"; then
    log_warning "Temporary file pattern '$pattern' detected in staging."
    echo "   Consider adding to .gitignore instead of committing." >&2
  fi
done

# ===== è¾“å‡ºç»“æžœ =====
if [ "$ERRORS" -gt 0 ]; then
  echo ""
  echo "âŒ Commit blocked: $ERRORS violation(s) found." >&2
  echo "   Use 'git commit --no-verify' to bypass (not recommended)." >&2
  echo ""
  echo "ðŸ“– Reference: docs/standards/FILE_ORGANIZATION_RULES.md" >&2
  exit 1
fi

if [ "$WARNINGS" -gt 0 ]; then
  echo ""
  echo "âš ï¸  Commit allowed with $WARNINGS warning(s)." >&2
  echo "   Please review the warnings above." >&2
fi

exit 0
