# MyStocks 架构优化项目 - 产品需求文档 (PRD)

## 1. 项目概述

**项目名称**: MyStocks 架构优化与重构
**版本**: v2.0
**日期**: 2025-11-08
**优先级**: P0-P1 (高优先级)

### 背景
根据架构分析修订报告,当前系统存在过度工程问题,但同时需要保留关键业务功能:灾备恢复、自动化数据处理、Grafana监控、多数据类型管理。

### 目标
- 代码简化: 从5050行减少到1550行 (69%减少)
- 性能提升: 数据保存延迟降低47% (12-30ms → 6-8ms)
- 成本降低: 年度成本从¥64,000降至¥30,000 (53%削减)
- 保留核心功能: YAML灾备、数据处理、Grafana监控、数据分类

## 2. Phase 1: 优化配置和删除冗余 (1周 - P0)

优化YAML配置为灾备专用:
- 简化table_config.yaml从200行到100行
- 重构ConfigDrivenTableManager为DisasterRecoveryTableManager (750行→300行)
- 保留核心功能: rebuild_all_tables、validate_schema_consistency、export_to_sql_migrations
- 删除auto-migration功能
- 灾备恢复时间目标: 3分钟

删除未使用的去重策略:
- 删除LastOccurrence、Average、Custom策略 (300行)
- 保留FirstOccurrence策略并集成到DataProcessor
- 使用pandas drop_duplicates简化实现

删除复杂告警系统:
- 删除monitoring/alerts.py (500行)
- 移除邮件、Webhook、多渠道告警模块
- 保留Python logging基础日志
- 迁移到Grafana内置告警

## 3. Phase 2: 监控和处理层优化 (2周 - P1)

Week 1 - 监控系统重设计:
创建TimescaleDB监控表:
  - query_performance: 查询性能监控 (timestamp, query_type, table_name, duration_ms, rows_affected)
  - data_quality: 数据质量监控 (timestamp, table_name, completeness_score, freshness_hours, row_count)
  - system_health: 系统健康监控 (timestamp, database_name, connection_status, cpu_usage, memory_usage)

实现GrafanaOptimizedMonitoring类 (300行):
  - log_query(): 记录查询性能
  - log_data_quality(): 记录数据质量指标
  - log_system_health(): 记录系统健康状态
  - get_slow_queries(): 获取慢查询TOP N

删除旧监控系统:
  - 删除monitoring.py (1700行基础设施代码)
  - 备份并删除独立监控数据库

Week 2 - 数据处理层优化:
重构DataProcessor (2000行→400行):
  - 保留核心方法: process、_standardize、_clean、_deduplicate、_validate
  - 删除4种未使用验证器,保留完整性和新鲜度验证
  - 删除复杂配置管理
  - 简化策略模式

集成去重逻辑:
  - FirstOccurrenceStrategy直接集成到_deduplicate
  - 使用pandas drop_duplicates实现

更新测试:
  - 更新tests/test_data_processor.py
  - 确保所有测试通过

## 4. Phase 3: 架构重构为4层 (1周 - P1)

实现DataRouter (100行):
  - save(): 基于classification.is_timeseries自动路由
  - load(): 自动路由加载
  - _save_to_tdengine(): TDengine保存
  - _save_to_postgres(): PostgreSQL保存
  - 配置驱动,基于DataClassification枚举

重构UnifiedManager (500行→200行):
  - 简化调用链: User → UnifiedManager → DataProcessor → DataRouter → Database
  - 删除StorageStrategy中间抽象层 (300行)
  - 保留核心方法: save_data_by_classification、load_data_by_classification、initialize_system

性能目标:
  - 延迟 < 8ms (vs 当前12-30ms)
  - 查询响应 < 50ms
  - 内存占用 < 200MB

## 5. Phase 4: Grafana配置和文档 (3天 - P1)

配置Grafana数据源:
  - 添加PostgreSQL数据源连接mystocks数据库
  - 创建监控只读用户
  - 测试query_performance、data_quality、system_health表查询

创建Grafana仪表盘:
  - Panel 1: 查询性能趋势 (过去24小时平均延迟,告警>100ms)
  - Panel 2: 慢查询TOP 10 (过去7天,告警>1000ms)
  - Panel 3: 数据新鲜度 (各表最新数据时间,告警>24h)
  - Panel 4: 系统健康 (连接状态、CPU、内存,告警规则)

更新文档:
  - README.md: 更新架构说明、性能指标、成本分析
  - CLAUDE.md: 更新文件组织规则、开发命令、架构说明
  - 创建docs/guides/MONITORING.md: Grafana使用指南、监控指标说明、告警配置、故障排查
  - 创建docs/guides/DISASTER_RECOVERY.md: YAML配置说明、灾备恢复流程、表结构验证、常见问题

## 6. 成功标准

技术指标:
  - 代码减少 ≥ 65% (5050行 → ≤1750行)
  - 数据保存延迟 < 8ms
  - 查询响应 < 50ms
  - 灾备恢复时间 < 5分钟
  - 内存占用 < 200MB

业务指标:
  - Grafana仪表盘正常显示所有监控数据
  - 支持快速添加新数据类型 (< 5分钟)
  - 灾备演练成功率 100%
  - 数据质量保持 ≥ 99.9%

质量指标:
  - 所有单元测试通过 (覆盖率 ≥ 80%)
  - 所有集成测试通过
  - 性能基准测试通过
  - 文档完整性检查通过

## 7. 交付物清单

代码交付物:
  - db_manager/disaster_recovery.py (300行)
  - monitoring/grafana_monitoring.py (300行)
  - core/data_processor.py (400行)
  - core/data_router.py (100行)
  - unified_manager.py (重构,200行)
  - table_config.yaml (优化,100行)

配置交付物:
  - TimescaleDB监控表SQL脚本
  - Grafana仪表盘JSON配置
  - Grafana告警规则配置

文档交付物:
  - docs/guides/MONITORING.md
  - docs/guides/DISASTER_RECOVERY.md
  - README.md (更新)
  - CLAUDE.md (更新)

测试交付物:
  - tests/test_disaster_recovery.py
  - tests/test_grafana_monitoring.py
  - tests/test_data_processor.py (更新)
  - tests/test_data_router.py
  - tests/test_integration_4layer.py

预计完成时间: 4周 (Phase 1-4)
项目优先级: P0-P1 (高优先级)
