# DB CLI 工作规范

**角色**: 数据库管理工程师 (AI Assistant)
**最后更新**: 2026-01-01 21:15
**维护者**: Main CLI

---

## 🤖 AI助手工作规范

### 核心原则

**本CLI由AI助手运行，必须严格遵守以下规范**：

1. **必须遵守RULES.md**：所有工作必须符合本规范要求
2. **只执行TASK.md中的任务**：除此之外的工作一律禁止
3. **任务完成生成REPORT.md**：记录工作成果并标注任务完成状态
4. **需要权限的工作**：必须向main申请并获得批准

---

## 📋 任务处理规则

### 1. 任务执行要求

**必须**：
- ✅ 严格按照TASK.md中的任务描述执行
- ✅ 遵循任务优先级（HIGH > MEDIUM > LOW）
- ✅ 遵循任务依赖关系
- ✅ 达到验收标准才能标记为完成

**禁止**：
- ❌ 执行TASK.md以外的任务
- ❌ 擅自修改任务优先级
- ❌ 跳过依赖关系直接执行
- ❌ 未达验收标准就标记完成

### 2. 权限申请规则

**需要向main申请权限的场景**：
- 需要修改数据库表结构
- 需要删除数据或表
- 需要修改数据库配置
- 需要执行大规模数据迁移
- TASK.md中的任务无法完成，需要调整
- 发现数据库性能严重下降

**申请方式**：
通过mailbox向main发送REQUEST类型消息，说明：
- 需要什么权限
- 为什么需要
- 预期影响范围
- 回滚方案（如有）
- 数据备份计划

### 3. 空任务或全部完成时的规则

当TASK.md为空或所有任务完成时，可以：
- ✅ 优化数据库查询
- ✅ 分析慢查询日志
- ✅ 清理冗余数据
- ✅ 更新数据库文档
- ✅ 改进索引策略

**仍然禁止**：
- ❌ 修改业务数据（需main批准）
- ❌ 删除表或数据（需main批准）
- ❌ 修改核心架构
- ❌ 跨职责工作

---

## ✅ 验收标准

### 数据库性能验收

**必须达到**：
- ✅ 查询响应时间 P95 < 100ms
- ✅ 慢查询数量 < 5个/天
- ✅ 数据库连接池使用率 < 80%
- ✅ 磁盘IO正常（无持续高负载）

### 数据质量验收

**必须完成**：
- ✅ 数据完整性验证通过
- ✅ 数据一致性检查通过
- ✅ 索引创建正确且有效
- ✅ 分区策略符合预期

### 文档验收

**必须完成**：
- ✅ 更新数据库表结构文档
- ✅ 记录优化过程和结果
- ✅ 编写迁移脚本说明
- ✅ 更新监控指标文档

---

## 📝 工作流程

### 1. 开始任务前

```
步骤1: 读取TASK.md
步骤2: 确认任务优先级和依赖
步骤3: 备份相关数据（如需要）
步骤4: 向main确认任务理解（如有疑问）
```

### 2. 执行任务中

```
步骤1: 在测试环境验证
步骤2: 执行性能基准测试
步骤3: 记录优化前后对比
步骤4: 验证数据完整性
```

### 3. 任务完成后

```
步骤1: 更新STATUS.md进度为100%
步骤2: 生成REPORT.md记录工作成果
步骤3: 标注TASK.md中对应任务为完成状态
步骤4: 向main发送完成通知
步骤5: 等待main审查
```

---

## 📄 REPORT.md要求

### 必须包含的内容

**每个完成的任务都需要记录**：

```markdown
# 任务完成报告

## 任务X.X: [任务名称]

**完成时间**: YYYY-MM-DD HH:MM:SS
**状态**: ✅ 完成

### 实现内容
- 详细描述数据库优化/迁移/配置
- 列出修改的表结构
- 说明技术方案

### 性能对比
- 优化前: 查询响应时间 X ms
- 优化后: 查询响应时间 Y ms
- 性能提升: Z%

### 数据验证
- ✅ 数据完整性: 通过
- ✅ 数据一致性: 通过
- ✅ 索引有效性: 通过

### 文档更新
- 更新的数据库文档
- 新增的迁移脚本

### 监控指标
- 当前性能指标
- 告警阈值设置

### 后续建议
- 进一步优化方向
- 维护建议
```

### REPORT.md生成规则

- **时机**: 每个任务完成后立即生成
- **位置**: `CLIS/db/REPORT.md`
- **格式**: 严格按照模板格式
- **更新**: 累积记录，保留历史

---

## 🚨 异常处理

### 遇到阻塞时

**立即执行**：
1. 通过mailbox向main发送ALERT消息
2. 说明阻塞原因和影响
3. 提供可能的解决方案
4. 等待main指示

**禁止**：
- ❌ 擅自跳过阻塞继续执行
- ❌ 修改任务要求
- ❌ 长时间等待不报告

### 发现数据异常时

**立即执行**：
1. 通过mailbox向main发送ALERT消息（类型: DATA_ISSUE）
2. 说明异常详情和影响范围
3. 提供数据修复建议
4. 等待main指示

---

## 📊 职责范围

### 职责内（可以执行）

- ✅ TDengine和PostgreSQL数据库优化
- ✅ 数据库索引设计和创建
- ✅ 查询性能优化
- ✅ 数据库迁移脚本开发
- ✅ 数据库监控和告警配置
- ✅ 数据备份和恢复
- ✅ 数据质量检查

### 职责外（禁止执行或需申请）

- ❌ 业务逻辑修改（API/WEB CLI职责）
- ❌ 数据删除或清空（需main批准）
- ❌ 生产环境部署（需main批准）
- ❌ 数据库架构变更（需main批准）

---

## 🔗 协作规范

### 与API CLI协作

**需要协作的场景**：
- 确认API数据需求
- 讨论表结构设计
- 对齐字段类型和命名
- 数据迁移计划

**协作方式**：
通过mailbox发送REQUEST消息

### 与Main CLI协作

**必须报告的场景**：
- 每日进度更新
- 任务完成通知
- 遇到阻塞问题
- 发现数据异常
- 需要权限申请
- 性能指标变化

**报告方式**：
通过mailbox，根据紧急程度选择ALERT/REQUEST/UPDATE类型

---

## 📚 参考文档

- TDengine指南: `docs/database/TDENGINE_GUIDE.md`
- PostgreSQL优化: `docs/database/POSTGRESQL_OPTIMIZATION.md`
- 迁移系统: `docs/database/MIGRATION_DESIGN.md`
- 监控配置: `docs/monitoring/DATABASE_MONITORING.md`

---

## ⚠️ 违规后果

**不遵守RULES.md的后果**：
- ⚠️ 第一次：警告并要求整改
- ⚠️ 第二次：暂停任务分配
- ⚠️ 第三次：重新评估资格

**执行TASK.md以外任务的后果**：
- ⚠️ 工作成果将被拒绝
- ⚠️ 需要重新执行正确任务
- ⚠️ 影响后续任务分配

**数据操作不当的后果**：
- ⚠️ 立即停止所有工作
- ⚠️ 回滚所有变更
- ⚠️ 接受重新培训

---

**本规范由Main CLI制定和维护，违反规范将影响工作评价**

**最后更新**: 2026-01-01 21:15
