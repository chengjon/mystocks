# 安全检查预提交钩子配置
# 在每次提交前自动运行安全检查
#
# 核心原则：智能触发 + 避免冗余扫描
#   ✅ 使用 files 过滤只检查相关文件
#   ✅ pass_filenames: false 仅用于全局扫描器
#   ❌ 避免所有 hooks 都使用 always_run: true
#
# Git Hooks 官方规范：
#   1. pass_filenames: false → hook 不接收文件列表（扫描整个项目）
#   2. files: pattern → 只对匹配的文件运行 hook
#   3. 两者不应同时使用（会导致 pre-commit 无法判断何时运行）

repos:
  # ============================================================================
  # 全局安全扫描器（扫描整个项目，不依赖文件列表）
  # ============================================================================
  - repo: local
    hooks:
      # Bandit 安全扫描（扫描所有 Python 代码）
      - id: security-scan-bandit
        name: Bandit security scan
        entry: bash -c 'bandit -r src/ web/backend/ -f json -o bandit-report.json -q || true'
        language: system
        pass_filenames: false  # ✅ 不接收文件列表，扫描整个目录
        # ✅ 不设置 files（每次提交都运行）

      # Safety 依赖安全检查（扫描所有依赖）
      - id: safety-check
        name: Safety dependency check
        entry: bash -c 'safety check --json --quiet || true'
        language: system
        pass_filenames: false  # ✅ 不接收文件列表，扫描所有依赖
        files: ^(requirements\.txt|pyproject\.toml|Pipfile)$  # ✅ 只在依赖文件改变时触发

  # ============================================================================
  # 文件级安全检查器（只对特定文件运行）
  # ============================================================================
  # ⚠️  重要：这些 hooks 使用 files 过滤，接收文件列表
  # ✅ 不设置 pass_filenames: false（使用默认值 true）
  # ✅ 不设置 always_run: true（只在匹配文件时运行）
  # ============================================================================

  # OWASP Top 10 安全测试（只在测试文件改变时运行）
  - repo: local
    hooks:
      - id: owasp-security-tests
        name: OWASP Top 10 security tests
        entry: pytest scripts/tests/test_security_owasp_top10.py -v
        language: system
        files: scripts/tests/test_security_owasp_top10\.py$
        # ✅ 只在测试文件改变时运行
        # ✅ pass_filenames 默认为 true，传递文件列表

      # 认证安全测试（只在测试文件改变时运行）
      - id: auth-security-tests
        name: Authentication security tests
        entry: pytest scripts/tests/test_security_authentication.py -v
        language: system
        files: scripts/tests/test_security_authentication\.py$
        # ✅ 只在测试文件改变时运行

      # XSS 防护检查（只检查前端文件）
      - id: xss-prevention-check
        name: XSS prevention check
        entry: python scripts/dev/check_xss_prevention.py
        language: system
        files: web/frontend/src/.*\.(ts|js|vue)$
        # ✅ 只检查前端文件

  # ============================================================================
  # 第三方安全工具集成
  # ============================================================================
  # ⚠️  注意：这些工具已经在主 .pre-commit-config.yaml 中配置
  # 这里只保留特殊的安全相关配置
  # ============================================================================

  # Bandit（使用项目特定的安全配置）
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.8
    hooks:
      - id: bandit
        name: Bandit security scan
        args: ['-c', 'config/.security.yml', '-ll']
        files: ^(src/|web/backend/)
        exclude: ^(tests/|test_|.*_test\.py)
        # ✅ 只检查源码文件
        # ✅ 排除测试文件（避免误报）

# ============================================================================
# 容器安全检查（可选）
# ============================================================================
# ⚠️  注意：这些工具只在项目中使用 Docker/Kubernetes 时启用
# ============================================================================

# Docker 安全检查（如果项目使用 Docker）
# - repo: https://github.com/docker/docker-bench-security
#   rev: main
#   hooks:
#     - id: docker-bench-security
#       name: Docker security benchmark
#       files: Dockerfile$

# Kubernetes 安全检查（如果项目使用 Kubernetes）
# - repo: https://github.com/aquasecurity/kube-bench
#   rev: v0.6.4
#   hooks:
#     - id: kube-bench
#       name: Kubernetes security benchmark
#       files: k8s/

# ============================================================================
# CI 配置
# ============================================================================
ci:
  autofix_prs: false           # 不自动创建 PR 修复问题
  autoupdate_schedule: monthly  # 每月自动更新 hooks
  skip:
    # CI 环境中可以跳过的 hooks（可选）
    - python-safety-dependencies-check  # 依赖检查可以只在本地运行
