# 安全检查预提交钩子配置
# 在每次提交前自动运行安全检查

repos:
  # 本地安全检查 - 基于项目标准
  - repo: local
    hooks:
      # 安全代码扫描
      - id: security-scan-bandit
        name: Bandit security scan
        entry: bandit
        language: python
        files: \.py$
        args: [-r, -f, json, -o, bandit-report.json, -q]
        pass_filenames: false
        always_run: true

      # 依赖安全检查
      - id: safety-check
        name: Safety dependency check
        entry: safety
        language: python
        args: [check, --json, --quiet]
        pass_filenames: false
        always_run: true

      # OWASP Top 10 安全测试
      - id: owasp-security-tests
        name: OWASP Top 10 security tests
        entry: python
        language: python
        additional_dependencies: [pytest, requests, pytest-mock]
        files: scripts/tests/test_security_owasp_top10\.py$
        pass_filenames: false
        always_run: true

      # 认证安全测试
      - id: auth-security-tests
        name: Authentication security tests
        entry: python
        language: python
        additional_dependencies: [pytest, requests, pytest-mock]
        files: scripts/tests/test_security_authentication\.py$
        pass_filenames: false
        always_run: true

      # 密码策略检查
      - id: password-policy-check
        name: Password policy validation
        entry: python
        language: python
        files: src/.*\.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_password_policy.py]

      # SQL注入检查
      - id: sql-injection-check
        name: SQL injection prevention check
        entry: python
        language: python
        files: src/.*\.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_sql_injection.py]

      # XSS防护检查
      - id: xss-prevention-check
        name: XSS prevention check
        entry: python
        language: python
        files: web/frontend/src/.*\.(ts|js|vue)$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_xss_prevention.py]

      # 硬编码密钥检查
      - id: hardcoded-secret-check
        name: Hardcoded secret detection
        entry: python
        language: python
        files: \.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_hardcoded_secrets.py]

      # 文件上传安全检查
      - id: file-upload-security
        name: File upload security check
        entry: python
        language: python
        files: src/.*\.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_file_upload_security.py]

      # 会话管理安全检查
      - id: session-security-check
        name: Session management security check
        entry: python
        language: python
        files: src/.*\.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_session_security.py]

      # CSRF保护检查
      - id: csrf-protection-check
        name: CSRF protection check
        entry: python
        language: python
        files: src/.*\.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_csrf_protection.py]

      # 权限验证检查
      - id: authorization-check
        name: Authorization and access control check
        entry: python
        language: python
        files: src/.*\.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_authorization.py]

      # 输入验证检查
      - id: input-validation-check
        name: Input validation check
        entry: python
        language: python
        files: src/.*\.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_input_validation.py]

      # 错误处理安全检查
      - id: error-handling-security
        name: Error handling security check
        entry: python
        language: python
        files: src/.*\.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_error_handling_security.py]

      # 日志安全检查
      - id: logging-security-check
        name: Logging security check
        entry: python
        language: python
        files: src/.*\.py$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_logging_security.py]

      # 配置安全检查
      - id: configuration-security-check
        name: Configuration security check
        entry: python
        language: python
        files: \.(yaml|yml|ini|toml|env)$
        pass_filenames: false
        always_run: true
        args: [scripts/dev/check_configuration_security.py]

  # 第三方安全工具
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        name: Bandit security scan
        args: [-r, -f, json, -o, bandit-report.json, -q]

  - repo: https://github.com/pycqa/pylint
    rev: v3.0.0a6
    hooks:
      - id: pylint
        name: Pylint security check
        args: [--rcfile=.pylintrc, -d, import-error, --output-format=json]

  - repo: https://github.com/PyCQA/flake8
    rev: 6.0.0
    hooks:
      - id: flake8
        name: Flake8 with security checks
        additional_dependencies: [flake8-bandit, flake8-docstrings]

  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
        name: Black code formatter (security-aware)
        args: [--check, --diff, --line-length=88]

  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort
        name: Import sorter (security imports first)
        args: [--check-only, --profile, black]

  - repo: https://github.com/anchore/grype
    rev: v0.72.0
    hooks:
      - id: grype
        name: Grype vulnerability scanner
        files: requirements.txt

  - repo: https://github.com/rustsec/rustcovenant
    rev: main
    hooks:
      - id: rust-covenant-check
        name: Rust security covenant check

  # Docker安全检查
  - repo: https://github.com/docker/docker-bench-security
    rev: main
    hooks:
      - id: docker-bench-security
        name: Docker security benchmark
        files: Dockerfile$

  # Kubernetes安全检查
  - repo: https://github.com/aquasecurity/kube-bench
    rev: v0.6.4
    hooks:
      - id: kube-bench
        name: Kubernetes security benchmark
        files: k8s/

# 排除的文件和目录
exclude: >
  (?x)^(
    \.git/
    | \.pytest_cache/
    | __pycache__/
    | *.py[co]
    | \.mypy_cache/
    | \.tox/
    | venv/
    | env/
    | \.venv/
    | node_modules/
    | \.next/
    | \.nuxt/
    | dist/
    | build/
    | coverage/
    | \.coverage
    | \.hypothesis/
    | \.DS_Store
    | \.idea/
    | \.vscode/
    | \*.swp
    | \*.swo
    | \*~
    | migrations/
    | logs/
    | tmp/
    | temp/
  )$

# 默认语言
default_language_version:
  python: python3.12

# 最少安装的依赖
minimum_pre_commit_version: 3.2.0

# 在合并前运行
fail_fast: true

# 传递给所有钩子的环境变量
default_stages: [commit, push]

# 安全钩子的特殊配置
ci:
  autofix_commit_msg: |
    style(pre-commit-ci): auto fixes from pre-commit.com hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: []
  submodules: false