# MyStocks ç›‘æ§æ ˆéƒ¨ç½²æŒ‡å—

æœ¬ç›‘æ§æ ˆç”¨äºå±•ç¤º Phase 2.4 å®ç°çš„å¥åº·æ£€æŸ¥å’Œæ€§èƒ½æŒ‡æ ‡ã€‚

## ğŸ“Š ç›‘æ§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Grafana (3000)                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚              â”‚   MyStocks Dashboards     â”‚               â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Prometheus (9090)                          â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚   Pull /metrics endpoint    â”‚                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MyStocks FastAPI (8000)                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  /api/metrics     - Prometheus æŒ‡æ ‡å¯¼å‡º              â”‚   â”‚
â”‚   â”‚  /api/system/health    - ç³»ç»Ÿå¥åº·æ£€æŸ¥              â”‚   â”‚
â”‚   â”‚  /api/monitoring/health - ç›‘æ§æœåŠ¡å¥åº·æ£€æŸ¥         â”‚   â”‚
â”‚   â”‚  /api/trade/health       - äº¤æ˜“æœåŠ¡å¥åº·æ£€æŸ¥         â”‚   â”‚
â”‚   â”‚  /api/*/health           - å„ç»„ä»¶å¥åº·æ£€æŸ¥            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### å‰ç½®è¦æ±‚
- Docker å’Œ Docker Compose å·²å®‰è£…
- MyStocks FastAPI åç«¯è¿è¡Œåœ¨ `http://localhost:8000`

### å¯åŠ¨ç›‘æ§æ ˆ

```bash
cd /opt/claude/mystocks_spec/monitoring-stack

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p data/{prometheus,grafana,alertmanager}

# å¯åŠ¨æœåŠ¡
docker-compose up -d
```

### è®¿é—®åœ°å€

| æœåŠ¡ | åœ°å€ | å‡­å‡­ |
|------|------|------|
| Grafana | http://localhost:3000 | admin/admin |
| Prometheus | http://localhost:9090 | - |
| AlertManager | http://localhost:9093 | - |

## ğŸ“ˆ å¯ç”¨æŒ‡æ ‡

### ç³»ç»ŸæŒ‡æ ‡
- `mystocks_http_requests_total` - HTTP è¯·æ±‚æ€»æ•°
- `mystocks_http_request_duration_seconds` - è¯·æ±‚å»¶è¿Ÿ
- `mystocks_process_cpu_usage_percentage` - CPU ä½¿ç”¨ç‡
- `mystocks_process_memory_usage_bytes` - å†…å­˜ä½¿ç”¨é‡

### æ•°æ®åº“æŒ‡æ ‡
- `mystocks_db_connections_active` - æ´»è·ƒè¿æ¥æ•°
- `mystocks_db_connections_idle` - ç©ºé—²è¿æ¥æ•°
- `mystocks_db_query_duration_seconds` - æŸ¥è¯¢å»¶è¿Ÿ
- `mystocks_db_slow_queries_total` - æ…¢æŸ¥è¯¢è®¡æ•°

### ç¼“å­˜æŒ‡æ ‡
- `mystocks_cache_hits_total` - ç¼“å­˜å‘½ä¸­æ•°
- `mystocks_cache_misses_total` - ç¼“å­˜æœªå‘½ä¸­æ•°
- `mystocks_cache_hit_rate` - ç¼“å­˜å‘½ä¸­ç‡
- `mystocks_cache_memory_usage_bytes` - ç¼“å­˜å†…å­˜ä½¿ç”¨

### ä¸šåŠ¡æŒ‡æ ‡
- `mystocks_market_data_points_processed` - å¸‚åœºæ•°æ®å¤„ç†é‡
- `mystocks_trade_orders_total` - äº¤æ˜“è®¢å•æ•°
- `mystocks_user_active_sessions` - æ´»è·ƒç”¨æˆ·ä¼šè¯
- `mystocks_alerts_active` - æ´»è·ƒå‘Šè­¦æ•°

### å¥åº·çŠ¶æ€æŒ‡æ ‡
- `mystocks_health_status` - ç»„ä»¶å¥åº·çŠ¶æ€ (1=å¥åº·, 0=ä¸å¥åº·)
- `mystocks_dependency_availability` - æ•°æ®æºå¯ç”¨æ€§ (%)

## ğŸ”§ é…ç½®è¯´æ˜

### Prometheus æŠ“å–é…ç½®

Prometheus æ¯ 15 ç§’æŠ“å–ä¸€æ¬¡æŒ‡æ ‡ï¼Œé…ç½®æ–‡ä»¶ä½äº `config/prometheus.yml`ï¼š

```yaml
scrape_configs:
  - job_name: 'mystocks-backend'
    static_configs:
      - targets: ['host.docker.internal:8000']
    metrics_path: '/api/metrics'
```

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

| ç«¯ç‚¹ | ç»„ä»¶ | å¥åº·çŠ¶æ€ |
|------|------|----------|
| `/api/system/health` | ç³»ç»Ÿæ ¸å¿ƒ | âœ… |
| `/api/monitoring/health` | ç›‘æ§æœåŠ¡ | âœ… |
| `/api/trade/health` | äº¤æ˜“æœåŠ¡ | âœ… |
| `/api/technical/health` | æŠ€æœ¯åˆ†æ | âœ… |
| `/api/announcement/health` | å…¬å‘Šç›‘æ§ | âœ… |
| `/api/multi_source/health` | å¤šæ•°æ®æº | âœ… |
| `/api/market/health` | å¸‚åœºæ•°æ® | âœ… |
| `/api/wencai/health` | é—®è´¢API | âœ… |
| `/api/tasks/health` | ä»»åŠ¡ç®¡ç† | âœ… |
| `/metrics/health` | Prometheuså¯¼å‡ºå™¨ | âœ… |

## ğŸ“Š ä»ªè¡¨æ¿è¯´æ˜

### 1. MyStocks ç³»ç»Ÿç›‘æ§æ¦‚è§ˆ

å±•ç¤ºç³»ç»Ÿçš„æ•´ä½“è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬ï¼š
- åç«¯æœåŠ¡å¥åº·çŠ¶æ€
- API è¯·æ±‚é€Ÿç‡å’Œå“åº”å»¶è¿Ÿ
- å†…å­˜å’Œ CPU ä½¿ç”¨æƒ…å†µ
- æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
- WebSocket è¿æ¥æ•°
- ç¼“å­˜å‘½ä¸­ç‡

### 2. MyStocks å¥åº·çŠ¶æ€ä»ªè¡¨æ¿

ä¸“æ³¨äºå¥åº·çŠ¶æ€ç›‘æ§ï¼š
- æ ¸å¿ƒæœåŠ¡å¥åº·çŠ¶æ€ï¼ˆåç«¯ã€APIã€æ•°æ®åº“ï¼‰
- ä¸šåŠ¡æ¨¡å—å¥åº·çŠ¶æ€
- æ•°æ®æºå¯ç”¨æ€§
- æ•°æ®å®Œæ•´æ€§æŒ‡æ ‡

## ğŸ”„ æ›´æ–°ä»ªè¡¨æ¿

### æ‰‹åŠ¨å¯¼å…¥ä»ªè¡¨æ¿

1. ç™»å½• Grafana
2. ç‚¹å‡» "+" â†’ "Import"
3. ä¸Šä¼  JSON æ–‡ä»¶æˆ–ç²˜è´´ä»ªè¡¨æ¿ ID

### è‡ªåŠ¨åŠ è½½ä»ªè¡¨æ¿

ä»ªè¡¨æ¿å·²é…ç½®ä¸ºè‡ªåŠ¨åŠ è½½ï¼Œä½äº `provisioning/dashboards/` ç›®å½•ã€‚

## ğŸ›‘ åœæ­¢ç›‘æ§æ ˆ

```bash
docker-compose down

# ä¿ç•™æ•°æ®
# docker-compose down

# æ¸…é™¤æ•°æ®ï¼ˆæ…ç”¨ï¼‰
# docker-compose down -v
```

## ğŸ” æ•…éšœæ’æŸ¥

### Prometheus æ— æ³•æŠ“å–æŒ‡æ ‡

1. æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œï¼š`curl http://localhost:8000/api/metrics`
2. æ£€æŸ¥ Docker ç½‘ç»œè¿æ¥ï¼š`docker logs mystocks-prometheus`
3. å¯¹äº Docker Desktopï¼Œä½¿ç”¨ `host.docker.internal`
4. å¯¹äº Linuxï¼Œä½¿ç”¨ `172.17.0.1` æˆ–å®¿ä¸»æœº IP

### Grafana æ— æ³•è¿æ¥ Prometheus

1. æ£€æŸ¥ Prometheus æ˜¯å¦è¿è¡Œï¼š`curl http://localhost:9090/-/healthy`
2. æ£€æŸ¥ Grafana æ•°æ®æºé…ç½®

## ğŸ“ å‘Šè­¦é…ç½®ï¼ˆå¯é€‰ï¼‰

ç¼–è¾‘ `config/alertmanager.yml` é…ç½®é‚®ä»¶æˆ– Webhook å‘Šè­¦ï¼š

```yaml
receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://host.docker.internal:8000/api/alerts/webhook'
```

## ğŸ”— ç›¸å…³é“¾æ¥

- [Prometheus æ–‡æ¡£](https://prometheus.io/docs/)
- [Grafana æ–‡æ¡£](https://grafana.com/docs/)
- [Phase 2.4 å®ç°æ–‡æ¡£](../docs/)
