# Pre-commit configuration for MyStocks project
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files
#
# 核心策略：Black 强制格式化 + Ruff 补充修复（避免格式冲突）
# 执行顺序：Black (format) → Ruff (selective fix) → Ruff (final check) → MyPy → Bandit → Safety
#
# 关键避坑点：
#   ⚠️  Ruff 不使用 --fix 做完整格式化（避免与 Black 冲突）
#   ✅   Black 负责所有格式化工作（punctual formatter）
#   ✅   Ruff 仅做 lint 检查和轻量级修复（如未使用的导入）
#   ✅   顺序：Black 先行 → Ruff 补充（避免 Ruff 格式被 Black 覆盖）

repos:
  # ============================================================================
  # 第一步：Black 强制格式化（解决所有格式问题）
  # ============================================================================
  # Black 的优势：
  #   - 非常固执的格式化规则（团队统一风格保证）
  #   - 完全不可配置的格式（避免格式战争）
  #   - 处理所有格式问题（缩进、空格、换行等）
  # ============================================================================
  - repo: https://github.com/psf/black
    rev: 24.8.0
    hooks:
      - id: black
        name: Black (Formatter)
        files: ^(src/|tests/|web/backend/)
        # 统一行长度为 120 字符
        args: [--line-length=120]

  # ============================================================================
  # 第二步：Ruff 补充修复（只修复 lint 问题，不做格式化）
  # ============================================================================
  # Ruff 的优势：
  #   - 快速的 linter（比 Flake8 快 30-100x）
  #   - 可配置的规则（选择性修复）
  #   - 轻量级修复（未使用的导入、简单的语法问题）
  #
  # 避坑点：
  #   ❌ 不使用 ruff format（避免与 Black 冲突）
  #   ❌ 不使用 --fix 无差别修复（可能回退 Black 的格式）
  #   ✅ 使用 --select 选择性修复（只修复特定问题）
  # ============================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.9.10
    hooks:
      - id: ruff
        name: Ruff (Selective Fix)
        files: ^(src/|tests/|web/backend/)
        # ⚠️  关键：只修复未使用的导入和变量，避免格式冲突
        # F401: unused-import (未使用的导入)
        # F841: unused-variable (未使用的变量)
        args: [--select, F401,F841, --fix]

  # ============================================================================
  # 第三步：Ruff 最终检查（确保没有遗漏的 lint 问题）
  # ============================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.9.10
    hooks:
      - id: ruff
        name: Ruff (Final Check)
        files: ^(src/|tests/|web/backend/)
        # ✅ 只检查，不修复（避免在最终阶段修改代码）
        args: [--no-fix]

  # ============================================================================
  # 第四步：类型检查
  # ============================================================================
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.11.2
    hooks:
      - id: mypy
        name: MyPy (Type Check)
        args: ['--ignore-missing-imports', '--no-error-summary']
        files: ^(src/|tests/|web/backend/)
        additional_dependencies:
          - types-requests
          - types-PyYAML

  # ============================================================================
  # 第五步：安全扫描
  # ============================================================================
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.8
    hooks:
      - id: bandit
        name: Bandit (Security Scan)
        args: ['-c', 'config/.security.yml', '-ll']
        files: ^(src/|web/backend/)
        exclude: ^(tests/|test_|.*_test\.py)

  # ============================================================================
  # 第六步：依赖安全检查
  # ============================================================================
  - repo: https://github.com/Lucas-C/pre-commit-hooks-safety
    rev: v1.3.3
    hooks:
      - id: python-safety-dependencies-check
        name: Safety (Dependency Check)
        files: ^(requirements\.txt|pyproject\.toml|Pipfile)$

  # ============================================================================
  # 第七步：通用文件检查
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: trailing-whitespace
        name: Trailing Whitespace
        exclude: ^(temp/|.archive/)
      - id: end-of-file-fixer
        name: End of File Fixer
        exclude: ^(temp/|.archive/)
      - id: check-yaml
        name: Check YAML
        exclude: ^(temp/|.archive/)
      - id: check-json
        name: Check JSON
        exclude: ^(temp/|.archive/)
      - id: check-added-large-files
        name: Check Large Files
        args: ['--maxkb=1000']
      - id: detect-private-key
        name: Detect Private Key
        exclude: ^(\.env\.example|docs/guides/|CLAUDE\.md|scripts/)
      - id: check-merge-conflict
        name: Check Merge Conflict

  # ============================================================================
  # 第八步：密钥检测
  # ============================================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        name: Detect Secrets
        exclude: ^(\.env\.example|docs/guides/|CLAUDE\.md|\.archive/|web/backend/app/core/config\.py)

  # ============================================================================
  # 第九步：Python 语法检查
  # ============================================================================
  - repo: https://github.com/pre-commit/pygrep-hooks
    rev: v1.10.0
    hooks:
      - id: python-check-blanket-noqa
        name: Check Blanket NOQA
      - id: python-check-blanket-type-ignore
        name: Check Blanket Type Ignore
      - id: python-no-eval
        name: No Eval
        exclude: ^(web/backend/app/api/tasks\.py)
      - id: python-no-log-warn
        name: No Log Warn

# ============================================================================
# CI 配置
# ============================================================================
ci:
  autofix_prs: false          # 不自动创建 PR 修复问题
  autoupdate_schedule: monthly  # 每月自动更新 hooks
  skip:
    # CI 环境中可以跳过的 hooks（可选）
    - python-safety-dependencies-check  # 依赖检查可以只在本地运行
