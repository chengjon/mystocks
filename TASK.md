# Backend CLI 任务文档

**Worker CLI**: Backend CLI (API契约开发工程师)
**Branch**: phase7-backend-api-contracts
**Worktree**: /opt/claude/mystocks_phase7_backend
**预计工作量**: 48小时（6周 × 8小时/周）
**完成标准**: 209个API契约标准化完成，115个已注册（P0+P1）

---

## 🎯 核心职责

作为Backend CLI，你的核心职责是完成**209个API端点**的契约标准化、测试覆盖和后端实现。这是整个Phase 7项目的基础工作，将直接支持Test CLI的契约测试和Frontend CLI的Web集成。

**关键目标**:
- ✅ 扫描并记录所有209个API端点
- ✅ 创建标准化的API契约（YAML格式）
- ✅ 注册115个高优先级API（P0+P1）
- ✅ 实现30个P0优先级API端点
- ✅ PM2服务管理（启动、监控、重启）

---

## 📋 任务清单

### 阶段1: API目录扫描与契约模板（Week 1-2, 16小时）

#### T1.1: API端点扫描与目录生成（8小时）

**目标**: 扫描所有209个API端点，生成完整的API目录

**实施步骤**:
1. 扫描FastAPI路由：`web/backend/app/api/`
2. 提取API信息：路径、方法、参数、响应
3. 生成catalog.yaml：结构化API清单
4. 生成catalog.md：人类可读的API文档

**验收标准**:
- [ ] catalog.yaml包含209个API完整信息
- [ ] catalog.md格式清晰，易于查阅
- [ ] 按模块分类（market, strategy, trading等）
- [ ] 标注优先级（P0/P1/P2）

**预计完成**: Week 1结束

#### T1.2: API契约模板创建（8小时）

**目标**: 为209个API创建标准化契约模板

**实施步骤**:
1. 定义契约模板结构（参考IMPLEMENTATION_GUIDE.md）
2. 批量生成契约YAML文件
3. 定义核心字段：api_id, module, path, method, request_params, response_code, response_data
4. 验证模板完整性

**验收标准**:
- [ ] 209个契约模板全部创建
- [ ] 模板符合OpenAPI规范
- [ ] 核心字段100%覆盖
- [ ] 通过契约验证测试

**预计完成**: Week 2结束

---

### 阶段2: 契约标准化与注册（Week 3-5, 24小时）

#### T2.1: 115个高优先级API契约标准化（16小时）

**目标**: 完成P0（30个）和P1（25个）API的详细契约

**实施步骤**:
1. P0 API详细契约：market, strategy, trading模块
2. P1 API详细契约：backtest, risk, user模块
3. 定义请求/响应数据结构
4. 添加错误码定义
5. 集成到契约管理系统

**验收标准**:
- [ ] 30个P0 API契约完成
- [ ] 85个P1 API契约完成
- [ ] 所有契约通过验证
- [ ] 契约管理系统注册成功

**预计完成**: Week 4结束

#### T2.2: PM2服务管理配置（8小时）

**目标**: 配置PM2生态系统，管理API服务

**实施步骤**:
1. 创建ecosystem.config.js
2. 配置进程监控、日志、自动重启
3. 测试PM2服务启动/停止/重启
4. 配置日志收集和轮转

**验收标准**:
- [ ] PM2服务稳定运行
- [ ] 自动重启机制工作正常
- [ ] 日志完整收集
- [ ] 监控指标正常

**预计完成**: Week 5结束

---

### 阶段3: P0 API实现（Week 6-9, 32小时）

#### T3.1: 30个P0 API端点实现（32小时）

**目标**: 实现核心业务API端点

**实施步骤**:
1. Market API（10个）：行情数据、实时报价、K线数据
2. Strategy API（10个）：策略管理、回测、信号
3. Trading API（10个）：交易委托、账户查询、持仓管理

**每个API实现包含**:
- FastAPI路由定义
- Pydantic数据模型
- 业务逻辑实现
- 错误处理
- 单元测试

**验收标准**:
- [ ] 30个P0 API全部实现
- [ ] 功能测试通过率100%
- [ ] 代码质量：Pylint 8.5+/10
- [ ] API响应时间<200ms（P95）

**预计完成**: Week 9结束

---

### 阶段4: 剩余API注册与文档完善（Week 10-12, 16小时）

#### T4.1: 94个P2 API契约注册（8小时）

**目标**: 完成剩余低优先级API的契约注册

**实施步骤**:
1. Indicators API（35个）：技术指标计算
2. Announcement API（29个）：公告信息
3. System API（30个）：配置、监控

**验收标准**:
- [ ] 94个P2 API契约完成
- [ ] 总计209个API契约100%覆盖
- [ ] 所有契约通过验证

**预计完成**: Week 11结束

#### T4.2: API文档完善与部署准备（8小时）

**目标**: 完善API文档，准备生产部署

**实施步骤**:
1. 更新OpenAPI/Swagger文档
2. 编写API使用指南
3. 性能测试和优化
4. 部署脚本准备

**验收标准**:
- [ ] Swagger UI完整可用
- [ ] API文档清晰准确
- [ ] 性能指标达标
- [ ] 部署脚本测试通过

**预计完成**: Week 12结束

---

## 📊 进度跟踪

**当前状态**: 🔄 待开始
**完成任务**: 0/4 阶段 (0%)
**总体进度**: 0/48 小时 (0%)

**更新日志**:
- 2025-12-30: 任务初始化

---

## 🛠️ 工具链

**必需工具**:
- PM2 (进程管理)
- FastAPI (API框架)
- Pydantic (数据验证)
- Python 3.12+

**配置文件**:
- `web/backend/ecosystem.config.js` - PM2配置
- `web/backend/docs/api/catalog.yaml` - API目录
- `contracts/` - 契约文件目录

---

## 📈 质量标准

**代码质量**:
- Pylint评级: 8.5+/10
- 单元测试覆盖率: >80%
- API响应时间: <200ms (P95)

**文档质量**:
- API文档完整性: 100%
- 契约规范性: 100%
- 代码注释率: >60%

---

## 🚧 问题报告机制

**问题级别**:
- 🟢 信息级（代码风格、文档补充）: 4h内处理
- 🟡 警告级（依赖冲突、测试偶尔失败）: 1h内处理
- 🔴 阻塞级（服务启动失败、契约冲突）: 15min内处理

**报告格式**:
```markdown
## 阻塞问题报告

**时间**: YYYY-MM-DD HH:MM
**级别**: 🔴 阻塞级
**问题**: [清晰描述]

### 已尝试
1. 尝试1: [结果]
2. 尝试2: [结果]

### 请求协助
[需要主CLI提供什么]
```

---

## 📝 备注

**关键原则**:
- ✅ **独立执行**: 按照TASK.md自主完成任务
- ✅ **主动报告**: 每2小时更新TASK-REPORT.md
- ✅ **质量优先**: 不通过质量检查不进入下一阶段
- ✅ **及时沟通**: 遇到阻塞立即报告

**权限范围**:
- ✅ `web/backend/` - 完全控制
- ✅ `config/data_sources.json` - 修改数据源配置
- ⚠️ `web/frontend/` - 只读（了解接口定义）
- ⚠️ `docs/api/` - 协调修改（需要Main CLI批准）

---

**文档版本**: v2.0
**创建时间**: 2025-12-30
**创建者**: Main CLI (Manager)
**参考**: [Phase 7提案](../docs/reports/phase7_worktree_collaboration_proposal.md)
