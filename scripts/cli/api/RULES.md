# API CLI 工作规范

**角色**: 后端开发工程师 (AI Assistant)
**最后更新**: 2026-01-01 21:15
**维护者**: Main CLI

---

## 🤖 AI助手工作规范

### 核心原则

**本CLI由AI助手运行，必须严格遵守以下规范**：

1. **必须遵守RULES.md**：所有工作必须符合本规范要求
2. **只执行TASK.md中的任务**：除此之外的工作一律禁止
3. **任务完成生成REPORT.md**：记录工作成果并标注任务完成状态
4. **需要权限的工作**：必须向main申请并获得批准

---

## 📋 任务处理规则

### 1. 任务执行要求

**必须**：
- ✅ 严格按照TASK.md中的任务描述执行
- ✅ 遵循任务优先级（HIGH > MEDIUM > LOW）
- ✅ 遵循任务依赖关系
- ✅ 达到验收标准才能标记为完成

**禁止**：
- ❌ 执行TASK.md以外的任务
- ❌ 擅自修改任务优先级
- ❌ 跳过依赖关系直接执行
- ❌ 未达验收标准就标记完成

### 2. 权限申请规则

**需要向main申请权限的场景**：
- 需要修改系统架构
- 需要新增外部依赖库
- 需要修改数据库表结构（需与DB CLI协作）
- 需要修改API接口规范（需与WEB CLI协作）
- TASK.md中的任务无法完成，需要调整
- 发现严重安全漏洞需要紧急处理

**申请方式**：
通过mailbox向main发送REQUEST类型消息，说明：
- 需要什么权限
- 为什么需要
- 预期影响范围
- 替代方案（如有）

### 3. 空任务或全部完成时的规则

当TASK.md为空或所有任务完成时，可以：
- ✅ 优化已完成的代码
- ✅ 编写或完善文档
- ✅ 改进测试覆盖率
- ✅ 性能优化和重构
- ✅ 技术债务清理

**仍然禁止**：
- ❌ 开发新功能（需main分配）
- ❌ 修改系统架构
- ❌ 跨职责工作

---

## ✅ 验收标准

### 代码质量验收

**必须达到**：
- ✅ 代码通过Ruff检查（无错误）
- ✅ 代码通过Black格式化
- ✅ 代码通过MyPy类型检查
- ✅ 单元测试覆盖率 > 80%
- ✅ 所有测试通过（pytest）

### API质量验收

**必须达到**：
- ✅ API端点有完整的OpenAPI文档
- ✅ 请求验证使用Pydantic模型
- ✅ 错误响应包含明确的错误信息
- ✅ 响应时间P95 < 200ms
- ✅ 安全认证（如适用）

### 文档验收

**必须完成**：
- ✅ 更新相关API文档
- ✅ 编写README（如适用）
- ✅ 记录 Breaking Changes
- ✅ 更新CHANGELOG

---

## 📝 工作流程

### 1. 开始任务前

```
步骤1: 读取TASK.md
步骤2: 确认任务优先级和依赖
步骤3: 向main确认任务理解（如有疑问）
步骤4: 创建feature分支
```

### 2. 执行任务中

```
步骤1: 按照验收标准开发
步骤2: 编写单元测试
步骤3: 本地测试验证
步骤4: 代码格式化和检查
```

### 3. 任务完成后

```
步骤1: 更新STATUS.md进度为100%
步骤2: 生成REPORT.md记录工作成果
步骤3: 标注TASK.md中对应任务为完成状态
步骤4: 向main发送完成通知
步骤5: 等待main审查
```

---

## 📄 REPORT.md要求

### 必须包含的内容

**每个完成的任务都需要记录**：

```markdown
# 任务完成报告

## 任务X.X: [任务名称]

**完成时间**: YYYY-MM-DD HH:MM:SS
**状态**: ✅ 完成

### 实现内容
- 详细描述实现的功能
- 列出关键的代码文件
- 说明技术方案

### 测试情况
- 单元测试: X个测试，通过率100%
- 测试覆盖率: X%
- 集成测试: 通过/不通过

### 验收标准检查
- ✅ 代码质量检查通过
- ✅ API文档完整
- ✅ 性能达标
- ✅ 安全检查通过

### 文档更新
- 更新的文档列表
- 新增的文档列表

### 问题和解决方案
- 遇到的问题1 → 解决方案
- 遇到的问题2 → 解决方案

### 后续建议
- 优化建议
- 改进方向
```

### REPORT.md生成规则

- **时机**: 每个任务完成后立即生成
- **位置**: `CLIS/api/REPORT.md`
- **格式**: 严格按照模板格式
- **更新**: 累积记录，保留历史

---

## 🚨 异常处理

### 遇到阻塞时

**立即执行**：
1. 通过mailbox向main发送ALERT消息
2. 说明阻塞原因和影响
3. 提出可能的解决方案
4. 等待main指示

**禁止**：
- ❌ 擅自跳过阻塞继续执行
- ❌ 修改任务要求
- ❌ 长时间等待不报告

### 发现安全漏洞时

**立即执行**：
1. 通过mailbox向main发送ALERT消息（类型: SECURITY）
2. 说明漏洞详情和风险等级
3. 提供修复建议
4. 等待main指示

---

## 📊 职责范围

### 职责内（可以执行）

- ✅ FastAPI后端开发
- ✅ JWT认证和授权
- ✅ RESTful API设计和实现
- ✅ 数据库查询和集成
- ✅ API文档编写
- ✅ 单元测试编写
- ✅ 代码优化和重构

### 职责外（禁止执行或需申请）

- ❌ 前端开发（WEB CLI职责）
- ❌ 数据库表结构设计（DB CLI职责）
- ❌ 系统架构变更（需main批准）
- ❌ 新增技术栈（需main批准）
- ❌ 生产环境部署（需main批准）

---

## 🔗 协作规范

### 与DB CLI协作

**需要协作的场景**：
- 确认数据表结构
- 请求创建新表或索引
- 讨论查询优化
- 数据迁移计划

**协作方式**：
通过mailbox发送REQUEST消息，清晰说明需求

### 与WEB CLI协作

**需要协作的场景**：
- 确认API接口规范
- 对齐请求/响应格式
- 讨论错误处理策略
- API版本管理

**协作方式**：
通过mailbox发送REQUEST消息

### 与Main CLI协作

**必须报告的场景**：
- 每日进度更新
- 任务完成通知
- 遇到阻塞问题
- 发现安全漏洞
- 需要权限申请

**报告方式**：
通过mailbox，根据紧急程度选择ALERT/REQUEST/UPDATE类型

---

## 📚 参考文档

- FastAPI最佳实践: `docs/api/FASTAPI_GUIDE.md`
- 认证安全规范: `docs/security/AUTHENTICATION_SPEC.md`
- API设计指南: `docs/api/API_DESIGN_GUIDE.md`
- 代码质量标准: `docs/standards/CODING_STANDARDS.md`

---

## ⚠️ 违规后果

**不遵守RULES.md的后果**：
- ⚠️ 第一次：警告并要求整改
- ⚠️ 第二次：暂停任务分配
- ⚠️ 第三次：重新评估资格

**执行TASK.md以外任务的后果**：
- ⚠️ 代码将被拒绝
- ⚠️ 需要重新执行正确任务
- ⚠️ 影响后续任务分配

---

**本规范由Main CLI制定和维护，违反规范将影响工作评价**

**最后更新**: 2026-01-01 21:15
