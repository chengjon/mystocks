### DeMark TD Sequential 指标计算公式和原理

DeMark TD Sequential 是一种量化趋势衰竭并预测潜在反转点的技术指标，它由两个主要阶段组成：TD Setup 和 TD Countdown。

**核心概念：** 识别趋势加速（动量）达到一个可能不可持续的极端水平（Setup），然后量化趋势在预警信号出现后的延续程度（Countdown），直至趋势“精疲力竭”并反转。

---

#### I. TD Setup 的计算规则

**目标：** 识别价格动量达到极端水平，预示趋势可能接近尾声。

**输入数据：** `closes` (收盘价序列), `highs` (最高价序列), `lows` (最低价序列)

1.  **买入 Setup (Buy Setup) - 预示下跌趋势衰竭，可能买入**
    *   **条件：** 连续 9 根 K 线中，至少有 7 根满足 `当前 K 线收盘价 < 第 i-4 根 K 线收盘价`。
    *   **中断 (Cancellation)：** 在形成过程中（尚未达到 9 根），如果出现一根 K 线，其 `当前 K 线收盘价 > 第 i-4 根 K 线最高价`，则当前正在形成的买入 Setup 中断，计数归零，需要重新开始。
    *   **完成标志：** 当连续出现 9 根 K 线，且其中至少 7 根满足上述条件时，买入 Setup 完成。

2.  **卖出 Setup (Sell Setup) - 预示上涨趋势衰竭，可能卖出**
    *   **条件：** 连续 9 根 K 线中，至少有 7 根满足 `当前 K 线收盘价 > 第 i-4 根 K 线收盘价`。
    *   **中断 (Cancellation)：** 在形成过程中，如果出现一根 K 线，其 `当前 K 线收盘价 < 第 i-4 根 K 线最低价`，则当前正在形成的卖出 Setup 中断，计数归零，需要重新开始。
    *   **完成标志：** 当连续出现 9 根 K 线，且其中至少 7 根满足上述条件时，卖出 Setup 完成。

**原理：** 通过比较当前收盘价和 4 期前的收盘价，Setup 关注的是短期的、加速的动量。例如，在下跌趋势中，连续满足 `Close(i) < Close(i-4)` 意味着价格在加速下滑，这种加速通常难以持久。中断规则过滤掉那些在形成过程中就出现强劲反向运动的伪信号。

---

#### II. TD Countdown 的计算规则

**目标：** 在 Setup 完成后启动，进一步量化趋势的“最后挣扎”，直至其“精疲力竭”。

**输入数据：** `closes`, `highs`, `lows`

**重要前提：** Countdown 只能在 Setup 完成后立即开始。

1.  **买入 Countdown (Buy Countdown) - 预示下跌趋势结束，强烈买入信号**
    *   **启动：** 在买入 Setup 完成后的那根 K 线开始计数。
    *   **条件：** 寻找连续的 K 线，每根 K 线满足 `当前 K 线收盘价 < 第 i-2 根 K 线最低价`。
    *   **中断 (Cancellation)：** 在 Countdown 过程中（尚未达到 13 次），如果出现一根 K 线，其 `当前 K 线收盘价 >= 买入 Setup 期间的最高价`。这个最高价是 Setup 完成时，前 9 根 K 线中的最高价。
    *   **完成标志：** 当满足上述条件的 K 线数量累积达到 13 根时，买入 Countdown 完成。

2.  **卖出 Countdown (Sell Countdown) - 预示上涨趋势结束，强烈卖出信号**
    *   **启动：** 在卖出 Setup 完成后的那根 K 线开始计数。
    *   **条件：** 寻找连续的 K 线，每根 K 线满足 `当前 K 线收盘价 > 第 i-2 根 K 线最高价`。
    *   **中断 (Cancellation)：** 在 Countdown 过程中，如果出现一根 K 线，其 `当前 K 线收盘价 <= 卖出 Setup 期间的最低价`。这个最低价是 Setup 完成时，前 9 根 K 线中的最低价。
    *   **完成标志：** 当满足上述条件的 K 线数量累积达到 13 根时，卖出 Countdown 完成。

**原理：** Countdown 的条件 (例如 `Close(i) < Low(i-2)`) 比 Setup 更严格，它要求价格不仅延续 Setup 的方向，还要创出更极端的新低/新高。这衡量了趋势在 Setup 预警后的“最后挣扎”力量。达到 13 次（DeMark 经验值）表明趋势动能已耗尽，反转概率很高。中断规则是关键安全阀，防止在趋势意外恢复时陷入错误的反转交易。
