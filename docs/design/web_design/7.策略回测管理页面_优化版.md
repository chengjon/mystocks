# 7. 策略回测管理页面_优化版

## 主菜单映射（对应主菜单项七：策略回测管理）
- **角色定位**：策略开发（可视化/代码）、回测与参数优化的集中平台，支持GPU加速与并行任务
- **必备功能清单**：
  - 策略设计器（模块化/代码编辑器）与策略模板库
  - 回测任务入口（选择策略/股票池/区间）与任务队列（task_id）
  - 回测报告（净值曲线、绩效指标、交易明细、A股特化分析）
  - 参数优化器（网格/遗传/贝叶斯）与结果展示
  - K线图可视化（回测信号标注、买卖点显示、策略逻辑验证）

## 精简摘要与实施要点
- **页面摘要**：回测管理页为策略验证和参数优化提供端到端能力，首要目标是正确、可复现的历史回测结果与可下载报告
- **核心功能（前5优先级）**：策略编辑与保存、回测任务提交/进度、净值曲线与绩效指标展示、回测交易明细导出、A股特化处理（涨跌停/T+1/手续费）
- **API/数据依赖**：backtest_tasks/backtest_results/backtest_trades（PostgreSQL）、历史行情（TDengine）、回测任务队列服务（Celery/asyncio）
- **实施要点**：初期以单线程可复现回测为主，记录随机种子与假设；回测要能配置A股特化选项（是否考虑涨停、手续费、滑点）；报告以PDF/CSV导出为主
- **验收标准（一句话）**：提交回测任务并获得包含净值曲线与关键绩效指标（总收益、最大回撤）的报告，回测结果在多次运行下保持一致（可复现）

---
**Owner**: 量化工程 / 协同: 后端, 运维  
**Collaborators**: QA

**MVP 最小实现任务**：
- 实现单策略、单股票的历史回测入口（选择策略、起止日期、股票池后执行）
- 回测完成后生成基本回测报告（净值曲线 + 总收益率 + 最大回撤）并可下载
- 实现回测任务队列并返回task_id，支持任务状态查询接口
- 集成K线图显示回测过程中的买卖信号

**验收标准**：
- 回测能在本地完成（使用模拟/历史数据），回测报告可下载并包含净值曲线；任务接口能返回正确的状态（pending/running/done/failed）
- K线图正确显示买卖信号，技术指标计算准确，策略逻辑验证清晰

**实现说明**：回测引擎应与TDengine/Postgres协同读取历史行情与参数，采用可配置的并发模式（本地先用单线程实现）。GPU加速为后续优化项，K线图使用TradingView集成

---

## 3.7 策略回测管理页面（Backtest Management）

**功能定位**：策略设计、管理、回测、GPU加速、参数优化、K线图可视化

### NiceGUI组件实现

**1. 策略设计器（ui.tabs子页面1）**

```python
# 可视化策略构建器（ui.card）

**模块化策略构建**：
- 入场条件模块（ui.expansion）：
  - 添加条件（ui.button）
  - 条件1：MACD金叉 AND RSI>50
  - 条件2：成交量 > 5日均量 * 1.5
  - 逻辑关系：AND / OR（ui.select）

- 出场条件模块（ui.expansion）：
  - 条件1：MACD死叉
  - 条件2：止损 -10%
  - 条件3：止盈 +20%

- 仓位管理模块（ui.expansion）：
  - 初始资金（ui.number）：1,000,000元
  - 单笔仓位（ui.slider）：10-30%
  - 总仓位上限（ui.slider）：90%
  - 加仓策略：ui.select（固定/金字塔/马丁）

- 风控模块（ui.expansion）：
  - 止损比例（ui.slider）：5-20%
  - 止盈比例（ui.slider）：10-50%
  - 移动止损（ui.checkbox）
  - 最大回撤限制（ui.number）：-20%

# K线图策略预览（ui.collapse，可展开）
- 选择示例股票：ui.select（600036招商银行、000333美的集团等）
- TradingView Klinechart显示：
  - K线图显示历史数据
  - 技术指标标注（MACD、RSI、KDJ、布林带）
  - 策略信号预览：
    - 绿色三角：买入信号
    - 红色三角：卖出信号
    - 蓝色线：止损线
    - 紫色线：止盈线
  - 参数调节实时预览

# 策略预览代码生成（ui.code）
- 自动生成Python策略代码
- 语法高亮
- 可编辑修改
- 实时预览K线图中的策略效果

# 保存策略（ui.button）
- 策略名称（ui.input）
- 策略描述（ui.textarea）
- 保存到策略库
- 生成回测模板
```

**2. 策略管理（ui.tabs子页面2）**

```python
# 策略库列表（ui.aggrid）
表格字段：
  ID | 策略名称 | 类型 | 创建时间 | 最后修改 | 回测次数 | 最佳收益 | 状态 | 操作

- 策略类型：
  - 趋势策略
  - 动量策略
  - 均值回归
  - 套利策略
  - 自定义

- 状态标识：
  - 🟢运行中（已启用）
  - 🔴暂停（已禁用）
  - 🔵测试中（正在回测）

- 操作按钮：
  - 查看详情（跳转到策略详情页）
  - 编辑策略（返回策略设计器）
  - 快速回测（直接运行回测）
  - 复制策略（创建副本）
  - 策略对比（最多5个）
  - 删除策略

# 策略对比分析（ui.tabs子页面）
- 选择对比策略（多选ui.checkbox，最多5个）
- 对比维度图表：
  - 收益对比雷达图（ui.plotly_radar）
  - 风险对比柱状图（ui.plotly_bar）
  - 净值曲线对比（ui.plotly_line）
  - 回撤曲线对比（ui.plotly_area）

# 版本控制（ui.expansion）
- 策略版本历史（ui.timeline）
- 版本差异对比（代码diff显示）
- 回滚到历史版本
- 分支管理（实验版/稳定版）
```

**3. 策略回测（ui.tabs子页面3）**

```python
# 回测配置面板（ui.card）
- 选择策略（ui.select）：
  - 从策略库选择
  - 或者选择示例策略
  - 显示策略代码预览

- 回测区间设置（ui.row）：
  - 开始日期（ui.date）：2020-01-01
  - 结束日期（ui.date）：2024-12-31
  - 快捷选择：ui.button_group（近1年/3年/5年/全部）
  
- 股票池选择（ui.multi_select）：
  - 全A股（适合大策略）
  - 沪深300（适合大盘股策略）
  - 中证500（适合中盘股策略）
  - 创业板指（适合成长股策略）
  - 自选股池（导入代码列表）

# A股特化设置（ui.card）
- 交易规则（ui.checkbox_group）：
  - ☑ 考虑涨跌停限制（无法买入涨停股、卖出跌停股）
  - ☑ 启用T+1限制（当日买入次日才能卖出）
  - ☑ 100股整数倍委托
  - ☑ 考虑滑点（默认0.2%，可调整）
  - ☑ 考虑手续费（佣金0.03%、印花税0.1%）
  - ☑ ST股特殊处理（涨跌幅5%）

- 资金管理（ui.row）：
  - 初始资金（ui.number）：1,000,000元
  - 单股仓位上限（ui.slider）：10-30%
  - 总仓位上限（ui.slider）：80-100%
  - 现金保留比例（ui.slider）：5-20%

# K线图回测可视化（ui.collapse，可展开）
- 策略测试股票选择：ui.select
- TradingView Klinechart集成：
  ```javascript
  // 回测专用K线图配置
  new TradingView.widget({
      "width": "100%",
      "height": "400px",
      "symbol": stock_code,
      "interval": "D",
      "timezone": "Asia/Shanghai",
      "theme": "light",
      "locale": "zh_CN",
      
      // 回测信号标记
      "drawings": [
          {
              "type": "buy_signal",
              "color": "#00ff00",
              "text": "BUY",
              "time": "2023-03-15"
          },
          {
              "type": "sell_signal", 
              "color": "#ff0000",
              "text": "SELL",
              "time": "2023-05-20"
          }
      ],
      
      // 策略指标显示
      "studies": [
          "MACD@tv-basicstudies",
          "RSI@tv-basicstudies",
          "KDJ@tv-basicstudies",
          "BollingerBands@tv-basicstudies"
      ],
      
      // 买卖点叠加
      "onChartReady": function(chart) {
          const widget = chart.activeChart();
          
          // 买入信号标注
          backtest_signals.buy.forEach(signal => {
              widget.chart().createShape({
                  time: signal.time,
                  color: '#00ff00',
                  shape: 'arrowUp',
                  text: 'BUY: ' + signal.reason
              });
          });
          
          // 卖出信号标注
          backtest_signals.sell.forEach(signal => {
              widget.chart().createShape({
                  time: signal.time,
                  color: '#ff0000',
                  shape: 'arrowDown', 
                  text: 'SELL: ' + signal.reason
              });
          });
          
          // 止损止盈线
          stop_loss_price = initial_price * 0.9;
          take_profit_price = initial_price * 1.2;
          
          widget.chart().createLine({
              price: stop_loss_price,
              color: '#ff4444',
              lineStyle: 2, // 虚线
              text: '止损线-10%'
          });
          
          widget.chart().createLine({
              price: take_profit_price,
              color: '#44ff44',
              lineStyle: 2, // 虚线
              text: '止盈线+20%'
          });
      }
  });
  ```

# 开始回测（ui.button，大号主按钮）
- 回测模式选择：
  - 标准回测（CPU，1x速度）
  - 快速回测（GPU加速，10x速度）
  - 详细回测（包含K线图标注，0.5x速度）

- 点击后显示进度：
  - 进度条（ui.linear_progress）
  - 实时日志（ui.log，滚动显示）：
    ```
    [09:00] 回测开始：2023-01-01 至 2024-12-31
    [09:01] 加载数据：沪深300，共300只股票
    [09:02] 初始化策略：双均线交叉策略
    [09:03] 计算技术指标：MA5、MA20、MACD、RSI
    [09:04] 2023-03-15：买入信号 600036 招商银行 @32.50元
    [09:05] 2023-05-20：卖出信号 600036 招商银行 @35.80元，盈利+10.15%
    ...
    [09:18] 回测完成！总交易次数：156次，胜率：62.8%
    [09:19] 生成回测报告...
    [09:20] K线图标注完成，买卖点已标记
    ```

# 回测结果展示（ui.tabs）

**Tab1：绩效概览**
- 核心指标仪表盘（ui.grid 2x4）：
  - 📈 总收益率：+45.6%（绿色，表示盈利）
  - 📊 年化收益：18.5%
  - ⚖️ 夏普比率：1.45（>1为优秀）
  - 📉 最大回撤：-15.8%（红色，需要关注）
  - ✅ 胜率：62.5%
  - 💰 盈亏比：1.85
  - 📋 交易次数：156次
  - ⏱️ 平均持仓：8.5天

- 净值曲线图（ui.plotly）：
  - 策略净值曲线（蓝色粗线）
  - 基准净值曲线（沪深300，灰色虚线）
  - 买卖信号标注点
  - 最大回撤区间阴影标注

**Tab2：交易明细**
- 交易记录表（ui.aggrid）：
  列字段：
  - 序号、日期、股票代码/名称
  - 操作类型（买入/卖出，价格标识颜色）
  - 价格、数量、金额、手续费
  - 持仓天数、盈亏（金额+百分比，红正绿负）
  - 交易原因（如"MA5上穿MA20金叉"）
  - K线查看（链接跳转到K线图对应日期）

- 高级筛选（ui.row）：
  - 按盈亏筛选：全部/盈利/亏损
  - 按股票筛选：输入股票代码
  - 按时间筛选：选择日期范围
  - 按盈亏金额排序

**Tab3：K线图分析**
- 策略信号回放（ui.collapse）：
  - 选择股票（ui.select）
  - 回测区间选择（ui.date_range）
  - 播放控制：
    - ▶️ 播放/暂停按钮
    - ⏩ 速度控制（1x/5x/10x）
    - 📍 跳转到指定日期（ui.slider）
  
- TradingView K线图集成：
  - 显示回测期间的完整K线数据
  - 买卖信号标注：
    - 绿色向上箭头：买入点，显示买入原因
    - 红色向下箭头：卖出点，显示卖出原因
    - 蓝色虚线：止损线位置
    - 紫色虚线：止盈线位置
  - 技术指标显示：
    - MACD（主图下方）
    - RSI（超买超卖区域标注）
    - KDJ（买卖信号标记）
    - 布林带（通道突破标记）

**Tab4：A股特化报告**
- 涨跌停影响分析：
  - 因涨停无法买入次数：12次
  - 潜在损失估算：-3.2%
  - 因跌停无法卖出次数：5次
  - 额外损失估算：-1.8%

- T+1影响分析：
  - T+1限制影响交易次数：8次
  - 若允许T+0可能提升收益：+2.5%
  - T+1对资金利用效率影响

- 板块收益分布：
  - 金融板块：+18.2%（贡献最大）
  - 医药板块：-2.1%（拖累收益）
  - 科技板块：+12.5%
  - 新能源：+8.7%

- 政策风险分析：
  - ST股影响：限制涨跌幅5%
  - 重组停牌影响：3次，损失-1.5%
  - 减持新规影响：限制了部分策略执行

**Tab5：参数敏感性分析**
- 参数影响分析（ui.plotly_3d）：
  - X轴：参数1（如MA短期周期）
  - Y轴：参数2（如MA长期周期）
  - Z轴：收益结果
  - 颜色：回撤大小

- 稳健性测试：
  - 同一参数在不同市场环境下的表现
  - 参数微调对收益的影响
  - 最优参数区间推荐
```

**4. GPU加速回测（ui.tabs子页面4）**

```python
# GPU配置与状态（ui.card）
- GPU硬件检测：
  - GPU设备：NVIDIA RTX 3090 / A100 / V100
  - 显存大小：24GB / 40GB / 16GB
  - CUDA版本：11.8 / 12.0
  - 驱动版本：驱动版本号
  - 状态：✅可用 / ❌不可用 / ⚠️部分可用

- 性能基准测试：
  - CPU单线程：45分钟（基准）
  - CPU多线程（8核）：8分钟
  - GPU加速：3分钟（15x加速）
  - 内存使用：18GB / 24GB

# GPU加速策略（ui.card）
- 支持的加速功能：
  - ☑ 技术指标批量计算（cuDF加速）
  - ☑ 向量化回测引擎（cuML支持）
  - ☑ 多策略并行回测
  - ☑ 实时K线图渲染优化
  - ☐ 深度学习策略（开发中）

- 加速配置：
  - 批处理大小（ui.slider）：100-1000股
  - 并行任务数（ui.slider）：1-8个
  - 内存优化（ui.switch）：自动释放无用数据
  - 缓存策略（ui.select）：LRU/时间优先

# 批量回测管理（ui.card）
- 选择多个策略（ui.multi_select，最多10个）
- 并行执行：
  - GPU并行回测：同时执行多个策略
  - 资源分配：动态分配GPU显存
  - 执行状态：
    ```
    [09:00] GPU批量回测开始
    [09:01] 策略1：双均线交叉 → 运行中 (30%)
    [09:02] 策略2：MACD策略 → 运行中 (45%)
    [09:03] 策略3：RSI策略 → 排队中
    ...
    [09:15] 所有策略回测完成！
    ```

- 性能对比分析：
  - 各策略耗时对比（条形图）
  - GPU使用率监控（实时图表）
  - 加速效果统计
```

**5. 参数优化器（ui.tabs子页面5）**

```python
# 优化方法选择（ui.radio）
- 🎯 网格搜索（穷举法）：
  - 优点：全面无遗漏
  - 缺点：计算量大
  - 适用：参数少（<3个）
  
- 🧬 遗传算法：
  - 优点：全局搜索，智能优化
  - 缺点：需要多代进化
  - 适用：中等参数数量
  
- 🔬 贝叶斯优化：
  - 优点：高效，样本需求少
  - 缺点：复杂度高
  - 适用：高维参数空间
  
- 🌟 粒子群优化：
  - 优点：收敛快
  - 缺点：容易局部最优
  - 适用：连续参数优化

# 参数范围设置（ui.card）
- 参数配置表（ui.table）：
  参数名称 | 当前值 | 最小值 | 最大值 | 步长 | 类型
  MA短期周期 | 5 | 5 | 20 | 1 | 整数
  MA长期周期 | 20 | 20 | 60 | 5 | 整数
  止损比例 | 8% | 5% | 20% | 1% | 浮点
  止盈比例 | 20% | 10% | 50% | 5% | 浮点

- A股特化参数（ui.expansion）：
  - 涨停板处理：ui.select（严格/宽松/忽略）
  - T+1限制：ui.checkbox（启用/禁用）
  - 最小交易单位：100股（固定）
  - 滑点设置：0.1%-0.5%

# 优化目标配置（ui.card）
- 主要目标（ui.radio）：
  - 🎯 最大化总收益率
  - ⚖️ 最大化夏普比率
  - 📉 最小化最大回撤
  - 💰 最大化收益风险比
  
- 约束条件（ui.checkbox_group）：
  - ☑ 最大回撤 < -15%
  - ☑ 年化收益 > 15%
  - ☑ 胜率 > 50%
  - ☑ 交易频率 < 2次/周

# 优化进度监控（ui.progress + ui.log）
- 优化进度：
  - 已测试组合：1,234 / 10,000
  - 当前最优：收益+42.3%，夏普1.52
  - 预计完成时间：25分钟
  
- 实时日志：
  ```
  [09:15] 开始网格搜索优化，共10,000种组合
  [09:16] 测试组合1：MA5/MA20，收益+38.2%
  [09:17] 测试组合2：MA5/MA25，收益+41.7%（新记录！）
  [09:18] 测试组合3：MA10/MA20，收益+35.1%
  ...
  ```

# 优化结果展示（ui.tabs）

**Tab1：最优参数组合**
- 参数排名表（ui.aggrid）：
  排名 | MA短期 | MA长期 | 止损 | 止盈 | 总收益 | 夏普 | 回撤 | 综合评分
  1 | 5 | 25 | 8% | 25% | +42.3% | 1.52 | -12.8% | 95.2
  2 | 5 | 20 | 10% | 20% | +41.1% | 1.48 | -13.5% | 93.8
  3 | 8 | 25 | 6% | 30% | +39.8% | 1.45 | -14.2% | 92.1

**Tab2：参数敏感性分析**
- 3D散点图（ui.plotly_3d）：
  - X轴：MA短期周期
  - Y轴：MA长期周期  
  - Z轴：收益结果
  - 颜色：夏普比率
  - 点击点查看详细参数组合

- 参数热力图（ui.plotly_heatmap）：
  - 横轴：MA短期周期
  - 纵轴：MA长期周期
  - 颜色：收益大小（红色高，蓝色低）

**Tab3：稳健性测试**
- 不同市场环境表现：
  - 牛市表现（2020-2021）：+52.3%
  - 震荡市表现（2018-2019）：+18.7%
  - 熊市表现（2022）：-8.2%
  
- 蒙特卡洛分析：
  - 参数微调±10%的收益变化
  - 稳定性评分：78.5/100
```

**6. 数据存储设计（PostgreSQL + TDengine）**

```sql
-- 策略配置表（PostgreSQL）
CREATE TABLE backtest_strategies (
    strategy_id SERIAL PRIMARY KEY,
    strategy_name VARCHAR(100),
    strategy_type VARCHAR(50), -- 趋势/动量/均值回归/套利/自定义
    strategy_code TEXT, -- Python策略代码
    parameters JSONB, -- 策略参数配置
    version INT DEFAULT 1,
    author VARCHAR(50),
    description TEXT,
    create_time TIMESTAMP DEFAULT NOW(),
    update_time TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT true
);

-- 回测任务表（PostgreSQL）
CREATE TABLE backtest_tasks (
    task_id SERIAL PRIMARY KEY,
    strategy_id INT REFERENCES backtest_strategies(strategy_id),
    task_name VARCHAR(100),
    start_date DATE,
    end_date DATE,
    stock_pool JSONB, -- 股票池配置
    initial_capital DECIMAL(15,2),
    status VARCHAR(20), -- PENDING/RUNNING/COMPLETED/FAILED
    progress INT DEFAULT 0, -- 进度百分比
    gpu_enabled BOOLEAN DEFAULT false,
    created_time TIMESTAMP DEFAULT NOW(),
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    error_message TEXT
);

-- 回测结果表（PostgreSQL）
CREATE TABLE backtest_results (
    result_id SERIAL PRIMARY KEY,
    task_id INT REFERENCES backtest_tasks(task_id),
    total_return DECIMAL(10,4), -- 总收益率
    annual_return DECIMAL(10,4), -- 年化收益率
    sharpe_ratio DECIMAL(10,4), -- 夏普比率
    sortino_ratio DECIMAL(10,4), -- 索提诺比率
    max_drawdown DECIMAL(10,4), -- 最大回撤
    calmar_ratio DECIMAL(10,4), -- 卡玛比率
    win_rate DECIMAL(10,4), -- 胜率
    profit_loss_ratio DECIMAL(10,4), -- 盈亏比
    trade_count INT, -- 交易次数
    avg_holding_days DECIMAL(10,2), -- 平均持仓天数
    final_capital DECIMAL(15,2), -- 最终资金
    benchmark_return DECIMAL(10,4), -- 基准收益
    alpha DECIMAL(10,4), -- Alpha
    beta DECIMAL(10,4), -- Beta
    created_time TIMESTAMP DEFAULT NOW()
);

-- 回测交易明细表（PostgreSQL）
CREATE TABLE backtest_trades (
    trade_id SERIAL PRIMARY KEY,
    result_id INT REFERENCES backtest_results(result_id),
    stock_code VARCHAR(10),
    stock_name VARCHAR(50),
    trade_date DATE,
    direction VARCHAR(10), -- BUY/SELL
    price DECIMAL(10,3),
    quantity INT,
    amount DECIMAL(15,2),
    commission DECIMAL(10,2),
    slippage DECIMAL(10,2),
    profit DECIMAL(15,2), -- 该笔交易盈亏
    profit_ratio DECIMAL(10,4), -- 盈亏比例
    holding_days INT, -- 持仓天数
    trade_reason TEXT, -- 交易原因
    signal_strength INT, -- 信号强度 0-100
    kline_data JSONB -- 对应K线数据用于回放
);

-- 回测信号记录表（TDengine，高频数据）
CREATE STABLE backtest_signals (
    ts TIMESTAMP,
    signal_type VARCHAR(20), -- BUY/SELL/STOP_LOSS/TAKE_PROFIT
    price DECIMAL(10,3),
    quantity INT,
    signal_strength INT,
    reason TEXT
) TAGS (
    result_id INT,
    stock_code NCHAR(10),
    strategy_id INT
);

-- 参数优化结果表（PostgreSQL）
CREATE TABLE parameter_optimization (
    optimization_id SERIAL PRIMARY KEY,
    strategy_id INT REFERENCES backtest_strategies(strategy_id),
    optimization_method VARCHAR(50), -- GRID/GA/BAYESIAN/PSO
    parameter_ranges JSONB, -- 参数范围配置
    objective_function VARCHAR(50), -- 优化目标
    total_combinations INT,
    tested_combinations INT,
    best_parameters JSONB,
    best_score DECIMAL(10,4),
    optimization_time INT, -- 优化耗时（秒）
    created_time TIMESTAMP DEFAULT NOW()
);
```

### API接口设计

```python
# 策略管理接口
@api.get("/api/v1/backtest/strategies")
async def get_strategies():
    """获取策略列表"""
    pass

@api.post("/api/v1/backtest/strategies")
async def create_strategy(strategy: StrategyCreate):
    """创建新策略"""
    pass

@api.get("/api/v1/backtest/strategies/{strategy_id}")
async def get_strategy_detail(strategy_id: str):
    """获取策略详情"""
    pass

# 回测任务接口
@api.post("/api/v1/backtest/tasks")
async def create_backtest_task(task: BacktestTaskCreate):
    """创建回测任务"""
    return {
        "task_id": "task_001",
        "status": "PENDING",
        "estimated_time": "15分钟"
    }

@api.get("/api/v1/backtest/tasks/{task_id}")
async def get_backtest_task_status(task_id: str):
    """获取回测任务状态"""
    return {
        "task_id": task_id,
        "status": "RUNNING",
        "progress": 45,
        "current_step": "计算技术指标",
        "estimated_remaining": "8分钟"
    }

@api.get("/api/v1/backtest/results/{result_id}")
async def get_backtest_result(result_id: str):
    """获取回测结果"""
    return {
        "basic_metrics": {
            "total_return": 0.456,
            "annual_return": 0.185,
            "sharpe_ratio": 1.45,
            "max_drawdown": -0.158,
            "win_rate": 0.625
        },
        "equity_curve": {
            "dates": [...],
            "strategy_equity": [...],
            "benchmark_equity": [...]
        },
        "trades": [...],
        "chart_data": {
            "symbol": "600036",
            "signals": [...]
        }
    }

@api.get("/api/v1/backtest/kline/{stock_code}")
async def get_kline_for_backtest(stock_code: str, start_date: str, end_date: str):
    """获取回测用的K线数据（含信号标注）"""
    return {
        "symbol": stock_code,
        "interval": "D",
        "data": [...],
        "signals": [
            {
                "time": "2023-03-15",
                "type": "BUY",
                "price": 32.50,
                "reason": "MA5上穿MA20金叉"
            },
            {
                "time": "2023-05-20", 
                "type": "SELL",
                "price": 35.80,
                "reason": "MA5下穿MA20死叉"
            }
        ]
    }

# 参数优化接口
@api.post("/api/v1/backtest/optimize")
async def optimize_parameters(optimization: ParameterOptimization):
    """启动参数优化任务"""
    return {
        "optimization_id": "opt_001",
        "status": "STARTED",
        "estimated_combinations": 10000,
        "estimated_time": "30分钟"
    }

@api.get("/api/v1/backtest/optimize/{optimization_id}")
async def get_optimization_progress(optimization_id: str):
    """获取参数优化进度"""
    pass
```

### 关键特性说明

1. **K线图策略可视化**：集成TradingView，实时显示策略信号和买卖点
2. **GPU加速回测**：15x加速，支持多策略并行执行
3. **A股特色优化**：涨跌停、T+1、100股倍数等A股特有规则
4. **智能参数优化**：多种优化算法，找到最优参数组合
5. **策略信号回放**：可视化展示策略逻辑执行过程
6. **批量回测管理**：同时测试多个策略，对比分析

### 验收标准

- **功能验收**：策略可以正常执行回测，K线图正确显示买卖信号，回测结果可复现
- **性能验收**：GPU加速效果明显（>10x），大批量数据处理稳定
- **用户体验**：参数优化界面直观，回测报告详细，策略对比清晰
- **A股适配**：涨跌停、T+1等规则正确模拟，回测结果贴近实盘

---
**开发完成时间**: 预估3周  
**测试重点**: K线图信号准确性、GPU加速稳定性、参数优化效果、A股规则模拟  
**风险点**: GPU兼容性问题、大数据量处理性能、策略过拟合、参数优化收敛
