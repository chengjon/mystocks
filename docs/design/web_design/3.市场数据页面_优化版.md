# 三、市场数据页面 - 优化版

## 页面概述
市场数据页面整合多维度市场数据，提供资金流向、ETF分析、概念板块、竞价抢筹、龙虎榜等核心市场情报，帮助用户把握市场脉搏和资金动向。

## 核心功能模块

### 1. 资金流向分析
**功能定位**: 分析个股和板块的资金流入流出情况，识别主力资金动向

**组件结构**:
```python
# 个股资金流分析 (ui.tabs)
Tab1: 个股资金流向
- 股票选择器 (ui.input自动补全)
- 时间范围选择 (ui.date_range, 默认近30日)
- 资金流向趋势图 (ui.plotly):
  主图: 主力净流入/流出柱状图 (红正绿负)
  副图: 成交量对比柱状图
  叠加: 价格走势线 (灰色虚线)

- 资金流向明细表 (ui.aggrid):
字段: 日期 | 主力净流入 | 超大单 | 大单 | 中单 | 小单 | 涨跌幅
- 颜色编码: 流入为红色，流出为绿色
- 数据聚合: 支持按日/周/月聚合

- 资金流向指标卡片 (ui.row):
  - 3日主力净流入: +5.6亿 (绿色正数)
  - 5日主力净流入: +12.8亿
  - 主力成本: 32.5元
  - 主力参与度: 68% (进度条显示)

Tab2: 板块资金流向  
- 板块选择 (ui.select多选):
  - 申万一级行业 (31个)
  - 热门概念板块 (动态更新)
  - 自定义板块组合

- 板块资金流向排行榜 (ui.aggrid):
字段: 排名 | 板块名称 | 今日主力净流入 | 5日累计 | 涨跌幅 | 成交额 | 活跃度

- 板块资金流向热力图 (ui.plotly):
  - X轴: 板块名称
  - Y轴: 资金流入金额  
  - 颜色: 涨跌幅 (红涨绿跌)
  - 气泡大小: 成交额
  - 交互: 点击查看板块成分股

Tab3: 北向资金
- 北向资金概览卡片 (ui.card, 4列):
  - 沪股通净流入: +28.6亿 (大号红色)
  - 深股通净流入: +30.2亿 (大号红色)
  - 北向资金总额: +58.8亿
  - 余额占比: 11.2%

- 北向资金趋势图 (ui.plotly):
  - 近30日每日流入流出柱状图
  - 累计净流入曲线 (蓝色粗线)
  - 关键事件标注 (如MSCI调整日)

- 北向资金持仓TOP10 (ui.table):
字段: 排名 | 股票代码 | 股票名称 | 持仓市值 | 占总市值比 | 增持减持 | 持股天数
```

**资金流向计算逻辑**:
```python
# 资金流向分类算法
def calculate_fund_flow(trades):
    """
    根据成交金额和性质计算资金流向
    """
    large_order_threshold = 10000  # 大单阈值(手)
    
    flow_data = {
        'super_large': 0,  # 超大单 >50万
        'large': 0,        # 大单 10-50万
        'medium': 0,       # 中单 5-10万  
        'small': 0,        # 小单 <5万
        'net_flow': 0      # 净流入
    }
    
    for trade in trades:
        amount = trade['amount']
        if amount > 500000:  # 超大单
            flow_data['super_large'] += trade['volume'] if trade['side'] == 'BUY' else -trade['volume']
        elif amount > 100000:  # 大单
            flow_data['large'] += trade['volume'] if trade['side'] == 'BUY' else -trade['volume']
        elif amount > 50000:   # 中单
            flow_data['medium'] += trade['volume'] if trade['side'] == 'BUY' else -trade['volume']
        else:                   # 小单
            flow_data['small'] += trade['volume'] if trade['side'] == 'BUY' else -trade['volume']
    
    flow_data['net_flow'] = flow_data['super_large'] + flow_data['large']
    return flow_data
```

### 2. ETF行情分析
**功能定位**: 提供ETF实时行情、溢价率分析和跟踪误差监控

**组件结构**:
```python
# ETF实时行情表 (ui.aggrid, 主体)
字段设计:
- 基础信息: 代码 | 名称 | 基金类型 | 跟踪指数
- 行情数据: 最新价 | 涨跌幅 | 成交量 | 成交额
- ETF特色: 溢价率 | 跟踪误差 | 规模 | 活跃度

特色显示:
- 溢价率颜色编码:
  - 溢价率 > 2%: 红色高亮 (价格偏高)
  - 溢价率 < -2%: 绿色高亮 (价格偏低)  
  - 正常范围: 灰色显示
- 规模显示: 自动转换单位 (亿/千万/百万)
- ETF类型标签: 宽基指数/行业ETF/主题ETF/跨境ETF

# ETF分类筛选 (ui.select)
- 全部ETF
- 宽基指数ETF (沪深300/中证500/创业板指)
- 行业ETF (科技/金融/医药/消费/新能源)
- 主题ETF (人工智能/半导体/军工/碳中和)
- 跨境ETF (恒生/纳斯达克/标普500)
- 债券ETF/商品ETF/黄金ETF

# ETF详情分析 (点击ETF展开ui.expansion)
- 基础信息卡片:
  - 基金全称
  - 管理人/托管人
  - 成立日期/当前规模  
  - 管理费率/托管费率
  - 跟踪指数权重前10

- 持仓明细表 (ui.table):
字段: 排名 | 成分股 | 持仓占比 | 涨跌幅 | 权重变化 | 市值

- 溢价率走势分析 (ui.plotly):
  - 近30日溢价率曲线
  - 历史均值线 (虚线)
  - 高溢价/低溢价机会标注
  - 套利空间可视化

# ETF套利机会监控 (ui.card)
- 高溢价ETF列表 (红色):
  - ETF溢价率 > 2%且成交活跃
  - 建议: 卖ETF申购ETF成分股
- 低溢价ETF列表 (绿色):
  - ETF折价率 > 2%且成交活跃  
  - 建议: 买入ETF赎回成分股
- 一键套利计算器:
  - 输入ETF代码和溢价率
  - 自动计算理论套利收益
  - 考虑申购赎回费用和滑点
```

### 3. 概念行情分析
**功能定位**: 追踪热门概念板块，表现轮动规律和投资机会

**组件结构**:
```python
# 概念板块涨跌排名 (ui.aggrid)
字段设计:
- 基础信息: 排名 | 概念名称 | 所属股票数 | 领涨股
- 表现数据: 板块涨跌幅 | 成交额 | 活跃度 | 主力净流入
- 持续性: 连涨天数 | 热度指数 | 关注度

热度计算:
热度指数 = 涨幅权重40% + 成交额权重30% + 活跃度权重20% + 关注度权重10%

# 概念成分股分析 (ui.expansion)
点击概念板块展开:
- 成分股表格 (ui.aggrid):
字段: 代码 | 名称 | 最新价 | 涨跌幅 | 成交额 | 所属概念数 | 概念活跃度

- 排序规则: 默认按涨跌幅降序
- 交互功能: 
  - 右键菜单: 加入自选股/查看K线
  - 批量操作: 全选/批量加入股票池

# 概念轮动分析 (ui.card)
- 热门概念追踪 (近7日):
  - 每日热门概念TOP3排行
  - 概念涨跌幅趋势图 (多条线叠加)
  - 持续性分析 (连续几天上涨的标记)

- 概念联动分析:
  - 概念间相关性热力图 (ui.plotly)
  - 产业链关系图 (概念概念间上下游关系)
  - 资金流向关联分析

# 自定义概念创建 (ui.dialog)
- 概念信息设置:
  - 概念名称 (ui.input)
  - 概念描述 (ui.textarea)
  - 概念标签 (ui.chip可添加)

- 成分股添加:
  - 股票选择器 (支持多选)
  - 权重设置 (可设置等权重或自定义权重)
  - 成分股导入 (支持CSV批量导入)

- 保存和管理:
  - 保存到概念库
  - 定时更新成分股
  - 概念表现对比
```

### 4. 竞价抢筹分析
**功能定位**: 分析集合竞价阶段的资金动向，捕捉开盘抢筹信号

**组件结构**:
```python
# 竞价数据监控 (ui.card, 盘中9:15-9:25)
- 竞价状态指示 (ui.badge):
  - 集合竞价中 (橙色)
  - 竞价结束 (绿色) 
  - 非竞价时间 (灰色)

- 竞价统计概览 (ui.row, 4列):
  - 竞价上涨家数: 1,256只 (大号红色)
  - 竞价下跌家数: 832只 (大号绿色)
  - 竞价涨停家数: 45只 (ui.badge红色)
  - 竞价总成交量: 125亿 (大号蓝色)

# 竞价抢筹排行榜 (ui.aggrid)
字段设计:
- 基础信息: 代码 | 名称 | 竞价涨幅 | 竞价价格 | 开盘预期
- 竞价数据: 竞价成交量 | 竞价换手率 | 量比 | 封单金额
- 抢筹信号: 主力净流入 | 资金流入强度 | 抢筹评分

抢筹信号分级:
- 高优先级 (红色): 竞价涨幅>7% + 放量成交
- 中优先级 (橙色): 竞价涨幅>5% + 持续买入
- 关注级别 (黄色): 竞价涨幅>3% + 异常放量

# 竞价分时分析 (ui.plotly)
- 竞价价格轨迹 (9:15-9:25):
  - 每分钟竞价价格变化曲线
  - 竞价成交量柱状图  
  - 关键时间点标注 (9:20封单、9:25撮合)

- 竞价资金流向:
  - 主力资金vs散户资金
  - 大单净买入统计
  - 竞价资金流向趋势

# 抢筹策略提示 (ui.list)
- 竞价涨停预案 (高优先级):
  - 竞价直接涨停+巨量 (9:20前封单)
  - 开盘一字板概率评估
  - 建议操作: 排队买入/关注开板

- 竞价放量突破 (中优先级):  
  - 竞价涨幅>7%+成交量放大
  - 开盘高开概率评估
  - 建议操作: 开盘追高/回调买入

- 竞价异动关注 (低优先级):
  - 竞价连续3日上涨
  - 异常放量需关注
  - 建议操作: 观察后续表现
```

### 5. 龙虎榜分析
**功能定位**: 分析上榜股票的机构和游资动向，学习顶级资金操作手法

**组件结构**:
```python
# 龙虎榜概览 (ui.tabs)
Tab1: 当日龙虎榜
- 上榜股票表 (ui.aggrid):
字段: 排名 | 代码 | 名称 | 涨跌幅 | 上榜原因 | 净买入额 | 买入席位 | 卖出席位 | 异常波动

上榜原因分类 (ui.chip):
- 日涨幅偏离值达7% (红色)
- 日换手率达20% (橙色)  
- 日跌幅偏离值达-7% (绿色)
- 连续3日涨幅偏离值累计20% (蓝色)

Tab2: 席位追踪分析
- 游资席位记录 (ui.aggrid):
字段: 席位名称 | 上榜次数 | 胜率 | 买入金额 | 净买入金额 | 代表股票 | 操作风格

席位分类标签:
- 知名游资 (金色标签): 赵老哥/孙哥/小鳄鱼等
- 机构席位 (蓝色标签): 机构专用席位
- 外资席位 (绿色标签): 沪/深股通专用席位

- 席位详情分析 (点击席位展开ui.expansion):
  - 近30日交易记录 (时间/股票/盈亏)
  - 买入后涨跌统计: 次日/3日/5日表现
  - 操作手法分析 (打板/低吸/趋势)

Tab3: 机构专用数据
- 机构买入排行 (ui.aggrid):
字段: 代码 | 名称 | 机构买入额 | 机构席位数 | 涨跌幅 | 后续1日表现 | 后续5日表现

- 机构买入特征分析:
  - 机构买入占流通市值比
  - 机构买入历史分位数
  - 机构集中度分析

# 龙虎榜选股器 (ui.card)
- 筛选条件设置:
  - 上榜原因 (多选)
  - 涨跌幅范围 (滑块)
  - 净买入额范围 (滑块)
  - 席位类型 (游资/机构/外资)
  - 时间范围 (近1日/近3日/近1周)

- 筛选结果排序:
  - 按净买入额排序
  - 按胜率排序  
  - 按后续表现排序

# 龙虎榜复盘分析 (ui.card)
- 成功案例分析:
  - 龙虎榜后1日/3日/5日涨跌统计
  - 胜率最高的上榜原因
  - 最赚钱的席位分析

- 失败案例警示:
  - 龙虎榜后下跌案例
  - 高位接盘风险
  - 主力出货信号
```

### 6. 机构荐股跟踪
**功能定位**: 汇总各大券商和研究机构的投资建议，跟踪命中率

**组件结构**:
```python
# 机构评级汇总 (ui.tabs)
Tab1: 最新评级
- 评级表 (ui.aggrid):
字段: 日期 | 股票代码 | 股票名称 | 评级机构 | 分析师 | 评级 | 目标价 | 现价 | 上涨空间

评级等级:
- 买入 (深红色): 预期涨幅>20%
- 增持 (红色): 预期涨幅10-20%
- 中性 (灰色): 预期涨幅-10%~10%
- 减持 (绿色): 预期涨幅-10%~-20%
- 卖出 (深绿色): 预期跌幅>20%

Tab2: 评级变化跟踪
- 评级上调/下调列表:
  - 评级上调: 卖出→中性→增持→买入
  - 评级下调: 买入→增持→中性→减持→卖出
  - 重点关注: 评级大幅变动股票

Tab3: 机构准确率
- 机构表现排行 (ui.aggrid):
字段: 机构名称 | 评级次数 | 1月准确率 | 3月准确率 | 6月准确率 | 平均涨幅 | 最佳推荐

# 研报分析工具 (ui.card)
- 研报筛选器:
  - 机构类型: 券商/基金/外资投行
  - 研报类型: 深度/快评/点评
  - 目标价空间: >20%/10-20%/-10%~10%/<-10%
  - 关注度: 高/中/低

- 研报内容分析:
  - 核心逻辑提取 (NLP分析)
  - 关键财务数据整理
  - 风险提示汇总
  - 相关概念标签

# 机构调研跟踪 (ui.expansion)
- 调研活动统计:
  - 近期调研股票排行
  - 调研机构类型分布
  - 调研频次与股价关系
- 业绩说明会跟踪:
  - 业绩预告/快报发布时间
  - 业绩说明会日程
  - 重要问答内容整理
```

### 7. 问财筛选器
**功能定位**: 自然语言股票筛选，类似同花顺问财功能

**组件结构**:
```python
# 智能问财输入 (ui.tabs)
Tab1: 自然语言输入
- 问财输入框 (ui.textarea, 大号):
  提示示例:
  - "涨停板股票"
  - "连续3天上涨"
  - "PE<20且PB<3"
  - "北向资金加仓"
  - "MACD金叉的股票"
  - "最近1周机构买入评级"

- 快捷问财 (ui.chip):
  🏆 涨停板 | 📈 连续上涨 | 💰 低估值 | 🌊 资金流入
  📊 技术金叉 | 🏢 机构买入 | 📰 业绩预增 | 🔥 热门概念

Tab2: 条件构建器
- 条件分组 (可添加多个条件组):
  
  条件组1:
  - 指标选择 (ui.select): 涨跌幅/成交量/PE/PB/RSI/MACD/市值
  - 操作符 (ui.select): > / < / = / >= / <= / between / not in
  - 数值输入 (ui.input): 具体数值或范围
  - 逻辑连接 (ui.select): AND / OR

  条件组2:
  - 逻辑关系 (ui.select): AND / OR
  - 重复上述步骤...

- 快捷条件模板 (ui.list):
  ✓ 涨幅>5%
  ✓ 量比>2
  ✓ PE<20
  ✓ 主力净流入>1亿
  ✓ 北向资金增持
  ✓ 机构买入评级
  ✓ 龙虎榜游资买入
  ✓ MACD金叉
  ✓ RSI<30超卖
  ✓ 布林带下轨反弹

# 筛选结果展示 (ui.aggrid)
结果表格字段:
- 基础信息: 代码 | 名称 | 最新价 | 涨跌幅 | 成交量
- 匹配信息: 符合条件数 | 符合度 | 排名 | 匹配详情

符合度计算:
符合度 = 符合条件数 / 总条件数 × 100%

结果排序:
- 默认按符合度降序
- 可切换按涨幅/成交量/市值排序

# 条件保存和管理 (ui.card)
- 保存当前条件 (ui.button):
  - 条件名称 (ui.input)
  - 条件描述 (ui.textarea)
  - 设为定时任务 (ui.checkbox)
  
- 我的条件库 (ui.list):
  - 条件名称 | 创建时间 | 使用次数 | 最后使用
  - 操作: 加载/编辑/删除/分享/定时执行

- 条件分享:
  - 生成分享链接
  - 导出条件配置
  - 导入他人条件
```

### 8. 数据存储设计

**PostgreSQL表结构**:
```sql
-- 资金流向历史数据
CREATE TABLE fund_flow_history (
    flow_id SERIAL PRIMARY KEY,
    trade_date DATE,
    stock_code VARCHAR(10),
    super_large_inflow DECIMAL(15,2),  -- 超大单流入
    large_inflow DECIMAL(15,2),        -- 大单流入
    medium_inflow DECIMAL(15,2),       -- 中单流入
    small_inflow DECIMAL(15,2),        -- 小单流入
    net_inflow DECIMAL(15,2),          -- 净流入
    create_time TIMESTAMP DEFAULT NOW()
);

-- ETF基础信息
CREATE TABLE etf_info (
    etf_code VARCHAR(10) PRIMARY KEY,
    etf_name VARCHAR(100),
    fund_type VARCHAR(50),  -- 宽基指数/行业ETF/主题ETF
    tracking_index VARCHAR(100),
    fund_scale DECIMAL(15,2),
    management_fee DECIMAL(5,4),
    tracking_error DECIMAL(10,4),
    create_time TIMESTAMP DEFAULT NOW()
);

-- 龙虎榜数据
CREATE TABLE dragon_tiger_list (
    record_id SERIAL PRIMARY KEY,
    trade_date DATE,
    stock_code VARCHAR(10),
    stock_name VARCHAR(50),
    list_reason VARCHAR(100),
    net_buy_amount DECIMAL(15,2),
    buy_seats JSONB,  -- 买入席位
    sell_seats JSONB, -- 卖出席位
    turnover_rate DECIMAL(10,4)
);

-- 机构评级数据
CREATE TABLE institution_rating (
    rating_id SERIAL PRIMARY KEY,
    rating_date DATE,
    stock_code VARCHAR(10),
    institution VARCHAR(100),
    analyst VARCHAR(50),
    rating VARCHAR(20),  -- 买入/增持/中性/减持/卖出
    target_price DECIMAL(10,2),
    current_price DECIMAL(10,2),
    report_link TEXT
);

-- 问财策略库
CREATE TABLE wencai_strategies (
    strategy_id SERIAL PRIMARY KEY,
    strategy_name VARCHAR(100),
    condition_text TEXT,  -- 自然语言描述
    condition_rules JSONB, -- 解析后的条件规则
    create_time TIMESTAMP DEFAULT NOW(),
    use_count INT DEFAULT 0,
    is_public BOOLEAN DEFAULT false,
    auto_run BOOLEAN DEFAULT false,
    run_schedule VARCHAR(50)  -- cron表达式
);
```

**TDengine表结构**:
```sql
-- 实时资金流向(高频)
CREATE STABLE realtime_fund_flow (
    ts TIMESTAMP,
    stock_code NCHAR(10),
    net_flow DECIMAL(15,2),
    large_order_inflow DECIMAL(15,2),
    small_order_inflow DECIMAL(15,2)
) TAGS (
    market NCHAR(10)
);

-- ETF溢价率追踪
CREATE STABLE etf_premium (
    ts TIMESTAMP,
    etf_code NCHAR(10),
    premium_rate DECIMAL(8,4),  -- 溢价率
    tracking_error DECIMAL(8,4)  -- 跟踪误差
) TAGS (
    fund_type NCHAR(20)
);

-- 概念板块热度
CREATE STABLE concept_heatmap (
    ts TIMESTAMP,
    concept_name NCHAR(50),
    heat_index DECIMAL(8,4),     -- 热度指数
    stock_count INT,             -- 成分股数量
    avg_change DECIMAL(8,4)      -- 平均涨跌幅
) TAGS (
    category NCHAR(20)  -- 行业/概念
);
```

## 性能优化

### 数据缓存策略
```python
# Redis缓存设计
import redis
r = redis.Redis(host='localhost', port=6379, db=2)

class MarketDataCache:
    def get_fund_flow(self, symbol, period='1d'):
        cache_key = f"fund_flow:{symbol}:{period}"
        cached = r.get(cache_key)
        if cached:
            return json.loads(cached)
        
        # 从数据库获取并缓存
        data = self.calculate_fund_flow(symbol, period)
        r.setex(cache_key, 300, json.dumps(data))  # 5分钟过期
        return data
    
    def get_concept_heatmap(self):
        cache_key = "concept_heatmap:daily"
        cached = r.get(cache_key)
        if cached:
            return json.loads(cached)
        
        # 实时计算概念热度
        data = self.calculate_concept_heatmap()
        r.setex(cache_key, 600, json.dumps(data))  # 10分钟过期
        return data
```

### 异步数据处理
```python
# 大数据量异步处理
import asyncio
import aiohttp
from concurrent.futures import ThreadPoolExecutor

class AsyncMarketDataProcessor:
    def __init__(self):
        self.executor = ThreadPoolExecutor(max_workers=10)
        self.session = aiohttp.ClientSession()
    
    async def process_batch_fund_flow(self, symbols):
        # 批量获取资金流向数据
        tasks = []
        for symbol in symbols:
            task = asyncio.create_task(
                self.get_symbol_fund_flow(symbol)
            )
            tasks.append(task)
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        return [r for r in results if not isinstance(r, Exception)]
    
    async def calculate_concept_performance(self, concepts):
        # 并行计算概念板块表现
        loop = asyncio.get_event_loop()
        tasks = [
            loop.run_in_executor(
                self.executor, 
                self.calculate_concept_metrics, 
                concept
            ) for concept in concepts
        ]
        return await asyncio.gather(*tasks)
```

## API接口设计

### 资金流向接口
```python
# 获取个股资金流向
GET /api/v1/fundflow/stock/{symbol}
参数: period=3d&start_date=2025-01-01&end_date=2025-01-31

# 获取板块资金流向  
GET /api/v1/fundflow/sector/{sector_name}
参数: period=5d

# 获取北向资金数据
GET /api/v1/fundflow/northbound
参数: period=30d
```

### ETF相关接口
```python
# 获取ETF列表
GET /api/v1/etf/list
参数: type=industry&min_scale=10&max_scale=1000

# 获取ETF溢价率
GET /api/v1/etf/premium/{etf_code}
参数: period=30d

# 获取ETF成分股
GET /api/v1/etf/holdings/{etf_code}
参数: limit=10
```

### 龙虎榜接口
```python
# 获取龙虎榜数据
GET /api/v1/dragon-tiger/list
参数: date=2025-11-12&reason=limit_up

# 获取席位数据
GET /api/v1/dragon-tiger/seat/{seat_name}
参数: period=30d
```

### 问财筛选接口
```python
# 自然语言筛选
POST /api/v1/wencai/filter
Body: {
    "query": "MACD金叉且RSI<30的股票",
    "limit": 100,
    "sort": "change_pct_desc"
}

# 获取问财建议
GET /api/v1/wencai/suggestions
返回: 常用问财语句和示例
```

## MVP验收标准
1. **基础数据展示**: 能正确显示资金流向、ETF、概念等基础数据
2. **筛选功能**: 问财筛选器能正确解析并执行筛选条件
3. **实时更新**: 龙虎榜、竞价数据能及时更新
4. **数据准确性**: 显示的溢价率、资金流向等数据与数据源一致
5. **导出功能**: 支持筛选结果导出为CSV/Excel

## 开发优先级
1. **P0**: 资金流向基础功能 + ETF行情
2. **P1**: 概念板块分析 + 龙虎榜数据
3. **P2**: 竞价抢筹 + 机构荐股跟踪  
4. **P3**: 问财筛选器 + 智能建议
5. **P4**: 高级分析工具 + 数据导出

---

**Owner**: 数据工程 + 前端(NiceGUI) + 后端工程师  
**技术难点**: 自然语言解析、大数据量处理、实时数据同步  
**预计开发时间**: 3周  
**依赖关系**: 需要akshare/tushare数据接入、NLP处理库
