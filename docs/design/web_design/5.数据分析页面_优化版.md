# 5. æ•°æ®åˆ†æé¡µé¢_ä¼˜åŒ–ç‰ˆ

## åŠŸèƒ½å®šä½

æä¾›æŠ€æœ¯æŒ‡æ ‡ã€è‡ªå®šä¹‰æŒ‡æ ‡ã€æ¡ä»¶ç­›é€‰ã€å› å­åˆ†æçš„å®Œæ•´é‡åŒ–åˆ†æå·¥å…·ç®±ï¼Œæ”¯æŒKçº¿å›¾å¯è§†åŒ–å’Œæ‰¹é‡è®¡ç®—ï¼Œæ˜¯ç­–ç•¥æ„å»ºä¸ä¿¡å·äº§ç”Ÿçš„æ ¸å¿ƒå·¥å…·ã€‚

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### Tab1: æŠ€æœ¯æŒ‡æ ‡åˆ†æ (Technical Indicators Analysis)

#### TA-LibæŒ‡æ ‡åº“é›†æˆ
```python
# å·¦ä¾§æŒ‡æ ‡æ ‘å½¢ç»“æ„ (ui.left_drawer)
technical_indicators_tree = ui.tree([
    ui.tree_node("ğŸ“ˆ è¶‹åŠ¿æŒ‡æ ‡", icon="trending_up", color="blue", children=[
        ui.tree_node("MA (ç§»åŠ¨å¹³å‡çº¿)", icon="show_chart", on_click=lambda: load_indicator_params('MA')),
        ui.tree_node("EMA (æŒ‡æ•°å¹³å‡)", icon="timeline", on_click=lambda: load_indicator_params('EMA')),
        ui.tree_node("MACD", icon="multiline_chart", on_click=lambda: load_indicator_params('MACD')),
        ui.tree_node("BOLL (å¸ƒæ—å¸¦)", icon="view_week", on_click=lambda: load_indicator_params('BOLL')),
        ui.tree_node("SAR (æŠ›ç‰©è½¬å‘)", icon="speed", on_click=lambda: load_indicator_params('SAR'))
    ]),
    ui.tree_node("âš¡ åŠ¨é‡æŒ‡æ ‡", icon="flash_on", color="orange", children=[
        ui.tree_node("RSI (ç›¸å¯¹å¼ºå¼±)", icon="sensors", on_click=lambda: load_indicator_params('RSI')),
        ui.tree_node("KDJ (éšæœºæŒ‡æ ‡)", icon="blur_circular", on_click=lambda: load_indicator_params('KDJ')),
        ui.tree_node("CCI (å•†å“é€šé“)", icon="grid_on", on_click=lambda: load_indicator_params('CCI')),
        ui.tree_node("WR (å¨å»‰æŒ‡æ ‡)", icon="data_usage", on_click=lambda: load_indicator_params('WR'))
    ]),
    ui.tree_node("ğŸ“Š æˆäº¤é‡æŒ‡æ ‡", icon("bar_chart"), color="green", children=[
        ui.tree_node("VOL (æˆäº¤é‡)", icon("equalizer"), on_click=lambda: load_indicator_params('VOL')),
        ui.tree_node("OBV (èƒ½é‡æ½®)", icon("waves"), on_click=lambda: load_indicator_params('OBV')),
        ui.tree_node("VROC (æˆäº¤é‡å˜åŠ¨ç‡)", icon("show_chart"), on_click=lambda: load_indicator_params('VROC'))
    ]),
    ui.tree_node("ğŸŒŠ æ³¢åŠ¨ç‡æŒ‡æ ‡", icon("water_drop"), color="purple", children=[
        ui.tree_node("ATR (å¹³å‡çœŸå®èŒƒå›´)", icon("timeline"), on_click=lambda: load_indicator_params('ATR')),
        ui.tree_node("KC (è‚¯ç‰¹çº³é€šé“)", icon("grid_4x4"), on_click=lambda: load_indicator_params('KC'))
    ]),
    ui.tree_node("ğŸ” å½¢æ€è¯†åˆ«", icon("search"), color="red", children=[
        ui.tree_node("CDLç³»åˆ— (30+Kçº¿å½¢æ€)", icon("gesture"), on_click=lambda: load_indicator_params('CDL'))
    ])
])
```

#### æŒ‡æ ‡å‚æ•°é…ç½®å™¨
```python
# å³ä¾§å‚æ•°é…ç½®é¢æ¿ (ui.card)
with ui.card().style("height: 100%;"):
    ui.label("æŒ‡æ ‡å‚æ•°é…ç½®").style("font-size: 16px; font-weight: bold;")

    # åŠ¨æ€å‚æ•°è¡¨å•
    params_form = ui.form()

    # MACDå‚æ•°é…ç½®ç¤ºä¾‹
    with params_form:
        ui.number("å¿«çº¿å‘¨æœŸ", value=12, min=1, max=50, label="MACDå¿«çº¿å‘¨æœŸ")
        ui.number("æ…¢çº¿å‘¨æœŸ", value=26, min=1, max=100, label="MACDæ…¢çº¿å‘¨æœŸ")
        ui.number("ä¿¡å·çº¿å‘¨æœŸ", value=9, min=1, max=50, label="MACDä¿¡å·çº¿å‘¨æœŸ")

        ui.number("RSIå‘¨æœŸ", value=14, min=2, max=100, label="RSIè®¡ç®—å‘¨æœŸ")
        ui.number("BOLLå‘¨æœŸ", value=20, min=5, max=100, label="å¸ƒæ—å¸¦å‘¨æœŸ")
        ui.number("BOLLå€æ•°", value=2.0, min=0.1, max=10.0, step=0.1, label="å¸ƒæ—å¸¦å€æ•°")

    # ä¿å­˜é…ç½®æŒ‰é’®
    with ui.row().style("margin-top: 16px; gap: 8px"):
        ui.button("ä¿å­˜é…ç½®", icon="save", on_click=save_indicator_config)
        ui.button("é‡ç½®", icon="refresh", on_click=reset_params_form)
```

#### Kçº¿å›¾ä¸æŠ€æœ¯æŒ‡æ ‡å¯è§†åŒ–
```python
# ä¸»å›¾è¡¨åŒºåŸŸ (ui.column)
with ui.row().style("height: 600px;"):

    # Kçº¿ä¸»å›¾ + æŒ‡æ ‡å åŠ  (70%)
    with ui.card().style("width: 70%; height: 100%;"):
        ui.label("Kçº¿å›¾ä¸æŠ€æœ¯æŒ‡æ ‡").style("font-size: 16px; font-weight: bold;")

        # Klinechart Kçº¿å›¾é›†æˆ
        kline_html = """
        <div id="technical_analysis_kline" style="height: 500px; background: #1a1a1a; border-radius: 8px;"></div>
        <script>
            // åˆå§‹åŒ–æŠ€æœ¯åˆ†æKçº¿å›¾
            function initTechnicalKline(stockCode) {
                new TradingView.widget({
                    "width": "100%",
                    "height": "100%",
                    "symbol": stockCode,
                    "interval": "D",
                    "timezone": "Asia/Shanghai",
                    "theme": "dark",
                    "style": "1",
                    "locale": "zh_CN",
                    "toolbar_bg": "#1a1a1a",
                    "enable_publishing": false,
                    "allow_symbol_change": false,
                    "container_id": "technical_analysis_kline",
                    "hide_side_toolbar": false,
                    "studies": [
                        "MACD@tv-basicstudies",
                        "RSI@tv-basicstudies",
                        "KDJ@tv-basicstudies",
                        "BollingerBands@tv-basicstudies"
                    ],
                    "disabled_features": ["use_localstorage_for_settings"],
                    "enabled_features": ["study_templates"],
                    "autosize": true,
                    "overrides": {
                        "paneProperties.background": "#1a1a1a",
                        "paneProperties.vertGridProperties.color": "#363c4e",
                        "paneProperties.horzGridProperties.color": "#363c4e",
                        "symbolWatermarkProperties.transparency": 90,
                        "scalesProperties.textColor": "#AAA"
                    }
                });
            }

            // é»˜è®¤åŠ è½½æµ¦å‘é“¶è¡Œ
            initTechnicalKline("600000");
        </script>
        """
        ui.html(kline_html)

        # è‚¡ç¥¨é€‰æ‹©å™¨
        with ui.row().style("margin-top: 8px; gap: 8px; align-items: center"):
            ui.label("åˆ†æè‚¡ç¥¨:").style("font-weight: bold;")
            stock_selector = ui.select(['600000', '000001', '300059', '000858'], value='600000')
            ui.button("åˆ‡æ¢", icon="refresh", on_click=lambda: switch_analysis_stock(stock_selector.value))

    # æŠ€æœ¯æŒ‡æ ‡å‰¯å›¾ (30%)
    with ui.column().style("width: 30%; height: 100%; overflow-y: auto;">

        # æŒ‡æ ‡è®¡ç®—çŠ¶æ€
        with ui.card().style("margin-bottom: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white"):
            ui.label("æŒ‡æ ‡è®¡ç®—çŠ¶æ€").style("font-weight: bold; margin-bottom: 8px")
            calc_status = ui.label("å‡†å¤‡å°±ç»ª").style("font-size: 14px")

        # è®¡ç®—è¿›åº¦æ¡
        calc_progress = ui.linear_progress(value=0, color="positive").style("margin-bottom: 10px")
        calc_logs = ui.log().style("height: 150px; background: #f5f5f5; font-family: monospace; font-size: 12px")

        # è®¡ç®—ç»“æœç»Ÿè®¡
        with ui.card().style("margin-bottom: 10px; background: #f8f9fa"):
            ui.label("è®¡ç®—ç»Ÿè®¡").style("font-weight: bold; margin-bottom: 8px")
            with ui.row().style("gap: 16px"):
                stat_card1 = ui.card().style("background: white; padding: 8px; text-align: center; min-width: 80px")
                with stat_card1:
                    ui.label("0").style("font-size: 18px; font-weight: bold; color: #dc3545")
                    ui.label("å¼ºä¿¡å·").style("font-size: 10px; color: #666")

                stat_card2 = ui.card().style("background: white; padding: 8px; text-align: center; min-width: 80px")
                with stat_card2:
                    ui.label("0").style("font-size: 18px; font-weight: bold; color: #fd7e14")
                    ui.label("ä¸­ä¿¡å·").style("font-size: 10px; color: #666")

                stat_card3 = ui.card().style("background: white; padding: 8px; text-align: center; min-width: 80px")
                with stat_card3:
                    ui.label("0").style("font-size: 18px; font-weight: bold; color: #28a745")
                    ui.label("å¼±ä¿¡å·").style("font-size: 10px; color: #666")
```

### Tab2: è‡ªå®šä¹‰æŒ‡æ ‡ç¼–è¾‘å™¨ (Custom Indicator Editor)

#### ä»£ç ç¼–è¾‘å™¨ç•Œé¢
```python
# å·¦ä¾§ä»£ç ç¼–è¾‘å™¨ (ui.column)
with ui.column().style("width: 50%; height: 100%;">
    ui.label("è‡ªå®šä¹‰æŒ‡æ ‡ç¼–è¾‘å™¨").style("font-size: 16px; font-weight: bold;")

    # æŒ‡æ ‡æ¨¡æ¿é€‰æ‹©
    with ui.row():
        template_selector = ui.select([
            'å¨ç§‘å¤«é‡ä»·åˆ†æ', 'ç¼ è®ºç¬”æ®µè¯†åˆ«', 'èµ„é‡‘æµå¼ºåº¦', 'æ¿å—è”åŠ¨æŒ‡æ•°', 'è‡ªå®šä¹‰æ¨¡æ¿'
        ], label='æŒ‡æ ‡æ¨¡æ¿', value='å¨ç§‘å¤«é‡ä»·åˆ†æ').style("width: 200px;")
        ui.button("åŠ è½½æ¨¡æ¿", icon="folder_open", on_click=load_indicator_template)

    # Pythonä»£ç ç¼–è¾‘å™¨
    code_editor_html = """
    <div id="code_editor" style="height: 400px; border: 1px solid #ddd; border-radius: 4px;"></div>
    <script>
        // åˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
        var editor = CodeMirror(document.getElementById("code_editor"), {
            mode: "python",
            theme: "default",
            lineNumbers: true,
            lineWrapping: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            value: `# å¨ç§‘å¤«é‡ä»·åˆ†æç¤ºä¾‹
import talib
import pandas as pd
import numpy as np

def wyckoff_analysis(df):
    \"\"\"
    å¨ç§‘å¤«é‡ä»·åˆ†æ
    è¯†åˆ«Springå’ŒUpthrustä¿¡å·
    \"\"\"
    # è®¡ç®—ä»·æ ¼å˜åŒ–å’Œæˆäº¤é‡å˜åŒ–
    price_change = df['close'].pct_change()
    volume_change = df['volume'].pct_change()

    # Springä¿¡å·è¯†åˆ«
    spring_condition = (
        (price_change.shift(1) < -0.02) &  # å‰ä¸€æ—¥å¤§è·Œ
        (volume_change > 0.5) &            # æˆäº¤é‡æ”¾å¤§
        (price_change > 0.03)              # å½“æ—¥åå¼¹
    )

    # Upthrustä¿¡å·è¯†åˆ«
    upthrust_condition = (
        (price_change.shift(1) > 0.03) &   # å‰ä¸€æ—¥å¤§æ¶¨
        (volume_change < -0.3) &           # æˆäº¤é‡èç¼©
        (price_change < -0.02)             # å½“æ—¥ä¸‹è·Œ
    )

    # è®¡ç®—ç»¼åˆä¿¡å·å¼ºåº¦
    signal_strength = (
        spring_condition.astype(int) * 1 +    # Springä¿¡å· +1åˆ†
        upthrust_condition.astype(int) * (-1) # Upthrustä¿¡å· -1åˆ†
    )

    return {
        'spring_signal': spring_condition,
        'upthrust_signal': upthrust_condition,
        'signal_strength': signal_strength,
        'recommendation': np.where(signal_strength > 0, 'BUY',
                                 np.where(signal_strength < 0, 'SELL', 'HOLD'))
    }

# ä¸»å‡½æ•°å…¥å£
def main(df):
    result = wyckoff_analysis(df)
    return result

# æµ‹è¯•ç¤ºä¾‹
if __name__ == "__main__":
    # ä½¿ç”¨ç¤ºä¾‹æ•°æ®è¿›è¡Œæµ‹è¯•
    print("å¨ç§‘å¤«é‡ä»·åˆ†ææ¨¡å—å·²åŠ è½½")
`
        });

        // ä»£ç æç¤º
        editor.setOption("extraKeys", {
            "Ctrl-Space": "autocomplete",
            "Ctrl-S": function(cm) {
                saveCustomIndicator();
            }
        });
    </script>
    """
    ui.html(code_editor_html)

    # æŒ‡æ ‡å‚æ•°é…ç½®
    with ui.card().style("margin-top: 10px;">
        ui.label("æŒ‡æ ‡å‚æ•°").style("font-weight: bold;")

        custom_params_form = ui.form()
        with custom_params_form:
            ui.number("è®¡ç®—å‘¨æœŸ", value=20, min=1, max=200, label="æ»šåŠ¨è®¡ç®—å‘¨æœŸ")
            ui.number("Springé˜ˆå€¼", value=0.02, min=0.001, max=0.1, step=0.001, label="Springä¿¡å·é˜ˆå€¼")
            ui.number("Upthrusté˜ˆå€¼", value=0.03, min=0.001, max=0.1, step=0.001, label="Upthrustä¿¡å·é˜ˆå€¼")
            ui.checkbox("å¯ç”¨å®æ—¶è®¡ç®—", value=True)
            ui.checkbox("ç”Ÿæˆä¹°å–å»ºè®®", value=True)

# å³ä¾§ç»“æœé¢„è§ˆ (ui.column)
with ui.column().style("width: 50%; height: 100%;>
    ui.label("æŒ‡æ ‡ç»“æœé¢„è§ˆ").style("font-size: 16px; font-weight: bold;")

    # æµ‹è¯•è‚¡ç¥¨é€‰æ‹©
    with ui.row():
        test_stock_selector = ui.select(['600000.SS', '000001.SZ', '300059.SZ', '000858.SZ'],
                                      label='æµ‹è¯•è‚¡ç¥¨', value='600000.SS')
        ui.button("è¿è¡Œè®¡ç®—", icon="play_arrow", on_click=run_indicator_calculation)

    # è®¡ç®—ç»“æœè¡¨æ ¼
    result_grid = ui.aggrid(
        options={
            "rowData": [],
            "columnDefs": [
                {"field": "date", "headerName": "æ—¥æœŸ", "width": 100},
                {"field": "close", "headerName": "æ”¶ç›˜ä»·", "width": 100},
                {"field": "spring_signal", "headerName": "Springä¿¡å·", "width": 100,
                 "cellRenderer": "signalRenderer"},
                {"field": "upthrust_signal", "headerName": "Upthrustä¿¡å·", "width": 100,
                 "cellRenderer": "signalRenderer"},
                {"field": "signal_strength", "headerName": "ä¿¡å·å¼ºåº¦", "width": 120,
                 "cellRenderer": "scoreRenderer"},
                {"field": "recommendation", "headerName": "å»ºè®®", "width": 100,
                 "cellRenderer": "actionRenderer"}
            ]
        }
    ).style("height: 250px; margin-bottom: 10px;")

    # æŒ‡æ ‡å›¾è¡¨é¢„è§ˆ
    indicator_chart_html = """
    <div id="indicator_preview_chart" style="height: 250px; background: #f8f9fa; border-radius: 8px;"></div>
    <script>
        var previewChart = LightweightCharts.createChart('indicator_preview_chart', {
            height: 250,
            layout: { background: { color: '#ffffff' }, textColor: '#333' },
            timeScale: { timeVisible: true, secondsVisible: false }
        });

        // ç”Ÿæˆæ¨¡æ‹ŸKçº¿æ•°æ®ç”¨äºé¢„è§ˆ
        function generateSampleData() {
            const data = [];
            const basePrice = 10;
            const now = Date.now();

            for (let i = 30; i >= 0; i--) {
                const time = (now - i * 24 * 60 * 60 * 1000) / 1000;
                const open = basePrice + Math.random() * 2 - 1;
                const close = open + Math.random() * 2 - 1;
                const high = Math.max(open, close) + Math.random();
                const low = Math.min(open, close) - Math.random();

                data.push({ time, open, high, low, close });
            }

            return data;
        }

        const sampleData = generateSampleData();
        previewChart.addCandlestickSeries().setData(sampleData);
    </script>
    """
    ui.html(indicator_chart_html)
```

### Tab3: æ¡ä»¶ç­›é€‰å™¨ (Custom Filter Builder)

#### å¤šæ¡ä»¶æ„å»ºå™¨
```python
# æ¡ä»¶æ„å»ºé¢æ¿
with ui.card():
    ui.label("æ¡ä»¶ç­›é€‰å™¨").style("font-size: 16px; font-weight: bold; margin-bottom: 10px;")

    # æ¡ä»¶ç»„åˆ—è¡¨
    conditions_container = ui.column()

    def add_condition_group(group_index: int = None):
        """æ·»åŠ æ–°çš„æ¡ä»¶ç»„"""
        if group_index is None:
            group_index = len(condition_groups)

        condition_group = ui.card().style("margin-bottom: 10px; border-left: 3px solid #2196F3;")

        with condition_group:
            ui.label(f"æ¡ä»¶ç»„ {group_index + 1}").style("font-weight: bold; color: #2196F3;")

            # æ¡ä»¶åˆ—è¡¨
            conditions_list = ui.column()

            def add_condition(parent_conditions_list):
                """æ·»åŠ å•ä¸ªæ¡ä»¶"""
                condition_row = ui.row().style("margin-bottom: 5px; align-items: center")

                with condition_row:
                    # æŒ‡æ ‡é€‰æ‹©
                    indicator_select = ui.select([
                        'æœ€æ–°ä»·', 'æ¶¨è·Œå¹…(%)', 'æˆäº¤é‡', 'æˆäº¤é¢', 'æ¢æ‰‹ç‡(%)',
                        'PE', 'PB', 'ROE(%)', 'å‡€åˆ©æ¶¦å¢é•¿ç‡(%)', 'è¥æ”¶å¢é•¿ç‡(%)',
                        'MACDä¿¡å·', 'RSIå€¼', 'KDJé‡‘å‰', 'BOLLä½ç½®', 'ä¸»åŠ›å‡€æµå…¥(ä¸‡å…ƒ)',
                        'åŒ—å‘èµ„é‡‘(ä¸‡è‚¡)', 'æœºæ„æŒä»“(%)'
                    ], label='æŒ‡æ ‡', style="width: 120px;")

                    # æ“ä½œç¬¦é€‰æ‹©
                    operator_select = ui.select(['>', '<', '=', '>=', '<=', 'between'],
                                               style="width: 80px;")

                    # æ•°å€¼è¾“å…¥ (å¼€å§‹)
                    value_input = ui.input(placeholder='æ•°å€¼', style="width: 100px;")

                    # æ•°å€¼è¾“å…¥ (ç»“æŸ, ç”¨äºbetween)
                    value_input_end = ui.input(placeholder='ç»“æŸå€¼', style="width: 100px; display: none;")

                    # æ·»åŠ æ¡ä»¶æŒ‰é’®
                    ui.button("+", icon="add", on_click=lambda: add_condition(conditions_list)).style("width: 30px;")

                    # åˆ é™¤æ¡ä»¶æŒ‰é’®
                    ui.button("-", icon="remove", on_click=lambda: condition_row.remove()).style("width: 30px;")

            # æ·»åŠ ç¬¬ä¸€ä¸ªæ¡ä»¶
            add_condition(conditions_list)

            # æ·»åŠ æ›´å¤šæ¡ä»¶æŒ‰é’®
            ui.button("æ·»åŠ æ¡ä»¶", icon="add", on_click=lambda: add_condition(conditions_list))

        conditions_container.move(condition_group, conditions_container.children[-1] if conditions_container.children else None)
        condition_groups.append(condition_group)

    # åˆå§‹åŒ–ç¬¬ä¸€ä¸ªæ¡ä»¶ç»„
    add_condition_group()

    # å¿«æ·æ¡ä»¶æ ‡ç­¾
    with ui.card().style("background: #f5f5f5; margin-top: 10px; padding: 12px;">
        ui.label("å¿«æ·æ¡ä»¶:").style("font-weight: bold; margin-bottom: 8px")

        quick_conditions = [
            ("æ¶¨å¹…>5%", lambda: add_quick_condition("æ¶¨è·Œå¹…(%)", ">", 5)),
            ("é‡æ¯”>2", lambda: add_quick_condition("æ¢æ‰‹ç‡(%)", ">", 2)),
            ("PE<20", lambda: add_quick_condition("PE", "<", 20)),
            ("MACDé‡‘å‰", lambda: add_quick_condition("MACDä¿¡å·", "=", "é‡‘å‰")),
            ("RSIè¶…å–", lambda: add_quick_condition("RSIå€¼", "<", 30)),
            ("ä¸»åŠ›å‡€æµå…¥>1000ä¸‡", lambda: add_quick_condition("ä¸»åŠ›å‡€æµå…¥(ä¸‡å…ƒ)", ">", 1000))
        ]

        for condition_text, condition_action in quick_conditions:
            ui.button(condition_text, on_click=condition_action).style("margin: 2px;")

# ç­›é€‰ç»“æœå±•ç¤º
with ui.card().style("margin-top: 20px;">
    ui.label("ç­›é€‰ç»“æœ").style("font-size: 16px; font-weight: bold; margin-bottom: 10px;")

    # ç»“æœç»Ÿè®¡
    with ui.row():
        ui.label("ç¬¦åˆæ¡ä»¶è‚¡ç¥¨: ").style("font-weight: bold;")
        result_count = ui.label("0").style("color: #2196F3; font-weight: bold; font-size: 18px")
        ui.button("é‡æ–°ç­›é€‰", icon="refresh", on_click=apply_filters)
        ui.button("ä¿å­˜æ¡ä»¶", icon="save", on_click=save_filter_condition)
        ui.button("å¯¼å‡ºç»“æœ", icon="download", on_click=export_filter_results)

    # ç»“æœè¡¨æ ¼
    filter_results_grid = ui.aggrid(
        options={
            "rowData": [],
            "columnDefs": [
                {"field": "code", "headerName": "ä»£ç ", "width": 100, "pinned": "left"},
                {"field": "name", "headerName": "åç§°", "width": 120, "pinned": "left"},
                {"field": "current_price", "headerName": "æœ€æ–°ä»·", "width": 100},
                {"field": "change_pct", "headerName": "æ¶¨è·Œå¹…(%)", "width": 100,
                 "cellClassRules": {
                     "text-positive": "data.change_pct > 0",
                     "text-negative": "data.change_pct < 0"
                 }},
                {"field": "volume", "headerName": "æˆäº¤é‡", "width": 120},
                {"field": "pe_ratio", "headerName": "PE", "width": 80},
                {"field": "macd_signal", "headerName": "MACDä¿¡å·", "width": 100},
                {"field": "rsi_value", "headerName": "RSIå€¼", "width": 100},
                {"field": "main_capital", "headerName": "ä¸»åŠ›å‡€æµå…¥(ä¸‡)", "width": 120},
                {"field": "match_score", "headerName": "ç¬¦åˆåº¦", "width": 100,
                 "cellRenderer": "scoreRenderer"},
                {"field": "kline_action", "headerName": "Kçº¿å›¾", "width": 80,
                 "cellRenderer": "klineButtonRenderer"},
                {"field": "actions", "headerName": "æ“ä½œ", "width": 150,
                 "cellRenderer": "resultActionButtons"}
            ],
            "defaultColDef": {"sortable": True, "filter": True, "resizable": True}
        }
    )
```

### Tab4: å› å­åˆ†æ (Factor Analysis)

#### å› å­åº“ç®¡ç†
```python
# å·¦ä¾§å› å­åˆ†ç±»æ ‘
factor_library_tree = ui.tree([
    ui.tree_node("ğŸ“Š é‡ä»·å› å­", icon("equalizer"), color="blue", children=[
        ui.tree_node("åŠ¨é‡å› å­", icon("trending_up"), children=[
            ui.tree_node("Næ—¥æ”¶ç›Šç‡", on_click=lambda: load_factor_config('MOM_1D')),
            ui.tree_node("20æ—¥åŠ¨é‡", on_click=lambda: load_factor_config('MOM_20D')),
            ui.tree_node("æ¢æ‰‹ç‡", on_click=lambda: load_factor_config('TURNOVER')),
            ui.tree_node("æˆäº¤é‡æ¯”", on_click=lambda: load_factor_config('VOL_RATIO'))
        ]),
        ui.tree_node("æ³¢åŠ¨ç‡å› å­", icon("show_chart"), children=[
            ui.tree_node("å†å²æ³¢åŠ¨ç‡", on_click=lambda: load_factor_config('HV')),
            ui.tree_node("æ”¶ç›Šæ³¢åŠ¨ç‡", on_click=lambda: load_factor_config('RV'))
        ]),
        ui.tree_node("æŠ€æœ¯å› å­", icon("timeline"), children=[
            ui.tree_node("MACDä¿¡å·", on_click=lambda: load_factor_config('MACD')),
            ui.tree_node("RSIå€¼", on_click=lambda: load_factor_config('RSI')),
            ui.tree_node("å¸ƒæ—å¸¦ä½ç½®", on_click=lambda: load_factor_config('BOLL_POS')),
            ui.tree_node("KDJä¿¡å·", on_click=lambda: load_factor_config('KDJ'))
        ])
    ]),

    ui.tree_node("ğŸ’° è´¢åŠ¡å› å­", icon("account_balance"), color="green", children=[
        ui.tree_node("ä¼°å€¼å› å­", icon("attach_money"), children=[
            ui.tree_node("å¸‚ç›ˆç‡PE", on_click=lambda: load_factor_config('PE')),
            ui.tree_node("å¸‚å‡€ç‡PB", on_click=lambda: load_factor_config('PB')),
            ui.tree_node("å¸‚é”€ç‡PS", on_click=lambda: load_factor_config('PS'))
        ]),
        ui.tree_node("ç›ˆåˆ©å› å­", icon("trending_up"), children=[
            ui.tree_node("ROE", on_click=lambda: load_factor_config('ROE')),
            ui.tree_node("ROA", on_click=lambda: load_factor_config('ROA')),
            ui.tree_node("å‡€åˆ©æ¶¦ç‡", on_click=lambda: load_factor_config('NET_MARGIN'))
        ]),
        ui.tree_node("æˆé•¿å› å­", icon("growth"), children=[
            ui.tree_node("è¥æ”¶å¢é•¿ç‡", on_click=lambda: load_factor_config('REV_GROWTH')),
            ui.tree_node("å‡€åˆ©æ¶¦å¢é•¿ç‡", on_click=lambda: load_factor_config('PROFIT_GROWTH'))
        ])
    ]),

    ui.tree_node("ğŸ¢ é£æ ¼å› å­", icon("business"), color="purple", children=[
        ui.tree_node("å¸‚å€¼å› å­", icon("apartment"), children=[
            ui.tree_node("æ€»å¸‚å€¼", on_click=lambda: load_factor_config('MARKET_CAP')),
            ui.tree_node("æµé€šå¸‚å€¼", on_click=lambda: load_factor_config('FREE_CAP'))
        ]),
        ui.tree_node("è¡Œä¸šå› å­", icon("category"), children=[
            ui.tree_node("è¡Œä¸šä¸­æ€§åŒ–", on_click=lambda: load_factor_config('INDUSTRY_NEUTRAL'))
        ])
    ])
])
```

#### å› å­æµ‹è¯•ä¸å›æµ‹
```python
# å› å­æµ‹è¯•é…ç½®é¢æ¿ (ui.card)
with ui.card().style("margin-top: 10px;>
    ui.label("å› å­æµ‹è¯•é…ç½®").style("font-size: 16px; font-weight: bold;")

    with ui.row():
        # æµ‹è¯•å‚æ•°é…ç½®
        with ui.column().style("width: 50%;">
            ui.label("æµ‹è¯•å‚æ•°").style("font-weight: bold; margin-bottom: 5px;")

            test_form = ui.form()
            with test_form:
                # é€‰æ‹©å› å­
                selected_factors = ui.select([
                    'PE', 'PB', 'ROE', 'MOM_20D', 'TURNOVER', 'MACD', 'RSI'
                ], multiple=True, label='é€‰æ‹©å› å­', value=['PE', 'ROE'])

                # æµ‹è¯•åŒºé—´
                date_range = ui.date_range(
                    start=datetime.now() - timedelta(days=365),
                    end=datetime.now(),
                    label='æµ‹è¯•åŒºé—´'
                )

                # è‚¡ç¥¨æ± é€‰æ‹©
                universe_select = ui.select([
                    'å…¨Aè‚¡', 'æ²ªæ·±300', 'ä¸­è¯500', 'ä¸­è¯1000', 'åˆ›ä¸šæ¿', 'è‡ªé€‰è‚¡æ± '
                ], value='æ²ªæ·±300', label='è‚¡ç¥¨æ± ')

                # åˆ†å±‚è®¾ç½®
                layer_method = ui.select(['5åˆ†å±‚', '10åˆ†å±‚'], value='5åˆ†å±‚', label='åˆ†å±‚æ–¹æ³•')

                # è°ƒä»“é¢‘ç‡
                rebalance_freq = ui.select([
                    'æ—¥åº¦', 'å‘¨åº¦', 'æœˆåº¦', 'å­£åº¦'
                ], value='æœˆåº¦', label='è°ƒä»“é¢‘ç‡')

        # æµ‹è¯•é€‰é¡¹
        with ui.column().style("width: 50%;>
            ui.label("æµ‹è¯•é€‰é¡¹").style("font-weight: bold; margin-bottom: 5px;")

            with ui.column():
                ui.checkbox("è¡Œä¸šä¸­æ€§åŒ–", value=True)
                ui.checkbox("å¸‚å€¼ä¸­æ€§åŒ–", value=True)
                ui.checkbox("å»é™¤åœç‰Œè‚¡ç¥¨", value=True)
                ui.checkbox("å»é™¤STè‚¡ç¥¨", value=True)
                ui.checkbox("è€ƒè™‘äº¤æ˜“æˆæœ¬", value=False)

                # äº¤æ˜“æˆæœ¬è®¾ç½®
                with ui.row():
                    ui.number("ä¹°å…¥æˆæœ¬(%)", value=0.1, min=0, max=1, step=0.01, label="ä¹°å…¥æ‰‹ç»­è´¹")
                    ui.number("å–å‡ºæˆæœ¬(%)", value=0.1, min=0, max=1, step=0.01, label="å–å‡ºæ‰‹ç»­è´¹")

    # å¼€å§‹æµ‹è¯•æŒ‰é’®
    with ui.row().style("justify-content: center; margin-top: 16px; gap: 16px"):
        ui.button("å¼€å§‹å› å­æµ‹è¯•", icon="play_arrow",
                 on_click=start_factor_test).style("width: 150px;")
        ui.button("ä¿å­˜æµ‹è¯•é…ç½®", icon="save",
                 on_click=save_factor_test_config)

# æµ‹è¯•è¿›åº¦æ˜¾ç¤º
factor_test_progress = ui.linear_progress().style("height: 6px; margin: 10px 0;")
factor_test_logs = ui.log().style("height: 120px; background: #f5f5f5;")

# å› å­åˆ†æç»“æœå±•ç¤º (ui.tabs)
with ui.tabs() as factor_result_tabs:

    with ui.tab("å› å­æ”¶ç›Šæ›²çº¿"):
        factor_returns_chart = ui.chart({
            'title': {'text': 'å› å­åˆ†å±‚æ”¶ç›Šæ›²çº¿', 'left': 'center'},
            'tooltip': {'trigger': 'axis'},
            'legend': {'data': ['ç¬¬1å±‚', 'ç¬¬2å±‚', 'ç¬¬3å±‚', 'ç¬¬4å±‚', 'ç¬¬5å±‚'], 'top': '10%'},
            'grid': {'left': '3%', 'right': '4%', 'bottom': '3%', 'containLabel': True},
            'xAxis': {'type': 'category', 'data': dates},
            'yAxis': {'type': 'value', 'axisLabel': {'formatter': '{value}%'}},
            'series': [
                {'name': 'ç¬¬1å±‚(æœ€é«˜)', 'type': 'line', 'data': layer1_returns},
                {'name': 'ç¬¬2å±‚', 'type': 'line', 'data': layer2_returns},
                {'name': 'ç¬¬3å±‚', 'type': 'line', 'data': layer3_returns},
                {'name': 'ç¬¬4å±‚', 'type': 'line', 'data': layer4_returns},
                {'name': 'ç¬¬5å±‚(æœ€ä½)', 'type': 'line', 'data': layer5_returns}
            ]
        }).style("height: 400px;")

    with ui.tab("å› å­ICåˆ†æ"):
        ic_analysis_html = """
        <div id="ic_analysis_chart" style="height: 400px;"></div>
        <script>
            var icChart = echarts.init(document.getElementById('ic_analysis_chart'));

            var icOption = {
                title: { text: 'å› å­ICåˆ†æ', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['ICå€¼', 'ICIR'], top: '10%' },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'category', data: ic_dates },
                yAxis: [
                    { type: 'value', name: 'ICå€¼', min: -1, max: 1 },
                    { type: 'value', name: 'ICIR', axisLabel: { formatter: '{value}' } }
                ],
                series: [
                    {
                        name: 'ICå€¼',
                        type: 'line',
                        data: ic_values,
                        yAxisIndex: 0
                    },
                    {
                        name: 'ICIR',
                        type: 'bar',
                        data: icir_values,
                        yAxisIndex: 1
                    }
                ]
            };

            icChart.setOption(icOption);
        </script>
        """
        ui.html(ic_analysis_html)

    with ui.tab("å› å­ç»Ÿè®¡"):
        factor_stats_table = ui.aggrid(
            options={
                "rowData": factor_statistics,
                "columnDefs": [
                    {"field": "factor_name", "headerName": "å› å­åç§°", "width": 120},
                    {"field": "ic_mean", "headerName": "ICå‡å€¼", "width": 100},
                    {"field": "ic_std", "headerName": "ICæ ‡å‡†å·®", "width": 100},
                    {"field": "icir", "headerName": "ICIR", "width": 100},
                    {"field": "hit_rate", "headerName": "èƒœç‡(%)", "width": 100},
                    {"field": "layer1_return", "headerName": "ç¬¬1å±‚æ”¶ç›Š(%)", "width": 120},
                    {"field": "layer5_return", "headerName": "ç¬¬5å±‚æ”¶ç›Š(%)", "width": 120},
                    {"field": "long_short_return", "headerName": "å¤šç©ºæ”¶ç›Š(%)", "width": 120},
                    {"field": "max_drawdown", "headerName": "æœ€å¤§å›æ’¤(%)", "width": 100},
                    {"field": "sharpe_ratio", "headerName": "å¤æ™®æ¯”ç‡", "width": 100}
                ]
            }
        )
```

## æ•°æ®åº“è®¾è®¡

### PostgreSQLè¡¨ç»“æ„
```sql
-- è‡ªå®šä¹‰æŒ‡æ ‡è¡¨
CREATE TABLE custom_indicators (
    indicator_id SERIAL PRIMARY KEY,
    indicator_name VARCHAR(100) NOT NULL,
    indicator_code TEXT NOT NULL,
    indicator_category VARCHAR(50),
    parameters JSONB DEFAULT '{}',
    description TEXT,
    is_public BOOLEAN DEFAULT false,
    create_time TIMESTAMP DEFAULT NOW(),
    update_time TIMESTAMP DEFAULT NOW(),
    use_count INT DEFAULT 0,
    created_by VARCHAR(50),
    version INT DEFAULT 1
);

-- ç­›é€‰æ¡ä»¶è¡¨
CREATE TABLE filter_conditions (
    condition_id SERIAL PRIMARY KEY,
    condition_name VARCHAR(100) NOT NULL,
    condition_groups JSONB NOT NULL,  -- æ¡ä»¶ç»„é…ç½®
    logic_relationship VARCHAR(10) DEFAULT 'AND',  -- AND/OR
    is_public BOOLEAN DEFAULT false,
    is_auto_run BOOLEAN DEFAULT false,
    run_schedule VARCHAR(50),  -- cronè¡¨è¾¾å¼
    create_time TIMESTAMP DEFAULT NOW(),
    update_time TIMESTAMP DEFAULT NOW(),
    last_run_time TIMESTAMP,
    run_count INT DEFAULT 0,
    created_by VARCHAR(50)
);

-- ç­›é€‰ç»“æœè¡¨
CREATE TABLE filter_results (
    result_id SERIAL PRIMARY KEY,
    condition_id INT REFERENCES filter_conditions(condition_id),
    stock_code VARCHAR(10) NOT NULL,
    stock_name VARCHAR(50),
    filter_time TIMESTAMP DEFAULT NOW(),
    match_score DECIMAL(5,2) DEFAULT 0.00,
    condition_details JSONB  -- ç¬¦åˆçš„å…·ä½“æ¡ä»¶è¯¦æƒ…
);

-- å› å­é…ç½®è¡¨
CREATE TABLE factor_configs (
    factor_id SERIAL PRIMARY KEY,
    factor_name VARCHAR(100) NOT NULL UNIQUE,
    factor_category VARCHAR(50),
    factor_formula TEXT,  -- å› å­è®¡ç®—å…¬å¼
    factor_params JSONB DEFAULT '{}',
    description TEXT,
    data_source VARCHAR(50),  -- æ•°æ®æºæ ‡è¯†
    is_active BOOLEAN DEFAULT true,
    create_time TIMESTAMP DEFAULT NOW()
);

-- å› å­æµ‹è¯•è®°å½•è¡¨
CREATE TABLE factor_test_records (
    test_id SERIAL PRIMARY KEY,
    test_name VARCHAR(100),
    factor_list JSONB NOT NULL,  -- æµ‹è¯•çš„å› å­åˆ—è¡¨
    test_period_start DATE,
    test_period_end DATE,
    universe VARCHAR(50),  -- æµ‹è¯•è‚¡ç¥¨æ± 
    layer_method VARCHAR(20),  -- åˆ†å±‚æ–¹æ³•
    rebalance_freq VARCHAR(20),  -- è°ƒä»“é¢‘ç‡
    test_config JSONB,  -- æµ‹è¯•é…ç½®
    test_status VARCHAR(20) DEFAULT 'PENDING',  -- PENDING/RUNNING/COMPLETED/FAILED
    create_time TIMESTAMP DEFAULT NOW(),
    complete_time TIMESTAMP,
    created_by VARCHAR(50)
);

-- æŒ‡æ ‡è®¡ç®—ä»»åŠ¡è¡¨
CREATE TABLE indicator_calculation_tasks (
    task_id SERIAL PRIMARY KEY,
    task_name VARCHAR(100),
    stock_codes JSONB,  -- è‚¡ç¥¨ä»£ç åˆ—è¡¨
    indicators JSONB,  -- æŒ‡æ ‡åˆ—è¡¨
    parameters JSONB,  -- å‚æ•°é…ç½®
    task_status VARCHAR(20) DEFAULT 'PENDING',  -- PENDING/RUNNING/COMPLETED/FAILED
    progress INT DEFAULT 0,  -- è¿›åº¦ç™¾åˆ†æ¯”
    total_count INT DEFAULT 0,
    completed_count INT DEFAULT 0,
    error_message TEXT,
    create_time TIMESTAMP DEFAULT NOW(),
    start_time TIMESTAMP,
    complete_time TIMESTAMP,
    created_by VARCHAR(50)
);

-- æŠ€æœ¯æŒ‡æ ‡æ•°æ®è¡¨ (TDengineè¶…çº§è¡¨)
CREATE STABLE technical_indicators (
    ts TIMESTAMP,
    indicator_value DOUBLE,
    signal INT,  -- 1ä¹°å…¥/-1å–å‡º/0ä¸­æ€§
    confidence DECIMAL(5,2) DEFAULT 0.00  -- ä¿¡å·ç½®ä¿¡åº¦
) TAGS (
    stock_code NCHAR(10),
    indicator_name NCHAR(50),
    period NCHAR(20),
    parameters_hash NCHAR(32)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_custom_indicators_category ON custom_indicators(indicator_category);
CREATE INDEX idx_filter_conditions_public ON filter_conditions(is_public, create_time);
CREATE INDEX idx_factor_test_records_status ON factor_test_records(test_status);
CREATE INDEX idx_technical_indicators_stock_code ON technical_indicators(stock_code);
CREATE INDEX idx_technical_indicators_name ON technical_indicators(indicator_name, period);
```

## APIæ¥å£è®¾è®¡

### æ ¸å¿ƒAPIç«¯ç‚¹
```python
# æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
@app.post("/api/technical/calculate")
async def calculate_technical_indicators(request: IndicatorCalcRequest):
    """è®¡ç®—æŠ€æœ¯æŒ‡æ ‡"""
    pass

@app.get("/api/technical/{stock_code}/indicators")
async def get_stock_indicators(stock_code: str, period: str = "1day"):
    """è·å–è‚¡ç¥¨æŠ€æœ¯æŒ‡æ ‡æ•°æ®"""
    pass

@app.post("/api/technical/batch/calculate")
async def batch_calculate_indicators(request: BatchCalcRequest):
    """æ‰¹é‡è®¡ç®—æŠ€æœ¯æŒ‡æ ‡"""
    pass

@app.get("/api/technical/calculation/tasks/{task_id}")
async def get_calculation_task_progress(task_id: str):
    """è·å–æ‰¹é‡è®¡ç®—ä»»åŠ¡è¿›åº¦"""
    pass

# è‡ªå®šä¹‰æŒ‡æ ‡ç®¡ç†
@app.get("/api/custom/indicators")
async def get_custom_indicators(category: str = None):
    """è·å–è‡ªå®šä¹‰æŒ‡æ ‡åˆ—è¡¨"""
    pass

@app.post("/api/custom/indicators")
async def create_custom_indicator(indicator: CustomIndicatorCreate):
    """åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡"""
    pass

@app.put("/api/custom/indicators/{indicator_id}")
async def update_custom_indicator(indicator_id: int, indicator: CustomIndicatorUpdate):
    """æ›´æ–°è‡ªå®šä¹‰æŒ‡æ ‡"""
    pass

@app.post("/api/custom/indicators/{indicator_id}/test")
async def test_custom_indicator(indicator_id: int, test_request: IndicatorTestRequest):
    """æµ‹è¯•è‡ªå®šä¹‰æŒ‡æ ‡"""
    pass

# ç­›é€‰æ¡ä»¶ç®¡ç†
@app.get("/api/filters")
async def get_filter_conditions(user_id: str = None):
    """è·å–ç­›é€‰æ¡ä»¶"""
    pass

@app.post("/api/filters")
async def create_filter_condition(condition: FilterConditionCreate):
    """åˆ›å»ºç­›é€‰æ¡ä»¶"""
    pass

@app.post("/api/filters/{condition_id}/execute")
async def execute_filter_condition(condition_id: int, filter_request: FilterExecuteRequest):
    """æ‰§è¡Œç­›é€‰æ¡ä»¶"""
    pass

# å› å­åˆ†æ
@app.get("/api/factors")
async def get_factor_library():
    """è·å–å› å­åº“"""
    pass

@app.post("/api/factors/test")
async def start_factor_test(test_config: FactorTestConfig):
    """å¯åŠ¨å› å­æµ‹è¯•"""
    pass

@app.get("/api/factors/test/{test_id}/results")
async def get_factor_test_results(test_id: int):
    """è·å–å› å­æµ‹è¯•ç»“æœ"""
    pass

@app.get("/api/factors/test/{test_id}/progress")
async def get_factor_test_progress(test_id: int):
    """è·å–å› å­æµ‹è¯•è¿›åº¦"""
    pass
```

## å‰ç«¯JavaScriptç»„ä»¶

### æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ç»„ä»¶
```javascript
// æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ç®¡ç†å™¨
class TechnicalAnalysisChart {
    constructor(containerId, options = {}) {
        this.containerId = containerId;
        this.options = {
            theme: 'dark',
            interval: 'D',
            locale: 'zh_CN',
            ...options
        };
        this.widget = null;
        this.currentSymbol = null;
        this.currentIndicators = new Set();
    }

    // åˆå§‹åŒ–å›¾è¡¨
    async init(symbol, name) {
        try {
            this.currentSymbol = symbol;

            // åŠ è½½TradingView
            await this.loadTradingView();

            // åˆ›å»ºå›¾è¡¨
            this.createChart(symbol);

        } catch (error) {
            console.error('åˆå§‹åŒ–æŠ€æœ¯åˆ†æå›¾è¡¨å¤±è´¥:', error);
            this.showError('åŠ è½½å›¾è¡¨å¤±è´¥');
        }
    }

    // åŠ è½½TradingViewåº“
    loadTradingView() {
        return new Promise((resolve, reject) => {
            if (typeof TradingView !== 'undefined') {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/tv.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // åˆ›å»ºå›¾è¡¨
    createChart(symbol) {
        const widget = new TradingView.widget({
            width: "100%",
            height: "100%",
            symbol: symbol,
            interval: this.options.interval,
            timezone: "Asia/Shanghai",
            theme: this.options.theme,
            style: "1",
            locale: this.options.locale,
            toolbar_bg: this.options.theme === 'dark' ? "#1a1a1a" : "#f1f3f6",
            enable_publishing: false,
            allow_symbol_change: false,
            container_id: this.containerId,
            hide_side_toolbar: false,
            studies: [
                "MACD@tv-basicstudies",
                "RSI@tv-basicstudies",
                "KDJ@tv-basicstudies",
                "BollingerBands@tv-basicstudies",
                "ATR@tv-basicstudies"
            ],
            disabled_features: ["use_localstorage_for_settings"],
            enabled_features: ["study_templates"],
            autosize: true
        });

        this.widget = widget;
    }

    // æ·»åŠ æŠ€æœ¯æŒ‡æ ‡
    addIndicator(indicatorType, params = {}) {
        if (!this.widget) return;

        const chart = this.widget.chart();
        try {
            switch(indicatorType) {
                case 'MA':
                    chart.createStudy('Moving Average', false, false, [params.period || 20]);
                    break;
                case 'EMA':
                    chart.createStudy('Exponential Moving Average', false, false, [params.period || 20]);
                    break;
                case 'MACD':
                    chart.createStudy('MACD', false, false);
                    break;
                case 'RSI':
                    chart.createStudy('Relative Strength Index', false, false, [params.period || 14]);
                    break;
                case 'KDJ':
                    chart.createStudy('Stochastic RSI', false, false);
                    break;
                case 'BOLL':
                    chart.createStudy('Bollinger Bands', false, false);
                    break;
                case 'ATR':
                    chart.createStudy('Average True Range', false, false, [params.period || 14]);
                    break;
            }

            this.currentIndicators.add(indicatorType);
        } catch (error) {
            console.error('æ·»åŠ æŒ‡æ ‡å¤±è´¥:', error);
        }
    }

    // ç§»é™¤æŠ€æœ¯æŒ‡æ ‡
    removeIndicator(indicatorType) {
        if (!this.widget) return;

        const chart = this.widget.chart();
        try {
            const studies = chart.getAllStudies();
            studies.forEach(study => {
                if (study.name.includes(indicatorType)) {
                    chart.removeEntity(study.id);
                }
            });

            this.currentIndicators.delete(indicatorType);
        } catch (error) {
            console.error('ç§»é™¤æŒ‡æ ‡å¤±è´¥:', error);
        }
    }

    // åˆ‡æ¢æ—¶é—´å‘¨æœŸ
    switchInterval(interval) {
        this.options.interval = interval;
        if (this.widget) {
            this.widget.chart().setResolution(interval);
        }
    }

    // è·å–å›¾è¡¨æ•°æ®
    async getChartData() {
        if (!this.widget) return null;

        try {
            const chart = this.widget.chart();
            const series = chart.getSeries().getData();
            return series;
        } catch (error) {
            console.error('è·å–å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            return null;
        }
    }

    // æˆªå›¾åŠŸèƒ½
    takeScreenshot() {
        if (!this.widget) return null;

        try {
            return this.widget.takeScreenshot();
        } catch (error) {
            console.error('æˆªå›¾å¤±è´¥:', error);
            return null;
        }
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    showError(message) {
        const container = document.getElementById(this.containerId);
        if (container) {
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; text-align: center;">
                    <div>
                        <div style="margin-bottom: 8px; font-size: 18px;">âŒ ${message}</div>
                        <button onclick="location.reload()" style="background: #1890ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            é‡æ–°åŠ è½½
                        </button>
                    </div>
                </div>
            `;
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const techChart = new TechnicalAnalysisChart('technical_analysis_kline');

// åˆå§‹åŒ–å›¾è¡¨
techChart.init('600000', 'æµ¦å‘é“¶è¡Œ');

// æ·»åŠ æŠ€æœ¯æŒ‡æ ‡
techChart.addIndicator('MA', {period: 5});
techChart.addIndicator('MA', {period: 10});
techChart.addIndicator('MA', {period: 20});
techChart.addIndicator('MACD');
techChart.addIndicator('RSI',
