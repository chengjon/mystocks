# 开发规范与接口契约（量化交易系统）

本文档定义量化交易系统Web管理平台的完整开发规范、接口契约和数据库设计，确保不同角色（前端/后端/数据）之间的协作清晰高效。

## 1. 技术架构与总体规范

### 1.1 系统架构
```python
# 系统分层架构
system_architecture = {
    "前端层": {
        "框架": "NiceGUI (Python Web Framework)",
        "UI组件": "Element Plus + TradingView Klinechart",
        "图表库": "Plotly + ECharts",
        "通信协议": "WebSocket + HTTP/REST"
    },
    "应用层": {
        "Web框架": "FastAPI (基于NiceGUI)",
        "任务队列": "Celery + Redis",
        "缓存层": "Redis + 内存缓存",
        "实时通信": "WebSocket + Server-Sent Events"
    },
    "数据层": {
        "元数据库": "PostgreSQL 17.x",
        "时序数据库": "TDengine 3.3.x",
        "缓存数据库": "Redis 7.x",
        "文件存储": "本地文件系统 + 对象存储"
    },
    "外部集成": {
        "数据源": "akshare/tushare/baostock/wind",
        "实时行情": "券商API + 第三方数据",
        "邮件服务": "SMTP + 企业邮箱",
        "监控告警": "Prometheus + Grafana"
    }
}
```

### 1.2 编码规范
```python
# Python代码规范
coding_standards = {
    "代码风格": {
        "格式化工具": "black (line-length=88)",
        "导入排序": "isort",
        "类型注解": "mypy严格模式",
        "文档字符串": "Google风格"
    },
    "命名规范": {
        "变量/函数": "snake_case",
        "类名": "PascalCase",
        "常量": "UPPER_SNAKE_CASE",
        "私有属性": "_leading_underscore"
    },
    "代码质量": {
        "静态检查": "pylint (score>=9.0)",
        "复杂度": "McCabe复杂度<=10",
        "测试覆盖率": ">=80%",
        "文档覆盖率": ">=90%"
    }
}
```

## 2. 数据库设计规范

### 2.1 PostgreSQL表结构设计
```sql
-- === 市场数据表 ===
-- 股票基础信息表
CREATE TABLE stock_basic (
    stock_code VARCHAR(10) PRIMARY KEY,
    stock_name VARCHAR(100) NOT NULL,
    exchange VARCHAR(10) NOT NULL,
    industry VARCHAR(50),
    concept TEXT[],
    market_cap DECIMAL(20,2),
    listing_date DATE,
    delist_date DATE,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_stock_basic_exchange ON stock_basic(exchange);
CREATE INDEX idx_stock_basic_industry ON stock_basic(industry);
CREATE INDEX idx_stock_basic_active ON stock_basic(is_active);

-- 股票池配置表
CREATE TABLE stock_pool_config (
    pool_id SERIAL PRIMARY KEY,
    pool_name VARCHAR(100) NOT NULL,
    pool_type VARCHAR(20) NOT NULL, -- 'WATCH'/'STRATEGY'/'INDUSTRY'/'CONCEPT'
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 股票池明细表
CREATE TABLE stock_pool_items (
    item_id SERIAL PRIMARY KEY,
    pool_id INT REFERENCES stock_pool_config(pool_id),
    stock_code VARCHAR(10) REFERENCES stock_basic(stock_code),
    added_reason TEXT,
    priority INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_stock_pool_items_pool ON stock_pool_items(pool_id);
CREATE INDEX idx_stock_pool_items_stock ON stock_pool_items(stock_code);

-- 预警配置表
CREATE TABLE alert_config (
    alert_id SERIAL PRIMARY KEY,
    alert_name VARCHAR(100) NOT NULL,
    stock_code VARCHAR(10) REFERENCES stock_basic(stock_code),
    alert_type VARCHAR(20) NOT NULL, -- 'PRICE'/'CHANGE'/'SIGNAL'/'VOLUME'
    condition_config JSONB NOT NULL,
    notify_methods JSONB NOT NULL, -- ['popup','email','wechat']
    is_active BOOLEAN DEFAULT true,
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 预警触发历史
CREATE TABLE alert_history (
    history_id SERIAL PRIMARY KEY,
    alert_id INT REFERENCES alert_config(alert_id),
    trigger_time TIMESTAMP DEFAULT NOW(),
    trigger_value JSONB,
    is_read BOOLEAN DEFAULT false,
    message TEXT
);

CREATE INDEX idx_alert_history_time ON alert_history(trigger_time);
CREATE INDEX idx_alert_history_read ON alert_history(is_read);

-- === 策略与回测表 ===
-- 策略配置表
CREATE TABLE strategy_config (
    strategy_id SERIAL PRIMARY KEY,
    strategy_name VARCHAR(100) NOT NULL,
    strategy_type VARCHAR(50),
    strategy_code TEXT,
    parameters JSONB,
    description TEXT,
    author VARCHAR(50),
    version INT DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 回测任务表
CREATE TABLE backtest_tasks (
    task_id SERIAL PRIMARY KEY,
    strategy_id INT REFERENCES strategy_config(strategy_id),
    task_name VARCHAR(100),
    start_date DATE,
    end_date DATE,
    initial_capital DECIMAL(15,2),
    stock_pool TEXT[], -- 股票池列表
    task_config JSONB,
    status VARCHAR(20) DEFAULT 'pending', -- 'pending'/'running'/'completed'/'failed'
    progress INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    started_at TIMESTAMP,
    completed_at TIMESTAMP
);

-- 回测结果表
CREATE TABLE backtest_results (
    result_id SERIAL PRIMARY KEY,
    task_id INT REFERENCES backtest_tasks(task_id),
    total_return DECIMAL(10,4),
    annual_return DECIMAL(10,4),
    sharpe_ratio DECIMAL(10,4),
    max_drawdown DECIMAL(10,4),
    win_rate DECIMAL(10,4),
    total_trades INT,
    winning_trades INT,
    losing_trades INT,
    avg_win DECIMAL(15,2),
    avg_loss DECIMAL(15,2),
    final_capital DECIMAL(15,2),
    backtest_data JSONB, -- 详细回测数据
    created_at TIMESTAMP DEFAULT NOW()
);

-- 回测交易明细表
CREATE TABLE backtest_trades (
    trade_id SERIAL PRIMARY KEY,
    result_id INT REFERENCES backtest_results(result_id),
    trade_date DATE,
    stock_code VARCHAR(10),
    direction VARCHAR(10), -- 'BUY'/'SELL'
    price DECIMAL(10,2),
    quantity INT,
    amount DECIMAL(15,2),
    commission DECIMAL(10,2),
    profit DECIMAL(15,2),
    reason TEXT
);

CREATE INDEX idx_backtest_trades_date ON backtest_trades(trade_date);
CREATE INDEX idx_backtest_trades_stock ON backtest_trades(stock_code);

-- === 交易管理表 ===
-- 交易信号表
CREATE TABLE trade_signals (
    signal_id SERIAL PRIMARY KEY,
    stock_code VARCHAR(10),
    signal_type VARCHAR(20), -- 'BUY'/'SELL'
    signal_strength INTEGER, -- 1-5星评级
    strategy_name VARCHAR(100),
    current_price DECIMAL(10,2),
    signal_reason TEXT,
    is_executable BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 订单记录表
CREATE TABLE trade_orders (
    order_id SERIAL PRIMARY KEY,
    signal_id INT REFERENCES trade_signals(signal_id),
    order_type VARCHAR(20), -- 'MARKET'/'LIMIT'
    direction VARCHAR(10), -- 'BUY'/'SELL'
    stock_code VARCHAR(10),
    quantity INT,
    order_price DECIMAL(10,2),
    filled_price DECIMAL(10,2),
    filled_quantity INT,
    status VARCHAR(20) DEFAULT 'pending', -- 'pending'/'filled'/'cancelled'/'rejected'
    commission DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW(),
    filled_at TIMESTAMP
);

-- 持仓记录表
CREATE TABLE positions (
    position_id SERIAL PRIMARY KEY,
    stock_code VARCHAR(10),
    total_quantity INT, -- 总持仓数量
    available_quantity INT, -- 可用数量(T+1限制)
    avg_cost DECIMAL(10,2), -- 平均成本
    market_price DECIMAL(10,2), -- 当前市价
    market_value DECIMAL(15,2), -- 市值
    unrealized_pnl DECIMAL(15,2), -- 未实现盈亏
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_positions_stock ON positions(stock_code);

-- === 风险管理表 ===
-- 风险指标历史表
CREATE TABLE risk_metrics_history (
    metric_id SERIAL PRIMARY KEY,
    calc_date DATE,
    var_95 DECIMAL(15,2), -- 95% VaR
    var_99 DECIMAL(15,2), -- 99% VaR
    volatility DECIMAL(10,4), -- 波动率
    max_drawdown DECIMAL(10,4), -- 最大回撤
    beta DECIMAL(10,4), -- Beta系数
    alpha DECIMAL(10,4), -- Alpha值
    concentration_risk DECIMAL(10,4), -- 集中度风险
    liquidity_risk DECIMAL(10,4), -- 流动性风险
    created_at TIMESTAMP DEFAULT NOW()
);

-- 风险警报表
CREATE TABLE risk_alerts (
    alert_id SERIAL PRIMARY KEY,
    alert_time TIMESTAMP DEFAULT NOW(),
    alert_type VARCHAR(30),
    severity VARCHAR(20), -- 'HIGH'/'MEDIUM'/'LOW'
    description TEXT,
    suggestion TEXT,
    status VARCHAR(20) DEFAULT 'pending', -- 'pending'/'handled'/'ignored'
    handled_by VARCHAR(50),
    handled_at TIMESTAMP
);

-- === 系统配置表 ===
-- 系统参数表
CREATE TABLE system_config (
    config_key VARCHAR(100) PRIMARY KEY,
    config_value TEXT,
    config_type VARCHAR(20), -- 'STRING'/'INT'/'FLOAT'/'JSON'
    description TEXT,
    is_editable BOOLEAN DEFAULT true,
    updated_by VARCHAR(50),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 数据源配置表
CREATE TABLE data_source_config (
    source_id SERIAL PRIMARY KEY,
    source_name VARCHAR(50) NOT NULL,
    source_type VARCHAR(20), -- 'AKSHARE'/'TUSHARE'/'BAOSTOCK'/'WIND'/'CRAWLER'
    config_json JSONB,
    is_active BOOLEAN DEFAULT true,
    last_test_time TIMESTAMP,
    last_error TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 2.2 TDengine时序数据结构
```sql
-- === TDengine超级表设计 ===
-- 分钟级行情数据超级表
CREATE STABLE minute_kline (
    ts TIMESTAMP,
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    amount DOUBLE,
    turnover_rate DOUBLE,
    change_rate DOUBLE,
    change_amount DOUBLE
) TAGS (stock_code BINARY(10));

-- 秒级Tick数据超级表  
CREATE STABLE tick_data (
    ts TIMESTAMP,
    price DOUBLE,
    volume DOUBLE,
    turnover DOUBLE,
    buy_volume DOUBLE,
    sell_volume DOUBLE,
    bid_price DOUBLE,
    ask_price DOUBLE,
    bid_volume DOUBLE,
    ask_volume DOUBLE
) TAGS (stock_code BINARY(10));

-- 技术指标结果超级表
CREATE STABLE technical_indicators (
    ts TIMESTAMP,
    value DOUBLE,
    signal INTEGER -- 信号强度(-1/0/1)
) TAGS (
    stock_code BINARY(10),
    indicator_type BINARY(50),
    period INTEGER
);

-- 资金流向数据超级表
CREATE STABLE fund_flow (
    ts TIMESTAMP,
    north_money DOUBLE, -- 北向资金
    south_money DOUBLE, -- 南向资金
    main_force_money DOUBLE, -- 主力资金
    retail_money DOUBLE, -- 散户资金
    margin_balance DOUBLE -- 融资余额
) TAGS (stock_code BINARY(10));

-- 创建按股票代码分表的后缀规则
-- CREATE TABLE stock_600036_kline AS minute_kline USING minute_kline TAGS("600036");
-- CREATE TABLE stock_000001_kline AS minute_kline USING minute_kline TAGS("000001");
```

## 3. REST API接口规范

### 3.1 总体API规范
```python
# API基础规范
api_standards = {
    "基础URL": "/api/v1",
    "请求格式": "application/json",
    "响应格式": "application/json",
    "编码标准": "UTF-8",
    "时区标准": "UTC+8 (中国时区)",
    "版本控制": "URL路径版本控制"
}

# 响应格式标准
response_format = {
    "成功响应": {
        "code": 200,
        "message": "success",
        "data": {},
        "timestamp": "2025-11-12T10:30:00"
    },
    "错误响应": {
        "code": 400,
        "message": "Invalid parameter",
        "error": "详细错误信息",
        "timestamp": "2025-11-12T10:30:00"
    },
    "分页响应": {
        "code": 200,
        "message": "success",
        "data": [],
        "pagination": {
            "page": 1,
            "page_size": 20,
            "total": 100,
            "has_next": true
        }
    }
}

# HTTP状态码规范
status_codes = {
    200: "OK - 请求成功",
    201: "Created - 资源创建成功", 
    400: "Bad Request - 请求参数错误",
    401: "Unauthorized - 未授权访问",
    403: "Forbidden - 权限不足",
    404: "Not Found - 资源不存在",
    422: "Unprocessable Entity - 请求数据格式正确但无法处理",
    429: "Too Many Requests - 请求频率过高",
    500: "Internal Server Error - 服务器内部错误",
    503: "Service Unavailable - 服务不可用"
}
```

### 3.2 核心API接口定义

#### 3.2.1 市场数据接口
```python
# 1. 获取股票实时行情
@router.get("/market/quote/{stock_code}")
async def get_stock_quote(stock_code: str):
    """
    获取股票实时行情数据
    """
    return {
        "code": 200,
        "message": "success", 
        "data": {
            "stock_code": "600036",
            "stock_name": "招商银行",
            "current_price": 32.50,
            "open_price": 32.00,
            "high_price": 32.80,
            "low_price": 31.90,
            "change_amount": 0.50,
            "change_rate": 1.56,
            "volume": 1250000,
            "turnover": 40500000,
            "turnover_rate": 0.85,
            "market_cap": 850000000000,
            "pe_ratio": 5.20,
            "pb_ratio": 0.85,
            "limit_up": 35.75,  # 涨停价
            "limit_down": 29.25, # 跌停价
            "update_time": "2025-11-12T10:30:00"
        }
    }

# 2. 获取K线数据
@router.get("/market/kline/{stock_code}")
async def get_kline_data(
    stock_code: str,
    period: str = "daily",  # '1min'/'5min'/'15min'/'30min'/'60min'/'daily'/'weekly'/'monthly'
    start_date: str = None,
    end_date: str = None,
    adjustment: str = "qfq"  # 'qfq'(前复权)/'hfq'(后复权)/'no'(不复权)
):
    """
    获取K线数据
    """
    return {
        "code": 200,
        "message": "success",
        "data": {
            "stock_code": stock_code,
            "period": period,
            "adjustment": adjustment,
            "data": [
                {
                    "date": "2025-11-12",
                    "open": 32.00,
                    "high": 32.80,
                    "low": 31.90,
                    "close": 32.50,
                    "volume": 1250000,
                    "amount": 40500000,
                    "change": 0.50,
                    "change_rate": 1.56
                }
            ]
        }
    }

# 3. 获取市场概况
@router.get("/market/summary")
async def get_market_summary():
    """
    获取市场整体概况
    """
    return {
        "code": 200,
        "message": "success",
        "data": {
            "sh_index": {  # 上证指数
                "current": 3150.25,
                "change": 15.80,
                "change_rate": 0.50,
                "volume": 280000000000
            },
            "sz_index": {  # 深证成指
                "current": 10250.30,
                "change": -25.60,
                "change_rate": -0.25,
                "volume": 180000000000
            },
            "cy_index": {  # 创业板指
                "current": 2180.45,
                "change": 8.90,
                "change_rate": 0.41,
                "volume": 120000000000
            },
            "market_status": "trading",  # 'trading'/'closed'/'pre_market'/'after_market'
            "trading_date": "2025-11-12",
            "update_time": "2025-11-12T10:30:00"
        }
    }
```

#### 3.2.2 技术指标接口
```python
# 4. 计算技术指标
@router.post("/technical/indicators")
async def calculate_indicators(request: IndicatorRequest):
    """
    计算技术指标
    """
    return {
        "code": 200,
        "message": "success",
        "data": {
            "stock_code": "600036",
            "indicators": {
                "MA5": [31.20, 31.45, 31.80, 32.10, 32.50],
                "MA10": [30.85, 31.10, 31.35, 31.65, 32.00],
                "MA20": [30.50, 30.75, 31.00, 31.25, 31.50],
                "MACD": {
                    "DIF": 0.25,
                    "DEA": 0.18,
                    "MACD": 0.07,
                    "signal": "golden_cross"  # 'golden_cross'/'death_cross'/'bullish'/'bearish'
                },
                "RSI": 65.8,  # 0-100
                "KDJ": {
                    "K": 72.5,
                    "D": 68.3,
                    "J": 81.0,
                    "signal": "overbought"  # 'overbought'/'oversold'/'neutral'
                },
                "BOLL": {
                    "upper": 35.20,
                    "middle": 32.50,
                    "lower": 29.80,
                    "position": "middle"  # 'upper'/'middle'/'lower'/'突破upper'/'突破lower'
                }
            },
            "calculation_time": "2025-11-12T10:30:00"
        }
    }

# 5. 获取自定义指标
@router.get("/technical/custom/{indicator_name}")
async def get_custom_indicator(
    indicator_name: str,
    stock_code: str,
    period: str = "daily",
    start_date: str = None,
    end_date: str = None,
    parameters: str = None  # JSON格式参数
):
    """
    获取自定义技术指标
    """
    return {
        "code": 200,
        "message": "success", 
        "data": {
            "indicator_name": indicator_name,
            "stock_code": stock_code,
            "parameters": json.loads(parameters) if parameters else {},
            "data": [
                {
                    "date": "2025-11-12",
                    "value": 0.75,
                    "signal": "buy"  # 'buy'/'sell'/'hold'
                }
            ]
        }
    }
```

#### 3.2.3 股票池管理接口
```python
# 6. 股票池CRUD操作
@router.get("/stocks/pools")
async def get_stock_pools():
    """
    获取所有股票池
    """
    return {
        "code": 200,
        "message": "success",
        "data": [
            {
                "pool_id": 1,
                "pool_name": "观察池",
                "pool_type": "WATCH",
                "stock_count": 15,
                "description": "重点观察的股票",
                "created_at": "2025-11-01T10:00:00"
            },
            {
                "pool_id": 2,
                "pool_name": "策略池",
                "pool_type": "STRATEGY", 
                "stock_count": 30,
                "description": "策略选股池",
                "created_at": "2025-11-01T10:00:00"
            }
        ]
    }

@router.post("/stocks/pools")
async def create_stock_pool(pool: StockPoolCreate):
    """
    创建股票池
    """
    return {
        "code": 201,
        "message": "Stock pool created successfully",
        "data": {
            "pool_id": 123,
            "pool_name": pool.pool_name,
            "pool_type": pool.pool_type,
            "created_at": "2025-11-12T10:30:00"
        }
    }

@router.post("/stocks/pools/{pool_id}/stocks")
async def add_stock_to_pool(pool_id: int, stock: StockAddRequest):
    """
    添加股票到股票池
    """
    return {
        "code": 200,
        "message": "Stock added to pool successfully",
        "data": {
            "pool_id": pool_id,
            "stock_code": stock.stock_code,
            "added_at": "2025-11-12T10:30:00"
        }
    }

# 7. 批量导入股票
@router.post("/stocks/pools/{pool_id}/import")
async def import_stocks_to_pool(
    pool_id: int,
    file: UploadFile = File(...),
    duplicate_handling: str = "skip"  # 'skip'/'overwrite'/'append'
):
    """
    批量导入股票到股票池
    """
    return {
        "code": 200,
        "message": "Import completed",
        "data": {
            "total_processed": 150,
            "success_count": 148,
            "failed_count": 2,
            "duplicates_skipped": 5,
            "failed_stocks": ["600001", "600002"]
        }
    }
```

#### 3.2.4 策略回测接口
```python
# 8. 策略管理
@router.get("/strategies")
async def get_strategies():
    """
    获取所有策略
    """
    return {
        "code": 200,
        "message": "success",
        "data": [
            {
                "strategy_id": 1,
                "strategy_name": "双均线策略",
                "strategy_type": "TREND",
                "description": "MA5和MA20金叉买入，死叉卖出",
                "parameters": {
                    "short_period": 5,
                    "long_period": 20,
                    "stop_loss": 0.10,
                    "take_profit": 0.20
                },
                "backtest_count": 5,
                "best_return": 0.45,
                "created_at": "2025-11-01T10:00:00"
            }
        ]
    }

@router.post("/strategies")
async def create_strategy(strategy: StrategyCreate):
    """
    创建策略
    """
    return {
        "code": 201,
        "message": "Strategy created successfully",
        "data": {
            "strategy_id": 123,
            "strategy_name": strategy.strategy_name,
            "created_at": "2025-11-12T10:30:00"
        }
    }

# 9. 回测任务
@router.post("/backtest/tasks")
async def create_backtest_task(task: BacktestTaskCreate):
    """
    创建回测任务
    """
    return {
        "code": 201,
        "message": "Backtest task created",
        "data": {
            "task_id": 456,
            "status": "pending",
            "estimated_time": "30 seconds",
            "created_at": "2025-11-12T10:30:00"
        }
    }

@router.get("/backtest/tasks/{task_id}")
async def get_backtest_task(task_id: int):
    """
    获取回测任务状态
    """
    return {
        "code": 200,
        "message": "success",
        "data": {
            "task_id": task_id,
            "status": "running",  # 'pending'/'running'/'completed'/'failed'
            "progress": 65,
            "current_step": "计算技术指标",
            "started_at": "2025-11-12T10:30:00",
            "estimated_completion": "2025-11-12T10:31:00"
        }
    }

@router.get("/backtest/results/{task_id}")
async def get_backtest_result(task_id: int):
    """
    获取回测结果
    """
    return {
        "code": 200,
        "message": "success",
        "data": {
            "task_id": task_id,
            "strategy_name": "双均线策略",
            "period": "2023-01-01 to 2024-12-31",
            "initial_capital": 1000000,
            "final_capital": 1450000,
            "metrics": {
                "total_return": 0.45,
                "annual_return": 0.22,
                "sharpe_ratio": 1.35,
                "max_drawdown": -0.15,
                "win_rate": 0.62,
                "total_trades": 156,
                "winning_trades": 97,
                "losing_trades": 59,
                "avg_win": 0.085,
                "avg_loss": -0.045
            },
            "equity_curve": [  # 净值曲线数据
                {"date": "2023-01-01", "value": 1.0},
                {"date": "2023-06-01", "value": 1.15},
                {"date": "2023-12-01", "value": 1.25},
                {"date": "2024-12-31", "value": 1.45}
            ],
            "trade_details": [
                {
                    "date": "2023-02-15",
                    "stock_code": "600036",
                    "action": "BUY",
                    "price": 30.50,
                    "quantity": 1000,
                    "amount": 30500
                }
            ],
            "generated_at": "2025-11-12T10:31:00"
        }
    }
```

#### 3.2.5 风险管理接口
```python
# 10. 风险指标
@router.get("/risk/metrics")
async def get_risk_metrics():
    """
    获取当前风险指标
    """
    return {
        "code": 200,
        "message": "success",
        "data": {
            "var_95": -28500,  # 95% VaR
            "var_99": -45800,  # 99% VaR
            "volatility": 0.225,  # 年化波动率
            "max_drawdown": -0.085,  # 当前回撤
            "beta": 1.15,  # Beta系数
            "alpha": 0.032,  # Alpha值
            "concentration_risk": 0.185,  # 集中度风险
            "liquidity_risk": 0.052,  # 流动性风险
            "calculation_date": "2025-11-12",
            "calculation_time": "2025-11-12T10:30:00"
        }
    }

# 11. 预警配置
@router.get("/risk/alerts/config")
async def get_alert_configs():
    """
    获取预警配置
    """
    return {
        "code": 200,
        "message": "success",
        "data": [
            {
                "alert_id": 1,
                "alert_name": "600036价格预警",
                "stock_code": "600036",
                "alert_type": "PRICE",
                "condition_config": {
                    "upper_limit": 35.0,
                    "lower_limit": 30.0
                },
                "notify_methods": ["popup", "email"],
                "is_active": True,
                "created_at": "2025-11-10T10:00:00"
            }
        ]
    }

@router.post("/risk/alerts/config")
async def create_alert_config(alert: AlertConfigCreate):
    """
    创建预警配置
    """
    return {
        "code": 201,
        "message": "Alert config created successfully",
        "data": {
            "alert_id": 123,
            "alert_name": alert.alert_name,
            "created_at": "2025-11-12T10:30:00"
        }
    }

@router.get("/risk/alerts/history")
async def get_alert_history(
    page: int = 1,
    page_size: int = 20,
    start_date: str = None,
    end_date: str = None,
    is_read: bool = None
):
    """
    获取预警历史
    """
    return {
        "code": 200,
        "message": "success",
        "data": [
            {
                "history_id": 1001,
                "alert_id": 1,
                "alert_name": "600036价格预警",
                "trigger_time": "2025-11-12T14:35:00",
                "trigger_value": {"current_price": 35.2, "upper_limit": 35.0},
                "message": "600036招商银行价格突破上限35.0元，当前价格35.2元",
                "is_read": False,
                "read_at": None
            }
        ],
        "pagination": {
            "page": page,
            "page_size": page_size,
            "total": 25,
            "has_next": True
        }
    }
```

#### 3.2.6 交易管理接口
```python
# 12. 交易信号
@router.get("/trading/signals")
async def get_trading_signals():
    """
    获取交易信号列表
    """
    return {
        "code": 200,
        "message": "success",
        "data": [
            {
                "signal_id": 501,
                "stock_code": "600036",
                "stock_name": "招商银行",
                "signal_type": "BUY",
                "signal_strength": 4,  # 1-5星
                "current_price": 32.50,
                "strategy_name": "双均线策略",
                "signal_reason": "MA5上穿MA20，MACD金叉",
                "is_executable": True,  # 是否可执行（A股特化检查）
                "limit_info": {
                    "can_buy": True,
                    "can_sell": True,
                    "limit_up": 35.75,
                    "limit_down": 29.25,
                    "is_limit_up": False,
                    "is_limit_down": False,
                    "t_plus_1": True  # 是否受T+1限制
                },
                "created_at": "2025-11-12T10:30:00"
            }
        ]
    }

# 13. 模拟订单
@router.post("/trading/orders")
async def create_trading_order(order: TradingOrderCreate):
    """
    创建模拟交易订单
    """
    return {
        "code": 201,
        "message": "Trading order created successfully",
        "data": {
            "order_id": 1001,
            "signal_id": order.signal_id,
            "status": "pending",
            "estimated_fill_price": 32.55,
            "created_at": "2025-11-12T10:35:00"
        }
    }

@router.get("/trading/orders")
async def get_trading_orders():
    """
    获取交易订单列表
    """
    return {
        "code": 200,
        "message": "success",
        "data": [
            {
                "order_id": 1001,
                "signal_id": 501,
                "stock_code": "600036",
                "direction": "BUY",
                "quantity": 1000,
                "order_price": 32.50,
                "filled_price": 32.52,
                "filled_quantity": 1000,
                "status": "filled",
                "commission": 9.76,  # A股手续费计算
                "filled_at": "2025-11-12T10:35:30"
            }
        ]
    }

# 14. 持仓查询
@router.get("/trading/positions")
async def get_positions():
    """
    获取当前持仓
    """
    return {
        "code": 200,
        "message": "success",
        "data": {
            "total_market_value": 1250000,
            "total_cost": 1180000,
            "total_unrealized_pnl": 70000,
            "total_positions": 8,
            "positions": [
                {
                    "stock_code": "600036",
                    "stock_name": "招商银行",
                    "total_quantity": 1000,
                    "available_quantity": 0,  # T+1限制
                    "avg_cost": 32.50,
                    "current_price": 32.50,
                    "market_value": 325000,
                    "unrealized_pnl": 0,
                    "unrealized_pnl_rate": 0.0,
                    "position_days": 1,
                    "position_ratio": 0.26,  # 占总仓位比例
                    "stop_loss_price": 29.25,
                    "take_profit_price": 39.00
                }
            ]
        }
    }
```

#### 3.2.7 数据管理接口
```python
# 15. 数据源配置
@router.get("/data/sources")
async def get_data_sources():
    """
    获取数据源配置
    """
    return {
        "code": 200,
        "message": "success",
        "data": [
            {
                "source_id": 1,
                "source_name": "AKShare",
                "source_type": "AKSHARE",
                "is_active": True,
                "last_test_time": "2025-11-12T10:00:00",
                "last_error": None,
                "daily_call_count": 1250,
                "daily_limit": 5000,
                "success_rate": 0.995
            },
            {
                "source_id": 2,
                "source_name": "Tushare Pro",
                "source_type": "TUSHARE",
                "is_active": True,
                "last_test_time": "2025-11-12T10:00:00",
                "last_error": None,
                "token_remaining": 850000,
                "success_rate": 0.998
            }
        ]
    }

# 16. 批量数据下载
@router.post("/data/download/tasks")
async def create_download_task(task: DataDownloadTaskCreate):
    """
    创建数据下载任务
    """
    return {
        "code": 201,
        "message": "Download task created",
        "data": {
            "task_id": 789,
            "status": "pending",
            "estimated_time": "5 minutes",
            "created_at": "2025-11-12T10:30:00"
        }
    }

@router.get("/data/download/tasks/{task_id}")
async def get_download_task_status(task_id: int):
    """
    获取下载任务状态
    """
    return {
        "code": 200,
        "message": "success",
        "data": {
            "task_id": task_id,
            "status": "running",
            "progress": 75,
            "current_step": "下载分钟级数据",
            "downloaded_count": 1500,
            "total_count": 2000,
            "error_count": 2,
            "started_at": "2025-11-12T10:30:00",
            "estimated_completion": "2025-11-12T10:35:00"
        }
    }
```

## 4. WebSocket实时通信规范

### 4.1 WebSocket连接规范
```python
# WebSocket连接配置
ws_config = {
    "连接地址": "/ws",
    "心跳间隔": "30秒",
    "重连策略": "指数退避 (1s, 2s, 4s, 8s, 最大30s)",
    "最大重连次数": 10,
    "消息格式": "JSON",
    "加密": "WSS (生产环境)"
}

# 消息格式标准
ws_message_format = {
    "数据类型": "消息类型标识",
    "消息ID": "唯一消息标识符",
    "时间戳": "服务器时间戳",
    "数据载荷": "具体数据内容"
}
```

### 4.2 WebSocket消息类型
```python
# 1. 心跳消息
@router.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    
    # 心跳响应
    async def heartbeat_handler():
        while True:
            try:
                await asyncio.sleep(30)  # 30秒心跳
                await websocket.send_json({
                    "type": "heartbeat",
                    "message_id": generate_message_id(),
                    "timestamp": get_current_timestamp(),
                    "server_time": get_server_time()
                })
            except WebSocketDisconnect:
                break
```

```python
# 2. 实时行情推送
async def send_quote_update(websocket: WebSocket, stock_code: str):
    """发送实时行情更新"""
    await websocket.send_json({
        "type": "quote_update",
        "message_id": generate_message_id(),
        "timestamp": get_current_timestamp(),
        "data": {
            "stock_code": stock_code,
            "current_price": 32.50,
            "change_amount": 0.50,
            "change_rate": 1.56,
            "volume": 1250000,
            "turnover": 40500000,
            "update_time": get_current_timestamp()
        }
    })

# 3. 预警通知推送
async def send_alert_notification(websocket: WebSocket, alert_data):
    """发送预警通知"""
    await websocket.send_json({
        "type": "alert_notification",
        "message_id": generate_message_id(),
        "timestamp": get_current_timestamp(),
        "data": {
            "alert_id": alert_data.alert_id,
            "alert_name": alert_data.alert_name,
            "stock_code": alert_data.stock_code,
            "alert_type": alert_data.alert_type,
            "trigger_value": alert_data.trigger_value,
            "message": alert_data.message,
            "severity": alert_data.severity  # 'HIGH'/'MEDIUM'/'LOW'
        }
    })

# 4. 任务状态更新推送
async def send_task_status_update(websocket: WebSocket, task_data):
    """发送任务状态更新"""
    await websocket.send_json({
        "type": "task_status",
        "message_id": generate_message_id(),
        "timestamp": get_current_timestamp(),
        "data": {
            "task_id": task_data.task_id,
            "task_type": task_data.task_type,  # 'backtest'/'download'/'calculation'
            "status": task_data.status,  # 'pending'/'running'/'completed'/'failed'
            "progress": task_data.progress,
            "current_step": task_data.current_step,
            "estimated_completion": task_data.estimated_completion
        }
    })

# 5. 系统通知推送
async def send_system_notification(websocket: WebSocket, notification_data):
    """发送系统通知"""
    await websocket.send_json({
        "type": "system_notification",
        "message_id": generate_message_id(),
        "timestamp": get_current_timestamp(),
        "data": {
            "notification_type": notification_data.type,  # 'info'/'warning'/'error'
            "title": notification_data.title,
            "message": notification_data.message,
            "action_required": notification_data.action_required
        }
    })
```

## 5. 数据源适配器规范

### 5.1 适配器基类设计
```python
from abc import ABC, abstractmethod
from typing import List, Dict, Optional, Union
import pandas as pd
from datetime import datetime, date
import asyncio

class BaseDataAdapter(ABC):
    """数据源适配器基类"""
    
    def __init__(self, config: Dict):
        self.config = config
        self.name = config.get('name', 'unknown')
        self.is_active = config.get('is_active', True)
        self.rate_limit = config.get('rate_limit', 100)  # 每分钟请求限制
        self.timeout = config.get('timeout', 30)
        
    @abstractmethod
    async def get_daily_kline(
        self, 
        stock_code: str, 
        start_date: date, 
        end_date: date,
        adjustment: str = "qfq"
    ) -> pd.DataFrame:
        """获取日K线数据"""
        pass
    
    @abstractmethod
    async def get_minute_kline(
        self, 
        stock_code: str, 
        start_time: datetime, 
        end_time: datetime
    ) -> pd.DataFrame:
        """获取分钟K线数据"""
        pass
    
    @abstractmethod
    async def get_stock_basic(self) -> pd.DataFrame:
        """获取股票基本信息"""
        pass
    
    @abstractmethod
    async def get_realtime_quote(self, stock_code: str) -> Dict:
        """获取实时行情"""
        pass
    
    def get_unified_columns(self) -> List[str]:
        """获取统一的数据列名"""
        return [
            'stock_code', 'trade_date', 'open', 'high', 'low', 
            'close', 'volume', 'amount', 'change', 'change_rate'
        ]
    
    def standardize_data(self, df: pd.DataFrame) -> pd.DataFrame:
        """标准化数据格式"""
        # 确保列名一致
        column_mapping = {
            '代码': 'stock_code',
            '股票代码': 'stock_code',
            '日期': 'trade_date',
            '日期时间': 'trade_date',
            '开盘': 'open',
            '收盘': 'close',
            '最高': 'high',
            '最低': 'low',
            '成交量': 'volume',
            '成交额': 'amount',
            '涨跌幅': 'change_rate'
        }
        
        df = df.rename(columns=column_mapping)
        
        # 数据类型转换
        numeric_columns = ['open', 'high', 'low', 'close', 'volume', 'amount']
        for col in numeric_columns:
            if col in df.columns:
                df[col] = pd.to_numeric(df[col], errors='coerce')
        
        # 日期格式转换
        if 'trade_date' in df.columns:
            df['trade_date'] = pd.to_datetime(df['trade_date']).dt.date
        
        return df[self.get_unified_columns()]
```

### 5.2 AKShare适配器实现
```python
class AkshareAdapter(BaseDataAdapter):
    """AKShare数据源适配器"""
    
    def __init__(self, config: Dict):
        super().__init__(config)
        try:
            import akshare as ak
            self.ak = ak
            self.logger.info("AKShare adapter initialized successfully")
        except ImportError:
            self.logger.error("AKShare not installed")
            raise
    
    async def get_daily_kline(
        self, 
        stock_code: str, 
        start_date: date, 
        end_date: date,
        adjustment: str = "qfq"
    ) -> pd.DataFrame:
        """获取AKShare日K线数据"""
        try:
            # 转换股票代码格式
            formatted_code = self._format_stock_code(stock_code)
            
            # 根据复权类型选择参数
            adjust_map = {
                "qfq": "qfq",  # 前复权
                "hfq": "hfq",  # 后复权
                "no": ""       # 不复权
            }
            
            adj = adjust_map.get(adjustment, "qfq")
            
            # 调用AKShare接口
            df = self.ak.stock_zh_a_hist(
                symbol=formatted_code,
                period="daily",
                start_date=start_date.strftime("%Y%m%d"),
                end_date=end_date.strftime("%Y%m%d"),
                adjust=adj
            )
            
            if df.empty:
                self.logger.warning(f"No data found for {stock_code}")
                return pd.DataFrame()
            
            return self.standardize_data(df)
            
        except Exception as e:
            self.logger.error(f"Error fetching daily kline for {stock_code}: {e}")
            raise
    
    async def get_minute_kline(
        self, 
        stock_code