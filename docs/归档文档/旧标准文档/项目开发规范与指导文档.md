项目开发规范与指导文档

目录
[1. 本文的地位和作用](#1-本文的地位和作用)
[2. 项目角色与职责](#2.项目角色与职责)
[3. 业务处理范围](#3.业务处理范围)
    [3.1 支持的业务](#3.1支持的业务)
    [3.2 不支持的业务](#3.2不支持的业务)
[4. 文档与代码规范](#4.文档与代码规范)
    [4.1 Markdown 文档规范](#41-Markdown文档规范)
        [4.1.1 文档头部模板](#411-文档头部模板)
        [4.1.2 命名与格式](#412-命名与格式)
    [4.2 Python 程序规范](#42-Python程序规范)
        [4.2.1 头部注释模板](#421-头部注释模板)
        [4.2.2 函数或类注释规范](#422-函数或类注释规范)
[5. 目录结构设计](#5.目录结构设计)
[6. 临时目录管理](#6.临时目录管理)
[7. 代码管理核心目标](#7.代码管理核心目标)
[8. 文档管理要求](#8.文档管理要求)
[9. 开发约定](#9.开发约定)
[10. 环境与配置说明](#10.环境与配置说明)
[11. AI 交互规则](#11.AI交互规则)
[术语表](#术语表)

# 1. 本文的地位和作用
本文档是项目开发的最高指导规范，所有开发、测试、使用行为均需遵循。文档内容具有强制性，任何冲突以本文为准，修订需经最高管理者审批。

# 2. 项目角色与职责
最高管理者 / 创建人 / 最终审批人：JohnC
负责项目方向决策、规则审批及最终验收，工作语言为中文（代码 / 命令 / 参数可使用英文）。
执行角色：
AI 工具（Claude、iFlow、Spec-Kit 等）：按本文规范生成代码、文档，主动检查合规性。
其他开发者：遵循本文规范开展开发，提交变更需经 JohnC 审批。

# 3. 业务处理范围
# 3.1 支持的业务
核心必选：
国内 A 股（沪市 60 开头、深市 00 开头、创业板 30 开头）的行情、交易数据处理。
国内合规股指期货（沪深 300、中证 500、上证 50 股指期货）。
可选扩展：
港股（H 股）：仅支持 A+H 股联动分析，需预留接口（命名格式：xxx_hk_bridge）。
接口要求：未支持的可选业务需预留扩展接口，参数需包含extra字段（示例：def fetch_hk_data(stock_code, extra=None):）。
# 3.2 不支持的业务
明确排除：期货（除 3.1 指定品种）、期权、外汇、黄金、美股。
处理规则：现有代码中若包含以上内容，需彻底删除，并在文档修订记录中注明 “移除 XX 非必要功能”。

# 4. 文档与代码编写规范
## 4.1 Markdown文档规范
### 4.1.1 文档头部模板
所有 MD 文档必须包含以下元数据（固定格式）：
markdown
---
创建人: [实际创建者，如JohnC、iFlow]
版本: x.y.z（主版本.次版本.修订号）
批准日期: YYYY-MM-DD（首次批准日期）
最后修订: YYYY-MM-DD（最近修改日期）
本次修订内容: 简要描述修改点（如“新增A股接口规范”“修复目录结构描述错误”）
---
### 4.1.2 命名与格式
文件名：小写字母 + 下划线（如a_stock_analysis_spec.md），禁止中文 / 特殊字符。
内容：使用中文撰写，技术术语需注明（如 “ETF（交易型开放式指数基金）”）。

## 4.2 Python程序规范
### 4.2.1 头部注释模板
所有.py文件必须包含头部注释（示例）：
---
# -*- coding: utf-8 -*-
# 功能：A股日线数据爬取与存储模块
#      从新浪财经接口获取指定股票的日线数据（开盘价、收盘价、成交量等），
#      进行数据清洗（去重、补全缺失值）后，增量写入PostgreSQL数据库。
# 作者：JohnC (ninjas@sina.com)、iFlow（如有协作）
# 日期：2025-09-15（创建日期）
# 版本：v2.1.0
# 修改记录：
# 2025-10-10 JohnC 修复创业板代码解析错误
# 依赖：Python 3.8+, pandas>=2.0.0, requests>=2.26.0, psycopg2-binary>=2.9.5
# 注意事项：
# 1. 需在config.yaml中配置数据库连接参数和API调用间隔（建议≥3秒）
# 2. 创业板股票需调用扩展接口（/api/gem/xxx）
# 版权：© 2025 All rights reserved.
---

### 4.2.2 函数或类注释规范
采用Google 风格注释，示例：
---
python
运行
def crawl_daily_data(stock_code: str, start_date: str) -> pd.DataFrame:
    """爬取A股日线数据

    从新浪财经接口获取指定股票的日线数据，返回清洗后的DataFrame

    Args:
        stock_code: 股票代码（如"600000"，不含后缀）
        start_date: 开始日期（格式"YYYY-MM-DD"）

    Returns:
        pd.DataFrame: 包含字段[date, open, high, low, close, volume]

    Raises:
        RequestException: 接口调用失败时抛出
        ValueError: 股票代码格式错误时抛出
    """
---

# 5. 目录结构设计
采用三层目录结构（功能 / 模块 + 生命周期 / 类型），示例：
plaintext
project_root/                  # 项目根目录
├─ data_crawl/                 # 功能模块1：数据爬取
│  ├─ scripts/                 # 可执行脚本
│  ├─ tests/                   # 测试文件（test_*.py）
│  └─ docs/                    # 模块文档
├─ analysis/                   # 功能模块2：数据分析
│  ├─ scripts/
│  ├─ tests/
│  └─ docs/
├─ common/                     # 公共模块（工具函数、常量等）
├─ config/                     # 配置文件（config.yaml、.env等）
└─ temp/                       # 临时目录（见6.临时目录管理）
命名规则：小写字母 + 下划线，禁止中文 / 空格 / 特殊字符。
单一职责：每个目录仅包含同类功能文件（如tests/只放测试代码）。

#  6. 临时目录管理
目录路径：project_root/temp/
用途：存放过渡期产物、外来项目代码（非本项目最终代码）。
add.md 文件规范（必存，只增不减）：
markdown
---
创建人: JohnC
版本: 1.0.0
批准日期: 2025-10-09
最后修订: 2025-10-09
本次修订内容: 初始化临时目录记录
---

## 外来项目：xxx_tool
- 迁移内容：文件xxx.py、目录yyy/
- 迁移日期：2025-10-09
- 迁移人：JohnC
- 状态：待审核（未迁移至正式目录）

## 外来项目：zzz_script
- 迁移内容：...
权限控制：temp/外的目录对AI为只读（目录中的数据除非JohnC 明确指令，否则不得修改）。

# 7. 代码管理核心目标
通过以下维度实现低耦合、高可读性、易维护：
目录结构：遵循 5. 的三层设计，直观反映功能划分。
命名规范：见 4.2.2 和 5. 的命名规则，见名知意。
功能分类：公共逻辑抽离至common/，避免重复代码。
文档配套：每个模块需包含docs/目录，记录设计思路和接口说明。
依赖管理：通过requirements.txt或environment.yml（Conda）统一管理依赖。
代码修改：请严格依据本文件同级目录下的文件：代码修改规则.md

# 8. 文档管理要求
自动生成限制：Claude、iFlow 等工具生成文档 / 代码后，需经 JohnC 确认方可保留，禁止擅自新建。
冗余文件处理：
根目录下无关文件 / 空文件：移至temp/unused/，观察 30 天后请示 JohnC 删除。
测试文件（test_*.py）：统一存放于模块的tests/目录，过期测试文件移至temp/expired_tests/。
Git 版本控制：
.gitignore需包含：.env、temp/、logs/、venv/、IDE 配置（如.vscode/）、依赖目录（__pycache__/）。

# 9. 开发约定
代码风格：严格遵循 PEP8（使用black自动格式化，flake8检查）。
类型注解：所有函数 / 方法必须添加参数和返回值类型注解（示例见 4.2.2）。
模块化设计：单个文件代码量不超过 500 行，复杂功能拆分为多个模块。
错误处理：使用自定义异常类（如StockDataError），禁止裸except:。
日志规范：使用logging模块，格式为[时间] [模块] [级别] 内容（如2025-10-09 10:00:00 [crawl] INFO: 开始爬取600000）。

# 10. 环境与配置说明
Python 环境：使用 Conda 管理，环境名统一为stock，配置文件为environment.yml。
配置文件.env模板：
---
ini
DB_HOST=localhost
DB_PORT=5432
DB_USER=stock_user
DB_PASS=xxxxxx
API_TIMEOUT=30
---
模式切换：通过config.yaml的mode字段控制（local：本地 TDX 接口；online：在线 adapter）。

# 11. AI工具交互规则
AI工具必须遵守：
歧义处理：对规则理解有歧义时，立即输出确认请求（如 “请确认‘港股联动分析’是否需要包含港股通数据？”）。
合规自查：生成代码 / 文档后，自动检查是否符合本文规范（如是否包含美股代码、注释是否完整），并输出自查结果。
操作限制：涉及删除文件、修改config/目录、变更数据库 schema 等操作时，需先输出操作计划，经 JohnC 回复 “同意” 后执行。
反馈机制：若发现规范存在冲突或不合理之处，输出 “建议优化：xxx”，由 JohnC 决定是否修订。

# 术语表
A 股：人民币普通股票，包括沪市（60 开头）、深市（00 开头）、创业板（30 开头）。
股指期货：以股票指数为标的的期货合约（本文特指沪深 300、中证 500、上证 50 股指期货）。
AI工具：指 Claude、iFlow、CodeX、Spec-Kit 等参与代码 / 文档生成的人工智能工具。
TDX接口：通达信软件的数据接口，用于本地模式获取行情。
