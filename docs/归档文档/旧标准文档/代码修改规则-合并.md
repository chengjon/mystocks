# AI 代码修改规则与最佳实践（通用版）

## 1 概述
本规则档旨在为 AI 辅助的代码修改与自动化修复提供一套通用、可执行的流程与检查清单。目标是平衡变更速度与系统可靠性：在保证架构合规与可回溯的前提下，允许 AI 在受控范围内进行代码修改并自动完成大部分验证。适用于多种项目（库、服务、脚本、数据处理、迁移等）。

核心原则：最小变更、分层验证、可回溯、透明化、架构合规与知识沉淀。

---

## 2 作用与适用场景
- 日常 bug 修复与小范围功能增强
- 性能优化（模块内）
- 配置、测试、文档层面的改进
- 重大或跨模块改动须触发人工审核

不建议 AI 直接修改：生产关键交易执行、核心风险控制、数据库 schema/migrations、任何被明示保护的文件（见 3 节）。

---

## 3 保护范围（PROTECTED）
在项目根目录应存在 `PROTECTED.md`（或在本规则中明确清单）列出禁止 AI 自动修改的核心模块/路径。例如：

- `/core/` 下交易/风控/仓位管理代码
- `/db/schema/`、`/db/migrations/`、迁移脚本
- 任何带有 `core`、`executor`、`risk`、`position`、`production-only` 等标签的文件

规则：AI 在开始任何修改前必须检查其修改路径是否落在保护范围内；若涉及，停止自动修改并生成修改建议与人工审批单。建议在仓库根目录维护 `PROTECTED.md`，AI 每次变更读取并校验。

---

## 4 最小变更与扩展优先
- 只修改为完成目标所必需的最小代码块（函数/小模块）。
- 修复 bug 时尽量避免同时重构或优化无关逻辑。若发现其他问题，单独开 issue/分支并记录为独立任务。
- 优先新增扩展函数而非改变现有公共接口：通过扩展 API 保持向后兼容性。

示例：新增市场线种支持时，创建 `crawl_gem_data()` 而非直接改 `crawl_a_data()` 的内部逻辑。

---

## 5 变更前的影响评估（AI 必须输出）
修改前，AI 必须列出：
- 直接修改的文件与函数
- 间接依赖的模块与可能受影响的调用方
- 修改等级（函数/模块/跨模块/核心模块）与风险等级（低/中/高/极高）
- 预期回滚方案（简单恢复命令或保留旧实现的备份）

风险矩阵（示例）：
- 单个函数：低（AI 可直接修改并添加单元测试）
- 单个模块：中（需要单元 + 集成测试）
- 跨模块：高（需人工审核与全量回归）
- 保护范围：极高（禁止自动修改，必须人工审核）

---

## 6 架构合规（Config-Driven 等）
若项目采用配置驱动或有严格的架构约束，AI 必须：
- 确认所有可配置项在配置文件中有定义；不得硬编码替代配置
- 不得绕过配置管理器；遇到配置驱动工具报错，应优先修复工具实现而非编写临时独立脚本
- 对数据库及 ORM 映射类特别谨慎（见 6.1）

### 6.1 ORM / PostgreSQL 特殊注意
- PostgreSQL 的 ENUM type 必须显式指定 `name` 参数（例如：`SQLEnum(..., name='xxx_enum')`）
- 默认值、JSONB、ARRAY 等字段需显式处理类型与序列化
- 批量插入前校验类型一致性，避免依赖数据库隐式类型推断

---

## 7 分层验证机制（必须全部执行）
修改提交必须通过三个层级的验证：AI 自检 → 自动化测试 → 人工审核（按条件触发）。

### 7.1 第一层：AI 自检（必须自动运行）
- 语法检查：pylint/flake8 或等效工具
- 单元测试（受影响范围内的测试）——若无测试须补充至少一条
- 依赖兼容性检查（requirements/pyproject 等）
- 保护范围校验
- 变更影响评估报告（见第 5 节）
- 如果涉及迁移/数据库变更，生成或更新迁移脚本并验证降级路径

AI 自检应输出自查报告模板（见附录）。

### 7.2 第二层：自动化测试与 CI
- 单元测试覆盖受修改代码的主要路径，覆盖率目标可由项目定义（常见 ≥80%）
- 集成/端到端用例：若修改跨模块或影响数据流，必须运行相关集成测试
- CI 必包含：依赖安装、语法检查、单元测试、BUG 冲突检查（可选自定义脚本）、必要的集成测试

建议 CI 步骤示例（GitHub Actions/其它 CI）：
1. 安装依赖
2. 语法检查（pylint/flake8）
3. 单元测试（含回归用例）
4. 可选：静态安全扫描、依赖漏洞扫描
5. 标注本次变更关联的 BUG ID / issue

### 7.3 第三层：人工审核（触发条件）
触发人工审核的场景：
- 修改进入 `PROTECTED.md` 列表的文件
- 变更范围跨模块或影响重大设计
- 自动化测试出现新增失败用例
- 模块历史存在多个未解决的 BUG（例如 ≥3 次）
- 涉及数据库 schema、数据迁移或影响生产数据

人工审核应包含：变更申请单、影响评估、回滚计划、关联测试清单。

---

## 8 版本控制与回滚
- 修改必须基于 `main`（或项目规定的基线）新建分支：`feature/xxx`、`hotfix/bug-<id>` 等
- PR 合并前必须通过 CI 并通过人工审核（若触发）
- 每次合并应记录关联的 BUG/issue ID
- 回滚策略：提供简洁的回滚命令或脚本（例如 `git revert` / `git reset --hard <tag>`），并在 PR 描述中写明回滚步骤

---

## 9 BUG 记录与知识库
- 每次修复必须在知识库（例如 `ERROR_CASES.md` 或 `BUGS/` 文件夹）记录：
  - BUG ID、时间、影响范围、根因、修复方案、预防措施、回归测试
- AI 在变更前必须搜索该模块的历史 BUG 记录并在变更申请或自检报告中列出参考案例
- 每个 BUG 至少对应一条单元测试，确保回归覆盖

---

## 10 模板与清单（可直接使用）

### 10.1 AI 自检报告模板（简版）
```
=== AI 自检报告 ===
修改时间：YYYY-MM-DD HH:MM
修改分支：feature/...
修改文件：list of files
修改类型：bugfix/feature/refactor
关联 BUG/ISSUE：#123 (可选)
自检结果：
1. 语法检查：通过/失败（详情）
2. 单元测试：通过/失败（命名关键测试）
3. 影响评估：列出直接/间接影响
4. 回滚计划：保留旧实现/回滚脚本路径
5. 是否触发人工审核：是/否（理由）
```

### 10.2 变更申请单（简版）
```
## 变更申请单
申请人：AI Assistant
申请时间：YYYY-MM-DD
关联 BUG ID：#123
变更摘要：一句话描述变更目的
修改文件：
- path/to/file.py - 说明
关联测试：列出新增/修改的测试
回滚方案：命令或脚本路径
人工审核意见：待填写
```

### 10.3 Checklist（每次变更必须完成）
- [ ] 检查 `PROTECTED.md` 是否涉及
- [ ] 输出影响评估报告
- [ ] 增加或更新单元测试（至少 1 条）
- [ ] 通过本地语法检查与测试
- [ ] CI 通过所有检查
- [ ] 若触发人工审核，提交变更申请单并等待批准
- [ ] 更新知识库（BUG/ERROR_CASES）并关联 BUG ID

---

## 11 可执行建议与范例
- 若遇到 ConfigDriven 表创建报错：不要临时用独立 SQL 创建表。应定位并修复 ConfigDrivenTableManager（例如修复 ENUM 未指定 name），删除手工创建的表并通过配置重新创建。
- 数据库字段类型问题：显式转换默认值与序列化 JSONB 字段，避免依赖隐式推断。

---

## 12 交付与验收（AI 完成变更后的说明）
交付内容应包含：
- PR 或补丁（含清晰的变更说明）
- AI 自检报告
- 新增/修改的测试文件
- 若有 DB 改动，包含向前/向后迁移脚本
- 更新后的知识库条目（若修复 BUG）

验收标准：
- 本地与 CI 测试通过
- 无安全/漏洞扫描阻断项
- 若需人工审核，审核批准

---

## 13 质量门禁（快速三项）
在合并前，至少保证：
- Build/测试：PASS
- Lint/静态分析：PASS
- 回归测试（关键路径）：PASS

若任一项 FAIL，不能合并。

---

## 14 附录：快速参考命令（示例）
下面命令仅为示例，按项目实际工具链调整：

```bash
# 建分支、提交、推送
git checkout -b feature/your-feature
git add .
git commit -m "feat: 描述"
git push origin feature/your-feature

# 本地运行测试
pytest tests/ -q

# 语法检查示例
pylint your_package/ || flake8 your_package/
```

---

## 15 结语
这份通用规则把两份文档的要点整合并泛化，既保留了对配置驱动与数据库 ORM 的具体注意事项，也添加了更广泛的变更流程、检查清单与模板。AI 在自动修改代码时应严格按本规则执行：先自检、再走自动化测试、最后在必要时请人审核；同时把每次变更与 BUG 教训记录到知识库，形成持续改进闭环。


*文件路径：`/opt/claude/mystocks_spec/代码修改规则-合并.md`*
