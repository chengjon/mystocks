# 4. è‚¡ç¥¨ç®¡ç†é¡µé¢_ä¼˜åŒ–ç‰ˆ

## åŠŸèƒ½å®šä½

ç»Ÿä¸€ç®¡ç†è‡ªé€‰è‚¡ã€ç­–ç•¥é€‰è‚¡ã€è¡Œä¸šé€‰è‚¡ã€æ¦‚å¿µé€‰è‚¡å››å¤§è‚¡ç¥¨æ± ï¼Œå¹¶ä½œä¸ºä»ªè¡¨ç›˜æ¿å—è¡¨ç°çš„é…ç½®ä¸­å¿ƒã€‚**é‡ç‚¹æ–°å¢Kçº¿å›¾å¯è§†åŒ–åŠŸèƒ½**ï¼Œæ”¯æŒKlinechartç”Ÿæˆä¸“ä¸šKçº¿å›¾ã€‚

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### Tab1: è‡ªé€‰è‚¡ç®¡ç† (Watchlist Management)

#### è‚¡ç¥¨æ± ç®¡ç†é¢æ¿
```python
# å·¦ä¾§åˆ†ç»„æ ‘å½¢ç»“æ„ (ui.left_drawer)
with ui.left_drawer().style("width: 300px; background-color: #fafafa"):
    # åˆ†ç»„æ ‘å½¢åˆ—è¡¨
    watchlist_tree = ui.tree([
        ui.tree_node("ğŸ“Š æ ¸å¿ƒæŒä»“æ±  (8åª)", icon="star", filled=True, color="primary"),
        ui.tree_node("âš¡ çŸ­çº¿è§‚å¯Ÿæ±  (20åª)", icon="bolt", color="orange"),
        ui.tree_node("ğŸ“ˆ é•¿çº¿ä»·å€¼æ±  (15åª)", icon="trending_up", color="green"),
        ui.tree_node("ğŸ“ è‡ªå®šä¹‰åˆ†ç»„", icon="folder", color="blue")
    ])

    # å¿«é€Ÿæ“ä½œæŒ‰é’®ç»„
    with ui.column().style("gap: 8px; margin-top: 16px"):
        ui.button("æ–°å»ºåˆ†ç»„", icon="add", on_click=create_group_dialog).style("width: 100%")
        ui.button("æ‰¹é‡å¯¼å…¥", icon="upload", on_click=batch_import_dialog).style("width: 100%")
        ui.button("å¿«é€Ÿæ·»åŠ ", icon="playlist_add", on_click=quick_add_dialog).style("width: 100%")
        ui.button("å¯¼å‡ºæ•°æ®", icon="download", on_click=export_data).style("width: 100%")
```

#### è‡ªé€‰è‚¡ä¸»è¡¨æ ¼ (å¸¦Kçº¿å¯è§†åŒ–)
```python
# è‡ªé€‰è‚¡è¡¨æ ¼ (ui.aggrid)
columns = [
    {"field": "code", "headerName": "ä»£ç ", "width": 100, "pinned": "left"},
    {"field": "name", "headerName": "åç§°", "width": 120, "pinned": "left"},
    {"field": "current_price", "headerName": "æœ€æ–°ä»·", "width": 100, "valueFormatter": "value.toFixed(2)"},
    {"field": "change_pct", "headerName": "æ¶¨è·Œå¹…", "width": 100, "cellClassRules": {
        "text-positive": "data.change_pct > 0",
        "text-negative": "data.change_pct < 0"
    }},
    {"field": "volume", "headerName": "æˆäº¤é‡", "width": 120},
    {"field": "group_name", "headerName": "æ‰€å±åˆ†ç»„", "width": 120},
    {"field": "add_time", "headerName": "æ·»åŠ æ—¥æœŸ", "width": 120},
    {"field": "note", "headerName": "å¤‡æ³¨", "width": 150},
    {"field": "actions", "headerName": "æ“ä½œ", "width": 150, "cellRenderer": "actionButtons"}
]

watchlist_grid = ui.aggrid(
    options={
        "rowData": watchlist_data,
        "columnDefs": columns,
        "rowSelection": "multiple",
        "enableRangeSelection": True,
        "suppressRowClickSelection": True,
        "defaultColDef": {"sortable": True, "filter": True, "resizable": True},
        "animateRows": True,
        "rowHeight": 40
    },
    theme="balham"
)

# å³é”®èœå• - é‡ç‚¹æ–°å¢Kçº¿å›¾åŠŸèƒ½
def show_context_menu(event):
    with ui.menu() as menu:
        ui.menu_item("ğŸ”— æŸ¥çœ‹Kçº¿å›¾", icon="timeline", on_click=lambda: show_kline_chart(event['data']))
        ui.menu_item("ğŸ“Š æŠ€æœ¯åˆ†æ", icon="analytics", on_click=lambda: show_technical_analysis(event['data']))
        ui.menu_item("ğŸ”„ ç§»åŠ¨åˆ†ç»„", icon="swap_horiz", on_click=lambda: move_to_group(event['data']))
        ui.menu_item("âœï¸ ç¼–è¾‘å¤‡æ³¨", icon="edit", on_click=lambda: edit_note(event['data']))
        ui.menu_item("ğŸ”” è®¾ç½®é¢„è­¦", icon="notifications", on_click=lambda: set_alert(event['data']))
        ui.separator()
        ui.menu_item("ğŸ—‘ï¸ åˆ é™¤è‚¡ç¥¨", icon="delete", on_click=lambda: remove_stock(event['data']))
```

#### Kçº¿å›¾å¯è§†åŒ–ç»„ä»¶ (æ ¸å¿ƒæ–°å¢åŠŸèƒ½)
```python
# Kçº¿å›¾å¼¹çª— (ui.dialog)
@ui.page('/stock/kline/{stock_code}')
async def show_kline_chart(stock_data):
    """ä½¿ç”¨Klinechartç”Ÿæˆä¸“ä¸šKçº¿å›¾"""

    stock_code = stock_data['code']
    stock_name = stock_data['name']

    with ui.dialog().style("width: 90vw; height: 90vh"):
        with ui.card().style("width: 100%; height: 100%; padding: 0"):
            # æ ‡é¢˜æ 
            with ui.card().style("margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white"):
                with ui.row().style("justify-content: space-between; align-items: center; padding: 16px"):
                    stock_info = ui.column().style("gap: 4px")
                    stock_info.push(ui.label(f"{stock_name} ({stock_code})").style("font-size: 18px; font-weight: bold"))
                    stock_info.push(ui.label(f"æœ€æ–°ä»·: {stock_data['current_price']} | æ¶¨è·Œå¹…: {stock_data['change_pct']}%").style("font-size: 12px"))

                    with ui.row().style("gap: 8px"):
                        ui.button("æ·»åŠ è‡ªé€‰", icon="star", on_click=lambda: add_to_watchlist(stock_data)).style("background-color: rgba(255,255,255,0.2); color: white; border: none")
                        ui.button("è®¾ç½®é¢„è­¦", icon="notifications", on_click=lambda: set_price_alert(stock_data)).style("background-color: rgba(255,255,255,0.2); color: white; border: none")
                        ui.button("ğŸ—™", on_click=lambda: kline_dialog.close()).style("background-color: rgba(255,255,255,0.2); color: white; border: none; width: 32px; min-width: 32px")

            # æ—¶é—´å‘¨æœŸé€‰æ‹©å™¨
            with ui.card().style("margin: 0; background-color: #f8f9fa; border-radius: 0"):
                with ui.row().style("padding: 12px 16px; gap: 8px; align-items: center"):
                    ui.label("æ—¶é—´å‘¨æœŸ:").style("font-weight: bold; color: #495057")

                    periods = ["1åˆ†", "5åˆ†", "15åˆ†", "30åˆ†", "1å°æ—¶", "1æ—¥", "1å‘¨", "1æœˆ"]
                    for i, period in enumerate(periods):
                        btn_class = "period-btn active" if i == 5 else "period-btn"  # é»˜è®¤é€‰æ‹©1æ—¥
                        ui.button(
                            period,
                            on_click=lambda p=period: switch_period(p),
                            style=f"""
                            padding: 4px 12px;
                            font-size: 12px;
                            border-radius: 16px;
                            border: 1px solid #dee2e6;
                            background-color: {'#007bff' if i == 5 else 'white'};
                            color: {'white' if i == 5 else '#6c757d'};
                            margin-right: 4px;
                            """
                        )

            # Klinechart Kçº¿å›¾ä¸»ä½“
            with ui.row().style("flex: 1; margin: 0; height: calc(90vh - 200px)"):
                # Kçº¿å›¾ä¸»åŒºåŸŸ (70%)
                with ui.column().style("flex: 7; padding: 0"):
                    ui.html(f"""
                    <div id="kline_chart_{stock_code}" style="width: 100%; height: 100%; background-color: #1a1a1a; border-radius: 0 0 8px 8px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 14px;">
                            <div style="text-align: center;">
                                <div style="margin-bottom: 8px;">ğŸ“ˆ Klinechart Kçº¿å›¾åŠ è½½ä¸­...</div>
                                <div style="font-size: 12px; color: #999;">æ­£åœ¨è·å– {stock_name} çš„Kçº¿æ•°æ®</div>
                            </div>
                        </div>
                    </div>
                    <script>
                        // åŠ¨æ€åŠ è½½TradingViewè„šæœ¬
                        const script = document.createElement('script');
                        script.src = 'https://s3.tradingview.com/tv.js';
                        script.onload = function() {{
                            initializeTradingViewChart('{stock_code}', '{stock_name}');
                        }};
                        document.head.appendChild(script);

                        function initializeTradingViewChart(symbol, name) {{
                            const containerId = 'kline_chart_' + symbol;
                            const container = document.getElementById(containerId);

                            new TradingView.widget({{
                                "width": "100%",
                                "height": "100%",
                                "symbol": symbol,
                                "interval": "D",
                                "timezone": "Asia/Shanghai",
                                "theme": "dark",
                                "style": "1",
                                "locale": "zh_CN",
                                "toolbar_bg": "#f1f3f6",
                                "enable_publishing": false,
                                "allow_symbol_change": true,
                                "container_id": containerId,
                                "hide_side_toolbar": false,
                                "hide_top_toolbar": false,
                                "studies": [
                                    "MACD@tv-basicstudies",
                                    "RSI@tv-basicstudies",
                                    "KDJ@tv-basicstudies"
                                ],
                                "disabled_features": ["use_localstorage_for_settings"],
                                "enabled_features": ["study_templates"],
                                "load_last_chart": true,
                                "autosize": true,
                                "datafeed": new Datafeeds.UDFCompatibleDatafeed("https://demo-feed.investing.com")
                            }});
                        }}

                        // è·å–Kçº¿æ•°æ®
                        async function fetchKlineData(symbol, interval = "D", range = "1M") {{
                            try {{
                                const response = await fetch(`/api/v1/kline/${{symbol}}?interval=${{interval}}&range=${{range}}`);
                                const data = await response.json();
                                return data;
                            }} catch (error) {{
                                console.error('è·å–Kçº¿æ•°æ®å¤±è´¥:', error);
                                return null;
                            }}
                        }}
                    </script>
                    """)

                # æŠ€æœ¯æŒ‡æ ‡å’Œæ“ä½œé¢æ¿ (30%)
                with ui.column().style("flex: 3; background-color: #f8f9fa; padding: 16px; overflow-y: auto"):
                    # æŠ€æœ¯æŒ‡æ ‡é€‰æ‹©
                    with ui.card().style("margin-bottom: 16px; background-color: white"):
                        ui.label("ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡").style("font-size: 14px; font-weight: bold; margin-bottom: 8px")

                        with ui.column().style("gap: 8px"):
                            # ç§»åŠ¨å¹³å‡çº¿
                            ui.label("ç§»åŠ¨å¹³å‡çº¿:").style("font-size: 12px; color: #666")
                            with ui.row().style("gap: 4px; flex-wrap: wrap"):
                                for ma in ["MA5", "MA10", "MA20", "MA60"]:
                                    ui.checkbox(ma, value=False, on_change=lambda ma=ma: toggle_ma_indicator(ma))

                            # æŠ€æœ¯æŒ‡æ ‡
                            ui.label("æŠ€æœ¯æŒ‡æ ‡:").style("font-size: 12px; color: #666; margin-top: 8px")
                            with ui.column().style("gap: 4px"):
                                ui.checkbox("MACD", value=False, on_change=lambda: toggle_technical_indicator("MACD"))
                                ui.checkbox("KDJ", value=False, on_change=lambda: toggle_technical_indicator("KDJ"))
                                ui.checkbox("RSI", value=False, on_change=lambda: toggle_technical_indicator("RSI"))
                                ui.checkbox("å¸ƒæ—å¸¦", value=False, on_change=lambda: toggle_technical_indicator("BOLL"))
                                ui.checkbox("æˆäº¤é‡", value=True, on_change=lambda: toggle_volume_indicator())

                    # äº¤æ˜“ä¿¡å·
                    with ui.card().style("margin-bottom: 16px; background-color: white"):
                        ui.label("ğŸ¯ äº¤æ˜“ä¿¡å·").style("font-size: 14px; font-weight: bold; margin-bottom: 8px")
                        signals_list = ui.column().style("gap: 4px")

                        # æ¨¡æ‹Ÿä¿¡å·æ•°æ®
                        signals = [
                            ("MACDé‡‘å‰", "positive", "å¼ºçƒˆä¹°å…¥ä¿¡å·"),
                            ("RSIè¶…å–", "warning", "å¯èƒ½åå¼¹"),
                            ("æˆäº¤é‡æ”¾å¤§", "info", "å…³æ³¨çªç ´")
                        ]

                        for signal, level, desc in signals:
                            signal_color = {"positive": "#d4edda", "warning": "#fff3cd", "info": "#d1ecf1"}[level]
                            text_color = {"positive": "#155724", "warning": "#856404", "info": "#0c5460"}[level]

                            signals_list.push(ui.label(f"ğŸ”¸ {signal}: {desc}").style(f"background-color: {signal_color}; color: {text_color}; padding: 4px 8px; border-radius: 4px; font-size: 12px"))

                    # å¿«é€Ÿæ“ä½œ
                    with ui.card().style("background-color: white"):
                        ui.label("âš¡ å¿«é€Ÿæ“ä½œ").style("font-size: 14px; font-weight: bold; margin-bottom: 8px")

                        with ui.column().style("gap: 8px"):
                            ui.button("åŠ å…¥è‡ªé€‰è‚¡", icon="star", on_click=lambda: add_to_watchlist(stock_data)).style("width: 100%; background-color: #28a745; color: white")
                            ui.button("è®¾ç½®ä»·æ ¼é¢„è­¦", icon="notifications", on_click=lambda: set_price_alert(stock_data)).style("width: 100%; background-color: #ffc107; color: black")
                            ui.button("æŸ¥çœ‹è´¢åŠ¡æ•°æ®", icon="account_balance", on_click=lambda: show_financial_data(stock_data)).style("width: 100%; background-color: #17a2b8; color: white")
                            ui.button("åˆ†äº«å›¾è¡¨", icon="share", on_click=lambda: share_chart(stock_data)).style("width: 100%; background-color: #6c757d; color: white")

# åˆ‡æ¢Kçº¿æ—¶é—´å‘¨æœŸ
def switch_period(period):
    """åˆ‡æ¢Kçº¿æ—¶é—´å‘¨æœŸ"""
    # æ›´æ–°æŒ‰é’®æ ·å¼
    ui.run_javascript(f"""
        document.querySelectorAll('.period-btn').forEach(btn => {{
            btn.style.backgroundColor = 'white';
            btn.style.color = '#6c757d';
        }});
        event.target.style.backgroundColor = '#007bff';
        event.target.style.color = 'white';
    """)

    # é‡æ–°åŠ è½½Kçº¿æ•°æ®
    ui.run_javascript(f"""
        if (window.TradingView && window.TradingView.widget) {{
            // é‡æ–°åˆå§‹åŒ–å›¾è¡¨
            const widget = new TradingView.widget({{
                interval: '{get_tradingview_interval(period)}'
            }});
        }}
    """)

def get_tradingview_interval(period):
    """å°†æˆ‘ä»¬çš„å‘¨æœŸè½¬æ¢ä¸ºTradingViewæ ¼å¼"""
    mapping = {
        "1åˆ†": "1",
        "5åˆ†": "5",
        "15åˆ†": "15",
        "30åˆ†": "30",
        "1å°æ—¶": "60",
        "1æ—¥": "D",
        "1å‘¨": "W",
        "1æœˆ": "M"
    }
    return mapping.get(period, "D")

# æŠ€æœ¯æŒ‡æ ‡åˆ‡æ¢
def toggle_technical_indicator(indicator):
    """åˆ‡æ¢æŠ€æœ¯æŒ‡æ ‡æ˜¾ç¤º"""
    ui.run_javascript(f"""
        if (window.tvWidget && window.tvWidget.chart) {{
            try {{
                switch('{indicator}') {{
                    case 'MACD':
                        window.tvWidget.chart().createStudy('MACD', false, false);
                        break;
                    case 'KDJ':
                        window.tvWidget.chart().createStudy('KDJ', false, false);
                        break;
                    case 'RSI':
                        window.tvWidget.chart().createStudy('RSI', false, false);
                        break;
                    case 'BOLL':
                        window.tvWidget.chart().createStudy('Bollinger Bands', false, false);
                        break;
                }}
            }} catch (error) {{
                console.error('æ·»åŠ æŠ€æœ¯æŒ‡æ ‡å¤±è´¥:', error);
            }}
        }}
    """)

# Kçº¿æ•°æ®APIæ¥å£
@app.get("/api/v1/kline/{stock_code}")
async def get_kline_data(stock_code: str, interval: str = "D", range: str = "1M"):
    """è·å–Kçº¿æ•°æ®"""
    try:
        # ä»æ•°æ®åº“è·å–Kçº¿æ•°æ®
        kline_data = await fetch_kline_data_from_db(stock_code, interval, range)

        return {
            "code": 200,
            "message": "success",
            "data": {
                "symbol": stock_code,
                "interval": interval,
                "range": range,
                "kline_data": kline_data,
                "timestamp": int(time.time())
            }
        }
    except Exception as e:
        return {"code": 500, "message": str(e)}
```

### Tab2: ç­–ç•¥é€‰è‚¡ç®¡ç† (Strategy Stock Selection)

#### ç­–ç•¥åˆ—è¡¨ä¸Kçº¿åˆ†æ
```python
# ç­–ç•¥ç®¡ç†é¢æ¿ (ui.left_drawer)
with ui.left_drawer().style("width: 300px; background-color: #fafafa"):
    # ç­–ç•¥å¤´éƒ¨ä¿¡æ¯
    with ui.card().style("margin-bottom: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white"):
        ui.label("ç­–ç•¥é€‰è‚¡ç®¡ç†").style("font-size: 16px; font-weight: bold")
        ui.label("å…±å¯ç”¨ 3 ä¸ªç­–ç•¥").style("font-size: 12px")

    # ç­–ç•¥æ ‘å½¢åˆ—è¡¨
    strategy_tree = ui.tree([
        ui.tree_node("ğŸ“Š MACDé‡‘å‰ç­–ç•¥ (æ¯æ—¥è¿è¡Œ)", icon="trending_up", color="green"),
        ui.tree_node("ğŸ’° åŒ—å‘èµ„é‡‘è·Ÿéš (å®æ—¶ç›‘æ§)", icon="attach_money", color="blue"),
        ui.tree_node("ğŸ“‰ ä½ä¼°å€¼ç­›é€‰ (æ¯å‘¨è¿è¡Œ)", icon="search", color="purple")
    ])

# ç­–ç•¥ç­›é€‰ç»“æœè¡¨ (ui.aggrid)
strategy_results_grid = ui.aggrid(
    options={
        "rowData": strategy_results,
        "columnDefs": [
            {"field": "code", "headerName": "ä»£ç ", "width": 100},
            {"field": "name", "headerName": "åç§°", "width": 120},
            {"field": "current_price", "headerName": "æœ€æ–°ä»·", "width": 100},
            {"field": "change_pct", "headerName": "æ¶¨è·Œå¹…", "width": 100},
            {"field": "strategy_match", "headerName": "ç¬¦åˆç­–ç•¥", "width": 200},
            {"field": "signal_strength", "headerName": "ä¿¡å·å¼ºåº¦", "width": 100,
             "cellRenderer": "signalStrengthRenderer"},
            {"field": "kline_action", "headerName": "Kçº¿å›¾", "width": 80,
             "cellRenderer": "klineButtonRenderer"},
            {"field": "match_time", "headerName": "ç­›é€‰æ—¶é—´", "width": 120}
        ]
    }
)

# Kçº¿å›¾å¿«é€ŸæŸ¥çœ‹æŒ‰é’®
class KLineButtonRenderer:
    def __init__(self, value):
        self.innerHTML = '<button style="background:#1890ff;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px">Kçº¿</button>'

    def getGui(self):
        return self.innerHTML

# ä»ç­–ç•¥ç»“æœç›´æ¥æŸ¥çœ‹Kçº¿
def show_strategy_stock_kline(stock_code):
    """ä»ç­–ç•¥ç»“æœç›´æ¥æŸ¥çœ‹Kçº¿å›¾"""
    # æ‰“å¼€Kçº¿å›¾çª—å£
    stock_data = get_stock_data(stock_code)
    show_kline_chart(stock_data)
```

### Tab3: è¡Œä¸šé€‰è‚¡ç®¡ç† (Industry Stock Selection)

#### è¡Œä¸šåˆ†ç±»ä¸Kçº¿åˆ†æ
```python
# ç”³ä¸‡è¡Œä¸šåˆ†ç±»æ ‘ (ui.tree)
industry_tree = ui.tree([
    ui.tree_node("ğŸ’° é‡‘èä¸š", icon="account_balance", color="blue"),
    ui.tree_node("ğŸ¥ åŒ»è¯ç”Ÿç‰©", icon="local_hospital", color="red"),
    ui.tree_node("ğŸ’» ç”µå­", icon="memory", color="purple")
])

# è¡Œä¸šè‚¡ç¥¨è¡¨ (ui.aggrid)
industry_stock_grid = ui.aggrid(
    options={
        "rowData": industry_stocks,
        "columnDefs": [
            {"field": "code", "headerName": "ä»£ç ", "width": 100},
            {"field": "name", "headerName": "åç§°", "width": 120},
            {"field": "current_price", "headerName": "æœ€æ–°ä»·", "width": 100},
            {"field": "change_pct", "headerName": "æ¶¨è·Œå¹…", "width": 100},
            {"field": "market_cap", "headerName": "å¸‚å€¼", "width": 120},
            {"field": "industry_rank", "headerName": "è¡Œä¸šæ’å", "width": 100},
            {"field": "kline_action", "headerName": "Kçº¿å›¾", "width": 80,
             "cellRenderer": "klineButtonRenderer"}
        ]
    }
)

# è¡Œä¸šå¯¹æ¯”åˆ†æ (ui.card)
with ui.card():
    ui.label("è¡Œä¸šå¯¹æ¯”åˆ†æ").style("font-size: 16px; font-weight: bold")

    # è¡Œä¸šKçº¿èµ°åŠ¿å¯¹æ¯” (é›†æˆKlinechart)
    with ui.tabs() as industry_tabs:
        with ui.tab("é“¶è¡Œæ¿å—"):
            ui.html(f"""
            <div id="bank_industry_kline" style="height: 400px; width: 100%;"></div>
            <script>
                new TradingView.widget({{
                    "width": "100%",
                    "height": "400px",
                    "symbol": "BANK_INDEX",  // é“¶è¡Œä¸šæŒ‡æ•°
                    "interval": "D",
                    "timezone": "Asia/Shanghai",
                    "theme": "light",
                    "style": "1",
                    "locale": "zh_CN",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "allow_symbol_change": false,
                    "container_id": "bank_industry_kline",
                    "hide_side_toolbar": false,
                    "disabled_features": ["use_localstorage_for_settings"],
                    "autosize": true
                }});
            </script>
            """)
```

### Tab4: æ¦‚å¿µé€‰è‚¡ç®¡ç† (Concept Stock Selection)

#### æ¦‚å¿µæ¿å—ä¸Kçº¿å¯è§†åŒ–
```python
# æ¦‚å¿µæ¿å—åˆ†ç±» (ui.tree)
concept_tree = ui.tree([
    ui.tree_node("ğŸ¤– äººå·¥æ™ºèƒ½", icon="smart_toy", color="blue"),
    ui.tree_node("ğŸš— æ–°èƒ½æºè½¦", icon="directions_car", color="green"),
    ui.tree_node("ğŸ’¾ åŠå¯¼ä½“", icon="memory", color="purple"),
    ui.tree_node("ğŸ¥½ å…ƒå®‡å®™", icon("view_in_ar"), color="orange")
])

# æ¦‚å¿µè‚¡ç¥¨è¡¨
concept_stock_grid = ui.aggrid(
    options={
        "rowData": concept_stocks,
        "columnDefs": [
            {"field": "code", "headerName": "ä»£ç ", "width": 100},
            {"field": "name", "headerName": "åç§°", "width": 120},
            {"field": "current_price", "headerName": "æœ€æ–°ä»·", "width": 100},
            {"field": "change_pct", "headerName": "æ¶¨è·Œå¹…", "width": 100},
            {"field": "concept_count", "headerName": "æ‰€å±æ¦‚å¿µæ•°", "width": 100},
            {"field": "concept_activity", "headerName": "æ¦‚å¿µæ´»è·ƒåº¦", "width": 120},
            {"field": "kline_action", "headerName": "Kçº¿å›¾", "width": 80,
             "cellRenderer": "klineButtonRenderer"}
        ]
    }
)

# æ¦‚å¿µçƒ­åº¦æ’è¡Œ
with ui.card():
    ui.label("æ¦‚å¿µçƒ­åº¦åˆ†æ").style("font-size: 16px; font-weight: bold")

    # æ¦‚å¿µæ¿å—Kçº¿å¯¹æ¯”
    with ui.tabs() as concept_tabs:
        with ui.tab("AIæ¦‚å¿µ"):
            ui.html(f"""
            <div id="ai_concept_kline" style="height: 400px; width: 100%;"></div>
            <script>
                new TradingView.widget({{
                    "width": "100%",
                    "height": "400px",
                    "symbol": "AI_CONCEPT_INDEX",  // AIæ¦‚å¿µæŒ‡æ•°
                    "interval": "D",
                    "timezone": "Asia/Shanghai",
                    "theme": "light",
                    "style": "1",
                    "locale": "zh_CN",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "allow_symbol_change": false,
                    "container_id": "ai_concept_kline",
                    "hide_side_toolbar": false,
                    "disabled_features": ["use_localstorage_for_settings"],
                    "autosize": true
                }});
            </script>
            """)
```

### æ‰¹é‡æ“ä½œåŠŸèƒ½

#### æ‰¹é‡å¯¼å…¥å¯¼å‡º
```python
# æ‰¹é‡æ“ä½œé¢æ¿ (ui.card, åº•éƒ¨)
with ui.card().style("margin-top: 20px"):
    ui.label("æ‰¹é‡æ“ä½œ").style("font-size: 16px; font-weight: bold; margin-bottom: 10px")

    with ui.row():
        # æ‰¹é‡å¯¼å…¥
        with ui.column().style("width: 300px"):
            ui.label("æ‰¹é‡å¯¼å…¥").style("font-weight: bold")

            upload = ui.upload(
                label="é€‰æ‹©CSV/Excelæ–‡ä»¶",
                multiple=False,
                on_upload=handle_batch_upload,
                auto_upload=True
            ).style("width: 100%")

            with ui.row():
                ui.select(['æ ¸å¿ƒæŒä»“æ± ', 'çŸ­çº¿è§‚å¯Ÿæ± ', 'é•¿çº¿ä»·å€¼æ± '],
                         label='ç›®æ ‡åˆ†ç»„').style("width: 120px")
                ui.button("å¯¼å…¥", icon="upload").style("width: 80px")

        # æ‰¹é‡å¯¼å‡º
        with ui.column().style("width: 300px"):
            ui.label("æ•°æ®å¯¼å‡º").style("font-weight: bold")

            with ui.row():
                ui.select(['CSV', 'Excel', 'JSON'], value='Excel').style("width: 100px")
                ui.button("å¯¼å‡ºå½“å‰æ•°æ®", icon="download").style("width: 120px")

        # Kçº¿å›¾æ‰¹é‡æ“ä½œ
        with ui.column().style("width: 300px"):
            ui.label("Kçº¿å›¾æ‰¹é‡æ“ä½œ").style("font-weight: bold")

            with ui.row():
                ui.button("æ‰¹é‡ç”ŸæˆKçº¿", icon="timeline",
                         on_click=batch_generate_kline).style("width: 140px")
                ui.button("æ‰¹é‡å¯¼å‡ºå›¾è¡¨", icon="image",
                         on_click=batch_export_charts).style("width: 140px")
```

## æ•°æ®åº“è®¾è®¡

### PostgreSQLè¡¨ç»“æ„
```sql
-- è‚¡ç¥¨æ± é…ç½®è¡¨
CREATE TABLE stock_pool_config (
    pool_id SERIAL PRIMARY KEY,
    pool_type VARCHAR(20) NOT NULL,  -- 'CUSTOM'/'STRATEGY'/'INDUSTRY'/'CONCEPT'
    pool_name VARCHAR(100) NOT NULL,
    parent_id INT REFERENCES stock_pool_config(pool_id),
    stock_count INT DEFAULT 0,
    sync_to_dashboard BOOLEAN DEFAULT false,
    description TEXT,
    color VARCHAR(7) DEFAULT '#1976D2',  -- UIæ˜¾ç¤ºé¢œè‰²
    icon VARCHAR(50) DEFAULT 'star',     -- UIå›¾æ ‡
    create_time TIMESTAMP DEFAULT NOW(),
    update_time TIMESTAMP DEFAULT NOW()
);

-- è‚¡ç¥¨æ± æ˜ç»†è¡¨
CREATE TABLE stock_pool_items (
    item_id SERIAL PRIMARY KEY,
    pool_id INT REFERENCES stock_pool_config(pool_id) ON DELETE CASCADE,
    stock_code VARCHAR(10) NOT NULL,
    stock_name VARCHAR(50) NOT NULL,
    add_reason TEXT,
    signal_strength INT CHECK (signal_strength >= 0 AND signal_strength <= 100),
    note TEXT,
    is_monitored BOOLEAN DEFAULT false,
    price_alert_upper DECIMAL(10,2),
    price_alert_lower DECIMAL(10,2),
    kline_view_count INT DEFAULT 0,  -- Kçº¿å›¾æŸ¥çœ‹æ¬¡æ•°
    last_kline_view TIMESTAMP,       -- æœ€åæŸ¥çœ‹Kçº¿æ—¶é—´
    add_time TIMESTAMP DEFAULT NOW(),
    update_time TIMESTAMP DEFAULT NOW(),
    UNIQUE(pool_id, stock_code)
);

-- Kçº¿å›¾è®¿é—®æ—¥å¿—è¡¨
CREATE TABLE kline_view_log (
    log_id SERIAL PRIMARY KEY,
    stock_code VARCHAR(10) NOT NULL,
    stock_name VARCHAR(50),
    view_time TIMESTAMP DEFAULT NOW(),
    view_duration INT,  -- æŸ¥çœ‹æ—¶é•¿(ç§’)
    user_session VARCHAR(100),
    source_tab VARCHAR(20)  -- 'watchlist'/'strategy'/'industry'/'concept'
);

-- ç­–ç•¥é…ç½®è¡¨
CREATE TABLE strategy_config (
    strategy_id SERIAL PRIMARY KEY,
    strategy_name VARCHAR(100) NOT NULL,
    strategy_code TEXT,        -- ç­–ç•¥ä»£ç /æ¡ä»¶
    strategy_params JSON,      -- ç­–ç•¥å‚æ•°
    is_enabled BOOLEAN DEFAULT true,
    run_schedule VARCHAR(20),  -- 'REALTIME'/'DAILY'/'WEEKLY'
    last_run_time TIMESTAMP,
    next_run_time TIMESTAMP,
    result_count INT DEFAULT 0,
    success_rate DECIMAL(5,2) DEFAULT 0.00,
    create_time TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_stock_pool_items_pool_id ON stock_pool_items(pool_id);
CREATE INDEX idx_stock_pool_items_code ON stock_pool_items(stock_code);
CREATE INDEX idx_kline_view_log_stock_code ON kline_view_log(stock_code);
CREATE INDEX idx_strategy_config_enabled ON strategy_config(is_enabled);
```

## APIæ¥å£è®¾è®¡

### æ ¸å¿ƒAPIç«¯ç‚¹
```python
# è‚¡ç¥¨æ± ç®¡ç†
@app.get("/api/v1/stock_pools")
async def get_stock_pools(pool_type: str = None):
    """è·å–è‚¡ç¥¨æ± åˆ—è¡¨"""
    pass

@app.post("/api/v1/stock_pools")
async def create_stock_pool(pool_data: StockPoolCreate):
    """åˆ›å»ºè‚¡ç¥¨æ± """
    pass

@app.get("/api/v1/stock_pool_items/{pool_id}")
async def get_pool_items(pool_id: int, page: int = 1, size: int = 50):
    """è·å–è‚¡ç¥¨æ± é¡¹ç›®åˆ—è¡¨"""
    pass

# Kçº¿æ•°æ®æ¥å£ (é‡ç‚¹æ–°å¢)
@app.get("/api/v1/kline/{stock_code}")
async def get_kline_data(stock_code: str, interval: str = "D", range: str = "1M"):
    """è·å–Kçº¿æ•°æ®"""
    pass

@app.get("/api/v1/kline/batch")
async def batch_get_kline_data(stock_codes: List[str], interval: str = "D"):
    """æ‰¹é‡è·å–Kçº¿æ•°æ®"""
    pass

@app.post("/api/v1/kline/view-log")
async def log_kline_view(view_data: KLineViewLog):
    """è®°å½•Kçº¿å›¾æŸ¥çœ‹æ—¥å¿—"""
    pass

@app.get("/api/v1/kline/popular-stocks")
async def get_popular_kline_stocks(period: str = "7d"):
    """è·å–çƒ­é—¨Kçº¿æŸ¥çœ‹è‚¡ç¥¨"""
    pass

# ç­–ç•¥ç®¡ç†
@app.get("/api/v1/strategies")
async def get_strategies():
    """è·å–ç­–ç•¥åˆ—è¡¨"""
    pass

@app.post("/api/v1/strategies/{strategy_id}/run")
async def run_strategy(strategy_id: int):
    """æ‰§è¡Œç­–ç•¥ç­›é€‰"""
    pass

# æ‰¹é‡æ“ä½œ
@app.post("/api/v1/stock_pools/batch_import")
async def batch_import_stocks(file: UploadFile, target_pool_id: int):
    """æ‰¹é‡å¯¼å…¥è‚¡ç¥¨"""
    pass

@app.post("/api/v1/kline/batch-generate")
async def batch_generate_kline(stock_codes: List[str], user_id: str):
    """æ‰¹é‡ç”ŸæˆKçº¿å›¾"""
    pass
```

## å‰ç«¯JavaScriptç»„ä»¶

### Klinecharté›†æˆç»„ä»¶
```javascript
// Klinechart Kçº¿å›¾ç»„ä»¶
class KLineChartManager {
    constructor(containerId, options = {}) {
        this.containerId = containerId;
        this.options = {
            theme: 'dark',
            interval: 'D',
            locale: 'zh_CN',
            ...options
        };
        this.widget = null;
        this.currentSymbol = null;
    }

    // åˆå§‹åŒ–Kçº¿å›¾
    async init(symbol, name) {
        try {
            this.currentSymbol = symbol;

            // åŠ¨æ€åŠ è½½TradingViewè„šæœ¬
            if (typeof TradingView === 'undefined') {
                await this.loadTradingViewScript();
            }

            // åˆ›å»ºå›¾è¡¨
            this.createChart(symbol, name);

            // è®°å½•æŸ¥çœ‹æ—¥å¿—
            await this.logView(symbol);

        } catch (error) {
            console.error('åˆå§‹åŒ–Kçº¿å›¾å¤±è´¥:', error);
            this.showError('åŠ è½½Kçº¿å›¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    // åŠ è½½TradingViewè„šæœ¬
    loadTradingViewScript() {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/tv.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // åˆ›å»ºå›¾è¡¨
    createChart(symbol, name) {
        const container = document.getElementById(this.containerId);
        if (!container) {
            throw new Error('å®¹å™¨å…ƒç´ ä¸å­˜åœ¨');
        }

        this.widget = new TradingView.widget({
            width: "100%",
            height: "100%",
            symbol: symbol,
            interval: this.options.interval,
            timezone: "Asia/Shanghai",
            theme: this.options.theme,
            style: "1",
            locale: this.options.locale,
            toolbar_bg: "#f1f3f6",
            enable_publishing: false,
            allow_symbol_change: false,
            container_id: this.containerId,
            hide_side_toolbar: false,
            hide_top_toolbar: false,
            studies: [
                "MACD@tv-basicstudies",
                "RSI@tv-basicstudies",
                "KDJ@tv-basicstudies"
            ],
            disabled_features: ["use_localstorage_for_settings"],
            enabled_features: ["study_templates"],
            autosize: true,
            overrides: {
                "paneProperties.background": this.options.theme === 'dark' ? '#1a1a1a' : '#ffffff',
                "paneProperties.vertGridProperties.color": this.options.theme === 'dark' ? '#363c4e' : '#e1e4e8',
                "paneProperties.horzGridProperties.color": this.options.theme === 'dark' ? '#363c4e' : '#e1e4e8',
                "symbolWatermarkProperties.transparency": 90,
                "scalesProperties.textColor": this.options.theme === 'dark' ? '#AAA' : "#2c2c2c"
            }
        });
    }

    // åˆ‡æ¢æ—¶é—´å‘¨æœŸ
    switchInterval(interval) {
        this.options.interval = interval;
        if (this.widget) {
            this.widget.chart().setResolution(interval);
        }
    }

    // æ·»åŠ æŠ€æœ¯æŒ‡æ ‡
    addIndicator(indicator, params = {}) {
        if (!this.widget) return;

        const chart = this.widget.chart();
        try {
            switch(indicator) {
                case 'MA':
                    chart.createStudy('Moving Average', false, false, [params.period || 20]);
                    break;
                case 'MACD':
                    chart.createStudy('MACD', false, false);
                    break;
                case 'RSI':
                    chart.createStudy('RSI', false, false, [params.period || 14]);
                    break;
                case 'KDJ':
                    chart.createStudy('KDJ', false, false);
                    break;
                case 'BOLL':
                    chart.createStudy('Bollinger Bands', false, false);
                    break;
            }
        } catch (error) {
            console.error('æ·»åŠ æŠ€æœ¯æŒ‡æ ‡å¤±è´¥:', error);
        }
    }

    // è®°å½•æŸ¥çœ‹æ—¥å¿—
    async logView(symbol) {
        try {
            await fetch('/api/v1/kline/view-log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    stock_code: symbol,
                    view_time: new Date().toISOString(),
                    user_session: this.getSessionId()
                })
            });
        } catch (error) {
            console.error('è®°å½•Kçº¿æŸ¥çœ‹æ—¥å¿—å¤±è´¥:', error);
        }
    }

    // è·å–ä¼šè¯ID
    getSessionId() {
        let sessionId = sessionStorage.getItem('kline_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('kline_session_id', sessionId);
        }
        return sessionId;
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    showError(message) {
        const container = document.getElementById(this.containerId);
        if (container) {
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; text-align: center;">
                    <div>
                        <div style="margin-bottom: 8px; font-size: 18px;">âŒ ${message}</div>
                        <button onclick="location.reload()" style="background: #1890ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            é‡æ–°åŠ è½½
                        </button>
                    </div>
                </div>
            `;
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const klineManager = new KLineChartManager('kline_chart_container');

// åˆå§‹åŒ–Kçº¿å›¾
klineManager.init('600000', 'æµ¦å‘é“¶è¡Œ');

// åˆ‡æ¢åˆ°5åˆ†é’ŸKçº¿
klineManager.switchInterval('5');

// æ·»åŠ æŠ€æœ¯æŒ‡æ ‡
klineManager.addIndicator('MA', {period: 10});
klineManager.addIndicator('MACD');
klineManager.addIndicator('RSI', {period: 14});
```

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- âœ… å®Œæˆå¯¹è‡ªé€‰è‚¡åˆ†ç»„çš„å¢åˆ æ”¹æŸ¥ä¸æ‰¹é‡å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
- âœ… **æ–°å¢Klinechart Kçº¿å›¾å¯è§†åŒ–åŠŸèƒ½**ï¼Œæ”¯æŒå¤šæ—¶é—´å‘¨æœŸã€å¤šæŠ€æœ¯æŒ‡æ ‡
- âœ… å¯¼å…¥å¼‚å¸¸èƒ½ç»™å‡ºæ¸…æ™°é”™è¯¯åˆ—è¡¨å¹¶é˜»æ­¢ç ´åæ€§å†™å…¥
- âœ… æ‰¹é‡æ“ä½œåœ¨100æ¡/æ¬¡å†…å®Œæˆä¸”ä¸æŠ¥é”™
- âœ… è¡¨æ ¼æ”¯æŒå®æ—¶åˆ·æ–°å¹¶æ˜¾ç¤ºæ‰€å±åˆ†ç»„å­—æ®µ
- âœ… ç­–ç•¥é€‰è‚¡ç®¡ç†æ”¯æŒè‡ªåŠ¨ç­›é€‰å’ŒKçº¿å¿«é€ŸæŸ¥çœ‹
- âœ… è¡Œä¸šé€‰è‚¡ç®¡ç†æ”¯æŒç”³ä¸‡è¡Œä¸šåˆ†ç±»å’Œæ¿å—Kçº¿å¯¹æ¯”
- âœ… æ¦‚å¿µé€‰è‚¡ç®¡ç†æ”¯æŒè‡ªå®šä¹‰æ¦‚å¿µå’Œçƒ­åº¦Kçº¿åˆ†æ

### æŠ€æœ¯éªŒæ”¶
- âœ… åç«¯æä¾›å®Œæ•´çš„RESTful APIæ¥å£
- âœ… å‰ç«¯ä½¿ç”¨NiceGUIç»„ä»¶å®ç°å“åº”å¼ç•Œé¢
- âœ… **Kçº¿å›¾ä½¿ç”¨Klinechartåº“ï¼ˆTradingViewï¼‰ï¼Œæ”¯æŒ70+æŠ€æœ¯æŒ‡æ ‡**
- âœ… æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡åˆç†ï¼Œç´¢å¼•ä¼˜åŒ–åˆ°ä½
- âœ… å®ç°Kçº¿æŸ¥çœ‹æ—¥å¿—è®°å½•å’Œçƒ­é—¨è‚¡ç¥¨ç»Ÿè®¡
- âœ… æ”¯æŒWebSocketå®æ—¶æ•°æ®æ¨é€
- âœ… æä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
- âœ… Kçº¿å›¾æ”¯æŒä¸»é¢˜åˆ‡æ¢ã€æ•°æ®å¯¼å‡ºã€å›¾è¡¨åˆ†äº«

---

**å¼€å‘ä¼˜å…ˆçº§**: é«˜ä¼˜å…ˆçº§
**é¢„ä¼°å·¥æœŸ**: 2å‘¨
**æŠ€æœ¯éš¾ç‚¹**: Klinecharté›†æˆã€å¤§æ•°æ®é‡åˆ†é¡µå¤„ç†ã€å®æ—¶æ•°æ®åŒæ­¥ã€Aè‚¡ç‰¹æ€§é€‚é…
**ä¾èµ–å…³ç³»**: éœ€è¦è‚¡ç¥¨åŸºç¡€æ•°æ®ã€Kçº¿æ•°æ®ã€TradingViewå›¾è¡¨åº“ã€æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æœåŠ¡

**é‡ç‚¹ç‰¹è‰²**:
- ğŸ¯ **ä¸“ä¸šçº§Kçº¿å›¾å¯è§†åŒ–** - åŸºäºTradingViewçš„Klinechart
- ğŸ“ˆ **å¤šæ—¶é—´å‘¨æœŸæ”¯æŒ** - 1åˆ†é’Ÿåˆ°æœˆçº¿å…¨æ”¯æŒ
- ğŸ”§ **70+æŠ€æœ¯æŒ‡æ ‡** - MAã€MACDã€RSIã€KDJã€å¸ƒæ—å¸¦ç­‰
- ğŸš€ **é«˜æ€§èƒ½æ¸²æŸ“** - æ”¯æŒå¤§æ•°æ®é‡å’Œå®æ—¶æ›´æ–°
- ğŸ¨ **çµæ´»å®šåˆ¶** - ä¸»é¢˜åˆ‡æ¢ã€æŒ‡æ ‡ç»„åˆã€å‚æ•°è°ƒæ•´
