# 8. 交易管理页面_优化版

## 主菜单映射（对应主菜单项八：交易管理）
- **角色定位**：从信号到订单再到持仓与绩效的闭环管理（先实现模拟/沙箱，后接入实盘）
- **必备功能清单**：
  - 交易信号管理（信号生成/分发/标记不可执行原因）
  - 订单/成交/撤单历史（支持导出与查询）
  - 持仓视图与实时盈亏（T+1可用数量处理）
  - 事后归因与绩效评估（按策略、按股票分解）
  - K线图交易分析（信号标注、买卖点显示、技术指标分析）

## 精简摘要与实施要点
- **页面摘要**：交易管理页负责交易信号的展示与模拟订单管理，为事后归因与绩效评估提供数据基础，实盘接入为后续阶段
- **核心功能（前5优先级）**：信号列表与详情、模拟订单创建/查看、持仓明细与T+1处理、交易历史导出、事后归因分析入口
- **API/数据依赖**：trade_signals/trade_orders/positions（PostgreSQL）、账户资产接口、回测/信号来源接口
- **实施要点**：初始版本使用模拟委托与仿真成交；按照A股100股整数倍与手续费规则计算成交金额与手续费；在实盘接入前保证权限和审计日志
- **验收标准（一句话）**：能通过UI创建并查看模拟订单，订单明细显示正确手续费与成交金额，持仓视图正确反映T+1可用数量规则

---
**Owner**: 后端(交易/订单) / 协同: 前端(NiceGUI), 运维
**Collaborators**: 风控工程, QA

**MVP 最小实现任务**：
- 实现交易信号表格（模拟信号源）与信号详情弹窗（含K线图）
- 实现订单记录表（模拟委托/成交数据，不接入真实券商）并能导出CSV
- 实现持仓明细视图（仅展示数据，不执行下单）
- 集成K线图显示交易信号和买卖点

**验收标准**：
- 前端能显示模拟信号并通过UI创建模拟订单；订单记录能正确显示手续费/成交金额计算（按A股规则示例）
- K线图正确显示买卖信号，技术指标计算准确，交易逻辑清晰

**实现说明**：真实下单与券商对接连接为后续阶段，当前阶段使用沙箱/模拟数据与规则验证逻辑正确性。K线图使用TradingView集成交易信号标注

---

## 3.8 交易管理页面（Trade Management）

**功能定位**：交易执行、持仓监控、事后归因与绩效评估的统一管理平台，通过信号管理→订单执行→持仓监控→事后归因→绩效评估，形成完整的交易管理体系

### NiceGUI组件实现

**主容器**：ui.tabs（5个Tab页）：交易信号管理、交易历史记录、持仓分析、事后归因、绩效评估

---

#### Tab1：交易信号管理

```python
# 实时信号概览面板（ui.card，顶部）
- 信号统计卡片组（ui.row，4个卡片）：
  - 今日信号总数：25个（+15% vs昨日）
  - 已执行信号：18个（成功率72%）
  - 待执行信号：7个
  - 信号准确率：68.5%（近30日）

- 信号类型分布（ui.charts饼图）：
  - 买入信号：60%（15个）
  - 卖出信号：40%（10个）
  - 止损信号：12个
  - 止盈信号：8个

# 交易信号表格（ui.aggrid）
表格字段：
  信号ID | 生成时间 | 股票代码/名称 | 信号类型 | 信号强度 | 当前价 | 建议操作 | 状态 | 执行 | K线查看
  信号001 | 09:30:15 | 600036 招商银行 | 买入 | ★★★★★ | 35.20 | 买入100股 | ✅可执行 | [执行] | [查看K线]
  信号002 | 09:31:22 | 000333 美的集团 | 卖出 | ★★★★☆ | 68.50 | 卖出200股 | ⚠️T+1限制 | [预约] | [查看K线]

- 状态标识：
  - ✅可执行（绿色）- 当前可下单
  - ⚠️T+1限制（橙色）- 需次日执行
  - ❌不可执行（红色）- 涨停/跌停/停牌
  - ⏰已执行（蓝色）- 订单已提交

# 信号筛选器（ui.card，中间）
- 快速筛选（ui.chip_group）：
  - 全部信号 / 买入信号 / 卖出信号 / 高强度（★★★★★）
  - 可执行 / 已执行 / 不可执行

- 高级筛选（ui.row）：
  - 股票池：ui.select（沪深300 / 自选股 / 全A股）
  - 信号类型：ui.multi_select（MACD金叉 / RSI超卖 / 突破等）
  - 信号强度：ui.slider（1-5星）
  - 时间范围：ui.date_range

# 信号详情对话框（ui.dialog，点击信号行触发）
- 信号基础信息：
  - 信号编号：SIG_20240115001
  - 生成时间：2024-01-15 09:30:15
  - 策略来源：双均线交叉策略
  - 股票信息：600036 招商银行

- **K线图交易分析**（TradingView集成）：
  ```javascript
  // 交易信号专用K线图
  new TradingView.widget({
      "width": "100%",
      "height": "350px",
      "symbol": "600036.SS", // 招商银行
      "interval": "30", // 30分钟图
      "timezone": "Asia/Shanghai",
      "theme": "light",
      "locale": "zh_CN",

      // 交易信号标注
      "drawings": [
          {
              "type": "signal_point",
              "time": "2024-01-15 09:30",
              "color": "#00ff00",
              "shape": "arrowUp",
              "text": "买入信号\nMA5上穿MA20\n信号强度: ★★★★★"
          },
          {
              "type": "historical_signal",
              "time": "2024-01-10 14:30",
              "color": "#ff0000",
              "shape": "arrowDown",
              "text": "历史卖出点\n盈利+8.5%"
          }
      ],

      // 技术指标显示
      "studies": [
          "MACD@tv-basicstudies",
          "RSI@tv-basicstudies",
          "KDJ@tv-basicstudies",
          "BollingerBands@tv-basicstudies"
      ],

      // 买卖区间标注
      "overlays": [
          {
              "type": "support_resistance",
              "color": "#2196F3",
              "text": "支撑位: 34.50"
          },
          {
              "type": "support_resistance",
              "color": "#FF9800",
              "text": "阻力位: 36.80"
          }
      ]
  });
  ```

- 技术分析指标（ui.card）：
  - 当前技术指标值：
    - MA5: 34.85元 | MA20: 34.20元 | MA60: 33.95元
    - MACD: +0.15（金叉状态）| DIF: 0.12 | DEA: 0.08
    - RSI: 58.2（健康区间）| KDJ: K=65, D=62, J=70
    - 布林带：上轨36.50 | 中轨34.80 | 下轨33.10
    - 成交量：放量1.8倍（较5日均量）

- A股交易限制检查（ui.alerts）：
  - 涨停检查：当前价格35.20元，距离涨停价38.72元，✅可买入
  - 跌停检查：当前价格35.20元，距离跌停价31.68元，✅可卖出
  - T+1检查：非当天买入股票，✅可卖出
  - 整数倍检查：建议100股，符合100股倍数规则

- 建议操作（ui.column）：
  - 推荐数量：100股（默认）
  - 预估成本：3,520元（不含手续费）
  - 止损价位：31.68元（-10%）
  - 止盈目标：42.24元（+20%）
  - 风险评级：🟢低风险（基于技术指标）

- 执行按钮组（ui.row）：
  - [立即买入] (ui.button primary)
  - [设置提醒] (ui.button)
  - [加入观察] (ui.button)
  - [信号详情] (ui.button)
```

#### Tab2：交易历史记录

```python
# 交易统计面板（ui.card，顶部）
- 今日交易概览（ui.row，4个卡片）：
  - 今日成交：8笔（买入5笔，卖出3笔）
  - 成交金额：¥285,600
  - 手续费总计：¥285.60
  - 净盈亏：+¥12,450（+4.55%）

# 订单明细表（ui.aggrid）
表格字段：
  订单号 | 委托时间 | 股票代码/名称 | 方向 | 委托价 | 委托数 | 成交价 | 成交数 | 成交金额 | 手续费 | 状态 | 订单详情
  ORD001 | 09:30:15 | 600036 招商银行 | 买入 | 35.20 | 100 | 35.25 | 100 | 3,525 | 3.53 | ✅已成交 | [详情] [K线]
  ORD002 | 10:15:30 | 000333 美的集团 | 卖出 | 68.50 | 200 | 68.45 | 200 | 13,690 | 13.69 | ✅已成交 | [详情] [K线]

- A股特化手续费计算（ui.expansion）：
  ```
  招商银行(600036) 100股 买入明细：
  - 成交金额：100股 × 35.25元 = 3,525.00元
  - 佣金(0.03%)：3,525.00 × 0.0003 = 1.06元
  - 过户费(0.002%)：3,525.00 × 0.00002 = 0.07元
  - 印花税：0元（买入免印花税）
  - 总费用：1.06 + 0.07 + 0 = 1.13元
  - 实际成本：3,526.13元（成本价：35.2613元/股）
  ```

# 成交记录表（ui.aggrid）
- 包含更多成交细节：
  成交编号 | 成交时间 | 订单号 | 股票信息 | 方向 | 成交价 | 成交数 | 成交金额 | 来源信号 | 盈亏状态 | K线查看
  DEAL001 | 09:30:45 | ORD001 | 600036 招商银行 | 买入 | 35.25 | 100 | 3,525 | SIG001 | 🟡浮盈 | [查看K线]

# 撤单/废单记录表（ui.aggrid）
- A股特有废单原因分类：
  订单号 | 股票代码 | 废单原因 | 废单时间 | 解决方案
  ORD003 | 300750 宁德时代 | 价格超涨停价(389.50>385.20) | 14:25:30 | 调整价格至涨停价以下
  ORD004 | 000002 万科A | 数量非100股整数倍 | 10:15:20 | 调整为200股
  ORD005 | 600036 招商银行 | T+1限制(当天买入) | 09:35:15 | 明日9:30后可卖出

# 交易统计图表（ui.tabs子页面）
**Tab1：交易趋势分析**
- 每日交易次数趋势（ui.plotly_line）
- 交易金额分布（ui.plotly_histogram）
- 胜率变化趋势（ui.plotly_line）
- 平均持仓天数分布（ui.plotly_box）

**Tab2：交易效率分析**
- 信号响应时间分布（ui.plotly_histogram）
- 成交率统计（买入成交率、卖出成交率）
- 滑点分析（实际成交价vs委托价差异）
- 手续费成本占比（ui.plotly_pie）

**Tab3：K线图回放**
- 选择交易进行K线图回放：
  - 选择订单号（ui.select）
  - 回放速度（ui.select：1x/5x/10x）
  - 显示买卖点标注
  - 交易理由说明
```

#### Tab3：持仓分析

```python
# 账户概览面板（ui.card，顶部）
- 资产统计卡片组（ui.row，5个卡片）：
  - 总资产：¥1,285,600（+2.8%）
  - 可用资金：¥135,600
  - 持仓市值：¥1,150,000
  - 当日盈亏：+¥28,500（+2.54%）
  - 总盈亏：+¥285,600（+28.56%，年化15.2%）

# 持仓明细表（ui.aggrid）
表格字段：
  股票代码/名称 | 持仓数量 | 可用数量 | 持仓成本 | 当前价 | 最新市值 | 浮动盈亏 | 持仓天数 | 仓位占比 | 状态 | 操作 | K线分析
  600036 招商银行 | 1000 | 0 | 32.50 | 35.20 | 35,200 | +2,700 | 3天 | 3.07% | 🟢盈利 | [卖出] [加仓] | [查看K线]
  000333 美的集团 | 2000 | 2000 | 65.20 | 68.50 | 137,000 | +6,600 | 8天 | 11.92% | 🟢盈利 | [卖出] [减仓] | [查看K线]

- A股T+1处理显示（ui.column）：
  ```
  招商银行(600036) T+1状态：
  - 今日买入：1000股 09:30:15
  - 今日不可卖出原因：T+1限制
  - 最早可卖时间：明日 09:30:15
  - 预估可用数量：1000股
  ```

# 持仓分布可视化（ui.tabs）

**Tab1：持仓分布图**
- 持仓占比饼图（ui.echarts_pie）：
  - 招商银行：11.9%
  - 美的集团：13.2%
  - 宁德时代：8.7%
  - 贵州茅台：15.6%
  - 其他：50.6%

- 行业分布柱状图（ui.echarts_bar）：
  - 金融：35.2%
  - 消费：28.7%
  - 科技：18.9%
  - 医药：12.1%
  - 其他：5.1%

**Tab2：盈亏分析**
- 当日盈亏分布（ui.plotly_bar）：
  - 盈利股票：12只（平均+3.2%）
  - 亏损股票：3只（平均-1.8%）
  - 平盘股票：1只

- 累计盈亏曲线（ui.plotly_area）：
  - 持仓盈亏变化趋势
  - 最大盈利/最大亏损标注

**Tab3：持仓K线分析**
- 选择持仓股票进行K线图分析：
  - 选择股票（ui.select）
  - 显示当前持仓标记
  - 技术指标分析
  - 支撑阻力位标注

```python
# 持仓K线图分析（TradingView集成）
# 选择持仓股票查看K线和技术分析
selected_stock = "600036"  # 招商银行

new TradingView.widget({
    "width": "100%",
    "height": "400px",
    "symbol": "600036.SS",
    "interval": "D",
    "theme": "light",

    // 持仓标记
    "drawings": [
        {
            "type": "position_entry",
            "time": "2024-01-10",
            "price": 32.50,
            "color": "#2196F3",
            "text": "持仓成本\n1000股 @32.50"
        },
        {
            "type": "current_price",
            "time": "2024-01-15",
            "price": 35.20,
            "color": "#4CAF50",
            "text": "当前价格\n+8.3%"
        }
    ],

    // 风险线标注
    "overlays": [
        {
            "type": "stop_loss",
            "price": 29.25, // -10%
            "color": "#F44336",
            "text": "止损线-10%"
        },
        {
            "type": "take_profit",
            "price": 39.00, // +20%
            "color": "#4CAF50",
            "text": "止盈线+20%"
        }
    ]
});
```

# 实时盈亏监控（ui.card，底部）
- 当日分时盈亏曲线（ui.plotly_line，3秒刷新）
- 持仓预警（ui.alerts）：
  - 🟡 仓位提醒：美的集团仓位13.2%，接近15%上限
  - 🔴 止损提醒：宁德时代跌破止损线，建议关注
  - 🟢 止盈提醒：招商银行接近止盈线，可考虑获利了结

# AI智能建议（ui.collapse）
- 基于持仓分析的AI建议：
  - 建议减持：美的集团（仓位过重）
  - 建议关注：技术面转弱的股票
  - 建议加仓：处于上升趋势的优质股票
  - 风险提示：集中度风险、行业风险
```

#### Tab4：事后归因

```python
# 复盘分析配置面板（ui.card，顶部）
- 分析范围选择（ui.row）：
  - 时间范围：ui.date_range（最近30天/最近90天/自定义）
  - 股票池：ui.select（全部持仓/核心持仓/亏损持仓）
  - 策略分类：ui.multi_select（双均线/MACD/RSI/自定义策略）
  - 交易类型：ui.checkbox（全部/盈利交易/亏损交易）

# 收益归因分析（ui.tabs）

**Tab1：收益分解树状图**
- 总收益分解（ui.plotly_sunburst）：
  ```
  总收益：+285,600元
  ├── 按策略分解
  │   ├── 双均线策略：+165,200元（57.9%）
  │   ├── MACD策略：+98,400元（34.5%）
  │   └── RSI策略：+22,000元（7.6%）
  ├── 按股票分解
  │   ├── 招商银行：+125,600元（44.0%）
  │   ├── 美的集团：+87,200元（30.5%）
  │   └── 宁德时代：+72,800元（25.5%）
  └── 按时间分解
      ├── 1月：+156,200元（54.7%）
      ├── 2月：+89,400元（31.3%）
      └── 3月：+40,000元（14.0%）
  ```

**Tab2：收益贡献排行**
- 收益贡献排行榜（ui.aggrid）：
  排名 | 股票代码/名称 | 收益贡献 | 交易次数 | 胜率 | 平均收益 | 策略来源 | 操作
  1 | 600036 招商银行 | +125,600 | 12次 | 75% | +10,467 | 双均线 | [详细分析]
  2 | 000333 美的集团 | +87,200 | 8次 | 87.5% | +10,900 | MACD | [详细分析]

# 策略有效性评估（ui.tabs）

**Tab1：策略绩效对比**
- 策略绩效对比表（ui.aggrid）：
  策略名称 | 交易次数 | 胜率 | 平均收益 | 总收益 | 最大回撤 | 夏普比率 | 年化收益率 | 评级
  双均线策略 | 45次 | 68.9% | +3,671 | +165,200 | -8.5% | 1.45 | 22.3% | ★★★★☆
  MACD策略 | 32次 | 71.9% | +3,075 | +98,400 | -6.2% | 1.58 | 18.7% | ★★★★☆
  RSI策略 | 18次 | 61.1% | +1,222 | +22,000 | -12.1% | 0.98 | 12.5% | ★★★☆☆

**Tab2：策略信号分析**
- 信号准确性统计（ui.plotly_bar）：
  - 买入信号准确率：72.5%
  - 卖出信号准确率：68.2%
  - 止损信号触发率：15.8%
  - 止盈目标达成率：62.3%

- 信号响应时间分析（ui.plotly_histogram）：
  - 信号到执行平均时间：2.3分钟
  - 最佳响应时间：30秒内
  - 延迟执行影响：平均损失-0.8%

# 交易行为分析（ui.tabs）

**Tab1：交易时机分析**
- 买卖时机分布图（ui.plotly_scatter）：
  - X轴：买入时间（盘中时段）
  - Y轴：收益率
  - 颜色：策略类型
  - 标注：最佳/最差交易时机

- 持仓周期分析（ui.plotly_box）：
  - 平均持仓时间：8.5天
  - 最短持仓：1天
  - 最长持仓：45天
  - 胜率vs持仓天数关系

**Tab2：盈亏分布分析**
- 盈亏分布散点图（ui.plotly_scatter）：
  - X轴：持仓天数
  - Y轴：盈亏比例
  - 点大小：交易金额
  - 颜色：盈亏状态

- 盈亏比例统计（ui.card）：
  - 大幅盈利（>10%）：25次
  - 盈利（0-10%）：35次
  - 亏损（0--10%）：22次
  - 大幅亏损（<-10%）：8次

# K线图复盘分析（ui.collapse）
- 选择交易进行K线图复盘：
  - 选择要复盘的交易（ui.select）
  - 显示买卖点K线图
  - 技术指标分析
  - 交易逻辑验证

```python
# 交易复盘K线图
# 用于验证交易决策的正确性
new TradingView.widget({
    "width": "100%",
    "height": "350px",
    "symbol": stock_code,
    "interval": "D",
    "theme": "light",

    // 复盘标记
    "drawings": [
        {
            "type": "buy_point",
            "time": buy_time,
            "color": "#4CAF50",
            "text": `买入点\n价格: ${buy_price}\n原因: ${buy_reason}`
        },
        {
            "type": "sell_point",
            "time": sell_time,
            "color": "#F44336",
            "text": `卖出点\n价格: ${sell_price}\n原因: ${sell_reason}`
        }
    ],

    // 技术指标验证
    "studies": [
        "MACD@tv-basicstudies",
        "RSI@tv-basicstudies"
    ]
});
```

# AI改进建议（ui.collapse）
- 基于归因分析的智能建议：
  - 🎯 策略优化：双均线策略表现最佳，建议增加权重
  - ⏰ 时机优化：开盘后30分钟内执行效果最佳
  - 💰 仓位优化：单股仓位建议控制在10%以内
  - 🔄 止损优化：严格执行8%止损规则
```

#### Tab5：绩效评估

```python
# 核心绩效指标面板（ui.grid 2x3，顶部）
- 绩效指标卡片组：
  - 总收益率：+28.56%（大号绿色显示）
  - 年化收益率：15.2%（基于投资时间）
  - 夏普比率：1.45（优秀水平>1.0）
  - 最大回撤：-12.8%（风险可控）
  - 胜率：68.5%（盈利交易占比）
  - 盈亏比：1.85（平均盈利/平均亏损）

# 累计收益曲线（ui.tabs）

**Tab1：净值曲线对比**
- 策略净值vs基准对比（ui.plotly）：
  - 主图：累计净值曲线（蓝色实线）
  - 基准：沪深300指数（灰色虚线）
  - 超额收益：阴影区域显示
  - 最大回撤：红色区域标注

- 关键时间点标注：
  - 最高点：+45.2%（2024年3月15日）
  - 最低点：-12.8%（2024年2月10日）
  - 策略启动：2023年1月1日

**Tab2：月度收益分析**
- 月度收益热力图（ui.plotly_heatmap）：
  - X轴：月份（1-12月）
  - Y轴：年份（2023、2024）
  - 颜色：收益大小（红色正收益，蓝色负收益）
  - 显示数值：具体收益率

- 月度收益统计表（ui.aggrid）：
  月份 | 2023年收益 | 2024年收益 | 同比变化 | 最佳策略
  1月 | +5.2% | +8.7% | +3.5% | 双均线
  2月 | -3.1% | +2.8% | +5.9% | MACD

**Tab3：年度绩效对比**
- 历年绩效汇总（ui.aggrid）：
  年份 | 起始资金 | 结束资金 | 绝对收益 | 相对收益 | 最大回撤 | 夏普比率 | 交易次数
  2023 | 1,000,000 | 1,185,000 | +185,000 | +18.5% | -8.2% | 1.32 | 156次
  2024 | 1,185,000 | 1,285,600 | +100,600 | +8.5% | -5.6% | 1.67 | 89次

# 风险指标雷达图（ui.plotly_radar）
- 多维度风险评估：
  - 收益能力：85/100
  - 风险控制：78/100
  - 稳定性：82/100
  - 胜率：76/100
  - 盈亏比：88/100
  - 交易效率：72/100

- 综合评级：★★★☆☆（78.5/100）

# 行业收益归因（ui.echarts_bar）
- 各行业收益贡献：
  - 金融行业：+125,600元（44.0%）
  - 消费行业：+98,400元（34.5%）
  - 科技行业：+45,200元（15.8%）
  - 医药行业：+16,400元（5.7%）

# 交易效率分析（ui.card）
- 关键效率指标：
  - 资金利用率：92.5%（较高）
  - 换手率：280%（适中）
  - 平均持仓时间：8.5天
  - 信号响应时间：2.3分钟
  - 成交率：96.8%（优秀）

# 绩效报告导出（ui.row，底部）
- 导出选项（ui.button_group）：
  - [PDF报告] (ui.button) - 完整绩效报告
  - [Excel数据] (ui.button) - 详细数据表格
  - [图表导出] (ui.button) - PNG格式图表
  - [邮件发送] (ui.button) - 定时发送报告

- 报告内容预览：
  ```
  📊 量化交易绩效报告
  报告期间：2023-01-01 至 2024-12-31
  策略组合：双均线+MACD+RSI

  🎯 核心指标
  总收益率：+28.56%
  年化收益率：15.2%
  夏普比率：1.45
  最大回撤：-12.8%

  📈 策略表现
  双均线策略：收益+18.5%，夏普1.32
  MACD策略：收益+8.7%，夏普1.67
  RSI策略：收益+1.4%，夏普0.98

  💡 优化建议
  1. 降低RSI策略权重
  2. 加强风险控制
  3. 优化仓位管理
  ```

# 实时绩效监控（ui.card，滚动显示）
- 实时关键指标：
  - 今日收益：+¥2,850（+0.22%）
  - 持仓股票：16只
  - 现金比例：10.5%
  - 风险等级：中等
  - 下次调仓：明日 09:30
```

### 数据存储设计（PostgreSQL + TDengine）

```sql
-- 交易信号表（PostgreSQL）
CREATE TABLE trade_signals (
    signal_id SERIAL PRIMARY KEY,
    signal_code VARCHAR(50) UNIQUE,
    stock_code VARCHAR(10),
    stock_name VARCHAR(50),
    signal_type VARCHAR(20), -- BUY/SELL/STOP_LOSS/TAKE_PROFIT
    signal_strength INT, -- 1-5星
    current_price DECIMAL(10,3),
    suggested_action TEXT,
    strategy_source VARCHAR(100),
    signal_data JSONB, -- 详细信号数据
    is_executable BOOLEAN DEFAULT true,
    create_time TIMESTAMP DEFAULT NOW(),
    expiry_time TIMESTAMP
);

-- 订单表（PostgreSQL）
CREATE TABLE trade_orders (
    order_id SERIAL PRIMARY KEY,
    order_code VARCHAR(50) UNIQUE,
    signal_id INT REFERENCES trade_signals(signal_id),
    stock_code VARCHAR(10),
    stock_name VARCHAR(50),
    direction VARCHAR(10), -- BUY/SELL
    order_price DECIMAL(10,3),
    order_quantity INT,
    order_amount DECIMAL(15,2),
    commission DECIMAL(10,2),
    status VARCHAR(20), -- PENDING/COMPLETED/CANCELLED/REJECTED
    reject_reason TEXT,
    create_time TIMESTAMP DEFAULT NOW(),
    execute_time TIMESTAMP
);

-- 成交记录表（PostgreSQL）
CREATE TABLE trade_executions (
    execution_id SERIAL PRIMARY KEY,
    order_id INT REFERENCES trade_orders(order_id),
    execution_code VARCHAR(50) UNIQUE,
    stock_code VARCHAR(10),
    direction VARCHAR(10),
    execution_price DECIMAL(10,3),
    execution_quantity INT,
    execution_amount DECIMAL(15,2),
    commission DECIMAL(10,2),
    slippage DECIMAL(10,3),
    profit_loss DECIMAL(15,2),
    execution_time TIMESTAMP DEFAULT NOW()
);

-- 持仓表（PostgreSQL）
CREATE TABLE positions (
    position_id SERIAL PRIMARY KEY,
    stock_code VARCHAR(10),
    stock_name VARCHAR(50),
    total_quantity INT, -- 总持仓数量
    available_quantity INT, -- 可用数量（T+1后更新）
    cost_price DECIMAL(10,3), -- 持仓成本
    current_price DECIMAL(10,3), -- 当前价格
    market_value DECIMAL(15,2), -- 市值
    unrealized_pnl DECIMAL(15,2), -- 浮动盈亏
    position_ratio DECIMAL(5,2), -- 仓位占比
    last_update TIMESTAMP DEFAULT NOW()
);

-- 交易信号K线数据（TDengine，高频数据）
CREATE STABLE signal_kline_data (
    ts TIMESTAMP,
    open_price DECIMAL(10,3),
    high_price DECIMAL(10,3),
    low_price DECIMAL(10,3),
    close_price DECIMAL(10,3),
    volume BIGINT,
    turnover DECIMAL(15,2),
    signal_mark VARCHAR(50) -- 信号标注
) TAGS (
    stock_code NCHAR(10),
    signal_id INT
);

-- 绩效统计表（PostgreSQL）
CREATE TABLE performance_metrics (
    metric_id SERIAL PRIMARY KEY,
    calc_date DATE,
    total_return DECIMAL(10,4),
    annual_return DECIMAL(10,4),
    sharpe_ratio DECIMAL(10,4),
    max_drawdown DECIMAL(10,4),
    win_rate DECIMAL(10,4),
    profit_loss_ratio DECIMAL(10,4),
    trade_count INT,
    avg_holding_days DECIMAL(10,2),
    benchmark_return DECIMAL(10,4),
    alpha DECIMAL(10,4),
    beta DECIMAL(10,4),
    created_time TIMESTAMP DEFAULT NOW()
);
```

### API接口设计

```python
# 交易信号接口
@api.get("/api/v1/trade/signals")
async def get_trade_signals():
    """获取交易信号列表"""
    pass

@api.get("/api/v1/trade/signals/{signal_id}")
async def get_signal_detail(signal_id: str):
    """获取信号详情（含K线数据）"""
    return {
        "basic_info": {...},
        "kline_data": {
            "symbol": "600036.SS",
            "interval": "30",
            "data": [...],
            "signals": [...]  # 买卖信号标注
        },
        "technical_analysis": {...}
    }

@api.post("/api/v1/trade/orders")
async def create_trade_order(order: TradeOrderCreate):
    """创建交易订单"""
    pass

# 持仓管理接口
@api.get("/api/v1/trade/positions")
async def get_positions():
    """获取持仓列表"""
    pass

@api.get("/api/v1/trade/positions/{stock_code}/kline")
async def get_position_kline(stock_code: str):
    """获取持仓股票K线图数据"""
    return {
        "symbol": stock_code,
        "position_info": {
            "cost_price": 32.50,
            "current_price": 35.20,
            "quantity": 1000,
            "unrealized_pnl": 2700
        },
        "kline_data": {...},
        "risk_lines": {
            "stop_loss": 29.25,
            "take_profit": 39.00
        }
    }

# 绩效评估接口
@api.get("/api/v1/trade/performance")
async def get_performance_metrics():
    """获取绩效指标"""
    pass

@api.get("/api/v1/trade/attribution")
async def get_performance_attribution():
    """获取收益归因分析"""
    pass

@api.post("/api/v1/trade/reports/export")
async def export_performance_report():
    """导出绩效报告"""
    pass
```

### 关键特性说明

1. **K线图交易分析**：集成TradingView，实时显示交易信号和技术分析
2. **A股特化处理**：T+1规则、涨跌停限制、100股倍数、手续费计算
3. **智能交易建议**：基于技术分析和风险评估的AI建议
4. **完整交易闭环**：从信号→订单→成交→持仓→归因→绩效
5. **实时风险监控**：持仓预警、止损提醒、仓位管理
6. **事后归因分析**：收益分解、策略评估、交易复盘

### 验收标准

- **功能验收**：交易信号正确生成，模拟订单正常执行，K线图准确显示交易点
- **A股适配**：T+1规则、涨跌停处理、100股倍数、手续费计算全部正确
- **数据准确性**：持仓数据实时更新，绩效指标计算准确，归因分析合理
- **用户体验**：界面直观，操作便捷，K线图交互流畅，交易逻辑清晰

---
**开发完成时间**: 预估3周
**测试重点**: K线图交易信号准确性、A股规则模拟、持仓数据实时性、绩效计算准确性
**风险点**: T+1规则处理复杂、实时数据同步、交易信号延迟、绩效归因算法
