# Web功能优化技术实施指南 - 第四阶段

## 阶段概览

**阶段名称**: 系统优化与生产部署  
**实施时间**: 第11-12周 (总计: 8天)  
**主要目标**: 完成系统性能优化、实时数据推送改进、综合UX优化、自动化部署和监控  
**技术栈**: Vue 3 + FastAPI + Redis + PostgreSQL + Docker + Kubernetes + Prometheus + Grafana

## 核心功能模块

### 1. 系统性能优化

#### 1.1 前端性能监控组件

**组件文件**: `src/components/Performance/PerformanceMonitor.vue`

```vue
<template>
  <div class="performance-monitor">
    <!-- 性能概览头部 -->
    <div class="performance-header">
      <div class="header-left">
        <h3>
          <el-icon><Monitor /></el-icon>
          实时性能监控
        </h3>
        <p class="subtitle">系统性能实时监控与优化建议</p>
      </div>
      
      <div class="header-right">
        <el-tag :type="systemStatus.type" size="large">
          {{ systemStatus.text }}
        </el-tag>
        <el-button @click="toggleMonitoring" size="small">
          {{ isMonitoring ? '停止监控' : '开始监控' }}
        </el-button>
      </div>
    </div>

    <!-- 实时性能指标 -->
    <el-row :gutter="20" class="performance-metrics">
      <el-col :span="6">
        <el-card class="metric-card" shadow="hover">
          <div class="metric-content">
            <div class="metric-icon cpu">
              <el-icon><Cpu /></el-icon>
            </div>
            <div class="metric-info">
              <div class="metric-value">{{ cpuUsage.toFixed(1) }}%</div>
              <div class="metric-label">CPU使用率</div>
              <el-progress 
                :percentage="cpuUsage" 
                :color="getCpuColor(cpuUsage)"
                :show-text="false"
                :stroke-width="6"
              />
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card class="metric-card" shadow="hover">
          <div class="metric-content">
            <div class="metric-icon memory">
              <el-icon><MemoryStick /></el-icon>
            </div>
            <div class="metric-info">
              <div class="metric-value">{{ memoryUsage.toFixed(1) }}%</div>
              <div class="metric-label">内存使用率</div>
              <el-progress 
                :percentage="memoryUsage" 
                :color="getMemoryColor(memoryUsage)"
                :show-text="false"
                :stroke-width="6"
              />
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card class="metric-card" shadow="hover">
          <div class="metric-content">
            <div class="metric-icon network">
              <el-icon><Connection /></el-icon>
            </div>
            <div class="metric-info">
              <div class="metric-value">{{ networkLatency }}ms</div>
              <div class="metric-label">网络延迟</div>
              <div class="network-status" :class="getNetworkStatus(networkLatency)">
                {{ getNetworkText(networkLatency) }}
              </div>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="6">
        <el-card class="metric-card" shadow="hover">
          <div class="metric-content">
            <div class="metric-icon disk">
              <el-icon><Folder /></el-icon>
            </div>
            <div class="metric-info">
              <div class="metric-value">{{ diskUsage.toFixed(1) }}%</div>
              <div class="metric-label">磁盘使用率</div>
              <el-progress 
                :percentage="diskUsage" 
                :color="getDiskColor(diskUsage)"
                :show-text="false"
                :stroke-width="6"
              />
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- 应用性能指标 -->
    <el-row :gutter="20" class="app-metrics">
      <el-col :span="8">
        <el-card class="app-metric-card">
          <template #header>
            <span>页面性能</span>
          </template>
          
          <div class="app-metric-content">
            <div class="metric-item">
              <span class="label">首次内容绘制 (FCP)</span>
              <span class="value" :class="getPerformanceClass(pageTimings.fcp)">
                {{ pageTimings.fcp }}ms
              </span>
            </div>
            <div class="metric-item">
              <span class="label">最大内容绘制 (LCP)</span>
              <span class="value" :class="getPerformanceClass(pageTimings.lcp)">
                {{ pageTimings.lcp }}ms
              </span>
            </div>
            <div class="metric-item">
              <span class="label">累积布局偏移 (CLS)</span>
              <span class="value" :class="getPerformanceClass(pageTimings.cls * 1000)">
                {{ pageTimings.cls.toFixed(3) }}
              </span>
            </div>
            <div class="metric-item">
              <span class="label">首次输入延迟 (FID)</span>
              <span class="value" :class="getPerformanceClass(pageTimings.fid)">
                {{ pageTimings.fid }}ms
              </span>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="8">
        <el-card class="app-metric-card">
          <template #header>
            <span>API响应</span>
          </template>
          
          <div class="app-metric-content">
            <div class="metric-item">
              <span class="label">平均响应时间</span>
              <span class="value" :class="getApiClass(apiMetrics.avgResponseTime)">
                {{ apiMetrics.avgResponseTime }}ms
              </span>
            </div>
            <div class="metric-item">
              <span class="label">成功率</span>
              <span class="value success">{{ (apiMetrics.successRate * 100).toFixed(1) }}%</span>
            </div>
            <div class="metric-item">
              <span class="label">错误率</span>
              <span class="value" :class="getErrorClass(apiMetrics.errorRate)">
                {{ (apiMetrics.errorRate * 100).toFixed(1) }}%
              </span>
            </div>
            <div class="metric-item">
              <span class="label">每秒请求数</span>
              <span class="value">{{ apiMetrics.requestsPerSecond }}</span>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <el-col :span="8">
        <el-card class="app-metric-card">
          <template #header>
            <span>用户体验</span>
          </template>
          
          <div class="app-metric-content">
            <div class="metric-item">
              <span class="label">活跃用户</span>
              <span class="value">{{ userMetrics.activeUsers }}</span>
            </div>
            <div class="metric-item">
              <span class="label">平均会话时长</span>
              <span class="value">{{ userMetrics.avgSessionDuration }}min</span>
            </div>
            <div class="metric-item">
              <span class="label">页面跳出率</span>
              <span class="value" :class="getBounceClass(userMetrics.bounceRate)">
                {{ (userMetrics.bounceRate * 100).toFixed(1) }}%
              </span>
            </div>
            <div class="metric-item">
              <span class="label">用户满意度</span>
              <span class="value" :class="getSatisfactionClass(userMetrics.satisfactionScore)">
                {{ userMetrics.satisfactionScore.toFixed(1) }}/5.0
              </span>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- 性能图表 -->
    <el-card class="performance-charts">
      <template #header>
        <div class="chart-header">
          <span>性能趋势图表</span>
          <div class="chart-controls">
            <el-select v-model="chartTimeRange" size="small" style="width: 120px">
              <el-option label="1小时" value="1h" />
              <el-option label="6小时" value="6h" />
              <el-option label="24小时" value="24h" />
              <el-option label="7天" value="7d" />
            </el-select>
            <el-button @click="refreshCharts" size="small">刷新</el-button>
          </div>
        </div>
      </template>
      
      <el-tabs v-model="activeChartTab">
        <el-tab-pane label="系统资源" name="system">
          <div class="chart-container">
            <canvas ref="systemChart" width="1200" height="300"></canvas>
          </div>
        </el-tab-pane>
        
        <el-tab-pane label="API性能" name="api">
          <div class="chart-container">
            <canvas ref="apiChart" width="1200" height="300"></canvas>
          </div>
        </el-tab-pane>
        
        <el-tab-pane label="用户行为" name="user">
          <div class="chart-container">
            <canvas ref="userChart" width="1200" height="300"></canvas>
          </div>
        </el-tab-pane>
      </el-tabs>
    </el-card>

    <!-- 性能优化建议 -->
    <el-card class="optimization-suggestions">
      <template #header>
        <span>智能优化建议</span>
        <el-tag type="info" size="small">AI驱动</el-tag>
      </template>
      
      <div class="suggestions-list">
        <div 
          v-for="suggestion in suggestions" 
          :key="suggestion.id"
          class="suggestion-item"
          :class="`priority-${suggestion.priority}`"
        >
          <div class="suggestion-header">
            <div class="suggestion-title">
              <el-icon><Warning /></el-icon>
              {{ suggestion.title }}
            </div>
            <div class="suggestion-meta">
              <el-tag :type="getPriorityType(suggestion.priority)" size="small">
                {{ getPriorityText(suggestion.priority) }}
              </el-tag>
              <span class="impact-text">预期改善: {{ suggestion.expectedImpact }}</span>
            </div>
          </div>
          
          <div class="suggestion-content">
            <p>{{ suggestion.description }}</p>
          </div>
          
          <div class="suggestion-actions">
            <el-button 
              @click="applySuggestion(suggestion)" 
              size="small" 
              type="primary" 
              plain
            >
              应用建议
            </el-button>
            <el-button 
              @click="dismissSuggestion(suggestion)" 
              size="small" 
              plain
            >
              忽略
            </el-button>
            <el-button 
              @click="showDetail(suggestion)" 
              size="small" 
              type="info" 
              plain
            >
              详情
            </el-button>
          </div>
        </div>
      </div>
    </el-card>
  </div>
</template>

<script>
import { ref, reactive, computed, onMounted, onUnmounted, watch, nextTick } from 'vue'
import { ElMessage } from 'element-plus'
import { 
  Monitor, 
  Cpu, 
  MemoryStick, 
  Connection, 
  Folder, 
  Warning 
} from '@element-plus/icons-vue'

export default {
  name: 'PerformanceMonitor',
  components: {
    Monitor,
    Cpu,
    MemoryStick,
    Connection,
    Folder,
    Warning
  },
  setup() {
    // 响应式数据
    const isMonitoring = ref(false)
    const chartTimeRange = ref('24h')
    const activeChartTab = ref('system')
    
    // 性能指标
    const cpuUsage = ref(0)
    const memoryUsage = ref(0)
    const networkLatency = ref(0)
    const diskUsage = ref(0)
    
    // 系统状态
    const systemStatus = reactive({
      type: 'success',
      text: '运行正常'
    })
    
    // 页面性能
    const pageTimings = reactive({
      fcp: 0,
      lcp: 0,
      cls: 0,
      fid: 0
    })
    
    // API指标
    const apiMetrics = reactive({
      avgResponseTime: 0,
      successRate: 0.99,
      errorRate: 0.01,
      requestsPerSecond: 0
    })
    
    // 用户指标
    const userMetrics = reactive({
      activeUsers: 0,
      avgSessionDuration: 0,
      bounceRate: 0.3,
      satisfactionScore: 4.2
    })
    
    // 优化建议
    const suggestions = ref([
      {
        id: 1,
        title: 'API响应时间优化',
        description: '检测到市场数据API平均响应时间为280ms，建议启用Redis缓存可将响应时间降低至50ms以内。',
        priority: 'high',
        expectedImpact: '响应时间降低80%',
        category: 'performance'
      },
      {
        id: 2,
        title: '前端资源优化',
        description: '检测到large chunk bundle，建议启用代码分割和懒加载可减少初始加载时间50%。',
        priority: 'medium',
        expectedImpact: '加载时间减少50%',
        category: 'frontend'
      },
      {
        id: 3,
        title: '数据库查询优化',
        description: '发现部分复杂查询未使用索引，建议添加复合索引可提升查询性能3-5倍。',
        priority: 'high',
        expectedImpact: '查询速度提升3-5倍',
        category: 'database'
      },
      {
        id: 4,
        title: '图片资源压缩',
        description: '检测到未压缩的图片资源，建议启用WebP格式和图片压缩可减少传输时间40%。',
        priority: 'low',
        expectedImpact: '传输时间减少40%',
        category: 'resource'
      }
    ])
    
    // 引用
    const systemChart = ref(null)
    const apiChart = ref(null)
    const userChart = ref(null)
    
    // 定时器
    let monitoringTimer = null
    let chartUpdateTimer = null
    
    // 方法
    const getCpuColor = (usage) => {
      if (usage >= 80) return '#f56c6c'
      if (usage >= 60) return '#e6a23c'
      return '#67c23a'
    }
    
    const getMemoryColor = (usage) => {
      if (usage >= 85) return '#f56c6c'
      if (usage >= 70) return '#e6a23c'
      return '#67c23a'
    }
    
    const getNetworkStatus = (latency) => {
      if (latency >= 200) return 'poor'
      if (latency >= 100) return 'fair'
      return 'good'
    }
    
    const getNetworkText = (latency) => {
      if (latency >= 200) return '差'
      if (latency >= 100) return '一般'
      return '良好'
    }
    
    const getDiskColor = (usage) => {
      if (usage >= 90) return '#f56c6c'
      if (usage >= 75) return '#e6a23c'
      return '#67c23a'
    }
    
    const getPerformanceClass = (value) => {
      // 根据Core Web Vitals标准
      if (value === pageTimings.fcp) {
        if (value <= 1800) return 'good'
        if (value <= 3000) return 'needs-improvement'
        return 'poor'
      }
      if (value === pageTimings.lcp) {
        if (value <= 2500) return 'good'
        if (value <= 4000) return 'needs-improvement'
        return 'poor'
      }
      if (value === pageTimings.cls * 1000) {
        if (value <= 100) return 'good'
        if (value <= 250) return 'needs-improvement'
        return 'poor'
      }
      if (value === pageTimings.fid) {
        if (value <= 100) return 'good'
        if (value <= 300) return 'needs-improvement'
        return 'poor'
      }
      return 'good'
    }
    
    const getApiClass = (responseTime) => {
      if (responseTime <= 100) return 'excellent'
      if (responseTime <= 300) return 'good'
      if (responseTime <= 500) return 'fair'
      return 'poor'
    }
    
    const getErrorClass = (errorRate) => {
      if (errorRate <= 0.01) return 'excellent'
      if (errorRate <= 0.05) return 'good'
      if (errorRate <= 0.1) return 'fair'
      return 'poor'
    }
    
    const getBounceRateClass = (rate) => {
      if (rate <= 0.3) return 'excellent'
      if (rate <= 0.5) return 'good'
      if (rate <= 0.7) return 'fair'
      return 'poor'
    }
    
    const getSatisfactionClass = (score) => {
      if (score >= 4.0) return 'excellent'
      if (score >= 3.5) return 'good'
      if (score >= 3.0) return 'fair'
      return 'poor'
    }
    
    const getPriorityType = (priority) => {
      const types = {
        high: 'danger',
        medium: 'warning',
        low: 'info'
      }
      return types[priority] || 'info'
    }
    
    const getPriorityText = (priority) => {
      const texts = {
        high: '高优先级',
        medium: '中优先级',
        low: '低优先级'
      }
      return texts[priority] || '未知'
    }
    
    const toggleMonitoring = () => {
      isMonitoring.value = !isMonitoring.value
      if (isMonitoring.value) {
        startMonitoring()
      } else {
        stopMonitoring()
      }
    }
    
    const startMonitoring = () => {
      // 开始实时监控
      monitoringTimer = setInterval(() => {
        collectPerformanceMetrics()
      }, 1000)
      
      chartUpdateTimer = setInterval(() => {
        updateCharts()
      }, 5000)
      
      ElMessage.success('性能监控已启动')
    }
    
    const stopMonitoring = () => {
      if (monitoringTimer) {
        clearInterval(monitoringTimer)
        monitoringTimer = null
      }
      if (chartUpdateTimer) {
        clearInterval(chartUpdateTimer)
        chartUpdateTimer = null
      }
      ElMessage.info('性能监控已停止')
    }
    
    const collectPerformanceMetrics = async () => {
      try {
        // 收集系统指标
        const systemResponse = await fetch('/api/performance/system')
        if (systemResponse.ok) {
          const systemData = await systemResponse.json()
          cpuUsage.value = systemData.cpu
          memoryUsage.value = systemData.memory
          networkLatency.value = systemData.latency
          diskUsage.value = systemData.disk
          
          // 更新系统状态
          const avgUsage = (systemData.cpu + systemData.memory + systemData.disk) / 3
          if (avgUsage >= 80) {
            systemStatus.type = 'danger'
            systemStatus.text = '性能警告'
          } else if (avgUsage >= 60) {
            systemStatus.type = 'warning'
            systemStatus.text = '性能注意'
          } else {
            systemStatus.type = 'success'
            systemStatus.text = '运行正常'
          }
        }
        
        // 收集页面性能
        if (window.performance && window.performance.getEntriesByType) {
          const navigation = performance.getEntriesByType('navigation')[0]
          if (navigation) {
            pageTimings.fcp = navigation.loadEventEnd - navigation.fetchStart
            pageTimings.lcp = getLCP()
            pageTimings.cls = getCLS()
            pageTimings.fid = getFID()
          }
        }
        
        // 收集API指标
        const apiResponse = await fetch('/api/performance/api')
        if (apiResponse.ok) {
          const apiData = await apiResponse.json()
          Object.assign(apiMetrics, apiData)
        }
        
        // 收集用户指标
        const userResponse = await fetch('/api/performance/user')
        if (userResponse.ok) {
          const userData = await userResponse.json()
          Object.assign(userMetrics, userData)
        }
        
      } catch (error) {
        console.error('性能指标收集失败:', error)
      }
    }
    
    const getLCP = () => {
      if (window.PerformanceObserver) {
        const observer = new PerformanceObserver((list) => {
          const entries = list.getEntries()
          return entries[entries.length - 1].startTime
        })
        observer.observe({ entryTypes: ['largest-contentful-paint'] })
      }
      return 2500 // 默认值
    }
    
    const getCLS = () => {
      let cls = 0
      if (window.PerformanceObserver) {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (!entry.hadRecentInput) {
              cls += entry.value
            }
          }
        })
        observer.observe({ entryTypes: ['layout-shift'] })
      }
      return cls
    }
    
    const getFID = () => {
      if (window.PerformanceObserver) {
        const observer = new PerformanceObserver((list) => {
          const entries = list.getEntries()
          return entries[0].processingStart - entries[0].startTime
        })
        observer.observe({ entryTypes: ['first-input'] })
      }
      return 100 // 默认值
    }
    
    const updateCharts = () => {
      if (activeChartTab.value === 'system') {
        drawSystemChart()
      } else if (activeChartTab.value === 'api') {
        drawApiChart()
      } else if (activeChartTab.value === 'user') {
        drawUserChart()
      }
    }
    
    const drawSystemChart = () => {
      if (!systemChart.value) return
      
      const ctx = systemChart.value.getContext('2d')
      const width = 1200
      const height = 300
      
      // 清除画布
      ctx.clearRect(0, 0, width, height)
      
      // 这里使用Chart.js进行图表绘制
      // 示例代码：
      if (window.Chart) {
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: generateTimeLabels(chartTimeRange.value),
            datasets: [
              {
                label: 'CPU使用率',
                data: generateData(chartTimeRange.value, cpuUsage.value),
                borderColor: '#f56c6c',
                backgroundColor: 'rgba(245, 108, 108, 0.1)',
                tension: 0.4
              },
              {
                label: '内存使用率',
                data: generateData(chartTimeRange.value, memoryUsage.value),
                borderColor: '#e6a23c',
                backgroundColor: 'rgba(230, 162, 60, 0.1)',
                tension: 0.4
              },
              {
                label: '磁盘使用率',
                data: generateData(chartTimeRange.value, diskUsage.value),
                borderColor: '#67c23a',
                backgroundColor: 'rgba(103, 194, 58, 0.1)',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function(value) {
                    return value + '%'
                  }
                }
              }
            },
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            }
          }
        })
      }
    }
    
    const drawApiChart = () => {
      // 绘制API性能图表
    }
    
    const drawUserChart = () => {
      // 绘制用户行为图表
    }
    
    const generateTimeLabels = (range) => {
      const now = new Date()
      const labels = []
      
      switch (range) {
        case '1h':
          for (let i = 59; i >= 0; i--) {
            const time = new Date(now.getTime() - i * 60000)
            labels.push(time.toLocaleTimeString())
          }
          break
        case '6h':
          for (let i = 359; i >= 0; i -= 6) {
            const time = new Date(now.getTime() - i * 60000)
            labels.push(time.toLocaleTimeString())
          }
          break
        case '24h':
          for (let i = 1439; i >= 0; i -= 60) {
            const time = new Date(now.getTime() - i * 60000)
            labels.push(time.toLocaleTimeString())
          }
          break
        case '7d':
          for (let i = 6; i >= 0; i--) {
            const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000)
            labels.push(date.toLocaleDateString())
          }
          break
      }
      
      return labels
    }
    
    const generateData = (range, currentValue) => {
      const data = []
      const points = range === '7d' ? 7 : range === '24h' ? 24 : range === '6h' ? 6 : 60
      
      for (let i = 0; i < points; i++) {
        // 生成接近当前值的随机数据
        const variation = currentValue * 0.1 // 10%的变动
        const randomValue = currentValue + (Math.random() - 0.5) * variation
        data.push(Math.max(0, Math.min(100, randomValue)))
      }
      
      return data
    }
    
    const refreshCharts = () => {
      updateCharts()
      ElMessage.success('图表已刷新')
    }
    
    const applySuggestion = async (suggestion) => {
      try {
        const response = await fetch('/api/performance/apply-optimization', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ suggestionId: suggestion.id })
        })
        
        if (!response.ok) throw new Error('应用失败')
        
        // 移除已应用的建议
        const index = suggestions.value.findIndex(s => s.id === suggestion.id)
        if (index > -1) {
          suggestions.value.splice(index, 1)
        }
        
        ElMessage.success('优化建议已应用')
      } catch (error) {
        ElMessage.error('应用失败，请重试')
      }
    }
    
    const dismissSuggestion = (suggestion) => {
      const index = suggestions.value.findIndex(s => s.id === suggestion.id)
      if (index > -1) {
        suggestions.value.splice(index, 1)
      }
      ElMessage.info('已忽略建议')
    }
    
    const showDetail = (suggestion) => {
      ElMessageBox.alert(
        `${suggestion.title}<br><br>${suggestion.description}<br><br>预期影响: ${suggestion.expectedImpact}`,
        '优化建议详情',
        {
          confirmButtonText: '确定',
          dangerouslyUseHTMLString: true
        }
      )
    }
    
    // 生命周期
    onMounted(() => {
      nextTick(() => {
        updateCharts()
      })
    })
    
    onUnmounted(() => {
      stopMonitoring()
    })
    
    // 监听
    watch(chartTimeRange, () => {
      updateCharts()
    })
    
    return {
      // 数据
      isMonitoring,
      chartTimeRange,
      activeChartTab,
      cpuUsage,
      memoryUsage,
      networkLatency,
      diskUsage,
      systemStatus,
      pageTimings,
      apiMetrics,
      userMetrics,
      suggestions,
      
      // 引用
      systemChart,
      apiChart,
      userChart,
      
      // 方法
      getCpuColor,
      getMemoryColor,
      getNetworkStatus,
      getNetworkText,
      getDiskColor,
      getPerformanceClass,
      getApiClass,
      getErrorClass,
      getBounceRateClass,
      getSatisfactionClass,
      getPriorityType,
      getPriorityText,
      toggleMonitoring,
      refreshCharts,
      applySuggestion,
      dismissSuggestion,
      showDetail
    }
  }
}
</script>

<style scoped>
.performance-monitor {
  padding: 20px;
  background-color: #f5f7fa;
  min-height: 100vh;
}

.performance-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  color: white;
}

.header-left h3 {
  margin: 0;
  font-size: 20px;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 8px;
}

.subtitle {
  margin: 5px 0 0 0;
  opacity: 0.9;
  font-size: 12px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.performance-metrics,
.app-metrics {
  margin-bottom: 20px;
}

.metric-card {
  cursor: pointer;
  transition: all 0.3s;
  height: 120px;
}

.metric-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.metric-content {
  display: flex;
  align-items: center;
  height: 100%;
}

.metric-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 16px;
  font-size: 24px;
  color: white;
}

.metric-icon.cpu {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.metric-icon.memory {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.metric-icon.network {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.metric-icon.disk {
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.metric-info {
  flex: 1;
}

.metric-value {
  font-size: 24px;
  font-weight: bold;
  color: #303133;
  margin-bottom: 4px;
}

.metric-label {
  font-size: 12px;
  color: #606266;
  margin-bottom: 8px;
}

.network-status {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 10px;
  text-align: center;
}

.network-status.good {
  background-color: #f0f9ff;
  color: #409EFF;
}

.network-status.fair {
  background-color: #fefce8;
  color: #E6A23C;
}

.network-status.poor {
  background-color: #fef2f2;
  color: #F56C6C;
}

.app-metric-card {
  height: 300px;
}

.app-metric-content {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.metric-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f5f7fa;
  border-radius: 8px;
}

.metric-item .label {
  font-size: 13px;
  color: #606266;
}

.metric-item .value {
  font-size: 14px;
  font-weight: bold;
}

.excellent {
  color: #67C23A;
}

.good {
  color: #409EFF;
}

.fair {
  color: #E6A23C;
}

.poor {
  color: #F56C6C;
}

.success {
  color: #67C23A;
}

.performance-charts {
  margin-bottom: 20px;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chart-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}

.chart-container {
  width: 100%;
  overflow-x: auto;
  padding: 20px 0;
}

.optimization-suggestions {
  margin-top: 20px;
}

.suggestions-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.suggestion-item {
  border: 1px solid #e4e7ed;
  border-radius: 8px;
  padding: 16px;
  transition: all 0.3s;
}

.suggestion-item:hover {
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

.suggestion-item.priority-high {
  border-left: 4px solid #F56C6C;
}

.suggestion-item.priority-medium {
  border-left: 4px solid #E6A23C;
}

.suggestion-item.priority-low {
  border-left: 4px solid #409EFF;
}

.suggestion-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.suggestion-title {
  font-size: 16px;
  font-weight: bold;
  color: #303133;
  display: flex;
  align-items: center;
  gap: 8px;
}

.suggestion-meta {
  display: flex;
  align-items: center;
  gap: 8px;
}

.impact-text {
  font-size: 12px;
  color: #909399;
}

.suggestion-content {
  margin-bottom: 16px;
}

.suggestion-content p {
  margin: 0;
  color: #606266;
  line-height: 1.6;
}

.suggestion-actions {
  display: flex;
  gap: 8px;
}

@media (max-width: 768px) {
  .performance-header {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
  
  .header-right {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .performance-metrics {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .app-metrics {
    grid-template-columns: 1fr;
  }
  
  .suggestion-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .suggestion-meta {
    flex-wrap: wrap;
  }
  
  .suggestion-actions {
    flex-wrap: wrap;
  }
}
</style>
```

#### 1.2 后端性能优化API

**API文件**: `app/api/performance.py`

```python
"""
系统性能监控API
提供系统资源监控、应用性能分析和优化建议
"""

from fastapi import APIRouter, HTTPException, Depends
from fastapi.security import HTTPBearer
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any
import asyncio
import psutil
import time
import structlog
from datetime import datetime, timedelta
import json
import redis
from sqlalchemy import text

logger = structlog.get_logger(__name__)
router = APIRouter()
security = HTTPBearer()

# 性能数据模型
class SystemMetrics(BaseModel):
    cpu: float = Field(..., description="CPU使用率(%)")
    memory: float = Field(..., description="内存使用率(%)")
    disk: float = Field(..., description="磁盘使用率(%)")
    network_latency: float = Field(..., description="网络延迟(ms)")
    timestamp: str = Field(..., description="时间戳")

class APIMetrics(BaseModel):
    avg_response_time: float = Field(..., description="平均响应时间(ms)")
    success_rate: float = Field(..., description="成功率")
    error_rate: float = Field(..., description="错误率")
    requests_per_second: float = Field(..., description="每秒请求数")
    endpoint_stats: Dict[str, Dict] = Field(..., description="端点统计")

class PageTimings(BaseModel):
    fcp: float = Field(..., description="首次内容绘制(ms)")
    lcp: float = Field(..., description="最大内容绘制(ms)")
    cls: float = Field(..., description="累积布局偏移")
    fid: float = Field(..., description="首次输入延迟(ms)")

class UserMetrics(BaseModel):
    active_users: int = Field(..., description="活跃用户数")
    avg_session_duration: float = Field(..., description="平均会话时长(min)")
    bounce_rate: float = Field(..., description="跳出率")
    satisfaction_score: float = Field(..., description="用户满意度")

class OptimizationSuggestion(BaseModel):
    id: int = Field(..., description="建议ID")
    title: str = Field(..., description="建议标题")
    description: str = Field(..., description="建议描述")
    priority: str = Field(..., description="优先级(high/medium/low)")
    category: str = Field(..., description="类别")
    expected_impact: str = Field(..., description="预期影响")
    implemented: bool = Field(False, description="是否已实施")

# Redis连接
redis_client = redis.Redis(
    host='localhost',
    port=6379,
    db=0,
    decode_responses=True
)

# 性能监控服务
class PerformanceMonitor:
    def __init__(self):
        self.logger = logger.bind(component="PerformanceMonitor")
        self.cache_ttl = 60  # 缓存60秒
        self.db_connections = {}  # 数据库连接池统计
        
    async def get_system_metrics(self) -> SystemMetrics:
        """获取系统指标"""
        try:
            # CPU使用率
            cpu_percent = psutil.cpu_percent(interval=1)
            
            # 内存使用率
            memory = psutil.virtual_memory()
            memory_percent = memory.percent
            
            # 磁盘使用率
            disk = psutil.disk_usage('/')
            disk_percent = (disk.used / disk.total) * 100
            
            # 网络延迟测试
            network_latency = await self._test_network_latency()
            
            return SystemMetrics(
                cpu=cpu_percent,
                memory=memory_percent,
                disk=disk_percent,
                network_latency=network_latency,
                timestamp=datetime.now().isoformat()
            )
        except Exception as e:
            self.logger.error("Failed to get system metrics", error=str(e))
            raise HTTPException(status_code=500, detail="获取系统指标失败")
    
    async def _test_network_latency(self) -> float:
        """测试网络延迟"""
        try:
            import subprocess
            
            # 使用ping测试延迟
            result = subprocess.run(
                ['ping', '-c', '1', '8.8.8.8'],
                capture_output=True,
                text=True,
                timeout=5
            )
            
            if result.returncode == 0:
                # 解析ping结果
                output = result.stdout
                if 'time=' in output:
                    time_str = output.split('time=')[1].split()[0]
                    return float(time_str.rstrip('ms'))
            
            return 50.0  # 默认值
        except Exception:
            return 50.0  # 默认值
    
    async def get_api_metrics(self) -> APIMetrics:
        """获取API性能指标"""
        try:
            # 从Redis获取API统计数据
            api_stats = redis_client.hgetall('api_stats')
            
            if not api_stats:
                return APIMetrics(
                    avg_response_time=120.0,
                    success_rate=0.985,
                    error_rate=0.015,
                    requests_per_second=45.0,
                    endpoint_stats={}
                )
            
            # 计算总体指标
            total_requests = int(api_stats.get('total_requests', 0))
            total_errors = int(api_stats.get('total_errors', 0))
            total_response_time = float(api_stats.get('total_response_time', 0))
            
            success_rate = (total_requests - total_errors) / total_requests if total_requests > 0 else 1.0
            error_rate = total_errors / total_requests if total_requests > 0 else 0.0
            avg_response_time = total_response_time / total_requests if total_requests > 0 else 0.0
            
            # 计算每秒请求数（基于最近1分钟的数据）
            recent_requests = int(api_stats.get('recent_requests', 0))
            requests_per_second = recent_requests / 60.0
            
            return APIMetrics(
                avg_response_time=avg_response_time,
                success_rate=success_rate,
                error_rate=error_rate,
                requests_per_second=requests_per_second,
                endpoint_stats=json.loads(api_stats.get('endpoint_stats', '{}'))
            )
        except Exception as e:
            self.logger.error("Failed to get API metrics", error=str(e))
            raise HTTPException(status_code=500, detail="获取API指标失败")
    
    async def get_page_timings(self) -> PageTimings:
        """获取页面性能指标"""
        try:
            # 从Redis获取页面性能数据
            page_stats = redis_client.get('page_performance')
            
            if page_stats:
                stats = json.loads(page_stats)
                return PageTimings(**stats)
            else:
                # 返回默认指标
                return PageTimings(
                    fcp=1200.0,
                    lcp=2500.0,
                    cls=0.05,
                    fid=80.0
                )
        except Exception as e:
            self.logger.error("Failed to get page timings", error=str(e))
            raise HTTPException(status_code=500, detail="获取页面性能失败")
    
    async def get_user_metrics(self) -> UserMetrics:
        """获取用户指标"""
        try:
            # 模拟用户指标数据
            # 在实际实现中，这些数据应该来自分析系统
            user_stats = redis_client.hgetall('user_metrics')
            
            if not user_stats:
                return UserMetrics(
                    active_users=1250,
                    avg_session_duration=18.5,
                    bounce_rate=0.32,
                    satisfaction_score=4.2
                )
            
            return UserMetrics(
                active_users=int(user_stats.get('active_users', 1250)),
                avg_session_duration=float(user_stats.get('avg_session_duration', 18.5)),
                bounce_rate=float(user_stats.get('bounce_rate', 0.32)),
                satisfaction_score=float(user_stats.get('satisfaction_score', 4.2))
            )
        except Exception as e:
            self.logger.error("Failed to get user metrics", error=str(e))
            raise HTTPException(status_code=500, detail="获取用户指标失败")
    
    async def get_optimization_suggestions(self) -> List[OptimizationSuggestion]:
        """获取优化建议"""
        suggestions = []
        
        try:
            # 获取系统指标
            system_metrics = await self.get_system_metrics()
            api_metrics = await self.get_api_metrics()
            
            # 基于系统指标生成建议
            if system_metrics.cpu > 80:
                suggestions.append(OptimizationSuggestion(
                    id=1,
                    title="CPU使用率过高",
                    description="检测到CPU使用率超过80%，建议优化计算密集型操作或增加服务器资源。",
                    priority="high",
                    category="system",
                    expected_impact="性能提升20-30%"
                ))
            
            if system_metrics.memory > 85:
                suggestions.append(OptimizationSuggestion(
                    id=2,
                    title="内存使用率过高",
                    description="检测到内存使用率超过85%，建议优化内存使用或增加内存配置。",
                    priority="high",
                    category="system",
                    expected_impact="内存使用减少30%"
                ))
            
            if api_metrics.avg_response_time > 300:
                suggestions.append(OptimizationSuggestion(
                    id=3,
                    title="API响应时间过长",
                    description="检测到API平均响应时间超过300ms，建议启用Redis缓存和数据库查询优化。",
                    priority="high",
                    category="api",
                    expected_impact="响应时间减少60%"
                ))
            
            if api_metrics.error_rate > 0.05:
                suggestions.append(OptimizationSuggestion(
                    id=4,
                    title="API错误率过高",
                    description="检测到API错误率超过5%，建议检查错误日志并修复相关问题。",
                    priority="high",
                    category="api",
                    expected_impact="错误率降低至1%以下"
                ))
            
            # 添加一些预防性建议
            suggestions.extend([
                OptimizationSuggestion(
                    id=5,
                    title="数据库索引优化",
                    description="定期检查和优化数据库索引，可以显著提升查询性能。",
                    priority="medium",
                    category="database",
                    expected_impact="查询速度提升3-5倍"
                ),
                OptimizationSuggestion(
                    id=6,
                    title="图片资源压缩",
                    description="启用图片压缩和WebP格式，可以减少页面加载时间。",
                    priority="low",
                    category="