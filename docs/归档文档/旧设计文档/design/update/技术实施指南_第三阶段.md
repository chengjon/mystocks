# Web功能优化技术实施指南 - 第三阶段

## 阶段概览

**阶段名称**: GPU加速与高级分析  
**实施时间**: 第8-10周 (总计: 22-30天)  
**主要目标**: 在前两阶段基础上，引入GPU加速回测系统、专业风险管理仪表盘、高级数据分析仪表盘  
**技术栈**: Vue 3 + FastAPI + RAPIDS (cuDF/cuML) + D3.js + WebGL + PostgreSQL + TDengine

## 核心功能模块

### 1. GPU加速回测系统

#### 1.1 前端组件开发

**组件文件**: `src/views/Strategy/BacktestGPU.vue`

```vue
<parameter name="template">
  <div class="backtest-gpu-container">
    <!-- GPU加速回测头部 -->
    <div class="gpu-header">
      <div class="header-left">
        <h2>
          <el-icon><Cpu /></el-icon>
          GPU加速回测系统
        </h2>
        <p class="subtitle">
          基于RAPIDS加速的高性能策略回测分析平台
          <el-tag size="small" type="success">GPU: {{ gpuStatus }}</el-tag>
        </p>
      </div>
      
      <div class="header-right">
        <div class="performance-metrics">
          <div class="metric">
            <span class="label">加速比</span>
            <span class="value">{{ accelerationRatio }}x</span>
          </div>
          <div class="metric">
            <span class="label">内存使用</span>
            <span class="value">{{ gpuMemoryUsage }}%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- GPU状态监控面板 -->
    <el-card class="gpu-monitor" v-if="showGPUMonitor">
      <template #header>
        <span>GPU实时状态监控</span>
        <el-switch v-model="realtimeMonitoring" active-text="实时监控" />
      </template>
      
      <div class="monitor-grid">
        <div class="monitor-item">
          <h4>GPU利用率</h4>
          <el-progress :percentage="gpuUtilization" :color="getUtilizationColor(gpuUtilization)" />
        </div>
        <div class="monitor-item">
          <h4>显存使用</h4>
          <el-progress :percentage="memoryUsage" :color="getMemoryColor(memoryUsage)" />
        </div>
        <div class="monitor-item">
          <h4>温度</h4>
          <el-progress :percentage="gpuTemp" :color="getTempColor(gpuTemp)" />
        </div>
        <div class="monitor-item">
          <h4>功耗</h4>
          <span class="power-value">{{ gpuPower }}W</span>
        </div>
      </div>
      
      <div class="gpu-charts">
        <div class="chart-container">
          <h4>GPU利用率历史</h4>
          <canvas ref="utilizationChart" width="400" height="200"></canvas>
        </div>
        <div class="chart-container">
          <h4>显存分配情况</h4>
          <canvas ref="memoryChart" width="400" height="200"></canvas>
        </div>
      </div>
    </el-card>

    <!-- 回测配置面板 -->
    <el-card class="backtest-config">
      <template #header>
        <div class="config-header">
          <span>回测配置</span>
          <div class="config-actions">
            <el-button @click="loadTemplate" size="small" type="primary" plain>
              <el-icon><Document /></el-icon>
              加载模板
            </el-button>
            <el-button @click="saveConfig" size="small" type="success" plain>
              <el-icon><Download /></el-icon>
              保存配置
            </el-button>
          </div>
        </div>
      </template>
      
      <el-row :gutter="20">
        <el-col :span="12">
          <!-- 策略配置 -->
          <div class="config-section">
            <h4>策略参数</h4>
            <el-form :model="strategyConfig" label-width="120px">
              <el-form-item label="策略名称">
                <el-input v-model="strategyConfig.name" placeholder="请输入策略名称" />
              </el-form-item>
              
              <el-form-item label="策略类型">
                <el-select v-model="strategyConfig.type" placeholder="选择策略类型">
                  <el-option label="均线策略" value="moving_average" />
                  <el-option label="RSI策略" value="rsi" />
                  <el-option label="MACD策略" value="macd" />
                  <el-option label="动量策略" value="momentum" />
                  <el-option label="网格策略" value="grid" />
                  <el-option label="自定义策略" value="custom" />
                </el-select>
              </el-form-item>
              
              <div v-if="strategyConfig.type === 'moving_average'">
                <el-form-item label="短期均线">
                  <el-input-number v-model="strategyConfig.shortPeriod" :min="1" :max="50" />
                </el-form-item>
                <el-form-item label="长期均线">
                  <el-input-number v-model="strategyConfig.longPeriod" :min="10" :max="200" />
                </el-form-item>
              </div>
              
              <div v-if="strategyConfig.type === 'rsi'">
                <el-form-item label="RSI周期">
                  <el-input-number v-model="strategyConfig.rsiPeriod" :min="2" :max="30" />
                </el-form-item>
                <el-form-item label="超买阈值">
                  <el-input-number v-model="strategyConfig.overbought" :min="50" :max="100" />
                </el-form-item>
                <el-form-item label="超卖阈值">
                  <el-input-number v-model="strategyConfig.oversold" :min="0" :max="50" />
                </el-form-item>
              </div>
              
              <el-form-item label="仓位管理">
                <el-select v-model="strategyConfig.positionManagement" placeholder="选择仓位管理方式">
                  <el-option label="固定比例" value="fixed_ratio" />
                  <el-option label="动态调整" value="dynamic" />
                  <el-option label="风险平价" value="risk_parity" />
                </el-select>
              </el-form-item>
              
              <el-form-item label="最大持仓比例">
                <el-slider 
                  v-model="strategyConfig.maxPositionRatio" 
                  :min="0.1" 
                  :max="1.0" 
                  :step="0.1"
                  show-stops
                  show-input
                />
              </el-form-item>
            </el-form>
          </div>
        </el-col>
        
        <el-col :span="12">
          <!-- 回测参数 -->
          <div class="config-section">
            <h4>回测参数</h4>
            <el-form :model="backtestConfig" label-width="120px">
              <el-form-item label="回测开始时间">
                <el-date-picker 
                  v-model="backtestConfig.startDate" 
                  type="date" 
                  placeholder="选择开始日期"
                  format="YYYY-MM-DD"
                  value-format="YYYY-MM-DD"
                />
              </el-form-item>
              
              <el-form-item label="回测结束时间">
                <el-date-picker 
                  v-model="backtestConfig.endDate" 
                  type="date" 
                  placeholder="选择结束日期"
                  format="YYYY-MM-DD"
                  value-format="YYYY-MM-DD"
                />
              </el-form-item>
              
              <el-form-item label="初始资金">
                <el-input-number 
                  v-model="backtestConfig.initialCapital" 
                  :min="10000" 
                  :max="1000000000"
                  :step="10000"
                  formatter="value => value.toLocaleString()"
                />
              </el-form-item>
              
              <el-form-item label="交易成本">
                <el-row :gutter="10">
                  <el-col :span="12">
                    <el-input-number 
                      v-model="backtestConfig.commissionRate" 
                      :min="0" 
                      :max="0.01" 
                      :precision="4"
                      placeholder="佣金率"
                    />
                    <span class="input-label">佣金率</span>
                  </el-col>
                  <el-col :span="12">
                    <el-input-number 
                      v-model="backtestConfig.stampTaxRate" 
                      :min="0" 
                      :max="0.001" 
                      :precision="4"
                      placeholder="印花税率"
                    />
                    <span class="input-label">印花税率</span>
                  </el-col>
                </el-row>
              </el-form-item>
              
              <el-form-item label="股票池">
                <el-select 
                  v-model="backtestConfig.universe" 
                  placeholder="选择股票池"
                  multiple
                  filterable
                >
                  <el-option label="沪深300" value="HS300" />
                  <el-option label="中证500" value="CSI500" />
                  <el-option label="全A股" value="ALL_A" />
                  <el-option label="自定义" value="CUSTOM" />
                </el-select>
              </el-form-item>
              
              <el-form-item label="回测模式">
                <el-radio-group v-model="backtestConfig.mode">
                  <el-radio label="GPU_ACCELERATED">GPU加速模式</el-radio>
                  <el-radio label="CPU_STANDARD">CPU标准模式</el-radio>
                  <el-radio label="HYBRID">混合模式</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-form>
          </div>
        </el-col>
      </el-row>
    </el-card>

    <!-- 回测执行面板 -->
    <div class="backtest-execution">
      <el-card>
        <template #header>
          <div class="execution-header">
            <span>回测执行</span>
            <div class="execution-status" v-if="isRunning">
              <el-progress 
                :percentage="executionProgress" 
                :status="executionStatus"
                :stroke-width="8"
                style="width: 200px"
              />
              <span class="status-text">{{ executionStatusText }}</span>
            </div>
          </div>
        </template>
        
        <div class="execution-content">
          <div class="execution-actions">
            <el-button 
              @click="startBacktest" 
              :loading="isRunning" 
              type="primary" 
              size="large"
              :disabled="!canStartBacktest"
            >
              <el-icon><VideoPlay /></el-icon>
              {{ isRunning ? '运行中...' : '开始GPU回测' }}
            </el-button>
            
            <el-button 
              @click="stopBacktest" 
              :loading="isStopping" 
              type="danger" 
              size="large"
              :disabled="!isRunning"
            >
              <el-icon><VideoPause /></el-icon>
              停止回测
            </el-button>
            
            <el-button 
              @click="exportResults" 
              :disabled="!results" 
              type="success" 
              size="large"
            >
              <el-icon><Download /></el-icon>
              导出结果
            </el-button>
          </div>
          
          <!-- 实时日志 -->
          <div class="execution-logs" v-if="logs.length">
            <h4>执行日志</h4>
            <div class="log-container" ref="logContainer">
              <div 
                v-for="(log, index) in logs" 
                :key="index"
                :class="['log-item', `log-${log.level}`]"
              >
                <span class="log-time">{{ log.timestamp }}</span>
                <span class="log-message">{{ log.message }}</span>
              </div>
            </div>
          </div>
        </div>
      </el-card>
    </div>

    <!-- 回测结果展示 -->
    <div class="backtest-results" v-if="results">
      <!-- 关键指标卡片 -->
      <el-row :gutter="20" class="metrics-cards">
        <el-col :span="6">
          <el-card class="metric-card" shadow="hover">
            <div class="metric-content">
              <div class="metric-icon">
                <el-icon><TrendCharts /></el-icon>
              </div>
              <div class="metric-info">
                <div class="metric-value">{{ results.totalReturn.toFixed(2) }}%</div>
                <div class="metric-label">总收益率</div>
                <div class="metric-change" :class="getReturnClass(results.totalReturn)">
                  <el-icon><ArrowUp v-if="results.totalReturn > 0" /><ArrowDown v-else /></el-icon>
                  {{ Math.abs(results.benchmarkReturn).toFixed(2) }}% (基准)
                </div>
              </div>
            </div>
          </el-card>
        </el-col>
        
        <el-col :span="6">
          <el-card class="metric-card" shadow="hover">
            <div class="metric-content">
              <div class="metric-icon">
                <el-icon><Warning /></el-icon>
              </div>
              <div class="metric-info">
                <div class="metric-value">{{ results.maxDrawdown.toFixed(2) }}%</div>
                <div class="metric-label">最大回撤</div>
                <div class="metric-change risk-level" :class="getRiskLevel(results.maxDrawdown)">
                  {{ getRiskLevelText(results.maxDrawdown) }}
                </div>
              </div>
            </div>
          </el-card>
        </el-col>
        
        <el-col :span="6">
          <el-card class="metric-card" shadow="hover">
            <div class="metric-content">
              <div class="metric-icon">
                <el-icon><Trophy /></el-icon>
              </div>
              <div class="metric-info">
                <div class="metric-value">{{ results.sharpeRatio.toFixed(2) }}</div>
                <div class="metric-label">夏普比率</div>
                <div class="metric-change" :class="getSharpeClass(results.sharpeRatio)">
                  {{ getSharpeLevelText(results.sharpeRatio) }}
                </div>
              </div>
            </div>
          </el-card>
        </el-col>
        
        <el-col :span="6">
          <el-card class="metric-card" shadow="hover">
            <div class="metric-content">
              <div class="metric-icon">
                <el-icon><Clock /></el-icon>
              </div>
              <div class="metric-info">
                <div class="metric-value">{{ results.executionTime }}s</div>
                <div class="metric-label">执行时间</div>
                <div class="metric-change acceleration">
                  {{ results.accelerationRatio }}x 加速
                </div>
              </div>
            </div>
          </el-card>
        </el-col>
      </el-row>
      
      <!-- 回测曲线图表 -->
      <el-card class="chart-section">
        <template #header>
          <span>回测曲线分析</span>
          <div class="chart-controls">
            <el-radio-group v-model="chartType" size="small">
              <el-radio-button label="equity">权益曲线</el-radio-button>
              <el-radio-button label="drawdown">回撤曲线</el-radio-button>
              <el-radio-button label="monthly">月度收益</el-radio-button>
              <el-radio-button label="rolling">滚动收益</el-radio-button>
            </el-radio-group>
          </div>
        </template>
        
        <div class="chart-container">
          <canvas ref="backtestChart" width="1200" height="400"></canvas>
        </div>
      </el-card>
      
      <!-- 详细分析面板 -->
      <el-row :gutter="20">
        <!-- 交易分析 -->
        <el-col :span="12">
          <el-card class="analysis-card">
            <template #header>
              <span>交易分析</span>
            </template>
            
            <div class="analysis-grid">
              <div class="analysis-item">
                <span class="label">总交易次数</span>
                <span class="value">{{ results.totalTrades }}</span>
              </div>
              <div class="analysis-item">
                <span class="label">胜率</span>
                <span class="value">{{ (results.winRate * 100).toFixed(1) }}%</span>
              </div>
              <div class="analysis-item">
                <span class="label">平均盈利</span>
                <span class="value positive">+{{ results.avgProfit.toFixed(2) }}%</span>
              </div>
              <div class="analysis-item">
                <span class="label">平均亏损</span>
                <span class="value negative">{{ results.avgLoss.toFixed(2) }}%</span>
              </div>
              <div class="analysis-item">
                <span class="label">盈亏比</span>
                <span class="value">{{ results.profitLossRatio.toFixed(2) }}</span>
              </div>
              <div class="analysis-item">
                <span class="label">交易频率</span>
                <span class="value">{{ results.tradingFrequency.toFixed(2) }}/年</span>
              </div>
            </div>
          </el-card>
        </el-col>
        
        <!-- 风险分析 -->
        <el-col :span="12">
          <el-card class="analysis-card">
            <template #header>
              <span>风险分析</span>
            </template>
            
            <div class="analysis-grid">
              <div class="analysis-item">
                <span class="label">波动率</span>
                <span class="value">{{ results.volatility.toFixed(2) }}%</span>
              </div>
              <div class="analysis-item">
                <span class="label">Beta系数</span>
                <span class="value">{{ results.beta.toFixed(2) }}</span>
              </div>
              <div class="analysis-item">
                <span class="label">Alpha收益</span>
                <span class="value" :class="getAlphaClass(results.alpha)">
                  {{ results.alpha > 0 ? '+' : '' }}{{ results.alpha.toFixed(2) }}%
                </span>
              </div>
              <div class="analysis-item">
                <span class="label">信息比率</span>
                <span class="value">{{ results.informationRatio.toFixed(2) }}</span>
              </div>
              <div class="analysis-item">
                <span class="label">VAR(95%)</span>
                <span class="value">{{ results.var95.toFixed(2) }}%</span>
              </div>
              <div class="analysis-item">
                <span class="label">卡玛比率</span>
                <span class="value">{{ results.calmarRatio.toFixed(2) }}</span>
              </div>
            </div>
          </el-card>
        </el-col>
      </el-row>
    </div>
  </div>
</template>

<script>
import { ref, reactive, computed, onMounted, watch, nextTick } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { 
  Cpu, 
  Document, 
  Download, 
  VideoPlay, 
  VideoPause, 
  TrendCharts, 
  Warning, 
  Trophy, 
  Clock, 
  ArrowUp, 
  ArrowDown
} from '@element-plus/icons-vue'

export default {
  name: 'BacktestGPU',
  components: {
    Cpu,
    Document,
    Download,
    VideoPlay,
    VideoPause,
    TrendCharts,
    Warning,
    Trophy,
    Clock,
    ArrowUp,
    ArrowDown
  },
  setup() {
    // 响应式数据
    const isRunning = ref(false)
    const isStopping = ref(false)
    const executionProgress = ref(0)
    const executionStatus = ref('')
    const executionStatusText = ref('')
    const showGPUMonitor = ref(true)
    const realtimeMonitoring = ref(true)
    const results = ref(null)
    const logs = ref([])
    const chartType = ref('equity')
    
    // GPU状态数据
    const gpuStatus = ref('N/A')
    const gpuUtilization = ref(0)
    const memoryUsage = ref(0)
    const gpuTemp = ref(0)
    const gpuPower = ref(0)
    const gpuMemoryUsage = ref(0)
    const accelerationRatio = ref(0)
    
    // 配置数据
    const strategyConfig = reactive({
      name: '',
      type: '',
      shortPeriod: 20,
      longPeriod: 60,
      rsiPeriod: 14,
      overbought: 70,
      oversold: 30,
      positionManagement: 'fixed_ratio',
      maxPositionRatio: 0.8
    })
    
    const backtestConfig = reactive({
      startDate: '',
      endDate: '',
      initialCapital: 1000000,
      commissionRate: 0.0003,
      stampTaxRate: 0.001,
      universe: [],
      mode: 'GPU_ACCELERATED'
    })

    // 引用
    const utilizationChart = ref(null)
    const memoryChart = ref(null)
    const backtestChart = ref(null)
    const logContainer = ref(null)

    // 计算属性
    const canStartBacktest = computed(() => {
      return !isRunning.value && 
             strategyConfig.name && 
             strategyConfig.type && 
             backtestConfig.startDate && 
             backtestConfig.endDate
    })

    // 方法
    const getUtilizationColor = (utilization) => {
      if (utilization >= 90) return '#f56c6c'
      if (utilization >= 70) return '#e6a23c'
      return '#67c23a'
    }

    const getMemoryColor = (usage) => {
      if (usage >= 90) return '#f56c6c'
      if (usage >= 70) return '#e6a23c'
      return '#67c23a'
    }

    const getTempColor = (temp) => {
      if (temp >= 80) return '#f56c6c'
      if (temp >= 70) return '#e6a23c'
      return '#67c23a'
    }

    const getReturnClass = (returnValue) => {
      return returnValue >= 0 ? 'positive' : 'negative'
    }

    const getRiskLevel = (drawdown) => {
      if (drawdown <= 10) return 'low'
      if (drawdown <= 20) return 'medium'
      return 'high'
    }

    const getRiskLevelText = (drawdown) => {
      if (drawdown <= 10) return '低风险'
      if (drawdown <= 20) return '中风险'
      return '高风险'
    }

    const getSharpeClass = (sharpe) => {
      if (sharpe >= 2) return 'excellent'
      if (sharpe >= 1) return 'good'
      return 'poor'
    }

    const getSharpeLevelText = (sharpe) => {
      if (sharpe >= 2) return '优秀'
      if (sharpe >= 1) return '良好'
      return '一般'
    }

    const getAlphaClass = (alpha) => {
      return alpha >= 0 ? 'positive' : 'negative'
    }

    const loadTemplate = async () => {
      try {
        const { value: templateName } = await ElMessageBox.prompt('选择模板', '加载策略模板', {
          confirmButtonText: '加载',
          cancelButtonText: '取消',
          inputType: 'select',
          inputOptions: [
            { label: '双均线策略', value: 'dual_ma' },
            { label: 'RSI反转策略', value: 'rsi_reversal' },
            { label: 'MACD动量策略', value: 'macd_momentum' },
            { label: '波动率突破', value: 'volatility_breakout' }
          ]
        })

        // 加载模板逻辑
        ElMessage.success(`已加载 ${templateName} 模板`)
      } catch (error) {
        if (error !== 'cancel') {
          ElMessage.error('加载模板失败')
        }
      }
    }

    const saveConfig = async () => {
      try {
        const configData = {
          strategy: strategyConfig,
          backtest: backtestConfig
        }

        const response = await fetch('/api/backtest/save-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(configData)
        })

        if (!response.ok) throw new Error('保存失败')

        ElMessage.success('配置已保存')
      } catch (error) {
        ElMessage.error('保存失败，请重试')
      }
    }

    const startBacktest = async () => {
      isRunning.value = true
      executionProgress.value = 0
      logs.value = []
      
      try {
        const response = await fetch('/api/backtest/gpu-start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            strategy: strategyConfig,
            config: backtestConfig
          })
        })

        if (!response.ok) throw new Error('回测启动失败')

        const reader = response.body.getReader()
        const decoder = new TextDecoder()
        
        while (true) {
          const { done, value } = await reader.read()
          if (done) break
          
          const chunk = decoder.decode(value)
          const lines = chunk.split('\n')
          
          for (const line of lines) {
            if (line.trim()) {
              try {
                const data = JSON.parse(line)
                handleProgressUpdate(data)
              } catch (e) {
                // 忽略解析错误
              }
            }
          }
        }

        // 获取最终结果
        const resultsResponse = await fetch('/api/backtest/results')
        if (resultsResponse.ok) {
          results.value = await resultsResponse.json()
          drawBacktestChart()
        }

      } catch (error) {
        ElMessage.error(`回测失败: ${error.message}`)
      } finally {
        isRunning.value = false
      }
    }

    const handleProgressUpdate = (data) => {
      switch (data.type) {
        case 'progress':
          executionProgress.value = data.progress
          executionStatusText.value = data.message
          break
        case 'log':
          logs.value.push({
            timestamp: new Date().toLocaleTimeString(),
            level: data.level,
            message: data.message
          })
          // 自动滚动日志
          nextTick(() => {
            if (logContainer.value) {
              logContainer.value.scrollTop = logContainer.value.scrollHeight
            }
          })
          break
        case 'gpu_status':
          gpuUtilization.value = data.gpuUtilization
          memoryUsage.value = data.memoryUsage
          gpuTemp.value = data.temperature
          gpuPower.value = data.power
          break
      }
    }

    const stopBacktest = async () => {
      isStopping.value = true
      try {
        await fetch('/api/backtest/stop', { method: 'POST' })
        isRunning.value = false
        ElMessage.info('回测已停止')
      } catch (error) {
        ElMessage.error('停止失败')
      } finally {
        isStopping.value = false
      }
    }

    const drawBacktestChart = () => {
      if (!backtestChart.value || !results.value) return
      
      const ctx = backtestChart.value.getContext('2d')
      const width = 1200
      const height = 400
      
      // 清除画布
      ctx.clearRect(0, 0, width, height)
      
      // 绘制图表逻辑
      // 这里使用Chart.js或D3.js进行专业图表绘制
      // 示例代码：
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: results.value.dates,
          datasets: [
            {
              label: '策略收益',
              data: results.value.strategyReturns,
              borderColor: '#409EFF',
              backgroundColor: 'rgba(64, 158, 255, 0.1)',
              fill: true
            },
            {
              label: '基准收益',
              data: results.value.benchmarkReturns,
              borderColor: '#67C23A',
              backgroundColor: 'rgba(103, 194, 58, 0.1)',
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: '日期'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: '收益率 (%)'
              }
            }
          }
        }
      })
    }

    const exportResults = async () => {
      try {
        const response = await fetch('/api/backtest/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ results: results.value })
        })

        if (!response.ok) throw new Error('导出失败')

        const blob = await response.blob()
        const url = window.URL.createObjectURL(blob)
        const link = document.createElement('a')
        link.href = url
        link.download = `GPU回测结果_${new Date().toISOString().split('T')[0]}.xlsx`
        link.click()
        window.URL.revokeObjectURL(url)

        ElMessage.success('结果已导出')
      } catch (error) {
        ElMessage.error('导出失败，请重试')
      }
    }

    // 监控GPU状态
    const monitorGPUStatus = () => {
      if (!realtimeMonitoring.value) return
      
      setInterval(async () => {
        try {
          const response = await fetch('/api/backtest/gpu-status')
          if (response.ok) {
            const status = await response.json()
            gpuStatus.value = status.device
            gpuUtilization.value = status.utilization
            memoryUsage.value = status.memoryUsage
            gpuTemp.value = status.temperature
            gpuPower.value = status.power
            
            // 更新图表
            updateUtilizationChart(status.utilization)
            updateMemoryChart(status.memoryUsage)
          }
        } catch (error) {
          console.error('GPU状态获取失败:', error)
        }
      }, 1000)
    }

    const updateUtilizationChart = (utilization) => {
      // 更新GPU利用率图表
    }

    const updateMemoryChart = (memory) => {
      // 更新显存使用图表
    }

    // 生命周期
    onMounted(() => {
      monitorGPUStatus()
    })

    // 监听
    watch(realtimeMonitoring, (newVal) => {
      if (newVal) {
        monitorGPUStatus()
      }
    })

    return {
      // 数据
      isRunning,
      isStopping,
      executionProgress,
      executionStatus,
      executionStatusText,
      showGPUMonitor,
      realtimeMonitoring,
      results,
      logs,
      chartType,
      gpuStatus,
      gpuUtilization,
      memoryUsage,
      gpuTemp,
      gpuPower,
      gpuMemoryUsage,
      accelerationRatio,
      strategyConfig,
      backtestConfig,
      
      // 计算属性
      canStartBacktest,
      
      // 引用
      utilizationChart,
      memoryChart,
      backtestChart,
      logContainer,
      
      // 方法
      getUtilizationColor,
      getMemoryColor,
      getTempColor,
      getReturnClass,
      getRiskLevel,
      getRiskLevelText,
      getSharpeClass,
      getSharpeLevelText,
      getAlphaClass,
      loadTemplate,
      saveConfig,
      startBacktest,
      stopBacktest,
      exportResults
    }
  }
}
</script>

<style scoped>
.backtest-gpu-container {
  padding: 20px;
  background-color: #f5f7fa;
  min-height: 100vh;
}

.gpu-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  color: white;
}

.header-left h2 {
  margin: 0;
  font-size: 28px;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 12px;
}

.subtitle {
  margin: 8px 0 0 0;
  opacity: 0.9;
  font-size: 14px;
}

.performance-metrics {
  display: flex;
  gap: 20px;
}

.metric {
  text-align: center;
}

.metric .label {
  display: block;
  font-size: 12px;
  opacity: 0.8;
}

.metric .value {
  display: block;
  font-size: 18px;
  font-weight: bold;
}

.gpu-monitor {
  margin-bottom: 20px;
}

.monitor-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 20px;
}

.monitor-item h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: #606266;
}

.power-value {
  font-size: 18px;
  font-weight: bold;
  color: #409EFF;
}

.gpu-charts {
  display: flex;
  gap: 20px;
}

.chart-container {
  flex: 1;
}

.chart-container h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: #606266;
}

.backtest-config {
  margin-bottom: 20px;
}

.config-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.config-actions {
  display: flex;
  gap: 8px;
}

.config-section {
  padding: 16px 0;
}

.config-section h4 {
  margin: 0 0 16px 0;
  font-size: 16px;
  color: #303133;
  border-bottom: 2px solid #409EFF;
  padding-bottom: 8px;
}

.input-label {
  display: block;
  font-size: 12px;
  color: #909399;
  margin-top: 4px;
}

.backtest-execution {
  margin-bottom: 20px;
}

.execution-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.execution-status {
  display: flex;
  align-items: center;
  gap: 12px;
}

.status-text {
  font-size: 14px;
  color: #606266;
}

.execution-content {
  padding: 16px 0;
}

.execution-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 20px;
}

.execution-logs {
  margin-top: 20px;
}

.execution-logs h4 {
  margin: 0 0 12px 0;
  font-size: 16px;
  color: #303133;
}

.log-container {
  height: 200px;
  overflow-y: auto;
  background: #f5f5f5;
  border: 1px solid #e4e7ed;
  border-radius: 4px;
  padding: 8px;
}

.log-item {
  display: flex;
  padding: 4px 0;
  font-size: 12px;
}

.log-time {
  color: #909399;
  margin-right: 12px;
  min-width: 60px;
}

.log-info {
  color: #409EFF;
}

.log-warn {
  color: #E6A23C;
}

.log-error {
  color: #F56C6C;
}

.backtest-results {
  margin-top: 20px;
}

.metrics-cards {
  margin-bottom: 20px;
}

.metric-card {
  cursor: pointer;
  transition: all 0.3s;
}

.metric-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.metric-content {
  display: flex;
  align-items: center;
  gap: 16px;
}

.metric-icon {
  font-size: 32px;
  color: #409EFF;
}

.metric-info {
  flex: 1;
}

.metric-value {
  font-size: 24px;
  font-weight: bold;
  color: #303133;
  margin-bottom: 4px;
}

.metric-label {
  font-size: 14px;
  color: #606266;
  margin-bottom: 4px;
}

.metric-change {
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.positive {
  color: #67C23A;
}

.negative {
  color: #F56C6C;
}

.excellent {
  color: #67C23A;
}

.good {
  color: #E6A23C;
}

.poor {
  color: #F56C6C;
}

.low {
  color: #67C23A;
}

.medium {
  color: #E6A23C;
}

.high {
  color: #F56C6C;
}

.risk-level {
  padding: 2px 6px;
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.05);
}

.acceleration {
  color: #409EFF;
}

.chart-section {
  margin-bottom: 20px;
}

.chart-controls {
  display: flex;
  gap: 8px;
}

.chart-container {
  width: 100%;
  overflow-x: auto;
}

.analysis-card {
  height: 100%;
}

.analysis-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.analysis-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f5f7fa;
  border-radius: 8px;
}

.analysis-item .label {
  font-size: 14px;
  color: #606266;
}

.analysis-item .value {
  font-size: 16px;
  font-weight: bold;
  color: #303133;
}

@media (max-width: 768px) {
  .gpu-header {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
  
  .performance-metrics {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .monitor-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .gpu-charts {
    flex-direction: column;
  }
  
  .execution-actions {
    flex-wrap: wrap;
  }
  
  .metrics-cards {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .analysis-grid {
    grid-template-columns: 1fr;
  }
}
</style>
```

#### 1.2 后端GPU API开发

**API文件**: `app/api/backtest_gpu.py`

```python
"""
GPU加速回测API
基于RAPIDS的高性能策略回测引擎
"""

from fastapi import APIRouter, HTTPException, Depends, BackgroundTasks
from fastapi.security import HTTPBearer
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any, AsyncGenerator
import asyncio
import json
import time
import structlog
from datetime import datetime, timedelta
import pandas as pd
import numpy as np

# RAPIDS导入
try:
    import cudf
    import cuml
    import cupy as cp
    RAPIDS_AVAILABLE = True
except ImportError:
    RAPIDS_AVAILABLE = False
    print("Warning: RAPIDS not available, falling back to CPU")

logger = structlog.get_logger(__name__)
router = APIRouter()
security = HTTPBearer()

# 请求模型
class StrategyConfig(BaseModel):
    name: str = Field(..., description="策略名称")
    strategy_type: str = Field(..., description="策略类型")
    short_period: Optional[int] = 20
    long_period: Optional[int] = 60
    rsi_period: Optional[int] = 14
    overbought: Optional[float] = 70.0
    oversold: Optional[float] = 30.0
    position_management: str = "fixed_ratio"
    max_position_ratio: float = 0.8

class BacktestConfig(BaseModel):
    start_date: str = Field(..., description="回测开始日期")
    end_date: str = Field(..., description="回测结束日期")
    initial_capital: float = Field(1000000, description="初始资金")
    commission_rate: float = Field(0.0003, description="佣金率")
    stamp_tax_rate: float = Field(0.001, description="印花税率")
    universe: List[str] = Field(default_factory=list, description="股票池")
    mode: str = Field("GPU_ACCELERATED", description="回测模式")

class BacktestRequest(BaseModel):
    strategy: StrategyConfig
    config: BacktestConfig

# 响应模型
class ProgressUpdate(BaseModel):
    type: str = Field(..., description="更新类型")
    progress: Optional[float] = Field(None, description="进度百分比")
    message: Optional[str] = Field(None, description="状态消息")
    level: Optional[str] = Field("info", description="日志级别")
    gpu_utilization: Optional[float] = Field(None, description="GPU利用率")
    memory_usage: Optional[float] = Field(None, description="内存使用率")
    temperature: Optional[float] = Field(None, description="GPU温度")
    power: Optional[float] = Field(None, description="GPU功耗")

class BacktestResult(BaseModel):
    # 基本指标
    total_return: float = Field(..., description="总收益率")
    annual_return: float = Field(..., description="年化收益率")
    benchmark_return: float = Field(..., description="基准收益率")
    volatility: float = Field(..., description="波动率")
    sharpe_ratio: float = Field(..., description="夏普比率")
    max_drawdown: float = Field(..., description="最大回撤")
    calmar_ratio: float = Field(..., description="卡玛比率")
    
    # 交易指标
    total_trades: int = Field(..., description="总交易次数")
    win_rate: float = Field(..., description="胜率")
    avg_profit: float = Field(..., description="平均盈利")
    avg_loss: float = Field(..., description="平均亏损")
    profit_loss_ratio: float = Field(..., description="盈亏比")
    trading_frequency: float = Field(..., description="交易频率")
    
    # 风险指标
    beta: float = Field(..., description="Beta系数")
    alpha: float = Field(..., description="Alpha收益")
    information_ratio: float = Field(..., description="信息比率")
    var_95: float = Field(..., description="VAR(95%)")
    
    # 性能指标
    execution_time: float = Field(..., description="执行时间")
    acceleration_ratio: float = Field(..., description="加速比")
    
    # 数据
    dates: List[str] = Field(..., description="日期列表")
    strategy_returns: List[float] = Field(..., description="策略收益")
    benchmark_returns: List[float] = Field(..., description="基准收益")
    daily_returns: List[float] = Field(..., description="日收益")
    equity_curve: List[float] = Field(..., description="权益曲线")
    drawdown_curve: List[float] = Field(..., description="回撤曲线")

# GPU加速回测引擎
class GPUBacktestEngine:
    def __init__(self, use_gpu: bool = True):
        self.use_gpu = use_gpu and RAPIDS_AVAILABLE
        self.logger = logger.bind(component="GPUBacktestEngine")
        self.device_count = 0
        if self.use_gpu:
            self._init_gpu()
        
    def _init_gpu(self):
        """初始化GPU环境"""
        try:
            # 检查GPU设备
            self.device_count = cp.cuda.runtime.getDeviceCount()
            self.logger.info("GPU initialized", device_count=self.device_count)
