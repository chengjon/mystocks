# 指标管理系统设计文档

## 1. 概述

指标管理系统是一个标准化、可扩展的技术指标计算框架，支持指标注册、依赖管理、智能调度和增量计算。

### 1.1 核心特性

- **标准化注册**: 统一的指标注册机制，支持元数据和参数验证
- **依赖管理**: 自动分析指标间依赖关系，支持循环检测
- **智能调度**: 支持同步/异步/批量三种计算模式
- **增量计算**: 基于缓存的增量计算优化
- **模板支持**: 预定义指标组合模板（短/中/长周期、波动率策略）

---

## 2. 设计原理

### 2.1 核心架构

```
┌─────────────────────────────────────────────────────────────┐
│                    IndicatorRegistry                        │
│                  (单例注册表，管理所有指标)                    │
├─────────────────────────────────────────────────────────────┤
│  IndicatorMetadata: 指标元数据（名称、分类、参数、依赖）       │
│  IndicatorParameter: 参数定义（类型、默认值、约束）            │
│  IndicatorTemplate: 指标组合模板                              │
├─────────────────────────────────────────────────────────────┤
│  OHLCVData: 标准OHLCV数据格式                                │
│  IndicatorResult: 计算结果容器                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 DependencyGraph                              │
│              (依赖关系图，DAG结构)                            │
├─────────────────────────────────────────────────────────────┤
│  DependencyNode: 指标节点（含参数）                           │
│  DependencyEdge: 依赖关系边                                   │
│  DependencyValidator: 参数验证器                              │
│  IncrementalCalculator: 增量计算器                            │
├─────────────────────────────────────────────────────────────┤
│  拓扑排序 (Kahn算法)                                          │
│  循环检测                                                    │
│  缓存验证                                                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  SmartScheduler                              │
│                (智能调度器)                                   │
├─────────────────────────────────────────────────────────────┤
│  SYNC: 同步计算                                              │
│  ASYNC_PARALLEL: 并行计算                                    │
│  BATCH: 批量计算                                             │
├─────────────────────────────────────────────────────────────┤
│  线程池管理                                                  │
│  性能监控                                                    │
│  缓存管理                                                    │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 节点ID格式

指标节点使用唯一标识符，格式如下：

- **无参数指标**: `RSI`
- **单参数指标**: `SMA[timeperiod-20]`
- **多参数指标**: `MACD[fastperiod-12_slowperiod-26]`

格式规则:
- `abbreviation[param1-value1_param2-value2]`
- 使用 `-` 连接键值对
- 使用 `_` 分隔多个参数对

### 2.3 依赖关系表示

依赖关系表示指标间的数据依赖，例如:
- MACD 依赖 EMA（计算MACD前需要先计算EMA）
- KDJ 依赖 RSV（计算RSV是KDJ的第一步）

依赖图使用 NetworkX 构建有向无环图(DAG)。

### 2.4 计算顺序确定

使用 Kahn算法进行拓扑排序，确保:
1. 依赖指标先于被依赖指标计算
2. 支持增量计算（缓存命中时跳过计算）
3. 支持并行计算（独立指标可并行处理）

---

## 3. 管理方法

### 3.1 指标分类

| 分类 | 说明 | 示例 |
|------|------|------|
| TREND | 趋势指标 | SMA, EMA, MACD, ADX |
| MOMENTUM | 动量指标 | RSI, KDJ, CCI, ROC |
| VOLATILITY | 波动率指标 | BBANDS, ATR, KELTNER |
| VOLUME | 成交量指标 | OBV, AD, ADOSC |
| CANDLESTICK | 价格形态 | DOJI, HAMMER, ENGULFING |

### 3.2 指标元数据管理

每个指标包含:
- **基本信息**: 名称、分类、描述
- **参数定义**: 参数列表（含类型、默认值、约束）
- **输出定义**: 输出值说明
- **依赖关系**: 依赖的其他指标
- **数据要求**: 最少需要的K线数量

### 3.3 参数约束

```python
ParameterConstraint(
    min=2,           # 最小值
    max=500,         # 最大值
    step=1,          # 步长
    valid_values=[], # 有效值列表
    description=""   # 描述
)
```

### 3.4 调度模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| SYNC | 同步顺序计算 | 简单场景、调试 |
| ASYNC_PARALLEL | 并行计算 | 多指标、独立计算 |
| BATCH | 批量优化计算 | 大数据量、批量处理 |

---

## 4. 新指标注册流程

### 4.1 注册前准备

1. **确定指标分类**: 根据指标性质选择合适分类
2. **定义参数**: 列出所有可配置参数及其约束
3. **确定依赖**: 明确指标计算所需的依赖指标
4. **计算输出**: 定义指标返回值结构

### 4.2 注册步骤

#### 步骤1: 编写指标元数据

```python
from app.services.indicators import (
    IndicatorMetadata,
    IndicatorParameter,
    IndicatorCategory,
    ParameterConstraint,
)

# 定义参数
sma_params = [
    IndicatorParameter(
        name="timeperiod",
        type_="int",
        default=20,
        description="移动平均周期",
        required=True,
        constraint=ParameterConstraint(min=2, max=500, step=1)
    )
]

# 定义元数据
sma_metadata = IndicatorMetadata(
    abbreviation="SMA",
    name="Simple Moving Average",
    category=IndicatorCategory.TREND,
    description="简单移动平均线",
    parameters=sma_params,
    outputs=[
        {"name": "sma", "type": "float", "description": "SMA值"}
    ],
    dependencies=[],  # 无依赖
    min_data_points=20  # 最少需要20根K线
)
```

#### 步骤2: 实现计算接口

```python
from app.services.indicators import IndicatorInterface, OHLCVData, IndicatorResult

class SMACalculator(IndicatorInterface):
    def calculate(
        self,
        ohlcv: OHLCVData,
        params: dict = None
    ) -> IndicatorResult:
        # 提取参数
        timeperiod = params.get("timeperiod", 20)

        # 计算SMA
        close = ohlcv.close
        sma = np.convolve(close, np.ones(timeperiod)/timeperiod, mode='valid')

        # 返回结果
        return IndicatorResult(
            status=CalculationStatus.SUCCESS,
            abbreviation="SMA",
            parameters=params,
            values={"sma": sma},
            calculation_time_ms=calculation_time
        )
```

#### 步骤3: 注册到注册表

```python
from app.services.indicators import indicator_registry

# 方式1: 直接注册
indicator_registry.register(SMA_METADATA, SMACalculator)

# 方式2: 从配置文件加载
indicator_registry.load_from_config("config/indicators/my_custom_indicator.yaml")
```

#### 步骤4: 添加到配置（如需要）

```yaml
# config/indicators/indicator_config.yaml
indicators:
  SMA:
    enabled: true
    category: TREND
    parameters:
      timeperiod:
        default: 20
        min: 2
        max: 500
    templates:
      short_term:
        timeperiod: 5
      medium_term:
        timeperiod: 20
      long_term:
        timeperiod: 60
```

### 4.3 验证注册

```python
# 验证指标已注册
indicator = indicator_registry.get_indicator("SMA")
print(indicator.name)  # "Simple Moving Average"

# 验证参数验证
is_valid, error = indicator_registry.validate_indicator("SMA", {"timeperiod": 20})
assert is_valid is True

# 验证参数约束
is_valid, error = indicator_registry.validate_indicator("SMA", {"timeperiod": 1})
assert is_valid is False
assert "最小值为2" in error
```

### 4.4 完整示例: 注册ATR指标

```python
from app.services.indicators import (
    IndicatorMetadata,
    IndicatorParameter,
    IndicatorCategory,
    ParameterConstraint,
    IndicatorInterface,
    OHLCVData,
    IndicatorResult,
    CalculationStatus,
    indicator_registry,
)
import numpy as np

# 1. 定义元数据
atr_params = [
    IndicatorParameter(
        name="timeperiod",
        type_="int",
        default=14,
        description="ATR周期",
        required=True,
        constraint=ParameterConstraint(min=2, max=100, step=1)
    )
]

atr_metadata = IndicatorMetadata(
    abbreviation="ATR",
    name="Average True Range",
    category=IndicatorCategory.VOLATILITY,
    description="平均真实波幅，用于衡量市场波动性",
    parameters=atr_params,
    outputs=[
        {"name": "atr", "type": "float", "description": "ATR值"}
    ],
    dependencies=[],
    min_data_points=14
)

# 2. 实现计算器
class ATRCalculator(IndicatorInterface):
    def calculate(self, ohlcv: OHLCVData, params: dict = None) -> IndicatorResult:
        timeperiod = params.get("timeperiod", 14)

        high = ohlcv.high
        low = ohlcv.low
        close = ohlcv.close

        # 计算True Range
        tr1 = high - low
        tr2 = np.abs(high - np.roll(close, 1))
        tr3 = np.abs(low - np.roll(close, 1))
        tr = np.maximum(tr1, np.maximum(tr2, tr3))

        # 计算ATR (使用EMA)
        atr = np.zeros_like(tr)
        atr[timeperiod-1] = np.mean(tr[:timeperiod])
        for i in range(timeperiod, len(tr)):
            atr[i] = (atr[i-1] * (timeperiod - 1) + tr[i]) / timeperiod

        return IndicatorResult(
            status=CalculationStatus.SUCCESS,
            abbreviation="ATR",
            parameters=params,
            values={"atr": atr},
            calculation_time_ms=0.0
        )

# 3. 注册指标
indicator_registry.register(atr_metadata, ATRCalculator)

# 4. 验证
print(f"ATR指标注册成功: {indicator_registry.get_indicator('ATR').name}")
```

---

## 5. 配置文件说明

### 5.1 指标配置 (indicator_config.yaml)

```yaml
indicators:
  # 趋势指标
  SMA:
    enabled: true
    category: TREND
    parameters:
      timeperiod:
        default: 20
        min: 2
        max: 500

  EMA:
    enabled: true
    category: TREND
    parameters:
      timeperiod:
        default: 12
        min: 2
        max: 500

  MACD:
    enabled: true
    category: TREND
    parameters:
      fastperiod:
        default: 12
        min: 2
        max: 200
      slowperiod:
        default: 26
        min: 2
        max: 200
      signalperiod:
        default: 9
        min: 2
        max: 200

# 指标模板
templates:
  short_term:
    name: "短期策略"
    indicators:
      - abbreviation: EMA
        params:
          timeperiod: 5
      - abbreviation: RSI
        params:
          timeperiod: 7
      - abbreviation: KDJ
        params:
          k_period: 9
          d_period: 3

  medium_term:
    name: "中期策略"
    indicators:
      - abbreviation: SMA
        params:
          timeperiod: 20
      - abbreviation: MACD
        params:
          fastperiod: 12
          slowperiod: 26
```

### 5.2 环境配置

```yaml
# 环境特定配置
environments:
  development:
    cache:
      enabled: false
      ttl: 3600
    scheduler:
      mode: SYNC
      max_workers: 2

  production:
    cache:
      enabled: true
      ttl: 3600
    scheduler:
      mode: ASYNC_PARALLEL
      max_workers: 8
```

---

## 6. 使用示例

### 6.1 基本使用

```python
from app.services.indicators import (
    IndicatorDependencyGraph,
    SmartScheduler,
    OHLCVData,
    CalculationMode,
)

# 创建依赖图
graph = IndicatorDependencyGraph()

# 添加指标及其依赖
graph.add_indicator(abbreviation="EMA", params={})
graph.add_indicator(
    abbreviation="MACD",
    params={"fastperiod": 12, "slowperiod": 26},
    dependencies=["EMA"]
)

# 获取计算顺序
order = graph.get_calculation_order([
    {"abbreviation": "MACD", "params": {"fastperiod": 12}, "dependencies": ["EMA"]},
    {"abbreviation": "EMA", "params": {}}
])

# 创建调度器
scheduler = SmartScheduler(max_workers=4, mode=CalculationMode.ASYNC_PARALLEL)

# 设置计算函数
scheduler.set_calculation_function(my_calc_function)

# 执行计算
results = scheduler.calculate(indicators, ohlcv_data)
```

### 6.2 使用模板

```python
from app.services.indicators import indicator_registry

# 获取预定义模板
template = indicator_registry.get_template("medium_term")

# 应用模板
indicators = []
for indicator in template.indicators:
    indicators.append({
        "abbreviation": indicator.abbreviation,
        "params": indicator.params
    })

# 执行计算
results = scheduler.calculate(indicators, ohlcv_data)
```

### 6.3 验证参数

```python
from app.services.indicators import indicator_registry

# 验证指标参数
is_valid, error = indicator_registry.validate_indicator("MACD", {
    "fastperiod": 12,
    "slowperiod": 26
})

if not is_valid:
    print(f"参数错误: {error}")
```

---

## 7. 最佳实践

### 7.1 命名规范

- **缩写**: 使用标准的指标缩写（SMA, EMA, MACD, RSI, KDJ）
- **参数**: 使用小写下划线命名（timeperiod, fastperiod）
- **分类**: 使用枚举值（TREND, MOMENTUM, VOLATILITY）

### 7.2 参数设计

- 提供合理的默认值
- 设置有效的范围约束
- 避免过多的可调参数

### 7.3 依赖管理

- 最小化指标间的依赖
- 避免循环依赖
- 清晰定义依赖关系

### 7.4 性能优化

- 使用缓存避免重复计算
- 利用并行计算处理独立指标
- 使用增量计算更新数据

---

## 8. 文件结构

```
web/backend/app/services/indicators/
├── __init__.py                      # 模块导出
├── indicator_metadata.py            # 元数据定义 (220行)
├── indicator_registry.py            # 注册表 (450行)
├── indicator_interface.py           # 接口定义 (280行)
├── dependency_graph.py              # 依赖图 (500+行)
└── smart_scheduler.py               # 智能调度 (400+行)

web/backend/tests/unit/services/indicators/
├── test_indicator_registry.py       # 注册表测试 (400行, 29测试)
└── test_dependency.py               # 依赖图测试 (430行, 34测试)

config/indicators/
└── indicator_config.yaml            # 默认配置 (300行)
```

---

## 9. 测试覆盖

| 模块 | 测试数 | 说明 |
|------|--------|------|
| IndicatorMetadata | 10 | 元数据创建、参数验证 |
| IndicatorRegistry | 12 | 注册、查询、验证、配置加载 |
| OHLCVData | 3 | 数据结构、切片 |
| IndicatorResult | 2 | 结果创建、输出获取 |
| DependencyNode | 4 | 节点创建、ID生成、依赖管理 |
| DependencyGraph | 13 | 添加、拓扑排序、循环检测 |
| DependencyValidator | 4 | MACD、KDJ参数验证 |
| IncrementalCalculator | 3 | 缓存管理 |
| SmartScheduler | 10 | 调度模式、缓存、并行计算 |
| Integration | 1 | 完整工作流 |

**总计: 63个测试，全部通过**
