# MyStocks API生态系统优化方案 (2026务实版)

## 1. 核心理念

本方案针对**个人投资者/小型投资者**的使用场景制定。针对现阶段需求，我们坚持以下原则：

1.  **实用主义 (Pragmatism)**: 拒绝过度设计，不引入目前不需要的复杂企业级流程。
2.  **稳定性优先 (Stability First)**: 首要任务是确保现有功能跑通、不报错、数据流转顺畅。
3.  **可观测性 (Observability)**: 确保系统在运行时，我们知道它是否健康，报错时能快速定位。
4.  **渐进式演进 (Evolution)**: 高级治理（如API-First、CDC、契约测试）作为系统稳定后的长期目标，不作为当前阻塞项。

---

## 2. Phase 1: 系统稳固与功能整合 (当前核心任务)

**目标**：确保系统"能用"且"好用"，消除明显的Bug和阻塞点。

### 2.1 核心端点健康检查与修复
*   **任务**: 对系统现有的核心API端点进行一轮完整的冒烟测试。
*   **动作**:
    *   梳理核心业务链路（行情 -> 分析 -> 策略 -> 交易）。
    *   修复任何返回 500 错误或格式不符合预期的端点。
    *   确保 Swagger UI (`/docs`) 可访问且能成功发起测试请求。
*   **验收标准**: 核心业务流程无报错，前端能正常获取数据。

### 2.2 前后端整合与流程打通
*   **任务**: 消除前端 (Vue3) 与后端 (FastAPI) 交互中的"摩擦"。
*   **动作**:
    *   **CORS/Auth**: 确保跨域配置正确，JWT Token 刷新机制无感运行（已修复 CSRF 和 Token 问题，需持续关注）。
    *   **数据格式对齐**: 确保后端返回的时间格式（如 ISO8601）与前端处理库（Dayjs）完美兼容（已修复 Dayjs 导入问题）。
    *   **错误处理**: 前端能优雅地展示后端抛出的错误信息，而不是白屏或无响应。
*   **验收标准**: 用户在 Web 界面操作流畅，无控制台红字报错。

### 2.3 基础监控与日志 (PM2 + 日志)
*   **任务**: 建立最基础的"看门狗"机制，确保服务挂了能自动重启并记录原因。
*   **动作**:
    *   **PM2配置**: 确保 `ecosystem.config.js` 配置正确，包含自动重启策略和日志路径。
    *   **日志归档**: 确保日志文件不会无限增长（配置 logrotate 或 PM2 log-rotate）。
    *   **简单告警**: (可选) 当 PM2 重启服务频繁时，通过简单的脚本发送通知（如邮件或钉钉）。
*   **验收标准**: `pm2 list` 全绿，日志文件可查且有意义。

### 2.4 数据同步服务稳定性
*   **任务**: 确保数据"搬运工"（Data Sync Services）按时按量工作。
*   **动作**:
    *   检查定时任务 (Cron) 是否按预期触发。
    *   验证数据入库完整性（如 K 线数据是否连续）。
    *   修复同步脚本的语法错误（如最近修复的 `data-sync-kline`）。
*   **验收标准**: 数据库中每日新增数据准确无误。

---

## 3. Phase 2: 标准化与治理 (未来路线图)

**触发条件**: 系统核心功能稳定运行 3-6 个月，且API变更变得频繁或多人协作需求增加时。

### 3.1 API生命周期管理规范化
*   **引入 OpenAPI 3.0**:
    *   从代码自动生成标准的 OpenAPI 3.0 文档 (`openapi.json`)。
    *   作为前后端协作的唯一"真理来源"。
*   **API设计评审**:
    *   在写代码前，先评审 API 接口定义（路径、参数、响应）。
*   **版本管理与弃用**:
    *   制定明确的 API 版本策略 (`/v1`, `/v2`)。
    *   建立平滑的 API 弃用流程 (Deprecation Headers)。

### 3.2 实施 API-First 开发流程
*   **合同驱动开发 (CDC)**:
    *   优先定义接口契约，前后端并行开发。
*   **自动化规范生成**:
    *   CI/CD 流水线中自动验证代码是否符合 API 规范。

### 3.3 构建 API 测试金字塔
*   **单元测试 (Unit Tests)**:
    *   针对 API 端点逻辑进行覆盖（Pytest）。
*   **集成测试 (Integration Tests)**:
    *   测试跨模块（如：API -> Service -> Database）的功能。
*   **契约测试 (Contract Tests)**:
    *   验证生产者（后端）与消费者（前端）的兼容性。
*   **E2E 测试 (End-to-End Tests)**:
    *   模拟用户真实场景的完整流程测试（Playwright）。

---

## 4. 总结

对于 MyStocks 这样一个服务于个人/小型投资者的系统，**"稳定"胜过"完美"**。我们不需要在一开始就背负沉重的企业级 API 治理包袱。

**当前的行动指南：**
1.  **Keep it running**: 保持 PM2 服务常青。
2.  **Keep it clean**: 修复报错，保持日志清晰。
3.  **Keep it simple**: 除非必要，不引入新的中间件或复杂流程。

待系统进入成熟期，我们将从容地开启 Phase 2 的标准化建设，将 MyStocks 打造为工业级的量化平台。
