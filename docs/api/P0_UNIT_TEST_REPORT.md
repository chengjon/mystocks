# Phase 7 Backend CLI - P0å•å…ƒæµ‹è¯•æŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2025-12-30
**æ‰§è¡Œè€…**: Backend CLI (APIå¥‘çº¦å¼€å‘å·¥ç¨‹å¸ˆ)
**åˆ†æ”¯**: phase7-backend-api-contracts

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

ä¸ºP0 APIåˆ›å»ºäº†**64ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹**,è¦†ç›–5ä¸ªæ ¸å¿ƒAPIæ¨¡å—ã€‚

### æµ‹è¯•ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°é‡ | çŠ¶æ€ |
|------|------|------|
| **æµ‹è¯•æ–‡ä»¶** | 3ä¸ª | âœ… åˆ›å»º |
| **æµ‹è¯•ç”¨ä¾‹** | 64ä¸ª | âœ… åˆ›å»º |
| **æµ‹è¯•é€šè¿‡** | 9ä¸ª | âœ… |
| **æµ‹è¯•å¤±è´¥** | 54ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤ |
| **æµ‹è¯•è·³è¿‡** | 5ä¸ª | â­ï¸ |
| **è¦†ç›–ç‡ç›®æ ‡** | 80% | â³ å¾…éªŒè¯ |

---

## ğŸ“ åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶

### 1. test_p0_market_api.py (29ä¸ªæµ‹è¯•ç”¨ä¾‹)

**æµ‹è¯•è¦†ç›–çš„13ä¸ªMarket APIç«¯ç‚¹**:

| ç«¯ç‚¹ | æµ‹è¯•ç”¨ä¾‹ | çŠ¶æ€ |
|------|----------|------|
| GET /fund-flow | 3ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| POST /fund-flow/refresh | 1ä¸ª | ğŸ”„ 403è®¤è¯é”™è¯¯ |
| GET /etf/list | 2ä¸ª | ğŸ”„ 500é”™è¯¯ |
| POST /etf/refresh | 1ä¸ª | ğŸ”„ 403è®¤è¯é”™è¯¯ |
| GET /chip-race | 2ä¸ª | ğŸ”„ 500é”™è¯¯ |
| POST /chip-race/refresh | 1ä¸ª | ğŸ”„ 403è®¤è¯é”™è¯¯ |
| GET /lhb | 2ä¸ª | ğŸ”„ 500é”™è¯¯ |
| POST /lhb/refresh | 1ä¸ª | ğŸ”„ 403è®¤è¯é”™è¯¯ |
| GET /quotes | 2ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /stocks | 2ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /kline | 3ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /heatmap | 2ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /health | 1ä¸ª | âœ… é€šè¿‡ |

**æµ‹è¯•ç±»å‹**:
- âœ… æ­£å¸¸è¯·æ±‚æµ‹è¯•
- âœ… å‚æ•°éªŒè¯æµ‹è¯•
- âœ… é”™è¯¯å¤„ç†æµ‹è¯•
- âœ… ç†”æ–­å™¨æµ‹è¯•
- âœ… å¹¶å‘è¯·æ±‚æµ‹è¯•
- âœ… æ€§èƒ½æµ‹è¯•

### 2. test_p0_data_api.py (15ä¸ªæµ‹è¯•ç”¨ä¾‹)

**æµ‹è¯•è¦†ç›–çš„Data APIç«¯ç‚¹**:

| ç«¯ç‚¹ | æµ‹è¯•ç”¨ä¾‹ | çŠ¶æ€ |
|------|----------|------|
| GET /stocks/basic | 4ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /stocks/daily | 1ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /kline | 1ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /stocks/industries | 1ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /stocks/concepts | 1ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /markets/overview | 2ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /stocks/search | 1ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| GET /financial | 1ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| é”™è¯¯å¤„ç†æµ‹è¯• | 2ä¸ª | ğŸ”„ éœ€è¦ä¿®å¤patchè·¯å¾„ |
| æ€§èƒ½æµ‹è¯• | 1ä¸ª | ğŸŸ¡ å¾…éªŒè¯ |

### 3. test_p0_strategy_trade_auth_api.py (20ä¸ªæµ‹è¯•ç”¨ä¾‹)

**æµ‹è¯•è¦†ç›–çš„Strategy/Trade/Auth APIç«¯ç‚¹**:

| API | ç«¯ç‚¹æ•° | æµ‹è¯•ç”¨ä¾‹ | çŠ¶æ€ |
|-----|--------|----------|------|
| **Strategy** | 6ä¸ª | 6ä¸ª | ğŸ”„ è·¯ç”±404/403é”™è¯¯ |
| **Trade** | 6ä¸ª | 6ä¸ª | ğŸ”„ è·¯ç”±404é”™è¯¯ |
| **Auth** | 6ä¸ª | 6ä¸ª | ğŸ”„ è·¯ç”±404é”™è¯¯ |
| **é›†æˆæµ‹è¯•** | - | 2ä¸ª | ğŸ”„ å¾…ä¿®å¤ |

---

## ğŸ” å‘ç°çš„é—®é¢˜

### é—®é¢˜1: Mock/Patchè·¯å¾„ä¸æ­£ç¡®

**åŸå› **: APIæ¨¡å—ä¸­çš„å‡½æ•°å¯¼å…¥æ–¹å¼å¯¼è‡´patchè·¯å¾„ä¸åŒ¹é…

```python
# APIä»£ç ä¸­çš„å¯¼å…¥
from app.services.data_source_factory import get_data_source_factory

# æµ‹è¯•ä»£ç ä¸­çš„patch
with patch("app.api.data.get_data_source_factory", ...):  # âŒ é”™è¯¯è·¯å¾„
```

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹patchè·¯å¾„åˆ°æ­£ç¡®çš„æ¨¡å—ä½ç½®
```python
with patch("app.services.data_source_factory.get_data_source_factory", ...):  # âœ… æ­£ç¡®è·¯å¾„
```

### é—®é¢˜2: APIè·¯ç”±è·¯å¾„ä¸åŒ¹é…

**åŸå› **: éƒ¨åˆ†APIè·¯ç”±è·¯å¾„ä¸æµ‹è¯•ä¸­çš„è·¯å¾„ä¸ä¸€è‡´

| æµ‹è¯•è·¯å¾„ | å®é™…è·¯å¾„ | çŠ¶æ€ |
|----------|----------|------|
| `/trade/health` | `/api/trade/health` | âŒ 404 |
| `/api/v1/auth/csrf_token` | æœªçŸ¥ | âŒ 404 |
| `/api/strategy/definitions` | æœªçŸ¥ | âŒ 500/403 |

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥å®é™…çš„è·¯ç”±å®šä¹‰å¹¶æ›´æ–°æµ‹è¯•è·¯å¾„

### é—®é¢˜3: è®¤è¯ä¸­é—´ä»¶é˜»æ­¢

**åŸå› **: éƒ¨åˆ†APIéœ€è¦è®¤è¯,æµ‹è¯•æœªæä¾›è®¤è¯token

| å“åº”ç  | å«ä¹‰ | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|
| 401 | æœªè®¤è¯ | æ·»åŠ è®¤è¯mock |
| 403 | ç¦æ­¢è®¿é—® | æ·»åŠ æƒé™mock |

**è§£å†³æ–¹æ¡ˆ**: åœ¨æµ‹è¯•ä¸­mockè®¤è¯ä¸­é—´ä»¶
```python
@patch("app.api.auth.get_current_user")
def test_endpoint(self, mock_auth, client):
    mock_auth.return_value = MagicMock(username="test")
    response = client.get(...)
```

---

## âœ… å·²å®Œæˆçš„æµ‹è¯•

| æµ‹è¯• | æè¿° | çŠ¶æ€ |
|------|------|------|
| test_health_check | Market APIå¥åº·æ£€æŸ¥ | âœ… é€šè¿‡ |
| test_get_stocks_basic_success | Data APIåŸºæœ¬æŸ¥è¯¢ | âœ… é€šè¿‡ |
| test_get_stocks_basic_with_search | å¸¦æœç´¢çš„è‚¡ç¥¨æŸ¥è¯¢ | âœ… é€šè¿‡ |
| test_get_stocks_basic_with_industry_filter | è¡Œä¸šç­›é€‰ | âœ… é€šè¿‡ |
| test_get_stocks_basic_invalid_limit | å‚æ•°éªŒè¯ | âœ… é€šè¿‡ |
| test_get_stocks_basic_limit_exceeded | å‚æ•°éªŒè¯ | âœ… é€šè¿‡ |
| test_get_stocks_daily_success | æ—¥çº¿æ•°æ® | âœ… é€šè¿‡ |
| test_get_kline_success | Kçº¿æ•°æ® | âœ… é€šè¿‡ |
| test_get_stocks_industries | è¡Œä¸šåˆ†ç±» | âœ… é€šè¿‡ |

---

## ğŸ”§ ä¿®å¤å»ºè®®

### ä¼˜å…ˆçº§1: ä¿®å¤Mock/Patchè·¯å¾„

å°†æ‰€æœ‰æµ‹è¯•ä¸­çš„patchè·¯å¾„ä»APIæ¨¡å—è·¯å¾„ä¿®æ”¹ä¸ºæœåŠ¡æ¨¡å—è·¯å¾„:

```python
# ä¿®æ”¹å‰
with patch("app.api.market.get_data_source_factory", ...):

# ä¿®æ”¹å
with patch("app.services.data_source_factory.get_data_source_factory", ...):
```

### ä¼˜å…ˆçº§2: ä¿®å¤APIè·¯ç”±è·¯å¾„

æ£€æŸ¥å®é™…çš„APIè·¯ç”±å®šä¹‰å¹¶æ›´æ–°æµ‹è¯•:

```python
# æ£€æŸ¥è·¯ç”±
grep -r "@router.get" app/api/trade/routes.py

# æ›´æ–°æµ‹è¯•
response = client.get("/api/trade/health")  # æ·»åŠ  /api å‰ç¼€
```

### ä¼˜å…ˆçº§3: æ·»åŠ è®¤è¯Mock

ä¸ºéœ€è¦è®¤è¯çš„APIæ·»åŠ mock:

```python
@patch("app.core.security.get_current_user")
def test_authenticated_endpoint(self, mock_auth, client):
    mock_auth.return_value = MagicMock(id=1, username="test")
    response = client.get("/api/strategy/definitions")
    assert response.status_code == 200
```

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥å·¥ä½œ

### é€‰é¡¹A: ä¿®å¤ç°æœ‰æµ‹è¯• (æ¨è)

1. **æ‰¹é‡ä¿®å¤patchè·¯å¾„** (1å°æ—¶)
   - æœç´¢æ›¿æ¢æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ä¸­çš„patchè·¯å¾„

2. **ä¿®å¤APIè·¯ç”±è·¯å¾„** (30åˆ†é’Ÿ)
   - æ£€æŸ¥å®é™…è·¯ç”±å®šä¹‰
   - æ›´æ–°æµ‹è¯•ä¸­çš„è·¯å¾„

3. **æ·»åŠ è®¤è¯Mock** (1å°æ—¶)
   - ä¸ºéœ€è¦è®¤è¯çš„APIæ·»åŠ mockè£…é¥°å™¨

### é€‰é¡¹B: åˆ›å»ºç®€åŒ–æµ‹è¯•

1. **åˆ›å»ºåŸºäºHTTPçš„é›†æˆæµ‹è¯•** (2å°æ—¶)
   - ä½¿ç”¨çœŸå®çš„HTTPè¯·æ±‚è€Œä¸æ˜¯mock
   - å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨

2. **ä½¿ç”¨TestClientè¦†ç›–é…ç½®** (1å°æ—¶)
   - ç¦ç”¨è®¤è¯ä¸­é—´ä»¶
   - ç®€åŒ–æµ‹è¯•é…ç½®

### é€‰é¡¹C: è¿›å…¥ä¸‹ä¸€é˜¶æ®µ

ç›´æ¥è¿›è¡Œ**æ€§èƒ½æµ‹è¯•**å’Œ**ä»£ç è´¨é‡æ£€æŸ¥**, ç¨åä¿®å¤å•å…ƒæµ‹è¯•ã€‚

---

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

æ ¹æ®TASK.mdé˜¶æ®µ3éªŒæ”¶æ ‡å‡†:

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰ | è¾¾æˆç‡ |
|------|------|------|--------|
| P0 APIå…¨éƒ¨å®ç° | 30ä¸ª | 47ä¸ª | 156% âœ… |
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | 80% | å¾…æµ‹ | â³ |
| åŠŸèƒ½æµ‹è¯•é€šè¿‡ç‡ | 100% | 14% (9/64) | ğŸ”„ |
| ä»£ç è´¨é‡è¯„åˆ† | 8.5+/10 | å¾…æµ‹ | â³ |
| APIå“åº”æ—¶é—´P95 | <200ms | å¾…æµ‹ | â³ |

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### æˆåŠŸè¦ç´ 

1. **ä½¿ç”¨FastAPI TestClient**: ç®€åŒ–æµ‹è¯•é…ç½®
2. **Pytest fixtures**: å¤ç”¨æµ‹è¯•ç»„ä»¶
3. **åˆ†å±‚æµ‹è¯•è®¾è®¡**: æŒ‰APIæ¨¡å—ç»„ç»‡æµ‹è¯•

### æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ

| æŒ‘æˆ˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| Mockè·¯å¾„å¤æ‚ | ä½¿ç”¨æ­£ç¡®çš„æ¨¡å—å¯¼å…¥è·¯å¾„ |
| è®¤è¯é˜»å¡æµ‹è¯• | Mockè®¤è¯ä¸­é—´ä»¶ |
| è·¯ç”±404é”™è¯¯ | æ£€æŸ¥å®é™…çš„è·¯ç”±å‰ç¼€ |
| æµ‹è¯•è¿è¡Œæ…¢(2åˆ†é’Ÿ) | ä¼˜åŒ–å¯¼å…¥å’Œfixture |

---

**æŠ¥å‘Šç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-12-30 23:55
**ç”Ÿæˆè€…**: Backend CLI (Claude Code)
