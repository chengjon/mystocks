# 前端路由优化 - Authentication Guard 启用任务方案

## 任务概述

**任务名称**: Authentication Guard 启用和完善
**优先级**: 高
**预计时间**: 3-4小时
**风险等级**: 中等（涉及用户认证流程）
**依赖项**: Pinia, Vue Router 4.x, 后端认证API

## 任务背景

当前前端应用虽然实现了完整的认证系统（包括Store、API、登录页面），但路由保护机制被禁用。所有用户都可以直接访问受保护的页面，这存在严重的安全风险。

目标：启用路由守卫，保护敏感页面，确保只有认证用户才能访问受保护的路由。

## 当前状态分析

### 已实现的认证系统
- ✅ **认证Store** (`stores/auth.js`): 完整的Pinia Store，包括登录、登出、token管理
- ✅ **认证API** (`api/index.js`): 完整的后端API调用
- ✅ **登录页面** (`views/Login.vue`): 用户界面
- ✅ **路由配置**: 部分路由已设置 `requiresAuth: false`
- ❌ **路由守卫**: 被注释掉，未启用

### 路由保护需求
根据路由配置分析，需要保护的页面包括：
- 仪表盘、分析、设置等主要功能页面
- 股票管理、投资组合等数据页面
- 策略管理、回测分析等高级功能

## 实施步骤

### 步骤1: 启用路由守卫
**目标**: 取消注释并启用认证路由守卫
**文件位置**: `web/frontend/src/router/index.ts`
**操作**:

```typescript
// 启用认证守卫
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()

  if (to.meta.requiresAuth !== false && !authStore.isAuthenticated) {
    // 需要登录但未登录，重定向到登录页
    next({ name: 'login', query: { redirect: to.fullPath } })
  } else if (to.name === 'login' && authStore.isAuthenticated) {
    // 已登录，访问登录页，重定向到首页
    next({ name: 'dashboard' })
  } else {
    next()
  }
})
```

**注意事项**:
- 确保 `useAuthStore` 已正确导入
- 保持重定向逻辑完整
- 测试认证状态检查

### 步骤2: 完善路由权限配置
**目标**: 为所有路由设置正确的认证要求
**操作**:

```typescript
// 公开路由 (不需要认证)
{
  path: '/login',
  meta: { requiresAuth: false }
}

// 受保护路由 (需要认证 - 默认)
{
  path: '/dashboard',
  meta: { requiresAuth: true }  // 或者省略，默认需要认证
}

// 明确标记的公开路由
{
  path: '/public-demo',
  meta: { requiresAuth: false }
}
```

**路由分类**:
- **公开路由**: 登录页、演示页面
- **受保护路由**: 所有业务功能页面
- **默认策略**: 未明确标记的路由需要认证

### 步骤3: 完善认证状态检查
**目标**: 在应用启动时检查用户认证状态
**文件位置**: `web/frontend/src/main.js` 或 `App.vue`
**操作**:

```javascript
// 在应用启动时检查认证状态
import { useAuthStore } from '@/stores/auth'

const authStore = useAuthStore()
await authStore.checkAuth()  // 验证token有效性
```

**注意事项**:
- 确保在路由守卫启用前执行
- 处理token过期的情况
- 避免阻塞应用启动

### 步骤4: 登录成功后的重定向
**目标**: 登录后自动跳转到用户原本要访问的页面
**文件位置**: `web/frontend/src/views/Login.vue`
**操作**:

```javascript
// 登录成功后处理重定向
const redirectPath = router.currentRoute.value.query.redirect || '/dashboard'
await router.push(redirectPath)
```

**注意事项**:
- 从URL查询参数获取重定向路径
- 验证重定向路径的安全性
- 设置默认重定向页面

### 步骤5: 处理认证失败的情况
**目标**: 优雅地处理认证失败和token过期
**操作**:
- 在API响应拦截器中处理401错误
- 清除本地认证状态
- 重定向到登录页面
- 保存当前路径用于登录后重定向

### 步骤6: 更新导航组件
**目标**: 根据认证状态显示不同的导航选项
**文件位置**: `web/frontend/src/layout/index.vue`
**操作**:

```vue
<!-- 根据认证状态显示内容 -->
<template v-if="authStore.isAuthenticated">
  <!-- 已登录用户的导航 -->
  <UserMenu />
</template>
<template v-else>
  <!-- 未登录用户的导航 -->
  <LoginButton />
</template>
```

## 测试验证

### 功能测试
- [ ] **未认证用户访问保护页面**: 应重定向到登录页
- [ ] **已认证用户访问登录页**: 应重定向到仪表盘
- [ ] **登录成功后重定向**: 应跳转到原本要访问的页面
- [ ] **Token过期处理**: 自动清除状态并重定向登录
- [ ] **页面刷新认证保持**: 刷新页面后仍保持登录状态

### 边界测试
- [ ] **直接访问保护路由URL**: 应重定向到登录页
- [ ] **恶意构造重定向URL**: 应验证安全性
- [ ] **多个标签页的认证状态**: 应保持同步
- [ ] **网络请求的认证头**: 自动添加Bearer token

### 用户体验测试
- [ ] **登录流程流畅性**: 无明显延迟或卡顿
- [ ] **重定向体验**: 用户理解跳转逻辑
- [ ] **错误提示友好性**: 认证失败有明确提示
- [ ] **状态保持稳定性**: 页面刷新后状态正确

## 风险评估和应对

### 风险1: 用户体验中断
**影响**: 启用认证后，未登录用户无法访问原有页面
**应对**:
- 在登录页显示友好的说明
- 提供演示账户或公开访问选项
- 逐步启用，允许临时公开访问

### 风险2: Token管理复杂性
**影响**: Token过期处理不当导致用户重复登录
**应对**:
- 实现自动token刷新
- 提供明确的过期提示
- 测试各种过期场景

### 风险3: 重定向逻辑错误
**影响**: 用户可能被重定向到错误页面
**应对**:
- 仔细验证重定向URL的安全性
- 提供默认重定向页面
- 记录重定向日志用于调试

## 验收标准

### 安全验收
- [ ] 所有敏感页面需要认证才能访问
- [ ] 未认证用户自动重定向到登录页
- [ ] API请求自动携带认证token
- [ ] Token过期后自动清理状态

### 功能验收
- [ ] 登录成功后正确重定向
- [ ] 登出功能正常工作
- [ ] 页面刷新保持认证状态
- [ ] 多个路由的权限控制正确

### 性能验收
- [ ] 路由守卫不影响页面加载性能
- [ ] 认证检查响应时间<100ms
- [ ] 内存泄漏检查通过

## 后续任务关联

**此任务完成后可以进行的优化**:
- 实现角色-based访问控制 (RBAC)
- 添加页面级别的权限控制
- 实现记住登录功能
- 优化认证错误处理

**依赖此任务的后续功能**:
- 用户会话管理
- 个性化设置保存
- 用户数据隔离
- 审计日志记录

---

*文档创建时间*: 2026-01-12
*预计完成时间*: 2026-01-12 (4小时内)
*负责人*: Claude Code
*审查人*: 项目维护者