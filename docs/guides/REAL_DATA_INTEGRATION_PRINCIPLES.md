# Realæ•°æ®å¯¹æ¥ - æ ¸å¿ƒåŸåˆ™ä¸æœ€ä½³å®è·µ

**åˆ¶å®šæ—¥æœŸ**: 2025-12-04
**é‡è¦æ€§**: ğŸ”´ CRITICAL - è¿™äº›åŸåˆ™å†³å®šäº†æ•´ä¸ªRealæ•°æ®å¯¹æ¥é¡¹ç›®çš„æˆè´¥
**æ ¸å¿ƒç†å¿µ**: å¹¶è¡Œå¼€å‘Realæ•°æ® + ä¿ç•™Mockçš„å®Œæ•´éš”ç¦» + é›¶é£é™©åˆ‡æ¢

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Real æ•°æ®å¯¹æ¥æ ¸å¿ƒåŸåˆ™ï¼ˆ4å¤§æ”¯æŸ±ï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1ï¸âƒ£ æ¶æ„éš”ç¦»                                             â”‚
â”‚     â””â”€ Mock ä¸ Real ä»£ç é›¶è€¦åˆ                           â”‚
â”‚     â””â”€ ç»Ÿä¸€å…¥å£ç‚¹æ§åˆ¶æ•°æ®æºåˆ‡æ¢                           â”‚
â”‚     â””â”€ ç‰©ç†éš”ç¦» + æ¸…æ™°è¾¹ç•Œæ ‡æ³¨                           â”‚
â”‚                                                         â”‚
â”‚  2ï¸âƒ£ å…¼å®¹ç°æœ‰ API                                        â”‚
â”‚     â””â”€ 100% å¤ç”¨ç°æœ‰æ¥å£å¥‘çº¦                             â”‚
â”‚     â””â”€ å…¥å‚/å‡ºå‚æ ¼å¼å®Œå…¨ä¸€è‡´                             â”‚
â”‚     â””â”€ ä»…æ›¿æ¢ "æ•°æ®æ¥æº"ï¼Œä¸ä¿®æ”¹æ¥å£                     â”‚
â”‚                                                         â”‚
â”‚  3ï¸âƒ£ å¤„ç† Real ç‰¹æ€§å·®å¼‚                                  â”‚
â”‚     â””â”€ å¼‚å¸¸åœºæ™¯å…¼å®¹ï¼ˆè¶…æ—¶ã€é”™è¯¯ã€ä¸ºç©ºï¼‰                  â”‚
â”‚     â””â”€ å¼‚æ­¥/åŒæ­¥å·®å¼‚é€‚é…                                â”‚
â”‚     â””â”€ æƒé™/é‰´æƒå·®å¼‚å¤„ç†                                â”‚
â”‚     â””â”€ æ€§èƒ½å·®å¼‚å…œåº•                                    â”‚
â”‚                                                         â”‚
â”‚  4ï¸âƒ£ å¹¶è¡Œå¼€å‘æµç¨‹                                        â”‚
â”‚     â””â”€ USE_MOCK å¼€å…³å•ä¸€èŒè´£                            â”‚
â”‚     â””â”€ Real ä»£ç ç‹¬ç«‹æäº¤                                â”‚
â”‚     â””â”€ æ°¸è¿œä¸åˆ é™¤ Mock ä»£ç                              â”‚
â”‚     â””â”€ æ•…éšœæ’æŸ¥æ—¶ä¿ç•™ Mock å›é€€èƒ½åŠ›                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ï¸âƒ£ æ¶æ„éš”ç¦»åŸåˆ™

### 1.1 æ ¸å¿ƒè¦æ±‚

#### âŒ é”™è¯¯åšæ³•ï¼ˆä¸¥ç¦ï¼‰
```python
# âŒ WRONG: Mock/Real é€»è¾‘æ··åœ¨æ¥å£é‡Œ
@router.get("/api/v1/stock/{symbol}/info")
async def get_stock_info(symbol: str):
    if os.getenv('USE_MOCK') == 'true':
        # Mock é€»è¾‘
        return {"symbol": symbol, "price": 100.0}
    else:
        # Real é€»è¾‘
        return await fetch_from_akshare(symbol)

# âŒ WRONG: åœ¨å¤šä¸ªåœ°æ–¹é‡å¤åˆ¤æ–­ USE_MOCK
if USE_MOCK:
    # ... 10è¡Œ Mock ä»£ç 
else:
    # ... 15è¡Œ Real ä»£ç 
```

#### âœ… æ­£ç¡®åšæ³•
```python
# âœ… CORRECT: ç»Ÿä¸€å…¥å£ç‚¹ï¼Œå·¥å‚æ¨¡å¼æ§åˆ¶
from app.core.data_source_factory import get_data_source

@router.get("/api/v1/stock/{symbol}/info")
async def get_stock_info(symbol: str):
    # ç»Ÿä¸€ä»å·¥å‚è·å–æ•°æ®æºï¼Œæ— éœ€å…³å¿ƒæ˜¯ Mock è¿˜æ˜¯ Real
    data_source = get_data_source()
    return await data_source.get_stock_info(symbol)
```

### 1.2 å®ç°ç­–ç•¥

#### æ•°æ®æºå·¥å‚æ¨¡å¼
```python
# app/core/data_source_factory.py

from enum import Enum
from typing import Union
import os

class DataSourceType(Enum):
    MOCK = "mock"
    REAL = "real"

class IDataSource(ABC):
    """æ•°æ®æºç»Ÿä¸€æ¥å£"""

    @abstractmethod
    async def get_stock_info(self, symbol: str) -> dict:
        pass

    @abstractmethod
    async def fetch_ohlcv(self, symbols: list, ...) -> dict:
        pass

class MockDataSource(IDataSource):
    """Mock æ•°æ®æºå®ç°"""
    # æ‰€æœ‰ Mock é€»è¾‘é›†ä¸­åœ¨è¿™ä¸ªç±»
    pass

class RealDataSource(IDataSource):
    """Real æ•°æ®æºå®ç°"""
    # æ‰€æœ‰ Real é€»è¾‘é›†ä¸­åœ¨è¿™ä¸ªç±»
    pass

# å…¨å±€å•ä¾‹ - ç»Ÿä¸€æ§åˆ¶åˆ‡æ¢å…¥å£
_current_source = None

def get_data_source() -> IDataSource:
    """è·å–å½“å‰æ•°æ®æº"""
    global _current_source

    if _current_source is None:
        use_mock = os.getenv('USE_MOCK', 'true').lower() == 'true'
        _current_source = MockDataSource() if use_mock else RealDataSource()

    return _current_source

def switch_data_source(source_type: DataSourceType):
    """æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æºï¼ˆç”¨äºæµ‹è¯•ï¼‰"""
    global _current_source
    _current_source = (
        MockDataSource() if source_type == DataSourceType.MOCK
        else RealDataSource()
    )
```

### 1.3 ä»£ç ç‰©ç†éš”ç¦»

```
app/
â”œâ”€â”€ api/                    # æ¥å£å±‚ï¼Œä¸æ•°æ®æºæ— å…³
â”‚   â””â”€â”€ stock.py
â”‚
â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘å±‚ï¼Œä½¿ç”¨å·¥å‚è·å–æ•°æ®æº
â”‚   â””â”€â”€ stock_service.py
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ data_source_factory.py  # ğŸ”‘ ç»Ÿä¸€å…¥å£ç‚¹
â”‚   â””â”€â”€ interfaces/
â”‚       â””â”€â”€ data_source.py      # æ•°æ®æºæ¥å£å®šä¹‰
â”‚
â””â”€â”€ data_sources/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ mock/
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ timeseries_mock.py  # Mock æ—¶åºæ•°æ®
    â”‚   â”œâ”€â”€ stock_mock.py       # Mock è‚¡ç¥¨æ•°æ®
    â”‚   â””â”€â”€ README.md           # Mock æ•°æ®è¯´æ˜
    â”‚
    â””â”€â”€ real/
        â”œâ”€â”€ __init__.py
        â”œâ”€â”€ akshare_adapter.py  # Real æ•°æ®æºé€‚é…
        â”œâ”€â”€ tushare_adapter.py  # Real æ•°æ®æºé€‚é…
        â””â”€â”€ README.md           # Real æ•°æ®æºè¯´æ˜
```

### 1.4 æ¸…æ™°è¾¹ç•Œæ ‡æ³¨

```python
# app/data_sources/mock/stock_mock.py

"""
=================================================================
ğŸ”´ MOCK DATA ONLY - DO NOT USE IN PRODUCTION
è¿™æ˜¯ä»…ç”¨äºå¼€å‘å’Œæµ‹è¯•çš„ Mock æ•°æ®æ¨¡å—

å…³é”®è¯´æ˜:
1. æ‰€æœ‰æ•°æ®éƒ½æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œä¸åæ˜ çœŸå®å¸‚åœº
2. ä¸Šçº¿å‰å¿…é¡»åˆ‡æ¢åˆ° Real æ•°æ®æºï¼ˆUSE_MOCK=falseï¼‰
3. è¿™ä¸ªæ–‡ä»¶åœ¨ Mock æ¨¡å¼ä¸‹çº¿æ—¶å¯ä»¥åˆ é™¤ï¼Œä½†å¼€å‘æœŸé—´å¿…é¡»ä¿ç•™
4. ä¸å…è®¸åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ç›´æ¥å¯¼å…¥æ­¤æ¨¡å—
=================================================================
"""

class StockMockDataSource:
    """Mock è‚¡ç¥¨æ•°æ®æº"""

    # æ‰€æœ‰ Mock é€»è¾‘éƒ½åœ¨è¿™é‡Œï¼Œä¸ä¼šæ±¡æŸ“å…¶ä»–ä»£ç 

    async def get_stock_info(self, symbol: str) -> dict:
        """è¿”å› Mock è‚¡ç¥¨ä¿¡æ¯"""
        return {
            "symbol": symbol,
            "name": f"Mock {symbol}",
            "price": 100.0,
            "source": "MOCK"  # ğŸ”‘ æ ‡è®°æ•°æ®æ¥æº
        }
```

---

## 2ï¸âƒ£ å…¼å®¹ç°æœ‰APIåŸåˆ™

### 2.1 API å¥‘çº¦ä¸å˜

#### çº¦æŸæ¡ä»¶
- âœ… è¯·æ±‚å‚æ•°æ ¼å¼å®Œå…¨ç›¸åŒ
- âœ… å“åº”å­—æ®µå®Œå…¨ç›¸åŒ
- âœ… HTTP çŠ¶æ€ç å®Œå…¨ç›¸åŒ
- âœ… é”™è¯¯æ¶ˆæ¯æ ¼å¼å®Œå…¨ç›¸åŒ
- âŒ ä¸ä¿®æ”¹æ¥å£è·¯å¾„
- âŒ ä¸ä¿®æ”¹è¯·æ±‚æ–¹æ³•
- âŒ ä¸ä¿®æ”¹å“åº”ç»“æ„

#### å®ä¾‹å¯¹æ¯”

```python
# ==================== Mock æ¨¡å¼ ====================
# è¯·æ±‚
GET /api/v1/stock/AAPL/info
Authorization: Bearer token

# å“åº” (200 OK)
{
    "code": "SUCCESS",
    "message": "Stock info fetched successfully",
    "data": {
        "symbol": "AAPL",
        "name": "Apple Inc",
        "price": 150.25,
        "change": 0.5,
        "change_percent": 0.33,
        "market_cap": 2500000000000,
        "pe_ratio": 25.5
    },
    "timestamp": "2025-12-04T10:00:00Z"
}

# ==================== Real æ¨¡å¼ ====================
# å®Œå…¨ç›¸åŒçš„è¯·æ±‚
GET /api/v1/stock/AAPL/info
Authorization: Bearer token

# å®Œå…¨ç›¸åŒçš„å“åº”æ ¼å¼ï¼ˆä»…æ•°æ®æ¥æºä¸åŒï¼‰
{
    "code": "SUCCESS",
    "message": "Stock info fetched successfully",
    "data": {
        "symbol": "AAPL",
        "name": "Apple Inc",
        "price": 150.35,      # æ¥è‡ªçœŸå®å¸‚åœº
        "change": 0.6,         # æ¥è‡ªçœŸå®å¸‚åœº
        "change_percent": 0.40,
        "market_cap": 2510000000000,
        "pe_ratio": 25.8
    },
    "timestamp": "2025-12-04T10:00:00Z"
}
```

### 2.2 æ•°æ®é€‚é…å±‚

```python
# app/data_sources/real/adapters/response_adapter.py

"""
Real æ•°æ®æºå“åº”é€‚é…å±‚
å°† Real API çš„ä¸åŒå“åº”æ ¼å¼é€‚é…ä¸ºç»Ÿä¸€çš„ API æ ¼å¼
"""

class ResponseAdapter:
    """å“åº”é€‚é…å™¨ - å°† Real æ•°æ®è½¬æ¢ä¸º API æ ¼å¼"""

    @staticmethod
    def adapt_stock_info(real_data: dict) -> dict:
        """
        å°† Akshare å“åº”é€‚é…ä¸º API æ ¼å¼

        Akshare æ ¼å¼:
        {
            "ts_code": "000001.SZ",
            "name": "å¹³å®‰é“¶è¡Œ",
            "close": 10.5
        }

        API æ ¼å¼:
        {
            "symbol": "000001",
            "name": "å¹³å®‰é“¶è¡Œ",
            "price": 10.5
        }
        """

        # å­—æ®µæ˜ å°„
        adapted = {
            "symbol": real_data.get("ts_code", "").split(".")[0],
            "name": real_data.get("name", ""),
            "price": float(real_data.get("close", 0)),
            # ... å…¶ä»–å­—æ®µæ˜ å°„
        }

        # æ•°æ®éªŒè¯
        required_fields = ["symbol", "name", "price"]
        for field in required_fields:
            if not adapted.get(field):
                raise DataValidationError(f"Missing required field: {field}")

        return adapted
```

### 2.3 é”™è¯¯å¤„ç†ä¸€è‡´æ€§

```python
# app/data_sources/real/error_handler.py

"""
Real æ•°æ®æºé”™è¯¯å¤„ç† - ç¡®ä¿é”™è¯¯æ ¼å¼ä¸ API ä¸€è‡´
"""

def handle_real_api_error(error: Exception) -> dict:
    """
    å°† Real API çš„é”™è¯¯è½¬æ¢ä¸ºæ ‡å‡† API é”™è¯¯æ ¼å¼
    """

    # è·å–é”™è¯¯ä¿¡æ¯
    error_msg = str(error)

    # æ˜ å°„åˆ°æ ‡å‡†é”™è¯¯ç 
    error_code_map = {
        "timeout": "TIMEOUT_ERROR",
        "connection": "CONNECTION_ERROR",
        "authentication": "AUTH_ERROR",
        "not_found": "NOT_FOUND",
        "rate_limit": "RATE_LIMIT_EXCEEDED"
    }

    # ç¡®å®šé”™è¯¯ç 
    api_error_code = "DATA_FETCH_ERROR"  # é»˜è®¤
    for keyword, code in error_code_map.items():
        if keyword in error_msg.lower():
            api_error_code = code
            break

    # è¿”å›æ ‡å‡†æ ¼å¼çš„é”™è¯¯å“åº”
    return {
        "code": api_error_code,
        "message": f"Failed to fetch data: {error_msg}",
        "data": None
    }
```

---

## 3ï¸âƒ£ å¤„ç†Realç‰¹æ€§å·®å¼‚åŸåˆ™

### 3.1 å¼‚å¸¸åœºæ™¯å…¼å®¹

#### ç½‘ç»œè¶…æ—¶
```python
# app/data_sources/real/resilience.py

class TimeoutHandler:
    """å¤„ç† Real API è¶…æ—¶"""

    def __init__(self, timeout_sec: int = 30):
        self.timeout_sec = timeout_sec

    async def fetch_with_timeout(self, api_call):
        """å¸¦è¶…æ—¶çš„ API è°ƒç”¨"""
        try:
            return await asyncio.wait_for(api_call, timeout=self.timeout_sec)
        except asyncio.TimeoutError:
            logger.warning(f"Real API timeout after {self.timeout_sec}s")

            # é™çº§ç­–ç•¥1: è¿”å›ç¼“å­˜æ•°æ®
            cached = await self.get_cached_data()
            if cached:
                return cached

            # é™çº§ç­–ç•¥2: è¿”å› Mock æ•°æ®
            return await self.get_mock_data()

            # é™çº§ç­–ç•¥3: è¿”å›æ ‡å‡†é”™è¯¯
            # raise TimeoutError("API unavailable, using fallback")
```

#### æ¥å£æŠ¥é”™å¤„ç†
```python
# app/data_sources/real/error_recovery.py

class ErrorRecovery:
    """Real API é”™è¯¯æ¢å¤"""

    async def fetch_with_retry(self, fetch_func, max_retries=3):
        """å¸¦é‡è¯•çš„ API è°ƒç”¨"""

        for attempt in range(max_retries):
            try:
                return await fetch_func()
            except APIError as e:
                logger.error(f"Attempt {attempt + 1} failed: {e}")

                if attempt < max_retries - 1:
                    # æŒ‡æ•°é€€é¿é‡è¯•
                    await asyncio.sleep(2 ** attempt)
                    continue

                # æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é™çº§
                logger.warning(f"All {max_retries} attempts failed, using fallback")
                return await self.fallback_fetch()

    async def fallback_fetch(self):
        """é™çº§ç­–ç•¥"""
        # 1. å°è¯•ç¼“å­˜
        cached = await self.get_cached_data()
        if cached:
            return cached

        # 2. ä½¿ç”¨ Mock æ•°æ®
        return await self.get_mock_data()
```

#### æ•°æ®ä¸ºç©ºå¤„ç†
```python
# app/data_sources/real/data_validation.py

class DataValidator:
    """æ•°æ®æœ‰æ•ˆæ€§éªŒè¯"""

    def validate_response(self, data: dict, required_fields: list) -> bool:
        """éªŒè¯å“åº”æ•°æ®"""

        # æ£€æŸ¥å¿…éœ€å­—æ®µ
        for field in required_fields:
            if not data.get(field):
                logger.warning(f"Missing required field: {field}")
                return False

        # æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
        if len(data) == 0:
            logger.warning("Empty data response")
            return False

        # æ£€æŸ¥æ•°æ®åˆç†æ€§ï¼ˆå¦‚ä»·æ ¼ä¸ºè´Ÿï¼‰
        if isinstance(data.get("price"), (int, float)) and data["price"] < 0:
            logger.warning(f"Invalid price: {data['price']}")
            return False

        return True

    def get_safe_response(self, real_data: dict, fallback_data: dict) -> dict:
        """è·å–å®‰å…¨çš„å“åº”"""

        if self.validate_response(real_data, ["symbol", "price"]):
            return real_data
        else:
            logger.info("Using fallback data")
            return fallback_data
```

### 3.2 å¼‚æ­¥/åŒæ­¥é€‚é…

```python
# app/data_sources/real/async_adapter.py

class AsyncSyncAdapter:
    """å¼‚æ­¥/åŒæ­¥é€‚é…å±‚"""

    def __init__(self):
        self.event_loop = asyncio.new_event_loop()

    def sync_fetch(self, async_func, *args, **kwargs):
        """
        å°†å¼‚æ­¥å‡½æ•°é€‚é…ä¸ºåŒæ­¥è°ƒç”¨
        ç”¨äºä¸ Mock çš„åŒæ­¥æ¥å£å…¼å®¹
        """
        return self.event_loop.run_until_complete(
            async_func(*args, **kwargs)
        )
```

### 3.3 æƒé™/é‰´æƒå·®å¼‚

```python
# app/data_sources/real/authentication.py

class RealAPIAuth:
    """Real API é‰´æƒå¤„ç†"""

    def __init__(self, api_key: str):
        self.api_key = api_key

    def get_headers(self) -> dict:
        """è·å–åŒ…å«é‰´æƒçš„è¯·æ±‚å¤´"""
        return {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }

    async def fetch_with_auth(self, url: str, params: dict):
        """å¸¦é‰´æƒçš„ API è°ƒç”¨"""
        try:
            headers = self.get_headers()
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    url,
                    params=params,
                    headers=headers,
                    timeout=30
                ) as response:
                    if response.status == 401:
                        raise AuthenticationError("Invalid API key")

                    return await response.json()
        except AuthenticationError as e:
            logger.error(f"Authentication failed: {e}")
            # è¿”å›æ ‡å‡†é”™è¯¯æ ¼å¼
            return {"code": "AUTH_ERROR", "message": str(e), "data": None}
```

### 3.4 æ€§èƒ½å·®å¼‚å…œåº•

```python
# app/data_sources/real/performance_handling.py

class PerformanceHandler:
    """å¤„ç† Real API æ€§èƒ½å·®å¼‚"""

    def __init__(self, cache_ttl: int = 3600):
        self.cache = {}
        self.cache_ttl = cache_ttl

    async def fetch_with_cache(self, key: str, fetch_func, use_cache=True):
        """å¸¦ç¼“å­˜çš„ API è°ƒç”¨"""

        # æ£€æŸ¥ç¼“å­˜
        if use_cache and key in self.cache:
            cached_data, timestamp = self.cache[key]
            if time.time() - timestamp < self.cache_ttl:
                logger.info(f"Using cached data for {key}")
                return cached_data

        # è·å–æ–°æ•°æ®
        try:
            data = await fetch_func()
            # ç¼“å­˜æ•°æ®
            self.cache[key] = (data, time.time())
            return data
        except Exception as e:
            logger.warning(f"Fetch failed: {e}, trying cache")

            # å¦‚æœè·å–å¤±è´¥ï¼Œè¿”å›è¿‡æœŸç¼“å­˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if key in self.cache:
                cached_data, _ = self.cache[key]
                logger.info(f"Using expired cache for {key}")
                return cached_data

            # å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œè¿”å›é”™è¯¯
            raise
```

---

## 4ï¸âƒ£ å¹¶è¡Œå¼€å‘æµç¨‹åŸåˆ™

### 4.1 å¼€å‘æµç¨‹

```
å¼€å‘å‘¨æœŸ:

Mock æ¨¡å¼ (USE_MOCK=true)
  â”œâ”€ å‘¨æœŸ1: Real ä»£ç å¼€å‘ (branch: feature/real-data-*)
  â”‚  â”œâ”€ å®ç° Real æ•°æ®æºé€‚é…
  â”‚  â”œâ”€ ç¼–å†™ Real ç›¸å…³æµ‹è¯•
  â”‚  â””â”€ Real ä»£ç å•ç‹¬æäº¤ (git commit)
  â”‚
  â”œâ”€ å‘¨æœŸ2: æœ¬åœ°éªŒè¯
  â”‚  â”œâ”€ USE_MOCK=false åˆ‡æ¢åˆ° Real æ¨¡å¼
  â”‚  â”œâ”€ éªŒè¯ Real æ•°æ®æ­£å¸¸å·¥ä½œ
  â”‚  â”œâ”€ å¯¹æ¯” Mock ä¸ Real çš„å·®å¼‚
  â”‚  â””â”€ ä¿®å¤å‘ç°çš„é—®é¢˜
  â”‚
  â””â”€ å‘¨æœŸ3: é›†æˆåˆ° Mock æ¨¡å¼
     â”œâ”€ USE_MOCK=true å›åˆ° Mock æ¨¡å¼
     â”œâ”€ éªŒè¯ Mock ä»ç„¶æ­£å¸¸å·¥ä½œ
     â”œâ”€ Real ä»£ç ä¸å½±å“ Mock
     â””â”€ æäº¤ (Ready for Production)
```

### 4.2 USE_MOCK å¼€å…³çš„å•ä¸€èŒè´£

```python
# app/core/config.py

import os

class Config:
    """å…¨å±€é…ç½®"""

    # ğŸ”‘ å•ä¸€èŒè´£: ä»…ç”¨äºæ§åˆ¶æ•°æ®æºåˆ‡æ¢
    USE_MOCK = os.getenv('USE_MOCK', 'true').lower() == 'true'

    # âŒ ä¸¥ç¦æ·»åŠ å…¶ä»–ç”¨é€”çš„åˆ¤æ–­
    # ä¸å…è®¸:
    # if USE_MOCK:
    #     LOG_LEVEL = 'DEBUG'
    # else:
    #     LOG_LEVEL = 'INFO'
```

### 4.3 ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ

#### åˆ†æ”¯å‘½å
```bash
# Real æ•°æ®ç›¸å…³å¼€å‘
git checkout -b feature/real-data-akshare
git checkout -b feature/real-data-error-handling
git checkout -b feature/real-data-caching

# ä¿®å¤ Real ç›¸å…³é—®é¢˜
git checkout -b fix/real-data-timeout-handling
git checkout -b fix/real-data-validation
```

#### æäº¤æ¶ˆæ¯è§„èŒƒ
```bash
# Real æ•°æ®ç›¸å…³æäº¤éœ€è¦æ˜ç¡®æ ‡æ³¨
git commit -m "feat(real-data): implement Akshare data source adapter"
git commit -m "feat(real-data): add error recovery for API timeouts"
git commit -m "test(real-data): write integration tests for Real mode"

# ä¸å…è®¸å°† Real å’Œ Mock æ”¹åŠ¨æ··åœ¨ä¸€èµ·
âŒ git commit -m "feat: add real data and fix mock bug"
âœ… git commit -m "feat(real-data): add Akshare adapter"
   git commit -m "fix(mock): fix mock data generation"
```

### 4.4 æ°¸ä¸åˆ é™¤Mockä»£ç 

```python
# âŒ é”™è¯¯: å³ä½¿ Real å®Œæˆä¹Ÿåˆ é™¤ Mock
git rm -r app/data_sources/mock/  # ä¸¥ç¦!

# âœ… æ­£ç¡®: ä¿ç•™ Mock ä»£ç ï¼Œæ°¸è¿œä¸åˆ é™¤
# ä¿ç•™åŸå› :
# 1. æ•…éšœæ—¶å¯å¿«é€Ÿå›é€€
# 2. æ–°åŠŸèƒ½å¼€å‘æ—¶å¯ç”¨ Mock æµ‹è¯•
# 3. CI/CD æµç¨‹ä¸­å¯ç”¨ Mock éªŒè¯
# 4. å†å²å‚è€ƒå’Œæ–‡æ¡£ä»·å€¼
```

### 4.5 æœ¬åœ°å¼€å‘å·¥ä½œæµ

```bash
# 1ï¸âƒ£ å¼€å‘ç¯å¢ƒé…ç½® (ä¿ç•™ Mock å¼€å…³)
cat > .env.local << 'EOF'
USE_MOCK=true          # å¼€å‘æ—¶é»˜è®¤ä½¿ç”¨ Mock
AKSHARE_ENABLED=false  # Real æ•°æ®æºå…³é—­
TUSHARE_ENABLED=false
EOF

# 2ï¸âƒ£ å¼€å‘ Real ä»£ç 
# - ç¼–å†™ Real æ•°æ®æºé€‚é…
# - ç¼–å†™ç›¸å…³æµ‹è¯•
# - Mock æ¨¡å¼ä¸‹éªŒè¯ä¸å½±å“ç°æœ‰åŠŸèƒ½

# 3ï¸âƒ£ åˆ‡æ¢åˆ° Real æ¨¡å¼éªŒè¯ (æœ¬åœ°æµ‹è¯•)
cat > .env.local << 'EOF'
USE_MOCK=false         # ä¸´æ—¶åˆ‡æ¢åˆ° Real
AKSHARE_ENABLED=true   # å¯ç”¨ Real æ•°æ®æº
TUSHARE_ENABLED=true
EOF

# è¿è¡Œæµ‹è¯•éªŒè¯ Real æ•°æ®
pytest tests/ -v

# 4ï¸âƒ£ åˆ‡å› Mock æ¨¡å¼ (å†æ¬¡ç¡®è®¤)
cat > .env.local << 'EOF'
USE_MOCK=true
AKSHARE_ENABLED=false
TUSHARE_ENABLED=false
EOF

# 5ï¸âƒ£ æäº¤ä»£ç 
git add -A
git commit -m "feat(real-data): implement data source adapter"
git push origin feature/real-data-*
```

---

## ğŸ“‹ ä¿è¯ Real ä¸ API æ•°æ®å¯¹é½çš„æ–¹æ¡ˆ

### 1. å‰ç½®: æ˜ç¡®æ•°æ®å¥‘çº¦åŸºå‡†

```python
# docs/DATA_CONTRACT.md

"""
API æ•°æ®å¥‘çº¦æ–‡æ¡£

æ‰€æœ‰æ¥å£çš„å‡ºå‚æ ¼å¼åŸºäº Mock æ•°æ®ç”Ÿæˆçš„æ­¤å¥‘çº¦
Real æ•°æ®å¿…é¡»å®Œå…¨ç¬¦åˆæ­¤å¥‘çº¦

ç¤ºä¾‹: /api/v1/stock/{symbol}/info

æ¨¡æ‹Ÿæ•°æ®æ ¼å¼:
{
    "code": "SUCCESS",          # çŠ¶æ€ç (å¿…éœ€)
    "message": "...",           # æ¶ˆæ¯(å¿…éœ€)
    "data": {
        "symbol": "AAPL",       # è‚¡ç¥¨ä»£ç (å¿…éœ€, string)
        "name": "Apple Inc",    # å…¬å¸åç§°(å¿…éœ€, string)
        "price": 150.25,        # ç°ä»·(å¿…éœ€, float)
        "change": 0.5,          # æ¶¨è·Œ(å¿…éœ€, float)
        "change_percent": 0.33, # æ¶¨è·Œ%(å¿…éœ€, float)
        "market_cap": 2.5e12,   # å¸‚å€¼(å¿…éœ€, float)
        "pe_ratio": 25.5        # PE(å¯é€‰, float)
    },
    "timestamp": "2025-12-04T10:00:00Z"
}

Real æ•°æ®å¿…é¡»:
âœ… è¿”å›ç›¸åŒçš„å­—æ®µ
âœ… å­—æ®µç±»å‹å®Œå…¨ä¸€è‡´
âœ… å¿…éœ€å­—æ®µéç©º
âœ… å¯é€‰å­—æ®µå…è®¸ç¼ºå¤±(ç”¨ None/null)
âœ… ä½¿ç”¨ç›¸åŒçš„å‘½åè§„èŒƒ

Real ä¸ Mock å·®å¼‚å…è®¸:
âœ… å­—æ®µå€¼ä¸åŒï¼ˆæ¥è‡ªä¸åŒæ•°æ®æºï¼‰
âœ… æ—¶é—´æˆ³æ›´æ–°åˆ°æœ€æ–°
âœ… éƒ¨åˆ†å­—æ®µå¯èƒ½ç¼ºå¤±ï¼ˆç”¨é»˜è®¤å€¼æ›¿ä»£ï¼‰
"""
```

### 2. å¼€å‘ä¸­: å¤šå±‚æ ¡éªŒ

#### å•å…ƒæµ‹è¯•æ ¡éªŒ
```python
# tests/test_data_source_alignment.py

def test_real_vs_mock_structure():
    """éªŒè¯ Real ä¸ Mock çš„æ•°æ®ç»“æ„ä¸€è‡´"""

    # è·å– Mock æ•°æ®
    mock_source = MockDataSource()
    mock_data = mock_source.get_stock_info("AAPL")

    # è·å– Real æ•°æ®
    real_source = RealDataSource()
    real_data = real_source.get_stock_info("AAPL")

    # æ¯”è¾ƒå­—æ®µ
    mock_fields = set(mock_data["data"].keys())
    real_fields = set(real_data["data"].keys())

    # Real å¿…é¡»åŒ…å«æ‰€æœ‰ Mock çš„å¿…éœ€å­—æ®µ
    required_fields = {"symbol", "name", "price", "change", "change_percent"}
    assert required_fields.issubset(real_fields), \
        f"Missing fields in Real: {required_fields - real_fields}"

    # æ¯”è¾ƒå­—æ®µç±»å‹
    for field in required_fields:
        mock_type = type(mock_data["data"][field])
        real_type = type(real_data["data"][field])
        assert mock_type == real_type, \
            f"Type mismatch for {field}: Mock={mock_type}, Real={real_type}"
```

#### é›†æˆæµ‹è¯•æ ¡éªŒ
```python
# tests/test_api_response_alignment.py

def test_api_response_same_in_mock_and_real():
    """éªŒè¯ API å“åº”æ ¼å¼åœ¨ Mock å’Œ Real æ¨¡å¼ä¸‹ä¸€è‡´"""

    client = TestClient(app)

    # 1. Mock æ¨¡å¼è¯·æ±‚
    os.environ['USE_MOCK'] = 'true'
    mock_response = client.get("/api/v1/stock/AAPL/info")
    mock_data = mock_response.json()

    # 2. Real æ¨¡å¼è¯·æ±‚
    os.environ['USE_MOCK'] = 'false'
    real_response = client.get("/api/v1/stock/AAPL/info")
    real_data = real_response.json()

    # 3. æ¯”è¾ƒå“åº”ç»“æ„
    # é¡¶çº§å­—æ®µå¿…é¡»ç›¸åŒ
    assert set(mock_data.keys()) == set(real_data.keys()), \
        f"Response structure mismatch"

    # data å­—æ®µç»“æ„å¿…é¡»ç›¸åŒ
    mock_data_fields = set(mock_data["data"].keys())
    real_data_fields = set(real_data["data"].keys())
    assert mock_data_fields == real_data_fields, \
        f"Data field mismatch: {mock_data_fields ^ real_data_fields}"

    # æ¢å¤åˆ° Mock æ¨¡å¼
    os.environ['USE_MOCK'] = 'true'
```

### 3. è‡ªåŠ¨åŒ–ä¿éšœ: CI/CD é›†æˆ

```yaml
# .github/workflows/data-alignment-check.yml

name: Data Alignment Check

on: [push, pull_request]

jobs:
  data-alignment:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Run Mock vs Real validation
        run: |
          pytest tests/test_data_source_alignment.py -v
          pytest tests/test_api_response_alignment.py -v

      - name: Generate alignment report
        run: |
          python scripts/generate_alignment_report.py

      - name: Upload report
        uses: actions/upload-artifact@v2
        with:
          name: alignment-report
          path: reports/alignment_report.json
```

### 4. å¼‚å¸¸å…œåº•: é”™è¯¯å¤„ç†

```python
# app/data_sources/real/error_standardization.py

class ErrorStandardizer:
    """ç¡®ä¿é”™è¯¯æ ¼å¼ä¸ API æ ‡å‡†ä¸€è‡´"""

    STANDARD_ERROR_FORMAT = {
        "code": "ERROR_CODE",
        "message": "Human readable message",
        "data": None
    }

    @staticmethod
    def standardize_error(error: Exception) -> dict:
        """å°†ä»»ä½•é”™è¯¯è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼"""

        error_code = "DATA_FETCH_ERROR"  # é»˜è®¤é”™è¯¯ç 
        error_msg = str(error)

        # æ ¹æ®é”™è¯¯ç±»å‹æ˜ å°„åˆ°æ ‡å‡†é”™è¯¯ç 
        error_mapping = {
            TimeoutError: "TIMEOUT_ERROR",
            ConnectionError: "CONNECTION_ERROR",
            ValueError: "VALIDATION_ERROR",
            AuthenticationError: "AUTH_ERROR",
            RateLimitError: "RATE_LIMIT_EXCEEDED"
        }

        for exc_type, code in error_mapping.items():
            if isinstance(error, exc_type):
                error_code = code
                break

        # è¿”å›æ ‡å‡†åŒ–é”™è¯¯å“åº”
        return {
            "code": error_code,
            "message": error_msg,
            "data": None
        }
```

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨å¯åŠ¨ Real æ•°æ®å¯¹æ¥ä¹‹å‰ï¼Œç¡®ä¿æ‰€æœ‰è¿™äº›æ£€æŸ¥éƒ½é€šè¿‡ï¼š

### æ¶æ„éš”ç¦»
- [ ] æ•°æ®æºå·¥å‚å·²å®ç°ï¼ˆ`data_source_factory.py`ï¼‰
- [ ] Mock å’Œ Real ä»£ç ç‰©ç†éš”ç¦»åœ¨ä¸åŒç›®å½•
- [ ] æ¥å£éƒ½é€šè¿‡å·¥å‚è·å–æ•°æ®æºï¼Œæ— é›¶æ•£ if-else
- [ ] æ‰€æœ‰ Mock ä»£ç æœ‰æ¸…æ™°çš„è¾¹ç•Œæ³¨é‡Š

### API å…¼å®¹æ€§
- [ ] æ•°æ®å¥‘çº¦æ–‡æ¡£å·²å‡†å¤‡ï¼ˆ`DATA_CONTRACT.md`ï¼‰
- [ ] Real æ•°æ®é€‚é…å±‚å·²å®ç°ï¼ˆresponse adapterï¼‰
- [ ] é”™è¯¯å¤„ç†æ ¼å¼ä¸ API æ ‡å‡†ä¸€è‡´
- [ ] æµ‹è¯•è¦†ç›– Mock vs Real æ•°æ®æ ¼å¼

### Real ç‰¹æ€§å¤„ç†
- [ ] è¶…æ—¶å¤„ç†å·²å®ç°
- [ ] é”™è¯¯æ¢å¤ï¼ˆé‡è¯•+é™çº§ï¼‰å·²å®ç°
- [ ] æ•°æ®éªŒè¯å±‚å·²å®ç°
- [ ] ç¼“å­˜ç­–ç•¥å·²ç¡®å®š

### å¼€å‘æµç¨‹
- [ ] åˆ†æ”¯å‘½åè§„èŒƒå®šä¹‰
- [ ] æäº¤æ¶ˆæ¯è§„èŒƒå®šä¹‰
- [ ] USE_MOCK å¼€å…³åªç”¨äºæ•°æ®æºåˆ‡æ¢
- [ ] Mock ä»£ç åˆ é™¤æ¸…å•å·²ç¦æ­¢

### æµ‹è¯•å’ŒéªŒè¯
- [ ] å•å…ƒæµ‹è¯•éªŒè¯æ•°æ®ç»“æ„
- [ ] é›†æˆæµ‹è¯•éªŒè¯ API å“åº”
- [ ] CI/CD pipeline é…ç½®äº†å¯¹é½æ£€æŸ¥
- [ ] æ‰‹åŠ¨æµ‹è¯•æµç¨‹æ–‡æ¡£åŒ–

---

## ğŸ¯ ç«‹å³è¡ŒåŠ¨

1. **åˆ¶å®šå›¢é˜Ÿè§„èŒƒ**
   - ç¡®è®¤è¿™äº›åŸåˆ™
   - åˆ¶å®šå›¢é˜Ÿå¼€å‘åè®®
   - è¿›è¡ŒæŠ€æœ¯åŸ¹è®­

2. **å»ºç«‹åŸºç¡€è®¾æ–½**
   - å®ç°æ•°æ®æºå·¥å‚
   - å‡†å¤‡æ•°æ®å¥‘çº¦æ–‡æ¡£
   - é…ç½® CI/CD æµç¨‹

3. **å¯åŠ¨å¼€å‘**
   - ç¬¬ä¸€é˜¶æ®µ: å®ç° Real æ•°æ®æºé€‚é…
   - ç¬¬äºŒé˜¶æ®µ: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé™çº§
   - ç¬¬ä¸‰é˜¶æ®µ: å……åˆ†çš„æµ‹è¯•éªŒè¯

4. **æŒç»­ç›‘æ§**
   - å®šæœŸæ£€æŸ¥ Mock/Real å¯¹é½
   - æ”¶é›† Real æ•°æ®çš„é—®é¢˜åé¦ˆ
   - æŒç»­ä¼˜åŒ–é™çº§ç­–ç•¥

---

**å…³é”®è®°ä½**:
ğŸ”‘ **Mock ä¸ Real å®Œå…¨éš”ç¦»ï¼Œé€šè¿‡å·¥å‚æ¨¡å¼ç»Ÿä¸€æ§åˆ¶**
ğŸ”‘ **API å¥‘çº¦100%ä¸å˜ï¼Œä»…æ›¿æ¢æ•°æ®æ¥æº**
ğŸ”‘ **å¹¶è¡Œå¼€å‘ï¼Œæ°¸è¿œä¿ç•™ Mock å›é€€èƒ½åŠ›**

*æœ€åæ›´æ–°: 2025-12-04*
