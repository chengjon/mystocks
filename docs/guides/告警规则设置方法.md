# MyStocks 告警规则设置方法

## 概述

本文档记录了MyStocks项目中Prometheus告警规则的完整设置过程，包括遇到的坑点和最终解决方案。

## 项目背景

**Phase 7: 生产部署与监控**
Week 1 Day 7 任务：配置关键告警规则

- Prometheus ✅ 已安装 (localhost:9090)
- Grafana ✅ 已安装 (192.168.123.104:3000)
- 后端服务 ✅ 运行中 (localhost:8000/metrics)
- 交易信号监控指标 ✅ 已添加 (37个指标)

## 告警规则设计

### 规则分类

设计了3个告警规则组，共19条告警规则：

#### 1. trading_signals_alerts (12个规则)
- **信号准确度告警**:
  - `TradingSignalAccuracyLow`: 信号准确度 < 60% (警告)
  - `TradingSignalAccuracyCritical`: 信号准确度 < 40% (严重)
- **策略健康状态**:
  - `StrategyUnhealthy`: 策略状态异常 (严重)
- **信号生成监控**:
  - `SignalGenerationRateLow`: 生成速率 < 0.1/秒 (警告)
  - `SignalLatencyHigh`: 95%延迟 > 30秒 (警告)
  - `SignalLatencyCritical`: 95%延迟 > 60秒 (严重)
- **信号数量管理**:
  - `ActiveSignalsTooMany`: 活跃信号 > 100个 (警告)
  - `ActiveSignalsZero`: 10分钟无活跃信号 (警告)
- **信号质量**:
  - `SignalSuccessRateLow`: 成功率 < 50% (警告)
- **基础设施监控**:
  - `BackendServiceDown`: 后端服务不可用 (严重)
  - `DatabaseConnectionsHigh`: 数据库连接使用率 > 90% (警告)
  - `DatabaseConnectionsZero`: 数据库连接为零 (严重)

#### 2. system_resources_alerts (4个规则)
- **CPU使用率**:
  - `HighCPUUsage`: CPU使用率 > 80% (警告)
  - `CriticalCPUUsage`: CPU使用率 > 95% (严重)
- **内存使用**:
  - `HighMemoryUsage`: 内存使用 > 2GB (警告)
  - `CriticalMemoryUsage`: 内存使用 > 4GB (严重)

#### 3. trading_performance_alerts (3个规则)
- **API性能**:
  - `HighHTTPLatency`: 95% HTTP响应时间 > 5秒 (警告)
- **缓存性能**:
  - `LowCacheHitRate`: 缓存命中率 < 70% (警告)
- **连接状态**:
  - `WebSocketConnectionsZero`: 无活跃WebSocket连接 (信息)

## 实施过程

### 文件创建

#### 1. 告警规则文件
**文件位置**: `config/alerts/mystocks-alerts.yml`

```yaml
groups:
  - name: trading_signals_alerts
    rules:
      - alert: TradingSignalAccuracyLow
        expr: mystocks_signal_accuracy_percentage < 60
        for: 5m
        labels:
          severity: warning
          team: trading
          component: signal_generation
        annotations:
          summary: "交易信号准确度过低"
          description: "信号准确度低于60%，当前值: {{ $value }}%"
          runbook_url: "https://docs.mystocks.com/troubleshooting/signal-accuracy"
      # ... 其他规则
```

#### 2. Prometheus配置文件
**文件位置**: `config/prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['localhost:9093']

rule_files:
  - "alerts/*.yml"

scrape_configs:
  - job_name: 'mystocks-backend'
    static_configs:
      - targets: ['localhost:8000']
    metrics_path: '/metrics'
    scrape_interval: 15s
```

## 遇到的问题和解决方案

### 问题1: 容器文件挂载路径错误

**问题现象**:
- 容器启动成功但告警规则无法加载
- `curl http://localhost:9090/api/v1/rules` 返回空数组 `{"groups":[]}`

**错误尝试**:
```bash
# 错误1: 路径不匹配
docker run -v /opt/claude/mystocks_spec/alerts:/etc/prometheus/alerts

# 错误2: 权限问题
# 实际文件位置: config/alerts/mystocks-alerts.yml
# 尝试挂载: alerts/ (错误路径)
```

**根本原因**:
1. 文件实际路径是 `/opt/claude/mystocks_spec/config/alerts/`
2. 挂载路径误认为是 `/opt/claude/mystocks_spec/alerts/`

### 问题2: 文件权限问题

**问题现象**:
```
ls: can't open '/etc/prometheus/alerts/': Permission denied
```

**解决过程**:
```bash
# 修复文件所有权
sudo chown -R john:john /opt/claude/mystocks_spec/config/alerts/
chmod 644 /opt/claude/mystocks_spec/config/alerts/mystocks-alerts.yml
```

### 问题3: Docker网络配置

**问题现象**:
- Prometheus无法访问宿主机上的后端服务
- 需要特殊网络配置

**解决方案**:
```bash
# 使用host-gateway网络模式
--add-host=host.docker.internal:host-gateway

# 配置文件中使用特殊主机名
targets: ['host.docker.internal:8000']
```

### 问题4: 数据目录权限

**问题现象**:
```
panic: Unable to create mmap-ed active query log
```

**解决方案**:
```bash
# 创建并设置正确的数据目录权限
sudo mkdir -p data/prometheus
sudo chown -R 65534:65534 data/prometheus  # Prometheus容器用户
chmod 755 data/prometheus
```

## 最终成功的解决方案

### 关键要素

1. **正确的文件路径**: 使用绝对路径，避免相对路径混淆
2. **网络配置**: 使用host-gateway模式访问宿主机服务
3. **权限配置**: 确保容器能正确读写挂载的文件
4. **简化配置**: 先用最小配置验证，再逐步添加功能

### 成功的Docker启动命令

```bash
# 1. 创建临时配置文件
cat > /tmp/prometheus_with_alerts.yml << 'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['localhost:9093']

rule_files:
  - "/etc/prometheus/alerts/*.yml"

scrape_configs:
  - job_name: 'mystocks-backend'
    static_configs:
      - targets: ['host.docker.internal:8000']
    metrics_path: '/metrics'
    scrape_interval: 15s
EOF

# 2. 复制告警规则到临时目录
mkdir -p /tmp/prometheus_alerts
cp /opt/claude/mystocks_spec/config/alerts/mystocks-alerts.yml /tmp/prometheus_alerts/

# 3. 启动容器 (关键配置)
docker run -d --name mystocks-prometheus \
    -p 9090:9090 \
    -v /tmp/prometheus_with_alerts.yml:/etc/prometheus/prometheus.yml \
    -v /tmp/prometheus_alerts:/etc/prometheus/alerts \
    --add-host=host.docker.internal:host-gateway \
    prom/prometheus:latest
```

## 验证方法

### 1. API验证
```bash
curl -s http://localhost:9090/api/v1/rules | jq '.data.groups[] | {name: .name, rules: .rules | length}'
```

**成功输出示例**:
```json
{
  "name": "trading_signals_alerts",
  "rules": 12
}
{
  "name": "system_resources_alerts",
  "rules": 4
}
{
  "name": "trading_performance_alerts",
  "rules": 3
}
```

### 2. Web界面验证
访问 http://localhost:9090/alerts 查看告警规则

### 3. 规则详情验证
```bash
# 检查特定规则状态
curl -s http://localhost:9090/api/v1/rules | jq '.data.groups[].rules[] | select(.name=="TradingSignalAccuracyLow")'
```

## 成功标准

- ✅ Prometheus容器正常运行
- ✅ 告警规则成功加载 (19条规则)
- ✅ API返回完整的规则信息
- ✅ Web界面可查看告警规则
- ✅ 规则状态为"inactive" (正常待触发状态)

## 关键经验总结

1. **路径问题是最常见的坑**: 始终使用绝对路径，避免相对路径混淆
2. **权限问题**: 确保容器用户有权访问挂载的文件和目录
3. **网络配置**: 容器访问宿主机服务需要特殊配置
4. **渐进式验证**: 先验证基础功能，再添加复杂配置
5. **使用临时目录**: 避免权限污染，便于问题排查

## 下一步工作

1. **配置Grafana数据源**: 连接Prometheus数据源
2. **导入Dashboard**: 导入交易信号监控面板
3. **配置AlertManager**: 设置告警通知渠道
4. **测试告警**: 验证告警规则触发和通知

---

**文档创建时间**: 2025-12-19
**Phase**: 7 - Week 1 Day 7
**状态**: ✅ 完成
**创建人**: Claude Sonnet 4.5