# GitHub Actions å·¥ä½œæµç¤ºä¾‹: çƒŸé›¾æµ‹è¯•é›†æˆ
#
# æ–‡ä»¶ä½ç½®: .github/workflows/smoke-tests.yml
#
# è¯´æ˜Ž:
#   æ­¤å·¥ä½œæµåœ¨ä»¥ä¸‹æƒ…å†µä¸‹è‡ªåŠ¨è¿è¡ŒçƒŸé›¾æµ‹è¯•:
#   - Pull Request åˆ›å»ºæˆ–æ›´æ–°æ—¶
#   - æŽ¨é€åˆ° main æˆ– develop åˆ†æ”¯æ—¶
#   - æ‰‹åŠ¨è§¦å‘æ—¶
#
# ç”¨é€”:
#   ç¡®ä¿ä»£ç åˆå¹¶å‰æ‰€æœ‰å…³é”®åŠŸèƒ½æ­£å¸¸å·¥ä½œ

name: Smoke Tests

on:
  # Pull Request è§¦å‘
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

  # æŽ¨é€åˆ°ä¸»è¦åˆ†æ”¯è§¦å‘
  push:
    branches:
      - main
      - develop

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# çŽ¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  POSTGRESQL_VERSION: "15"

jobs:
  smoke-tests:
    name: è¿è¡ŒçƒŸé›¾æµ‹è¯•
    runs-on: ubuntu-latest

    # æœåŠ¡å®¹å™¨ (PostgreSQL)
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: mystocks_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      # ============================================
      # Step 1: æ£€å‡ºä»£ç 
      # ============================================
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ============================================
      # Step 2: è®¾ç½® Python çŽ¯å¢ƒ
      # ============================================
      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-playwright httpie

      # ============================================
      # Step 3: è®¾ç½® Node.js çŽ¯å¢ƒ
      # ============================================
      - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/frontend/package-lock.json

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd web/frontend
          npm ci

      # ============================================
      # Step 4: å®‰è£… Playwright æµè§ˆå™¨
      # ============================================
      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: |
          playwright install chromium
          playwright install-deps chromium

      # ============================================
      # Step 5: åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“
      # ============================================
      - name: åˆå§‹åŒ–æ•°æ®åº“
        env:
          PGPASSWORD: test_password
        run: |
          # åˆ›å»ºæ•°æ®åº“æ¨¡å¼
          psql -h localhost -U test_user -d mystocks_test -f db/schema.sql

          # å¯¼å…¥æµ‹è¯•æ•°æ®
          psql -h localhost -U test_user -d mystocks_test -f db/test_data.sql

      # ============================================
      # Step 6: é…ç½®çŽ¯å¢ƒå˜é‡
      # ============================================
      - name: é…ç½®çŽ¯å¢ƒå˜é‡
        run: |
          cat > .env << EOF
          # æ•°æ®åº“é…ç½®
          POSTGRESQL_HOST=localhost
          POSTGRESQL_PORT=5432
          POSTGRESQL_USER=test_user
          POSTGRESQL_PASSWORD=test_password
          POSTGRESQL_DATABASE=mystocks_test

          # åº”ç”¨é…ç½®
          MYSTOCKS_URL=http://localhost:8000
          FRONTEND_URL=http://localhost:5173
          SECRET_KEY=${{ secrets.SECRET_KEY || 'test-secret-key-for-ci' }}
          EOF

      # ============================================
      # Step 7: å¯åŠ¨åŽç«¯æœåŠ¡
      # ============================================
      - name: å¯åŠ¨åŽç«¯æœåŠ¡
        run: |
          cd web/backend
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

          # éªŒè¯åŽç«¯å¯åŠ¨æˆåŠŸ
          curl -f http://localhost:8000/health || exit 1

      # ============================================
      # Step 8: æž„å»ºå¹¶å¯åŠ¨å‰ç«¯æœåŠ¡
      # ============================================
      - name: æž„å»ºå‰ç«¯
        run: |
          cd web/frontend
          npm run build

      - name: å¯åŠ¨å‰ç«¯æœåŠ¡
        run: |
          cd web/frontend
          npm run preview -- --port 5173 --host 0.0.0.0 &
          sleep 5

          # éªŒè¯å‰ç«¯å¯åŠ¨æˆåŠŸ
          curl -f http://localhost:5173 || exit 1

      # ============================================
      # Step 9: è¿è¡ŒçƒŸé›¾æµ‹è¯•
      # ============================================
      - name: è¿è¡ŒçƒŸé›¾æµ‹è¯•å¥—ä»¶
        run: |
          pytest tests/smoke/test_smoke.py -v -x --tb=short \
            --junit-xml=test-results/smoke-tests.xml

      # ============================================
      # Step 10: ä¸Šä¼ æµ‹è¯•ç»“æžœ
      # ============================================
      - name: ä¸Šä¼ æµ‹è¯•ç»“æžœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: test-results/
          retention-days: 30

      # ============================================
      # Step 11: ä¸Šä¼ å¤±è´¥æˆªå›¾
      # ============================================
      - name: ä¸Šä¼ å¤±è´¥æˆªå›¾
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-screenshots
          path: docs/verification-screenshots/
          retention-days: 14

      # ============================================
      # Step 12: è¯„è®º PR (å¯é€‰)
      # ============================================
      - name: è¯„è®º PR ç»“æžœ
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const testResults = fs.existsSync('test-results/smoke-tests.xml');

            let comment = '## ðŸ§ª çƒŸé›¾æµ‹è¯•ç»“æžœ\n\n';

            if (testResults) {
              comment += 'âœ… **æ‰€æœ‰çƒŸé›¾æµ‹è¯•é€šè¿‡**\n\n';
              comment += 'æ‰€æœ‰ 7 é¡¹å…³é”®åŠŸèƒ½éªŒè¯é€šè¿‡ï¼ŒPR å¯ä»¥åˆå¹¶ã€‚\n\n';
              comment += 'è¯¦ç»†æŠ¥å‘Š: [æŸ¥çœ‹æµ‹è¯•ç»“æžœ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            } else {
              comment += 'âŒ **çƒŸé›¾æµ‹è¯•å¤±è´¥**\n\n';
              comment += 'éƒ¨åˆ†å…³é”®åŠŸèƒ½éªŒè¯æœªé€šè¿‡ï¼Œè¯·ä¿®å¤åŽå†åˆå¹¶ã€‚\n\n';
              comment += 'è¯¦ç»†æŠ¥å‘Š: [æŸ¥çœ‹å¤±è´¥è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: comment
            });

# ============================================
# è¡¥å……è¯´æ˜Ž
# ============================================
#
# 1. Secrets é…ç½®:
#    åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹ Secrets:
#    - SECRET_KEY: åº”ç”¨å¯†é’¥
#
# 2. æ•°æ®åº“æ–‡ä»¶:
#    ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨:
#    - db/schema.sql: æ•°æ®åº“æ¨¡å¼
#    - db/test_data.sql: æµ‹è¯•æ•°æ®
#
# 3. è‡ªå®šä¹‰é…ç½®:
#    æ ¹æ®é¡¹ç›®å®žé™…æƒ…å†µè°ƒæ•´:
#    - Python/Node ç‰ˆæœ¬
#    - æ•°æ®åº“é…ç½®
#    - ç«¯å£å·
#    - è¶…æ—¶æ—¶é—´
#
# 4. æ€§èƒ½ä¼˜åŒ–:
#    - ä½¿ç”¨ cache åŠ é€Ÿä¾èµ–å®‰è£…
#    - å¹¶è¡Œè¿è¡Œç‹¬ç«‹æ­¥éª¤
#    - é€‚å½“è°ƒæ•´ timeout-minutes
#
# 5. æ•…éšœæŽ’æŸ¥:
#    - æŸ¥çœ‹ Actions æ—¥å¿—
#    - ä¸‹è½½å¤±è´¥æˆªå›¾
#    - æ£€æŸ¥æ•°æ®åº“è¿žæŽ¥
#    - éªŒè¯çŽ¯å¢ƒå˜é‡
