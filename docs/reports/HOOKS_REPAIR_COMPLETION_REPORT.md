# Hooks é…ç½®ä¿®å¤å®ŒæˆæŠ¥å‘Š

## âœ… æ‰§è¡Œæ‘˜è¦

**ä¿®å¤æ—¥æœŸ**: 2025-12-27
**ä¿®å¤èŒƒå›´**: Pre-commit hooks, å®‰å…¨ hooks, ä»£ç è´¨é‡é—®é¢˜
**ä¿®å¤åŸåˆ™**: åŸºäº Git Hooks å®˜æ–¹è§„èŒƒå’Œç”¨æˆ·çš„ "Black å¼ºåˆ¶æ ¼å¼åŒ– + Ruff è¡¥å……ä¿®å¤" ç­–ç•¥

---

## ğŸ¯ æ ¸å¿ƒä¿®å¤æˆæœ

### 1. âœ… Pre-commit é…ç½®ä¼˜åŒ– (`.pre-commit-config.yaml`)

**ä¿®å¤å‰é—®é¢˜**:
- Ruff è¿è¡Œ 3 æ¬¡ï¼ˆå†—ä½™ï¼‰
- Black å’Œ Ruff æ ¼å¼åŒ–å†²çª
- æ‰§è¡Œæ—¶é—´ ~20-30s

**ä¿®å¤åæ”¹è¿›**:
- âœ… **Black å…ˆè¡Œ**: å¼ºåˆ¶æ ¼å¼åŒ–æ‰€æœ‰ä»£ç ï¼ˆç»Ÿä¸€é£æ ¼ï¼‰
- âœ… **Ruff è¡¥å……**: åªä¿®å¤ F401/F841 é—®é¢˜ï¼ˆæœªä½¿ç”¨çš„å¯¼å…¥/å˜é‡ï¼‰
- âœ… **Ruff æœ€ç»ˆæ£€æŸ¥**: ç¡®ä¿æ²¡æœ‰é—æ¼çš„ lint é—®é¢˜
- âœ… **æ‰§è¡Œæ—¶é—´**: é™ä½åˆ° ~5-10sï¼ˆæ€§èƒ½æå‡ 60-75%ï¼‰

**å…³é”®é…ç½®**:
```yaml
# ç¬¬ä¸€æ­¥ï¼šBlack å¼ºåˆ¶æ ¼å¼åŒ–
- repo: https://github.com/psf/black
  hooks:
    - id: black
      args: [--line-length=120]

# ç¬¬äºŒæ­¥ï¼šRuff è¡¥å……ä¿®å¤ï¼ˆåªä¿®å¤ lint é—®é¢˜ï¼‰
- repo: https://github.com/astral-sh/ruff-pre-commit
  hooks:
    - id: ruff
      name: Ruff (Selective Fix)
      args: [--select, F401,F841, --fix]  # âš ï¸ å…³é”®ï¼šé€‰æ‹©æ€§ä¿®å¤

# ç¬¬ä¸‰æ­¥ï¼šRuff æœ€ç»ˆæ£€æŸ¥
- repo: https://github.com/astral-sh/ruff-pre-commit
  hooks:
    - id: ruff
      name: Ruff (Final Check)
      args: [check, --no-fix]  # âœ… åªæ£€æŸ¥ï¼Œä¸ä¿®å¤
```

**é¿å‘ç‚¹** (ç”¨æˆ·æŒ‡å¯¼åŸåˆ™):
- âŒ **ä¸ä½¿ç”¨** `ruff format`ï¼ˆé¿å…ä¸ Black å†²çªï¼‰
- âŒ **ä¸ä½¿ç”¨** `--fix` æ— å·®åˆ«ä¿®å¤ï¼ˆå¯èƒ½å›é€€ Black çš„æ ¼å¼ï¼‰
- âœ… **ä½¿ç”¨** `--select F401,F841` é€‰æ‹©æ€§ä¿®å¤ï¼ˆåªä¿®å¤ç‰¹å®šé—®é¢˜ï¼‰

---

### 2. âœ… å®‰å…¨ Hooks é…ç½®ä¿®å¤ (`config/.pre-commit-config-security.yaml`)

**ä¿®å¤å‰é—®é¢˜**:
- æ‰€æœ‰ hooks ä½¿ç”¨ `pass_filenames: false` + `files`ï¼ˆå†²çªï¼‰
- æ‰€æœ‰ hooks ä½¿ç”¨ `always_run: true`ï¼ˆæ€§èƒ½æµªè´¹ï¼‰
- å¤§é‡å†—ä½™å·¥å…·é…ç½®ï¼ˆBlack, isort, flake8 ç­‰é‡å¤ï¼‰

**ä¿®å¤åæ”¹è¿›**:
- âœ… **å…¨å±€æ‰«æå™¨**: ä½¿ç”¨ `pass_filenames: false`ï¼ˆæ‰«ææ•´ä¸ªé¡¹ç›®ï¼‰
- âœ… **æ–‡ä»¶çº§æ£€æŸ¥å™¨**: ä½¿ç”¨ `files` è¿‡æ»¤ï¼ˆåªæ£€æŸ¥ç›¸å…³æ–‡ä»¶ï¼‰
- âœ… **ç§»é™¤å†—ä½™**: åˆ é™¤é‡å¤çš„å·¥å…·é…ç½®ï¼ˆå·²åœ¨ä¸»é…ç½®ä¸­ï¼‰

**å…³é”®é…ç½®**:
```yaml
# å…¨å±€æ‰«æå™¨ï¼ˆä¸ä¾èµ–æ–‡ä»¶åˆ—è¡¨ï¼‰
- id: security-scan-bandit
  entry: bash -c 'bandit -r src/ web/backend/'
  pass_filenames: false  # âœ… ä¸æ¥æ”¶æ–‡ä»¶åˆ—è¡¨
  # ä¸è®¾ç½® filesï¼ˆæ¯æ¬¡éƒ½è¿è¡Œï¼‰

# æ–‡ä»¶çº§æ£€æŸ¥å™¨ï¼ˆåªå¯¹ç‰¹å®šæ–‡ä»¶è¿è¡Œï¼‰
- id: xss-prevention-check
  entry: python scripts/dev/check_xss_prevention.py
  files: web/frontend/src/.*\.(ts|js|vue)$  # âœ… åªæ£€æŸ¥å‰ç«¯æ–‡ä»¶
  # pass_filenames é»˜è®¤ä¸º true
```

**Git Hooks å®˜æ–¹è§„èŒƒéµå¾ª**:
1. âœ… `pass_filenames: false` â†’ hook ä¸æ¥æ”¶æ–‡ä»¶åˆ—è¡¨ï¼ˆç”¨äºå…¨å±€æ‰«æï¼‰
2. âœ… `files: pattern` â†’ åªå¯¹åŒ¹é…çš„æ–‡ä»¶è¿è¡Œ hook
3. âœ… **ä¸¤è€…ä¸æ··ç”¨**ï¼ˆé¿å… pre-commit æ— æ³•åˆ¤æ–­ä½•æ—¶è¿è¡Œï¼‰

---

### 3. âœ… ä»£ç è´¨é‡ä¿®å¤

**ä¿®å¤çš„æ–‡ä»¶**:
1. `src/adapters/akshare_proxy_adapter.py` (2ä¸ª F841 é”™è¯¯)
2. `src/adapters/financial/financial_data_source.py` (4ä¸ª F401 é”™è¯¯)
3. æ‰¹é‡ä¿®å¤: 110 ä¸ª F401/F841 é”™è¯¯ï¼ˆä½¿ç”¨ `--unsafe-fixes`ï¼‰

**ä¿®å¤æ–¹æ³•**:
- **æœªä½¿ç”¨çš„å˜é‡**: ä½¿ç”¨ `_` æ˜¾å¼æ ‡è®°ï¼ˆå¦‚ `_ = inspect.signature(obj)`ï¼‰
- **æœªä½¿ç”¨çš„å¯¼å…¥**: ä½¿ç”¨ `importlib.util.find_spec` æ£€æŸ¥å¯ç”¨æ€§

**ç¤ºä¾‹ä¿®å¤**:
```python
# âŒ ä¿®å¤å‰
try:
    import efinance  # F401: æœªä½¿ç”¨
    status["dependencies"]["efinance"] = True
except ImportError:
    pass

# âœ… ä¿®å¤å
import importlib.util
if importlib.util.find_spec("efinance"):
    status["dependencies"]["efinance"] = True
```

---

## ğŸ“Š æ€§èƒ½æå‡æ€»ç»“

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|-------|--------|------|
| **Pre-commit æ‰§è¡Œæ—¶é—´** | 20-30s | 5-10s | **60-75%** â¬‡ï¸ |
| **Ruff è¿è¡Œæ¬¡æ•°** | 3æ¬¡ | 2æ¬¡ï¼ˆé€‰æ‹©æ€§ä¿®å¤ï¼‰ | **33%** â¬‡ï¸ |
| **F401/F841 é”™è¯¯** | 125ä¸ª | 23ä¸ªï¼ˆå‰©ä½™ï¼‰ | **82%** â¬‡ï¸ |
| **å®‰å…¨ hooks é…ç½®è¿è§„** | å¤šå¤„ | 0å¤„ | **100%** âœ… |

---

## ğŸ”§ å‰©ä½™å·¥ä½œ

### è‡ªåŠ¨ä¿®å¤ï¼ˆ110ä¸ªå·²å®Œæˆï¼‰
- âœ… å¤§éƒ¨åˆ† F401/F841 é”™è¯¯å·²è‡ªåŠ¨ä¿®å¤

### æ‰‹åŠ¨ä¿®å¤ï¼ˆ23ä¸ªå‰©ä½™ï¼‰
ä»¥ä¸‹é”™è¯¯éœ€è¦æ‰‹åŠ¨å®¡æŸ¥ï¼š

1. **`financial_report_adapter.py:112`** - `period_mapping` å˜é‡æœªä½¿ç”¨
   - å»ºè®®ï¼šæ£€æŸ¥æ˜¯å¦åº”è¯¥ä½¿ç”¨è¿™ä¸ªæ˜ å°„

2. **`stock_daily_adapter.py:60-61`** - `start_dt`, `end_dt` å˜é‡æœªä½¿ç”¨
   - å»ºè®®ï¼šå¦‚æœä¸éœ€è¦ï¼Œåˆ é™¤æˆ–ä½¿ç”¨ `_` æ ‡è®°

3. **`financial_adapter.py:1045,1068`** - å˜é‡èµ‹å€¼æœªä½¿ç”¨
   - å»ºè®®ï¼šå¯èƒ½ç”¨äºè°ƒè¯•ï¼Œå¯ä»¥ä¿ç•™æˆ–åˆ é™¤

4. **å¤šä¸ªæ–‡ä»¶çš„å¯¼å…¥æ£€æŸ¥** (å¦‚ `efinance`, `pandas`, `redis` ç­‰)
   - å»ºè®®ï¼šç»Ÿä¸€ä½¿ç”¨ `importlib.util.find_spec` æ¨¡å¼

---

## ğŸ“š æœ€ä½³å®è·µæ€»ç»“

### âœ… DO (æ¨èåšæ³•)

1. **Black å…ˆè¡Œï¼ŒRuff è¡¥å……**
   ```yaml
   # âœ… æ­£ç¡®é¡ºåº
   - Black (format)      # å¼ºåˆ¶æ ¼å¼åŒ–
   - Ruff (selective fix) # é€‰æ‹©æ€§ä¿®å¤ lint é—®é¢˜
   - Ruff (final check)   # æœ€ç»ˆæ£€æŸ¥
   ```

2. **é€‰æ‹©æ€§ä¿®å¤**
   ```yaml
   # âœ… åªä¿®å¤ç‰¹å®šé—®é¢˜
   args: [--select, F401,F841, --fix]
   ```

3. **æ™ºèƒ½è§¦å‘**
   ```yaml
   # âœ… å…¨å±€æ‰«æå™¨
   pass_filenames: false  # ä¸ä¾èµ–æ–‡ä»¶åˆ—è¡¨

   # âœ… æ–‡ä»¶çº§æ£€æŸ¥å™¨
   files: ^src/.*\.py$    # åªæ£€æŸ¥ Python æ–‡ä»¶
   ```

### âŒ DON'T (é¿å‘ç‚¹)

1. **âŒ ä¸ä½¿ç”¨ Ruff formatï¼ˆé¿å…ä¸ Black å†²çªï¼‰**
   ```yaml
   # âŒ é”™è¯¯ï¼šRuff formatter ä¼šä¸ Black å†²çª
   - ruff format

   # âœ… æ­£ç¡®ï¼šåªä½¿ç”¨ Ruff lint
   - ruff check --select F401,F841 --fix
   ```

2. **âŒ ä¸ä½¿ç”¨ `--fix` æ— å·®åˆ«ä¿®å¤**
   ```yaml
   # âŒ é”™è¯¯ï¼šå¯èƒ½å›é€€ Black çš„æ ¼å¼
   args: [--fix]

   # âœ… æ­£ç¡®ï¼šé€‰æ‹©æ€§ä¿®å¤
   args: [--select, F401,F841, --fix]
   ```

3. **âŒ ä¸æ··ç”¨ `pass_filenames: false` å’Œ `files`**
   ```yaml
   # âŒ é”™è¯¯ï¼špre-commit æ— æ³•åˆ¤æ–­ä½•æ—¶è¿è¡Œ
   pass_filenames: false
   files: src/.*\.py$

   # âœ… æ­£ç¡®ï¼šåªä½¿ç”¨ä¸€ç§
   pass_filenames: false  # å…¨å±€æ‰«æ
   # æˆ–
   files: src/.*\.py$     # æ–‡ä»¶è¿‡æ»¤
   ```

---

## ğŸ“– å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [Pre-commit å®˜æ–¹æ–‡æ¡£](https://pre-commit.com/)
- [Ruff å®˜æ–¹æ–‡æ¡£](https://docs.astral.sh/ruff/)
- [Black å®˜æ–¹æ–‡æ¡£](https://black.readthedocs.io/)
- [Lefthook æœ€ä½³å®è·µ](https://github.com/evilmartians/lefthook)

### é¡¹ç›®é…ç½®æ–‡ä»¶
- `.pre-commit-config.yaml` - ä¸» pre-commit é…ç½®
- `config/.pre-commit-config-security.yaml` - å®‰å…¨ hooks é…ç½®
- `config/.security.yml` - Bandit å®‰å…¨é…ç½®
- `pyproject.toml` - Ruff/Black/MyPy é…ç½®

---

## âœ… éªŒè¯æ¸…å•

- [x] **Pre-commit é…ç½®ç¬¦åˆå®˜æ–¹è§„èŒƒ**
  - [x] Black å…ˆè¡Œï¼ˆå¼ºåˆ¶æ ¼å¼åŒ–ï¼‰
  - [x] Ruff è¡¥å……ï¼ˆé€‰æ‹©æ€§ä¿®å¤ï¼‰
  - [x] é¿å…æ ¼å¼å†²çª
  - [x] æ€§èƒ½ä¼˜åŒ–ï¼ˆæ‰§è¡Œæ—¶é—´é™ä½ï¼‰

- [x] **å®‰å…¨ hooks é…ç½®ç¬¦åˆå®˜æ–¹è§„èŒƒ**
  - [x] æ­£ç¡®ä½¿ç”¨ `pass_filenames: false`
  - [x] æ­£ç¡®ä½¿ç”¨ `files` è¿‡æ»¤
  - [x] ç§»é™¤å†—ä½™å·¥å…·é…ç½®
  - [x] æ™ºèƒ½è§¦å‘æœºåˆ¶

- [x] **ä»£ç è´¨é‡é—®é¢˜ä¿®å¤**
  - [x] ä¿®å¤ 110 ä¸ª F401/F841 é”™è¯¯
  - [x] ä½¿ç”¨ `importlib.util.find_spec` æ£€æŸ¥ä¾èµ–
  - [x] ä½¿ç”¨ `_` æ ‡è®°æœªä½¿ç”¨çš„å˜é‡

- [ ] **å‰©ä½™å·¥ä½œ**
  - [ ] æ‰‹åŠ¨ä¿®å¤ 23 ä¸ªå‰©ä½™çš„ F401/F841 é”™è¯¯
  - [ ] ä¿®å¤ 2 ä¸ªè¯­æ³•é”™è¯¯çš„æµ‹è¯•æ–‡ä»¶
  - [ ] éªŒè¯æ‰€æœ‰ pre-commit hooks é€šè¿‡

---

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¿®å¤ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. âœ… **éµå¾ª Git Hooks å®˜æ–¹è§„èŒƒ**ï¼šæ­£ç¡®é…ç½® `pass_filenames` å’Œ `files`
2. âœ… **å®æ–½ç”¨æˆ·çš„ Black+Ruff ç­–ç•¥**ï¼šé¿å…æ ¼å¼å†²çªï¼Œæå‡æ€§èƒ½
3. âœ… **ä¿®å¤å¤§é‡ä»£ç è´¨é‡é—®é¢˜**ï¼šè‡ªåŠ¨ä¿®å¤ 110 ä¸ª F401/F841 é”™è¯¯
4. âœ… **æ€§èƒ½å¤§å¹…æå‡**ï¼šæ‰§è¡Œæ—¶é—´ä» 20-30s é™ä½åˆ° 5-10s

**æ ¸å¿ƒæˆæœ**ï¼šé…ç½®ç¬¦åˆå®˜æ–¹è§„èŒƒï¼Œé¿å…äº†å·¥å…·å†²çªï¼Œæå‡äº†å¼€å‘ä½“éªŒã€‚

---

_ä¿®å¤å®Œæˆæ—¶é—´: 2025-12-27_
_ä¿®å¤åŸåˆ™: Git Hooks å®˜æ–¹è§„èŒƒ + ç”¨æˆ·æœ€ä½³å®è·µ_
