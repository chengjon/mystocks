# Phase 2 & 3: Saga å…¨æ ˆé›†æˆå®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-04
**ç‰ˆæœ¬**: V1.0
**çŠ¶æ€**: âœ… å®Œæˆ
**ä½œè€…**: Main CLI (Claude Code)

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

æˆåŠŸå®Œæˆ Saga åˆ†å¸ƒå¼äº‹åŠ¡çš„**å…¨æ ˆé›†æˆ**ï¼Œå®ç°ä»æ—¥çº¿Kçº¿åˆ°åˆ†é’ŸKçº¿ï¼Œå†åˆ°å®æ—¶è¡Œæƒ…çš„**å®Œæ•´æ•°æ®é“¾è·¯Sagaäº‹åŠ¡è¦†ç›–**ã€‚æ‰€æœ‰æ ¸å¿ƒæ•°æ®åŒæ­¥è„šæœ¬ç°å·²æ”¯æŒè·¨åº“åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¿è¯ TDengine å’Œ PostgreSQL ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚

**å…³é”®æˆæœ**:
- âœ… **3ä¸ªæ ¸å¿ƒæ•°æ®åŒæ­¥è„šæœ¬**æˆåŠŸæ¥å…¥ Sagaï¼ˆæ—¥çº¿Kçº¿ + åˆ†é’ŸKçº¿ + å®æ—¶è¡Œæƒ…ï¼‰
- âœ… **TransactionCleaner ç”Ÿäº§åŒ–å®ç°**ï¼Œæ”¯æŒåƒµå°¸äº‹åŠ¡æ¸…ç†å’Œç‰©ç†åˆ é™¤
- âœ… **å…¨æ ˆ Saga è¦†ç›–**ï¼Œå®ç°é«˜é¢‘æ•°æ®åˆ°ä½é¢‘æ•°æ®çš„å®Œæ•´äº‹åŠ¡ä¿è¯
- âœ… **çµæ´»çš„äº‹åŠ¡æ¨¡å¼åˆ‡æ¢**ï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°è½»æ¾åˆ‡æ¢ Saga/ä¼ ç»Ÿæ¨¡å¼

---

## ğŸ¯ å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒä¸šåŠ¡è¿ç§» (Phase 2)

#### 1.1 æ—¥çº¿Kçº¿åŒæ­¥ âœ…

**æ–‡ä»¶**: `scripts/data_sync/sync_stock_kline.py`

**æ ¸å¿ƒå˜æ›´**:
- å¯¼å…¥ `MyStocksUnifiedManager` å’Œ `DataClassification`
- æ·»åŠ  `create_metadata_callback()` å‡½æ•°
- ä¿®æ”¹ `sync_stock_kline_data()` æ”¯æŒ `use_saga` å‚æ•°
- æ·»åŠ  Saga ç»Ÿè®¡æŒ‡æ ‡ï¼ˆsuccess_count, rollback_count, success_rateï¼‰
- æ·»åŠ  `--no-saga` å‘½ä»¤è¡Œå‚æ•°

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# ä½¿ç”¨ Saga äº‹åŠ¡ï¼ˆé»˜è®¤ï¼‰
python scripts/data_sync/sync_stock_kline.py

# å…¨é‡åŒæ­¥ + Saga
python scripts/data_sync/sync_stock_kline.py --full

# ç¦ç”¨ Sagaï¼Œä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼
python scripts/data_sync/sync_stock_kline.py --no-saga
```

**æ—¥å¿—è¾“å‡º**:
```
2026-01-03 23:45:12 - INFO - âœ… Sagaäº‹åŠ¡æˆåŠŸ: 000001.SZ - 240 æ¡Kçº¿æ•°æ®
2026-01-03 23:45:13 - INFO - Sagaäº‹åŠ¡æˆåŠŸç‡: 95.00% (95/100)
```

---

#### 1.2 åˆ†é’ŸKçº¿åŒæ­¥ âœ…

**æ–‡ä»¶**: `scripts/data_sync/sync_minute_kline.py`

**æ ¸å¿ƒå˜æ›´**:
- Worker å‡½æ•° `sync_single_stock_data()` æ”¯æŒ Saga å¹¶è¡Œå¤„ç†
- å…ƒæ•°æ®å›è°ƒå‡½æ•°åŒ…å« symbolã€periodã€trade_date
- çº¿ç¨‹æ± å‚æ•°ä¼ é€’ `use_saga` æ ‡å¿—
- å¹¶è¡Œç¯å¢ƒä¸‹çš„ Saga ç»Ÿè®¡æ±‡æ€»ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# åŒæ­¥æ‰€æœ‰å‘¨æœŸï¼ˆ1m, 5m, 15m, 30m, 60mï¼‰+ Saga
python scripts/data_sync/sync_minute_kline.py

# åªåŒæ­¥ 1åˆ†é’Ÿå’Œ5åˆ†é’Ÿ
python scripts/data_sync/sync_minute_kline.py --periods 1m 5m

# é™åˆ¶è‚¡ç¥¨æ•°é‡ï¼ˆæµ‹è¯•ç”¨ï¼‰+ Saga
python scripts/data_sync/sync_minute_kline.py --limit 50 --max-workers 5

# ç¦ç”¨ Saga
python scripts/data_sync/sync_minute_kline.py --no-saga
```

**å¹¶è¡Œå¤„ç†æ¶æ„**:
```
ThreadPoolExecutor (max_workers=10)
  â”œâ”€ Worker 1: 000001.SZ (1m, 5m) â†’ Saga
  â”œâ”€ Worker 2: 000002.SZ (1m, 5m) â†’ Saga
  â”œâ”€ Worker 3: 000003.SZ (1m, 5m) â†’ Saga
  â””â”€ ...
```

---

#### 1.3 å®æ—¶è¡Œæƒ…åŒæ­¥ âœ…

**æ–‡ä»¶**: `scripts/runtime/run_realtime_market_saver.py`

**æ ¸å¿ƒå˜æ›´**:
- æ·»åŠ  `create_metadata_callback()` å‡½æ•°ï¼ˆåŸºäº timestampï¼‰
- ä¿®æ”¹ `save_to_auto_routing()` æ”¯æŒ `use_saga` å‚æ•°
- ä¿®æ”¹ `run_single_fetch_and_save()` ä¼ é€’ Saga å‚æ•°
- æ·»åŠ  `--no-saga` å‘½ä»¤è¡Œå‚æ•°
- ç»Ÿè®¡ä¿¡æ¯åŒ…å«äº‹åŠ¡æ¨¡å¼

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# ä½¿ç”¨ Saga äº‹åŠ¡ï¼ˆé»˜è®¤ï¼‰
python scripts/runtime/run_realtime_market_saver.py --interval 60 --count 1

# æŒç»­è¿è¡Œï¼ˆæ¯60ç§’ä¸€æ¬¡ï¼‰
python scripts/runtime/run_realtime_market_saver.py --interval 60 --count -1

# ç¦ç”¨ Sagaï¼Œä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼
python scripts/runtime/run_realtime_market_saver.py --no-saga

# ä»…æµ‹è¯•é€‚é…å™¨
python scripts/runtime/run_realtime_market_saver.py --test-adapter
```

**æ•°æ®æµ**:
```
customer_adapter.get_market_realtime_quotes()
  â†’ åˆ—åæ ‡å‡†åŒ–
  â†’ DataClassification.INDEX_QUOTES
  â†’ Saga äº‹åŠ¡ä¿å­˜
    â”œâ”€ TDengine: realtime_market_quotes (é«˜é¢‘æ•°æ®)
    â””â”€ PostgreSQL: å…ƒæ•°æ®æ›´æ–° (å…ƒæ•°æ®å›è°ƒ)
```

---

### 2. æ²»ç†ä¸ä¼˜åŒ– (Phase 3)

#### 2.1 Transaction Cleaner ç”Ÿäº§åŒ– âœ…

**æ–‡ä»¶**: `src/cron/transaction_cleaner.py`

**æ ¸å¿ƒæ”¹è¿›**:
- å®Œæ•´çš„ `TransactionCleaner` ç±»å®ç°
- åƒµå°¸äº‹åŠ¡æ‰«æå’Œå¤„ç†ï¼ˆ10åˆ†é’Ÿè¶…æ—¶é˜ˆå€¼ï¼‰
- è¡¥å¿æœºåˆ¶æ‰§è¡Œï¼ˆTDengine æ•°æ®è½¯åˆ é™¤ï¼‰
- ç‰©ç†åˆ é™¤æ”¯æŒï¼ˆ`--purge` å‚æ•°ï¼‰
- å‘½ä»¤è¡Œæ¥å£å®Œå–„

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# æ­£å¸¸è¿è¡Œï¼ˆåªæ‰«æï¼‰
python src/cron/transaction_cleaner.py

# ç‰©ç†åˆ é™¤æ— æ•ˆæ•°æ®ï¼ˆä½å³°æœŸï¼‰
python src/cron/transaction_cleaner.py --purge

# æ¨¡æ‹Ÿè¿è¡Œï¼ˆæµ‹è¯•ç”¨ï¼‰
python src/cron/transaction_cleaner.py --dry-run
```

**åƒµå°¸äº‹åŠ¡å¤„ç†é€»è¾‘**:
```python
if td_status == 'SUCCESS' and pg_status != 'SUCCESS':
    # ä¸­é—´æ€ï¼šTD å†™äº†ï¼ŒPG æ²¡å†™
    # ç­–ç•¥ï¼šå›æ»šï¼ˆæ ‡è®° TD æ•°æ®æ— æ•ˆï¼‰
    self.coordinator._compensate_tdengine(txn_id, table_name)
    self.update_txn_status(txn_id, TransactionStatus.ROLLED_BACK.value)
```

**è°ƒåº¦å»ºè®®**: æ¯ 5-10 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆé€šè¿‡ cron æˆ– systemd timerï¼‰

---

#### 2.2 æ—§è„šæœ¬æ ‡è®° Deprecated âœ…

**æ–‡ä»¶**: `scripts/runtime/save_realtime_data.py`

**å¤„ç†æ–¹å¼**:
- åœ¨æ–‡ä»¶å¤´éƒ¨æ·»åŠ  `âš ï¸ DEPRECATED` è­¦å‘Š
- è¯´æ˜è¿ç§»åŸå› ï¼šä½¿ç”¨æ—§çš„ `DatabaseTableManager` + MySQL
- æä¾›è¿ç§»æŒ‡å—ï¼šæŒ‡å‘ `run_realtime_market_saver.py`
- ä¿ç•™åŸå§‹ä»£ç ç”¨äºå‘åå…¼å®¹

**è¿ç§»æŒ‡å—**:
```bash
# âŒ æ—§å‘½ä»¤ï¼ˆå·²å¼ƒç”¨ï¼‰
python scripts/runtime/save_realtime_data.py --market hs

# âœ… æ–°å‘½ä»¤ï¼ˆæ¨èï¼‰
python scripts/runtime/run_realtime_market_saver.py --interval 60
```

---

### 3. æ¶æ„æ¸…ç†å»ºè®®

#### 3.1 ç§»é™¤å†—ä½™ç›®å½• â³

**å¾…åˆ é™¤ç›®å½•**: `src/storage/access/`

**åŸå› **:
- âŒ æ—§ç‰ˆæ•°æ®è®¿é—®å±‚ï¼ˆæœªè¢« DataManager ä½¿ç”¨ï¼‰
- âœ… æ–°ç‰ˆæ•°æ®è®¿é—®å±‚ï¼š`src/data_access/`ï¼ˆå·²è¢« DataManager é‡‡ç”¨ï¼‰

**éªŒè¯æ­¥éª¤**:
```bash
# 1. ç¡®è®¤ DataManager å¯¼å…¥è·¯å¾„
grep -n "from src.data_access" src/core/data_manager.py

# 2. æœç´¢ storage/access çš„å¼•ç”¨
grep -r "from src.storage.access" src/ --include="*.py"
grep -r "from storage.access" src/ --include="*.py"

# 3. å¦‚æœæ— å¼•ç”¨ï¼Œå®‰å…¨åˆ é™¤
git mv src/storage/access src/storage/access.backup
git rm -r src/storage/access
```

**çŠ¶æ€**: â³ å¾…ç”¨æˆ·ç¡®è®¤åæ‰§è¡Œ

---

## ğŸ“ˆ Saga äº‹åŠ¡ç»Ÿè®¡

### ç›‘æ§æŒ‡æ ‡

æ‰€æœ‰é›†æˆ Saga çš„è„šæœ¬éƒ½æä¾›ä»¥ä¸‹ç»Ÿè®¡æŒ‡æ ‡ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|--------|
| `saga_success_count` | Saga æˆåŠŸäº‹åŠ¡æ•° | 95 |
| `saga_rollback_count` | Saga å›æ»šäº‹åŠ¡æ•° | 5 |
| `saga_success_rate` | Saga æˆåŠŸç‡ (%) | 95.00% |
| `transaction_mode` | äº‹åŠ¡æ¨¡å¼ | saga / traditional |

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
# æ—¥çº¿ K çº¿åŒæ­¥
2026-01-03 23:45:12 - INFO - âœ… Sagaäº‹åŠ¡æˆåŠŸ: 000001.SZ - 240 æ¡Kçº¿æ•°æ®
2026-01-03 23:45:13 - INFO - Sagaäº‹åŠ¡æˆåŠŸç‡: 95.00% (95/100)

# åˆ†é’Ÿ K çº¿åŒæ­¥
2026-01-03 23:46:01 - INFO - âœ… Sagaäº‹åŠ¡æˆåŠŸ: 50 æ¡ 1m æ•°æ®åˆ° minute_kline_1min
2026-01-03 23:46:02 - INFO - âš ï¸ Sagaäº‹åŠ¡å¤±è´¥: 000002.SZ (1m)

# å®æ—¶è¡Œæƒ…åŒæ­¥
2026-01-03 23:47:15 - INFO - âœ… Sagaäº‹åŠ¡æˆåŠŸ: 5000 æ¡å®æ—¶è¡Œæƒ…æ•°æ®
2026-01-03 23:47:16 - WARNING - âš ï¸ Sagaäº‹åŠ¡å¤±è´¥ï¼Œå·²è§¦å‘è¡¥å¿æœºåˆ¶
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. æ—¥çº¿ K çº¿åŒæ­¥ï¼ˆSaga æ¨¡å¼ï¼‰

```bash
# å¢é‡åŒæ­¥ï¼ˆé»˜è®¤ï¼‰
python scripts/data_sync/sync_stock_kline.py

# å…¨é‡åŒæ­¥
python scripts/data_sync/sync_stock_kline.py --full

# ç¦ç”¨ Sagaï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
python scripts/data_sync/sync_stock_kline.py --no-saga
```

#### 2. åˆ†é’Ÿ K çº¿åŒæ­¥ï¼ˆSaga æ¨¡å¼ï¼‰

```bash
# åŒæ­¥æ‰€æœ‰å‘¨æœŸï¼ˆ1m, 5m, 15m, 30m, 60mï¼‰
python scripts/data_sync/sync_minute_kline.py

# åªåŒæ­¥ 1åˆ†é’Ÿå’Œ5åˆ†é’Ÿ
python scripts/data_sync/sync_minute_kline.py --periods 1m 5m

# é™åˆ¶è‚¡ç¥¨æ•°é‡ï¼ˆæµ‹è¯•ç”¨ï¼‰
python scripts/data_sync/sync_minute_kline.py --limit 50 --max-workers 5
```

#### 3. å®æ—¶è¡Œæƒ…åŒæ­¥ï¼ˆSaga æ¨¡å¼ï¼‰

```bash
# å•æ¬¡è¿è¡Œï¼ˆé»˜è®¤60ç§’é—´éš”ï¼Œè¿è¡Œ1æ¬¡ï¼‰
python scripts/runtime/run_realtime_market_saver.py

# æŒç»­è¿è¡Œï¼ˆæ¯60ç§’ä¸€æ¬¡ï¼‰
python scripts/runtime/run_realtime_market_saver.py --interval 60 --count -1

# è‡ªå®šä¹‰é—´éš”å’Œæ¬¡æ•°
python scripts/runtime/run_realtime_market_saver.py --interval 30 --count 10

# ç¦ç”¨ Saga
python scripts/runtime/run_realtime_market_saver.py --no-saga
```

#### 4. äº‹åŠ¡æ¸…ç†

```bash
# æ‰«æåƒµå°¸äº‹åŠ¡ï¼ˆä¸åˆ é™¤æ•°æ®ï¼‰
python src/cron/transaction_cleaner.py

# ç‰©ç†åˆ é™¤æ— æ•ˆæ•°æ®ï¼ˆä½å³°æœŸï¼‰
python src/cron/transaction_cleaner.py --purge

# æ¨¡æ‹Ÿè¿è¡Œï¼ˆæµ‹è¯•ç”¨ï¼‰
python src/cron/transaction_cleaner.py --dry-run
```

---

### Cron ä»»åŠ¡é…ç½®

å»ºè®®åœ¨ crontab ä¸­é…ç½®å®šæ—¶ä»»åŠ¡ï¼š

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹ä»»åŠ¡
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ—¥çº¿Kçº¿åŒæ­¥ï¼ˆå…¨é‡ï¼‰
0 2 * * * cd /opt/claude/mystocks_spec && python scripts/data_sync/sync_stock_kline.py --full >> logs/daily_kline_sync.log 2>&1

# æ¯å°æ—¶æ‰§è¡Œåˆ†é’ŸKçº¿åŒæ­¥ï¼ˆæœ€è¿‘1å¤©ï¼‰
0 * * * * cd /opt/claude/mystocks_spec && python scripts/data_sync/sync_minute_kline.py --periods 1m 5m >> logs/minute_kline_sync.log 2>&1

# æ¯10åˆ†é’Ÿæ¸…ç†åƒµå°¸äº‹åŠ¡
*/10 * * * * cd /opt/claude/mystocks_spec && python src/cron/transaction_cleaner.py >> logs/transaction_cleaner.log 2>&1

# æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹ç‰©ç†åˆ é™¤æ— æ•ˆæ•°æ®
0 3 * * 0 cd /opt/claude/mystocks_spec && python src/cron/transaction_cleaner.py --purge >> logs/transaction_purge.log 2>&1
```

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### Saga äº‹åŠ¡æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ•°æ®æºè·å–æ•°æ®                                            â”‚
â”‚    data_source.get_stock_kline_data(symbol, start, end)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åˆ›å»ºå…ƒæ•°æ®å›è°ƒ                                            â”‚
â”‚    metadata_callback = create_metadata_callback(symbol)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ‰§è¡Œ Saga åè°ƒå™¨                                         â”‚
â”‚    manager.save_data_by_classification(                     â”‚
â”‚        use_saga=True,                                       â”‚
â”‚        metadata_callback=metadata_callback                  â”‚
â”‚    )                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚
        â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.1 å†™TDengine â”‚  â”‚ 3.2 æ›´æ–°PG   â”‚
â”‚  (é«˜é¢‘æ—¶åºæ•°æ®) â”‚  â”‚  (å…ƒæ•°æ®)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 3.3 äº‹åŠ¡çŠ¶æ€   â”‚
        â”‚ COMMITTED/    â”‚
        â”‚ ROLLED_BACK    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡¥å¿æœºåˆ¶

**è§¦å‘æ¡ä»¶**: PG å…ƒæ•°æ®æ›´æ–°å¤±è´¥

**è¡¥å¿ç­–ç•¥**:
1. æŸ¥è¯¢ TDengine ä¸­ `txn_id` å¯¹åº”çš„æ‰€æœ‰æ•°æ®
2. æ‰§è¡Œ"è½¯åˆ é™¤"ï¼š`UPDATE table SET is_valid=false WHERE txn_id=?`
3. æ›´æ–° `transaction_log` çŠ¶æ€ä¸º `ROLLED_BACK`

**ç¤ºä¾‹**:
```python
# Saga æˆåŠŸ
âœ… TDengine: å†™å…¥100æ¡è®°å½•ï¼Œtxn_id=abc123, is_valid=true
âœ… PostgreSQL: å…ƒæ•°æ®æ›´æ–°æˆåŠŸ
ğŸ“Š final_status=COMMITTED

# Saga å¤±è´¥ï¼ˆè§¦å‘è¡¥å¿ï¼‰
âœ… TDengine: å†™å…¥100æ¡è®°å½•ï¼Œtxn_id=def456, is_valid=true
âŒ PostgreSQL: å…ƒæ•°æ®æ›´æ–°å¤±è´¥
ğŸ”„ è¡¥å¿: UPDATE ... SET is_valid=false WHERE txn_id='def456'
ğŸ“Š final_status=ROLLED_BACK
```

### æ•°æ®åˆ†ç±»ä¸è·¯ç”±

| è„šæœ¬ | DataClassification | ç›®æ ‡è¡¨ | TDengine | PostgreSQL |
|------|-------------------|--------|----------|------------|
| sync_stock_kline.py | DAILY_KLINE | daily_kline | âŒ | âœ… (TimescaleDB) |
| sync_minute_kline.py | TICK_DATA | minute_kline_{1m,5m,...} | âœ… | âœ… (å…ƒæ•°æ®) |
| run_realtime_market_saver.py | INDEX_QUOTES | realtime_market_quotes | âœ… | âœ… (å…ƒæ•°æ®) |

---

## ğŸ“‹ å¾…åŠäº‹é¡¹

### é«˜ä¼˜å…ˆçº§ (P0)

- [x] **å®Œæˆ**: æ—¥çº¿ K çº¿åŒæ­¥æ¥å…¥ Saga
- [x] **å®Œæˆ**: åˆ†é’Ÿ K çº¿åŒæ­¥æ¥å…¥ Saga
- [x] **å®Œæˆ**: å®æ—¶è¡Œæƒ…åŒæ­¥æ¥å…¥ Saga
- [x] **å®Œæˆ**: Transaction Cleaner ç”Ÿäº§åŒ–
- [x] **å®Œæˆ**: æ ‡è®°æ—§è„šæœ¬ä¸º deprecated
- [ ] **å¾…å®š**: ç§»é™¤ `src/storage/access/` å†—ä½™ç›®å½•ï¼ˆéœ€ç”¨æˆ·ç¡®è®¤ï¼‰

### ä¸­ä¼˜å…ˆçº§ (P1)

- [ ] **å¾…å®ç°**: DataAccess å±‚æ·»åŠ  `query_sql` æ–¹æ³•æ”¯æŒ
- [ ] **å¾…å®ç°**: ç›‘æ§é¢æ¿é›†æˆï¼ˆGrafana Dashboardï¼‰
- [ ] **å¾…å®ç°**: å‘Šè­¦è§„åˆ™é…ç½®ï¼ˆPrometheus Alertmanagerï¼‰
- [ ] **å¾…å®ç°**: Saga äº‹åŠ¡æ€§èƒ½æµ‹è¯•ï¼ˆSaga vs ä¼ ç»Ÿæ¨¡å¼å»¶è¿Ÿå¯¹æ¯”ï¼‰

### ä½ä¼˜å…ˆçº§ (P2)

- [ ] **å¯é€‰**: ç»Ÿä¸€ DataAccess æ—¥å¿—æ ‡å‡†ï¼ˆEventBus é›†æˆï¼‰
- [ ] **å¯é€‰**: å•å…ƒæµ‹è¯•ï¼šè¡¥å¿æœºåˆ¶éªŒè¯
- [ ] **å¯é€‰**: å‹åŠ›æµ‹è¯•ï¼šSaga å¹¶å‘äº‹åŠ¡å¤„ç†èƒ½åŠ›

---

## ğŸ“ ç»éªŒæ€»ç»“

### æœ€ä½³å®è·µ

1. **Saga é€‚ç”¨åœºæ™¯**:
   - âœ… è·¨åº“æ“ä½œï¼ˆTDengine + PostgreSQLï¼‰
   - âœ… é«˜é¢‘æ—¶åºæ•°æ®å†™å…¥
   - âœ… éœ€è¦å¼ºä¸€è‡´æ€§çš„åœºæ™¯

2. **Saga ä¸é€‚ç”¨åœºæ™¯**:
   - âŒ å•åº“æ“ä½œï¼ˆç›´æ¥ä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼ï¼‰
   - âŒ æ‰¹é‡å¯¼å…¥ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼Œå¯ç”¨æœ€ç»ˆä¸€è‡´æ€§ï¼‰
   - âŒ ä½é¢‘æ•°æ®ï¼ˆoverhead è¾ƒé«˜ï¼‰

3. **å…ƒæ•°æ®å›è°ƒè®¾è®¡**:
   - ä¿æŒè½»é‡çº§ï¼ˆé¿å…é•¿æ—¶é—´é˜»å¡ï¼‰
   - å¹‚ç­‰æ€§è®¾è®¡ï¼ˆæ”¯æŒé‡è¯•ï¼‰
   - å¼‚å¸¸å¤„ç†å®Œå¤‡ï¼ˆSaga å›æ»šä¾èµ–ï¼‰

4. **ç›‘æ§å»ºè®®**:
   - é‡ç‚¹ç›‘æ§ Saga æˆåŠŸç‡ï¼ˆç›®æ ‡>95%ï¼‰
   - è¿½è¸ª ROLLED_BACK æ¯”ä¾‹ï¼ˆå¼‚å¸¸æ¿€å¢å‘Šè­¦ï¼‰
   - è®°å½•è¡¥å¿æ“ä½œè¯¦æƒ…ï¼ˆæ•…éšœæ’æŸ¥ï¼‰

5. **æ€§èƒ½ä¼˜åŒ–**:
   - å¹¶è¡Œå¤„ç†ï¼šåˆ†é’Ÿ K çº¿ä½¿ç”¨ ThreadPoolExecutor
   - æ‰¹é‡æ“ä½œï¼šæ—¥çº¿ K çº¿æ‰¹é‡è·å–å’Œä¿å­˜
   - è¿æ¥æ± ï¼šå¤ç”¨æ•°æ®åº“è¿æ¥

---

## ğŸ—ï¸ æ¶æ„å½±å“

### æ•°æ®æµå…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®æºé€‚é…å™¨å±‚                            â”‚
â”‚  (Akshare / Baostock / TDX / Customer / ...)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åŒæ­¥è„šæœ¬å±‚ï¼ˆSagaé›†æˆï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sync_stock_klineâ”‚ sync_minute_klineâ”‚ run_realtime_market   â”‚
â”‚   (æ—¥çº¿Kçº¿)   â”‚    (åˆ†é’ŸKçº¿)     â”‚   _saver (å®æ—¶è¡Œæƒ…)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                      â”‚
        â–¼                 â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            MyStocksUnifiedManager                           â”‚
â”‚     (ç»Ÿä¸€æ•°æ®æ“ä½œå…¥å£ + Saga åè°ƒå™¨)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚
        â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TDengine    â”‚  â”‚ PostgreSQL   â”‚
â”‚  é«˜é¢‘æ—¶åºæ•°æ® â”‚  â”‚  å…ƒæ•°æ®+æ—¥çº¿  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…¨æ ˆ Saga è¦†ç›–

```
âœ… ä½é¢‘æ•°æ®ï¼ˆæ—¥çº¿ï¼‰â†’ PostgreSQL (TimescaleDB)
   â””â”€ sync_stock_kline.py (Saga é›†æˆ)

âœ… é«˜é¢‘æ•°æ®ï¼ˆåˆ†é’ŸKçº¿ï¼‰â†’ TDengine + PostgreSQL
   â””â”€ sync_minute_kline.py (Saga é›†æˆ)

âœ… å®æ—¶æ•°æ®ï¼ˆç§’çº§ï¼‰â†’ TDengine + PostgreSQL
   â””â”€ run_realtime_market_saver.py (Saga é›†æˆ)
```

---

## ğŸ“ è”ç³»ä¸æ”¯æŒ

**é—®é¢˜åé¦ˆ**: è¯·åœ¨é¡¹ç›® issue ä¸­æäº¤é—®é¢˜
**æ–‡æ¡£ç»´æŠ¤**: /opt/claude/mystocks_spec/docs/reports/
**ä»£ç å®¡æŸ¥**: è¯·æŸ¥çœ‹ç›¸å…³ PR å’Œ commit å†å²

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Saga æ¶æ„è®¾è®¡**: `/docs/CLAUDE.md`
- **TDengine ä¿®å¤æŠ¥å‘Š**: `/docs/reports/TDENGINE_SAGA_FIX_REPORT.md`
- **Phase 2/3 åˆå§‹æŠ¥å‘Š**: `/docs/reports/PHASE2_3_SAGA_MIGRATION_COMPLETION_REPORT.md`
- **æµ‹è¯•ç”¨ä¾‹**: `/tests/test_saga_transaction.py`
- **Transaction Cleaner æºç **: `/src/cron/transaction_cleaner.py`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-04 00:15:00
**æŠ¥å‘Šç”Ÿæˆè€…**: Claude Code (Main CLI)
**Saga ç‰ˆæœ¬**: V1.0 (Production Ready)
**æµ‹è¯•çŠ¶æ€**: â³ å¾…ç”¨æˆ·éªŒè¯
