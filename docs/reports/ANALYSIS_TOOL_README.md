# API与Web前端数据使用分析工具

## 概述

这个工具用于扫描和分析MyStocks项目中的API端点和前端页面的数据请求情况，生成详细的对比报告，帮助发现API使用情况和潜在的问题。

## 功能特性

- ✅ **API端点扫描**：自动扫描后端API路由，提取端点信息
- ✅ **前端调用分析**：分析Vue/TS/JS文件中的API调用
- ✅ **数据使用对比**：对比API返回数据和前端实际使用情况
- ✅ **数据源识别**：识别API使用的数据源（PostgreSQL/TDengine/Mock）
- ✅ **增量分析**：支持只分析修改的文件，提高分析速度
- ✅ **详细报告**：生成Markdown和JSON格式的详细报告
- ✅ **可视化展示**：使用图表和表格展示分析结果

## 使用方法

### 基本使用

```bash
# 完整分析
python scripts/analyze_api_data_usage.py

# 增量分析（只分析修改的文件）
python scripts/analyze_api_data_usage.py --incremental
```

### 命令行参数

- `--incremental, -i`：增量分析模式，只分析修改的文件
- `--help`：显示帮助信息

## 输出文件

工具会在 `docs/reports/` 目录下生成以下文件：

### 1. API_WEB_DATA_USAGE_REPORT.md

主要的Markdown报告，包含：
- 概览统计
- API端点统计（按HTTP方法、路径分组）
- 前端页面API调用清单
- 数据使用分析（未使用的API、未实现的API）
- 数据库依赖分析
- 数据源类型统计
- 推荐改进建议

### 2. api_data_inventory.json

API数据清单的JSON格式，包含：
- 生成时间
- API端点总数
- 每个端点的详细信息（路径、方法、返回模型、数据源等）

### 3. web_api_calls.json

Web前端API调用清单的JSON格式，包含：
- 生成时间
- 页面总数
- API调用总数
- 每个页面的API调用详情

## 分析维度

### API端点维度

- 路由路径
- HTTP方法
- 返回模型/Schema
- 数据字段列表
- 依赖的数据库表
- 数据源类型（PostgreSQL/TDengine/Mock）
- 源文件位置和行号

### Web页面维度

- 页面路径
- 调用的API端点
- API调用类型（HTTP/API对象）
- 调用的方法
- 使用的行号

## 报告解读

### 概览统计

- **API端点总数**：后端实现的API端点数量
- **前端页面总数**：前端页面和组件数量
- **API调用总数**：前端代码中的API调用数量
- **已使用的API**：前端实际调用的API数量
- **未使用的API**：后端实现但前端未使用的API
- **前端请求但未实现的API**：前端调用但后端未实现的API

### 可视化图表

报告包含ASCII字符画的可视化图表，直观展示API使用情况：

```
已使用:  1 (0.3%)
未使用: ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 355 (99.7%)
```

### 推荐改进

报告会根据分析结果提供改进建议：

| 优先级 | 类别 | 建议 |
|--------|------|------|
| 高 | 代码清理 | 有 251 个API端点未被前端使用，建议评估是否需要删除或标记为deprecated |
| 中 | 数据源 | 有 1 个API仍在使用Mock数据，建议替换为真实数据源 |

## 技术实现

### API分析

使用正则表达式解析Python FastAPI路由：
- 识别 `@router.get("/path")` 和 `@app.get("/path")` 格式的装饰器
- 提取HTTP方法和路径
- 解析async函数定义
- 识别返回模型类型注解
- 分析数据源类型

### 前端分析

使用正则表达式解析Vue/TS/JS文件：
- 识别HTTP调用（`axios.get()`, `request.post()`等）
- 识别API对象调用（`dataApi.xxx()`, `authApi.xxx()`等）
- 提取API端点路径
- 统计API调用次数

### 增量分析

使用文件MD5哈希值检测文件变化：
- 首次运行：分析所有文件，记录文件哈希
- 增量运行：只分析哈希值变化的文件
- 缓存文件：`.analysis_cache.json`

## 注意事项

1. **文件编码**：工具假设所有文件使用UTF-8编码
2. **正则表达式限制**：某些复杂的API调用模式可能无法识别
3. **类型推断**：返回模型和数据字段的提取基于简单的正则匹配，可能不完全准确
4. **数据库依赖**：数据库表依赖检测基于常见的数据库操作模式，可能遗漏某些依赖

## 常见问题

### Q: 为什么有些API调用没有被检测到？

A: 工具使用正则表达式匹配，如果API调用使用了动态构建、字符串拼接等复杂方式，可能无法检测到。可以手动检查相关文件。

### Q: 如何更新分析结果？

A: 直接重新运行工具即可。如果文件没有修改，可以使用`--incremental`参数加快分析速度。

### Q: 报告中显示的"未使用的API"是否一定需要删除？

A: 不一定。这些API可能是：
- 为未来的功能预留的
- 供其他系统或第三方使用的
- 用于内部管理的API

建议结合实际业务需求评估。

## 扩展和定制

如果需要添加自定义的分析逻辑，可以修改以下部分：

1. **API提取规则**：修改`APIAnalyzer._analyze_python_file_with_regex()`方法
2. **前端调用提取**：修改`FrontendAnalyzer._extract_vue_api_calls()`方法
3. **报告生成**：修改`ReportGenerator`类的相关方法
4. **数据源识别**：修改`APIAnalyzer._determine_source_type()`方法

## 许可证

本工具是MyStocks项目的一部分，遵循项目的开源许可证。

## 联系方式

如有问题或建议，请通过GitHub Issues反馈。
