# Phase 5 技术调研报告

**创建日期**: 2025-12-27
**作者**: AI 2 (OpenCode)
**版本**: v1.0

---

## 1. 执行摘要

Phase 5 是 MyStocks 项目从开发环境迈向生产环境的关键阶段。本报告基于已完成的基础设施（Phase 1-4），提供完整的技术调研和选型建议，涵盖性能监控、可观测性栈和E2E测试框架三大核心领域。

**核心结论**:
- 性能监控采用 Prometheus + FastAPI 中间件方案
- 可观测性栈选择 Prometheus + Grafana + Loki + Tempo 组合
- E2E 测试框架采用 Playwright + pytest + Testcontainers

---

## 2. 性能监控技术调研

### 2.1 监控方案对比

| 方案 | 优点 | 缺点 | 推荐场景 |
|------|------|------|---------|
| Prometheus + 中间件 | 开源、轻量、易集成、无依赖 | 需手动埋点 | 本项目首选 |
| Elastic APM | 功能全面、分布式追踪强 | 资源消耗大、成本高 | 大规模微服务 |
| Datadog | 全托管、 SaaS | 成本高、vendor lock-in | 企业级应用 |
| SkyWalking | 国产、社区活跃 | 配置复杂、学习曲线陡 | 国内团队 |

### 2.2 选型结论

**推荐方案**: Prometheus + FastAPI 中间件

**理由**:
1. 与现有技术栈（FastAPI）集成简单
2. 轻量级，对应用性能影响小
3. 开源免费，无供应商锁定
4. 生态完善，Grafana集成良好

### 2.3 核心指标设计

```python
# 推荐的Prometheus指标
REQUEST_LATENCY = Histogram(
    'http_request_duration_seconds',
    'HTTP请求延迟(秒)',
    ['method', 'endpoint', 'status_code'],
    buckets=[0.01, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]
)

REQUEST_COUNT = Counter(
    'http_requests_total',
    'HTTP请求总数',
    ['method', 'endpoint', 'status_code']
)

ACTIVE_REQUESTS = Gauge(
    'http_requests_active',
    '当前活跃HTTP请求数',
    ['method', 'endpoint']
)
```

### 2.4 性能基准目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| API P95 延迟 | ≤ 300ms | 正常负载下 |
| 监控开销 | ≤ 2% | 占总请求时间 |
| 指标采集延迟 | ≤ 10s | Prometheus抓取间隔 |

---

## 3. 可观测性栈技术调研

### 3.1 日志聚合方案对比

| 方案 | 类型 | 优点 | 缺点 | 推荐度 |
|------|------|------|------|--------|
| ELK Stack | 日志 | 功能全面、生态丰富 | 资源消耗大 | ⭐⭐⭐ |
| Loki | 日志 | 轻量、与Prometheus集成好 | 查询语法不同 | ⭐⭐⭐⭐ |
| EFK Stack | 日志 | 成熟稳定 | 配置复杂 | ⭐⭐⭐ |
| 云服务 | 日志 | 托管、易用 | 成本高 | ⭐⭐ |

### 3.2 分布式追踪方案对比

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| Jaeger | 开源、云原生 | 需独立部署 | ⭐⭐⭐ |
| Tempo | 与Grafana深度集成 | 较新 | ⭐⭐⭐⭐ |
| Zipkin | 简单、轻量 | 功能有限 | ⭐⭐⭐ |
| SkyWalking | 全链路 APM | 重量级 | ⭐⭐ |

### 3.3 选型结论

**推荐组合**: Prometheus + Grafana + Loki + Tempo

**理由**:
1. 统一的可观测性平台（Grafana）
2. 轻量级日志方案（Loki）
3. 简化分布式追踪（Tempo）
4. 降低运维复杂度

### 3.4 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                      Application Layer                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ FastAPI     │  │ Cache Layer │  │ Database    │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
└─────────┼────────────────┼────────────────┼─────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────┐
│                   Instrumentation Layer                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Metrics     │  │ Logs        │  │ Traces      │         │
│  │ (Prometheus)│  │ (JSON)      │  │ (OTLP)      │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   Backend Services                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Prometheus  │  │ Loki        │  │ Tempo       │         │
│  │ (Metrics)   │  │ (Logs)      │  │ (Traces)    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   Visualization                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    Grafana                          │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │    │
│  │  │Dashboards│ │Alerts    │ │Explore   │            │    │
│  │  └──────────┘ └──────────┘ └──────────┘            │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 3.5 日志规范

```json
{
  "timestamp": "2025-12-27T10:30:00.000Z",
  "level": "INFO",
  "message": "Request processed",
  "trace_id": "abc123",
  "request_id": "xyz789",
  "user_id": "user_123",
  "service": "mystocks-api",
  "environment": "production",
  "version": "1.0.0",
  "host": "api-server-01",
  "latency_ms": 45.5
}
```

---

## 4. E2E测试框架技术调研

### 4.1 测试框架对比

| 框架 | 语言 | 优点 | 缺点 | 推荐度 |
|------|------|------|------|--------|
| Playwright | 多语言 | 速度快、API友好、多浏览器 | 较新 | ⭐⭐⭐⭐⭐ |
| Cypress | JS/TS | 生态好、文档完善 | 仅Chrome | ⭐⭐⭐⭐ |
| Selenium | 多语言 | 成熟、跨浏览器 | 慢、复杂 | ⭐⭐⭐ |
| Puppeteer | JS/TS | Chrome优先、轻量 | 浏览器支持有限 | ⭐⭐⭐ |

### 4.2 测试数据管理方案

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| Testcontainers | Docker化、独立性强 | 资源消耗大 | ⭐⭐⭐⭐ |
| Factory Pattern | 简单、灵活 | 数据管理复杂 | ⭐⭐⭐⭐ |
| API Mock | 速度快 | 集成测试有限 | ⭐⭐⭐ |
| 数据库快照 | 数据一致性好 | 快照管理复杂 | ⭐⭐⭐ |

### 4.3 选型结论

**推荐组合**: Playwright + pytest + Testcontainers

**理由**:
1. Playwright: 多浏览器支持、API简洁、速度快
2. pytest: Python生态成熟、与FastAPI集成好
3. Testcontainers: 测试隔离、跨环境一致

### 4.4 测试场景规划

| 优先级 | 场景 | 复杂度 | 预计工时 |
|--------|------|--------|---------|
| P0 | 用户登录/登出 | 低 | 2h |
| P0 | 股票列表加载 | 低 | 2h |
| P0 | 股票详情展示 | 中 | 4h |
| P0 | 下单流程 | 中 | 4h |
| P1 | 资金流向展示 | 中 | 4h |
| P1 | 龙虎榜数据 | 中 | 4h |
| P1 | 搜索功能 | 低 | 2h |
| P2 | 回测配置 | 高 | 6h |
| P2 | 回测结果 | 高 | 6h |
| P2 | 数据导出 | 低 | 2h |

### 4.5 测试框架结构

```
tests/e2e/
├── conftest.py              # pytest配置和fixtures
├── pages/                   # Page Object Models
│   ├── base_page.py        # 基类
│   ├── login_page.py       # 登录页
│   ├── dashboard_page.py   # 仪表板页
│   ├── stock_list_page.py  # 股票列表页
│   ├── stock_detail_page.py# 股票详情页
│   ├── trade_page.py       # 交易页
│   └── backtest_page.py    # 回测页
├── fixtures/                # 测试数据工厂
│   ├── user_factory.py     # 用户工厂
│   ├── stock_factory.py    # 股票数据工厂
│   └── order_factory.py    # 订单工厂
├── specs/                   # 测试用例
│   ├── test_auth.py        # 认证测试
│   ├── test_market.py      # 市场数据测试
│   ├── test_trade.py       # 交易功能测试
│   └── test_backtest.py    # 回测功能测试
├── utils/                   # 工具类
│   ├── browser.py          # 浏览器管理
│   ├── logger.py           # 测试日志
│   └── screenshot.py       # 截图工具
└── data/                    # 测试数据
    └── test_users.json     # 测试用户数据
```

---

## 5. CI/CD集成方案

### 5.1 测试流水线设计

```
┌─────────────────────────────────────────────────────────────────┐
│                        CI Pipeline                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Code Checkout                                               │
│         │                                                       │
│         ▼                                                       │
│  2. Install Dependencies (pip install -r requirements.txt)      │
│         │                                                       │
│         ▼                                                       │
│  3. Linting & Type Checking (black, mypy, pylint)               │
│         │                                                       │
│         ▼                                                       │
│  4. Unit Tests (pytest --cov)                                   │
│         │                                                       │
│         ▼                                                       │
│  5. Integration Tests                                           │
│         │                                                       │
│         ▼                                                       │
│  6. E2E Tests (Playwright)                                      │
│         │                                                       │
│         ▼                                                       │
│  7. Security Scan (bandit, safety)                              │
│         │                                                       │
│         ▼                                                       │
│  8. Build & Push Docker Image                                   │
│         │                                                       │
│         ▼                                                       │
│  9. Deploy to Staging                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 门禁规则

| 检查项 | 门禁规则 | 严重程度 |
|--------|---------|---------|
| 代码覆盖率 | ≥ 80% | 阻断 |
| Pylint评分 | ≥ 8.0 | 警告 |
| 安全扫描 | 无高危漏洞 | 阻断 |
| E2E测试 | 通过率 ≥ 95% | 阻断 |
| 类型检查 | 无错误 | 阻断 |
| 性能基准 | 回归 < 10% | 警告 |

---

## 6. 资源需求评估

### 6.1 开发资源

| 阶段 | 工作量 | 负责AI |
|------|--------|--------|
| 性能监控中间件 | 8h | AI 2 |
| 缓存架构实现 | 12h | AI 2 |
| 可观测性栈 | 16h | AI 2 |
| E2E测试框架 | 20h | AI 2 |
| CI/CD集成 | 8h | AI 2 |
| **总计** | **64h** | |

### 6.2 服务器资源（预估）

| 组件 | CPU | 内存 | 存储 | 备注 |
|------|-----|------|------|------|
| Prometheus | 1核 | 2GB | 50GB | 指标数据 |
| Grafana | 1核 | 1GB | 10GB | Dashboards |
| Loki | 1核 | 2GB | 100GB | 日志存储 |
| Tempo | 1核 | 2GB | 50GB | 追踪数据 |
| **总计** | **4核** | **7GB** | **210GB** | |

---

## 7. 风险评估与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 监控数据量过大 | 中 | 中 | 采样策略+保留策略 |
| 测试不稳定 | 高 | 中 | 重试机制+截图报告 |
| 性能开销 | 中 | 低 | 生产环境采样50% |
| 告警风暴 | 低 | 高 | 聚合告警+静默规则 |
| 依赖服务不可用 | 低 | 高 | 服务降级+熔断 |

---

## 8. 结论与建议

### 8.1 核心结论

1. **性能监控**: 采用 Prometheus + FastAPI 中间件方案，技术成熟、集成简单
2. **可观测性**: 采用 Prometheus + Grafana + Loki + Tempo 组合，生态统一
3. **E2E测试**: 采用 Playwright + pytest + Testcontainers，隔离性好、覆盖全面

### 8.2 下一步行动

1. **立即开始**: 搭建性能监控中间件框架
2. **并行推进**: 配置可观测性栈（Prometheus + Grafana）
3. **后续**: E2E测试框架搭建和核心场景覆盖

### 8.3 成功标准

- [ ] API P95 延迟 ≤ 300ms
- [ ] 可用性 ≥ 99.9%
- [ ] E2E测试覆盖 ≥ 80% 核心场景
- [ ] 监控告警响应时间 < 5分钟

---

**报告完成日期**: 2025-12-27
**版本历史**:
- v1.0 (2025-12-27): 初始版本，完成技术调研和选型建议
