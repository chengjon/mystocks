# PHASE 2: Saga åˆ†å¸ƒå¼äº‹åŠ¡è½åœ°ä¸ç”Ÿäº§åŒ–ä»»åŠ¡æ¸…å•

## ğŸ¯ ç›®æ ‡
å°†è·¨åº“ä¸€è‡´æ€§æ–¹æ¡ˆä» Demo æå‡è‡³ç”Ÿäº§çº§ï¼Œå®Œæˆæ ¸å¿ƒä¸šåŠ¡è¿ç§»å¹¶å»ºç«‹å…¨æ–¹ä½ç›‘æ§ã€‚

**å½“å‰çŠ¶æ€**: ğŸŸ¡ éƒ¨åˆ†å®Œæˆï¼ˆå·²å­˜åœ¨æµ‹è¯•ä¸ä»ªè¡¨ç›˜ï¼Œä½†ç¼ºå°‘ transaction_log å®å†™ã€duration_ms å­—æ®µã€å‘Šè­¦è§„åˆ™ä¸ä¸šåŠ¡æ¥å…¥è·¯å¾„æ›´æ–°ï¼‰

---

## ğŸ› ï¸ ç¬¬ä¸€é˜¶æ®µï¼šéªŒè¯ä¸è§‚æµ‹ (æœ¬å‘¨é‡ç‚¹)
- [x] **æ‰©å±•æµ‹è¯•è¦†ç›–**
    - [x] `tests/core/transaction/test_saga_tick_data.py` (Tick å†™å…¥ä¸è¡¥å¿)
    - [x] `tests/core/transaction/test_saga_concurrency.py` (å¹¶å‘å‹åŠ›æµ‹è¯•)
- [ ] **ç›‘æ§é›†æˆ (Grafana + PG) - éƒ¨åˆ†å®Œæˆ**
    - [x] `transaction_log` å»ºè¡¨è„šæœ¬å·²å­˜åœ¨: `scripts/migrations/create_pg_transaction_log.sql`
    - [x] `error_msg` / `retry_count` å­—æ®µå·²å­˜åœ¨
    - [ ] **è¡¥å…… `duration_ms` å­—æ®µ** (è„šæœ¬å½“å‰ç¼ºå¤±)
    - [ ] **Saga äº‹åŠ¡å®å†™ `transaction_log`** (å½“å‰ä»…æ³¨é‡Š/æ—¥å¿—ï¼Œéœ€åœ¨ `src/core/transaction/saga_coordinator.py` æ¥å…¥)
    - [x] Grafana Dashboard JSON å·²å­˜åœ¨: `config/grafana/dashboards/saga_transactions.json`
    - [ ] Prometheus/Alertmanager å‘Šè­¦è§„åˆ™ (æœªå‘ç° Saga ç›¸å…³è§„åˆ™ï¼Œéœ€æ–°å¢)

## ğŸ”„ ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒä¸šåŠ¡è¿ç§»
- [ ] **Kçº¿åŒæ­¥è¿ç§»ï¼ˆè·¯å¾„éœ€æ›´æ–°ï¼‰**
    - [ ] åŸè·¯å¾„ `src/data_sources/real/kline_syncer.py` ä¸å­˜åœ¨ï¼Œéœ€å…ˆå®šä½çœŸå®è½åº“å…¥å£
    - [ ] å»ºè®®ä» `save_data_by_classification` / `save_data` çš„è°ƒç”¨å¤„ä¸‹æ‰‹ï¼Œæ˜ç¡® K çº¿å†™å…¥é“¾è·¯
    - [ ] åœ¨å…¥å£å¤„å¯ç”¨ `use_saga=True` å¹¶æä¾› `metadata_callback` å®Œæˆ PG å…ƒæ•°æ®å†™å…¥
    - [ ] éªŒè¯å…¨é‡åŒæ­¥åœºæ™¯ä¸‹çš„äº‹åŠ¡ç¨³å®šæ€§
- [ ] **å®æ—¶è¡Œæƒ…è¿ç§»ï¼ˆéœ€é‡æ–°è¯„ä¼° Saga é€‚ç”¨æ€§ï¼‰**
    - [ ] å½“å‰å®æ—¶è¡Œæƒ…å†™å…¥å…¥å£ç¤ºä¾‹: `src/storage/database/save_realtime_market_data.py` (ç»Ÿä¸€ç®¡ç†å™¨ â†’ PG/Redis)
    - [ ] è‹¥ä¸æ¶‰åŠ TDengine+PG åŒå†™ï¼Œåˆ™æ— éœ€ Sagaï¼›å¦‚éœ€è·¨åº“ä¸€è‡´æ€§ï¼Œå†æ¥å…¥ `use_saga`
    - [ ] è¯„ä¼°é«˜é¢‘å†™å…¥ä¸‹çš„å»¶è¿Ÿå¼€é”€ (Latency Overhead)

## ğŸ§¹ ç¬¬ä¸‰é˜¶æ®µï¼šæ²»ç†ä¸ä¼˜åŒ–
- [ ] **æ¶æ„æ¸…ç†**
    - [ ] ç§»é™¤å†—ä½™çš„ `src/storage/access/` ç›®å½•ï¼ˆå½“å‰ä»…åœ¨ `src/README.md` ä¸­è¢«æåŠï¼Œåˆ é™¤å‰ç¡®è®¤æ— å¼•ç”¨ï¼‰
    - [ ] ç»Ÿä¸€æ‰€æœ‰ DataAccess çš„æ—¥å¿—æ ‡å‡† (EventBus)ï¼ˆDataManager å·²æœ‰äº‹ä»¶æœºåˆ¶ï¼ŒDataAccess å°šæœªç»Ÿä¸€ï¼‰
- [ ] **è‡ªåŠ¨åŒ–æ¸…ç†ä»»åŠ¡**
    - [ ] æ¿€æ´» `src/cron/transaction_cleaner.py`ï¼ˆä»£ç å·²å­˜åœ¨ï¼Œéœ€éƒ¨ç½²çº§å¯ç”¨ï¼‰
    - [ ] è¡¥å…¨ transaction_cleaner çš„ **çœŸå®æŸ¥è¯¢/åˆ é™¤é€»è¾‘**ï¼ˆå½“å‰ä¸ºç¤ºä¾‹/å ä½ï¼‰
    - [ ] å®šæœŸç‰©ç†åˆ é™¤ TDengine ä¸­ `is_valid=false` çš„å†å²ç¢ç‰‡æ•°æ®ï¼ˆå¯é€šè¿‡ `--purge`ï¼‰

---
**å½“å‰è¿›åº¦**: ğŸŸ¢ å¯åŠ¨ä¸­
**è´Ÿè´£äºº**: Gemini CLI Agent
