<!--
同步影响报告 - 宪法更新
版本变更: 1.0.0 → 1.1.0
日期: 2025-10-09

本次修订 (v1.1.0):
- 扩展: I. 数据分类体系从5个基础分类扩展为5大类23个详细子项
- 优化: 参考数据增加基本面数据子项(结构化财务指标、分红送配、股东数据)
- 新增: SYMBOL_CLASSIFICATIONS独立分类(行业/概念/指数成分)
- 优化: 市场数据增加Level-2盘口快照和指数行情
- 优化: 衍生数据增加回测结果和风险指标
- 优化: 交易数据增加资金流水和委托队列
- 优化: 元数据增加数据质量指标和用户配置
- 新增: 三层扩展机制(基础枚举+二级标签+存储元数据)

需要更新的模板:
✅ plan-template.md - 已同步数据分类扩展
✅ spec-template.md - 已同步关键实体定义
✅ tasks-template.md - 已同步数据分类任务结构

后续待办事项: 更新代码中的DataClassification枚举以匹配新分类体系
-->

# MyStocks 项目宪法

**创建人**: JohnC & Claude
**版本**: 1.1.0
**批准日期**: 2025-10-09
**最后修订**: 2025-10-09
**本次修订内容**: 扩展数据分类体系从5个基础分类到23个详细子项,增强量化系统全流程覆盖

## 核心原则

### I. 5层数据分类体系 (不可协商)

所有数据必须基于其特性和访问模式分类为以下五大类23个子项之一:

#### 第1类: 市场数据 (Market Data) - 高频时序数据
- **Tick数据**: 逐笔成交数据 → TDengine (超高频,毫秒级)
- **分钟K线**: 分钟级行情数据 → TDengine (高频,分钟级)
- **日线/周线/月线**: 日度及以上K线数据 → PostgreSQL+TimescaleDB (中低频,历史回溯)
- **深度数据**: 订单簿数据 → TDengine (高频,实时订单队列)
- **盘口快照**: Level-2逐笔委托、十档行情 → TDengine (高频,3秒/次)
- **指数行情**: 指数分时和日线数据 → TDengine+PostgreSQL (分时高频+日线中频)

#### 第2类: 参考数据 (Reference Data) - 相对静态的描述性数据
- **股票信息**: 代码、名称、上市日期等基础属性 → MySQL/MariaDB (静态)
- **行业分类**: 申万一级/二级、证监会行业等分类标准 → MySQL/MariaDB (半静态)
- **概念分类**: AI、新能源、国企改革等概念标签 → MySQL/MariaDB (半静态,动态更新)
- **成分股信息**: 沪深300、中证500等指数成分 → MySQL/MariaDB (半静态,定期调整)
- **交易日历**: 交易日、节假日信息 → MySQL/MariaDB (静态,预定义)
- **基本面数据 - 结构化财务指标**: 营收、净利润、EPS、ROE等 → MySQL/MariaDB (低频,季度/年度)
- **基本面数据 - 分红送配**: 分红比例、除权除息日、送股数量 → MySQL/MariaDB (低频,不定期)
- **基本面数据 - 股东数据**: 大股东增减持、机构持仓变化 → MySQL/MariaDB (低频,月度)
- **市场规则**: 涨跌幅限制、停牌规则、退市标准 → MySQL/MariaDB (静态,系统级)

#### 第3类: 衍生数据 (Derived Data) - 计算分析结果
- **技术指标**: MACD、RSI、布林带等 → PostgreSQL+TimescaleDB (计算密集,时序)
- **量化因子**: 动量因子、价值因子、基于财务指标的因子 → PostgreSQL+TimescaleDB (计算密集,多维度)
- **模型输出**: AI模型预测结果(结构化) → PostgreSQL+TimescaleDB (二进制权重可选对象存储)
- **交易信号**: 策略生成的买卖信号 → PostgreSQL+TimescaleDB (时序,触发式)
- **回测结果**: 收益曲线、最大回撤、夏普比率等 → PostgreSQL+TimescaleDB (非时序+时序混合)
- **风险指标**: VaR、行业暴露度、Beta等 → PostgreSQL+TimescaleDB (计算密集,多维度)

#### 第4类: 交易数据 (Transaction Data) - 冷热分离
- **订单记录**: 历史委托记录 → PostgreSQL (持久化,关联成交)
- **成交记录**: 历史成交明细 → PostgreSQL (持久化,时序)
- **持仓记录**: 历史持仓快照 → PostgreSQL (持久化,历史回溯)
- **实时持仓**: 当前持仓状态 → Redis (热数据,高频读写)
- **实时账户**: 当前账户资金状态 → Redis (热数据,高频更新)
- **资金流水**: 资金转入/转出、手续费、分红到账 → PostgreSQL (持久化,时序,审计)
- **委托队列**: 未成交委托排队状态 → Redis (热数据,实时更新)

#### 第5类: 元数据 (Meta Data) - 系统配置和监控
- **数据源状态**: 数据源健康度、更新状态、完整性校验 → MySQL/MariaDB (配置型,实时监控)
- **任务调度**: 定时任务配置和执行记录 → MySQL/MariaDB (配置型,定时触发)
- **策略参数**: 策略配置参数、版本管理 → MySQL/MariaDB (配置型,版本化)
- **系统配置**: 系统级参数、权限配置 → MySQL/MariaDB (配置型,全局生效)
- **数据质量指标**: 完整性率、缺失率、更新延迟 → MySQL/MariaDB (监控型,时序)
- **用户配置**: 自定义标的组合、看板设置 → MySQL/MariaDB (个性化,用户关联)

**原理**: 科学的数据分类确保最优存储策略,防止性能退化,并实现智能自动路由。
从5个基础分类扩展到23个详细子项,覆盖量化系统从策略研发→回测验证→实盘交易的全流程需求,
这是所有其他架构决策的基础原则。

**扩展机制**: 采用三层架构支持未来扩展而不修改核心代码:
1. **基础枚举层**: 定义核心一级分类和关键二级子项(不可轻易变更)
2. **二级标签层**: 通过配置文件定义细分维度(如行业分类标准、财报类型)
3. **存储元数据层**: 通过YAML配置定义每个子项的存储策略、更新频率、保留周期

### II. 配置驱动设计

所有表结构、数据库映射必须在YAML配置文件(`table_config.yaml`)中定义，系统配置可放在YAML或.env文件中。
除开发/测试环境有明确理由外,禁止手动修改数据库架构。

**关键要求**:
- 表通过 `ConfigDrivenTableManager` 自动创建
- 架构变更通过配置更新传播
- 所有配置变更进行版本控制
- 配置架构文档化

**原理**: 配置驱动设计消除手动干预,减少人为错误,确保跨环境一致性,
并为所有结构变更提供审计跟踪。

### III. 智能自动路由

系统必须根据数据分类自动将数据路由到最优数据库。开发人员不得在应用代码中
手动指定目标数据库,除非有特定性能要求的明确理由。

**实现方式**:
- `DataStorageStrategy.get_target_database()` 确定路由
- `DataClassification` 枚举驱动所有路由决策
- 统一方法: `save_data_by_classification()`, `load_data_by_classification()`

**原理**: 自动路由抽象了数据库复杂性,实现无缝数据库切换,并确保整个系统
一致应用存储策略。

### IV. 多数据库协同

系统利用多个数据库引擎,每个都针对特定数据特性进行优化。数据库选择必须
基于技术优势,而非便利性。

**数据库专业化分工**:
- **TDengine**: 超高压缩比(20:1),极致写入性能用于市场数据
- **PostgreSQL+TimescaleDB**: 复杂时序查询,自动分区
- **MySQL/MariaDB**: ACID合规,复杂JOIN用于参考数据
- **Redis**: 亚毫秒级访问用于实时状态和热数据

**原理**: 异构数据库架构允许每种数据类型利用最合适的存储引擎,
最大化性能和成本效益。

### V. 完整可观测性 (不可协商)

所有系统操作必须记录到独立于业务数据存储的监控数据库。性能指标、数据质量
检查和告警对于生产部署是强制性的。

**必需组件**:
- `MonitoringDatabase`: 独立数据库用于所有操作日志
- `PerformanceMonitor`: 查询性能跟踪,慢操作告警
- `DataQualityMonitor`: 完整性、新鲜度、准确性验证
- `AlertManager`: 多渠道告警(邮件、webhook、日志)

**原理**: 独立监控确保系统行为可见性而不影响业务操作,实现主动问题检测,
并为合规提供审计跟踪。

### VI. 统一访问接口

所有数据操作必须通过统一管理器(`MyStocksUnifiedManager`)进行。在应用代码中
禁止直接数据库访问,除非在数据库访问层实现中。

**关键原则**:
- 所有数据操作的单一入口点
- 跨所有数据库类型的一致API
- 底层数据库复杂性的抽象
- 集中式错误处理和重试逻辑

**原理**: 统一接口简化应用开发,实现一致的错误处理,允许透明的数据库更改,
并减少代码重复。

### VII. 安全优先

数据库凭证和敏感配置必须存储在环境变量或安全保管库中。源代码中严格禁止
硬编码凭证。

**必需实践**:
- 所有数据库连接使用环境变量
- `.env` 文件从版本控制中排除
- 安全的凭证轮换程序
- 数据库账户的最小权限原则

**原理**: 安全优先设计防止凭证泄露,支持特定环境配置,并符合生产系统的
安全最佳实践。

## 性能标准

### 响应时间要求
- 实时数据访问 (Redis): < 10ms p95
- 时序查询 (TDengine): 标准范围查询 < 100ms
- 复杂分析查询 (PostgreSQL): 典型报表 < 5s
- 参考数据查找 (MySQL): < 50ms p95

### 吞吐量要求
- 市场数据摄取: 支持 10,000+ tick/秒 (TDengine)
- 并发查询支持: 100+ 并发用户无性能下降
- 批量操作: 批量操作处理 1M+ 记录

### 数据质量标准
- 完整性: > 99.9% 的预期数据点存在
- 新鲜度: 实时数据延迟 < 1秒
- 准确性: 对数据损坏或类型不匹配零容忍

## 测试要求

### 集成测试 (强制性)
- 数据库连接和故障转移场景
- 数据分类和路由逻辑
- 多数据库事务协调
- 监控和告警机制

### 性能测试 (生产环境必需)
- 使用真实数据量的负载测试
- 并发访问下的查询性能
- 内存使用和连接池效率
- 数据库特定优化验证

### 数据质量测试
- 针对配置的架构验证
- 数据类型和约束强制执行
- 跨数据库引用完整性
- 监控数据完整性

## 开发工作流

### 配置变更
1. 使用新架构更新 `table_config.yaml`
2. 在开发环境中测试配置
3. 通过 `ConfigDrivenTableManager` 验证自动创建
4. 在提交消息中记录变更
5. 通过受控发布部署到生产环境

### 新数据分类
1. 证明需要新分类类别的理由
2. 在 `DataStorageStrategy` 中定义路由策略
3. 更新 `DataClassification` 枚举
4. 在YAML中添加配置映射
5. 更新监控以覆盖新分类

### 数据库添加
1. 记录新数据库的技术理由
2. 在 `data_access.py` 中实现访问层
3. 在 `core.py` 中更新路由策略
4. 在 `db_manager/` 中添加连接管理
5. 集成监控和质量检查

## 治理规则

### 宪法权威性
本宪法优先于所有其他开发实践。所有代码审查、架构决策和实施计划必须
验证是否符合这些原则。

### 修订流程
宪法修订需要:
1. 包含技术原理的书面理由
2. 对现有系统的影响分析
3. 破坏性变更的迁移计划
4. 项目维护者的批准
5. 遵循语义版本控制的版本递增

### 版本控制策略
- **主版本 (MAJOR)**: 原则移除/重新定义、破坏性架构变更
- **次版本 (MINOR)**: 新增原则、扩展指导、新增强制章节
- **补丁版本 (PATCH)**: 澄清、措辞改进、非语义细化

### 合规审查
所有拉取请求必须包括:
- 数据分类合规性验证
- 统一接口使用确认
- 凭证使用环境变量
- 新操作的监控集成

### 复杂性论证
任何偏离这些原则的行为必须在设计文档中明确论证,并记录:
- 需要偏离的特定技术约束
- 考虑并拒绝的更简单替代方案
- 约束消除后返回合规的计划

**版本**: 1.0.0 | **批准日期**: 2025-10-09 | **最后修订**: 2025-10-09
